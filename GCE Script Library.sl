<?xml version="1.0" encoding="UTF-8"?> 
<java version="1.6.0_26" class="java.beans.XMLDecoder"> 
 <object class="pe.pde.ScriptLibraryModel"> 
  <void property="exportFileName"> 
   <string>GCE Script Library</string> 
  </void> 
  <void property="root"> 
   <void property="author"> 
    <string>Administrator</string> 
   </void> 
   <void property="createDate"> 
    <string>2005/01/03 17:15:09</string> 
   </void> 
   <void property="name"> 
    <string> Script Library</string> 
   </void> 
   <void property="parentId"> 
    <string>SCFROOT</string> 
   </void> 
   <void property="scriptForderIdList"> 
    <void method="add"> 
     <string>SCF00001159252679531</string> 
    </void> 
   </void> 
   <void property="synopsis"> 
    <string>Your Company Name ScriptLibrary</string> 
   </void> 
  </void> 
  <void property="scriptForderMap"> 
   <void method="put"> 
    <string>SCF00001105070014109</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/01/07 11:53:34</string> 
     </void> 
     <void property="id"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="name"> 
      <string>ExpenseFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001154842169093</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00121110621764421</string> 
      </void> 
      <void method="add"> 
       <string>SCL00301117094466531</string> 
      </void> 
      <void method="add"> 
       <string>SCL00011105070029907</string> 
      </void> 
      <void method="add"> 
       <string>SCL00271112272370906</string> 
      </void> 
      <void method="add"> 
       <string>SCL00021105070711231</string> 
      </void> 
      <void method="add"> 
       <string>SCL00071105353068885</string> 
      </void> 
      <void method="add"> 
       <string>SCL00221111120231968</string> 
      </void> 
      <void method="add"> 
       <string>SCL00071142688806091</string> 
      </void> 
      <void method="add"> 
       <string>SCL00331123493696484</string> 
      </void> 
      <void method="add"> 
       <string>SCL00081144128900643</string> 
      </void> 
      <void method="add"> 
       <string>SCL00031132401425963</string> 
      </void> 
      <void method="add"> 
       <string>SCL00311120121485718</string> 
      </void> 
      <void method="add"> 
       <string>SCL00211110982479406</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string></string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00001154842169093</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/09/02 08:36:43</string> 
     </void> 
     <void property="id"> 
      <string>SCF00001154842169093</string> 
     </void> 
     <void property="name"> 
      <string>A</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001159252679531</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00081250755035080</string> 
      </void> 
      <void method="add"> 
       <string>SCF00041102066155330</string> 
      </void> 
      <void method="add"> 
       <string>SCF00121179635187359</string> 
      </void> 
      <void method="add"> 
       <string>SCF00011194752256531</string> 
      </void> 
      <void method="add"> 
       <string>SCF00031157709081640</string> 
      </void> 
      <void method="add"> 
       <string>SCF00001105070014109</string> 
      </void> 
      <void method="add"> 
       <string>SCF00011105352183360</string> 
      </void> 
      <void method="add"> 
       <string>SCF00031102066129487</string> 
      </void> 
      <void method="add"> 
       <string>SCF00081177250221609</string> 
      </void> 
      <void method="add"> 
       <string>SCF00051102066163487</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>此分類是由顧問提供</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00001156610917031</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/03/14 15:15:38</string> 
     </void> 
     <void property="id"> 
      <string>SCF00001156610917031</string> 
     </void> 
     <void property="name"> 
      <string>Common</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011152000677625</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00011156610928578</string> 
      </void> 
      <void method="add"> 
       <string>SCF00021156610951562</string> 
      </void> 
      <void method="add"> 
       <string>SCF00021196616535609</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00001159252679531</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/12/22 15:49:03</string> 
     </void> 
     <void property="id"> 
      <string>SCF00001159252679531</string> 
     </void> 
     <void property="name"> 
      <string>com</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF_GLOBAL_ROOTSCRIPT</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00001154842169093</string> 
      </void> 
      <void method="add"> 
       <string>SCF00001202014127828</string> 
      </void> 
      <void method="add"> 
       <string>SCF00011181776157390</string> 
      </void> 
      <void method="add"> 
       <string>SCF00041211951346768</string> 
      </void> 
      <void method="add"> 
       <string>SCF00011159252687234</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00001202014127828</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/02/03 12:48:47</string> 
     </void> 
     <void property="id"> 
      <string>SCF00001202014127828</string> 
     </void> 
     <void property="name"> 
      <string>eland</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001159252679531</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00011203496283609</string> 
      </void> 
      <void method="add"> 
       <string>SCF00011202014151093</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>eland ekm 整合</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00001209032361851</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/04/24 18:19:21</string> 
     </void> 
     <void property="id"> 
      <string>SCF00001209032361851</string> 
     </void> 
     <void property="name"> 
      <string>MAN</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00411408698385876</string> 
      </void> 
      <void method="add"> 
       <string>SCL00451471930547476</string> 
      </void> 
      <void method="add"> 
       <string>SCL00001209032411725</string> 
      </void> 
      <void method="add"> 
       <string>SCL00421424829535863</string> 
      </void> 
      <void method="add"> 
       <string>SCL00021211161988159</string> 
      </void> 
      <void method="add"> 
       <string>SCL00031211433598746</string> 
      </void> 
      <void method="add"> 
       <string>SCL00001231493866502</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>製造系統用的Library</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00001222246374313</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/09/24 16:52:54</string> 
     </void> 
     <void property="id"> 
      <string>SCF00001222246374313</string> 
     </void> 
     <void property="name"> 
      <string>TRN</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00011222246389213</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00001222752517878</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/02/03 12:49:11</string> 
     </void> 
     <void property="id"> 
      <string>SCF00001222752517878</string> 
     </void> 
     <void property="name"> 
      <string>org</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>null</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00011105352183360</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/01/10 18:16:23</string> 
     </void> 
     <void property="id"> 
      <string>SCF00011105352183360</string> 
     </void> 
     <void property="name"> 
      <string>FormFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001154842169093</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00051105352286045</string> 
      </void> 
      <void method="add"> 
       <string>SCL00041105352225910</string> 
      </void> 
      <void method="add"> 
       <string>SCL00241111202929406</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string></string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00011152000677625</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/07/04 16:11:17</string> 
     </void> 
     <void property="id"> 
      <string>SCF00011152000677625</string> 
     </void> 
     <void property="name"> 
      <string>Client</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00121179635187359</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00001156610917031</string> 
      </void> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00111155897650750</string> 
      </void> 
      <void method="add"> 
       <string>SCL00231208421992871</string> 
      </void> 
      <void method="add"> 
       <string>SCL00031153280417375</string> 
      </void> 
      <void method="add"> 
       <string>SCL00041153405120156</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00011156610928578</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/08/27 00:48:48</string> 
     </void> 
     <void property="id"> 
      <string>SCF00011156610928578</string> 
     </void> 
     <void property="name"> 
      <string>Client</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001156610917031</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00051196792258437</string> 
      </void> 
      <void method="add"> 
       <string>SCL00011203609380890</string> 
      </void> 
      <void method="add"> 
       <string>SCL00001155559869484</string> 
      </void> 
      <void method="add"> 
       <string>SCL00121159178539171</string> 
      </void> 
      <void method="add"> 
       <string>SCL00051156611878250</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00011159252687234</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/09/26 14:38:07</string> 
     </void> 
     <void property="id"> 
      <string>SCF00011159252687234</string> 
     </void> 
     <void property="name"> 
      <string>realtek</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001159252679531</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00041179559576781</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00011181776157390</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/06/14 07:09:17</string> 
     </void> 
     <void property="id"> 
      <string>SCF00011181776157390</string> 
     </void> 
     <void property="name"> 
      <string>flowring</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001159252679531</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00021181776164687</string> 
      </void> 
      <void method="add"> 
       <string>SCF00031096524071477</string> 
      </void> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00011110349333406</string> 
      </void> 
      <void method="add"> 
       <string>SCL00021110507127984</string> 
      </void> 
      <void method="add"> 
       <string>SCL00001095842798154</string> 
      </void> 
      <void method="add"> 
       <string>SCL00011095842959300</string> 
      </void> 
      <void method="add"> 
       <string>SCL00031090380546207</string> 
      </void> 
      <void method="add"> 
       <string>SCL00001110188021296</string> 
      </void> 
      <void method="add"> 
       <string>SCL00031110519447000</string> 
      </void> 
      <void method="add"> 
       <string>SCL00001090375075160</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00011194752256531</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/11/11 11:37:36</string> 
     </void> 
     <void property="id"> 
      <string>SCF00011194752256531</string> 
     </void> 
     <void property="name"> 
      <string>DMS</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001154842169093</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00061197197728734</string> 
      </void> 
      <void method="add"> 
       <string>SCL00001194752354625</string> 
      </void> 
      <void method="add"> 
       <string>SCL00021194753061796</string> 
      </void> 
      <void method="add"> 
       <string>SCL00081197709110953</string> 
      </void> 
      <void method="add"> 
       <string>SCL00011194752664156</string> 
      </void> 
      <void method="add"> 
       <string>SCL00071197301741640</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00011202014151093</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/02/03 12:49:11</string> 
     </void> 
     <void property="id"> 
      <string>SCF00011202014151093</string> 
     </void> 
     <void property="name"> 
      <string>org</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001202014127828</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00001202014169406</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00011203496283609</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/02/20 16:31:23</string> 
     </void> 
     <void property="id"> 
      <string>SCF00011203496283609</string> 
     </void> 
     <void property="name"> 
      <string>dms</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001202014127828</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00071211441967003</string> 
      </void> 
      <void method="add"> 
       <string>SCL00061208585687703</string> 
      </void> 
      <void method="add"> 
       <string>SCL00031203786161875</string> 
      </void> 
      <void method="add"> 
       <string>SCL00021203777218718</string> 
      </void> 
      <void method="add"> 
       <string>SCL00001203589316078</string> 
      </void> 
      <void method="add"> 
       <string>SCL00051204017948203</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ekm 文件整合</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00011221465024953</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/09/15 15:50:24</string> 
     </void> 
     <void property="id"> 
      <string>SCF00011221465024953</string> 
     </void> 
     <void property="name"> 
      <string>QC</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00021227755663885</string> 
      </void> 
      <void method="add"> 
       <string>SCL00011222129534884</string> 
      </void> 
      <void method="add"> 
       <string>SCL00001221465131374</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00011227091263550</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/11/19 17:41:54</string> 
     </void> 
     <void property="id"> 
      <string>SCF00011227091263550</string> 
     </void> 
     <void property="name"> 
      <string>Server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041226985843214</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00011227091346193</string> 
      </void> 
      <void method="add"> 
       <string>SCL00081345181797965</string> 
      </void> 
      <void method="add"> 
       <string>SCL00461533006257266</string> 
      </void> 
      <void method="add"> 
       <string>SCL00281284102739398</string> 
      </void> 
      <void method="add"> 
       <string>SCL00021229675716182</string> 
      </void> 
      <void method="add"> 
       <string>SCL00021366945149256</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00011227857277675</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/11/28 15:27:57</string> 
     </void> 
     <void property="id"> 
      <string>SCF00011227857277675</string> 
     </void> 
     <void property="name"> 
      <string>Util</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041226985843214</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00011227857292197</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>通用的函式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00021156610951562</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/07/10 18:41:10</string> 
     </void> 
     <void property="id"> 
      <string>SCF00021156610951562</string> 
     </void> 
     <void property="name"> 
      <string>Server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001156610917031</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00031195270894828</string> 
      </void> 
      <void method="add"> 
       <string>SCL00031156609563578</string> 
      </void> 
      <void method="add"> 
       <string>SCL00151222251230193</string> 
      </void> 
      <void method="add"> 
       <string>SCL00251177170718515</string> 
      </void> 
      <void method="add"> 
       <string>SCL00231160885095703</string> 
      </void> 
      <void method="add"> 
       <string>SCL00061156729683843</string> 
      </void> 
      <void method="add"> 
       <string>SCL00011155562447984</string> 
      </void> 
      <void method="add"> 
       <string>SCL00151156083789093</string> 
      </void> 
      <void method="add"> 
       <string>SCL00261177170806203</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00021181776164687</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/06/14 07:09:24</string> 
     </void> 
     <void property="id"> 
      <string>SCF00021181776164687</string> 
     </void> 
     <void property="name"> 
      <string>a02</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011181776157390</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00001181776172890</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00021196616535609</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/12/03 01:28:55</string> 
     </void> 
     <void property="id"> 
      <string>SCF00021196616535609</string> 
     </void> 
     <void property="name"> 
      <string>Util</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001156610917031</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00041196616571406</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>小funciton</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00021209086907130</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/04/25 09:28:27</string> 
     </void> 
     <void property="id"> 
      <string>SCF00021209086907130</string> 
     </void> 
     <void property="name"> 
      <string>TGCE</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00031209086927990</string> 
      </void> 
      <void method="add"> 
       <string>SCF00061245913388659</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>TGCE 專案</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00021229049977055</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/12/12 10:46:17</string> 
     </void> 
     <void property="id"> 
      <string>SCF00021229049977055</string> 
     </void> 
     <void property="name"> 
      <string>Client</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00161213170082195</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00191213170155089</string> 
      </void> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00171244444421608</string> 
      </void> 
      <void method="add"> 
       <string>SCL00161241831936682</string> 
      </void> 
      <void method="add"> 
       <string>SCL00271280738792367</string> 
      </void> 
      <void method="add"> 
       <string>SCL00081229050014461</string> 
      </void> 
      <void method="add"> 
       <string>SCL00331297093787246</string> 
      </void> 
      <void method="add"> 
       <string>SCL00341297093840136</string> 
      </void> 
      <void method="add"> 
       <string>SCL00101233886524113</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00031096524071477</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/09/30 14:01:11</string> 
     </void> 
     <void property="id"> 
      <string>SCF00031096524071477</string> 
     </void> 
     <void property="name"> 
      <string>project</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011181776157390</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00061096524105449</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00031102066129487</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/09/02 08:35:45</string> 
     </void> 
     <void property="id"> 
      <string>SCF00031102066129487</string> 
     </void> 
     <void property="name"> 
      <string>MemberFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001154842169093</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00231111149037203</string> 
      </void> 
      <void method="add"> 
       <string>SCL00081105425836005</string> 
      </void> 
      <void method="add"> 
       <string>SCL00131102067302190</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>(顧問提供的)</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00031157709081640</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/09/08 17:51:21</string> 
     </void> 
     <void property="id"> 
      <string>SCF00031157709081640</string> 
     </void> 
     <void property="name"> 
      <string>ECN</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001154842169093</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00101157982483921</string> 
      </void> 
      <void method="add"> 
       <string>SCL00091157866682468</string> 
      </void> 
      <void method="add"> 
       <string>SCL00241169693876062</string> 
      </void> 
      <void method="add"> 
       <string>SCL00221160739242421</string> 
      </void> 
      <void method="add"> 
       <string>SCL00081157807667218</string> 
      </void> 
      <void method="add"> 
       <string>SCL00071157709108062</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00031209086927990</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/04/25 09:28:47</string> 
     </void> 
     <void property="id"> 
      <string>SCF00031209086927990</string> 
     </void> 
     <void property="name"> 
      <string>F00001</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021209086907130</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00001209086968194</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>帳號權限申請單</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00031307504074135</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/06/08 11:34:34</string> 
     </void> 
     <void property="id"> 
      <string>SCF00031307504074135</string> 
     </void> 
     <void property="name"> 
      <string>scrap</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00051307586042458</string> 
      </void> 
      <void method="add"> 
       <string>SCF00041307504199431</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>原物料報廢申請單</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00041102066155330</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/12/03 17:29:15</string> 
     </void> 
     <void property="id"> 
      <string>SCF00041102066155330</string> 
     </void> 
     <void property="name"> 
      <string>ComponentFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001154842169093</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00151102067455440</string> 
      </void> 
      <void method="add"> 
       <string>SCL00161102067493565</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string></string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00041179559576781</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/05/19 15:26:16</string> 
     </void> 
     <void property="id"> 
      <string>SCF00041179559576781</string> 
     </void> 
     <void property="name"> 
      <string>ecn</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011159252687234</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00021179559590828</string> 
      </void> 
      <void method="add"> 
       <string>SCL00051188310399187</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00041211951346768</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/02/03 12:48:47</string> 
     </void> 
     <void property="id"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="name"> 
      <string>gce</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001159252679531</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00161370400796920</string> 
      </void> 
      <void method="add"> 
       <string>SCF00241213176827229</string> 
      </void> 
      <void method="add"> 
       <string>SCF00041226985843214</string> 
      </void> 
      <void method="add"> 
       <string>SCF00001209032361851</string> 
      </void> 
      <void method="add"> 
       <string>SCF00051221612480089</string> 
      </void> 
      <void method="add"> 
       <string>SCF00321216878882287</string> 
      </void> 
      <void method="add"> 
       <string>SCF00091213169988915</string> 
      </void> 
      <void method="add"> 
       <string>SCF00071247640707129</string> 
      </void> 
      <void method="add"> 
       <string>SCF00011221465024953</string> 
      </void> 
      <void method="add"> 
       <string>SCF00061211339110866</string> 
      </void> 
      <void method="add"> 
       <string>SCF00021209086907130</string> 
      </void> 
      <void method="add"> 
       <string>SCF00001222246374313</string> 
      </void> 
      <void method="add"> 
       <string>SCF00001222752517878</string> 
      </void> 
      <void method="add"> 
       <string>SCF00031307504074135</string> 
      </void> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00381306142008999</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00041226985843214</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/11/18 13:24:03</string> 
     </void> 
     <void property="id"> 
      <string>SCF00041226985843214</string> 
     </void> 
     <void property="name"> 
      <string>HR</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00051226985915885</string> 
      </void> 
      <void method="add"> 
       <string>SCF00011227091263550</string> 
      </void> 
      <void method="add"> 
       <string>SCF00011227857277675</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00041307504199431</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/06/08 11:36:39</string> 
     </void> 
     <void property="id"> 
      <string>SCF00041307504199431</string> 
     </void> 
     <void property="name"> 
      <string>server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031307504074135</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00071307685833337</string> 
      </void> 
      <void method="add"> 
       <string>SCL00041307504406693</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00051102066163487</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/09/02 08:35:34</string> 
     </void> 
     <void property="id"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="name"> 
      <string>SystemFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001154842169093</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00171102067568377</string> 
      </void> 
      <void method="add"> 
       <string>SCL00041132647811822</string> 
      </void> 
      <void method="add"> 
       <string>SCL00021132401004006</string> 
      </void> 
      <void method="add"> 
       <string>SCL00191102067678580</string> 
      </void> 
      <void method="add"> 
       <string>SCL00111102067208799</string> 
      </void> 
      <void method="add"> 
       <string>SCL00121102067255033</string> 
      </void> 
      <void method="add"> 
       <string>SCL00061139206122020</string> 
      </void> 
      <void method="add"> 
       <string>SCL00101108379793777</string> 
      </void> 
      <void method="add"> 
       <string>SCL00011132400920246</string> 
      </void> 
      <void method="add"> 
       <string>SCL00001132400879057</string> 
      </void> 
      <void method="add"> 
       <string>SCL00141102067408862</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>(顧問提供的)</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00051221612480089</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/09/17 08:48:00</string> 
     </void> 
     <void property="id"> 
      <string>SCF00051221612480089</string> 
     </void> 
     <void property="name"> 
      <string>MIS</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00001221612491355</string> 
      </void> 
      <void method="add"> 
       <string>SCL00041226456872524</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00051226985915885</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/11/18 13:25:15</string> 
     </void> 
     <void property="id"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="name"> 
      <string>Client</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041226985843214</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00061228293410074</string> 
      </void> 
      <void method="add"> 
       <string>SCL00031368775140247</string> 
      </void> 
      <void method="add"> 
       <string>SCL00361300344812880</string> 
      </void> 
      <void method="add"> 
       <string>SCL00391307953879424</string> 
      </void> 
      <void method="add"> 
       <string>SCL00041226985850508</string> 
      </void> 
      <void method="add"> 
       <string>SCL00321287982186283</string> 
      </void> 
      <void method="add"> 
       <string>SCL00451533006214046</string> 
      </void> 
      <void method="add"> 
       <string>SCL00051481792955176</string> 
      </void> 
      <void method="add"> 
       <string>SCL00351300098563864</string> 
      </void> 
      <void method="add"> 
       <string>SCL00251280397834700</string> 
      </void> 
      <void method="add"> 
       <string>SCL00261280397889824</string> 
      </void> 
      <void method="add"> 
       <string>SCL00001360054366687</string> 
      </void> 
      <void method="add"> 
       <string>SCL00011366944386927</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00051307586042458</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/06/09 10:20:42</string> 
     </void> 
     <void property="id"> 
      <string>SCF00051307586042458</string> 
     </void> 
     <void property="name"> 
      <string>client</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031307504074135</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00061307586058505</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00061096524105449</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/09/30 14:01:45</string> 
     </void> 
     <void property="id"> 
      <string>SCF00061096524105449</string> 
     </void> 
     <void property="name"> 
      <string>leave</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031096524071477</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00021096524133452</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00061211339110866</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/05/21 11:05:10</string> 
     </void> 
     <void property="id"> 
      <string>SCF00061211339110866</string> 
     </void> 
     <void property="name"> 
      <string>RMA</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00111215581833819</string> 
      </void> 
      <void method="add"> 
       <string>SCL00051211866267548</string> 
      </void> 
      <void method="add"> 
       <string>SCL00041211339797866</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00061245913388659</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2009/06/25 15:03:08</string> 
     </void> 
     <void property="id"> 
      <string>SCF00061245913388659</string> 
     </void> 
     <void property="name"> 
      <string>MISTOOL</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021209086907130</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00061245913402440</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00071247640707129</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2009/07/15 14:51:47</string> 
     </void> 
     <void property="id"> 
      <string>SCF00071247640707129</string> 
     </void> 
     <void property="name"> 
      <string>PO</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00071247640723078</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00081177250221609</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/09/02 08:35:25</string> 
     </void> 
     <void property="id"> 
      <string>SCF00081177250221609</string> 
     </void> 
     <void property="name"> 
      <string>PR</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001154842169093</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00281177601933625</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>(顧問提供的)-請購、採購、採購變更流程</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00081250755035080</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/03/14 15:15:38</string> 
     </void> 
     <void property="id"> 
      <string>SCF00081250755035080</string> 
     </void> 
     <void property="name"> 
      <string>Common</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001154842169093</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00091250755035083</string> 
      </void> 
      <void method="add"> 
       <string>SCF00101250755035086</string> 
      </void> 
      <void method="add"> 
       <string>SCF00111250755035089</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00091213169988915</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 15:39:48</string> 
     </void> 
     <void property="id"> 
      <string>SCF00091213169988915</string> 
     </void> 
     <void property="name"> 
      <string>PLM</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00211213170224737</string> 
      </void> 
      <void method="add"> 
       <string>SCF00161213170082195</string> 
      </void> 
      <void method="add"> 
       <string>SCF00181213170131754</string> 
      </void> 
      <void method="add"> 
       <string>SCF00101213170010924</string> 
      </void> 
      <void method="add"> 
       <string>SCF00111213170028219</string> 
      </void> 
      <void method="add"> 
       <string>SCF00141213170046263</string> 
      </void> 
      <void method="add"> 
       <string>SCF00131213170041299</string> 
      </void> 
      <void method="add"> 
       <string>SCF00301215516853448</string> 
      </void> 
      <void method="add"> 
       <string>SCF00121213170035009</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>PLM System</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00091250755035083</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/08/27 00:48:48</string> 
     </void> 
     <void property="id"> 
      <string>SCF00091250755035083</string> 
     </void> 
     <void property="name"> 
      <string>Client</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00081250755035080</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00091250755035097</string> 
      </void> 
      <void method="add"> 
       <string>SCL00101250755035099</string> 
      </void> 
      <void method="add"> 
       <string>SCL00111250755035102</string> 
      </void> 
      <void method="add"> 
       <string>SCL00121250755035105</string> 
      </void> 
      <void method="add"> 
       <string>SCL00131250755035107</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00101213170010924</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 15:40:10</string> 
     </void> 
     <void property="id"> 
      <string>SCF00101213170010924</string> 
     </void> 
     <void property="name"> 
      <string>ECN</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091213169988915</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00101250755035086</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/07/10 18:41:10</string> 
     </void> 
     <void property="id"> 
      <string>SCF00101250755035086</string> 
     </void> 
     <void property="name"> 
      <string>Server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00081250755035080</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00141250755035110</string> 
      </void> 
      <void method="add"> 
       <string>SCL00151250755035112</string> 
      </void> 
      <void method="add"> 
       <string>SCL00171250755035117</string> 
      </void> 
      <void method="add"> 
       <string>SCL00181250755035120</string> 
      </void> 
      <void method="add"> 
       <string>SCL00191250755035123</string> 
      </void> 
      <void method="add"> 
       <string>SCL00201250755035126</string> 
      </void> 
      <void method="add"> 
       <string>SCL00211250755035128</string> 
      </void> 
      <void method="add"> 
       <string>SCL00221250755035131</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00111213170028219</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 15:40:28</string> 
     </void> 
     <void property="id"> 
      <string>SCF00111213170028219</string> 
     </void> 
     <void property="name"> 
      <string>ECR</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091213169988915</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00111250755035089</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/12/03 01:28:55</string> 
     </void> 
     <void property="id"> 
      <string>SCF00111250755035089</string> 
     </void> 
     <void property="name"> 
      <string>Util</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00081250755035080</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00231250755035133</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>小funciton</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00121179635187359</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/05/20 12:26:27</string> 
     </void> 
     <void property="id"> 
      <string>SCF00121179635187359</string> 
     </void> 
     <void property="name"> 
      <string>Config</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001154842169093</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00011152000677625</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>20070520 請購、採購、採購變更流程之後新增</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00121213170035009</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 15:40:35</string> 
     </void> 
     <void property="id"> 
      <string>SCF00121213170035009</string> 
     </void> 
     <void property="name"> 
      <string>MECN</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091213169988915</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00131213170041299</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 15:40:41</string> 
     </void> 
     <void property="id"> 
      <string>SCF00131213170041299</string> 
     </void> 
     <void property="name"> 
      <string>ER</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091213169988915</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00141213170046263</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 15:40:46</string> 
     </void> 
     <void property="id"> 
      <string>SCF00141213170046263</string> 
     </void> 
     <void property="name"> 
      <string>EQ</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091213169988915</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00161213170082195</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 15:41:22</string> 
     </void> 
     <void property="id"> 
      <string>SCF00161213170082195</string> 
     </void> 
     <void property="name"> 
      <string>Common</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091213169988915</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00021229049977055</string> 
      </void> 
      <void method="add"> 
       <string>SCF00281213180209899</string> 
      </void> 
      <void method="add"> 
       <string>SCF00351217475842115</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00161370400796920</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2013/06/05 10:53:16</string> 
     </void> 
     <void property="id"> 
      <string>SCF00161370400796920</string> 
     </void> 
     <void property="name"> 
      <string>AB</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00181370400890358</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00181213170131754</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 15:42:11</string> 
     </void> 
     <void property="id"> 
      <string>SCF00181213170131754</string> 
     </void> 
     <void property="name"> 
      <string>Config</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091213169988915</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00181370400890358</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2013/06/05 10:54:50</string> 
     </void> 
     <void property="id"> 
      <string>SCF00181370400890358</string> 
     </void> 
     <void property="name"> 
      <string>Server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00161370400796920</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00441499060788739</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00191213170155089</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 15:42:35</string> 
     </void> 
     <void property="id"> 
      <string>SCF00191213170155089</string> 
     </void> 
     <void property="name"> 
      <string>CUSTOMER</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021229049977055</string> 
     </void> 
     <void property="synopsis"> 
      <string>客戶資料簽收單</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00211213170224737</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 15:43:44</string> 
     </void> 
     <void property="id"> 
      <string>SCF00211213170224737</string> 
     </void> 
     <void property="name"> 
      <string>CAM</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091213169988915</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00241213176827229</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 17:33:47</string> 
     </void> 
     <void property="id"> 
      <string>SCF00241213176827229</string> 
     </void> 
     <void property="name"> 
      <string>Common</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00251213176848084</string> 
      </void> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00311286783561499</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00251213176848084</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 17:34:08</string> 
     </void> 
     <void property="id"> 
      <string>SCF00251213176848084</string> 
     </void> 
     <void property="name"> 
      <string>Server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00241213176827229</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00061213176883566</string> 
      </void> 
      <void method="add"> 
       <string>SCL00161222251459724</string> 
      </void> 
      <void method="add"> 
       <string>SCL00091230018633669</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00281213180209899</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 18:30:09</string> 
     </void> 
     <void property="id"> 
      <string>SCF00281213180209899</string> 
     </void> 
     <void property="name"> 
      <string>Server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00161213170082195</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00131237179798492</string> 
      </void> 
      <void method="add"> 
       <string>SCL00071213180226962</string> 
      </void> 
      <void method="add"> 
       <string>SCL00111235028720052</string> 
      </void> 
      <void method="add"> 
       <string>SCL00371304154561490</string> 
      </void> 
      <void method="add"> 
       <string>SCL00101357892989589</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00301215516853448</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/07/08 19:34:13</string> 
     </void> 
     <void property="id"> 
      <string>SCF00301215516853448</string> 
     </void> 
     <void property="name"> 
      <string>MAN</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091213169988915</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00091215516896632</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00321216878882287</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/07/24 13:54:42</string> 
     </void> 
     <void property="id"> 
      <string>SCF00321216878882287</string> 
     </void> 
     <void property="name"> 
      <string>PH</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00121216878888116</string> 
      </void> 
      <void method="add"> 
       <string>SCL00011225331685222</string> 
      </void> 
      <void method="add"> 
       <string>SCL00081250573085426</string> 
      </void> 
      <void method="add"> 
       <string>SCL00021225676980243</string> 
      </void> 
      <void method="add"> 
       <string>SCL00031225701287691</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptForder1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF00351217475842115</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/07/31 11:44:02</string> 
     </void> 
     <void property="id"> 
      <string>SCF00351217475842115</string> 
     </void> 
     <void property="name"> 
      <string>dms</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00161213170082195</string> 
     </void> 
     <void property="scriptLibraryIdList"> 
      <void method="add"> 
       <string>SCL00141217475919273</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>ekm 文件整合 For PLM</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCF_GLOBAL_ROOTSCRIPT</string> 
    <object class="pe.pde.ScriptForder"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/01/03 17:15:09</string> 
     </void> 
     <void property="id"> 
      <string>SCF_GLOBAL_ROOTSCRIPT</string> 
     </void> 
     <void property="name"> 
      <string>GCE Script Library</string> 
     </void> 
     <void property="parentId"> 
      <string>SCFROOT</string> 
     </void> 
     <void property="scriptForderIdList"> 
      <void method="add"> 
       <string>SCF00001159252679531</string> 
      </void> 
     </void> 
     <void property="synopsis"> 
      <string>Your Company Name ScriptLibrary</string> 
     </void> 
    </object> 
   </void> 
  </void> 
  <void property="scriptLibraryMap"> 
   <void method="put"> 
    <string>SCL00001090375075160</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/07/21 09:57:55</string> 
     </void> 
     <void property="fullName"> 
      <string>com.flowring.util</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001090375075160</string> 
     </void> 
     <void property="name"> 
      <string>util</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011181776157390</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function formatDate(dateTime)
{
	var date = null;
	if ((dateTime != null) &amp;&amp; (!&quot;&quot;.equals(dateTime)))
	{
		try
		{
			if (dateTime instanceof java.util.Date)
			{
				date = dateTime;
			}
			else
			{
				date = java.util.Date.valueOf(dateTime.toString());
			}
		} catch(e)
		{
		}
	}

	if (date != null)
	{
		var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd&quot;);
		return simpledateformat.format(date);
	}
	else
	{
		return &quot;&quot;;
	}
}

function formatDecimal(num_str, pattern)
{	
	try
	{
		var number = java.lang.Double.parseDouble(num_str);
		var format = new java.text.DecimalFormat(pattern);
		return format.format(number);
	}catch(e)
	{
		return &quot;&quot;;
	}
}

function getFormatedCurrentTime(){
    var date = new java.util.Date(java.lang.System.currentTimeMillis());
    var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
    return simpledateformat.format(date);
}

function setAllDepNameToCombobox(comboboxName){
	var temp = Form.getValue(comboboxName);
	var vecDepName = Client.getAllDepNameOfCompany();
	var comDep1 = Form.getComponent(comboboxName);
	comDep1.removeAllItems();
	comDep1.addItem(&quot;&quot;);
	for (var i=0; i &lt; vecDepName.size(); i++) 
	{
		comDep1.addItem(vecDepName.get(i));
	}
	if ((temp != null) &amp;&amp; !temp.trim().equals(&quot;&quot;))	
		Form.setValue(comboboxName,temp);
}

function setAllMemberOfDepToCombobox(depComboboxName, mbrComboboxName){
	var depName = Form.getValue(depComboboxName);
	var vecMember = getAllMemberOfDep(depName);
 	var comb2 = Form.getComponent(mbrComboboxName);
	comb2.removeAllItems();
	comb2.addItem(&quot;&quot;);
	for (var i=0; i &lt; vecMember.size(); i++) {
		comb2.addItem(vecMember.get(i));
	}
}

function getAllMemberOfDep(sDepName){
	//return department object
	var vecDep = Client.getAllDepartmentByName(sDepName);
	var dep = vecDep.get(0);
	var vecRoleID = dep.getRoleList();
	var vecMember = new java.util.Vector();
	for (var i = 0; i&lt; vecRoleID.size() ; i++){
		var role = Client.getRole(vecRoleID.get(i));
		var vecMemID = role.getMemberList();
		for (var j = 0; j&lt; vecMemID.size() ; j++){
			vecMember.add(Client.getMemberByID(vecMemID.get(j)));
		}
	}
	return vecMember;
}

function setAllDepToComboBox(comboBoxName){
	var DepartmentNameList = Client.getAllDepNameOfCompany();
	DepartmentNameList.add(0, &quot;&quot;);
	var defaultValue = null;
	if(Client != null){
		var mr = Client.getCurrentMember();
		var mDR = mr.getMemberDR(mr.getMainRoleID());
		defaultValue = mDR.getDepartmentName();
	}
	setVectorToComboBox(comboBoxName,DepartmentNameList,defaultValue);
}

function setAllDepMemberToComboBox(comboBoxName,DepName){
	var memberNameList  = new java.util.Vector();
	memberNameList.add(&quot;&quot;);
	var DepartmentList = Client.getAllDepartmentByName(DepName);
	for(var i=0;i&lt;DepartmentList.size();i++){
			var depObj =DepartmentList.get(i);
			var depID = depObj.getID();
			var memList = Client.getSubMemberCNameOfDR(depID,true);
			memberNameList.addAll(memList);
	}
	setVectorToComboBox(comboBoxName,memberNameList,null);
}

function setVectorToComboBox(comboBoxName,valueList,defaultValue){
	var comboBox = Form.getComponent(comboBoxName);
	comboBox.removeAllItems();
	for(var i=0;i&lt;valueList.size();i++){
			var Result = valueList.get(i)
			comboBox.addItem(Result);
	}
	if( defaultValue != null ){
			comboBox.setSelectedItem(defaultValue);
			var selectItem = comboBox.getSelectedItem();
			//HTML表單要多加此行,From.getValue才拿的到預設值
			Form.setValue(comboBoxName,defaultValue);
	}
}

function setDeputy(mID,deputyID,startDate,startHour,startMin,endDate,endHour,endMin){
	var mr = Server.getMemberByID(mID);
	mr.setDeputyID(deputyID);
	mr.setExeucteDeputyDuration(true);
	mr.setStartExecuteDeputyTime(startDate+&quot; &quot;+startHour+&quot;:&quot;+startMin);
	mr.setEndExecuteDeputyTime(endDate+&quot; &quot;+endHour+&quot;:&quot;+endMin);
	Server.updateMemberRecord(mr);
}</string> 
     </void> 
     <void property="synopsis"> 
      <string>Utilities functions</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001095842798154</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/09/22 16:46:38</string> 
     </void> 
     <void property="fullName"> 
      <string>com.flowring.org</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001095842798154</string> 
     </void> 
     <void property="name"> 
      <string>org</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011181776157390</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//script library 
//com.flowring.org
//
//-----------------------------------------------------------------------------
//
//Server端專用
//取得此Role上方所有主管,若以人員當參數時只能取得mainRole,
//但實際上可能以各種身份啟動流程,所以以Role來取得簽核人員較佳
//此method不取出company的manager,因為大多數情況下是不須簽至董事長的
//若輸入參數的roleID就是managerID則再向上取一層

/*
example
	var roleID = Form.getCurrentTask().getRoleID();
	var vecManagerIDs = getManagerMemIDs(roleID);
*/

function getManagerMemIDs(roleID) {
	var vec = new Packages.java.util.Vector();
	//因為是取得manager,所以不含自己,先取上一層再丟入
	var currentRole = Server.getRole(roleID);
	var parentID = currentRole.getParentID();
	//parentID有可能為部門或職務,若是部門時要檢查是否本身這個role為此部門主管,若是則再向上找
	if (parentID.startsWith(&quot;DEP&quot;)) {
		parentDep = Server.getDepartment(parentID);
		var managerID = parentDep.getManagerID();
		if (managerID.equals(roleID)) {
			//此role即為部門的主管,再向上找一層
			parentID = parentDep.getParentID();
		}
	}
	managerTrace(parentID, vec);
	return vec;
}

//   1. Get the org tree trace in terms manager, input is UID
//   2. return is Vector v,  v[0] is lowest-level manager, v[1] is 2nd-level manager, etc.
//DRID : Department or Role ID, &quot;DEPXXX&quot; or &quot;ROLXXX&quot;
//若主管職務有多人時取出第一位
//可取至company主管
//若有設職務,但職務內無人時則略過此層級
function managerTrace(DRID, vec) {
	var role, dep;
	if (DRID.startsWith(&quot;ROL&quot;)) {
		role = Server.getRole(DRID);
		var vecMemID = role.getMemberList();
		if (vecMemID.size() &gt; 0) {
			vec.add(vecMemID.get(0));
		}
		managerTrace(role.getParentID(), vec);
	} else if (DRID.startsWith(&quot;DEP&quot;)) {
		dep = Server.getDepartment(DRID);
		var managerID = dep.getManagerID();
		//managerID可能是&quot;&quot;(上層主管,繼續往上找), &quot;MEMXXX&quot; 或 &quot;ROLXXX&quot;
		//若是設上層主管,則取回的memID是空字串,略過
		if (managerID.startsWith(&quot;ROL&quot;)) {
			role = Server.getRole(managerID);
			var vecMemID = role.getMemberList();
			if (vecMemID.size() &gt; 0) {
				vec.add(vecMemID.get(0));
			}
		} else if (managerID.startsWith(&quot;MEM&quot;)) {
			vec.add(managerID);
		}
		managerTrace(dep.getParentID(), vec);
	} else if (DRID.equals(&quot;company&quot;)) {
		//到頂了
		var company = Server.getCompany();
		var roleID = company.getManagerID();
		if (roleID.startsWith(&quot;ROL&quot;)) {
			role = Server.getRole(roleID);
			var vecMemID = role.getMemberList();
			if (vecMemID.size() &gt; 0) {
				vec.add(vecMemID.get(0));
			}
		}
	}
	return;
}
//
//-----------------------------------------------------------------------------
//
//透過資料庫取得memName的memID, 若不只一筆時則只取出存在於DRID內的那筆
//可以防止同姓名情況
function getMemberIDInDep(memName, DRName) {
	var DRList;
	DRList = Server.getAllDepartmentByName(DRName); //vec of Department, 有可能同名部門
	if (DRList == null || DRList.size() == 0) {
		//若部門不存在改找職務
		DRList = Server.getAllRoleByName(DRName); //vec of Role, 有可能同名職務
	}
	var memberIDList = new java.util.Vector();
	for(var i=0;i&lt;DRList.size();i++) {
		var DRObj =DRList.get(i);
		var DRID = DRObj.getID();
		var memList = Server.getSubMemberIDOfDR(DRID,true);//recursive to sublevel
		memberIDList.addAll(memList);
	}
	for (var i = 0; i &lt; memberIDList.size(); i++) {
		var name = Server.getMember(memberIDList.get(i)).getName();
		if (memName.equals(name)) {
			return memberIDList.get(i);
		}
	}
	//不存在時
	return &quot;&quot;;
}</string> 
     </void> 
     <void property="synopsis"> 
      <string>Agentflow org related utility</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001110188021296</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/03/07 17:33:41</string> 
     </void> 
     <void property="fullName"> 
      <string>com.flowring.sl</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001110188021296</string> 
     </void> 
     <void property="name"> 
      <string>sl</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011181776157390</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//計算請假時數
function calculateHours(){  
	var startDate = Form.getValue(&quot;sDate&quot;);
	var startHour = Form.getValue(&quot;sHour&quot;);
	var startMin = Form.getValue(&quot;sMin&quot;);
	var endDate = Form.getValue(&quot;eDate&quot;);
	var endHour = Form.getValue(&quot;eHour&quot;);
	var endMin = Form.getValue(&quot;eMin&quot;);

	var hm = getRangeDateHours(startDate, startHour, startMin, endDate, endHour, endMin);
	var errorMsg = hm.get(&quot;error&quot;);
	if (!&quot;&quot;.equals(errorMsg)) {
		Form.showMessageDialog(errorMsg);
		Form.setValue(&quot;totalHours&quot;, 0.0);
		return false;
	} else {
		Form.setValue(&quot;totalHours&quot;, hm.get(&quot;hours&quot;));
		return true;
	}
}


//取得目前申請中表單的某一假別的總請假時數
//	var leaveType = Form.getValue(&quot;leaveType&quot;);
//	var applyerMemID = Form.getValue(&quot;applyerMemID&quot;);
//
function getProcessingHours(leaveType, applyerMemID, insID) {

	//ART00001095659164419 : 請假單
	//ITEM104 : totalHours請假時數 
	//ITEM47 : applyerMemID申請人memID
	//ITEM113 : leaveType假別
	//ITEM14 : giveup作廢
	//ITEM37 : submitted已送出請假單
	//ITEM63 : applyFinished已請假完成
	var sql = &quot;SELECT ITEM104 FROM ART00001095659164419_Ins WHERE ITEM47 = &apos;&quot; + applyerMemID
		+ &quot;&apos; AND InsID != &apos;&quot; + insID
		+ &quot;&apos; AND ITEM113 = &apos;&quot; + leaveType + &quot;&apos; AND ITEM14 != &apos;true&apos; AND ITEM37 = &apos;true&apos; AND ITEM63 != &apos;true&apos;&quot;;
	var vecSql = Client.SQLloadValue(sql);
	
	var totalHours = 0.0;
	for (var i = 0; i &lt; vecSql.size(); i++) {
		totalHours += java.lang.Float.parseFloat(vecSql.get(i).get(&quot;ITEM104&quot;));
	}
	return totalHours;
}




//以中英文姓名找搜尋員工
function searchEmployee() {
	Form.setValue(&quot;deputyDep&quot;, &quot;&quot;);
	Form.setValue(&quot;deputyID&quot;, &quot;&quot;);//隱藏的代理人memid一律清空,切換代理人combox才帶
	//代理人以姓名輸入搜尋,可輸入中文及英文名字,用
	//select username, englishname from mem_geninf where username like &apos;kkkk&apos; or englishname like &apos;kkkk&apos;
	var deputySearch = Form.getValue(&quot;deputySearch&quot;);
	if (!&quot;&quot;.equals(deputySearch)) {
		var lowercase = deputySearch.substring(0,1).toLowerCase() + deputySearch.substring(1,deputySearch.length());
		var uppercase = deputySearch.substring(0,1).toUpperCase() + deputySearch.substring(1,deputySearch.length());
		var s_sqlGeninf = &quot;SELECT UserName, EnglishName FROM Mem_GenInf &quot;
			+ &quot; WHERE (LOWER(UserName) LIKE LOWER(&apos;&quot; + deputySearch + &quot;%&apos;) &quot;
			+ &quot; OR LOWER(EnglishName) LIKE LOWER(&apos;&quot; + deputySearch + &quot;%&apos;) ) AND Resign = &apos;false&apos;&quot;;
java.lang.System.out.println(&quot;sql = &quot; + s_sqlGeninf);
		var vc_Geninf = Client.SQLloadValue(s_sqlGeninf);
		//顯示在下拉選項為UserName
		if (vc_Geninf.size() &gt; 0) {
			Form.setValue(&quot;deputy&quot;,&quot;&quot;)
			var combo = Form.getComponent(&quot;deputy&quot;);//代理人
			combo.removeAllItems();
			combo.addItem(&quot;&quot;);
			for (var i = 0; i &lt; vc_Geninf.size(); i++) {
				var userName = vc_Geninf.get(i).get(&quot;UserName&quot;);
				var englishName = vc_Geninf.get(i).get(&quot;EnglishName&quot;);
				//combo.addItem(userName + &quot;[&quot; + englishName + &quot;]&quot;);
				combo.addItem(userName);
			}
		} else {
			var combo = Form.getComponent(&quot;deputy&quot;);//代理人
			combo.removeAllItems();
			combo.addItem(&quot;&quot;);
		}
	
		//選了某下拉人員後以
		//select memid from mem_geninf where englishname=&apos;ename&apos; and username=&apos;uname&apos;
		//找出此人再設至deputyID
	} else {
		var combo = Form.getComponent(&quot;deputy&quot;);//代理人
		combo.removeAllItems();
		combo.addItem(&quot;&quot;);
	}
}

//
//---------------------------------------------------------------------------------------------------------------------------
//

	/**
	* 測試範例
	*/
	/*
	function main(){
		var startDate=&quot;2004/07/29&quot;;
		var startHour=&quot;08&quot;;
		var startMin=&quot;30&quot;;
		var endDate=&quot;2004/07/29&quot;;
		var endHour=&quot;10&quot;;
		var endMin=&quot;30&quot;;
	
		var HmResult = getRangeDateHours(startDate, startHour, startMin, endDate, endHour, endMin);
		
		print(&quot;錯誤訊息&quot; + HmResult.get(&quot;error&quot;));
		print(&quot;時數為&quot; + HmResult.get(&quot;hours&quot;));
	}
	*/

//-----以下為實際function ----//
	//計算range內請假時數
	function getRangeDateHours(startDate, startHour, startMin, endDate, endHour, endMin){
		var HmResult = new java.util.HashMap();
		var errorMsg = &quot;&quot;;
		var totalHour = 0;
		if(startDate+startHour+startMin &gt; endDate+endHour+endMin){
			errorMsg = &quot;請假結束時間(&quot;+endDate+&quot; &quot;+endHour+&quot;:&quot;+endMin+&quot;)不能大於開始時間(&quot;+startDate+&quot; &quot;+startHour+&quot;:&quot;+startMin+&quot;)&quot;;			
		}else{
			var myDate = new Packages.pase.agenda.MyDate();
			var num = myDate.getSubtractDay(startDate,endDate);
			if(num ==0){
				//當天
				totalHour = getOneDayLeaveHours(startDate,startHour,endHour,startMin,endMin);
			}else{
				for (var i=0;i&lt;=num;i++)	{
					var checkDate = myDate.add(startDate,i);
					if(i == 0){//第一天
						totalHour = totalHour+ getOneDayLeaveHours(checkDate,startHour,&quot;17&quot;,startMin,&quot;30&quot;);
					}else if(i== num){//最後一天
						totalHour = totalHour+ getOneDayLeaveHours(checkDate,&quot;08&quot;,endHour,&quot;30&quot;,endMin);
					}else{//range內
						totalHour = totalHour+ getOneDayLeaveHours(checkDate,startHour,endHour,startMin,endMin);
					}
				}
			}
		}
		HmResult.put(&quot;error&quot;, errorMsg);
		HmResult.put(&quot;hours&quot;, totalHour);
		return HmResult;
	}


	//計算請假時數
	function getOneDayLeaveHours(startDate,startHour,endHour,iStartMin,iEndMin){
		var realHours = 0;
		
		if(Client.isHoliday(startDate)){
			//realHours =0;
		}else{
			if(startHour+startHour &lt; &quot;0830&quot;){
				startHour = &quot;08&quot;;
				iStartMin = &quot;30&quot;;
			}else if(startHour+startHour &gt; &quot;1200&quot; &amp;&amp; startHour+startHour &lt; &quot;1300&quot;){
				startHour = &quot;13&quot;;
				iStartMin = &quot;00&quot;;
			}
			if(endHour+iEndMin &gt; &quot;1730&quot;){
				endHour = &quot;17&quot;;
				iEndMin = &quot;30&quot;;
			}else if(endHour+iEndMin &gt; &quot;1200&quot; &amp;&amp; endHour+iEndMin  &lt; &quot;1300&quot;){
				endHour = &quot;12&quot;;
				iEndMin = &quot;00&quot;;
			}
			
			var totalHour = toInt(endHour) - toInt(startHour);
			var totalMin = toInt(iEndMin) - toInt(iStartMin);
			realHours = totalHour+totalMin/60;
			
			if(startHour+startHour &lt; &quot;1200&quot; &amp;&amp; endHour+iEndMin &gt;&quot;1300&quot;)
				realHours = realHours-1;
				
			if(realHours &lt; 0)
				realHours  = 0;			
		}

		return realHours;
	}
	
	function toInt(stringValue){
		return java.lang.Integer.parseInt(stringValue);

	}

	function print(s){
	   java.lang.System.out.println(s);
	}
//------------------------------------------------------------------------------------------------------------------//</string> 
     </void> 
     <void property="synopsis"> 
      <string>Script from jsp form script library</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001132400879057</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/11/19 19:47:59</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.SystemFunction.SetSenderForSubProcess</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001132400879057</string> 
     </void> 
     <void property="name"> 
      <string>SetSenderForSubProcess</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//設定子流程的送出人員
function setSender(objSenderTextName){
	
   var member = Client.getCurrentMember();
   var mID = member.getID();
   Form.setValue(objSenderTextName.toString(),mID);
   java.lang.System.out.println(&quot;Sender &quot;+member.getName().toString());
   java.lang.System.out.println(&quot;SenderID  &quot;+Form.getValue(objSenderTextName.toString()).toString());
   
}</string> 
     </void> 
     <void property="synopsis"> 
      <string>設定子流程的送出人員</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001155559869484</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/08/14 20:51:09</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Client.SignTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001155559869484</string> 
     </void> 
     <void property="name"> 
      <string>SignTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011156610928578</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

function loadSignTable_e(SignTable,groupname){
         var table = Form.getComponent(SignTable);
           //如果是空的才抓
         if(table.getRowCount()==0){
           var sql = &quot; select A_Group.ID 工號,MEM_GENINF.USERNAME 姓名,loginid from A_Group,MEM_GENINF where  A_Group.GROUPNAME = &apos;&quot;+ groupname +&quot;&apos; and A_Group.ID = MEM_GENINF.ID &quot; ;
           var vector = Client.SQLloadValue(sql);
           table.clear();
           if ( vector != null ){
               Form.setValue(&quot;Count&quot;,vector.size());
			   if (vector.size()&gt;0){
				   for(var i=0;i&lt;vector.size();i++)  {
					   var ht = vector.get(i);
					   var row = table.newRow()-1;
					   var cMember = Client.getMember(ht.get(&quot;loginid&quot;));
					   var roleID = cMember.getMainRoleID();
					   var memDR = cMember.getMemberDR(roleID);
					   var sDepName = &quot;未定&quot;;
            	           if(memDR != null){
							   sDepName = memDR.getDepartmentName(); //使用者部門名稱
						   }
                       table.setValueAt(sDepName,row,&quot;會簽單位&quot;);
                       table.setValueAt(ht.get(&quot;工號&quot;),row,&quot;工號&quot;);
                       table.setValueAt(ht.get(&quot;姓名&quot;),row,&quot;姓名&quot;);          
                   }//for
			   }
           }
         }         
}
//============================================================== 
// Client 將CurrentTask 會簽結果放入審核意見裡面
//============================================================== 
function setSignTableResult(process_table){
          //將會簽結果放入審核意見裡面
          var process_table = Form.getComponent(process_table);
          //process_table.clear();
          var task = Form.getCurrentTask(); 
               if(task == null){
                   return ;
                 };
          var taskmemberlist = task.getAddASAuditList() ; 
		  var vTitle=task.getAddASTitle(); //會簽主旨
		      if(&quot;&quot;!=vTitle){
//		      vTitle = &quot;會簽主旨:&quot;+vTitle.trim();
			  }
          var TotalResult =task.getAddASResultString(); //取得加會簽結果的字串                  
                  //------------------------------------------------------------------------------------------
                  // 20080107 cc
                  //因 aCSResultData.getMsg(); //簽核意見的api會有切割不完整的問題，改 function 來抓會簽意見
          var tag = &quot;========================================================&quot;;
          var msg = SplitString(TotalResult,tag);
                  //------------------------------------------------------------------------------------------
          var detailresult =Client.parseAddASResultString(TotalResult);   //將加會簽結果的字串解析成個別的物件形式 
          var flg_reject = false;                 
                  //--------------------------------------------------------------------------------------------
                  //20090212 cc
                  //以會簽關卡(雙人ICON)再進行動態加會簽也要取得到會簽資訊
                  //--------------------------------------------------------------------------------------------
           if(detailresult.size()&gt;0){
              for(var i = 0; i&lt; detailresult.size(); i++){
                 try{
                      var flg = true;        
                //process_table.clear();//有資料才清 table
                       var aCSResultData = detailresult.get(i);
					   var l_time = aCSResultData.getTime(&quot;yyyy/MM/dd HH:mm&quot;);
					   var l_name = aCSResultData.getName(); //只能拿到姓名，沒有工號可用
					   var l_role = aCSResultData.getRole(); //職稱
					   var l_dep = aCSResultData.getDep();
					    	l_name = l_name.substring(0,l_name.indexOf(&quot;(&quot;));
//------------------------取得職稱---modi by wangwei@2009/03/19 解決同名同姓讀取職稱的問題------							
						var vDep = &quot;%&quot;+l_dep.substring(0,3);
						var vSQL = &quot;select jobtitle from mem_geninf where username =&apos;&quot;+l_name+&quot;&apos; and workplace like &apos;&quot;+vDep+&quot;&apos;&quot;;
						var vec = Client.SQLloadValue(vSQL);
						var vJobTitle=&quot;&quot;;
						if(vec.get(0).get(&quot;jobtitle&quot;) != null ){
							vJobTitle =vec.get(0).get(&quot;jobtitle&quot;);
						}
//--------------------------------------											
			            var l_msg = msg[i]; //簽核意見
						var l_result = &quot;未表示&quot;;
						if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Agree&quot;)){
							l_result = &quot;同意&quot;;
						}else if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Disagree&quot;)||aCSResultData.getSignResult().equalsIgnoreCase(&quot;reject&quot;)){
                                l_result = &quot;不同意&quot;;
                                flg_reject = true ;
                        }
						
                        for (var j=0;j&lt;process_table.getRowCount();j++){
                                //check 會簽人的工號+簽核時間有無在 SingTable 內，有的話就 update table 內的簽核及審核意見
                                //如果不在 table 內就加到最後
                                t_name = process_table.getValueAt(j,&quot;姓名&quot;);
                                t_yes = process_table.getValueAt(j,&quot;是否核准&quot;);
                                t_time =process_table.getValueAt(j,&quot;審核日期&quot;);
                                if (l_name.equals(t_name)&amp;&amp; l_time.equals(t_time)){
//                                        process_table.setValueAt(vTitle+l_msg,j,&quot;審核意見&quot;);//ITEM5 審核意見
										process_table.setValueAt(l_msg,j,&quot;審核意見&quot;);//ITEM5 審核意見
                                        process_table.setValueAt(l_result,j,&quot;是否核准&quot;);//同意
                                        //j = process_table.getRowCount();//跳出 for j
                                        flg = false;
                                }
                        }//for j
                        if(flg == true){
                                //不在 table 內就加到最後
                                var row = process_table.newRow() - 1;
                                var l_member = Client.getMemberByCName(l_name);
                                var l_id = l_member.getMyID();                            
                                process_table.setValueAt(l_id, row, &quot;工號&quot;);//
                                process_table.setValueAt(l_name, row, &quot;姓名&quot;);//
                                process_table.setValueAt(l_msg, row, &quot;審核意見&quot;);//ITEM5 審核意見
                                process_table.setValueAt(l_result, row,&quot;是否核准&quot;);//同意                
                                process_table.setValueAt(l_time, row,&quot;審核日期&quot;);//日期  
                                //加簽的要補工號、部門及分機
                                var sMember = Client.getMemberByCName(l_name);
                                if(sMember != null){
                                        var roleID = sMember.getMainRoleID();
                                        var rolename = Client.getRole(roleID).getName();
                                        var memDR = sMember.getMemberDR(roleID);
                                        var sDepName = memDR.getDepartmentName();        //使用者部門名稱
                                        process_table.setValueAt(row+1+&quot;&quot;,row,&quot;序號&quot;);
                                        process_table.setValueAt(l_dep,row,&quot;部門&quot;);
                                        process_table.setValueAt(&quot;*動態加會簽&quot;,row,&quot;關卡名稱&quot;);
                                        //process_table.setValueAt(l_role,row,&quot;職稱&quot;);
// ---------------------add by wangwei@2009/3/19 解決同名同姓的問題										
										if(&quot;&quot;==vJobTitle){
											vJobTitle = sMember.getJobTitle();//GCE Member.getJobTitle();
											}										
                                        process_table.setValueAt(vJobTitle,row,&quot;職稱&quot;);
                                        process_table.setValueAt(task.getID(),row,&quot;TaskID&quot;);                                   
                                        }                                        
                                }
                     }catch(e){}                               
                }//for i
             }else{                              
                try{
				    if( &quot;ART01081221466085083&quot; != Form.getCurrentTask().getArtInstance().getArtifactID() &amp;&amp; &quot;ART01001231233951714&quot; != Form.getCurrentTask().getArtInstance().getArtifactID() ){
					   var rootid = task.getRootID();
					   var sql_note = &quot; select note from signins where note is not null and note like &apos;[%========================================================%&apos; and tskid in (select tskid from task where rootid = &apos;&quot;+ rootid +&quot;&apos;)&quot;;
					   var vec_note = Client.SQLloadValue(sql_note);
					   if(vec_note != null &amp;&amp; vec_note.size()&gt;0){
						   for(var k=0; k&lt;vec_note.size();k++){
							   detailresult = Client.parseAddASResultString(vec_note.get(k).get(&quot;Note&quot;));   //將加會簽結果的字串解析成個別的物件形式
							   msg = SplitString(vec_note.get(k).get(&quot;Note&quot;),tag);
							   flg_reject = addCSProcess_table(process_table,detailresult,msg,flg_reject,task);
							  }
						  }														  
					  }					   
                   }catch(e){}
                  }
        }
 
function addCSProcess_table(process_table,detailresult,msg,flg_reject,task){
          var task = Form.getCurrentTask(); 
               if(task == null){
				   var vTitle=&quot;&quot;;
                 };
		  var vTitle=task.getAddASTitle(); //會簽主旨
	
        for(var i = 0; i&lt; detailresult.size(); i++){
            try{
                var flg = true;        
                //process_table.clear();//有資料才清 table
                var aCSResultData = detailresult.get(i);
				var l_time = aCSResultData.getTime(&quot;yyyy/MM/dd HH:mm&quot;);
				var l_name = aCSResultData.getName(); //只能拿到姓名，沒有工號可用
                var l_role = aCSResultData.getRole(); //職稱
                var l_dep = aCSResultData.getDep();
                     l_name = l_name.substring(0,l_name.indexOf(&quot;(&quot;));
//------------------------取得職稱---modi by wangwei@2009/03/19 解決同名同姓讀取職稱的問題------							
				var vDep = &quot;%&quot;+l_dep.substring(0,3);
				var vSQL = &quot;select jobtitle from mem_geninf where username =&apos;&quot;+l_name+&quot;&apos; and workplace like &apos;&quot;+vDep+&quot;&apos;&quot;;
				var vec = Client.SQLloadValue(vSQL);
				var vJobTitle=&quot;&quot;;
					if(vec.get(0).get(&quot;jobtitle&quot;) != null ){
						vJobTitle =vec.get(0).get(&quot;jobtitle&quot;);
					}
//--------------------------------------																 

                var l_msg = msg[i]; //簽核意見
				var l_result = &quot;未表示&quot;;
				if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Agree&quot;)){
					l_result = &quot;同意&quot;;
				}else if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Disagree&quot;)||aCSResultData.getSignResult().equalsIgnoreCase(&quot;reject&quot;)){
                     l_result = &quot;不同意&quot;;
                     flg_reject = true ;
                 }
                for (var j=0;j&lt;process_table.getRowCount();j++){
                                //check 會簽人的工號+簽核時間有無在 SingTable 內，有的話就 update table 內的簽核及審核意見
                                //如果不在 table 內就加到最後
                     t_name = process_table.getValueAt(j,&quot;姓名&quot;);
                     t_yes = process_table.getValueAt(j,&quot;是否核准&quot;);
                     t_time =process_table.getValueAt(j,&quot;審核日期&quot;);
                     if (l_name.equals(t_name)&amp;&amp; l_time.equals(t_time)){
                         process_table.setValueAt(l_msg,j,&quot;審核意見&quot;);//ITEM5 審核意見
                         process_table.setValueAt(l_result,j,&quot;是否核准&quot;);//同意
                         flg = false;
                        }
                 }//for j
                 if(flg == true){
                             //不在 table 內就加到最後
                     var row = process_table.newRow() - 1;
                     var l_member = Client.getMemberByCName(l_name);
                     var l_id = l_member.getMyID();                            
                          process_table.setValueAt(l_id, row, &quot;工號&quot;);//
                          process_table.setValueAt(l_name, row, &quot;姓名&quot;);//
                          process_table.setValueAt(l_msg, row, &quot;審核意見&quot;);//ITEM5 審核意見
                          process_table.setValueAt(l_result, row,&quot;是否核准&quot;);//同意                
                          process_table.setValueAt(l_time, row,&quot;審核日期&quot;);//日期  
                                //加簽的要補工號、部門及分機
                     var sMember = Client.getMemberByCName(l_name);
                         if(sMember != null){
                             var roleID = sMember.getMainRoleID();
                             var rolename = Client.getRole(roleID).getName();
                             var memDR = sMember.getMemberDR(roleID);
                             var sDepName = memDR.getDepartmentName();        //使用者部門名稱
                                  process_table.setValueAt(row+1+&quot;&quot;,row,&quot;序號&quot;);
                                  process_table.setValueAt(l_dep,row,&quot;部門&quot;);
                                  process_table.setValueAt(&quot;*動態加會簽&quot;,row,&quot;關卡名稱&quot;);
                                       //process_table.setValueAt(l_role,row,&quot;職稱&quot;);
// ---------------------add by wangwei@2009/3/19 解決同名同姓的問題										
									if(&quot;&quot;==vJobTitle){
										vJobTitle = sMember.getJobTitle();//GCE Member.getJobTitle();
										}																			   
                                  process_table.setValueAt(vJobTitle,row,&quot;職稱&quot;);//GCE Member.getJobTitle();
                                  process_table.setValueAt(task.getID(),row,&quot;TaskID&quot;);                                   
       
                                        }                                        
                                }
                                }catch(e){}                               
                        }//for i
                return flg_reject;
        }




//==============================================================	
// Client 將CurrentTask 會簽結果放入審核意見裡面  20090216 更新如上的部份,因動態加會簽不能使用 For Peppers
//==============================================================	
	function setSignTableResult_OLD(process_table){
          //將會簽結果放入審核意見裡面
          var process_table = Form.getComponent(process_table);
          //process_table.clear();
          var task = Form.getCurrentTask(); 
		  if(task == null){
			  return ;
			};
          var taskmemberlist = task.getAddASAuditList() ; 
          var TotalResult =task.getAddASResultString(); //取得加會簽結果的字串		  
		  //------------------------------------------------------------------------------------------
		  // 20080107 cc
		  //因 aCSResultData.getMsg(); //簽核意見的api會有切割不完整的問題，改 function 來抓會簽意見
		  var tag = &quot;========================================================&quot;;
		  var msg = SplitString(TotalResult,tag);
		  //------------------------------------------------------------------------------------------
          var detailresult =Client.parseAddASResultString(TotalResult);   //將加會簽結果的字串解析成個別的物件形式 
		  var flg_reject = false;
		  for(var i = 0; i&lt; detailresult.size(); i++){
			try{
			var flg = true;	      
           	//process_table.clear();//有資料才清 table
			var aCSResultData = detailresult.get(i);
            var l_time = aCSResultData.getTime(&quot;yyyy/MM/dd HH:mm&quot;);
            var l_name = aCSResultData.getName(); //只能拿到姓名，沒有工號可用
			var l_role = aCSResultData.getRole(); //職稱
			var l_dep = aCSResultData.getDep();
			l_name = l_name.substring(0,l_name.indexOf(&quot;(&quot;));
			var l_msg = msg[i]; //簽核意見
            var l_result = &quot;未表示&quot;;
            if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Agree&quot;)){
                l_result = &quot;同意&quot;;
            }else if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Disagree&quot;)||aCSResultData.getSignResult().equalsIgnoreCase(&quot;reject&quot;)){
  				l_result = &quot;不同意&quot;;
				flg_reject = true ;
			}
			for (var j=0;j&lt;process_table.getRowCount();j++){
				//check 會簽人的工號+簽核時間有無在 SingTable 內，有的話就 update table 內的簽核及審核意見
				//如果不在 table 內就加到最後
				t_name = process_table.getValueAt(j,&quot;姓名&quot;);
				t_yes = process_table.getValueAt(j,&quot;是否核准&quot;);
				t_time =process_table.getValueAt(j,&quot;審核日期&quot;);
				if (l_name.equals(t_name)&amp;&amp; l_time.equals(t_time)){
					process_table.setValueAt(l_msg,j,&quot;審核意見&quot;);//ITEM5 審核意見
					process_table.setValueAt(l_result,j,&quot;是否核准&quot;);//同意
					//j = process_table.getRowCount();//跳出 for j
					flg = false;
				}
			}//for j

			if(flg == true){
				//不在 table 內就加到最後
				var row = process_table.newRow() - 1;
				var l_member = Client.getMemberByCName(l_name);
				var l_id = l_member.getMyID();				
				process_table.setValueAt(l_id, row, &quot;工號&quot;);//
				process_table.setValueAt(l_name, row, &quot;姓名&quot;);//
				process_table.setValueAt(l_msg, row, &quot;審核意見&quot;);//ITEM5 審核意見
				process_table.setValueAt(l_result, row,&quot;是否核准&quot;);//同意		
				process_table.setValueAt(l_time, row,&quot;審核日期&quot;);//日期	
				//加簽的要補工號、部門及分機
				var sMember = Client.getMemberByCName(l_name);
				if(sMember != null){
					var roleID = sMember.getMainRoleID();
					var rolename = Client.getRole(roleID).getName();
					var memDR = sMember.getMemberDR(roleID);
					var sDepName = memDR.getDepartmentName();	//使用者部門名稱
					process_table.setValueAt(row+1+&quot;&quot;,row,&quot;序號&quot;);
					process_table.setValueAt(l_dep,row,&quot;部門&quot;);
					process_table.setValueAt(&quot;*動態加會簽&quot;,row,&quot;關卡名稱&quot;);
					//process_table.setValueAt(l_role,row,&quot;職稱&quot;);
					process_table.setValueAt(sMember.getJobTitle(),row,&quot;職稱&quot;);//GCE Member.getJobTitle();
					process_table.setValueAt(task.getID(),row,&quot;TaskID&quot;);					
					//process_table.setValueAt(sMember.getMyID(),row,&quot;工號&quot;);
					//process_table.setValueAt(sMember.getOfficePhone(),row,&quot;電話&quot;);
					}
					
				}
				}catch(e){}
			}//for i
			/*
			//這一段用來判斷會簽的意見內有沒有人不同意的
			if (flg_reject == true){
				Form.setValue(&quot;Add_Sign_Reject&quot;,true);
			}else{
				Form.setValue(&quot;Add_Sign_Reject&quot;,&quot;false&quot;);
			}
			*/
	}

	

/**
 * 拆分字串到陣列，分割符可使用多個字符或者中文
 * 建立日期：(2001-7-10 14:50:31)
 * @param fieldsru java.lang.String 輸入參數：待拆分字符串
 * @param tag java.lang.String      輸入參數：分割符
 * @exception java.lang.Exception 異常說明。
 * @exception java.io.IOException 異常說明。
 */
function SplitString(fieldsru,tag){
	try{
	var returnarray = fieldsru.split(tag);
	// 加會意見： [Mon Jan 07 11:18:21 CST 2008] [徐正芳(徐正芳),廠/處長,人力資源處] :不同意 駁回測試 
	for(var t=0;t&lt;returnarray.length-1;t++){
		var temp_index = returnarray[t].indexOf(&quot;] :&quot;);
		if(temp_index&gt;0){
			returnarray[t] = returnarray[t].substring(temp_index);
			var n = 1 + returnarray[t].indexOf(&quot;\n&quot;);
			if(n&gt;0){
				returnarray[t] = returnarray[t].substring(n);
			}
		}
	}
	return returnarray;
	}catch (e)	{
		//java.lang.System.out.println(e.getMessage());
	}
	return null;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001181776172890</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/06/14 07:09:32</string> 
     </void> 
     <void property="fullName"> 
      <string>com.flowring.a02.sampleCode</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001181776172890</string> 
     </void> 
     <void property="name"> 
      <string>sampleCode</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021181776164687</string> 
     </void> 
     <void property="scriptSource"> 
      <string>	function forTest() {
		Form.showMessageDialog(&quot;HELLO~~&quot;);
	}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001194752354625</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/11/11 11:39:14</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.DMS.DMSClient</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001194752354625</string> 
     </void> 
     <void property="name"> 
      <string>DMSClient</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011194752256531</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
loadLibrary(&quot;com.A.DMS.DMSConfig&quot;);
//取得FlowClient物件
function getFlowClient(){
	//var dmsFlowClient = new Packages.ogre.dms.util.client.FlowClient(hm.get(&quot;DMSServerIP&quot;), hm.get(&quot;DMSServerPort&quot;));	
	var dmsFlowClient = new Packages.ogre.dms.util.client.FlowClient(DMSSERVERIP,DMSSERVERPORT);	
	return dmsFlowClient;
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001202014169406</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2017/03/15 13:57:25</string> 
     </void> 
     <void property="fullName"> 
      <string>com.eland.org.Server</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001202014169406</string> 
     </void> 
     <void property="name"> 
      <string>Server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011202014151093</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
/**

	20080123 直接下 SQL 到 DB 速度較快(不行要用 api)
	AF.MEM_GENINF --&gt; EKM.EIP_MEMBER

	INSERT INTO ekm.eip_member (m_uid,m_site,m_account,m_password,m_lockpass,m_block,m_nickname,m_name,m_email,m_birthday,m_create_date,m_create_time)
 (SELECT  memid,areacode,loginid,&apos;NA&apos;,&apos;NA&apos;,&apos;N&apos; m_block,englishname,username,email,birthday,to_Char(sysdate,&apos;yyyy/MM/dd&apos;),to_Char(sysdate,&apos;HH24:MI&apos;)
 FROM MEM_GENINF m WHERE loginid is not null and  LOGINID NOT IN ( select M_ACCOUNT from ekm.eip_member) );

*/

/**
方法一
1.找出有更新的帳號 insert/update 到 ekm

方法二 20080129
全部刪除 eip_member 
eip_member_misc
where m_account not in(&apos;eipadmin&apos;,&apos;guest&apos;,&apos;CATEGORY_MGR&apos;,&apos;BOARD_MGR&apos;,&apos;DEPT_MGR&apos;)
eip_group
eip_group_member
where g_id not in(&apos;KM_DEPT&apos;,&apos;$everyone$&apos;,&apos;ROLeL060817150012000&apos;,&apos;ROLeL080129230225000&apos;,&apos;ROLeL080129230225000_boss&apos;)
重新產生
*/
	function updateOrg(){
		//Server.clearCache();   // 不要清cache modi by wangwei@2010/08/31 
		var ekmschema = &quot;EKM&quot;;
		var ekmapi = new Packages.com.eland.ekm.api.member.MemberAPI();
		try{
			var conn_ekm = Server.createSessionConnection(&quot;EKM&quot;);
			Server.addDebugLog(&quot;組織同步--&gt;&gt; update 部門資料&quot;);
			updateDepartment(conn_ekm,ekmapi,ekmschema);//不作刪除的動作
			Server.addDebugLog(&quot;組織同步--&gt;&gt; update 人員資料 call updateMember(conn_ekm,ekmapi,ekmschema)&quot;);
			updateMember(conn_ekm,ekmapi,ekmschema);
		}catch(e){}finally{
			conn_ekm.close();
		}
	}	
	function updateDepartment(conn_ekm,ekmapi,ekmschema){
		/*
		var sql_where = &quot; where g_id not in(&apos;KM_DEPT&apos;,&apos;$everyone$&apos;,&apos;ROLeL060817150012000&apos;)&quot;; //,&apos;ROLeL080129230225000&apos;,&apos;ROLeL080129230225000_boss&apos;
		var sql_del = &quot;  delete  &quot;+ ekmschema +&quot;.eip_group  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);
		var sql_del = &quot;  delete  &quot;+ ekmschema +&quot;.eip_group_member  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);	
		conn_ekm.commit();
		*/
		/**
		api.insertDept(&quot;部門編號&quot;, &quot;部門名稱&quot;, &quot;部門建立者&quot;, &quot;部門簡介&quot;, &quot;所屬部門的ID &quot;)；
		api.updateDept (&quot;部門編號&quot;,&quot;新部門名稱&quot;, &quot;新部門簡介&quot;, &quot;上層部門ID&quot;)
		*/
		var sql_dep = &quot; select * from dep_geninf  &quot;;
		var vec_dep = Server.SQLloadValue(sql_dep);
		if(vec_dep != null &amp;&amp; vec_dep.size() &gt; 0){
			for(var i=0;i&lt;vec_dep.size();i++){
				try	{
					var depid = vec_dep.get(i).get(&quot;depid&quot;);
					var depname = vec_dep.get(i).get(&quot;name&quot;);
					var creator = &quot;eipadmin&quot;;
					var id = vec_dep.get(i).get(&quot;id&quot;);
					var parentid = vec_dep.get(i).get(&quot;parentid&quot;);
					if(parentid == &quot;company&quot;){
						parentid = &quot;root&quot;;
					}
					//判斷是否已存在
					var sql_group = &quot; select count(1) count from eip_group where g_id =&apos;&quot;+ depid +&quot;&apos;&quot; ;
					var vec_group = conn_ekm.loadValue(sql_group);
					if(&quot;1&quot; != vec_group.get(0).get(&quot;count&quot;)){
						//不存在 就 insert
						var result = ekmapi.insertDept(depid,depname,creator,&quot;&quot;,parentid);
						Server.addDebugLog(i + &quot;=&quot; + depname + &quot;insertDept[&quot; + result + &quot;]&quot;);
					}else{
						//存在就 update
						var result = ekmapi.updateDept(depid,depname,&quot;&quot;,parentid);
						Server.addDebugLog(i + &quot;=&quot; + depname + &quot;updateDept[&quot; + result + &quot;]&quot;);
					}
				}catch(e){
				}finally {}
	        }
		}
		//var sql_update = &quot; update eip_group set g_parentid = &apos;root&apos; where g_id like &apos;DEP%GCE&apos; &quot;;
		//conn_ekm.updateValue(sql_update);	
		//conn_ekm.commit();
		var sql_update = &quot; update eip_group set g_name = &apos;主管&apos;,g_desc = &apos;主管&apos; where g_id like &apos;%_boss&apos; &quot;;
		conn_ekm.updateValue(sql_update);	
		conn_ekm.commit();
	}

	function updateMember(conn_ekm,ekmapi,ekmschema){
		/*
		var sql_where = &quot; where m_account not in(&apos;eipadmin&apos;,&apos;guest&apos;,&apos;CATEGORY_MGR&apos;,&apos;BOARD_MGR&apos;,&apos;DEPT_MGR&apos;) &quot;;
		var sql_del = &quot;  delete &quot;+ ekmschema +&quot;.eip_member  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);
		var sql_del = &quot;  delete  &quot;+ ekmschema +&quot;.eip_member_misc  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);
		conn_ekm.commit();
		*/
		//update 前 loginid 先全部轉小寫 mark by wangwei@2010/08/31 不用再轉小寫,因建立時已是小寫,避免DB loading
	//	var sql_update = &quot; update mem_geninf set loginid = lower(loginid) &quot;;
	//	Server.SQLupdateValue(sql_update);
		
		var myDate = new Packages.pase.agenda.MyDate();
		var currDate = myDate.getCurrentDate();	
		var sql_mem = &quot; SELECT  distinct loginid FROM MEM_GENINF m WHERE loginid is not null and EXPERIENCEDJOBPERIOD &gt;= &apos;&quot;+ currDate +&quot;&apos; &quot;; //=&apos;2011/05/05 17:00:00&apos;&quot;; // --
//		var sql_mem = &quot; SELECT  distinct loginid FROM MEM_GENINF m WHERE loginid is not null and EXPERIENCEDJOBPERIOD  &gt;= &apos;2011/11/22%&apos; &quot;;
		Server.addDebugLog(&quot;組織同步--&gt;&gt; update 人員資料:&quot;+sql_mem);
		var vec_mem = Server.SQLloadValue(sql_mem);
		if(vec_mem != null &amp;&amp; vec_mem.size() &gt; 0){
			for(var i=0;i&lt;vec_mem.size();i++){
				try	{
					var loginid = vec_mem.get(i).get(&quot;loginid&quot;);
					var member = Server.getMember(loginid);
					//判斷是否已存在
					var sql_member = &quot; select count(1) count from eip_member where m_account =&apos;&quot;+ loginid +&quot;&apos;&quot; ;
					var vec_member = conn_ekm.loadValue(sql_member);
					if(&quot;1&quot; != vec_member.get(0).get(&quot;count&quot;)){
						//不存在 就 insert
						var result = insertEkmMember(ekmapi,member);
						if (result == true){
							Server.addDebugLog(&quot;Insert eKM Member Succ:&quot;+  member);
						}else{
							Server.addDebugLog(&quot;Insert eKM Member Fail:&quot;+  member);							
						}
					}else{
						//存在就 update
						var result = updateEkmMember(ekmapi,member);						
					}
				}catch(e){
					//java.lang.System.out.println(i + &quot;Error : updateMember=[&quot;+ loginid +&quot;][&quot; + result+&quot;]&quot;);
					Server.addErrLog(&quot;Update eKM Member Fail:&quot;+  e);
				}finally {}
	        }
		}
	}
	
	function updateEkmMember(ekmapi,member){
		var result = false;
		if(member != null){
			//com.eland.api.MemberInfoWrapper info
			//to do 注意部門
			
			var loginid = member.getLoginID();
			var password = member.getReligion();//getLoginID();
			var username = member.getName();
			var email = member.getEmail();
			var sex = &quot;F&quot;; 
			if(member.isMale()){
				sex = &quot;M&quot;;
			}
			
			//var info = new Packages.com.eland.ekm.api.member.MemberInfoWrapper(loginid,password,username,email,sex); //[帳號][密碼][名稱][email][性別&apos;F&apos;/&apos;M&apos;]
			var info = ekmapi.getMemberInfoWrapper(loginid);
			info.memberInfo.password = password;
			info.department = member.getWorkPlace();
			//java.lang.System.out.println(&quot;info.memberMiscInfo.company=&quot; + member.getAreaCode());
			// 將HGCE轉成CGCE for 檔案伺服器  L164  add by wangwei@20100929
			var vAreaCode = member.getAreaCode();
			if(&quot;HGCE&quot;==vAreaCode) { 
				vAreaCode = &quot;CGCE&quot; ;
				}			
			info.memberMiscInfo.company = vAreaCode;
			info.memberMiscInfo.title = member.getJobTitle(); // add by wangwei@2009/12/08 職稱
			//to do 離職設定
			if(member.isDeniedLogin() ){
				info.memberInfo.block = true;
			}else{
				info.memberInfo.block = false;
			}
			/*
			info.memberMiscInfo.employeeID = member.getMyID();
			var otherDepartment= new Array();
			info.memberMiscInfo.title = &quot;經理&quot;;
			info.otherDepartment = otherDepartment;
			info.department = &quot;for_test&quot;;
			var array1 = new Array();
			array1[0] = &quot;1165377077250&quot;;
			info.userSkillId = array1;
			info.customFieldId= array1;
			info.customFieldValue= array1;
			*/
			var result_i = ekmapi.updateMember(info); //成功得1失敗得0
			Server.addDebugLog(&quot;Update eKM Member:&quot;+  member+&quot;ArecCode:&quot;+vAreaCode+&quot;JobTitle:&quot;+member.getJobTitle()+&quot;WorkPlace:&quot;+member.getWorkPlace());
			if(1 == result_i){
				result = true;				
			}
		}
		return result ; 
	}
	
//===============================================================================================================================
	function reloadOrg(){
		var ekmschema = &quot;EKM&quot;;
		var ekmapi = new Packages.com.eland.ekm.api.member.MemberAPI();
		try{
			var conn_ekm = Server.createSessionConnection(&quot;EKM&quot;);
			reloadDepartment(conn_ekm,ekmapi,ekmschema);
			reloadMember(conn_ekm,ekmapi,ekmschema);
		}catch(e){}
		if(conn_ekm != null)	{
			try	{
				conn_ekm.commit();
			}catch(e){}
			conn_ekm.close();
		}
	}
	
	function reloadDepartment(conn_ekm,ekmapi,ekmschema){
		var sql_where = &quot; where g_id not in(&apos;KM_DEPT&apos;,&apos;$everyone$&apos;,&apos;ROLeL060817150012000&apos;)&quot;; //,&apos;ROLeL080129230225000&apos;,&apos;ROLeL080129230225000_boss&apos;
		var sql_del = &quot;  delete  &quot;+ ekmschema +&quot;.eip_group  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);
		var sql_del = &quot;  delete  &quot;+ ekmschema +&quot;.eip_group_member  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);	
		conn_ekm.commit();
		/**
		api.insertDept(&quot;部門編號&quot;, &quot;部門名稱&quot;, &quot;部門建立者&quot;, &quot;部門簡介&quot;, &quot;所屬部門的ID &quot;)；
		api.updateDept (&quot;部門編號&quot;,&quot;新部門名稱&quot;, &quot;新部門簡介&quot;, &quot;上層部門ID&quot;)
		*/
		var sql_dep = &quot; select * from dep_geninf  &quot;;
		var vec_dep = Server.SQLloadValue(sql_dep);
		if(vec_dep != null &amp;&amp; vec_dep.size() &gt; 0){
			for(var i=0;i&lt;vec_dep.size();i++){
				try	{
					var depid = vec_dep.get(i).get(&quot;depid&quot;);
					var depname = vec_dep.get(i).get(&quot;name&quot;);
					var creator = &quot;eipadmin&quot;;
					var id = vec_dep.get(i).get(&quot;id&quot;);
					var parentid = vec_dep.get(i).get(&quot;parentid&quot;);
					if(parentid == &quot;company&quot;){
						parentid = &quot;root&quot;;
					}
					var result = ekmapi.insertDept(depid,depname,creator,&quot;&quot;,parentid);
					//var result1 = ekmapi.updateDept(depid,depname,&quot;&quot;,parentid);
					java.lang.System.out.println(i + &quot;=&quot; + depname + &quot;insertDept[&quot; + result + &quot;]&quot;);
				}catch(e){
				}finally {}
	        }
		}
		//var sql_update = &quot; update eip_group set g_parentid = &apos;root&apos; where g_id like &apos;DEP%GCE&apos; &quot;;
		//conn_ekm.updateValue(sql_update);	
		//conn_ekm.commit();
		var sql_update = &quot; update eip_group set g_name = &apos;主管&apos;,g_desc = &apos;主管&apos; where g_id like &apos;%_boss&apos; &quot;;
		conn_ekm.updateValue(sql_update);	
		conn_ekm.commit();
		
	}

	function reloadMember(conn_ekm,ekmapi,ekmschema){
		// to do 注意 schema
		//update 前 loginid 先全部轉小寫
//		var sql_update = &quot; update mem_geninf set loginid = lower(loginid) &quot;;
//		Server.SQLupdateValue(sql_update);

		var sql_where = &quot; where m_account not in(&apos;eipadmin&apos;,&apos;guest&apos;,&apos;CATEGORY_MGR&apos;,&apos;BOARD_MGR&apos;,&apos;DEPT_MGR&apos;) &quot;;
		var sql_del = &quot;  delete &quot;+ ekmschema +&quot;.eip_member  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);
		var sql_del = &quot;  delete  &quot;+ ekmschema +&quot;.eip_member_misc  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);
		conn_ekm.commit();
		var sql_mem = &quot; SELECT  distinct loginid FROM MEM_GENINF m WHERE loginid is not null and  LOGINID NOT IN ( select M_ACCOUNT from &quot;+ ekmschema +&quot;.eip_member) &quot;;
		var vec_mem = Server.SQLloadValue(sql_mem);
		if(vec_mem != null &amp;&amp; vec_mem.size() &gt; 0){
			for(var i=0;i&lt;vec_mem.size();i++){
				try	{
					var loginid = vec_mem.get(i).get(&quot;loginid&quot;);
					var member = Server.getMember(loginid);
					var result = insertEkmMember(ekmapi,member);
					java.lang.System.out.println(i + &quot;insertMember=[&quot;+ loginid +&quot;][&quot; + result+&quot;]&quot;);
				}catch(e){
				}finally {}
	        }
		}
	}
	
	function insertEkmMember(ekmapi,member){
		var result = false;
		if(member != null){
			//com.eland.api.MemberInfoWrapper info
			//to do 注意部門
			
			var loginid = member.getLoginID();
			var password = member.getReligion();//getLoginID();
			var username = member.getName();
			var email = member.getEmail();
			var sex = &quot;F&quot;; 
			if(member.isMale()){
				sex = &quot;M&quot;;
			}
			var info = new Packages.com.eland.ekm.api.member.MemberInfoWrapper(loginid,password,username,email,sex); //[帳號][密碼][名稱][email][性別&apos;F&apos;/&apos;M&apos;]
			info.department = member.getWorkPlace();
			info.memberMiscInfo.employeeID = member.getMyID();
			//info.department = &quot;ROLeL080129230225000&quot;;//金像電員工
			/*
			var otherDepartment= new Array();
			info.memberMiscInfo.title = &quot;經理&quot;;
			info.otherDepartment = otherDepartment;
			info.department = &quot;for_test&quot;;
			var array1 = new Array();
			array1[0] = &quot;1165377077250&quot;;
			info.userSkillId = array1;
			info.customFieldId= array1;
			info.customFieldValue= array1;
			*/
			var result_i = ekmapi.insertMember(info); //成功得1失敗得0
			if(1 == result_i){
				result = true;
			}
		}
		return result ; 
	}





	
	
	
	function updateGCE_ROLE_WT(){
		
//		try{
//		var conn_winddb = Server.createSessionConnection(&quot;WINDDB&quot;);
//		var sql_winddb = &quot; select name,customer from GCE_ASSIGN_ROLE where role = &apos;PM&apos; and org_id = &apos;TGCE&apos; and status = &apos;Y&apos; order by name,customer  &quot; ; 
//		var vec = conn_winddb.loadValue(sql_winddb);
//		var name = &quot;&quot; ;
//		var customer = &quot;&quot;;
//		if(vec != null &amp;&amp; vec.size()&gt;0){
//			
//			if( &quot;&quot;.equals(name) &amp;&amp; name != vec.get(0).get(&quot;name&quot;).trim()  ){   //第一次
//				name = vec.get(0).get(&quot;name&quot;).trim() ;
//				customer = vec.get(0).get(&quot;customer&quot;).trim() ;
//			}else if( &quot;&quot; != name &amp;&amp; name != vec.get(0).get(&quot;name&quot;).trim()  ){
//			
//			
//			}else if(){  //重覆
//				var customer = vec.get(0).get(&quot;customer&quot;).trim() ;
//			}	
//			
//		}					
//		conn_winddb.close();
//		//所有版本狀態皆update
//		//var sql_ekm = &quot; update FIELD_DATA set COL_06 = &apos;&quot;+ status +&quot;&apos; where REF_ID_01= &apos;&quot;+ doc_id +&quot;&apos; &quot; ;
//		//var result = conn_winddb.updateValue(sql_ekm);	
//		/*
//		if(&quot;true&quot;==result){
//			conn_ekm.commit();
//		}else{
//			conn_ekm.rollback();				
//		}
//		*/
//		conn_ekm.commit();
//		conn_ekm.close();
//		}catch(e){
//			conn_ekm.rollback();
//		}
//
//		
//		Server.clearCache();
//		var ekmschema = &quot;ekm&quot;;
//		var ekmapi = new Packages.com.eland.ekm.api.member.MemberAPI();
//		try{
//			var conn_ekm = Server.createSessionConnection(&quot;EKM&quot;);
//			updateDepartment(conn_ekm,ekmapi,ekmschema);//不作刪除的動作
//			updateMember(conn_ekm,ekmapi,ekmschema);
//		}catch(e){}
//		if(conn_ekm != null)	{
//			try	{
//				conn_ekm.commit();
//			}catch(e){}
//			conn_ekm.close();
//		}
		
	}	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ekm loginid 組織同步</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001203589316078</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/11/26 17:50:32</string> 
     </void> 
     <void property="fullName"> 
      <string>com.eland.dms.Server</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001203589316078</string> 
     </void> 
     <void property="name"> 
      <string>Server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011203496283609</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

loadLibrary(&quot;com.eland.dms.Config&quot;);

/**
 Exception 時發出的 mail
*/
function sendExcptionMail(message){
	var InsID = MyTask.getArtInstance();
	var dataMap = InsID.getAppDataMap();
	var cMember = Server.getMember(&quot;Administrator&quot;);
	var fromMail= Server.getMember(&quot;Administrator&quot;).getEmail();//系統管理員為寄件者
	var toEMail = cMember.getEmail();
	var totalccMail = &quot;yingchieh_wang@gce.com.tw;wangwei@gce.com.tw;edison_wang@gce.com.tw&quot;;
	var title = &quot; [AF MESSAGE] &quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的電子表單有 Exception !&quot;;
	var urlData = &quot;&lt;a href=\&quot;$webAgendaURL$mailOpenFormCheckpass\&quot;&gt;開啟表單&lt;/a&gt;&quot;;
	var data = &quot; 您好：&quot;+&quot;\n&quot;+&quot;\n&quot;;
	data = data + &quot;這是系統自動發出的一封 Excetion 通知信，請儘速處理，\n&quot;;
	data = data +&quot;表單內容為：&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的電子表單 \n&quot;;
	data = data + &quot;Message:&quot; + message +&quot;\n&quot;;
   data = data + &quot; 您可以開啟 &quot;+urlData+&quot;，來查看該表單。&quot;+&quot;\n  \n \n   MIS &quot;;
   data = &quot;&lt;pre&gt;&quot;+data+&quot;&lt;/pre&gt;&quot;;
    var vector = new java.util.Vector();
     //taskID
    var taskID = MyTask.getID();  
    Server.sendHTMLMailExt(fromMail,toEMail,totalccMail,title,data,vector,taskID);  
 }

/**
 public class WorkflowFunctionConst {
    public static final String K_TC_STATUS_D  = &quot;D&quot;;  // Draft 草稿
	public static final String K_TC_STATUS_CI = &quot;CI&quot;; // Certifying 審核中
	public static final String K_TC_STATUS_C  = &quot;C&quot;;  // Certified 已發行
	public static final String K_TC_STATUS_A  = &quot;A&quot;;   //abolish 已廢止
	public static final String K_TC_STATUS_AI  = &quot;AI&quot;;   //abolish in progress 申請廢止中
	public static final String K_TC_STATUS_II  = &quot;II&quot;;   //set ideal doc in progress 申請為點範文件中
    // 以下為金像客製的文件狀態
    public static final String K_TC_STATUS_MA = &quot;MA&quot;;  //變更申請
    public static final String K_TC_STATUS_MW = &quot;MW&quot;;  //變更確認 
    public static final String K_TC_STATUS_MC = &quot;MC&quot;;  //變更取消
    public static final String K_TC_STATUS_AA = &quot;AA&quot;;  //作廢申請
    public static final String K_TC_STATUS_NC = &quot;NC&quot;;  //駁回
}
*/

// Agree 必需為 True ; 作廢時另外處理用 cancelDocStatus
	function setDocStatus(status){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		var category_id = dataMap.get(&quot;Category_ID&quot;);
		var RealExecutorID = MyTask.getRealExecutor();
		var RealExecutor = Server.getMember(RealExecutorID);
		var account = &quot;eipadmin&quot;;
		if(RealExecutor != null){
			account = RealExecutor.getLoginID();
		}
		if(&quot;&quot; != doc_id &amp;&amp; &quot;&quot; != ver_id &amp;&amp; &quot;false&quot; == dataMap.get(&quot;Cancel&quot;) ){
			try{
				  var wfapi = new Packages.com.eland.ekm.api.workflow.WorkflowFunctionAPI(hostname);
				  //wfapi.setDocCertified(categoryId,docId,verId,&quot;eipadmin&quot;); // public void wfapi.setDocCertified(String categoryId, String docId, int verId, String account);
				  var success = wfapi.setDocStatus(category_id,doc_id,ver_id,account,status); // public void setDocStatus(String categoryId, String docId, int verId, String account, String docStatus)
				  java.lang.System.out.println(&quot;WorkflowFunctionAPI.hostname=[&quot;+ hostname + &quot;] set DccStatus [&quot;+ status +&quot;] success:[&quot; + success + &quot;]&quot;);
				  if(true != success){
							  sendExcptionMail(&quot;[update ekm 狀態失敗]:setDocStatus(status);fapi.setDocStatus(&quot; + category_id + &quot;,&quot;+ doc_id + &quot;,&quot;+ ver_id+ &quot;,&quot; + account + &quot;,&quot; + status + &quot;)&quot;);
				  }
				  try{
					  // 20080419 如果是 CW(待發行) 要另外回寫GCE No + 發行日期
					  var Effective_Date = dataMap.get(&quot;Effective_Date&quot;);
					  var GCE_Doc_Sn = dataMap.get(&quot;GCE_Doc_Sn&quot;);
					  if(&quot;CW&quot; == status &amp;&amp; Effective_Date != &quot;&quot; &amp;&amp; GCE_Doc_Sn != &quot;&quot;){
						  //WorkflowFunctionAPI wfapi = new WorkflowFunctionAPI(hostname); 
						  //wfapi.setGceDocAttr(&quot;1206093166858_1&quot;,1,&quot;A-FQ-01&quot;,&quot;2008/04/18&quot;);
						  //public void setGceDocAttr(String docId, int verId,String gceNo, String date)
						  var success = wfapi.setGceDocAttr(doc_id,ver_id,GCE_Doc_Sn,Effective_Date);
		  				  java.lang.System.out.println(&quot;WorkflowFunctionAPI.setGceDocAttr=[&quot;+ hostname + &quot;] set DocAttr [&quot;+ GCE_Doc_Sn +&quot;] success:[&quot; + success + &quot;]&quot;);
						  
					  }
				  }catch(e){sendExcptionMail(&quot;[update ekm 狀態失敗1]:&quot; + e) ;	}
				  
			}catch(e){sendExcptionMail(&quot;[update ekm 狀態失敗2]:&quot; + e) ;	}
//以下兩行不知是誰加的,markbywangwie@2009/09/25			
//		  	loadLibrary(&quot;com.A.Common.Server.Process&quot;);
//			closeProcess();
		}
	}
// ---------不使用API 還沒改好哦
	function setDocStatusNew(status){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		var category_id = dataMap.get(&quot;Category_ID&quot;);
		var RealExecutorID = MyTask.getRealExecutor();
		var RealExecutor = Server.getMember(RealExecutorID);
		var account = &quot;eipadmin&quot;;
		if(RealExecutor != null){
			account = RealExecutor.getLoginID();
		}
		if(&quot;&quot; != doc_id &amp;&amp; &quot;&quot; != ver_id &amp;&amp; &quot;false&quot; == dataMap.get(&quot;Cancel&quot;) ){
			try{
				  var wfapi = new Packages.com.eland.ekm.api.workflow.WorkflowFunctionAPI(hostname);
				  var success = wfapi.setDocStatus(category_id,doc_id,ver_id,account,status); // public void setDocStatus(String categoryId, String docId, int verId, String account, String docStatus)
				  java.lang.System.out.println(&quot;WorkflowFunctionAPI.hostname=[&quot;+ hostname + &quot;] set DccStatus [&quot;+ status +&quot;] success:[&quot; + success + &quot;]&quot;);
				  if(true != success){
							  sendExcptionMail(&quot;[update ekm 狀態失敗]:setDocStatus(status);fapi.setDocStatus(&quot; + category_id + &quot;,&quot;+ doc_id + &quot;,&quot;+ ver_id+ &quot;,&quot; + account + &quot;,&quot; + status + &quot;)&quot;);
				  }
				  try{
					  var Effective_Date = dataMap.get(&quot;Effective_Date&quot;);
					  var GCE_Doc_Sn = dataMap.get(&quot;GCE_Doc_Sn&quot;);
					  if(&quot;CW&quot; == status &amp;&amp; Effective_Date != &quot;&quot; &amp;&amp; GCE_Doc_Sn != &quot;&quot;){
						  var success = wfapi.setGceDocAttr(doc_id,ver_id,GCE_Doc_Sn,Effective_Date);
		  				  java.lang.System.out.println(&quot;WorkflowFunctionAPI.setGceDocAttr=[&quot;+ hostname + &quot;] set DocAttr [&quot;+ GCE_Doc_Sn +&quot;] success:[&quot; + success + &quot;]&quot;);
					  }
				  }catch(e){sendExcptionMail(&quot;[update ekm 狀態失敗1]:&quot; + e) ;	}
				  
			}catch(e){sendExcptionMail(&quot;[update ekm 狀態失敗2]:&quot; + e) ;	}

		}
	}

//------------------------------
	function setOldDocStatus(status){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;OVer_ID&quot;);
		var category_id = dataMap.get(&quot;Category_ID&quot;);
		var RealExecutorID = MyTask.getRealExecutor();
		var RealExecutor = Server.getMember(RealExecutorID);
		var account = &quot;eipadmin&quot;;
		if(RealExecutor != null){
			account = RealExecutor.getLoginID();
		}
		if(&quot;&quot; != doc_id &amp;&amp; &quot;&quot; != ver_id &amp;&amp;  &quot;false&quot; == dataMap.get(&quot;Cancel&quot;) ){
			try{
				  var wfapi = new Packages.com.eland.ekm.api.workflow.WorkflowFunctionAPI(hostname);
				  //wfapi.setDocCertified(categoryId,docId,verId,&quot;eipadmin&quot;); // public void wfapi.setDocCertified(String categoryId, String docId, int verId, String account);
				  var success = wfapi.setDocStatus(category_id,doc_id,ver_id,account,status); // public void setDocStatus(String categoryId, String docId, int verId, String account, String docStatus)
				  java.lang.System.out.println(&quot;WorkflowFunctionAPI.hostname=[&quot;+ hostname + &quot;] set DccStatus [&quot;+ status +&quot;] success:[&quot; + success + &quot;]&quot;);
				  if(true != success){
							  sendExcptionMail(&quot;[update ekm 狀態失敗]:setOldDocStatus(status) ;wfapi.setDocStatus(&quot; + category_id + &quot;,&quot;+ doc_id + &quot;,&quot;+ ver_id+ &quot;,&quot; + account + &quot;,&quot; + status + &quot;)&quot;);
				  }
			}catch(e){sendExcptionMail(&quot;[update ekm 狀態失敗3]:&quot; + e );	}
		  	loadLibrary(&quot;com.A.Common.Server.Process&quot;);
			closeProcess();
		}
	}
	
	function cancelDocStatus(status){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		var category_id = dataMap.get(&quot;Category_ID&quot;);
		var RealExecutorID = MyTask.getRealExecutor();
		var RealExecutor = Server.getMember(RealExecutorID);
		var account = &quot;eipadmin&quot;;
		if(RealExecutor != null){
			account = RealExecutor.getLoginID();
		}
		if( &quot;true&quot; == dataMap.get(&quot;Cancel&quot;) ){
			try{
				  var wfapi = new Packages.com.eland.ekm.api.workflow.WorkflowFunctionAPI(hostname);
				  //wfapi.setDocCertified(categoryId,docId,verId,&quot;eipadmin&quot;); // public void wfapi.setDocCertified(String categoryId, String docId, int verId, String account);
				  var success = wfapi.setDocStatus(category_id,doc_id,ver_id,account,status); // public void setDocStatus(String categoryId, String docId, int verId, String account, String docStatus)
				  java.lang.System.out.println(&quot;WorkflowFunctionAPI.hostname=[&quot;+ hostname + &quot;] set DccStatus [&quot;+ status +&quot;] success:[&quot; + success + &quot;]&quot;);
				   if(true != success){
							  sendExcptionMail(&quot;[update ekm 狀態失敗]:cancelDocStatus(status) ;wfapi.setDocStatus(&quot; + category_id + &quot;,&quot;+ doc_id + &quot;,&quot;+ ver_id+ &quot;,&quot; + account + &quot;,&quot; + status + &quot;)&quot;);
				  }
			}catch(e){sendExcptionMail(&quot;[update ekm 狀態失敗4]:&quot; + e );	}
		}
	}
	function cancelOldDocStatus(status){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;OVer_ID&quot;);
		var category_id = dataMap.get(&quot;Category_ID&quot;);
		var RealExecutorID = MyTask.getRealExecutor();
		var RealExecutor = Server.getMember(RealExecutorID);
		var account = &quot;eipadmin&quot;;
		if(RealExecutor != null){
			account = RealExecutor.getLoginID();
		}
		if( &quot;&quot; != doc_id &amp;&amp; &quot;&quot; != ver_id &amp;&amp; &quot;true&quot; == dataMap.get(&quot;Cancel&quot;) ){
			try{
				  var wfapi = new Packages.com.eland.ekm.api.workflow.WorkflowFunctionAPI(hostname);
				  //wfapi.setDocCertified(categoryId,docId,verId,&quot;eipadmin&quot;); // public void wfapi.setDocCertified(String categoryId, String docId, int verId, String account);
				  var success = wfapi.setDocStatus(category_id,doc_id,ver_id,account,status); // public void setDocStatus(String categoryId, String docId, int verId, String account, String docStatus)
				  java.lang.System.out.println(&quot;WorkflowFunctionAPI.hostname=[&quot;+ hostname + &quot;] set DccStatus [&quot;+ status +&quot;] success:[&quot; + success + &quot;]&quot;);
				  if(true != success){
							  sendExcptionMail(&quot;[update ekm 狀態失敗]:cancelOldDocStatus(status) ;wfapi.setDocStatus(&quot; + category_id + &quot;,&quot;+ doc_id + &quot;,&quot;+ ver_id+ &quot;,&quot; + account + &quot;,&quot; + status + &quot;)&quot;);
				  }
			}catch(e){sendExcptionMail(&quot;[update ekm 狀態失敗5]:&quot; + e );	}
		}
	}
	
	function setTechDoc(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var rootTaskID = MyTask.getRootID();
		var ht = Server.getGlobals(rootTaskID); //{doc_id=1203563399578, category_id=1203513331265, ver_id=1}
		var doc_id = ht.get(&quot;doc_id&quot;).trim();
		var ver_id = ht.get(&quot;ver_id&quot;).trim();
		var category_id = ht.get(&quot;category_id&quot;).trim();
		dataMap.put(&quot;Doc_ID&quot;,doc_id);
		dataMap.put(&quot;Ver_ID&quot;,ver_id);
		dataMap.put(&quot;Category_ID&quot;,category_id);
		
		dataMap.put(&quot;OVer_ID&quot;,ht.get(&quot;OVer_ID&quot;)); // 舊版 ver
		dataMap.put(&quot;Type&quot;,ht.get(&quot;ISO_depth3&quot;).trim()); // ISO 型態
		dataMap.put(&quot;Category&quot;,ht.get(&quot;ISO_depth5&quot;).trim()); // 文件類別
		/*
		try{
			  var wfapi = new Packages.com.eland.ekm.api.workflow.WorkflowFunctionAPI(hostname);
			  //public IndexCardInfo getIndexCardInfo(String docId, int verId)
			  var indexinfo = wfapi.getIndexCardInfo(doc_id,ver_id);
			  dataMap.put(&quot;Subject&quot;,indexinfo.subject);
			  dataMap.put(&quot;Doc_Desc&quot;,&quot;cc test&quot;);
		}catch(e){	}
		*/
		// 改用 api
		try{
			var conn = Server.createSessionConnection(&quot;EKM&quot;);
			if(&quot;&quot; == ver_id){
				ver_id = ht.get(&quot;OVer_ID&quot;);
			}	
			//var sql = &quot; select c.Name,t.Name Type,v.* from TECHDOC_VERSION v,ELAND_CATEGORY c ,TECHDOC_TYPE t where v.CATEGORY_ID = c.CATEGORY_ID(+) and v.Type_ID = t.Type_ID(+) and doc_id = &apos;&quot; + doc_id + &quot;&apos; and ver_id = &apos;&quot;+ ver_id +&quot;&apos; &quot;;
			// 
			var sql = &quot; select c.Name,t.Name Type,v.*,g.G_name from TECHDOC_VERSION v,ELAND_CATEGORY c ,TECHDOC_TYPE t,EIP_GROUP g where v.CATEGORY_ID = c.CATEGORY_ID(+) and v.Type_ID = t.Type_ID(+) and v.reserve_dept = g.g_id(+) and doc_id = &apos;&quot; + doc_id + &quot;&apos; and ver_id = &apos;&quot;+ ver_id +&quot;&apos;&quot;;
//			java.lang.System.out.println(&quot;sql=&quot;+sql);
//			var vecTest = conn.loadValue(&quot;SELECT * FROM TECHDOC_VERSION WHERE doc_id=&apos;1222215919316&apos;&quot;);
//			java.lang.System.out.println(&quot;vec=&quot;+vecTest);
			var vec = conn.loadValue(sql);		
//			java.lang.System.out.println(&quot;vec=&quot;+vec);
			if(vec != null &amp;&amp; vec.size()&gt;0){				
				dataMap.put(&quot;Subject&quot;,vec.get(0).get(&quot;subject&quot;).trim());
				var creator_id = vec.get(0).get(&quot;Creator&quot;);
				dataMap.put(&quot;Doc_Creator_ID&quot;,creator_id);
				var doc_creator = Server.getMember(creator_id);
				if(doc_creator != null){
					dataMap.put(&quot;Doc_Creator&quot;,doc_creator.getName());
				}
				dataMap.put(&quot;Type_ID&quot;,vec.get(0).get(&quot;Type_ID&quot;).trim());
				//dataMap.put(&quot;Type&quot;,vec.get(0).get(&quot;Type&quot;)); 改由 Global 取 20080317
				var dept_id = vec.get(0).get(&quot;Dept&quot;);
				dataMap.put(&quot;Dept_ID&quot;,dept_id);
				var dept = Server.getDepartment(dept_id);
				if(dept != null){
					dataMap.put(&quot;Dept&quot;,dept.getName());
				}
				// dataMap.put(&quot;Category&quot;,vec.get(0).get(&quot;Name&quot;)); 改由 Global 取 20080317
//				dataMap.put(&quot;Description&quot;,vec.get(0).get(&quot;Description&quot;).trim());//Abstract
				dataMap.put(&quot;Description&quot;,vec.get(0).get(&quot;Abstract&quot;).trim());//Abstract 文件摘要說明
				dataMap.put(&quot;Reason&quot;,vec.get(0).get(&quot;Description&quot;).trim());  //修訂說明
				dataMap.put(&quot;Reserve_Year&quot;,vec.get(0).get(&quot;Reserve_Year&quot;).trim());	
				dataMap.put(&quot;Reserve_Dept&quot;,vec.get(0).get(&quot;G_name&quot;).trim());
				/*
				var reserve_dept_id = vec.get(0).get(&quot;Reserve_Dept&quot;);
				dataMap.put(&quot;Reserve_Dept_ID&quot;,reserve_dept_id);
				var reserve_dept = Server.getDepartment(reserve_dept_id);
				if(reserve_dept != null){
					dataMap.put(&quot;Reserve_Dept&quot;,reserve_dept.getName());
				}
				*/
				dataMap.put(&quot;Doc_Create_Date&quot;,vec.get(0).get(&quot;Create_Date&quot;).trim());
				dataMap.put(&quot;GCE_Doc_Sn&quot;,vec.get(0).get(&quot;GCE_Doc_Sn&quot;).trim());
				dataMap.put(&quot;GCE_Ver_Sn&quot;,vec.get(0).get(&quot;GCE_Ver_Sn&quot;).trim());
				//dataMap.put(&quot;&quot;,vec.get(0).get(&quot;&quot;));
			}
			
			var doc_level = getDoc_Level(category_id,conn);
			dataMap.put(&quot;Doc_Level&quot;,doc_level); //iso 文件階別
			var doc_level_name = getDoc_Level_Name(doc_level); //
			dataMap.put(&quot;Doc_Level_Name&quot;,doc_level_name); //iso 文件階層名稱			
			var verify_level = getVerify_Level(doc_level);	
			dataMap.put(&quot;Verify_Level&quot;,verify_level); //審核權限
			
			//var url = &quot;http://&quot;+  hostname +   &quot;/eip/techdoc/Tech_read.jsp?doc_id=&quot;+ doc_id +&quot;&amp;ver_id=&quot;+ ver_id +&quot;&amp;codex=codex&quot;;
			var url = &quot;http://&quot;+  hostname +   &quot;/eip/techdoc/Tech_iso_read.jsp?doc_id=&quot;+ doc_id +&quot;&amp;ver_id=&quot;+ ver_id +&quot;&amp;codex=codex&quot;;
			var Index_URL = &quot;&lt;a href=&quot;+ url +&quot; target=_new &gt;文件檔案&lt;/a&gt;&quot;;
			//window.open(url, &quot;view&quot;,&quot;toolbar=no ,menubar=no, resizable=yes, scrollbars=yes, left=200, top=100, width=700, height=800, status=no&quot;);
			//var Index_URL = &quot;&lt;a href=&apos;javascript:openElandIndexCard(&quot;+ url +&quot;)&apos; &gt;開啟索引卡2&lt;/a&gt;&quot;; //隱藏URL
			dataMap.put(&quot;Index_URL&quot;,Index_URL); //設定索引卡 URL
			
			//setTable_DCC(dataMap);//設定DCC 人員 改在第一關的後置動作 mark by wangwei@2010/10/15
			//var dcc = getDCC(dataMap.get(&quot;Factory&quot;));
			//dataMap.put(&quot;DCC&quot;,dcc);
		}catch(e){
			conn.rollback();
		}
		if(conn != null){
			try	{
					conn.commit();
				}catch(e){	}
				conn.close();
			}
		
	}

	function getDoc_Level_Name(doc_level){
		var doc_level_name = &quot;&quot;;
		if(&quot;1&quot; == doc_level){
			doc_level_name = &quot;1-手冊&quot; ;
		}else if(&quot;2&quot; == doc_level){
			doc_level_name = &quot;2-作業程序&quot;;
		}else if(&quot;3&quot; == doc_level){
			doc_level_name = &quot;3-作業規範&quot;;
		}else if(&quot;4&quot; == doc_level){
			doc_level_name = &quot;4-品質紀綠&quot;;
		}
		return doc_level_name ;
	}
	
/**
在table文件分類eland_category 的欄位category_id內針對每一種階別後方加了特定字元
第一階 手冊為MENU 、第二階程序書為PROCESS、第三階為 作業規範為 SOP 、第四階品質記錄為 QUALITY
*/
function getDoc_Level(category_id,conn){
	var doc_level = &quot;4&quot;;
	try{
		var sql_ekm = &quot; select path from ELAND_CATEGORY where Category_ID = &apos;&quot; + category_id + &quot;&apos;&quot; ;
		var vec_ekm = conn.loadValue(sql_ekm);
		if(vec_ekm != null &amp;&amp; vec_ekm.size()&gt;0){
			var path = vec_ekm.get(0).get(&quot;path&quot;);
			if(path != null){
				if(path.endsWith(&quot;MENU&quot;)){
					doc_level = &quot;1&quot;;
				}else if(path.endsWith(&quot;PROCESS&quot;)){
					doc_level = &quot;2&quot;;
				}else if(path.endsWith(&quot;SOP&quot;)){
					doc_level = &quot;3&quot;;
				}
			}
		}
	}catch(e){}
	//QUALITY &quot;4&quot;
	return doc_level;
}

/**
一階文件：簽核至「劉中天」總經理 180
        包括:QM/EM
  二階文件：簽核至部門直屬主管
        包括:QP/EP
三階文件：簽核至部門主管
SOP/PMP/SIP/WI/WE
四階文件：簽核至部門主管
除QPQR/EPER簽核至部門直屬主管其它表單簽至部門主管

其中的「部門直屬主管」「部門主管」
抓核決權限表 84~103 為「部門主管」104~179「部門直屬主管」
*/
function getVerify_Level(doc_level){
	var verifylevel = &quot;084&quot;; //經理
	if (&quot;4&quot;.equals(doc_level)){	
		verifylevel = &quot;102&quot;; // 部門主管管處級主管
	}else if(&quot;3&quot;.equals(doc_level)){
		verifylevel = &quot;102&quot;; // 部門主管處級主管
	}else if(&quot;2&quot;.equals(doc_level)){
		verifylevel = &quot;124&quot;; //部門最高主管 協理/廠長/副總
	}else if(&quot;1&quot;.equals(doc_level)){
		verifylevel = &quot;180&quot;;//總經理
	}
	return verifylevel;
}

/**
DCC 專案職務
TGCE ROL00331190304875453
CGCE ROL00041203755677250
SGCE ROL00051203755744734	
HGCE ROL01011285118909369
在 Process 不能用 Role of
*/
// 20080425 修改一廠的 DCC 可能有一位以上，改用 Table_DCC 來接 DCC
function setTable_DCC(dataMap){
	var factory = dataMap.get(&quot;Factory&quot;);
	var dcc_role_id = &quot;ROL00331190304875453&quot;; //預設TGCE
	if(&quot;(CGCE)&quot; == factory){
		dcc_role_id = &quot;ROL00041203755677250&quot;;
	}else if (&quot;(SGCE)&quot; == factory){
		dcc_role_id = &quot;ROL00051203755744734&quot;;
	}else if (&quot;(HGCE)&quot; == factory){
		dcc_role_id = &quot;ROL01011285118909369&quot;;
	}
	var dcc_role = Server.getRole(dcc_role_id);
	var dcc = &quot;&quot;;
	if(dcc_role.getMemberList() != null &amp;&amp; dcc_role.getMemberList().size()&gt;0){
		var records = dataMap.get(&quot;Table_DCC&quot;);
		for(var i=0;i&lt;dcc_role.getMemberList().size();i++){
			dcc = dcc_role.getMemberList().get(i);
			if(dcc != &quot;&quot;){
				var row = new Packages.java.util.HashMap();
				row.put(&quot;ITEM1&quot;, dcc);
				records.add(records.size(), row);
			}
		}
		dataMap.put(&quot;Table_DCC&quot;,records);
	}
}
//--ISO文件申請單流程核准後,應給申請廠別的 DCC--------add by wangwei 2008/09/02----------
function setTable_DCC_A(dataMap){
	var factory = dataMap.get(&quot;FC_factory&quot;);
	var dcc_role_id = &quot;ROL00331190304875453&quot;; //預設TGCE
	if(&quot;CGCE&quot; == factory){
		dcc_role_id = &quot;ROL00041203755677250&quot;;
	}else if (&quot;SGCE&quot; == factory){
		dcc_role_id = &quot;ROL00051203755744734&quot;;
	}else if (&quot;HGCE&quot; == factory){
		dcc_role_id = &quot;ROL01011285118909369&quot;;
	}
	var dcc_role = Server.getRole(dcc_role_id);
	var dcc = &quot;&quot;;
	if(dcc_role.getMemberList() != null &amp;&amp; dcc_role.getMemberList().size()&gt;0){
		var records = dataMap.get(&quot;Table_DCC_A&quot;);
		for(var i=0;i&lt;dcc_role.getMemberList().size();i++){
			dcc = dcc_role.getMemberList().get(i);
			if(dcc != &quot;&quot;){
				var row = new Packages.java.util.HashMap();
				row.put(&quot;ITEM1&quot;, dcc);
				records.add(records.size(), row);
			}
		}
		dataMap.put(&quot;Table_DCC_A&quot;,records);
	}
}

//-------這個FUNCTION不知用在那裡, 只取一位DCC人員,若有多人可就錯了
function getDCC(factory){
	var dcc_role_id = &quot;ROL00331190304875453&quot;; //預設TGCE
	if(&quot;(CGCE)&quot; == factory){
		dcc_role_id = &quot;ROL00041203755677250&quot;;
	}else if (&quot;(SGCE)&quot; == factory){
		dcc_role_id = &quot;ROL00051203755744734&quot;;
	}else if (&quot;(HGCE)&quot; == factory){
		dcc_role_id = &quot;ROL01011285118909369&quot;;
	}
	var dcc_role = Server.getRole(dcc_role_id);
	var dcc = &quot;eipadmin&quot; ;
	if(dcc_role.getMemberList() != null &amp;&amp; dcc_role.getMemberList().size()&gt;0){
		dcc = dcc_role.getMemberList().get(0);
	}
	return dcc;
}

/**
 可單獨在 server 中使用
*/
function setDCC(){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var dcc = getDCC(dataMap.get(&quot;Factory&quot;));
	dataMap.put(&quot;DCC&quot;,dcc);//設定DCC 人員
}
// 文件變更確認單核准之後要  update ezflow ISO文件 add by wangwei 2008/07/09
// 這個FUNCTION應該可以不用了, 已上線快兩年了
function setDSC(){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var factory = dataMap.get(&quot;Factory&quot;);
	var GCE_Doc_Sn = dataMap.get(&quot;GCE_Doc_Sn&quot;); // 文件編號
	var mydate = new Packages.pase.agenda.MyDate();
	var todate = mydate.getCurrentDate(); 	
	try{
		if(&quot;(TGCE)&quot; == factory){				              
			var conn_oa = Server.createSessionConnection(&quot;EZFlow&quot;);
		}else if(&quot;(SGCE)&quot; == factory){
			var conn_oa = Server.createSessionConnection(&quot;EZFlow_S&quot;);	
		}else if(&quot;(CGCE)&quot; == factory){
			var conn_oa = Server.createSessionConnection(&quot;EZFlow_C&quot;);	
		}			
		var sql_iso = &quot;update isoeba set isoeba097=&apos;3&apos;,isoeba098=&apos;5&apos;,isoeba099=&apos;3&apos;,isoeba012= &apos;&quot;+ todate +&quot;&apos; where isoeba001 = &apos;&quot;+ GCE_Doc_Sn +&quot;&apos; and isoeba012=&apos;&apos;  &quot;;  // 004 是文件版本
		var result = conn_oa.updateValue(sql_iso);	
		if(&quot;true&quot;==result){
			conn_oa.commit();
		}else{
			conn_oa.rollback();				
		}
	}catch(e){ 					
		
	}
	conn_oa.close();
}

/* 三廠的環安管理代代表
SGCE--&gt;MEMS1013460  章元藩
TGCE--&gt;MEMT1007321  李松營
CGCE--&gt;MEMC1000002  林志濤 
*/
function setOHSAS_delegate(){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();	
	var factory = dataMap.get(&quot;Factory&quot;);
	var vOHSAS_delegate = &quot;MEMT1007321&quot;; // 預設先預設為TGCE管理者--李松營
	var factory_chief = &quot;MEMT1006161&quot;;  // 預設先預設為TGCE廠長--蔡錦松
	if(&quot;(CGCE)&quot; == factory){
		//vOHSAS_delegate = &quot;MEMS1039626&quot;; // 廖祐唯
		//vOHSAS_delegate = &quot;MEMC1000042&quot;;//周利華 modify by edison@20140929
		vOHSAS_delegate = &quot;MEMC1027881&quot;;//黃建嘉 modify by edison@20180704
		factory_chief = &quot;MEMC1043983&quot;;  //董憲卿
	}else if (&quot;(SGCE)&quot; == factory){
		//vOHSAS_delegate = &quot;MEMS1039626&quot;;// 廖祐唯 
		vOHSAS_delegate = &quot;MEMS1000244&quot;;//黎祥 modify by edison@20140929
//		factory_chief = &quot;MEMC1000010&quot;;  //石俊傑  modify by edison@20160830 (原本是董憲卿)
		factory_chief = &quot;MEMT1006161&quot;;  // modify by edison 廠長--(石俊傑-&gt;蔡錦松)
	}else if (&quot;(HGCE)&quot; == factory){
		//vOHSAS_delegate = &quot;MEMT1007321&quot;;//  MEMT1007321
//		vOHSAS_delegate = &quot;MEMH1010726&quot;;//劉文斌
		vOHSAS_delegate = &quot;MEMS1009555&quot;;//張凱飛    //modify by edison@20180620
		factory_chief = &quot;MEMH1023036&quot;;  //薛永龍
	}
//    var SQL =    &quot; select VALUE2 memid ,VALUE1 username  from A_PARAMETER_ITEM , A_PARAMETER_DATA &quot;;
//    SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
//    SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
//    SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&apos; &quot;;
//    SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 = &apos;&quot;+ factory +&quot;&apos; &quot;  ;          
//
//    var vector = Server.SQLloadValue(SQL); 
	dataMap.put(&quot;OHSAS_delegate&quot;,vOHSAS_delegate);
	dataMap.put(&quot;factory_chief&quot;,factory_chief);
}
//三廠文件同步作廢
function setSynchronousOutDocStatus(status){
	var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var vec = dataMap.get(&quot;Table1&quot;);
		var RealExecutorID = MyTask.getRealExecutor();
		var RealExecutor = Server.getMember(RealExecutorID);
		var account = &quot;eipadmin&quot;;
		if(RealExecutor != null){
			account = RealExecutor.getLoginID();
		}
		try{
			if(vec.size()&gt;0){
				var doc_id = &quot;&quot;;
				var ver_id = &quot;&quot;;
				var category_id = &quot;&quot;;
				for(var i=0;i&lt;vec.size();i++){
					doc_id = vec.get(i).get(&quot;ITEM4&quot;);
					ver_id = vec.get(i).get(&quot;ITEM5&quot;);
					category_id = vec.get(i).get(&quot;ITEM6&quot;);
					if(doc_id!=&quot;&quot; &amp;&amp; ver_id!=&quot;&quot; &amp;&amp; category_id!=&quot;&quot;){
						var wfapi = new Packages.com.eland.ekm.api.workflow.WorkflowFunctionAPI(hostname);				  
						var success = wfapi.setDocStatus(category_id,doc_id,ver_id,account,status); // public void setDocStatus(String categoryId, String docId, int verId, String account, String docStatus)
						java.lang.System.out.println(&quot;WorkflowFunctionAPI.hostname=[&quot;+ hostname + &quot;] set DccStatus [&quot;+ status +&quot;] success:[&quot; + success + &quot;]&quot;);
						if(true != success){
							  sendExcptionMail(&quot;[update ekm 狀態失敗]:setDocStatus(status);fapi.setDocStatus(&quot; + category_id + &quot;,&quot;+ doc_id + &quot;,&quot;+ ver_id+ &quot;,&quot; + account + &quot;,&quot; + status + &quot;)&quot;);
						}
						
					}					
				}
			}
		}catch(e){
		}	
}


//檢查文件是否被關聯,若有則email通知該廠文管人員,並寫入紀錄
//add by edison@20130607
function chkSynchronousDoc(){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var process_type = MyTask.artInstance.name;	 
	var art_name = artIns.getName();
	var factory = dataMap.get(&quot;Factory&quot;).substr(1,4);
	var doc_id = dataMap.get(&quot;Doc_ID&quot;);
	var gce_doc_sn = dataMap.get(&quot;GCE_Doc_Sn&quot;);
	var gce_ver = dataMap.get(&quot;GCE_Ver_Sn&quot;);
	var new_subject = dataMap.get(&quot;Subject&quot;);
	var old_subject = dataMap.get(&quot;Subject&quot;);
	var ver_id = dataMap.get(&quot;Ver_ID&quot;);//文件作廢申請單 版序
	var flag = false;
	var App_MemID = dataMap.get(&quot;App_MemID&quot;);
	if( art_name.equals(&quot;文件變更確認單&quot;) ){		
		//chkOldVerSyn(doc_id,ver_id,dataMap.get(&quot;OVer_ID&quot;));//檢查上一版是否有設定關連文件,有則複製至下一版
		ver_id = dataMap.get(&quot;OVer_ID&quot;);//文件變更確認單 版序
		var sqla = &quot;select subject from ekm.techdoc_version where doc_id=&apos;&quot;+doc_id+&quot;&apos; and ver_id=&apos;&quot;+ver_id+&quot;&apos;&quot;;
		var rs = Server.SQLloadValue(sqla);
		if(rs!=null &amp;&amp; rs.size()&gt;0){
			old_subject = rs.get(0).get(&quot;subject&quot;);
			if(!new_subject.equals(old_subject)){//文件名稱有變更才通知
				flag = true;
			}
		}
	}
	if(art_name.equals(&quot;文件作廢申請單&quot;)){
		flag = true;
	}
	
	var sql = &quot;SELECT distinct a.* &quot;;
		sql +=&quot;   FROM ekm.techdoc_version a, ekm.field_data b, ekm.eland_techdoc c &quot;;
		sql +=&quot;  WHERE a.doc_id = b.ref_id_01 &quot;;
		sql +=&quot;    AND a.doc_id = c.doc_id &quot;;
		sql +=&quot;    AND a.ver_id = c.latest_version &quot;;
		sql +=&quot;    AND b.ref_id_02 = c.latest_version &quot;;
		sql +=&quot;    AND (b.col_01 LIKE &apos;%&quot;+doc_id+&quot;%&apos; OR b.col_02 LIKE &apos;%&quot;+doc_id+&quot;%&apos;)&quot;;
		sql +=&quot;    AND a.status&lt;&gt;&apos;A&apos; &quot;;
		Server.addDebugLog(&quot;sql==&quot;+sql);
	
	try{
		var vec = Server.SQLloadValue(sql);
		if(vec!=null &amp;&amp; vec.size()&gt;0){
			var vector = new java.util.Vector();			
			var taskID = MyTask.getID();			
			var mail_list = Server.getMemberByID(dataMap.get(&quot;Table_DCC&quot;).get(0).get(&quot;ITEM1&quot;)).getEmail();		
			var mail_cc_list =&quot;edison_wang@gce.com.tw&quot;;
			var count = 0;
			var vContent = &quot;&lt;table border=0 &gt;&lt;td bgcolor=#6495ed &gt;作業名稱&lt;/td&gt;&lt;td bgcolor=#6495ed &gt;異動文件編號&lt;/td&gt;&lt;td bgcolor=#6495ed &gt;關聯文件編號&lt;/td&gt;&lt;td bgcolor=#6495ed&gt;版序&lt;/td&gt;&lt;td bgcolor=#6495ed&gt;標題&lt;/td&gt;&lt;td bgcolor=#6495ed&gt;作者&lt;/td&gt;&lt;tr&gt;&quot;;
			for(var i = 0; i&lt;vec.size(); i++){
				var ls_doc_id = vec.get(i).get(&quot;doc_id&quot;);
				var ls_ver_id = vec.get(i).get(&quot;ver_id&quot;);
				var ls_gce_doc_sn = vec.get(i).get(&quot;gce_doc_sn&quot;);
				var ls_gce_ver_sn = vec.get(i).get(&quot;gce_ver_sn&quot;);
				var ls_subject = vec.get(i).get(&quot;subject&quot;);
				var ls_creator = vec.get(i).get(&quot;creator&quot;);
				vContent +=&quot;&lt;td bgcolor=#b0e0e6 &gt;&quot;+art_name+&quot;&lt;/td&gt;&lt;td bgcolor=#b0e0e6 &gt;&quot;+gce_doc_sn+&quot;&lt;/td&gt;&quot;;
				vContent +=&quot;&lt;td bgcolor=#b0e0e6 &gt;&lt;a href=http://&quot;+  hostname +   &quot;/eip/techdoc/Tech_iso_read.jsp?doc_id=&quot;+ ls_doc_id +&quot;&amp;ver_id=&quot;+ ls_ver_id +&quot;&amp;codex=codex target=_new &gt;&quot;+ls_gce_doc_sn+&quot;&lt;/a&gt;&lt;/td&gt;&quot;;
				vContent +=&quot;&lt;td bgcolor=#b0e0e6 &gt;&quot;+ls_gce_ver_sn+&quot;&lt;/td&gt;&lt;td bgcolor=#b0e0e6&gt;&quot;+ls_subject+&quot;&lt;/td&gt;&lt;td bgcolor=#b0e0e6&gt;&quot;+ls_creator+&quot;&lt;/td&gt;&lt;tr&gt;&quot;;		
				count++;
				if(flag){
					insert_a_iso_synchronous(factory,art_name,gce_doc_sn,ls_gce_doc_sn,ls_gce_ver_sn,ls_doc_id,ls_ver_id,ls_subject,ls_creator,App_MemID);
				}
				
				             
			}
			vContent +=&quot;&lt;/table&gt;&quot;;
			if(count&gt;0 &amp;&amp; flag){
				Server.sendHTMLMailExt(&quot;MyGCE&quot;,mail_list,mail_cc_list,(&quot;[通知](&quot;+factory+&quot;)ISO文件關聯通知!&quot;),vContent,vector,taskID);
			}
		}
	}catch(e){
	}
	
}

function insert_a_iso_synchronous(factory,art_name,gce_doc_sn,ls_gce_doc_sn,ls_gce_ver_sn,ls_doc_id,ls_ver_id,ls_subject,ls_creator,App_MemID){
	var date = new java.util.Date(Server.getServerTime());
	var SDformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
	var ls_date =SDformat.format(date);
	var sql = &quot;INSERT INTO A_ISO_SYNCHRONOUS ( FACTORY, PROCESS_NAME, GCE_DOC_SN, RELEVANCE_GCE_DOC_SN,	RELEVANCE_GCE_VER_SN, &quot;;
	    sql +=&quot;RELEVANCE_DOC_ID, RELEVANCE_VER_ID, SUBJECT, CREATOR, CREATE_TIME, MODIFY_TIME, UPDATE_USER_ID, FLAG, COM) &quot;; 
		sql +=&quot;VALUES (&apos;&quot;+factory+&quot;&apos; ,&apos;&quot;+art_name+&quot;&apos; ,&apos;&quot;+gce_doc_sn+&quot;&apos; ,&apos;&quot;+ls_gce_doc_sn+&quot;&apos; , &quot;;
		sql +=&quot;&apos;&quot;+ls_gce_ver_sn+&quot;&apos;,&apos;&quot;+ls_doc_id+&quot;&apos; ,&apos;&quot;+ls_ver_id+&quot;&apos; , &quot;;
		sql +=&quot;&apos;&quot;+ls_subject+&quot;&apos;,&apos;&quot;+ls_creator+&quot;&apos; , &quot;;
		sql +=&quot;&apos;&quot;+ls_date+&quot;&apos;,&apos;&apos; ,&apos;MEMT1022153&apos; ,&apos;N&apos;,&apos;&quot;+App_MemID+&quot;&apos; ) &quot;;
	Server.addDebugLog(&quot;sql==&quot;+sql);
	try{
		var vec = Server.SQLinsertValue(sql);
	}catch(e){
	}
}

function chkOldVerSyn(doc_id,ver_id,old_ver_id){
	try{
		//先刪除
		var rs = Server.SQLdeleteValue((&quot;delete from ekm.field_data where ref_id_01=&apos;&quot;+doc_id+&quot;&apos; and ref_id_02=&apos;&quot;+ver_id+&quot;&apos;&quot;));
		//再新增
		var sql = &quot;INSERT INTO ekm.field_data &quot;;
            sql +=&quot;     (col_01, col_02, ref_id_01, ref_id_02) &quot;;
			sql +=&quot; SELECT col_01, col_02, ref_id_01, &quot;+ver_id;
			sql +=&quot;   FROM ekm.field_data &quot;;
			sql +=&quot;  WHERE ref_id_01 = &apos;&quot;+doc_id+&quot;&apos; AND ref_id_02 = &apos;&quot;+old_ver_id+&quot;&apos;&quot;;
		var vec = Server.SQLinsertValue(sql);
	}catch(e){
	}
	
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>帶ekm文件資料及回寫ekm文件狀態等</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001209032411725</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/04/18 16:36:18</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.MAN.addAsignTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001209032411725</string> 
     </void> 
     <void property="name"> 
      <string>addAsignTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001209032361851</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/* 2010/05/27 
1. 增加 &quot;材料&quot;及&quot;原物料&quot;的勾選欄位           
是否要給預設值? …恩 什麼意思? 材料指 基板/膠片 類
  是材料類才減少下面的會簽人員嗎?   YES                                                                                           
2.減少目前會簽核人員--(2R1/2R2 產品工程部)
                 --(2K2 OR 2K1，若是2K1提出，則2K2不須簽，反之亦然)
                 --(2G0 品質保證處 李長興)
                 --(2A0 管理處 林勝賢)     
DEP2J1制程能力提升部門
EDEP2J2制工程部代號
DEP2R1新技朮開發部門
DEP2D4採購一部門
DEP2A8環工部門
DEP2G1&quot; 可靠度 -- 目前是李長興
DEP2G2&quot; then &apos;品保部代號
DEP2G3&quot; then &apos;管制部代號
採購會簽另外再call setPur 這個function  wei@2011/09/02
*/ 
function addAsignList(){ 
// 判斷不同廠別call 不同的funciton	
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	//使用者姓名
//	var roleID = MyTask.getRoleID();
//	var memDR = cMember.getMemberDR(roleID);
//	var sDepName = memDR.getDepartmentName();	//使用者部門名稱
//	var sDepID = Server.getDepartment(memDR.getDepartmentID()).getMyID();
//	var sRoleName = memDR.getRoleName();	//使用者職務名稱
	var companyID = cMember.getAreaCode(); //使用者公司代碼
// 理級主管
// 2012/07/11 加上,DEPT2B5 , 2012/07/18 筆戰結果改為通知不用簽核
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();
	var SignTable = appDataMap.get(&quot;Sign_MemberTable_A&quot;);	// 理級的list
    var App_DepID = appDataMap.get(&quot;App_DepID&quot;); // 申請者部門代號
	var App_Dep_ID= appDataMap.get(&quot;App_Dep_ID&quot;); // 申請者部門代號 3碼
	var vFlow=getFlow(&quot;102&quot;); // 計算簽核人員,for讀取部門主管時不要再加入
	var vManagerList=&quot;&quot;;      // 紀錄部門主管for有相同的主管人員	
	var vFR_type2 = appDataMap.get(&quot;FR_type2&quot;); // 申請類別: 是否是材料 type1 是原物料
	if(vFR_type2 ==&quot;true&quot;){
		if(companyID==&quot;TGCE&quot;){
			if(App_Dep_ID.indexOf(&quot;K&quot;) &gt; 0){  // 選擇材料且是 K 部門發出的則不用會簽 K 部門
				var signDptnoList = &quot;DEPT2J1,DEPT2J2,DEPT2A8,DEPT2D3,DEPT2G1,DEPT2G3,DEPT2G9&quot;;  // ,DEPT2J3
			}else{
				var signDptnoList = &quot;DEPT2J1,DEPT2J2,DEPT2K1,DEPT2K2,DEPT2A8,DEPT2D3,DEPT2G1,DEPT2G3,DEPT2G9&quot;; //,DEPT2J3
			}
		}
		if(companyID==&quot;SGCE&quot;){
			var signDptnoList = &quot;DEPS6J1,DEPS6J2,DEPS6J3,DEPS6A8,DEPS6G1,DEPS6G2,DEPS6G3,DEPS6D2,DEPS6G7,DEPS6G9,DEPS6K0&quot;; // 2009/09/29取消6A4,改設定在a_sign_table_j 黃清山 2011/01/20 加入6G9
		}
		if(companyID==&quot;CGCE&quot;){
			var signDptnoList = &quot;DEPC8J1,DEPC8J2,DEPC8G3,DEPC8G0,DEPC8D0&quot;;   // 8A8主管目前是何誌勛,因己列入處級主管,SO不列入此
		}		
		if(companyID==&quot;HGCE&quot;){  // add by wangwei@2010/10/2
			var signDptnoList = &quot;DEPH5J1,DEPH5A8,DEPH5G3,DEPH5G0,DEPH5D0&quot;;
		}					
	}else{  // 不是材料則依原來的簽核設定
		if(companyID==&quot;TGCE&quot;){
			var signDptnoList = &quot;DEPT2J1,DEPT2J2,DEPT2R2,DEPT2K1,DEPT2K2,DEPT2A8,DEPT2D3,DEPT2G1,DEPT2G3,DEPT2G9,DEPT2B5&quot;;//,DEPT2R1,,DEPT2J3
		}
		if(companyID==&quot;SGCE&quot;){
			var signDptnoList = &quot;DEPS6J1,DEPS6J2,DEPS6J3,DEPS6A8,DEPS6G1,DEPS6G2,DEPS6G3,DEPS6D2,DEPS6G7,DEPS6G9,DEPS6K0,DEPT2B5&quot;; // 2009/09/29取消6A4,改設定在a_sign_table_j 黃清山 2011/01/20 加入6G9
		}
		if(companyID==&quot;CGCE&quot;){
			var signDptnoList = &quot;DEPC8J1,DEPC8J2,DEPC8G3,DEPC8G0,DEPC8D0,DEPT2B5&quot;;
		}	
		if(companyID==&quot;HGCE&quot;){
			var signDptnoList = &quot;DEPH5J1,DEPH5A8,DEPH5G3,DEPH5G0,DEPH5D0,DEPT2B5&quot;;
		}			
	}
	 SignTable.clear();	 
	 signDptnoList = signDptnoList + &quot;&quot;;//轉為 string
	 var fields = signDptnoList.split(&quot;,&quot;);
	 var queryStr =&quot;&quot;;
	 for (var i=0; i&lt;fields.length; i++) {  
		 var singDptno = fields[i];
		 var department = Server.getDepartment(singDptno);    
		 if(department!=null &amp;&amp; App_DepID!=singDptno){			 			 
			 var dptcname=department.getName(); 			 
			 var managerRoleID = department.getManagerID();
			 var depID = department.getID(); // 取得部門的ID
			 var member = Server.getMemberByID(managerRoleID);		
			 if(member != null ){
 				 var managerName = member.getName();
				 if (member.getMainRoleID().substring(7,10)&lt; &quot;102&quot;){ // add by wanngwei@20090810 若部門主管為副處以上則不要加入
					 if(vFlow.indexOf(managerName)&lt; 0&amp;&amp;vManagerList.indexOf(managerName)&lt;0){ // 檢核是否在層簽中或一主管有兩個單位
						 vManagerList = vManagerList+&quot;,&quot;+managerName ;
						 var row = new Packages.java.util.HashMap();		 			 
						 row.put(&quot;memid&quot;,managerRoleID);
						 row.put(&quot;cname&quot;,managerName);
						 row.put(&quot;dptno&quot;,dptcname);
						 SignTable.add(SignTable.size(), row);
					 }
				 }				 
			 }
		 }			 
	  }
	appDataMap.put(&quot;Sign_MemberTable_A&quot;, SignTable);
	aInstance.setAppDataMap(appDataMap);
//---------特別指定理級主管／單位主管
  var SignTable = appDataMap.get(&quot;Sign_MemberTable_A&quot;);
  var artid = aInstance.getArtifactID();
  var sql = &quot; select trim(memid) as memid ,username from a_sign_table_j where groupid = &apos;Sign_MemberTable_A&apos; and factory = &apos;&quot;+ companyID +&quot;&apos;&quot; + &quot; and dptno not like &apos;%&quot;+ App_Dep_ID +&quot;%&apos;&quot;  ;
  var vector = Server.SQLloadValue(sql);
    if ( vector != null ){
	   if (vector.size()&gt;0){
		  for(var i=0;i&lt;vector.size();i++)  {
			  var ht = vector.get(i);
			  var memid = ht.get(&quot;memid&quot;)
			  var cMember = Server.getMemberByID(memid);
			  if(cMember == null){
					memid = &quot;MEMT1005230&quot;  // 先設給005230	
			    var cMember = Server.getMemberByID(memid);
			    }
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  var row = new Packages.java.util.HashMap()		 
			  row.put(&quot;memid&quot;,memid);
			  row.put(&quot;cname&quot;,ht.get(&quot;username&quot;));
			  row.put(&quot;dptno&quot;,dptcname);
			  SignTable.add(SignTable.size(), row);			  
			 }
			 appDataMap.put(&quot;Sign_MemberTable_A&quot;, SignTable);
			 aInstance.setAppDataMap(appDataMap);			 
		}//for
	}
}  // --------------------------------------
//---------------------------------------
// 先期審查小組 add by wangwei 2008/08/09
function addAsignListTableD(){ 
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var companyID = appDataMap.get(&quot;Factory&quot;).substring(1,5);
    var SignTable_d = appDataMap.get(&quot;Sign_MemberTable_D&quot;);
    SignTable_d.clear();	
	var artid = aInstance.getArtifactID();
//    var sql = &quot; select trim(memid) as memid ,username from a_sign_table_j where groupid = &apos;Sign_MemberTable_D&apos; and factory = &apos;&quot;+ companyID +&quot;&apos;&quot;   ;
	//modify by edison@20190418(改抓J0，A8主管)
	var sql = &quot; select b.memid,b.username from dep_geninf a,mem_geninf b where A.MANAGERID=B.MEMID and(a.id like &apos;%J0%&apos; or a.id like &apos;%A8%&apos;) and B.RESIGN=&apos;false&apos; and B.AREACODE=&apos;&quot;+ companyID +&quot;&apos;&quot;
    var vector = Server.SQLloadValue(sql);
    if ( vector != null ){
	   if (vector.size()&gt;0){
		  for(var i=0;i&lt;vector.size();i++)  {
			  var ht = vector.get(i);
			  var memid = ht.get(&quot;memid&quot;) ;
			  var cMember = Server.getMemberByID(memid);
			  if(cMember == null){
// 檢核員工是否是有效的,若無效基本上會傳給administrator , 
				memid = &quot;MEMT1005230&quot;   ;// 先設給005230	
			    var cMember = Server.getMemberByID(memid);
			  }
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  var row = new Packages.java.util.HashMap()	;	 
			  row.put(&quot;memid&quot;,memid);
			  row.put(&quot;cname&quot;,ht.get(&quot;username&quot;));
			  row.put(&quot;dptno&quot;,dptcname);
			  SignTable_d.add(SignTable_d.size(), row);			  
			 }
		  }//for
		}
	appDataMap.put(&quot;Sign_MemberTable_D&quot;, SignTable_d);
	aInstance.setAppDataMap(appDataMap);
}	

// 處級主管asign add by wangwei 2008/11/19
function addAsignListTableB(){ 
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var SignTable_b = appDataMap.get(&quot;Sign_MemberTable_B&quot;);
	var companyID = appDataMap.get(&quot;Factory&quot;).substring(1,5);
	var App_Dep_ID = appDataMap.get(&quot;App_Dep_ID&quot;);
	var vManagerList=&quot;administrator&quot;;  // 空白好像不行一定要有
	var vFlow=getFlow(&quot;102&quot;); // 計算簽核人員,for讀取部門主管時不要再加入
	var vFR_type2 = appDataMap.get(&quot;FR_type2&quot;); // 申請類別: 是否是材料 type1 是原物料
	    if(vFR_type2 ==&quot;true&quot;){     // 材料不用給林勝賢
			var sql = &quot;select trim(a.memid) as memid ,a.username from a_sign_table_j a where a.groupid = &apos;Sign_MemberTable_B&apos; and username &lt;&gt; &apos;林勝賢&apos; and a.factory = &apos;&quot;+ companyID +&quot;&apos;&quot; + &quot; and a.dptno not like &apos;%&quot;+ App_Dep_ID +&quot;%&apos;&quot;  ;
		}else{
			var sql = &quot;select trim(a.memid) as memid ,a.username from a_sign_table_j a where a.groupid = &apos;Sign_MemberTable_B&apos; and a.factory = &apos;&quot;+ companyID +&quot;&apos;&quot; + &quot; and a.dptno not like &apos;%&quot;+ App_Dep_ID +&quot;%&apos;&quot;  ;
		}
	var vAD=&quot;D4&quot;;			
	var vD4 = appDataMap.get(&quot;D4&quot;); // 採一  D4 or A4 應該是2選1
	var vA4 = appDataMap.get(&quot;A4&quot;); // 採二		
	if(&quot;true&quot;==vD4){vAD=&quot;D4&quot;;}  // add by wangwei@2011/09/02
	if(&quot;true&quot;==vA4){vAD=&quot;A4&quot;;}		
		sql = sql +  &quot;union select trim(b.memid) as memid ,b.username from a_sign_table_j b where b.groupid = &apos;Sign_MemberTable_B_PUR&apos; and b.factory = &apos;&quot;+ companyID +&quot;&apos;&quot; + &quot; and b.dptno not like &apos;%&quot;+ App_Dep_ID +&quot;%&apos; and b.dptno_a = &apos;&quot;+vAD+&quot;&apos;&quot;; 
		Server.addDebugLog(&quot;原物料鑑審-處級:&quot;+sql);
	try{	
		var vector = Server.SQLloadValue(sql);
		if ( vector != null ){
		   if (vector.size()&gt;0){
			   SignTable_b.clear();
			  for(var i=0;i&lt;vector.size();i++)  {
				  var ht = vector.get(i);
				  var memid = ht.get(&quot;memid&quot;) ;
				  var cMember = Server.getMemberByID(memid);
				  if(cMember == null){
					memid = &quot;MEMT1005230&quot; ; // 先設給005230	
					var cMember = Server.getMemberByID(memid);
				  }
				  var roleID = cMember.getMainRoleID();
				  var memDR =  cMember.getMemberDR(roleID);
				  if( memDR != null ){
					  var vName = ht.get(&quot;username&quot;);
					 if(vFlow.indexOf(vName.trim())&lt; 0&amp;&amp;vManagerList.indexOf(vName.trim())){
						 var managerName=ht.get(&quot;username&quot;);
						 vManagerList = vManagerList+&quot;,&quot;+managerName ;
						 var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
						 var row = new Packages.java.util.HashMap() ;		 
						 row.put(&quot;memid&quot;,memid);
						 row.put(&quot;cname&quot;,ht.get(&quot;username&quot;));
						 row.put(&quot;dptno&quot;,dptcname);
						 SignTable_b.add(SignTable_b.size(), row);			  
					 }
				  }
				 }//for				 
			  }
		}
	}catch(e){
		Server.addErrLog(&quot;原物料試用申請報告單 call function:addAsignListTableB &quot;);
	}
	appDataMap.put(&quot;Sign_MemberTable_B&quot;, SignTable_b);
	aInstance.setAppDataMap(appDataMap);		
}
//-報告單結束時要啟動它廠KLM人員---  此function 已不使用----
function addAsignListTableE(){ 
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
    var SignTable_b = appDataMap.get(&quot;Sign_MemberTable_E&quot;);
	var companyID = appDataMap.get(&quot;Factory&quot;).substring(1,5) ;  
	var artid = aInstance.getArtifactID();
    var sql = &quot; select trim(memid) as memid ,username from a_sign_table_j where groupid = &apos;Sign_MemberTable_E&apos; and factory = &apos;&quot;+ companyID +&quot;&apos;&quot;   ;
	
    var vector = Server.SQLloadValue(sql);
    if ( vector != null ){
	   if (vector.size()&gt;0){
	       SignTable_b.clear();	  // 有資料再清空
		  for(var i=0;i&lt;vector.size();i++)  {
			  var ht = vector.get(i);
			  var memid = ht.get(&quot;memid&quot;) ;
			  var cMember = Server.getMemberByID(memid);
			  if(cMember == null){
// 檢核員工是否是有效的,若無效基本上會傳給administrator , 
				memid = &quot;administrator&quot; ;
			    var cMember = Server.getMemberByID(memid);
			  }
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  var row = new Packages.java.util.HashMap() ;		 
			  row.put(&quot;memid&quot;,memid);
			  row.put(&quot;cname&quot;,ht.get(&quot;username&quot;));
			  row.put(&quot;dptno&quot;,dptcname);
			  SignTable_b.add(SignTable_b.size(), row);			  
			 }
		  }//for
		}
	appDataMap.put(&quot;Sign_MemberTable_E&quot;, SignTable_b);
	aInstance.setAppDataMap(appDataMap);		
	}
//-報告單結束時要啟動它廠採購人員員-------
function addAsignListTableF(){ 
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
    var SignTable_b = appDataMap.get(&quot;Sign_MemberTable_E&quot;);  // 用原來的table
	SignTable_b.clear();			// add by wangwei@2016/06/23
	var companyID = appDataMap.get(&quot;Factory&quot;).substring(1,5) ;  
	var artid = aInstance.getArtifactID();
	var vD4 = appDataMap.get(&quot;D4&quot;); // 採一  D4 or A4 應該是2選1
	var vA4 = appDataMap.get(&quot;A4&quot;); // 採二
	var vAD=&quot;D4&quot;;
	if(&quot;true&quot;==vD4){vAD=&quot;D4&quot;;}
	if(&quot;true&quot;==vA4){vAD=&quot;A4&quot;;}	
// 增加區分D4 A4 給不同的人 a_sign_table_j 也要改	
    var sql = &quot; select trim(memid) as memid ,username from a_sign_table_j where groupid = &apos;Sign_MemberTable_F&apos; and factory = &apos;&quot;+ companyID +&quot;&apos; and dptno_a = &apos;&quot;+ vAD +&quot;&apos;&quot; ;
//    var sql = &quot; select trim(memid) as memid ,username from a_sign_table_j where groupid = &apos;Sign_MemberTable_F&apos; and factory = &apos;&quot;+ companyID +&quot;&apos;&quot; ;
	Server.addDebugLog(&quot;原物料鑑審-KLM 人員:&quot;+sql);
    var vector = Server.SQLloadValue(sql);
    if ( vector != null ){
	   if (vector.size()&gt;0){
	       SignTable_b.clear();	  // 有資料再清空
		  for(var i=0;i&lt;vector.size();i++)  {
			  var ht = vector.get(i);
			  var memid = ht.get(&quot;memid&quot;) ;
			  var cMember = Server.getMemberByID(memid);
			  if(cMember == null){
// 檢核員工是否是有效的,若無效基本上會傳給administrator , 
				memid = &quot;administrator&quot; ;
			    var cMember = Server.getMemberByID(memid);
			  }
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  var row = new Packages.java.util.HashMap() ;		 
			  row.put(&quot;memid&quot;,memid);
			  row.put(&quot;cname&quot;,ht.get(&quot;username&quot;));
			  row.put(&quot;dptno&quot;,dptcname);
			  SignTable_b.add(SignTable_b.size(), row);			  
			 }
		  }//for
		}
	appDataMap.put(&quot;Sign_MemberTable_E&quot;, SignTable_b);
	aInstance.setAppDataMap(appDataMap);		
	}
	
	
//--將簽核人員儲存, for 檢查是否重複簽核
function getFlow(verLv){ 
	var i=0;
	var vString;
	var vMenName=&quot;&quot;;
	try{
		var App_MemID = MyTask.getRealExecutor();
		var cMember = Server.getMemberByID(App_MemID);	
		var sUserName = cMember.getName();	//使用者姓名
		var	vMemID = Server.getMemberByID(App_MemID).getPager(); //申請者主管	
		var vMem = Server.getMember(vMemID); // 主管的物件
		var vMainRoleID = vMem.getMainRoleID();
		var mbrLv= Server.getRole(vMainRoleID).getMyID();//vMem.getMainRoleID();
		var vString=sUserName;
		while ( mbrLv &lt; verLv  &amp;&amp; i &lt; 5 ){
			vMenName = vMem.getName();  // 姓名
			vString = vString+vMenName +&quot;-&gt;&quot;;		
			vMem=getManager(vMemID);   // 取得主管物件
			mbrLv=Server.getRole(vMem.getMainRoleID()).getMyID();
			vMenName = vMem.getName();		
			vMemID=vMem.getID(); // 		
			i++ ;
		}	
		vString = vString+vMenName ;		
	}catch(e){
		Server.addErrLog(&quot;原物料試用申請報告單 call getFlow&quot;+sUserName);
		vString = &quot;administrator&quot;;
	}
	return vString;
}

function getManager(vMemID){
	var mem = Server.getMember(vMemID);
	var managerMemID = &quot;Administrator&quot;;
	if(mem != null){
		managerMemID = mem.getPager();
	}
	var manager = Server.getMember(managerMemID);
	return manager;
}

//-UL 各單位主管審核--- select *from mem_geninf where username in (&apos;劉輝煌&apos;,&apos;蔡錦松&apos;,&apos;陳元鴻&apos;,&apos;李順騫&apos;,&apos;李松營&apos;)   ----
function addAsignListTableUL(){ 
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
    var SignTable_b = appDataMap.get(&quot;MemberTable_UL&quot;);  // 用原來的table
	var companyID = appDataMap.get(&quot;Factory&quot;).substring(1,5) ;  
	var artid = aInstance.getArtifactID();
	var vtgce = appDataMap.get(&quot;tgce&quot;);
	var vsgce = appDataMap.get(&quot;sgce&quot;);
	var vcgce = appDataMap.get(&quot;cgce&quot;);
	var vhgce = appDataMap.get(&quot;hgce&quot;);	
	var vTSCH = &quot;&quot;;
	if(&quot;true&quot;==vtgce){
		vTSCH = vTSCH + &quot;TGCE&apos;,&apos;&quot;;
	}
	if(&quot;true&quot;==vsgce){
		vTSCH = vTSCH +&quot;SGCE&apos;,&apos;&quot;;
	}
	if(&quot;true&quot;==vcgce){
		vTSCH = vTSCH +&quot;CGCE&apos;,&apos;&quot;;
	}
	if(&quot;true&quot;==vhgce){
		vTSCH = vTSCH +&quot;HGCE&apos;,&apos;&quot;;
	}	
    var sql = &quot; select distinct trim(memid) as memid ,username ,dptno from a_sign_table_j where groupid = &apos;MemberTable_UL&apos; and factory in (&apos;&quot;+ vTSCH + &quot;&apos;)&quot; ;	
//    var sql = &quot; select trim(memid) as memid ,username ,dptno from a_sign_table_j where groupid = &apos;MemberTable_UL&apos; and factory = &apos;&quot;+ companyID +&quot;&apos;&quot;   ;
    var vector = Server.SQLloadValue(sql);
    if ( vector != null ){
	   if (vector.size()&gt;0){
	       SignTable_b.clear();	  // 有資料再清空
		  for(var i=0;i&lt;vector.size();i++)  {
			  var ht = vector.get(i);
			  var memid = ht.get(&quot;memid&quot;) ;
			  var cMember = Server.getMemberByID(memid);
			  if(cMember == null){
// 檢核員工是否是有效的,若無效基本上會傳給administrator , 
				memid = &quot;administrator&quot; ;
			    var cMember = Server.getMemberByID(memid);
			  }

			  var row = new Packages.java.util.HashMap() ;		 
			  row.put(&quot;memid&quot;,memid);
			  row.put(&quot;cname&quot;,ht.get(&quot;username&quot;));
			  row.put(&quot;dptno&quot;,ht.get(&quot;dptno&quot;));
			  SignTable_b.add(SignTable_b.size(), row);			  
			 }
		  }//for
		}
	appDataMap.put(&quot;MemberTable_UL&quot;, SignTable_b);
	aInstance.setAppDataMap(appDataMap);		
}

//-UL/PR窗口
function addAsignPRUL(){ 
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var companyID = appDataMap.get(&quot;Factory&quot;).substring(1,5) ;  
	var artid = aInstance.getArtifactID();
//--採購窗口----------------
    var sql = &quot; select trim(a.memid) as memid ,a.username ,a.dptno from a_sign_table_j a,mem_geninf b where trim(a.memid)=trim(b.memid) and b.resign=&apos;false&apos; and a.groupid = &apos;PR_window&apos; and a.factory = &apos;&quot;+ companyID +&quot;&apos;&quot;   ;
    var vector = Server.SQLloadValue(sql);
    if ( vector != null ){
	   if (vector.size()&gt;0){
		   var vMEMID = vector.get(0).get(&quot;memid&quot;);
		   appDataMap.put(&quot;PUR_MEMID&quot;,  vMEMID);
	   }else{
		   appDataMap.put(&quot;PUR_MEMID&quot;, &quot;administrator&quot;);
		   }
	}  // dataMap.put(&quot;con_result_2&quot;,&quot;NG&quot;);	
//--UL窗口----------------
    var sql = &quot; select trim(a.memid) as memid ,a.username ,a.dptno from a_sign_table_j a,mem_geninf b where trim(a.memid)=trim(b.memid) and b.resign=&apos;false&apos; and a.groupid = &apos;UL_window&apos; and a.factory = &apos;&quot;+ companyID +&quot;&apos;&quot;   ;
    var vector = Server.SQLloadValue(sql);
    if ( vector != null ){
	   if (vector.size()&gt;0){
		   var vMEMID = vector.get(0).get(&quot;memid&quot;);
		   appDataMap.put(&quot;ME_MEMID&quot;,vMEMID);
	   }else{
		   appDataMap.put(&quot;ME_MEMID&quot;, &quot;administrator&quot;);
		   }
	}
	aInstance.setAppDataMap(appDataMap);
}
// 依廠別給給適用廠別
function setGCE(){
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var companyID = cMember.getAreaCode(); //使用者公司代碼
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	if(companyID==&quot;TGCE&quot;){
		dataMap.put(&quot;tgce&quot;,&quot;true&quot;) ;
	}
	if(companyID==&quot;SGCE&quot;){
		dataMap.put(&quot;sgce&quot;,&quot;true&quot;) ;
	}
	if(companyID==&quot;CGCE&quot;){
		dataMap.put(&quot;cgce&quot;,&quot;true&quot;) ;
	}	
	if(companyID==&quot;HGCE&quot;){  // add by wangwei@20101002
		dataMap.put(&quot;hgce&quot;,&quot;true&quot;) ;
	}		
}
// Add by wangwei@2011/09/02
// 因採購分為採一採二,相關單位會簽時又不要會簽到不相關的原物料
// 只好由填單者來設定會簽
// 在OPEN FORM ACTION [填單人]關卡會先把採購的刪除,避免第1次選錯被退回
function setPUR(){
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var SignTable = appDataMap.get(&quot;Sign_MemberTable_A&quot;);	// 理級的list
	var App_Dep_ID= appDataMap.get(&quot;App_Dep_ID&quot;); // 申請者部門代號 3碼	
	var vAD=&quot;D4&quot;;
	var vD4 = appDataMap.get(&quot;D4&quot;); // 採一  D4 or A4 應該是2選1
	var vA4 = appDataMap.get(&quot;A4&quot;); // 採二
	if(&quot;true&quot;==vD4){vAD=&quot;D4&quot;;}
	if(&quot;true&quot;==vA4){vAD=&quot;A4&quot;;}
	var vFactory = appDataMap.get(&quot;Factory&quot;).substring(1,5); // (TGCE)==&gt;TGCE
	// 其他廠的採購 2011/10/23 應該不是取它廠的採購而是的本廠的
	var sql = &quot; select trim(memid) as memid ,username from a_sign_table_j where groupid = &apos;Sign_MemberTable_A_PUR&apos; &quot;;
	    sql = sql +&quot; and factory = &apos;&quot;+ vFactory +&quot;&apos;&quot; + &quot; and dptno not like &apos;%&quot;+ App_Dep_ID +&quot;%&apos; and dptno_a = &apos;&quot;+ vAD +&quot;&apos;&quot;  ;		
		Server.addDebugLog(&quot;原物料鑑審-call setPUR:&quot;+sql);
	var vector = Server.SQLloadValue(sql);			
    if ( vector != null ){
	   if (vector.size()&gt;0){
		  for(var i=0;i&lt;vector.size();i++)  {
			  var ht = vector.get(i);
			  var memid = ht.get(&quot;memid&quot;)
			  var vFlag = true;			  
			  for (var j=0;j&lt;SignTable.size() ;j++){	//check 會簽人的工號有無在 SingTable 內,因可能會有退件
				   var vTableMEMID = SignTable.get(j).get(&quot;ITEM1&quot;) ;
					if (memid.equals(vTableMEMID)){
						vFlag = false;
					}
				}//  -------------------------------------------------------------
			  if(vFlag){  // 不存在則新增 
				  var cMember = Server.getMemberByID(memid);
				  if(cMember == null){
					  memid = &quot;MEMT1005230&quot;  // 先設給005230	
					  var cMember = Server.getMemberByID(memid);
				  }
				  var roleID = cMember.getMainRoleID();
				  var memDR =  cMember.getMemberDR(roleID);
				  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
				  var row = new Packages.java.util.HashMap()		 
				  row.put(&quot;memid&quot;,memid);
				  row.put(&quot;cname&quot;,ht.get(&quot;username&quot;));
				  row.put(&quot;dptno&quot;,dptcname);
				  SignTable.add(SignTable.size(), row);			  
				  appDataMap.put(&quot;Sign_MemberTable_A&quot;, SignTable);
				  aInstance.setAppDataMap(appDataMap);			 				  
			  }
		  }
		}//for
	}	
}
// UL 申請單,業務單位會簽
function addAsignListTableSE(){ 
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
    var SignTable = appDataMap.get(&quot;MemberTable_SE&quot;);  // 用原來的table
	var companyID = appDataMap.get(&quot;Factory&quot;).substring(1,5) ;  
	var artid = aInstance.getArtifactID();
	SignTable.clear();	  // 有資料再清空
	var row = new Packages.java.util.HashMap() ;	
	row.put(&quot;memid&quot;,&quot;MEMT1005982&quot;);
	row.put(&quot;cname&quot;,&quot;劉敏澄&quot;);
	SignTable.add(SignTable.size(), row);
	if(	companyID ==&quot;TGCE&quot;){	 
		var row = new Packages.java.util.HashMap() ;		
		row.put(&quot;memid&quot;,&quot;MEMT1013909&quot;);
		row.put(&quot;cname&quot;,&quot;鍾承軒&quot;);
		SignTable.add(SignTable.size(), row);			  
	}
	appDataMap.put(&quot;MemberTable_SE&quot;, SignTable);
	aInstance.setAppDataMap(appDataMap);		
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>依不同條件設定會簽的Table List</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001209086968194</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/04/25 09:29:28</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.TGCE.F00001.Set_CheckBox</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001209086968194</string> 
     </void> 
     <void property="name"> 
      <string>Set_CheckBox</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031209086927990</string> 
     </void> 
     <void property="scriptSource"> 
      <string>Function SET_ALL_R(b){
Form.setValue(&quot;INTERNET&quot;,b);
Form.setValue(&quot;VPN&quot;,b);
Form.setValue(&quot;ENG&quot;,b);
Form.setValue(&quot;PRICE&quot;,b);
Form.showMessageDialog(&quot;Clear All special item&quot;);
}

Function SET_ALL_L(b){
Form.setValue(&quot;NTACC&quot;,b);
Form.setValue(&quot;EMAIL&quot;,b);
Form.setValue(&quot;FTP&quot;,b);
Form.setValue(&quot;OA&quot;,b);
Form.setValue(&quot;HR&quot;,b);
Form.setValue(&quot;KPI&quot;,b);
Form.setValue(&quot;GCEMIS&quot;,b);
Form.setValue(&quot;ERP&quot;,b);
Form.setValue(&quot;WINDCHILL&quot;,b);
Form.setValue(&quot;TRUSTVIEW&quot;,b);
Form.showMessageDialog(&quot;Clear All general item&quot;);
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001221465131374</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/09/15 15:52:11</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.QC.addAsignTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001221465131374</string> 
     </void> 
     <void property="name"> 
      <string>addAsignTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011221465024953</string> 
     </void> 
     <void property="scriptSource"> 
      <string>importPackage(java.lang);

//===================================================
//Parameters:companyID=公司代碼;PARAMETER=角色代碼;Sign_MemberTable=暫存表單
function addAsignList(PARAMETER,Sign_MemberTable){ 
// 判斷不同廠別call 不同的funciton		
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	//使用者姓名
	var roleID = MyTask.getRoleID();
	var memDR = cMember.getMemberDR(roleID);
	var sDepName = memDR.getDepartmentName();	//使用者部門名稱
	var sDepID = Server.getDepartment(memDR.getDepartmentID()).getMyID();
	var sRoleName = memDR.getRoleName();	//使用者職務名稱
	var companyID = cMember.getAreaCode(); //使用者公司代碼	
	
//QC角色
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap(); 
    var SignTable = appDataMap.get(Sign_MemberTable);
	var App_DepID = appDataMap.get(&quot;App_DepID&quot;); // 申請者部門代號
	var App_Dep_ID= appDataMap.get(&quot;App_Dep_ID&quot;); // 申請者部門代號 3碼
    SignTable.clear();	
//------------	
	var artid = aInstance.getArtifactID();
		var SQL =    &quot; select VALUE2 memid ,VALUE1 username  from A_PARAMETER_ITEM , A_PARAMETER_DATA &quot;;
		SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 &lt;&gt; &apos;&quot;+ companyID +&quot;&apos; &quot;  ;
//		SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 = &apos;&quot;+ companyID +&quot;&apos; &quot;  ;	97/9/17修改	
    var vector = Server.SQLloadValue(SQL);		
    if ( vector != null ){				
	   if (vector.size()&gt;0){
		  for(var i=0;i&lt;vector.size();i++)  {
			  var ht = vector.get(i);
			  var memid = ht.get(&quot;memid&quot;);			  
			  var cMember = Server.getMemberByID(memid);
			  if(cMember == null){
// 檢核員工是否是有效的,若無效基本上會傳給administrator , 
				memid = &quot;MEMT1005230&quot;  // 先設給005230	
			    var cMember = Server.getMemberByID(memid);
			  }
//			  var jobtitle = member.getJobTile();			  
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  var row = new Packages.java.util.HashMap()		 
			  row.put(&quot;memid&quot;,memid);
			  row.put(&quot;cname&quot;,ht.get(&quot;username&quot;));
//			  row.put(&quot;jobtitle&quot;,jobtitle);
			  SignTable.add(SignTable.size(), row);			  
			 }
		  }//for
		}
	appDataMap.put(Sign_MemberTable, SignTable);
	aInstance.setAppDataMap(appDataMap);	 
//QC角色
}	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>addAsignTable</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001221612491355</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/09/17 08:48:11</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.MIS.MISFORM</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001221612491355</string> 
     </void> 
     <void property="name"> 
      <string>MISFORM</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051221612480089</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
function SENDMAIL(SENDFROM,SENDTO,SUBJECT,CCLIST,MSGTXT,){
	var task =  Form.getParentForm().getCurrentTask();
	var CurrMember = Client.getCurrentMember();
//	var FrontMember= Client.getMember(task.getFrontUser());
	var from = CurrMember.getEmail();     // Sender e-mail
	var to = &quot;dasen_chen@gce.com.tw;&quot;;
	var cc = &quot;dasen_chen@gce.com.tw&quot;;
	var subject = &quot;[小黃]來自 &quot;+ Form.getValue(&quot;SENDFROM&quot;) +&quot; 傳來的消息:&quot;;    // Mail Subject
	var text    = &quot;您好, 這是 MyGCE 線上小黃便利貼，系統替您送來了一個訊息。&quot;;    // Mail Content
	var text = text + &quot;&lt;hr&gt;&quot; + Form.getValue(&quot;SENDMSG&quot;);
	var text = text + &quot;&lt;hr&gt; 請閱讀後儘速回覆訊息給:&quot; + Form.getValue(&quot;SENDFROM&quot;) + &quot;&lt;br&gt;&quot; + arturl;
	var fileList = new java.util.Vector();
	fileList.add(&quot;c:\\test.gif&quot;);	
	Client.sendHTMLMailExt(from,to,cc,subject,text,fileList,task.getID());	
}

//		var arturl = getUrl(2) ;

//------------------------
// 發 mail 開啟連結用的 URL 
// n == 1 //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件 ( ie7 無法直接開 ) 
// n == 2 //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
// n == 3 //email開表單，需密碼
// n == 4 //email開表單，不需密碼
//------------------------
function getUrl(n){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           var aInstance = MyTask.getArtInstance(); 
           var dataMap = aInstance.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=false&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                     //var userName = member.getName();
                     var userName = member.getLoginID();
                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }
           return url;
}			
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001231493866502</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2016/08/24 17:15:59</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.MAN.updateMaterial</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001231493866502</string> 
     </void> 
     <void property="name"> 
      <string>updateMaterial</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001209032361851</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//com.gce.MAN.updateMaterial
// KLM回覆進度用的function
function updateTableStatus(){
	var aInstance = MyTask.getArtInstance(); 
	var dataMap = aInstance.getAppDataMap(); 	
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	   //使用者姓名
	var companyID = cMember.getAreaCode(); //使用者公司代碼
    var vFR_yes = dataMap.get(&quot;FR_yes&quot;);//是否比照
	if(&quot;true&quot;==vFR_yes){
		var vFlag_yes_no = &quot;YES&quot;;
	}else{
		var vFlag_yes_no = &quot;NO&quot;;		
	}
	var vNo_reason = dataMap.get(&quot;no_reason&quot;)//不比照原因
	var vWeekly_status= dataMap.get(&quot;FT_remark&quot;) //每週進度
	var vEcd = dataMap.get(&quot;ECD&quot;);	
	var vEcd = dataMap.get(&quot;Re_Schedual&quot;);
	var vKlm = dataMap.get(&quot;KLM&quot;);           // 負責的人
	var vECD = dataMap.get(&quot;ECD&quot;);
	var vRe_Schedual = dataMap.get(&quot;Re_Schedual&quot;);
	var vRep_sn_a = dataMap.get(&quot;rep_sn&quot;);   // 它廠報告單編號
	var vRep_insid_a = dataMap.get(&quot;rep_insid&quot;);   // 它廠報告單INSID
	var vResult_a = dataMap.get(&quot;result_a&quot;); // 它廠報告單結果
	var vInsid = dataMap.get(&quot;InsID&quot;);       // 申請單編號 -------------------
	var vIns_ID = dataMap.get(&quot;Ins_ID&quot;); // 報告單的InsID	
	var vKLM_insid = dataMap.get(&quot;KLM_insid&quot;); //KLM INSID
// --------- add trim @2016/06/07
	vNo_reason = vNo_reason.trim();
	vRep_sn_a = vRep_sn_a.trim();
	vRep_insid_a = vRep_insid_a.trim();	
	vInsid = vInsid.trim();
	vIns_ID = vIns_ID.trim();
	vKLM_insid = vKLM_insid.trim();  //--------------------------
	var vResult=&quot;&quot;; // 測試結果是否採用;
		if(&quot;true&quot;==dataMap.get(&quot;accetp_flag&quot;)){
		vResult = &quot;OK&quot; ;
		}
// step 1: 檢查是否可以直接update
	if(chkIsExist(vInsid,&quot;null&quot;) &gt; 0 ){
		try{
		var sql = &quot;UPDATE a_material SET &quot;;
		    sql = sql+ &quot;flag_yes_no = &apos;&quot;+vFlag_yes_no+&quot;&apos;,no_reason = &apos;&quot;+vNo_reason+&quot;&apos;,weekly_status= &apos;&quot;+vWeekly_status+&quot;&apos;&quot; ;
		    sql = sql +&quot;,klm = &apos;&quot;+vKlm+&quot;&apos;,ecd = to_date(&apos;&quot;+vECD+&quot;&apos;,&apos;YYYY/MM/DD&apos;),rec_ecd = to_date(&apos;&quot;+vRe_Schedual+&quot;&apos;,&apos;YYYY/MM/DD&apos;)&quot;+&quot;,factory_a= &apos;&quot;+companyID+&quot;&apos;&quot; ;
			sql = sql +&quot;,rep_sn_a = &apos;&quot;+vRep_sn_a+&quot;&apos;,rep_insid_a =&apos;&quot;+vRep_insid_a+&quot;&apos;,result_a = &apos;&quot;+vResult_a+&quot;&apos;,klm_insid=&apos;&quot;+vKLM_insid+&quot;&apos;&quot;;
			sql = sql +&quot; WHERE insid = &apos;&quot;+vInsid+&quot;&apos; and  factory_a = &apos;&quot;+companyID+&quot;&apos;&quot;  ;
		var Result = Server.SQLupdateValue(sql);
		if(false==Result){
			sendAlert(dataMap,&quot;[警告]update 至a_material失敗!&quot;,sql);
			}
		}catch(e){
			sendAlert(dataMap,&quot;[警告] update 至a_material失敗!&quot;,sql);		
		}		
	}
// step 2: 是否已回覆過若有則 update	
	if(chkIsExist(vInsid,companyID) &gt; 0 ){   
		try{
		var sql = &quot;UPDATE a_material SET &quot;;
		    sql = sql + &quot;flag_yes_no = &apos;&quot;+vFlag_yes_no+&quot;&apos;,no_reason = &apos;&quot;+vNo_reason+&quot;&apos;,weekly_status= &apos;&quot;+vWeekly_status+&quot;&apos;&quot; ;
		    sql = sql + &quot;,klm = &apos;&quot;+vKlm+&quot;&apos;,ecd = to_date(&apos;&quot;+vECD+&quot;&apos;,&apos;YYYY/MM/DD&apos;),rec_ecd = to_date(&apos;&quot;+vRe_Schedual+&quot;&apos;,&apos;YYYY/MM/DD&apos;)&quot; ;
			sql = sql + &quot;,rep_sn_a = &apos;&quot;+vRep_sn_a+&quot;&apos;,rep_insid_a =&apos;&quot;+vRep_insid_a+&quot;&apos;,result_a = &apos;&quot;+vResult_a+&quot;&apos;,klm_insid=&apos;&quot;+vKLM_insid+&quot;&apos;&quot;;
			sql = sql + &quot; WHERE a_material.insid = &apos;&quot;+vInsid+&quot;&apos; and factory_a= &apos;&quot;+companyID+&quot;&apos;&quot;;
		var Result = Server.SQLupdateValue(sql);
		if(false==Result){
			sendAlert(dataMap,&quot;[警告]update 至a_material失敗!&quot;,sql);
			}
		}catch(e){
			sendAlert(dataMap,&quot;[警告] update 至a_material失敗!&quot;,sql);		
		}		
	}
//	step 3: 沒有回覆過也沒有可以直接update --&gt; 因己有它廠update了 , 就要新增了
	if(chkIsExist(vInsid,companyID)==0&amp;&amp;chkIsExist(vInsid,&quot;null&quot;)==0&amp;&amp;chkIsExist(vInsid,&quot;&quot;)&gt;0){
		insertTable(vInsid,vFlag_yes_no,vNo_reason,vWeekly_status,vKlm,vECD,vRe_Schedual,vRep_sn_a ,vRep_insid_a,vResult_a,companyID);	
	}
}
// -------- insert
function insertTable(vInsid,vFlag_yes_no,vNo_reason,vWeekly_status,vKlm,vECD,vRe_Schedual,vRep_sn_a ,vRep_insid_a,vResult_a,companyID){
// 以申請單號去讀取己有的資料
    var sql = &quot; select trim(factory) as factory,trim(sn) as sn ,trim(app_dep) as app_dep ,trim(app_id) as app_id ,trim(app_name) as app_name ,trim(subject) as subject ,trim(workstation) as workstation,create_date,trim(benefit) from a_material where insid = &apos;&quot;+ vInsid +&quot;&apos;&quot; ;
	try{
		var vec = Server.SQLloadValue(sql);
		var vFactory = vec.get(0).get(&quot;factory&quot;) ;
		var vSn = vec.get(0).get(&quot;sn&quot;) ;
		var vApp_dep = vec.get(0).get(&quot;app_dep&quot;) ;
		var vApp_id = vec.get(0).get(&quot;app_id&quot;) ;
		var vApp_name = vec.get(0).get(&quot;app_name&quot;) ;		
		var vSubject = vec.get(0).get(&quot;subject&quot;) ;				
		var vWorkstation = vec.get(0).get(&quot;workstation&quot;) ;
		var vCreate_date = vec.get(0).get(&quot;create_date&quot;) ;
		var tmpstt = vCreate_date;
//			tmpstt = tmpstt.substring(0,10);	
//			vCreate_date = tmpstt;
		var vBenefit = vec.get(0).get(&quot;benefit&quot;) ;		
		var sql = &quot; INSERT INTO a_material &quot; ;
			sql = sql+&quot;(factory,sn,app_dep,app_id,app_name,insid,subject,workstation,create_date,benefit,  &quot;;
			sql = sql+&quot; flag_yes_no,no_reason,weekly_status,klm,ecd,rec_ecd,rep_sn_a,rep_insid_a,result_a ,factory_a,ins_dtime)  &quot;;
			sql = sql+&quot; VALUES (&apos;&quot;+vFactory+&quot;&apos;,&apos;&quot;+vSn+&quot;&apos;,&apos;&quot;+vApp_dep+&quot;&apos;,&apos;&quot;+vApp_id+&quot;&apos;,&apos;&quot;+vApp_name+&quot;&apos;,&apos;&quot;+vInsid+&quot;&apos;,&apos;&quot;+vSubject+&quot;&apos;,&apos;&quot;+vWorkstation+&quot;&apos;,&apos;&quot;+vCreate_date+&quot;&apos;,&apos;&quot;+vBenefit+&quot;&apos;&quot;;			
			sql = sql+&quot; ,&apos;&quot;+vFlag_yes_no+&quot;&apos;,&apos;&quot;+vNo_reason+&quot;&apos;,&apos;&quot;+vWeekly_status+&quot;&apos;,&apos;&quot;+vKlm+&quot;&apos;,to_date(&apos;&quot;+vECD+&quot;&apos;,&apos;YYYY/MM/DD&apos;),to_date(&apos;&quot;+vRe_Schedual+&quot;&apos;,&apos;YYYY/MM/DD&apos;),&apos;&quot;+vRep_sn_a +&quot;&apos;,&apos;&quot;+vRep_insid_a+&quot;&apos;,&apos;&quot;+vResult_a+&quot;&apos;,&apos;&quot;+companyID+&quot;&apos;,sysdate)&quot;;
		var Result = Server.SQLinsertValue(sql);
		if(false==Result){
			sendAlert(dataMap,&quot;[警告]新增至a_material失敗!&quot;,sql);
		}
	}catch(e){
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 	
		sendAlert(dataMap,&quot;[警告]新增至a_material失敗!&quot;,sql);		
	}	
	
}
//=原物料報告單結案時新增&amp;upate======================
function updateInsertTable(){
	var aInstance = MyTask.getArtInstance(); 
	var dataMap = aInstance.getAppDataMap(); 
	var Ob_date = new Packages.pase.agenda.MyDate();
	var ls_date = Ob_date.getCurrentDate(&quot;Y/M/D&quot;); // 取得現在時間
	var vFC_1= dataMap.get(&quot;FC_1&quot;);//
	var vFactory = dataMap.get(&quot;Factory&quot;);//
	var vRep_sn=dataMap.get(&quot;Sn&quot;);//
	var vIns_ID = dataMap.get(&quot;Ins_ID&quot;); // 報告單的InsID	
	var vInsid = dataMap.get(&quot;InsID&quot;);   // 申請單編號
	
// -----------------------------------------------------------------	
	var sql = &quot; select * from a_material where insid = &apos;&quot;+ vInsid +&quot;&apos; and Factory =&apos;&quot;+vFactory+&quot;&apos;&quot;   ;
	try{
		var vector = Server.SQLloadValue(sql);
	}catch(e){
		sendAlert(dataMap,&quot;[警告]updateInsertTable失敗&quot;,sql);		
	}
	if(vector.size() ==0 ){   
		insertMaterialByRep();
	}
// -----------------------------------------------------------------		
	var vBenefit=dataMap.get(&quot;rej_reason&quot;); // 報告單結案採用或不採用的原因	
	var vAccetp_flag = dataMap.get(&quot;accetp_flag&quot;); // 是否採用;
	var vFactory_a_1=&quot;&quot;;
	var vFactory_a_2=&quot;&quot;;
	var vFactory_a_3=&quot;&quot;;
	var vResult = &quot;NG&quot; ;
	if(&quot;true&quot;==vAccetp_flag){
		vResult = &quot;OK&quot; ;
		if(&quot;(TGCE)&quot; == vFactory){
			vFactory_a_1=&quot;SGCE&quot;;		
			vFactory_a_2=&quot;CGCE&quot;;	
			vFactory_a_3=&quot;HGCE&quot;;
			}
		if(&quot;(SGCE)&quot; == vFactory){
			vFactory_a_1=&quot;TGCE&quot;;		
			vFactory_a_2=&quot;CGCE&quot;;
			vFactory_a_3=&quot;HGCE&quot;;				
			}
		if(&quot;(CGCE)&quot; == vFactory){
			vFactory_a_1=&quot;TGCE&quot;;		
			vFactory_a_2=&quot;SGCE&quot;;
			vFactory_a_3=&quot;HGCE&quot;;				
			}
		if(&quot;(HGCE)&quot; == vFactory){ // add by wangwei@2010102
			vFactory_a_1=&quot;TGCE&quot;;		
			vFactory_a_2=&quot;SGCE&quot;;
			vFactory_a_3=&quot;CGCE&quot;;				
			}				
		}	
	if(&quot;true&quot;==vFC_1){    // 是自提則 update 原申請單
	    var sql = &quot; select trim(factory) as factory ,trim(sn) as sn ,trim(app_dep) as app_dep,trim(insid) as insid,trim(app_id) as app_id,trim(app_name) as app_name,trim(insid) asinsid ,trim(subject) as subject,trim(workstation) as workstation,create_date from a_material where insid = &apos;&quot;+ vInsid +&quot;&apos;&quot;   ;
		try{
			var vector = Server.SQLloadValue(sql);			
			if (vector.size() &gt; 0){			
				var sql = &quot;UPDATE a_material SET &quot;;
				    sql = sql+ &quot;rep_insid = &apos;&quot;+vIns_ID+&quot;&apos;, rep_sn = &apos;&quot;+vRep_sn+&quot;&apos;,result= &apos;&quot;+vResult+&quot;&apos;,benefit= &apos;&quot;+vBenefit+&quot;&apos;,Factory_a=&apos;&quot;+ vFactory_a_1+&quot;&apos;,result_date=to_date(&apos;&quot;+ls_date+&quot;&apos;,&apos;YYYY/MM/DD&apos;)&quot;;
					sql = sql +&quot; WHERE a_material.insid = &apos;&quot;+vInsid+&quot;&apos;&quot;;
					var Result = Server.SQLupdateValue(sql);
					if(false==Result){
						sendAlert(dataMap,&quot;[警告]update 至a_material失敗!&quot;,sql);
					}
// ==================================================================================若是採用再新新增它廠第1廠 vFactory_a_2
				if(&quot;true&quot;==vAccetp_flag){
					var vFactory = vector.get(0).get(&quot;factory&quot;) ;
					var vSn = vector.get(0).get(&quot;sn&quot;) ;
					var vApp_dep = vector.get(0).get(&quot;app_dep&quot;) ;
					var vApp_id = vector.get(0).get(&quot;app_id&quot;) ;
					var vApp_name = vector.get(0).get(&quot;app_name&quot;) ;
					var vInsid = vector.get(0).get(&quot;insid&quot;) ;
					var vSubject = vector.get(0).get(&quot;subject&quot;) ;
					var vWorkstation = vector.get(0).get(&quot;workstation&quot;) ;
					var vCreate_date = vector.get(0).get(&quot;create_date&quot;) ;
					var sql = &quot; INSERT INTO a_material &quot; ;
						sql = sql+&quot;( factory,sn,app_dep,app_id,app_name,insid,subject,workstation,create_date,&quot;;
						sql = sql+&quot;  rep_insid,rep_sn,result,benefit,Factory_a,result_date,ins_dtime)  &quot;;
						sql = sql+&quot; VALUES ( &quot;;
						sql = sql+  &quot;&apos;&quot;+vFactory+&quot;&apos;,&apos;&quot;+vSn+&quot;&apos;,&apos;&quot;+vApp_dep+&quot;&apos;,&apos;&quot;+vApp_id+&quot;&apos;,&apos;&quot;+vApp_name+&quot;&apos;,&apos;&quot;+vInsid+&quot;&apos;,&apos;&quot;+vSubject+&quot;&apos;,&apos;&quot;+vWorkstation+&quot;&apos;,&apos;&quot;+vCreate_date+&quot;&apos;&quot;;
						sql = sql+ &quot;,&apos;&quot;+vIns_ID+&quot;&apos;,&apos;&quot;+vRep_sn+&quot;&apos;,&apos;&quot;+vResult+&quot;&apos;,&apos;&quot;+vBenefit+&quot;&apos;,&apos;&quot;+vFactory_a_2+&quot;&apos;,to_date(&apos;&quot;+ls_date+&quot;&apos;,&apos;YYYY/MM/DD&apos;),sysdate)&quot;;	
					var Result = Server.SQLinsertValue(sql);
					if(false==Result){
						sendAlert(dataMap,&quot;[警告]新增至a_material失敗!&quot;,sql);
					}
// ==================================================================================若是採用再新增它廠第2廠 vFactory_a_3
					var sql = &quot; INSERT INTO a_material &quot; ;
						sql = sql+&quot;( factory,sn,app_dep,app_id,app_name,insid,subject,workstation,create_date,&quot;;
						sql = sql+&quot;  rep_insid,rep_sn,result,benefit,Factory_a,result_date,ins_dtime)  &quot;;
						sql = sql+&quot; VALUES ( &quot;;
						sql = sql+  &quot;&apos;&quot;+vFactory+&quot;&apos;,&apos;&quot;+vSn+&quot;&apos;,&apos;&quot;+vApp_dep+&quot;&apos;,&apos;&quot;+vApp_id+&quot;&apos;,&apos;&quot;+vApp_name+&quot;&apos;,&apos;&quot;+vInsid+&quot;&apos;,&apos;&quot;+vSubject+&quot;&apos;,&apos;&quot;+vWorkstation+&quot;&apos;,&apos;&quot;+vCreate_date+&quot;&apos;&quot;;
						sql = sql+ &quot;,&apos;&quot;+vIns_ID+&quot;&apos;,&apos;&quot;+vRep_sn+&quot;&apos;,&apos;&quot;+vResult+&quot;&apos;,&apos;&quot;+vBenefit+&quot;&apos;,&apos;&quot;+vFactory_a_3+&quot;&apos;,to_date(&apos;&quot;+ls_date+&quot;&apos;,&apos;YYYY/MM/DD&apos;),sysdate)&quot;;	
					var Result = Server.SQLinsertValue(sql);
					if(false==Result){
						sendAlert(dataMap,&quot;[警告]新增至a_material失敗!&quot;,sql);
					}					
				}				
			}		
		}catch(e){
			sendAlert(dataMap,&quot;[警告] update 至a_material失敗!&quot;,sql);		
		}				
	}
}			
//===它廠報告單結案回寫KLM 表單========
// 以報告單上的申請單號(InsID)取得==&gt;&gt; 申請單 dataMap===&gt;&gt;取得它廠報告單號(ref_InsID)
// ==&gt;&gt; 它廠報告報單 dataMap ==&gt;&gt;申請單號(InsID)
function updateResult(){
	var aInstance = MyTask.getArtInstance(); 
	var dataMap = aInstance.getAppDataMap(); 	
	var vInsID = dataMap.get(&quot;InsID&quot;);  // 報告單上的申請請單
	var vFactory_a = dataMap.get(&quot;Factory&quot;).substring(1,5); // 廠別
	
}
//=====================================================
function sendAlert(dataMap,vMsg,vMsg1){
	var arturl = getUrl(2) ;
	var fromMail= Server.getMember(&quot;Administrator&quot;).getEmail();//系統管理員為寄件者
	var toEMail = &quot;wangwei@gce.com.tw&quot;;
	var totalccMail = &quot;&quot;;
	var title = vMsg;

	var data = &quot; 您好：&quot;+&quot;\n&quot;+&quot;\n&quot;;
	data = data + &quot;這是系統自動發出的一封通知信\n&quot;;
	data = data +&quot;表單內容為：&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; \n&quot;;
	data = data +&quot;SQL 語法:&quot; + vMsg1+&quot;\n&quot;;

   data = data + &quot; 您可以開啟 &quot;+arturl+&quot;，來查看該表單。&quot;+&quot;\n  \n \n   MIS &quot;;
   data = &quot;&lt;pre&gt;&quot;+data+&quot;&lt;/pre&gt;&quot;;
    var vector = new java.util.Vector();
    var taskID = MyTask.getID();  
    Server.sendHTMLMailExt(fromMail,toEMail,totalccMail,title,data,vector,taskID);  
 }

function getUrl(n){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           var aInstance = MyTask.getArtInstance(); 
           var dataMap = aInstance.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                     //var userName = member.getName();
                     var userName = member.getLoginID();
                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }
           return url;
}
 
// 判斷a_material 是否己經有資料 vFactory : 可能是空白,null 或 有值
function chkIsExist(vInsid,vFactory){
	if(&quot;null&quot;==	vFactory){		
		var sql = &quot; select * from a_material where insid = &apos;&quot;+ vInsid +&quot;&apos; and Factory_a is null&quot;   ;
	}else{
		if(&quot;&quot; == vFactory){
			var sql = &quot; select * from a_material where insid = &apos;&quot;+ vInsid +&quot;&apos;&quot;   ;
		}else{
			var sql = &quot; select * from a_material where insid = &apos;&quot;+ vInsid +&quot;&apos; and Factory_a =&apos;&quot;+vFactory+&quot;&apos;&quot;   ;
		}		
	}
	try{
		var vector = Server.SQLloadValue(sql);
		return vector.size() ;

	}catch(e){
		sendAlert(dataMap,&quot;[警告]chkIsExistSQL失敗&quot;,sql);		
	}
}	
//--- update KLM
//select *from a_material  where rep_insid =&apos;Ans000000072481&apos; and factory_a=&apos;CGCE&apos;;
// 申請單update KLM
function updateMaterialApply(vStatus){
	var aInstance = MyTask.getArtInstance(); 
	var dataMap = aInstance.getAppDataMap(); 
    var vRep_insid = dataMap.get(&quot;ref_InsID&quot;);	
	var vFactory = dataMap.get(&quot;Factory&quot;).substring(1,5);
	var vApp_Name = dataMap.get(&quot;App_Name&quot;);	
	var vApp_Tel = dataMap.get(&quot;App_Tel&quot;);	
	try{	
	var sql = &quot;UPDATE a_material SET &quot;;
	    sql = sql + &quot;weekly_status= &apos;&quot;+vStatus+&quot;&apos;,klm=&apos;&quot;+vApp_Name +&quot;&apos;&quot; ;
		sql = sql + &quot; WHERE a_material.rep_insid = &apos;&quot;+vRep_insid+&quot;&apos; and factory_a= &apos;&quot;+vFactory+&quot;&apos;&quot;;
	var Result = Server.SQLupdateValue(sql);
		if(false==Result){
			sendAlert(dataMap,&quot;[警告]update 至a_material失敗!&quot;,sql);
			}
		}catch(e){
			sendAlert(dataMap,&quot;[警告] update 至a_material失敗!&quot;,sql);		
		}		
		if(true==Result){
			sql = &quot;select trim(klm_insid) as klm_insid from a_material &quot;;
			sql = sql + &quot; WHERE a_material.rep_insid = &apos;&quot;+vRep_insid+&quot;&apos; and factory_a= &apos;&quot;+vFactory+&quot;&apos;&quot;;	
			var vector = Server.SQLloadValue(sql);						
			if( vector.size()&gt;0){
				var vKlm_insid = vector.get(0).get(&quot;klm_insid&quot;) ;
				var sqlUpdate = &quot;UPDATE ART00021231121671621_ins SET &quot;;			
				    sqlUpdate = sqlUpdate + &quot;item295 = &apos;&quot;+vStatus+&quot;&apos;,item307= &apos;&quot;+vApp_Name+&quot;&apos;&quot;;
					sqlUpdate = sqlUpdate + &quot; WHERE insid= &apos;&quot;+vKlm_insid+&quot;&apos;&quot;;	
					var Result = Server.SQLupdateValue(sqlUpdate);	
					if(false==Result){
						sendAlert(dataMap,&quot;[警告]update 至a_material失敗!&quot;,sql);
					}			
				}
		}
}
// 報告單 update KLM
function updateMaterialRep(vStatus){
	var aInstance = MyTask.getArtInstance(); 
	var dataMap = aInstance.getAppDataMap();   // 報告單 datamap
	var vFactory = dataMap.get(&quot;Factory&quot;).substring(1,5);
	var vApp_Name = dataMap.get(&quot;App_Name&quot;);	
	var vApp_Tel = dataMap.get(&quot;App_Tel&quot;);	
	var vSn = dataMap.get(&quot;Sn&quot;);	
	var vIns_ID = dataMap.get(&quot;Ins_ID&quot;);	// 報告單INS
    var vInsID = dataMap.get(&quot;InsID&quot;);	  // 報告單上的申請單	
	var vAaccetp_flag = dataMap.get(&quot;accetp_flag&quot;);
                                 	
//ART00041208747409078_ins -&gt;&gt;報告單  
//ART00031208141153140_ins -&gt;&gt;申請單
// 以下SQL 是取得它廠的申請單
	var vSQL = &quot;select item263 as InsID from ART00041208747409078_ins where INSID = (select ITEM214 as ref_InsID from ART00031208141153140_ins where INSID =&apos;&quot;+vInsID+&quot;&apos;)&quot;;
	var vector = Server.SQLloadValue(vSQL);			
			if (vector.size() &gt; 0){		
				var vInsID_a = vector.get(0).get(&quot;InsID&quot;) ;		// 取得它廠的申請單			
// update a_material by  申請單&amp;廠別				
				var sqlUpdate = &quot;UPDATE a_material SET &quot;;
				    sqlUpdate = sqlUpdate + &quot;weekly_status= &apos;&quot;+vStatus+&quot;&apos;,klm=&apos;&quot;+vApp_Name +&quot;&apos;,rep_sn_a=&apos;&quot;+vSn+&quot;&apos;,rep_insid_a=&apos;&quot;+vIns_ID+&quot;&apos;&quot; ;
				    sqlUpdate = sqlUpdate + &quot; WHERE a_material.insid = &apos;&quot;+vInsID_a+&quot;&apos; and factory_a= &apos;&quot;+vFactory+&quot;&apos;&quot;;				
				var Result = Server.SQLupdateValue(sqlUpdate);	
					  if(false==Result){
						  sendAlert(dataMap,&quot;[警告]update 至a_material失敗!&quot;,sqlUpdate);
						}											
// 取KLM INSID
					vSQL = &quot;select trim(klm_insid) as klm_insid from a_material where a_material.insid = &apos;&quot;+vInsID_a+&quot;&apos; and factory_a= &apos;&quot;+vFactory+&quot;&apos;&quot;;				
					vector = Server.SQLloadValue(vSQL);
					if (vector.size() &gt; 0){		
						var vKLM_INSID = vector.get(0).get(&quot;klm_insid&quot;) ;		
						var vIns  = Server.getArtInstance(vKLM_INSID); 	
						var dataMapApply = vIns.getAppDataMap(); 
						dataMapApply.put(&quot;FT_remark&quot;,vStatus);
						dataMapApply.put(&quot;KLM&quot;,vApp_Name);	
						dataMapApply.put(&quot;rep_sn&quot;,vSn);	
						dataMapApply.put(&quot;rep_insid&quot;,vIns_ID);							
						if(&quot;true&quot;==vAaccetp_flag){
							dataMapApply.put(&quot;result_a&quot;,&quot;OK&quot;);
						}else{
							dataMapApply.put(&quot;result_a&quot;,&quot;NG&quot;);							
						}
// update KLM				
//						var sqlUpdate = &quot;UPDATE ART00021231121671621_ins SET &quot;;			
//							sqlUpdate = sqlUpdate + &quot;item295 = &apos;&quot;+vStatus+&quot;&apos;,item307= &apos;&quot;+vApp_Name+&quot;&apos;&quot;;
//							sqlUpdate = sqlUpdate + &quot; WHERE INSID= &apos;&quot;+vKLM_INSID+&quot;&apos;&quot;;	
//						var Result = Server.SQLupdateValue(sqlUpdate);	
//						if(false==Result){
//							sendAlert(dataMap,&quot;[警告]update 至a_material失敗!&quot;,sql);
//						}							
					}	
			}	
}			
//================================================
// For自提的報告單 update material
function updateMaterialRepBySelf(vStatus){
	var aInstance = MyTask.getArtInstance(); 
	var dataMap = aInstance.getAppDataMap();   // 報告單 datamap
	var vApp_Name = dataMap.get(&quot;App_Name&quot;);	
    var vInsID = dataMap.get(&quot;InsID&quot;);	    // 報告單上的申請單	
	var sqlUpdate = &quot;UPDATE a_material SET &quot;;
	    sqlUpdate = sqlUpdate + &quot;rep_sn= &apos;&quot;+vStatus +&quot;&apos;WHERE a_material.insid = &apos;&quot;+vInsID+&quot;&apos;&quot;;				
	var Result = Server.SQLupdateValue(sqlUpdate);	
		  if(false==Result){
			  sendAlert(dataMap,&quot;[警告]update 至a_material失敗!&quot;,sqlUpdate);
			}

}	


// -------------------------	
//ART00041208747409078_ins -&gt;&gt;報告單  
//ART00031208141153140_ins -&gt;&gt;申請單 
function insertMaterialByRep(){
	var aInstance = MyTask.getArtInstance(); 
	var dataMap = aInstance.getAppDataMap(); 
	var vApp_sn = dataMap.get(&quot;app_sn&quot;); //報告單上的申請單號
	var vFC_1= dataMap.get(&quot;FC_1&quot;);//
	var vInsSQL=&quot;&quot; // 先給空白
	var vSQL = &quot;select INSID from ART00031208141153140_ins where ITEM10 =&apos;&quot;+vApp_sn+&quot;&apos;&quot;;
	try{   // add by wangwei@20090830
		var vector = Server.SQLloadValue(vSQL);			
		if (vector.size() &gt; 0){		
			var vInsID_App = vector.get(0).get(&quot;InsID&quot;) ;		// 取得它廠的申請單							
			var vIns  = Server.getArtInstance(vInsID_App); 	
			var dataMapApply = vIns.getAppDataMap(); 				// 申請單dataMAP
			var vFactory = dataMapApply.get(&quot;Factory&quot;);//
			var vSn = dataMapApply.get(&quot;Sn&quot;);//
			var vApp_dep = dataMapApply.get(&quot;App_Dep&quot;);
			var vApp_id = dataMapApply.get(&quot;App_ID&quot;);
			var vApp_name = dataMapApply.get(&quot;App_Name&quot;);
			var vApp_Tel = dataMapApply.get(&quot;App_Tel&quot;); //
				vApp_name = vApp_name+&quot;(&quot;+ vApp_Tel+&quot;)&quot;
			var vInsid = dataMapApply.get(&quot;Ins_ID&quot;);
			var vSubject = dataMapApply.get(&quot;Subject&quot;);
			var vWorkstation = dataMapApply.get(&quot;workstation&quot;);
			var vCreate_date = dataMapApply.get(&quot;Create_Date&quot;);
			var vBenefit = dataMapApply.get(&quot;benefit&quot;);
			var vInsSQL = &quot; INSERT INTO a_material &quot; ;
				vInsSQL = vInsSQL+&quot;( factory,sn,app_dep,app_id,app_name,insid,subject,workstation,create_date,benefit)  &quot;;
				vInsSQL = vInsSQL+&quot; VALUES ( &quot;+&quot;&apos;&quot;+vFactory+&quot;&apos;,&apos;&quot;+vSn+&quot;&apos;,&apos;&quot;+vApp_dep+&quot;&apos;,&apos;&quot;+vApp_id+&quot;&apos;,&apos;&quot;+vApp_name+&quot;&apos;,&apos;&quot;+vInsid+&quot;&apos;,&apos;&quot;+vSubject+&quot;&apos;,&apos;&quot;+vWorkstation+&quot;&apos;,&apos;&quot;+vCreate_date+&quot;&apos;,&apos;&quot;+vBenefit+&quot;&apos;)&quot;;	
				var Result = Server.SQLinsertValue(vInsSQL);
				if(false==Result){
					sendAlert(dataMap,&quot;[警告]新增至a_material失敗!&quot;,vInsSQL);
				}
		}
	}catch(e){
		sendAlert(dataMap,&quot;[警告]call insertMaterialByRep SQL失敗 &quot;,vInsSQL);		
	}		
}	
	
 
</string> 
     </void> 
     <void property="synopsis"> 
      <string>KLM 回覆進度新增或更新a_material</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00001360054366687</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2013/02/05 17:01:38</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.TravelRelated</string> 
     </void> 
     <void property="id"> 
      <string>SCL00001360054366687</string> 
     </void> 
     <void property="name"> 
      <string>TravelRelated</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//轉入resda(view:form_status)
	function updateFormStatus(status){
		var msg = &quot;&quot;;
		var isSucccess;
		var Sn = Form.getValue(&quot;Sn&quot;);
		var App_ID = Form.getValue(&quot;App_ID&quot;);
		var Create_Date = Form.getValue(&quot;Create_Date&quot;);
		var mydate = new Packages.pase.agenda.MyDate();
		var format1 = new Packages.java.text.SimpleDateFormat(&quot;yyyy/MM/dd&quot;);
		var format2 = new Packages.java.text.SimpleDateFormat(&quot;yyyy-MM-dd&quot;);
		var conn = Client.createSessionConnection(&quot;EZFlow&quot;);
		var sql;
		var vec;
		try{
			sql = &quot;select * from resda where resda001 =&apos;A00030&apos; and resda002 =&apos;&quot; + Sn + &quot;&apos;&quot;;
			vec = conn.loadValue(sql);
			if (vec.size() &gt; 0){
				sql =&quot;update resda set resda021=&apos;&quot; + status + &quot;&apos; where resda001=&apos;A00030&apos; and resda002 =&apos;&quot; + Sn + &quot;&apos;&quot;;
				isSucccess = conn.updateValue(sql);
				//更新表單內容
				if(true == isSucccess){
					conn.commit();
				}else if (false==isSucccess){
					msg += &quot;updateFormStatus:資料庫操作異常\n&quot;;
					Client.addDebugLog(&quot;updateFormStatus:資料庫操作異常:&quot; + sql);
					conn.rollback();
				}
			}else{
				sql = &quot; insert into resda(resda001,resda002,resda003,resda004,resda005, &quot;;
                sql +=&quot;   resda006,resda007,resda009,resda010,resda011, &quot;;
				sql +=&quot;   resda012,resda013,resda014,resda015,resda016, &quot;;
				sql +=&quot;  resda017,resda019,resda020,resda021,resda023, &quot;;
				sql +=&quot;  resda024,resda025,resda026,resda027,resda028,resda029)  &quot;;
				sql +=&quot; values(&apos;A00030&apos;,&apos;&quot; + Sn + &quot;&apos;,&apos;0&apos;,&apos;N&apos;,&apos;N&apos;, &quot;;
				sql +=&quot; &apos;N&apos;,&apos;N&apos;,0,0,&apos;N&apos;, &quot;;
				sql +=&quot; &apos;N&apos;,&apos;N&apos;,&apos;N&apos;,&apos;&quot; + Create_Date + &quot;&apos;,&apos;&quot; + App_ID + &quot;&apos;, &quot;;
				sql +=&quot; &apos;&quot; + App_ID  + &quot;&apos;,&quot;;
				if (status.equals(&quot;2&quot;)){
					sql +=&quot;&apos;&quot;+mydate + &quot;&apos;&quot;;
				}else{
					sql +=&quot;null&quot;;
				}				
				sql +=&quot;,3,&quot; + status + &quot;,0, &quot;;
				sql +=&quot; &apos;N&apos;,&apos;N&apos;,&apos;N&apos;,&apos;N&apos;,&apos;N&apos;,&apos;N&apos;); &quot;;
				
				isSucccess = conn.updateValue(sql);
				//更新表單內容
				if(true == isSucccess){
					conn.commit();
				}else if (false==isSucccess){
					msg += &quot;updateFormStatus:資料庫操作異常\n&quot;;
					Client.addDebugLog(&quot;updateFormStatus:資料庫操作異常:&quot; + sql);
					conn.rollback();
				}
			}
		}catch(e){
			Client.addDebugLog(e);
			msg =+&quot;updateFormStatus:資料庫操作異常\n&quot;;
		}finally{
			conn.close();
		}
		
		return msg;
	}
	
	//轉入Ezflow的A00030
	function updateA00030(){
		var msg = &quot;&quot;;
		var isSucccess ;
		var mydate = new Packages.pase.agenda.MyDate();
		var format1 = new Packages.java.text.SimpleDateFormat(&quot;yyyy/MM/dd&quot;);
		var format2 = new Packages.java.text.SimpleDateFormat(&quot;yyyy-MM-dd&quot;);
		var conn = Client.createSessionConnection(&quot;EZFlow&quot;);
		var sql;
		var vec;
		try{
			var Sn = Form.getValue(&quot;Sn&quot;);//單號
			var Factory = Form.getValue(&quot;Factory&quot;);//廠別
			var applyer = tranEmpno(Form.getValue(&quot;App_ID&quot;),Factory);//取得員工6碼工號
			//先刪原始資料
			sql =&quot;delete from a00030 where a00030002=&apos;&quot;+ Sn+&quot;&apos; and applyer=&apos;&quot; + applyer + &quot;&apos;&quot;;
			isSucccess = conn.updateValue(sql);
			if(true == isSucccess){
				conn.commit();
			}else if (false==isSucccess){
				msg += &quot;updateFormStatus:資料庫操作異常\n&quot;;
				Client.addDebugLog(&quot;updateFormStatus:資料庫操作異常:&quot; + sql);
				conn.rollback();
				return msg;
			}				
			var App_Dep_ID =  Form.getValue(&quot;App_Dep_ID&quot;);//部門3碼代號
			var locate ;//國內、外出差
			if (Form.getValue(&quot;rdoIn&quot;).equals(&quot;true&quot;)){
				locate = &quot;1&quot;;
			}else{
				locate = &quot;2&quot;;
			}
			var rangetype;//1.短期支援 2.長期支援
			if (Form.getValue(&quot;rdoShort&quot;).equals(&quot;true&quot;)){
				rangetype = &quot;1&quot;;
			}else{
				rangetype = &quot;2&quot;;
			}			
			var applyer_dept = Form.getValue(&quot;App_Dep&quot;);//部門
			var pidname = Form.getValue(&quot;Gname&quot;);//護照姓名
			var applyer_cname = Form.getValue(&quot;App_Name&quot;) + &quot; / &quot; + Form.getValue(&quot;App_Title&quot;);//姓名		
			var	reason =  Packages.org.apache.commons.lang.StringEscapeUtils.escapeSql(Form.getValue(&quot;txtReason&quot;));//理由
			var	schedule =  Packages.org.apache.commons.lang.StringEscapeUtils.escapeSql(Form.getValue(&quot;txtSchedule&quot;));//行程
			var	startdate = Form.getValue(&quot;txtStart&quot;);//開始時間
			var	enddate = Form.getValue(&quot;txtEnd&quot;);//結束時間
			var outrange = Form.getValue(&quot;days&quot;) + &quot; 天 &quot; + Form.getValue(&quot;hours&quot;) + &quot; 小時&quot;;//出差時間總計
			var Fights_Y = Form.getValue(&quot;Fights_Y&quot;);
			var	hr_comm = &quot;&quot;;//人事備註
			var	hr_confirm = &quot;&quot;;//人事確認欄
			var	protect_year = &quot;&quot;;//旅平險到期日
			var	hr_close = &quot;&quot;;//人事結案FLAG
			var sales_close = &quot;&quot;;//業務結案
			var rec_close = &quot;&quot;;//接機人結案FLAG
			var last_noti = &quot;&quot;;//報表傳送記錄時間
			var noti_sendtime = 0;//報表傳送記錄次數
			var id = 0;//檢核用
			var delmark = &quot;&quot;;//作廢FLAG
			var restaddress = &quot;&quot;;//住宿廠別
			var pickupaddress =&quot;&quot;;//接機廠別
			var proxy_emp;
			if (Form.getValue(&quot;isNeedAgent&quot;).equals(&quot;true&quot;)){
				proxy_emp = &quot;000000,N/A&quot;;
			}else{
				proxy_emp = Form.getValue(&quot;txtAgent&quot;) + &quot;,&quot; + Form.getValue(&quot;txtAgentName&quot;);
			}
			var neednb;
			if (Form.getValue(&quot;needNB_T&quot;).equals(&quot;true&quot;)){
				neednb = &quot;Y&quot;;
			}else{
				neednb = &quot;N&quot;;
			}
			if (Form.getValue(&quot;RB_A_Y&quot;).equals(&quot;true&quot;)){
				needpickup = &quot;Y&quot;;
				pickupaddress = chgFactoryC2E(Form.getValue(&quot;CB_A&quot;));//接機廠別
			}else{
				needpickup = &quot;N&quot;;
			}
			if (Form.getValue(&quot;RB_STAY_Y&quot;).equals(&quot;true&quot;)){
				needstay = &quot;Y&quot;;
				restaddress = chgFactoryC2E(Form.getValue(&quot;CB_STAY&quot;));//住宿廠別
			}else{
				needstay = &quot;N&quot;;
			}
			var scgce1; //是否至蘇州及常熟廠出差
			if (Form.getValue(&quot;cbxIsSC&quot;).equals(&quot;true&quot;)){
				scgce1 = &quot;Y&quot;;
			}else{
				scgce1 = &quot;N&quot;;
			}
			var facname = &quot;&quot;;
			var locates3 = &quot;&quot;;
			//請務必確認所有欄位的使用狀況。
			sql  = &quot;INSERT INTO a00030 VALUES (&quot;;
			sql += &quot;&apos;A00030&apos;,&quot;;  //no (a00030001) 
			sql += &quot;&apos;&quot; + Sn + &quot;&apos;,&quot;;//單號 (a00030002)
			sql += &quot;&apos;&quot; + locate + &quot;&apos;,&quot;;//廠區 (locate)
			sql += &quot;&apos;&quot; + rangetype + &quot;&apos;,&quot;;//支援類型 (rangetype)
			sql += &quot;&apos;&quot; + applyer + &quot;&apos;,&quot;; //出差人工號(applyer)
			sql += &quot;&apos;&quot; + applyer_dept + &quot;&apos;,&quot;;//出差人部門(applyer_dept)
			sql += &quot;&apos;&quot; + pidname + &quot;&apos;,&quot;;//護照姓名(pidname)
			sql += &quot;&apos;&quot; + applyer_cname + &quot;&apos;,&quot;;//出差人姓名(applyer_cname)
			sql += &quot;&apos;&quot; + reason + &quot;&apos;,&quot;;//出差事由(reason)
			sql += &quot;&apos;&quot; + schedule + &quot;&apos;,&quot;;//行程說明(schedule)
			sql += &quot;&apos;&quot; + startdate + &quot;&apos;,&quot;;//起始時間(startdate)
			sql += &quot;&apos;&quot; + enddate + &quot;&apos;,&quot;;//結束時間(enddate)
			sql += &quot;&apos;&quot; + outrange + &quot;&apos;,&quot;;//出差時間(outrange)
			sql += &quot;NULL,&quot;;//人事備註-未使用(hr_comm)
			sql += &quot;NULL,&quot;;//未使用(hr_confirm)
			sql += &quot;NULL,&quot;;//未使用(protect_year)
			sql += &quot;NULL,&quot;;//(hr_close)
			if (Fights_Y.equals(&quot;true&quot;)){//(sales_close )
				sql += &quot;&apos;N&apos;,&quot;;//如果需要預訂則為N
			}else{
				sql += &quot;&apos;Y&apos;,&quot;;//如果不需要預訂則為Y
			}			
			sql += &quot;NULL,&quot;;//(rec_close)
			sql += &quot;&apos;&quot; + last_noti + &quot;&apos;,&quot;;//(last_noti)
			sql += &quot;&apos;&quot; + noti_sendtime + &quot;&apos;,&quot;;//(noti_sendtime)
			sql += &quot;&apos;&apos;,&quot;;//(facbs_sendlog)報表轉寄張京文時間
			sql += &quot;&apos;0&apos;,&quot;;//保表轉寄張京文次數(facbs_sendtime)
			sql += &quot;&apos;&apos;,&quot;;//(askmark)報表轉寄總經理時間
			sql += &quot;&apos;0&apos;,&quot;; //(asktime)報表轉寄總經理次數
			sql += &quot;0,&quot;; //(id)
			sql += &quot;&apos;N&apos;,&quot;;//(delmark)
			sql += &quot;NULL,&quot;;//未使用(a00030900)
			sql += &quot;NULL,&quot;;//未使用(a00030901)
			sql += &quot;NULL,&quot;;//未使用(a00030902)
			sql += &quot;NULL,&quot;;//未使用(a00030903)
			sql += &quot;NULL,&quot;;//未使用(a00030904)
			sql += &quot;NULL,&quot;;//未使用(a00030905)
			sql += &quot;&apos;&quot; + proxy_emp + &quot;&apos;,&quot;; //代理人(proxy_emp)
			sql += &quot;&apos;&quot; + scgce1 + &quot;&apos;,&quot;;//是否至蘇州及常熟廠出差(scgce1)
			sql += &quot;&apos;&quot; + neednb + &quot;&apos;,&quot;;//是否攜帶NB(neednb)
			sql += &quot;&apos;&quot; + needpickup + &quot;&apos;,&quot;;//是否接機(needpickup)
			sql += &quot;&apos;&quot; + needstay + &quot;&apos;,&quot;;//是否住宿(needstay)
			sql += &quot;NULL,&quot;; //出差路線(未使用)(facname)
			sql += &quot;&apos;&quot; + restaddress + &quot;&apos;,&quot;; //住宿廠別(restaddress)
			sql += &quot;&apos;&quot; + pickupaddress + &quot;&apos;,&quot;; //接機廠別(pickupaddress)
			sql += &quot;NULL); &quot;;//初次派駐(locates3)
			isSucccess = conn.updateValue(sql);// 新增
	
			//更新表單內容
			if(true==isSucccess){
				conn.commit();
				msg =  &quot;&quot;;
			}else if (false==isSucccess){
				Client.addDebugLog(&quot;[出差單轉檔失敗]:&quot; + sql);
				conn.rollback();
				msg = &quot;出差單-A00030轉入失敗&quot;;
			}
		}catch(e){
			Client.addDebugLog(e);
		}finally{
			conn.close();
		}
		return msg;
	}
	
	//轉換為11碼memid
	function tranEmpno(Empno,Factory){	
		var Empno_2;
		if (Factory.equals(&quot;(SGCE)&quot;)){
			Empno_2 = &quot;S&quot; + Empno.substring(1,6);
		}else if (Factory.equals(&quot;(CGCE)&quot;)){
			Empno_2 = &quot;C&quot; + Empno.substring(1,6);	
		}else if (Factory.equals(&quot;(HGCE)&quot;)){
			Empno_2 = &quot;H&quot; + Empno.substring(1,6);
		}else{
			Empno_2 = Empno;
		}
		return Empno_2;
	}
	//廠別  中文 轉 英文
	function chgFactoryC2E(name){
		if (name.equals(&quot;台灣廠&quot;)){
			return &quot;TGCE&quot;;
		}else if (name.equals(&quot;蘇州廠&quot;)){
			return &quot;SGCE&quot;;
		}else if (name.equals(&quot;常熟一廠&quot;)){
			return &quot;CGCE&quot;;
		}else if (name.equals(&quot;常熟二廠&quot;)){
			return &quot;HGCE&quot;;
		}
	}
	
	//更新舊系統Ezflow
	function updateToEzflow(process_name,Cancel,processCode){
		var Reject = Form.getValue(&quot;Reject&quot;);
		var msg = &quot;&quot;;
		if (Reject.equals(&quot;true&quot;)){
			msg += updateFormStatus(&quot;3&quot;);//不同意
		}else{
			if (Cancel.equals(&quot;true&quot;)){
				msg += updateFormStatus(&quot;4&quot;);//作廢
			}else{
				if (process_name.equals(&quot;申請人填單&quot;)){	
					msg += updateFormStatus(&quot;1&quot;);//簽核中
					//整個流程只要新增一次就好，其他的更新from_status即可
					msg += updateA00030();
				}else if (process_name.equals(&quot;人事會簽&quot;)){
					msg += updateFormStatus(&quot;1&quot;);//簽核中
				}else if (process_name.equals(&quot;代理人簽核&quot;)){
					msg += updateFormStatus(&quot;1&quot;);//簽核中
				}else if (process_name.equals(&quot;主管審核&quot;)){
					if (processCode.equals(&quot;end&quot;)){
						msg += updateFormStatus(&quot;2&quot;);//2同意
					}else{
						msg += updateFormStatus(&quot;1&quot;);//1簽核中
					}
				}
			}
		}
		return msg ;
	}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>出差申請單_Client端相關程式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011095842959300</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/09/22 16:49:19</string> 
     </void> 
     <void property="fullName"> 
      <string>com.flowring.orgClient</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011095842959300</string> 
     </void> 
     <void property="name"> 
      <string>orgClient</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011181776157390</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//script library 
//com.flowring.orgClient
//
//-----------------------------------------------------------------------------
//
//Client端專用
//取得此Role上方所有主管,若以人員當參數時只能取得mainRole,
//但實際上可能以各種身份啟動流程,所以以Role來取得簽核人員較佳
//此method不取出company的manager,因為大多數情況下是不須簽至董事長的
//若輸入參數的roleID就是managerID則再向上取一層

/*
example
	var roleID = Form.getCurrentTask().getRoleID();
	var vecManagerIDs = getManagerMemIDs(roleID);
*/

function getManagerMemIDs(roleID) {
	var vec = new Packages.java.util.Vector();
	//因為是取得manager,所以不含自己,先取上一層再丟入
	var currentRole = Client.getRole(roleID);
	var parentID = currentRole.getParentID();
	//parentID有可能為部門或職務,若是部門時要檢查是否本身這個role為此部門主管,若是則再向上找
	if (parentID.startsWith(&quot;DEP&quot;)) {
		parentDep = Client.getDepartment(parentID);
		var managerID = parentDep.getManagerID();
		if (managerID.equals(roleID)) {
			//此role即為部門的主管,再向上找一層
			parentID = parentDep.getParentID();
		}
	}
	managerTrace(parentID, vec);
	return vec;
}

//   1. Get the org tree trace in terms manager, input is UID
//   2. return is Vector v,  v[0] is lowest-level manager, v[1] is 2nd-level manager, etc.
//DRID : Department or Role ID, &quot;DEPXXX&quot; or &quot;ROLXXX&quot;
//若主管職務有多人時取出第一位
//可取至company主管
//若有設職務,但職務內無人時則略過此層級
function managerTrace(DRID, vec) {
	var role, dep;
	if (DRID.startsWith(&quot;ROL&quot;)) {
		role = Client.getRole(DRID);
		var vecMemID = role.getMemberList();
		if (vecMemID.size() &gt; 0) {
			vec.add(vecMemID.get(0));
		}
		managerTrace(role.getParentID(), vec);
	} else if (DRID.startsWith(&quot;DEP&quot;)) {
		dep = Client.getDepartment(DRID);
		var managerID = dep.getManagerID();
		//managerID可能是&quot;&quot;(上層主管,繼續往上找), &quot;MEMXXX&quot; 或 &quot;ROLXXX&quot;
		//若是設上層主管,則取回的memID是空字串,略過
		if (managerID.startsWith(&quot;ROL&quot;)) {
			role = Client.getRole(managerID);
			var vecMemID = role.getMemberList();
			if (vecMemID.size() &gt; 0) {
				vec.add(vecMemID.get(0));
			}
		} else if (managerID.startsWith(&quot;MEM&quot;)) {
			vec.add(managerID);
		}
		managerTrace(dep.getParentID(), vec);
	} else if (DRID.equals(&quot;company&quot;)) {
		//到頂了
		var company = Client.getCompany();
		var roleID = company.getManagerID();
		if (roleID.startsWith(&quot;ROL&quot;)) {
			role = Client.getRole(roleID);
			var vecMemID = role.getMemberList();
			if (vecMemID.size() &gt; 0) {
				vec.add(vecMemID.get(0));
			}
		}
	}
	return;
}
//
//-----------------------------------------------------------------------------
//
//透過資料庫取得memName的memID, 若不只一筆時則只取出存在於DRID內的那筆
//可以防止同姓名情況
function getMemberIDInDep(memName, DRName) {
	var DRList;
	DRList = Client.getAllDepartmentByName(DRName); //vec of Department, 有可能同名部門
	if (DRList == null || DRList.size() == 0) {
		//若部門不存在改找職務
		DRList = Client.getAllRoleByName(DRName); //vec of Role, 有可能同名職務
	}
	var memberIDList = new java.util.Vector();
	for(var i=0;i&lt;DRList.size();i++) {
		var DRObj =DRList.get(i);
		var DRID = DRObj.getID();
		var memList = Client.getSubMemberIDOfDR(DRID,true);//recursive to sublevel
		memberIDList.addAll(memList);
	}
	for (var i = 0; i &lt; memberIDList.size(); i++) {
		var name = Client.getMember(memberIDList.get(i)).getName();
		if (memName.equals(name)) {
			return memberIDList.get(i);
		}
	}
	//不存在時
	return &quot;&quot;;
}</string> 
     </void> 
     <void property="synopsis"> 
      <string>Agentflow Client org related utility</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011105070029907</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.ApportionDep</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011105070029907</string> 
     </void> 
     <void property="name"> 
      <string>ApportionDep</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>	//依所選取的項目將對應的部門加入分攤部門的 Table 裡
	//傳入快速分攤的類別
	function loadSharedDep(index){
		if(Form.getValue(&quot;txtItemNo&quot;).equals(&quot;&quot;)){
			Form.showMessageDialog(&quot;請先點選欲分攤之費用項目!&quot;);
		}else{
			var tableSharedDep = Form.getComponent(&quot;tableSharedDep&quot;);
			for(var i = 0; i &lt; 5; i++){
				var rowNum = tableSharedDep.newRow() - 1;
				tableSharedDep.setValueAt(new java.lang.Integer(rowNum + 1), rowNum, 0);
				tableSharedDep.setValueAt(&quot;XXX&quot;, rowNum, 1);
				tableSharedDep.setValueAt(&quot;資訊部&quot;, rowNum, 2);
				tableSharedDep.setValueAt(new java.lang.Float(&quot;0&quot;), rowNum, 3);
			}
		}
	}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>依所選取的項目將對應的部門加入分攤部門的 Table 裡</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011110349333406</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/03/09 14:22:13</string> 
     </void> 
     <void property="fullName"> 
      <string>com.flowring.crm</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011110349333406</string> 
     </void> 
     <void property="name"> 
      <string>crm</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011181776157390</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

	 	 
function setVectorToComboBox(comboBoxName,valueList,defaultValue,isFirstEmpty){

		var comboBox = Form.getComponent(comboBoxName);
		comboBox.removeAllItems();

		if(isFirstEmpty)
			comboBox.addItem(&quot;&quot;);

		for(var i=0;i&lt;valueList.size();i++){
				var Result = valueList.get(i)
				comboBox.addItem(Result);
		}
		if( defaultValue != null ){
				comboBox.setSelectedItem(defaultValue);
				var selectItem = comboBox.getSelectedItem();
				//HTML表單要多加此行,From.getValue才拿的到預設值
				Form.setValue(comboBoxName,defaultValue);
		}
}


function setSQLToComboBox(comboBoxName,sql,defaultValue){
	var valueList = new java.util.Vector();
	try{
		var comList = Client.SQLloadValue(sql);
		var keyValue = &quot;&quot;;
		if(comList.size()&gt;0){
			var rt = comList.get(0);
			var it = rt.keySet().iterator();
			if(it.hasNext()){
			   keyValue = it.next();
			}
		}
		if(!keyValue.equals(&quot;&quot;)){
	    	for(var i=0;i&lt;comList.size();i++){
		      var rt =comList.get(i);	
	    	  var value = rt.get(keyValue);
	    	  valueList.add(value);
    		}
		}
	}catch(e){
		Client.addErrLog(&quot;setSQLToComboBox error&quot;+e);
	}
	setVectorToComboBox(comboBoxName,valueList,defaultValue,false);
}


	//for server 
	function setTableData(){
		var artIns = MyTask.getArtInstance();
		var formMap = artIns.getAppDataMap();
		var rowVecotr = formMap.get(&quot;managerInfo&quot;);
		var rowCount = rowVecotr.size();
		var userName = formMap.get(&quot;managerName&quot;);
		var userDep = formMap.get(&quot;managerDep&quot;);
		var note = formMap.get(&quot;managerNote&quot;);
		var nextState = formMap.get(&quot;nextState&quot;);
		var formatter = new java.text.SimpleDateFormat (&quot;yyyy/MM/dd HH:mm&quot;);
		var nowDate = java.util.Calendar.getInstance().getTime();
		var nowDateString = formatter.format(nowDate);
		var rowMap = new java.util.HashMap();
		rowMap.put(&quot;ITEM1&quot;,userDep);
		rowMap.put(&quot;ITEM2&quot;,userName);
		rowMap.put(&quot;ITEM3&quot;,nowDateString);
		rowMap.put(&quot;ITEM4&quot;,nextState);
		rowMap.put(&quot;ITEM5&quot;,note);

		rowVecotr.add(rowMap);
//		rowVecotr.add(rowCount, rowMap);
//		artIns.setAppValue(&quot;managerInfo&quot;, rowVecotr);
	}

	function initUserData(companyName){
		var sql = &quot;SELECT CRM_MEM.* FROM CRM_MEM INNER JOIN CRM_company ON CRM_MEM.companyID = CRM_company.companyID WHERE (CRM_company.companyName = &apos;&quot;+companyName+&quot;&apos;)&quot;;
		var rtVector = Client.SQLloadValue(sql);
		var userList = new java.util.Vector();
		var userName = &quot;&quot;;
		var userTEL = &quot;&quot;;
		var userEmail = &quot;&quot;;
		for(var i=0;i&lt;rtVector.size();i++){
			var rt = rtVector.get(i);
			userList.add(rt.get(&quot;userName&quot;));
			if(i== 0){
				userName = rt.get(&quot;userName&quot;);
				userTEL = rt.get(&quot;tel&quot;);
				userEmail = rt.get(&quot;email&quot;);
			}
		}	
	
		setVectorToComboBox(&quot;userName&quot;,userList,null,false);
//		Form.setValue(&quot;tel&quot;,userTEL);
//		Form.setValue(&quot;email&quot;,userEmail);
	}

	function loadFlowOption(processName){

		var valueList = new java.util.Vector();
		var defaultOption = &quot;&quot;;

		if(&quot;填單&quot;.equals(processName)){
			valueList.add(&quot;填寫完畢&quot;);
			defaultOption  = &quot;填寫完畢&quot;;
		}else if(&quot;客服處理&quot;.equals(processName)){
			valueList.add(&quot;問題確認&quot;);
			valueList.add(&quot;客服直接回覆&quot;);
		}else if(&quot;問題確認&quot;.equals(processName)){
			valueList.add(&quot;指派負責人處理&quot;);
			valueList.add(&quot;退回客服&quot;);
			valueList.add(&quot;直接結案&quot;);
		}else if(&quot;負責人員處理&quot;.equals(processName)){
			valueList.add(&quot;改派人員&quot;);
			valueList.add(&quot;處理完畢&quot;);
		}else if(&quot;主管確認&quot;.equals(processName)){
			valueList.add(&quot;主管同意&quot;);
			valueList.add(&quot;主管退回&quot;);
		}else if(&quot;填單人確認&quot;.equals(processName)){
			valueList.add(&quot;確認完畢&quot;);
			valueList.add(&quot;結案再發&quot;);
		}

		setVectorToComboBox(&quot;nextState&quot;,valueList,defaultOption,true); 
	}

	function setUserDataByNode(processName){
		var MyTask = Form.getCurrentTask();	
		if(&quot;填單&quot;.equals(processName)){
			setUserData(MyTask,processName);
		}else{
			setUserData(MyTask,processName);
		}
	}

	//init member into questionHandler combo box
	function initQuestionHandler(processName){
		if(&quot;客服處理&quot;.equals(processName)){
			var prjRoleID = &quot;ROL00041096873157067&quot;;
			var prjRole = Client.getProjectRole(prjRoleID);
			var memList = prjRole.getMemberList();
			var memNameList = new java.util.Vector();
			for(var i=0;i&lt;memList.size();i++){
				var memID = memList.get(i);
				var mr = Client.getMemberByID(memID);
				if(mr != null)
					memNameList.add(mr.getName());
			}
			setVectorToComboBox(&quot;questionHandler&quot;,memNameList,&quot;&quot;,true);
		}
	}

   function setUserData(MyTask,processName){

		var mr = Client.getCurrentMember();
		var userName = mr.getName();
		var userDep = &quot;&quot;;
		var depID = MyTask.getDepartmentID();	
		if(depID.startsWith(&quot;DEP&quot;)){
			var dep = Client.getDepartment(depID);
			if(dep != null)
				userDep = dep.getName();
		}else if(depID.startsWith(&quot;PRJ&quot;)){
			//get MainRole 
			var roleList = mr.getRoleList();
			if(roleList.size()&gt;0){
			   var mdr  = roleList.get(0);
			   userDep = mdr.getDepartmentName();
			}
		}
		Form.setValue(&quot;managerDep&quot;,userDep);
		Form.setValue(&quot;managerName&quot;,userName);
		Form.setValue(&quot;processState&quot;,processName);
   }


function initCompanyList(defaultValue){
	var sql = &quot;select companyName from CRM_company order by companyName&quot;;
	setSQLToComboBox(&quot;companyName&quot;,sql,null);
}


//load product from DB
	function loadProduct(){
		var sql = &quot;SELECT productName FROM CRM_Product&quot;;
		setSQLToComboBox(&quot;product&quot;,sql,&quot;Agentflow&quot;);
	}

//load product Ver From DB
	function loadProductVer(){
		var productName = Form.getValue(&quot;product&quot;);
		var sql = &quot;SELECT CRM_Product_ver.productVerName FROM CRM_Product_ver INNER JOIN CRM_Product ON CRM_Product_ver.productID = CRM_Product.productID WHERE (CRM_Product.productName = &apos;&quot;+productName+&quot;&apos;)&quot;;
		setSQLToComboBox(&quot;ver&quot;,sql,null);
	}
	//runtime set Client Form Component  disalbe or not ~
function setCompDisabled(compName , isDisabled){
	try{
		var compObject = Form.getComponent(compName);
		if(compObject != null)
			compObject.setEnabled(!isDisabled);
	}catch(e){
		Client.addErrLog(&quot;setCompDisabled error&quot;+compName+e);
	}
}</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011132400920246</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/11/19 19:48:40</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.SystemFunction.ProcessInfoFunction</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011132400920246</string> 
     </void> 
     <void property="name"> 
      <string>ProcessInfoFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//取得當關出關卡的所有狀態
function getCurrentOutProcessList(){
	
	var OutProcessList = new java.util.Vector();
	if(OutProcessList == null) 
		return OutProcessList;

	var CurrentProcess = Client.getDBProcess(Form.getCurrentTask().getProcessID());
    OutProcessList = CurrentProcess.getOutProcessList();
	
	return OutProcessList;
}
//傳入關卡物件,取出該關卡底下的所有所有關卡物件 Vector
function getDBProcessListOfRootDBProcess(RootDBProcess){
	var DBProcessList = new java.util.Vector();
	if(RootDBProcess == null) 
		return DBProcessList;

	//先取該主流程的關卡
	var MainDBProcessList = RootDBProcess.getSubProcessList();
	var newMainDBProcessList = orderDBProcessList(MainDBProcessList);
	
	for(var i = 0; i &lt; newMainDBProcessList.size(); i++){
		var DBProcess = newMainDBProcessList.get(i);
		DBProcessList.add(DBProcess);

		//再取該子流程的關卡
		java.lang.System.out.println(&quot;DBProcess Name : &quot; +DBProcess.getName());
		java.lang.System.out.println(&quot;DBProcess Name order : &quot; +DBProcess.getSiblingOrder());
		var subDBProcessList = getDBProcessListOfRootDBProcess(DBProcess);
		DBProcessList.addAll(subDBProcessList);
	}
	return DBProcessList;
}
//關卡排序
function orderDBProcessList(RootDBProcess){
	var tempDBProcessList = new java.util.Vector();
	tempDBProcessList.setSize(RootDBProcess.size());
	if (RootDBProcess == null)
		return tempDBProcessList;
	
	for 	(var i = 0; i &lt; RootDBProcess.size(); i++){
		if (tempDBProcessList.get(0) == null &amp;&amp; RootDBProcess.get(i).getSiblingOrder()==0) {
			tempDBProcessList.setElementAt(RootDBProcess.get(i), RootDBProcess.get(i).getSiblingOrder()); 
		} else if (tempDBProcessList.get(0) != null &amp;&amp; RootDBProcess.get(i).getSiblingOrder()==0){
			tempDBProcessList.setElementAt(RootDBProcess.get(i), i);
		} else {
			tempDBProcessList.setElementAt(RootDBProcess.get(i), RootDBProcess.get(i).getSiblingOrder());
		}
		
	}
	
	return tempDBProcessList;
}
//過濾不要的關卡(利用關卡名稱集合)
function getFilterDBProcessListByDBProcessList(AllDBProcessList,fiterDBProcessList){
	var tempDBProcessList = new java.util.Vector();
	var filteredDBProcessList = new java.util.Vector();
	
	if (AllDBProcessList == null)
		return filteredDBProcessList;
	
	for 	(var i = 0; i &lt; AllDBProcessList.size(); i++){
		tempDBProcessList.add(AllDBProcessList.get(i).getName());		
	}
		
	for 	(var i = 0; i &lt; AllDBProcessList.size(); i++){
		if (fiterDBProcessList.indexOf(tempDBProcessList.get(i))==-1)
			filteredDBProcessList.add(AllDBProcessList.get(i));
	}
		
	return filteredDBProcessList;
}
//過濾不要的關卡(利用關卡關鍵字)
function getFilterDBProcessListByKeyWord(AllDBProcessList,fiterDBProcessKeyWordList){
	var tempDBProcessList = new java.util.Vector();
	var filteredDBProcessList = new java.util.Vector();
	var filterflag =false;
	if (AllDBProcessList == null)
		return filteredDBProcessList;
	
	for 	(var i = 0; i &lt; AllDBProcessList.size(); i++){
		aDBProcess = AllDBProcessList.get(i);
		for (var j=0;j &lt; fiterDBProcessKeyWordList.length;j++){
			if (aDBProcess.getName().indexOf(fiterDBProcessKeyWordList[j])==-1){
				filterflag=false;
			} else {
				filterflag=true;
				break;
			}	
		}
		if (!filterflag)
			filteredDBProcessList.add(aDBProcess);
	
	}
	
	return filteredDBProcessList;
}
//預測未簽核關卡
function getOpinionDBProcessList(OpinionDBProcessList){
	
	var removeIndex=0;
	
	for(var i=0;i&lt;OpinionDBProcessList.size();i++){
		var CDBProcess = OpinionDBProcessList.get(i);
			
		if (CDBProcess.getName().equals(processName)){
			removeIndex = i
			break;
		}	
	}
		
	java.lang.System.out.println(&quot;removeIndex : &quot; +removeIndex);
		
	if (removeIndex==0){
		OpinionDBProcessList.remove(0);
	} else {
		for(var i=0;i&lt;removeIndex+1;i++){	
			OpinionDBProcessList.remove(0);
		}
	}
	return OpinionDBProcessList;
}	
//預測未簽核關卡(需指定關卡名稱)
function getOpinionDBProcessListWithProcessName(OpinionDBProcessList,processName){
	
	var removeIndex=0;
	
	for(var i=0;i&lt;OpinionDBProcessList.size();i++){
		var CDBProcess = OpinionDBProcessList.get(i);
			
		if (CDBProcess.getName().equals(processName)){
			removeIndex = i
			break;
		}	
	}
		
	java.lang.System.out.println(&quot;removeIndex : &quot; +removeIndex);
		
	if (removeIndex==0){
		OpinionDBProcessList.remove(0);
	} else {
		for(var i=0;i&lt;removeIndex+1;i++){	
			OpinionDBProcessList.remove(0);
		}
	}
	return OpinionDBProcessList;
}	
//查詢目前關卡有哪些離開狀態
//傳回字串陣列    [離開狀態, 前往關卡]
function queryExitStatus(prjID,txtNextProcess_NO,txtNextStatus_NO,txtNextProcess_YES,txtNextStatus_YES){
	//清空關卡狀態
	Form.setValue(txtNextProcess_NO.toString(),&quot;&quot;);
	Form.setValue(txtNextStatus_NO.toString(),&quot;&quot;);
	Form.setValue(txtNextProcess_YES.toString(),&quot;&quot;);
	Form.setValue(txtNextStatus_YES.toString(),&quot;&quot;);
	
	//getOutProcessList	
	var OutProcessList = getCurrentOutProcessList();
	var AllRootDBProcessList = Client.getRootDBProcessOfProject(prjID);
	
	java.lang.System.out.println(&quot;AllRootDBProcessList :&quot; + AllRootDBProcessList.toString()); 
	
	for (var i = 0;i &lt; OutProcessList.size();i++){
		var aOutProcess = OutProcessList.get(i);
		
		java.lang.System.out.println(&quot;NextStatus :&quot; + aOutProcess.getLabel()); 
		java.lang.System.out.println(&quot;ToProcessID :&quot; + aOutProcess.getToProcessID()); 
		
		if(aOutProcess.getLabel().indexOf(&quot;重新&quot;) !=-1 || 
		  aOutProcess.getLabel().indexOf(&quot;駁回&quot;) !=-1 || 
		  aOutProcess.getLabel().indexOf(&quot;錯誤&quot;) !=-1 ||
		  aOutProcess.getLabel().indexOf(&quot;作廢&quot;) !=-1){
			if(aOutProcess.getToProcessID().indexOf(&quot;End&quot;) == -1)
				Form.setValue(txtNextProcess_NO.toString(),Client.getDBProcess(aOutProcess.getToProcessID()).getName()); 
			else {
				
				for 	(var j = 0; j &lt; AllRootDBProcessList.size(); j++){
					if (!AllRootDBProcessList.get(j).equals(Client.getDBProcess(aOutProcess.getToProcessID().substring(aOutProcess.getToProcessID().indexOf(&quot;PRO&quot;))))){
						Form.setValue(txtNextProcess_NO.toString(),Client.getDBProcess(aOutProcess.getToProcessID().substring(aOutProcess.getToProcessID().indexOf(&quot;PRO&quot;))).getName());
					}	
				}
				
			}
			java.lang.System.out.println(&quot;1. NextProcess :&quot; + Client.getDBProcess(aOutProcess.getToProcessID().substring(aOutProcess.getToProcessID().indexOf(&quot;PRO&quot;))).getName()); 
			
			Form.setValue(txtNextStatus_NO.toString(),aOutProcess.getLabel());
		}else{
			
			if(aOutProcess.getToProcessID().indexOf(&quot;End&quot;) == -1)
				Form.setValue(txtNextProcess_YES.toString(),Client.getDBProcess(aOutProcess.getToProcessID()).getName()); 
			else {
				for 	(var j = 0; j &lt; AllRootDBProcessList.size(); j++){
					if (!AllRootDBProcessList.get(j).equals(Client.getDBProcess(aOutProcess.getToProcessID().substring(aOutProcess.getToProcessID().indexOf(&quot;PRO&quot;))))){
						Form.setValue(txtNextStatus_YES.toString(),Client.getDBProcess(aOutProcess.getToProcessID().substring(aOutProcess.getToProcessID().indexOf(&quot;PRO&quot;))).getName());
					}	
				}
			}
			
			java.lang.System.out.println(&quot;2. NextProcess :&quot; + Client.getDBProcess(aOutProcess.getToProcessID().substring(aOutProcess.getToProcessID().indexOf(&quot;PRO&quot;))).getName()); 
			
			Form.setValue(txtNextStatus_YES.toString(),aOutProcess.getLabel());
		}	
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>取得關卡的相關資訊</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011155562447984</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/08/14 21:34:07</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Server.TotalNote</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011155562447984</string> 
     </void> 
     <void property="name"> 
      <string>TotalNote</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021156610951562</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
function setTotalNote(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		//Set 流程控制
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
		dataMap.put(&quot;From_User_Role_ID&quot;, MyTask.getRoleID());
		
		//Set 簽核意見
		//		var mbrName = Server.getMemberByID(MyTask.getMemberID()).getName();
		var mbrName = Server.getMemberByID(MyTask.getRealExecutor()).getName();		
		var rolName = Server.getRole(MyTask.getRoleID()).getName();
		var totalNote = dataMap.get(&quot;Total_Note&quot;);
		var note = dataMap.get(&quot;Note&quot;);
		var yesno = &quot;駁回&quot;;
		var yes = dataMap.get(&quot;Agree&quot;);
		if(yes.equals(&quot;true&quot;)){
		     yesno = &quot;同意&quot;;
		}
		java.lang.System.out.println(&quot;yesno=&quot;+yesno);
		if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
			totalNote = totalNote + &quot;[&quot; + mbrName + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;),&quot; + rolName + &quot;,&quot; + getFormatedCurrentTime() + &quot;]  &quot;  + yesno +&quot; &quot;+ note +&quot;\n&quot;;
		}else{
			totalNote = totalNote + &quot;[&quot; + mbrName + &quot;,&quot; + rolName + &quot;,&quot; + getFormatedCurrentTime() + &quot;]  &quot;  + yesno +&quot; &quot;+note +&quot;\n&quot;;    
		}
		
		dataMap.put(&quot;Total_Note&quot;,totalNote);
		dataMap.put(&quot;Agree&quot;,&quot;true&quot;);
		dataMap.put(&quot;Reject&quot;,&quot;false&quot;);
		dataMap.put(&quot;Note&quot;,&quot;&quot;);
}

    function getFormatedCurrentTime(){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
        return simpledateformat.format(date);
    }

function setVerifyName(){
		//設定主管簽核姓名
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		dataMap.put(&quot;Verify_ID&quot;,Server.getMember(MyTask.getRealExecutor()).getMyID() );		
		dataMap.put(&quot;Verify_Name&quot;,Server.getMember(MyTask.getRealExecutor()).getName() );
		dataMap.put(&quot;Agree&quot;,&quot;true&quot;);
}

//DCC 關卡用
function setDCCTotalNote(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		//Set 流程控制
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
		dataMap.put(&quot;From_User_Role_ID&quot;, MyTask.getRoleID());
		
		//Set 簽核意見
		//		var mbrName = Server.getMemberByID(MyTask.getMemberID()).getName();
		var mbrName = Server.getMemberByID(MyTask.getRealExecutor()).getName();		
		var rolName = Server.getRole(MyTask.getRoleID()).getName();
		var totalNote = dataMap.get(&quot;Total_Note&quot;);
		var note = dataMap.get(&quot;Note&quot;);
		var yesno = &quot;駁回&quot;;
		var yes = dataMap.get(&quot;Agree&quot;);
		if(yes.equals(&quot;true&quot;)){
		     yesno = &quot;同意&quot;;
		}
		java.lang.System.out.println(&quot;yesno=&quot;+yesno);
		if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
			totalNote = totalNote + &quot;[&quot; + mbrName + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;),&quot; + rolName +
			&quot;,&quot; + getFormatedCurrentTime() + &quot;]  &quot;  + yesno + &quot; &quot;+ dataMap.get(&quot;Next_Process&quot;) +&quot; &quot;+ note +&quot;\n&quot;;
		}else{
			totalNote = totalNote + &quot;[&quot; + mbrName + &quot;,&quot; + rolName + &quot;,&quot; + getFormatedCurrentTime() + &quot;]  &quot;  + yesno +&quot; &quot;+note +&quot;\n&quot;;    
		}
		
		dataMap.put(&quot;Total_Note&quot;,totalNote);
		dataMap.put(&quot;Agree&quot;,&quot;true&quot;);
		dataMap.put(&quot;Reject&quot;,&quot;false&quot;);
		dataMap.put(&quot;Note&quot;,&quot;&quot;);
}

function setTaskRole(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		if(&quot;&quot; != dataMap.get(&quot;Next_Member_Role&quot;)){
			MyTask.setRoleID(dataMap.get(&quot;Next_Member_Role&quot;)); //設定Task 所屬的職務 
		}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011194752664156</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/11/11 11:44:24</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.DMS.DMSServer</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011194752664156</string> 
     </void> 
     <void property="name"> 
      <string>DMSServer</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011194752256531</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011203609380890</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/02/21 23:56:20</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Client.Action</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011203609380890</string> 
     </void> 
     <void property="name"> 
      <string>Action</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011156610928578</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
/**
	統一共用的 openFormAction()
*/
function openFormAction(){
		var table = Form.getComponent(&quot;Process_Table&quot;);
		var hideCols = [&quot;工號&quot;,&quot;TaskID&quot;];
		table.setColHiding(hideCols);
		setSelectProcess();
		loadLibrary(&quot;com.A.Common.Client.SignTable&quot;);
		setSignTableResult(&quot;Process_Table&quot;); //將會簽結果放入審核意見裡面
		
	//設定簽核者姓名工號 20080505
	var member = Client.getCurrentMember();
	if(member != null){
		Form.setValue(&quot;Verify_Name&quot;,member.getName());
		Form.setValue(&quot;Verify_ID&quot;,member.getMyID());		
	}
	
	table.sortByColumnName(&quot;審核日期&quot;,true); // add by wangwei@2009/03/18
}

/**
	統一共用的 okAction()
*/
function okAction(){
	var msg = &quot;&quot;;
	if(&quot;true&quot; == Form.getValue(&quot;Reject&quot;) &amp;&amp; &quot;&quot; == Form.getValue(&quot;Verify_Note&quot;)){
		msg = &quot;請填寫退回原因!\n&quot;;
	}
	if(msg != &quot;&quot;){
		Form.setComplete(false);
		Form.showMessageDialog(msg);
	}
}

	
	
//=====================================================
// 將本關卡的流程「離開狀態」list 加到下拉選單內
//=====================================================
function setSelectProcess(){
	//決定流程選項的內容
	var selectprocess = Form.getComponent(&quot;Select_Process&quot;);
	selectprocess.removeAllItems();
	var task = Form.getCurrentTask();
	//如果是用應用程式開表單會沒有 CurrentTask()
	if(task == null){
		var ins = Form.getArtInstance();
		var insid = ins.getID();
		task = getTaskByInsID(insid);
	}
	var extCond = task.getExtCondList();	//取得離開狀態的物件
	//selectprocess.addItem(&quot;&quot;);
	for (var i1=0;i1&lt;extCond.size();i1++){
		var linkTerm = extCond.get(i1);	//取得第i1筆的物件資料
		var extStateList = linkTerm.getArtStateList();	//取得表單狀態的表列資料
		for (var i2=0;i2&lt;extStateList.size();i2++){
			var extState = extStateList.get(i2);	//取得第i2筆資料狀態名稱
			var stateName = extState.getName();
			//只放退回的選項
			if(stateName.startsWith(&quot;退回&quot;)){
					selectprocess.addItem(stateName);
			}
		}
	}
	Form.setValue(&quot;Select_Process&quot;,&quot;退回申請人&quot;);
	if(&quot;true&quot; == Form.getValue(&quot;Reject&quot;)){
		Form.getComponent(&quot;Select_Process&quot;).setVisible(true);
	}
}

//========================================================================================
// 取得應用程式之查詢共用條件的SQL
//========================================================================================
function getTaskByInsID(InsID){
	var task = null;
	var vecTask = Client.SQLloadValue(&quot;select max(tskid) taskid from task_artins where insid =&apos;&quot;+ InsID +&quot;&apos;&quot;);
	if(vecTask.get(0).get(&quot;taskid&quot;) != null ){
		task = Client.getTask(vecTask.get(0).get(&quot;taskid&quot;));
	}
	return task;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>統一共用的 Form Action()</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011222129534884</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/09/23 08:25:34</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.QC.SendMail</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011222129534884</string> 
     </void> 
     <void property="name"> 
      <string>SendMail</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011221465024953</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
/**
 撤單(拉回前一關)時發出的 mail
 發給被撤的那一關(task.realexecutor)
 用於 Client
*/
function sendGoBackMail(MyTask){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Client.getMember(&quot;administrator&quot;).getEmail();  		
        //var to = getProcessMailAddressList(groupname); 
		//var to = Client.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail();
		var realexecutor_mail = Client.getMember(MyTask.getRealExecutor()).getEmail();
		var to = realexecutor_mail;
        var cc = &quot;&quot;; //cc觀察用 
//        var subject = &quot;[撤簽通知]&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」已被撤回-[&quot;+ MyTask.getKeyWord() +&quot;]&quot;; // Mail Subject 
        var subject = &quot;[撤簽通知]&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot;所申請-&quot; + roottaskname + &quot;已被撤回&quot;; // Mail Subject 
		var text = getGoBackMailContent(dataMap,MyTask);
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
		Client.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
//-------------------
// 撤單通知內容
//-------------------
function getGoBackMailContent(dataMap,MyTask){
		//var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   [撤回通知]&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Client.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Client.getMember(Client.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Client.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Client.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		//text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;

		return text;
}

/**
 會簽時發出的 mail
*/
function sendCSMail(){
	var InsID = MyTask.getArtInstance();
	var dataMap = InsID.getAppDataMap();
	var cMember = Server.getMember(MyTask.getMemberID());
	var fromMail= Server.getMember(&quot;Administrator&quot;).getEmail();//系統管理員為寄件者
	var toEMail = cMember.getEmail();
	var totalccMail = &quot;&quot;;
	var title = &quot;請會簽&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單&quot;;
	var urlData = &quot;&lt;a href=\&quot;$webAgendaURL$mailOpenFormCheckpass\&quot;&gt;會簽單&lt;/a&gt;&quot;;
	var data = &quot; 您好：&quot;+&quot;\n&quot;+&quot;\n&quot;;
	data = data + &quot;這是系統自動發出的一封通知信，請至 EIP 上進行會簽簽核，\n&quot;;
	data = data +&quot;表單內容為：&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單 \n&quot;;
	data = data +&quot;會簽簽核時請點選「加會意見」及請務必填寫「同意」或「不同意」\n&quot;;
   data = data + &quot; 您可以開啟 &quot;+urlData+&quot;，來查看該表單。&quot;+&quot;\n  \n \n   MIS &quot;;
   data = &quot;&lt;pre&gt;&quot;+data+&quot;&lt;/pre&gt;&quot;;
    var vector = new java.util.Vector();
     //taskID
    var taskID = MyTask.getID();  
    Server.sendHTMLMailExt(fromMail,toEMail,totalccMail,title,data,vector,taskID);  
 }
/**
 審核通過時發出的 mail
 通知申請者&amp;填單者
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
 20080502 mail to 名單加入 TableA 上的人員
*/
function sendAcceptMail(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        //var to = getProcessMailAddressList(groupname); //通知簽核過的人員		
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}
		to += &quot;;&quot; +getMailAddressTableA(dataMap);		
//		var vFactory = dataMap.get(&quot;Factory&quot;);
//		var cc = &quot;wangwei@gce.com.tw&quot;; //cc觀察用 
//		if( vFactory==&quot;(SGCE)&quot; ||vFactory==&quot;(CGCE)&quot;  ){
//			cc = &quot;jay.jiang@gcecn.com;wangwei@gce.com.tw&quot;; //cc觀察用 
//		}
        var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		var text = getAcceptMailContent(dataMap);
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
		java.lang.System.out.println(&quot;email ~~&quot;);
//		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
		Server.sendHTMLMailExt(from,to,&quot;&quot;,subject,text,fileList,MyTask); 
	}catch(e){
		java.lang.System.out.println(e);
	}
}

/**
	TABLEA 內的 ID 會有 DEPID or MEMID
	DEPID 要取所有部門成員的 Email address
*/

function getMailAddressTableA(dataMap){
	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	try{
		var tablea = dataMap.get(&quot;TableA&quot;);
		if( tablea != null &amp;&amp; tablea.size()&gt;0  ){
			for(var t=0;t&lt;tablea.size();t++){
				var id = tablea.get(t).get(&quot;ITEM2&quot;);//DEPID or MEMID
				if(id.startsWith(&quot;DEP&quot;) &amp;&amp; Server.getDepartment(id) != null){
					var depname = Server.getDepartment(id).getName();
					memset = addDepAllMemID(depname,memset);
				}else{
					var id = tablea.get(t).get(&quot;ITEM3&quot;);//DEPID or MEMID			
					if(id.startsWith(&quot;MEM&quot;)&amp;&amp; Server.getMember(id) != null &amp;&amp; !Server.getMember(id).isResign()){
						memset.add(id);
					}
				}				
			}
		}
		
		// memset --&gt; email address
			var key = memset.iterator();
			while(key.hasNext()){
				var memid = key.next();
				if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
					emailaddress += Server.getMember(memid).getEmail() + &quot;;&quot; ;
				}
			}

	}catch(e){
		var emailaddress = Server.getMember(&quot;administrator&quot;).getEmail();  
	}
	return emailaddress;
}
/**
	20080503
	將 DEP 內的所有人員加入 memset 內(含子部門)
*/
function addDepAllMemID(depname,memset){
	var DepartmentList = Server.getAllDepartmentByName(depname);
	//var memberNameList  = new java.util.Vector();
	for(var i=0;i&lt;DepartmentList.size();i++){
			var depObj =DepartmentList.get(i);
			var depID = depObj.getID();
			var memList = Server.getSubMemberIDOfDR(depID,true);
			for(var j = 0; j&lt; memList.size();j++){
				var memid = memList.get(j);
				if(memid != null &amp;&amp; memid != &quot;&quot;){
					memset.add(memid);
				}
			}
	}
	return memset;
}

 //-------------------
// 駁回通知內容
//-------------------
function getAcceptMailContent(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核通過通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

/**
 駁回時發出的 mail
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
*/
function sendRejectMail(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
//		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        var to = getProcessMailAddressList(groupname); 
        var cc = &quot;&quot;; //cc觀察用 
        var subject = &quot;[駁回通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」已退回申請人&quot;; // Mail Subject 
		var text = getMailContent(dataMap);
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
 //-------------------
// 駁回通知內容
//-------------------
function getMailContent(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核駁回通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		return text;
}


/**
	取得Root Task 流程所經過的人+ 特定 table 抓出來的 email address 字串
*/
function getProcessMailAddressList(groupname){

	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	//流程上的成員
		var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;exeid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;exeid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;); //排除 Administrator
		//memset.remove(&quot;MEM00211172832334935&quot;);
	}
	//Table 上的成員
	if(groupname != &quot;&quot;){
		var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
		var vec = Server.SQLloadValue(sql); 
		if(vec != null &amp;&amp; vec.size() &gt; 0){
			for(var i=0;i&lt;vec.size();i++){
				if(Server.getMember(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;memid&quot;)).isResign()){
						memset.add(vec.get(i).get(&quot;memid&quot;));
				}
			}
				memset.remove(&quot;Administrator&quot;);
		}
	}

	var key = memset.iterator();
	while(key.hasNext()){
		var memid = key.next();
		if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
			emailaddress += Server.getMember(memid).getEmail() + &quot;;&quot; ;
		}
	}
	return emailaddress;	
}

 
 

//---------------------------------------------------------
//取得Root Task 流程所經過的人+ 特定 table 抓出來的 memid set
//扣掉上一關的人
function getProcessMemberList(groupname){
	var emailaddress = &quot;&quot;;
	var fronttaskid = MyTask.getFrontID();
	var frontmemid = Server.getTask(fronttaskid).getRealExecutor();
	var memset = java.util.TreeSet();
	//流程上的成員
	var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid and exeid !=&apos;&quot;+ frontmemid + &quot;&apos; &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			//去除已離職的人
			if(Server.getMember(vec.get(i).get(&quot;exeid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;exeid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;);
	}
	//Table 上的成員
	var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;memid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;memid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;);
	}
	return memset;	
}
//---------------------------------------------------------- 


//------------------------
// 發 mail 開啟連結用的 URL 
// n == 1 //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件 ( ie7 無法直接開 ) 
// n == 2 //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
// n == 3 //email開表單，需密碼
// n == 4 //email開表單，不需密碼
//------------------------
function getUrl(n){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           var aInstance = MyTask.getArtInstance(); 
           var dataMap = aInstance.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                     //var userName = member.getName();
                     var userName = member.getLoginID();
                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }
           return url;
}


</string> 
     </void> 
     <void property="synopsis"> 
      <string>SendMail</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011222246389213</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2015/03/25 15:27:15</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.TRN.TRNSEARCH</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011222246389213</string> 
     </void> 
     <void property="name"> 
      <string>TRNSEARCH</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001222246374313</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//loadLibrary(&quot;com.eland.dms.DMSAP&quot;);

	
//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				var userName = memberRecord.getName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;
//				}else if(&quot;complete&quot; == task.getTaskState()){
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
					userName = &quot;--&quot;;
				}
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);
				
				
				//table.setValueAt(getPriorityString(task), i, &quot;緊急程度&quot;);
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(processname,    	     row, &quot;目前關卡&quot;);
			table.setValueAt(userName, row, &quot;目前處理者&quot;);			
			table.setValueAt(hm.get(&quot;ITEM15&quot;),    	 row, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;ITEM27&quot;), 	     row, &quot;申請者&quot;);
			table.setValueAt(hm.get(&quot;ITEM2&quot;),  	 row, &quot;申請日期&quot;);
			table.setValueAt(hm.get(&quot;ITEM57&quot;),   	 row, &quot;課程資訊&quot;);						
			table.setValueAt(hm.get(&quot;INSID&quot;),   	 row, &quot;InsID&quot;);
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			sSQL += &quot; AND ITEM2 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
		}
	}
	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM2 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
		}
	}	
	
	// 部門
	var DepName = Form.getValue(&quot;DepName&quot;);	
	if (!&quot;&quot;.equals(DepName)) {
		sSQL += &quot; AND ITEM15 like &apos;&quot; + DepName + &quot;%&apos;&quot;;
	}	
	// 單位主管
	var MemName= Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM79 like &apos;%&quot; + MemName + &quot;%&apos;&quot;;
	}
	// 表單編號
	var Sn = Form.getValue(&quot;Sn&quot;);	 
	if (!&quot;&quot;.equals(Sn)) {
		sSQL += &quot; AND ITEM9 like &apos;%&quot; + Sn + &quot;%&apos;&quot;;
	}
	// 申請者中文姓名
	var vApp_Name = Form.getValue(&quot;App_Name&quot;);	 
	if (!&quot;&quot;.equals(vApp_Name) &amp;&amp; vApp_Name!=null) {
		sSQL += &quot; AND ITEM43  = &apos;&quot; + vApp_Name + &quot;&apos;&quot;;
	}	
	
	//文件狀態
	var Status = Form.getValue(&quot;Status&quot;);	 
	if (!&quot;全部&quot;.equals(Status)) {
			if (&quot;已結案&quot;.equals(Status)) {
				sSQL += &quot; AND ITEM115 is not null &quot;;
			}else if (&quot;未結案&quot;.equals(Status)){
				sSQL += &quot; AND ITEM115 is null &quot;;
			}				
	}
	
	return sSQL;
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011225331685222</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/10/30 09:54:45</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PH.FILTER_PH_ALLCLOSE</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011225331685222</string> 
     </void> 
     <void property="name"> 
      <string>FILTER_PH_ALLCLOSE</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00321216878882287</string> 
     </void> 
     <void property="scriptSource"> 
      <string>	
//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;
//				}else if(&quot;complete&quot; == task.getTaskState()){
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
				//table.setValueAt(getPriorityString(task), i, &quot;緊急程度&quot;);
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);

			if(&quot;Y&quot;.equals(hm.get(&quot;ITEM131&quot;))){
				var prstatus = &quot;已轉ERP&quot;;
			}else if(&quot;W&quot;.equals(hm.get(&quot;ITEM131&quot;))){
				var prstatus = &quot;已收件&quot;;
			}
			else{
				var prstatus = &quot;Waiting!&quot;;
			}
			
			table.setValueAt(prstatus,    	row, &quot;PR狀態&quot;);			
			table.setValueAt(hm.get(&quot;ITEM12&quot;).substring(0,10),    	row, &quot;開單日期&quot;);
			
			if(hm.get(&quot;ITEM115&quot;).length()&gt;1){
				var fm_closedate = hm.get(&quot;ITEM115&quot;).substring(0,10);
			}else{
				var fm_closedate = &quot;--&quot;;
			}
			table.setValueAt(fm_closedate,    	row, &quot;結案日期&quot;);			
			table.setValueAt(hm.get(&quot;ITEM138&quot;),    	row, &quot;PR No.&quot;);			
			table.setValueAt(hm.get(&quot;ITEM144&quot;),    	row, &quot;填單人&quot;);
			table.setValueAt(hm.get(&quot;ITEM24&quot;), 	row, &quot;申請人&quot;);
			table.setValueAt(hm.get(&quot;ITEM186&quot;), 	row, &quot;開單部門&quot;);
			table.setValueAt(hm.get(&quot;ITEM15&quot;),   	row, &quot;用途說明&quot;);
			table.setValueAt(hm.get(&quot;ITEM165&quot;),  	row, &quot;品名/規格&quot;);
			table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}else{
					sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
		}
	}
	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}else{
					sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}			
		}
	}
	// 文件編號
	var Doc_Sn = Form.getValue(&quot;Sn&quot;);	
	if (!&quot;&quot;.equals(Doc_Sn)) {
		sSQL += &quot; AND ITEM138 like &apos;%&quot; + Doc_Sn + &quot;%&apos;&quot;;
	}	
	
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM144 like &apos;%&quot; + MemName + &quot;%&apos;&quot;;
	}	
	var appname = Form.getValue(&quot;appname&quot;);	
	if (!&quot;&quot;.equals(appname)) {
		sSQL += &quot; AND ITEM27 like &apos;%&quot; + appname + &quot;%&apos;&quot;;
	}	

	var PHSTATUS = Form.getValue(&quot;FComboBox0&quot;);

//	if (!&quot;&quot;.equals(PHSTATUS)) {
//		if(&quot;採購已收件&quot;.equals(PHSTATUS)){
//			sSQL += &quot; AND ITEM131 like &apos;%採購已收件%&apos;&quot;;
//		}
//		else if(&quot;已轉入ERP&quot;.equals(PHSTATUS)){
//			sSQL += &quot; AND ITEM131 like &apos;%已轉入ERP%&apos;&quot;;
//		}
//		else{
		sSQL += &quot; AND (ITEM131 &lt;&gt; &apos;W&apos; and  ITEM131 &lt;&gt; &apos;Y&apos;) &quot;;
//		}
//	}
	//文件狀態
	
		sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM115 is not null &quot;;

	}	
	
	// 用途說明
	var spec = Form.getValue(&quot;spec&quot;);	
	if (!&quot;&quot;.equals(spec)) {
		sSQL += &quot; AND ITEM15 like &apos;%&quot; + spec + &quot;%&apos;&quot;;
	}		
	var Subject = Form.getValue(&quot;Subject&quot;);	
	if (!&quot;&quot;.equals(Subject)) {
		sSQL += &quot; AND ITEM165 like &apos;%&quot; + Subject + &quot;%&apos;&quot;;
	}	
	return sSQL;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011227091346193</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/08/16 13:30:58</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Server.AppRelated</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011227091346193</string> 
     </void> 
     <void property="name"> 
      <string>AppRelated</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011227091263550</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function getManager(memid){
	var mem = Server.getMemberByID(memid);  // getMember modi by wangwei@2013/04/11
	var managerMemID = &quot;Administrator&quot;;
	if(mem != null){
		managerMemID = mem.getPager();
	}
	var manager = Server.getMemberByID(managerMemID);
	return manager;
}

// 設定流程走向
function setFlow(days){
	var artIns = MyTask.getArtInstance();
	var insID = artIns.getID();	
	var App_ID = artIns.getAppValue(&quot;App_ID&quot;);// 請假人ID
	var App_Dep_ID = artIns.getAppValue(&quot;App_Dep_ID&quot;);// 請假人部門
	var App_MemID = artIns.getAppValue(&quot;App_MemID&quot;);
	var flowList = new java.util.Vector();// 簽核人名單
	var vec;
	var sql = &quot;select * from a_parameter_data where parameter =&apos;HR_FLOW_SPECIAL&apos; and value2=&apos;&quot;+App_MemID+&quot;&apos;&quot;;
	vec = Server.SQLloadValue(sql);
	if (vec.size()&gt;0){//特殊簽核流程人員名單中,用等殊簽核流程的來顯示
		var list = vec.get(0).get(&quot;remarks&quot;);
		//一階為總經理，二階為副董，且請假時數小於等於3小時者，二階不用再簽副董 add by yingchieh@20121005
		if (list.equals(&quot;MEMT1012949;MEMT1012627&quot;) &amp;&amp; artIns.getAppValue(&quot;txtTotal&quot;) &lt;=3 ){
			list = &quot;MEMT1012949&quot;;
		}
		var st = new java.util.StringTokenizer(list,&quot;;&quot;);
		while(st.hasMoreTokens()){
			var memid = st.nextToken();
			var memMap = new java.util.HashMap();
			memMap.put(&quot;ITEM1&quot;,memid);// 放memid
			memMap.put(&quot;ITEM2&quot;,Server.getMemberByID(memid));  //getMember modi by wangwei@2013/04/11
			flowList.add(memMap);
		}
	}else{//傳回一般簽核流程人員名單
		loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
		var dbName = &quot;T-MES&quot;;
		var level=&quot;&quot;;
		//1.以請假天數決定簽核層級 2.需依照各工作型態設定每天工時
		var dataMap = artIns.getAppDataMap();
		var txtTotal = java.lang.Float.parseFloat(dataMap.get(&quot;txtTotal&quot;));// 取得總小時
		var wktype = dataMap.get(&quot;wktype&quot;);// 工作型態
		if(days&lt;2){// 小於2天,簽核層級:1
			level = &quot;1&quot;;
		}else if(days&gt;=2&amp;&amp;days&lt;3){// 2~未滿3天,簽核層級:2
			level = &quot;2&quot;;
		}else{// 3天(含)以上,簽核層級:3
			level = &quot;3&quot;;
		}
		//設定最後一個審核人
		var dptno = dataMap.get(&quot;App_Dep_ID&quot;);
		var wkgreat = dataMap.get(&quot;wkgreat&quot;);
		if (wkgreat==&quot;0&quot; ||wkgreat.equals(&quot;0&quot;)){//不列等人員判斷,自動改成M職等
			wkgreat=&quot;M&quot;;
		}
		var LastManager;
		if(level==&quot;1&quot;){// level1簽核
			var sql = &quot;select flow_1 from empm032 where dptno=&apos;&quot;+dptno+&quot;&apos; and wkgreat=&apos;&quot;+wkgreat+&quot;&apos;&quot;;
			LastManager = getLastManager(sql,&quot;flow_1&quot;);	
		}else if(level==&quot;2&quot;){// level2簽核
			var sql = &quot;select flow_2 from empm032 where dptno=&apos;&quot;+dptno+&quot;&apos; and wkgreat=&apos;&quot;+wkgreat+&quot;&apos;&quot;;
			LastManager = getLastManager(sql,&quot;flow_2&quot;);	
		}else if(level==&quot;3&quot;){// level3簽核
			var sql = &quot;select flow_3 from empm032 where dptno=&apos;&quot;+dptno+&quot;&apos; and wkgreat=&apos;&quot;+wkgreat+&quot;&apos;&quot;;
			LastManager = getLastManager(sql,&quot;flow_3&quot;);	
		}		
		var isFlushcard = false;// 是不是刷卡處理人員
		var flushcard_verify_level;// 刷卡處理人員的簽核層級
		try{
			var sql =&quot;select flushcard from empm020 where empno=&apos;&quot;+App_ID+&quot;&apos;&quot;;
			var conn = Server.createSessionConnection(dbName);
			var vec = conn.loadValue(sql);
			var result = vec.get(0);
			var flushcard = result.get(&quot;flushcard&quot;);
			if(flushcard==&quot;1&quot;){// 1.刷卡處理人員的簽核方式
				isFlushcard = true;
				if(level==&quot;1&quot;){// 請假不滿2天時,請假兩日以內(含)：逐級簽核至課長、主任。
					flushcard_verify_level= Server.getRole(Server.getMemberByID(LastManager).getMainRoleID()).getMyID();
				}else if(level==&quot;2&quot;){// 請假超過兩日，逐級簽核至經理、副理。
					flushcard_verify_level= Server.getRole(Server.getMemberByID(LastManager).getMainRoleID()).getMyID();
				}else if(level==&quot;3&quot;){// 請假超過五日，逐級簽核至協理。
					flushcard_verify_level= Server.getRole(Server.getMemberByID(LastManager).getMainRoleID()).getMyID();
				}
			}		
		}catch(e){
		}finally{
			conn.close();
		}
		var nextMemberID = dataMap.get(&quot;App_MemID&quot;);// 申請人mID	
		//2A0特定人員判斷
		var vice_presidentID = &quot;MEMT1012627&quot;;// 副董事長
		var bigManagerID = getSpecialVerify(); 
		var isSpecial = getSpecialProc(App_ID);
		var isSpecial2 = getSpecialProc2(App_ID);
		var isSpecial3 = getSpecialProc3(App_ID);
		var VPProc = isVPProc(App_ID);//是否為副總直接簽核的流程
		if(VPProc==&quot;true&quot; || VPProc.equals(&quot;true&quot;)){
			var member = Server.getMemberByID(vice_presidentID);  // getMember modi by wangwei@2013/04/11
			var memMap = new java.util.HashMap();
			memMap.put(&quot;ITEM1&quot;,vice_presidentID);// 放memid
			memMap.put(&quot;ITEM2&quot;,member.getName());
			flowList.add(memMap);
		}else{
			if(isSpecial==&quot;true&quot; || isSpecial.equals(&quot;true&quot;) || isSpecial3==&quot;true&quot; || isSpecial3.equals(&quot;true&quot;)){// 特定人員請假時，系統自動於流程最後加簽總經理劉中天，特定人員名單由人力資源部透過管理介面維護				
				LastManager = bigManagerID;
				var member = Server.getMemberByID(nextMemberID);   // getMember modi by wangwei@2013/04/11
				nextMemberID = member.getPager();// 取得直屬主管mid
				member = Server.getMemberByID(nextMemberID);   // getMember modi by wangwei@2013/04/11
				while(!(nextMemberID.equals(LastManager))){// 簽核人與最後簽核者是同一個人時		
					var memMap = new java.util.HashMap();
					memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
					memMap.put(&quot;ITEM2&quot;,member.getName());	 			
					flowList.add(memMap);
					nextMemberID = member.getPager();// 取得直屬主管mid
					member = Server.getMemberByID(nextMemberID);  // getMember modi by wangwei@2013/04/11
				}
				var memMap = new java.util.HashMap();
				memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
				memMap.put(&quot;ITEM2&quot;,member.getName());
				flowList.add(memMap);
			}else if(isSpecial2==&quot;true&quot; || isSpecial2.equals(&quot;true&quot;)){
				LastManager = vice_presidentID;
				var member = Server.getMemberByID(nextMemberID);  // getMember modi by wangwei@2013/04/11
				nextMemberID = member.getPager();// 取得直屬主管mid
				member = Server.getMemberByID(nextMemberID);    // getMember modi by wangwei@2013/04/11
				while(!(nextMemberID.equals(LastManager))){// 簽核人與最後簽核者是同一個人時		
					var memMap = new java.util.HashMap();
					memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
					memMap.put(&quot;ITEM2&quot;,member.getName());	 			
					flowList.add(memMap);
					nextMemberID = member.getPager();// 取得直屬主管mid
					member = Server.getMemberByID(nextMemberID); // getMember modi by wangwei@2013/04/11
				}
				var memMap = new java.util.HashMap();
				memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
				memMap.put(&quot;ITEM2&quot;,member.getName());
				flowList.add(memMap);
			}else{
				//刷卡處理人員的簽核方式
				if(isFlushcard){// 刷卡處理人員流程名單設定,根據flushcard_verify_level
					var member = Server.getMemberByID(nextMemberID);// memberRecord// getMember modi by wangwei@2013/04/11
					nextMemberID = member.getPager();// 取得直屬主管mid
					member = Server.getMemberByID(nextMemberID); // getMember modi by wangwei@2013/04/11   
					var roleID = member.getMainRoleID();
					var mbrLv = Server.getRole(roleID).getMyID();// 取得職務等級
					mbrLv = java.lang.Integer.parseInt(mbrLv);		
					while(mbrLv &lt;= flushcard_verify_level){
						var memMap = new java.util.HashMap();
						memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
						memMap.put(&quot;ITEM2&quot;,member.getName());
						flowList.add(memMap);
						if (nextMemberID.equals(LastManager)){
							break;
						}
						nextMemberID = member.getPager();// 取得直屬主管mid
						member = Server.getMemberByID(nextMemberID);  // getMember modi by wangwei@2013/04/11
						roleID = member.getMainRoleID();
						mbrLv = Server.getRole(roleID).getMyID();// 取得職務等級
						mbrLv = java.lang.Integer.parseInt(mbrLv);
					}
				}else{// 刷卡不處理人員流程名單設定,根據LastManager
					var member = Server.getMemberByID(nextMemberID);// getMember modi by wangwei@2013/04/11
					// 20081127 先判斷審核人是不是自己
					if(nextMemberID.equals(LastManager)){// 代表審核人就是自己,系統自動加簽請假人上一階直屬主管。
						nextMemberID = member.getPager();// 取得直屬主管mid
						member = Server.getMemberByID(nextMemberID); // getMember modi by wangwei@2013/04/11
						LastManager = nextMemberID;
					}else{
						nextMemberID = member.getPager();// 取得直屬主管mid
						member = Server.getMemberByID(nextMemberID);// getMember modi by wangwei@2013/04/11
						var count = 0;
						if (Server.getRole(Server.getMemberByID(nextMemberID).getMainRoleID()).getMyID()&gt;Server.getRole(Server.getMemberByID(LastManager).getMainRoleID()).getMyID()){
							LastManager=nextMemberID;
						}
						while(!(nextMemberID.equals(LastManager))){// 簽核人與最後簽核者是同一個人時		
							var memMap = new java.util.HashMap();
							memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
							memMap.put(&quot;ITEM2&quot;,member.getName());	 			
							flowList.add(memMap);
							nextMemberID = member.getPager();// 取得直屬主管mid
							member = Server.getMemberByID(nextMemberID);// getMember modi by wangwei@2013/04/11
							count++;
							if(count&gt;10){
								break;
							}
						}
					}
					var memMap = new java.util.HashMap();
					memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
					memMap.put(&quot;ITEM2&quot;,member.getName());	 	
					flowList.add(memMap);
				}			
			}		
		}
	}
	return flowList;// 回傳簽核人員清單
}

// 設定最後一位簽核人
function getLastManager(sql,flow){
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	try{
		var conn = Server.createSessionConnection(&quot;T-MES&quot;);
		var vec	= conn.loadValue(sql);
		var result = vec.get(0);	
		var LastManager	= result.get(flow);
		//需完整工號
		if(LastManager.substring(0,1).equals(&quot;0&quot;)){
			LastManager = &quot;MEMT1&quot; + LastManager;
		}else if(LastManager.substring(0,1).equals(&quot;S&quot;)){
			LastManager = &quot;MEMS10&quot; + LastManager.substring(1,6);
		}else if(LastManager.substring(0,1).equals(&quot;C&quot;)){
			LastManager = &quot;MEMC10&quot; + LastManager.substring(1,6);
		}else if(LastManager.substring(0,1).equals(&quot;H&quot;)){
			LastManager = &quot;MEMH10&quot; + LastManager.substring(1,6);
		}		
		return LastManager;
	}catch(e){	
		java.lang.System.out.println(e);
	}finally{		
		conn.close();
	}
}

function getSpecialVerify(){// 取得特定流程簽核人id
	var sql = &quot;select ITEM56 from ART00311223536033565_INS&quot;;
	var vec = Server.SQLloadValue(sql);	
	var id=&quot;&quot;;
	if(vec.size()&gt;0){
		var result = vec.get(0);
		id = result.get(&quot;ITEM56&quot;);
		id = &quot;MEMT1&quot; + id;
	}
	return id;
}

//是否為副董直接簽核人員
function isVPProc(App_ID){
	var sql = &quot;select ITEM66 from ART00311223536033565_INS where ITEM66 like &apos;%&quot;+App_ID+&quot;%&apos;&quot;;
	var vec = Server.SQLloadValue(sql);
	var VPProc=&quot;false&quot;;
	if(vec.size()&gt;0){
		VPProc = &quot;true&quot;;
	}
	return VPProc;
}

//是否為特殊人員,最後一關加總經理
//總經理目前只簽一階主?。故此項已不再用  add by yingchieh@20121001
function getSpecialProc(App_ID){ 
	var sql = &quot;select ITEM52 from ART00311223536033565_INS where ITEM52 like &apos;%&quot;+App_ID+&quot;%&apos;&quot;;
	var vec = Server.SQLloadValue(sql);
	var isSpecial=&quot;false&quot;;
	if(vec.size()&gt;0){
		isSpecial=&quot;true&quot;;
	}
	return isSpecial;
}

//是否為特殊人員,最後一關加總經理(bryan專用)
//此項已移入特殊簽核流程設定 add by yingchieh@20121001
function getSpecialProc2(App_ID){ 
	var isSpecial2=&quot;false&quot;;
	if(App_ID==&quot;001296&quot; || App_ID.equals(&quot;001296&quot;)){
		isSpecial2=&quot;true&quot;;
	}
	return isSpecial2;
}

//是否為特殊人員,最後一關加總經理
function getSpecialProc3(App_ID){ 
//	var sql = &quot;SELECT * FROM mem_geninf WHERE ( pager IN (SELECT memid FROM mem_geninf WHERE pager = &apos;MEMT1012949&apos;)) AND resign = &apos;false&apos; and (joblevel like &apos;M10%&apos; or joblevel like &apos;M11%&apos; or joblevel like &apos;M12%&apos; or joblevel like &apos;0不列等%&apos;) and memid =&apos;MEMT1&quot;+App_ID+&quot;&apos;&quot;;
//	var vec = Server.SQLloadValue(sql);
//	var isSpecial3=&quot;false&quot;;
//	if(vec.size()&gt;0){
//		isSpecial3=&quot;true&quot;;
//	}
//	return isSpecial3;
	//取消二階副理級以上簽至總經理的功能  add by yingchieh@20121001
	return &quot;false&quot;;
}

/**
 審核通過時發出的 mail
 通知申請者&amp;填單者
 沒有要多傳給特定人 groupname 傳 &quot;&quot; 
*/
function sendAcceptMail(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var Sn = dataMap.get(&quot;Sn&quot;);
		var cname = dataMap.get(&quot;App_Name&quot;);
		var Creator = dataMap.get(&quot;Creator&quot;);
		var vVerify_Name = dataMap.get(&quot;Verify_Name&quot;);  // add by wangwei@2016/04/25
		if(vVerify_Name!=&quot;&quot;){
			var from = Server.getMemberByCName(vVerify_Name).getEmail();   	// getMember modi by wangwei@2013/04/11	
		}else{
			var from =&quot;MyGCE@gce.com.tw&quot;
		}   				//-------------------------------------------------------			
		var vMaill = Server.getMemberByID(dataMap.get(&quot;App_MemID&quot;)).getEmail();
		if( vMaill.indexOf(&quot;wtadmin&quot;)&lt;0){
			var to = Server.getMemberByID(dataMap.get(&quot;App_MemID&quot;)).getEmail(); // getMember modi by wangwei@2013/04/11	
		}else{
			var to=&quot;&quot;;		
		}
		var creator_mail = Server.getMemberByID(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}
		var cc=&quot;&quot;;
		var tableList = dataMap.get(&quot;tableList&quot;);
		var appname = dataMap.get(&quot;App_Name&quot;);
		var appdpt = dataMap.get(&quot;App_Dep_ID&quot;);
		var time = dataMap.get(&quot;Start_Time&quot;);
		var procHist = getProcHistTable();
		var size = tableList.size();
		var table = &quot;  &lt;table border=\&quot;1\&quot; cellpadding=\&quot;2\&quot; cellspacing=\&quot;0\&quot; width=\&quot;720\&quot; bordercolordark=\&quot;#FFFFFF\&quot; id=\&quot;table1\&quot; style=\&quot;font-size: 9pt; font-family: Arial\&quot;&gt;&quot;
  				  + &quot;    &lt;tr style=\&quot;font-size: 9PT; font-family: Arial; line-height: 100%; border: 1px outset #FFFFFF;line-height:150%\&quot;&gt;&quot;
				  + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;150\&quot;&gt;請假人&lt;/td&gt;&quot;
				  + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;150\&quot;&gt;假別&lt;/td&gt;&quot;
				  + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;120\&quot;&gt;請假日&lt;/td&gt;&quot;
				  + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;80\&quot;&gt;時數&lt;/td&gt;&quot;
				  + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;220\&quot;&gt;事由&lt;/td&gt;&quot;
				  + &quot;      &lt;/td&gt;&quot;
				  + &quot;    &lt;/tr&gt;&quot;;				 
		 for(var i=0;i&lt;size;i++){
			 var rowData = tableList.get(i);
			 var apptype = rowData.get(&quot;ITEM3&quot;);// 假別
			 var appdate = rowData.get(&quot;ITEM4&quot;);// 日期
			 var apptime = rowData.get(&quot;ITEM5&quot;);// 時間
			 var reason = rowData.get(&quot;ITEM9&quot;);// 理由
			 table = table + &quot;    &lt;tr&gt;&lt;form method=\&quot;POST\&quot; NAME = \&quot;NEWFORM\&quot;&gt;&quot;
		           + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+appname+&quot; / &quot;+appdpt+&quot;&lt;/td&gt;&quot;
				   + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+apptype+&quot;&lt;/td&gt;&quot;
				   + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+appdate+&quot;&lt;/td&gt;&quot;
				   + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+apptime+&quot;&lt;/td&gt;&quot;
				   + &quot;      &lt;td align=\&quot;left\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+reason+&quot;&lt;/td&gt;&quot;
				   + &quot;      	&lt;/td&gt;&lt;/tr&gt;&quot;;
		 }
		var table = table + &quot; &lt;/table&gt;&quot;;
        var subject = &quot;[結案通知]請假單:&quot;+cname+ &quot;-請假單(&quot;+Sn+&quot;)已審核通過&quot;; // Mail Subject
		var text = &quot;&lt;table border=\&quot;0\&quot; width=\&quot;100%\&quot; style=\&quot;font-size: 11pt; font-family: Tahoma\&quot; height=\&quot;321\&quot;&gt;&quot;
				 + &quot;	&lt;tr&gt;&quot;
				 + &quot;	&lt;td height=\&quot;293\&quot;&gt;&quot;
				 + &quot;		&lt;font size=2&gt;Dear Sir,&lt;/font&gt;&quot;
				 + &quot;		&lt;p&gt;&lt;font size=2&gt;您申請的請假單(&quot;+Sn+&quot;)，已簽核完畢。&lt;/font&gt;&lt;/p&gt;&quot;
				 + &quot;		&lt;blockquote&gt;&quot;
				 + &quot;&lt;p&gt;&lt;font size=2&gt;流程名稱：請假單流程&lt;br&gt;&quot;
				 + &quot;&lt;p&gt;&lt;font size=2&gt;填單者：&quot;+Creator+&quot;&lt;/font&gt;&lt;/p&gt;&quot;
				 + table
				 + &quot;&lt;p&gt;&lt;font size=2&gt;簽核記錄：&lt;/font&gt;&lt;/p&gt;&quot;
				 +  procHist 
				 + &quot;&lt;br&gt;&lt;p&gt;&lt;font size=2&gt;操作上有任何問題 請與&lt;a href=\&quot;http://mygce/eip/portal/oa/formList.jsp?n=001\&quot;&gt;資訊處&lt;/a&gt;聯絡 &lt;/p&gt;&quot;
				 + &quot;&lt;/blockquote&gt;&quot;
				 + &quot;&lt;p&gt;&lt;/td&gt;&quot;
				 + &quot;&lt;/tr&gt;&quot;
				 + &quot;&lt;tr&gt;&quot;
				 + &quot;&lt;td bgcolor=\&quot;#336699\&quot; style=\&quot;font-size: 9pt; font-family: Tahoma\&quot;&gt;&quot;
				 + &quot;&lt;p align=\&quot;center\&quot;&gt;&lt;font color=\&quot;#FFFFFF\&quot;&gt;MyGCE All New Flow System&lt;/font&gt;&lt;/td&gt;&quot;
				 + &quot;&lt;/tr&gt;&quot;	
				 + &quot;&lt;/table&gt;&quot;
        var fileList = new Packages.java.util.Vector();
		var TO = new Packages.java.lang.String(to).replaceAll(&quot;wtadmin@gce.com.tw&quot;,&quot;&quot;);//刪除wtadmin帳號
		Server.sendHTMLMail(from,TO,subject,text);
//		Server.sendHTMLMail(from,&quot;yingchieh_wang@gce.com.tw&quot;,subject,text);//測試用
	}catch(e){
		//java.lang.System.out.println(e);
		Server.addErrLog(&quot;com.gce.HR.Server.AppRelated.sendAcceptMail() Error:&quot;+e);
	}
}

function getSpecialRule(){
	var sql = &quot;select * from ART00311223536033565_ins where insid=&apos;test&apos;&quot;;
	var vec = Server.SQLloadValue(sql);
	var result = vec.get(0);
	var FLOWTO_PAUL = result.get(&quot;ITEM52&quot;);// 特定流程名單
	var FLOWER = result.get(&quot;ITEM56&quot;);// paul id
	var NOTI_PAUL = result.get(&quot;ITEM31&quot;);// 要通知paul的名單
	var NOTIER = result.get(&quot;ITEM48&quot;);// 
	var PAUL_ENABLE = result.get(&quot;ITEM28&quot;);// paul要求項目
	var senderemail = result.get(&quot;ITEM40&quot;);// 寄件者信箱
	var recemail = result.get(&quot;ITEM44&quot;);// paul信箱
	var bcclist = result.get(&quot;ITEM31&quot;);//
	var hm = new java.util.HashMap();
	hm.put(&quot;FLOWTO_PAUL&quot;,FLOWTO_PAUL);
	hm.put(&quot;FLOWER&quot;,FLOWER);
	hm.put(&quot;NOTI_PAUL&quot;,NOTI_PAUL);
	hm.put(&quot;NOTIER&quot;,NOTIER);
	hm.put(&quot;PAUL_ENABLE&quot;,PAUL_ENABLE);
	hm.put(&quot;senderemail&quot;,senderemail);
	hm.put(&quot;recemail&quot;,recemail);
	hm.put(&quot;bcclist&quot;,bcclist);
	return hm;
}

function sendNoticeMailTo(from,to,dataMap,subject){// 通知的email內容
	var from;
	if(&quot;&quot;==subject){
		subject = &quot;TGCE&quot;+&quot;請假通知&quot;;
	}	
	var tableList = dataMap.get(&quot;tableList&quot;);
	var appname = dataMap.get(&quot;App_Name&quot;);
	var appdpt = dataMap.get(&quot;App_Dep_ID&quot;);
	var time = dataMap.get(&quot;Start_Time&quot;);
	var size = tableList.size();
	var date = new java.util.Date(java.lang.System.currentTimeMillis());
	var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
	time = simpledateformat.format(date);
	var text = &quot;&lt;div align=\&quot;left\&quot; style=\&quot;font-size: 9pt; font-family: Arial\&quot;&gt;&quot;
		     + &quot;Dear Sir,&lt;p&gt;&quot;+appname+&quot; 於 &quot;+ time +&quot; 填寫了一張假單如下，請參考：&lt;/p&gt;&quot;
			 + &quot;  &lt;table border=\&quot;1\&quot; cellpadding=\&quot;2\&quot; cellspacing=\&quot;0\&quot; width=\&quot;720\&quot; bordercolordark=\&quot;#FFFFFF\&quot; id=\&quot;table1\&quot; style=\&quot;font-size: 9pt; font-family: Arial\&quot;&gt;&quot;
			 + &quot;    &lt;tr style=\&quot;font-size: 9PT; font-family: Arial; line-height: 100%; border: 1px outset #FFFFFF;line-height:150%\&quot;&gt;&quot;
			 + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;150\&quot;&gt;請假人&lt;/td&gt;&quot;
			 + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;150\&quot;&gt;假別&lt;/td&gt;&quot;
			 + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;120\&quot;&gt;請假日&lt;/td&gt;&quot;
			 + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;80\&quot;&gt;時數&lt;/td&gt;&quot;
			 + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;220\&quot;&gt;事由&lt;/td&gt;&quot;
			 + &quot;      &lt;/td&gt;&quot;
			 + &quot;    &lt;/tr&gt;&quot;;
			
	for(var i=0;i&lt;size;i++){
		var rowData = tableList.get(i);
		var apptype = rowData.get(&quot;ITEM3&quot;);// 假別
		var appdate = rowData.get(&quot;ITEM4&quot;);// 日期
		var apptime = rowData.get(&quot;ITEM5&quot;);// 時間
		var reason = rowData.get(&quot;ITEM9&quot;);// 理由
		text = text + &quot;    &lt;tr&gt;&lt;form method=\&quot;POST\&quot; NAME = \&quot;NEWFORM\&quot;&gt;&quot;
			        + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+appname+&quot; / &quot;+appdpt+&quot;&lt;/td&gt;&quot;
					+ &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+apptype+&quot;&lt;/td&gt;&quot;
					+ &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+appdate+&quot;&lt;/td&gt;&quot;
					+ &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+apptime+&quot;&lt;/td&gt;&quot;
					+ &quot;      &lt;td align=\&quot;left\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+reason+&quot;&lt;/td&gt;&quot;
					+ &quot;      	&lt;/td&gt;&lt;/tr&gt;&quot;;
	}
	var text = text + &quot; &lt;/table&gt;&quot;;	
	Server.sendHTMLMail(from,to,subject,text);
}

// 結案通知的email內容,通知給書記or主管的內容
function sendCloseNoticeMailTo(from,to,dataMap){
	var from;
	var Sn = dataMap.get(&quot;Sn&quot;);
	var cname = dataMap.get(&quot;App_Name&quot;);
	var empno = dataMap.get(&quot;App_ID&quot;);
	var tableList = dataMap.get(&quot;tableList&quot;);
	var appname = dataMap.get(&quot;App_Name&quot;);
	var appdpt = dataMap.get(&quot;App_Dep_ID&quot;);
	var subject = &quot;[結案通知]請假單:(&quot;+appdpt+&quot;)&quot;+cname+ &quot;-請假單(&quot;+Sn+&quot;)已審核通過&quot;; // Mail Subject
	var size = tableList.size();
	var text = &quot;&lt;div align=\&quot;left\&quot; style=\&quot;font-size: 9pt; font-family: Arial\&quot;&gt;&quot;
		     + &quot;Dear Sir,&lt;p&gt; &quot;+appname+&quot; 通過了請假單申請，請假內容如下，請參考：&lt;/p&gt;&quot;
			 + &quot;  &lt;table border=\&quot;1\&quot; cellpadding=\&quot;2\&quot; cellspacing=\&quot;0\&quot; width=\&quot;800\&quot; bordercolordark=\&quot;#FFFFFF\&quot; id=\&quot;table1\&quot; style=\&quot;font-size: 9pt; font-family: Arial\&quot;&gt;&quot;
			 + &quot;    &lt;tr style=\&quot;font-size: 9PT; font-family: Arial; line-height: 100%; border: 1px outset #FFFFFF;line-height:150%\&quot;&gt;&quot;
			 + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;150\&quot;&gt;請假人&lt;/td&gt;&quot;
			 + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;150\&quot;&gt;假別&lt;/td&gt;&quot;
			 + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;120\&quot;&gt;請假日&lt;/td&gt;&quot;
			 + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;80\&quot;&gt;時數&lt;/td&gt;&quot;
			 + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;80\&quot;&gt;時段&lt;/td&gt;&quot;
			 + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;220\&quot;&gt;事由&lt;/td&gt;&quot;
			 + &quot;      &lt;/td&gt;&quot;
			 + &quot;    &lt;/tr&gt;&quot;;
	for(var i=0;i&lt;size;i++){
		var rowData = tableList.get(i);
		var apptype = rowData.get(&quot;ITEM3&quot;);// 假別
		var appdate = rowData.get(&quot;ITEM4&quot;);// 日期
		var apptime = rowData.get(&quot;ITEM5&quot;);// 時間
		var reason = rowData.get(&quot;ITEM9&quot;);// 理由
		var timecnt = rowData.get(&quot;ITEM7&quot;);
		text = text + &quot;    &lt;tr&gt;&lt;form method=\&quot;POST\&quot; NAME = \&quot;NEWFORM\&quot;&gt;&quot;
			        + &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+appname+&quot; / &quot;+empno + &quot; / &quot; + appdpt + &quot;&lt;/td&gt;&quot;
					+ &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+apptype+&quot;&lt;/td&gt;&quot;
					+ &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+appdate+&quot;&lt;/td&gt;&quot;
					+ &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+timecnt+&quot;&lt;/td&gt;&quot;
					+ &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+apptime+&quot;&lt;/td&gt;&quot;
					+ &quot;      &lt;td align=\&quot;left\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+reason+&quot;&lt;/td&gt;&quot;
					+ &quot;      	&lt;/td&gt;&lt;/tr&gt;&quot;;
	}
	var text = text + &quot; &lt;/table&gt;&quot;;
	Server.sendHTMLMail(from,to,subject,text);
	//手動加入廠長請假結案通知副董功能 add by yingchieh@20120913
	//移除通知 add by yingchieh@20171208
	//if (cname.equals(&quot;蔡錦松&quot;)){
	//	Server.sendHTMLMail(from,Server.getMemberByID(&quot;MEMT1012627&quot;).getEmail(),subject,text);
	//}
}

// 設定直屬主管 , 同時也要設定主管的roleID
function setManager(){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var App_MemID = dataMap.get(&quot;Next_Member_ID&quot;);// 使用目前的主管來設定下一層的主管	
	//加入特殊流程
	var vec;
	var sql = &quot;select * from a_parameter_data where parameter =&apos;HR_FLOW_SPECIAL&apos; and value2=&apos;MEMT1&quot;+dataMap.get(&quot;App_ID&quot;)+&quot;&apos;&quot;;
	vec = Server.SQLloadValue(sql);
	if (vec.size()&gt;0){//特殊簽核流程人員名單中,用等殊簽核流程的來顯示
		var list = vec.get(0).get(&quot;remarks&quot;).split(&quot;;&quot;);
		for (var i = 0 ; i&lt; list.length ; i++){
			if (list[i].equals(App_MemID)){//如果等於，則抓取下一階主管
				if (i == list.length-1){
					Manager_ID = Server.getMemberByID(App_MemID).getPager(); //getMember modi by wangwei@2013/04/11
				}else{
					Manager_ID = list[i+1];
				}
			}
		}
	}else{
		var App_mem = Server.getMemberByID(App_MemID); //getMember modi by wangwei@2013/04/11
		var Manager_ID = &quot;Administrator&quot;;
		if(App_mem != null){
			Manager_ID = App_mem.getPager();
		}
	}
	dataMap.put(&quot;Next_Member_ID&quot;,Manager_ID);	
	dataMap.put(&quot;Manager_ID&quot;,Manager_ID);	
}

function sendRejectMail(groupname){
	var aInstance = MyTask.getArtInstance(); 
	var dataMap = aInstance.getAppDataMap(); 
	var Sn = dataMap.get(&quot;Sn&quot;);
	var cname = dataMap.get(&quot;App_Name&quot;);
	var frontTask = Server.getTask(MyTask.getFrontID());//上一開task
	var frontRealExecutorID = frontTask.getRealExecutor();//上一關執行者
	var from = Server.getMemberByID(frontRealExecutorID).getEmail();//上一關執行者email 

	var to = Server.getMemberByID(dataMap.get(&quot;App_MemID&quot;)).getEmail();  //getMember modi by wangwei@2013/04/11
	if(to.indexOf(&quot;wtadmin&quot;)&gt;=0){
		to = &quot;&quot;;
	}
	var creator_mail = Server.getMemberByID(dataMap.get(&quot;Creator_ID&quot;)).getEmail();//getMember modi by wangwei@2013/04/11
	if( to != creator_mail ){
		to += &quot;;&quot; + creator_mail;
	}
	var cc=&quot;&quot;;
	var etID = &quot;ETP00031229409324433&quot;;// email template id.
	var fileList = new java.util.Vector();
	Server.sendTemplateMail(from,to,cc,etID,fileList,MyTask.getID(),true);
}

//換休申請單的結案通知
function sendAcceptMailR1(){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var insID = dataMap.get(&quot;insID&quot;);//單號
		var App_Name = dataMap.get(&quot;App_Name&quot;);
		var App_ID = dataMap.get(&quot;App_ID&quot;);
		var App_Dep_ID = dataMap.get(&quot;App_Dep_ID&quot;);//部門
		var App_date = dataMap.get(&quot;App_date&quot;);//出勤日
		var TT = dataMap.get(&quot;TT&quot;);//總時數
		var memo = dataMap.get(&quot;remind&quot;);//人資備註,寫在Verify_Note內
		var Times = dataMap.get(&quot;StartTime_H&quot;)+&quot;:&quot;+dataMap.get(&quot;StartTime_M&quot;)+&quot; - &quot;+ dataMap.get(&quot;EndTime_H&quot;)+&quot;:&quot;+dataMap.get(&quot;EndTime_M&quot;);
		var abstypeInfo = dataMap.get(&quot;abstypeInfo&quot;);//換休類型
		var txtTotal = dataMap.get(&quot;txtTotal&quot;);//時數
		var Creator = dataMap.get(&quot;Creator&quot;);
		//var from = Server.getMember(dataMap.get(&quot;Verify_Name&quot;)).getEmail();
		var from = &quot;hr@gce.com.tw&quot;;
		var to = Server.getMemberByID(dataMap.get(&quot;App_MemID&quot;)).getEmail();
		if(to.indexOf(&quot;wtadmin&quot;)&gt;=0){
			to = &quot;&quot;;
		}		
		var creator_mail = Server.getMemberByID(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		var RecordInfo = dataMap.get(&quot;RecordInfo&quot;);
		var size = RecordInfo.size();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}
		//G-20110942，廠務請換休假，CC給若云。
		if (App_Dep_ID.equals(&quot;2P0&quot;) || App_Dep_ID.equals(&quot;2P1&quot;) || App_Dep_ID.equals(&quot;2P2&quot;) ||
			App_Dep_ID.equals(&quot;2P3&quot;) || App_Dep_ID.equals(&quot;2P8&quot;) || App_Dep_ID.equals(&quot;2PA&quot;)){
				to += &quot;;&quot; + Server.getMemberByID(&quot;MEMT1007663&quot;).getEmail();
		}
		var cc=&quot;&quot;;
		var table = &quot;&lt;table border=\&quot;1\&quot; cellpadding=\&quot;2\&quot; cellspacing=\&quot;0\&quot; width=\&quot;560\&quot; bordercolordark=\&quot;#FFFFFF\&quot; id=\&quot;table1\&quot; style=\&quot;font-size: 9pt; font-family: Arial\&quot;&gt;&quot;
  				  + &quot; 	&lt;tr style=\&quot;font-size: 9PT; font-family: Arial; line-height: 100%; border: 1px outset #FFFFFF;line-height:150%\&quot;&gt;&quot;
				  + &quot;   	&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;120\&quot;&gt;申請人&lt;/td&gt;&quot;
				  + &quot;   	&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;120\&quot;&gt;換休類型&lt;/td&gt;&quot;
				  + &quot;       &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;120\&quot;&gt;出勤日&lt;/td&gt;&quot;
				  + &quot;       &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;120\&quot;&gt;出勤時段&lt;/td&gt;&quot;
				  + &quot;       &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;80\&quot;&gt;時數&lt;/td&gt;&quot;
				  + &quot;   &lt;/tr&gt;&quot;;
		for(var i=0;i&lt;size;i++){
			 var rowData = RecordInfo.get(i);
			 var App_date = rowData.get(&quot;ITEM3&quot;);// 日期
			 var Times = rowData.get(&quot;ITEM4&quot;);// 時段
			 var txtTotal = rowData.get(&quot;ITEM5&quot;);// 時數
			 table += &quot;&lt;tr&gt;&quot;
		           +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+App_Name+&quot; / &quot;+App_Dep_ID+&quot;&lt;/td&gt;&quot;
				   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+abstypeInfo+&quot;&lt;/td&gt;&quot;
				   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+App_date+&quot;&lt;/td&gt;&quot;
				   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+Times+&quot;&lt;/td&gt;&quot;
				   +  &quot;&lt;td align=\&quot;left\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+txtTotal+&quot;&lt;/td&gt;&quot;
				   +  &quot;&lt;/tr&gt;&quot;;
		 }
		table +=  &quot;&lt;/table&gt;&quot;;
        var subject = &quot;[結案通知]換休申請單:&quot;+App_Name+ &quot;-換休申請單(&quot;+insID+&quot;)已審核通過&quot;; // Mail Subject
		var text = &quot;&lt;table border=\&quot;0\&quot; width=\&quot;100%\&quot; style=\&quot;font-size: 11pt; font-family: Tahoma\&quot; height=\&quot;321\&quot;&gt;&quot;
				 + &quot;	&lt;tr&gt;&quot;
				 + &quot;	&lt;td height=\&quot;293\&quot;&gt;&quot;
				 + &quot;		&lt;font size=2&gt;Dear Sir,&lt;/font&gt;&quot;
				 + &quot;		&lt;p&gt;&lt;font size=2&gt;您申請的換休申請單(&quot;+insID+&quot;)，已簽核完畢。&lt;/font&gt;&lt;/p&gt;&quot;
				 + &quot;		&lt;blockquote&gt;&quot;
				 + &quot;&lt;p&gt;&lt;font size=2&gt;流程名稱：換休申請單&lt;br&gt;&quot;
				 + &quot;&lt;p&gt;&lt;font size=2&gt;填單者：&quot;+Creator+&quot;&lt;/font&gt;&lt;/p&gt;&quot;
				 + &quot;&lt;p&gt;&lt;font size=2&gt;人資核定時數：&quot;+TT+&quot; 小時&lt;/font&gt;&lt;/p&gt;&quot;
				 + &quot;&lt;p&gt;&lt;font size=2&gt;人資備註：&quot;+memo+&quot;&lt;/font&gt;&lt;/p&gt;&quot;
				 + table
				 + &quot;&lt;p&gt;&lt;font size=2&gt;操作上有任何問題 請與&lt;a href=\&quot;http://mygce/eip/portal/oa/formList.jsp?n=002\&quot;&gt;資訊處&lt;/a&gt;聯絡 &lt;/p&gt;&quot;
				 + &quot;&lt;/blockquote&gt;&quot;
				 + &quot;&lt;p&gt;&lt;/td&gt;&quot;
				 + &quot;&lt;/tr&gt;&quot;
				 + &quot;&lt;tr&gt;&quot;
				 + &quot;&lt;td bgcolor=\&quot;#336699\&quot; style=\&quot;font-size: 9pt; font-family: Tahoma\&quot;&gt;&quot;
				 + &quot;&lt;p align=\&quot;center\&quot;&gt;&lt;font color=\&quot;#FFFFFF\&quot;&gt;MyGCE All New Flow System&lt;/font&gt;&lt;/td&gt;&quot;
				 + &quot;&lt;/tr&gt;&quot;
				 + &quot;&lt;/table&gt;&quot;
        var fileList = new Packages.java.util.Vector();
		Server.sendHTMLMail(from,to,subject,text);
		//測試程式用，程式穩定後可刪除 add by yingchiehwang@20110302
//		Server.sendHTMLMail(from,&quot;yingchieh_wang@gce.com.tw&quot;,subject,text + to);
	}catch(e){
		java.lang.System.out.println(e);
	}
}

//取簽核記錄
function getProcHistTable(){
	loadLibrary(&quot;com.A.Common.Server.ProcessTable&quot;);
	var procHist = &quot;&quot;;
	var vec = getProcessTable();
	procHist =  &quot;&lt;table border=\&quot;1\&quot; cellpadding=\&quot;2\&quot; cellspacing=\&quot;0\&quot; width=\&quot;720\&quot; bordercolordark=\&quot;#FFFFFF\&quot; id=\&quot;table1\&quot; style=\&quot;font-size: 9pt; font-family: Arial\&quot;&gt;&quot;;
  	procHist += &quot;    &lt;tr style=\&quot;font-size: 9PT; font-family: Arial; line-height: 100%; border: 1px outset #FFFFFF;line-height:150%\&quot;&gt;&quot;;
	procHist += &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;50\&quot;&gt;序號&lt;/td&gt;&quot;;
	procHist += &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;100\&quot;&gt;審核日期&lt;/td&gt;&quot;;
	procHist += &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;100\&quot;&gt;關卡名稱&lt;/td&gt;&quot;;
	procHist += &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;100\&quot;&gt;部門&lt;/td&gt;&quot;;
	procHist += &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;100\&quot;&gt;職稱&lt;/td&gt;&quot;;
	procHist += &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;80\&quot;&gt;工號&lt;/td&gt;&quot;;
	procHist += &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;80\&quot;&gt;姓名&lt;/td&gt;&quot;;
	procHist += &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;40\&quot;&gt;是否核准&lt;/td&gt;&quot;;
	procHist += &quot;      &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;200\&quot;&gt;審核意見&lt;/td&gt;&quot;;
	procHist += &quot;      &lt;/td&gt;&quot;;
	procHist += &quot;    &lt;/tr&gt;&quot;;
	for(var i =0 ; i &lt; vec.size() ; i++){
		procHist += &quot; &lt;tr&gt;&quot;
		procHist += &quot; &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+vec.get(i).get(&quot;ITEM7&quot;)+&quot;&lt;/td&gt;&quot;
		procHist += &quot; &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+vec.get(i).get(&quot;ITEM5&quot;)+&quot;&lt;/td&gt;&quot;
		procHist += &quot; &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+vec.get(i).get(&quot;ITEM8&quot;)+&quot;&lt;/td&gt;&quot;
		procHist += &quot; &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+vec.get(i).get(&quot;ITEM6&quot;)+&quot;&lt;/td&gt;&quot;
		procHist += &quot; &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+vec.get(i).get(&quot;ITEM9&quot;)+&quot;&lt;/td&gt;&quot;
		procHist += &quot; &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+vec.get(i).get(&quot;ITEM2&quot;)+&quot;&lt;/td&gt;&quot;
		procHist += &quot; &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+vec.get(i).get(&quot;ITEM4&quot;)+&quot;&lt;/td&gt;&quot;
		procHist += &quot; &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+vec.get(i).get(&quot;ITEM3&quot;)+&quot;&lt;/td&gt;&quot;
		procHist += &quot; &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+vec.get(i).get(&quot;ITEM1&quot;)+&quot;&lt;/td&gt;&quot;
		procHist += &quot; &lt;/tr&gt;&quot;;
	}	
	procHist += &quot;&lt;/table&gt;&quot;;
	return procHist;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>請假單相關函式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011227857292197</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/08/27 13:27:00</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Util.Utils</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011227857292197</string> 
     </void> 
     <void property="name"> 
      <string>Utils</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011227857277675</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function getInt(abc){//傳入String，捨小數點後位數,並回傳整數值
	var abcInt = &quot;&quot;;
	var st = new java.util.StringTokenizer(abc, &quot;.&quot;);
    if (st.hasMoreTokens()) {
		abcInt = st.nextToken();
    }
    return java.lang.Integer.parseInt(abcInt);
}

function customCheckDateFormat(date){// 檢查日期格式是否錯誤YYYY/MM/DD(String格式)
	var dates = date.split(&quot;/&quot;);
	var year = dates[0];
	var month = dates[1];
	var day = dates[2];
	if(!(dates.length==3) || !(year.length()==4) || !(month.length()==2) || !(day.length()==2)){// 格式不符 &quot;YYYY/MM/DD&quot;
		return false;
	}
	try{
		year = java.lang.Integer.parseInt(year);
		month = java.lang.Integer.parseInt(month);
		day = java.lang.Integer.parseInt(day);
	}catch(e){// 代表有輸入字串
		return false;
	}
	month -= 1;// 因為Calendar月份是0~11
	if(month&lt;0||month&gt;11){
		return false;
	}
	var cal = java.util.Calendar.getInstance();
	cal.set(cal.YEAR,year);
	cal.set(cal.MONTH,month);
	var maxDay = cal.getActualMaximum(cal.DAY_OF_MONTH);
	if(day&gt;maxDay||day&lt;1){// 檢查日期是否超過
		return false;
	}
	return true;
}

function getDBName(){//取得短期資料庫的名稱
	return &quot;T-MES&quot;;
}

function loadSQL(sql,dbName){// 取得查詢結果from db
	var conn = Client.createSessionConnection(dbName);
	var vec = new java.util.Vector();
	try{
		vec = conn.loadValue(sql);
	}catch(e){
		Client.addErrLog(&quot;loadSQL錯誤:com.gce.HR.Util.Utils&quot;);
		Client.addErrLog(&quot;語法為:&quot;+sql);
		Client.addErrLog(e.message);
	}finally{
		conn.close();
	}
	return vec;
}

function getMaxVerID(doc_id){
	try{		
		var conn = Client.createSessionConnection(&quot;EKM&quot;);
		var sql = &quot;  select doc_id,max(ver_id) ver_id from ekm.TECHDOC_VERSION  where doc_id like &apos;&quot;+ doc_id +&quot;&apos; group by  doc_id &quot;;
		var vec = conn.loadValue(sql);
		if(vec != null &amp;&amp; vec.size()&gt;0){
			ver_id = vec.get(0).get(&quot;ver_id&quot;).trim();
		}		
	}catch(e){
		conn.rollback();
	}finally{
		conn.close();
	}	
	return ver_id;
}

//寄送錯誤訊息信
function sendErrorMail_Client(msg){
	var artid = Form.getCurrentTask().getArtInstance().getArtifactID();
	var artifact = Form.getArtifact();//表單名稱
	var member = Client.getCurrentMember();
	var mailFrom = &quot;mygce@gce.com.tw&quot;;//寄
	var mailto   = &quot;yingchieh_wang@gce.com.tw&quot;;//收
	var content  = &quot;AF表單異常通知 -&quot; + Packages.pase.agenda.MyDate() +&quot;&lt;br&gt;&quot;
				 + &quot;執行者：&quot; + member + &quot;-&quot; + member.getMyID() + &quot;-&quot; +  member.getOfficePhone() + &quot;&lt;br&gt;&quot;
				 + &quot;錯誤訊息：&quot; + msg;
	var subject  = artifact+&quot;異常通知!&quot;;
    var vector = new java.util.Vector();			
	var task =  Form.getCurrentTask();
	Client.sendHTMLMailExt(mailFrom,mailto,&quot;&quot;,subject,content,vector,task.getID());
}

// 回傳今天星期幾(大陸廠)(已確認)
function checkWeek(dayOfWeekIndex){
	var dayOfWeek;
	switch(dayOfWeekIndex){
		case 1:
			dayOfWeek = &quot;星期一&quot;;
			break;
		case 2:
			dayOfWeek = &quot;星期二&quot;;
			break;
		case 3:
			dayOfWeek = &quot;星期三&quot;;
			break;
		case 4:
			dayOfWeek = &quot;星期四&quot;;
			break;
		case 5:
			dayOfWeek = &quot;星期五&quot;;
			break;
		case 6:
			dayOfWeek = &quot;星期六&quot;;
			break;
		default:
			dayOfWeek = &quot;星期日&quot;;
			break;
	}
	return dayOfWeek;
}

function getApptypeCname(abstype){
	var abscname=&quot;請假&quot;;
	if(abstype==&quot;B&quot;||abstype.equals(&quot;B&quot;)){
		abscname = &quot;一般事假&quot;;		
	}else if(abstype==&quot;B2&quot;||abstype.equals(&quot;B2&quot;)){
		abscname = &quot;遲到事假&quot;;		
	}else if(abstype==&quot;D&quot;||abstype.equals(&quot;D&quot;)){
		abscname = &quot;病假&quot;;		
	}else if(abstype==&quot;D2&quot;||abstype.equals(&quot;D2&quot;)){
		abscname = &quot;長病假&quot;;
	}else if(abstype==&quot;G&quot;||abstype.equals(&quot;G&quot;)){
		abscname = &quot;公假&quot;;		
	}else if(abstype==&quot;G3&quot;||abstype.equals(&quot;G3&quot;)){
		abscname = &quot;返台假&quot;;	
	}else if(abstype==&quot;H&quot;||abstype.equals(&quot;H&quot;)){
		abscname = &quot;工傷假&quot;;
	}else if(abstype==&quot;I&quot;||abstype.equals(&quot;I&quot;)){
		abscname = &quot;年假&quot;;
	}else if(abstype==&quot;J&quot;||abstype.equals(&quot;J&quot;)){
		abscname = &quot;婚假&quot;;
	}else if(abstype==&quot;K&quot;||abstype.equals(&quot;K&quot;)){
		abscname = &quot;產假&quot;;		
	}else if(abstype==&quot;K4&quot;||abstype.equals(&quot;K4&quot;)){
		abscname = &quot;晚育假&quot;;		
	}else if(abstype==&quot;K5&quot;||abstype.equals(&quot;K5&quot;)){
		abscname = &quot;流產假&quot;;	
	}else if(abstype==&quot;K6&quot;||abstype.equals(&quot;K6&quot;)){
		abscname = &quot;護理假&quot;;		
	}else if(abstype==&quot;P&quot;||abstype.equals(&quot;P&quot;)){
		abscname = &quot;產前檢查假&quot;;		
	}else if(abstype==&quot;M&quot;||abstype.equals(&quot;M&quot;)){
		abscname = &quot;有薪事假&quot;;
	}else if(abstype==&quot;L&quot;||abstype.equals(&quot;L&quot;)){
		abscname = &quot;喪假&quot;;		
	}else if(abstype==&quot;R&quot;||abstype.equals(&quot;R&quot;)){
		abscname = &quot;調休假&quot;;
	}else if(abstype==&quot;Q&quot;||abstype.equals(&quot;Q&quot;)){
		abscname = &quot;哺乳假&quot;;				
	}else if(abstype==&quot;S&quot;||abstype.equals(&quot;S&quot;)){
		abscname = &quot;排休假&quot;;					
	}else if(abstype==&quot;V&quot;||abstype.equals(&quot;V&quot;)){
		abscname = &quot;年假(T)&quot;;		
	}
	return abscname;
}


function loadSQL_new(sql , dbName , type){// 取得查詢結果from db
	var conn = Client.createSessionConnection(dbName);
	var vec = new java.util.Vector();
	try{
		vec = conn.loadValue(sql);
		Client.addDebugLog(&quot;type:&quot;+type);
		Client.addDebugLog(&quot;語法為:&quot;+sql);
	}catch(e){
		Client.addErrLog(&quot;loadSQL錯誤:com.gce.HR.Util.Utils&quot;);
		Client.addErrLog(&quot;type:&quot;+type);
		Client.addErrLog(&quot;語法為:&quot;+sql);
		Client.addErrLog(e.message);
	}finally{
		conn.close();
	}
	return vec;
}

//台灣廠假別代碼中文(直接讀參數檔速度會變很慢) 
//add by yingchieh@20161115
function getApptypeCname_TGCE(abstype){
	var abscname=&quot;&quot;;
	if(abstype==&quot;A&quot;||abstype.equals(&quot;A&quot;)){
		abscname = &quot;曠工&quot;;
	}else if(abstype==&quot;B&quot;||abstype.equals(&quot;B&quot;)){
		abscname = &quot;事假&quot;;
	}else if(abstype==&quot;B1&quot;||abstype.equals(&quot;B1&quot;)){
		abscname = &quot;家庭照顧假&quot;;					
	}else if(abstype==&quot;D&quot;||abstype.equals(&quot;D&quot;)){
		abscname = &quot;未住院病假&quot;;					
	}else if(abstype==&quot;D1&quot;||abstype.equals(&quot;D1&quot;)){
		abscname = &quot;生理假&quot;;	
	}else if(abstype==&quot;D2&quot;||abstype.equals(&quot;D2&quot;)){
		abscname = &quot;住院病假&quot;;
	}else if(abstype==&quot;D3&quot;||abstype.equals(&quot;D3&quot;)){
		abscname = &quot;安胎假&quot;;				
	}else if(abstype==&quot;G&quot;||abstype.equals(&quot;G&quot;)){
		abscname = &quot;公假&quot;;
	}else if(abstype==&quot;G1&quot;||abstype.equals(&quot;G1&quot;)){
		abscname = &quot;出差假&quot;;
	}else if(abstype==&quot;G2&quot;||abstype.equals(&quot;G2&quot;)){
		abscname = &quot;訓練假&quot;;
	}else if(abstype==&quot;G3&quot;||abstype.equals(&quot;G3&quot;)){
		abscname = &quot;返台假&quot;;
	}else if(abstype==&quot;H&quot;||abstype.equals(&quot;H&quot;)){
		abscname = &quot;公傷假&quot;;					
	}else if(abstype==&quot;H1&quot;||abstype.equals(&quot;H1&quot;)){
		abscname = &quot;公傷假(超過三日)&quot;;		
	}else if(abstype==&quot;I&quot;||abstype.equals(&quot;I&quot;)){
		abscname = &quot;特休假&quot;;		
	}else if(abstype==&quot;J&quot;||abstype.equals(&quot;J&quot;)){
		abscname = &quot;婚假&quot;;					
	}else if(abstype==&quot;K&quot;||abstype.equals(&quot;K&quot;)){
		abscname = &quot;產假&quot;;
	}else if(abstype==&quot;K1&quot;||abstype.equals(&quot;K1&quot;)){
		abscname = &quot;流產假&quot;;
	}else if(abstype==&quot;K2&quot;||abstype.equals(&quot;K2&quot;)){
		abscname = &quot;流產假&quot;;
	}else if(abstype==&quot;K3&quot;||abstype.equals(&quot;K3&quot;)){
		abscname = &quot;流產假&quot;;
	}else if(abstype==&quot;L&quot;||abstype.equals(&quot;L&quot;)){
		abscname = &quot;喪假&quot;;	
	}else if(abstype==&quot;M&quot;||abstype.equals(&quot;M&quot;)){
		abscname = &quot;有薪事假&quot;;		
	}else if(abstype==&quot;N&quot;||abstype.equals(&quot;N&quot;)){
		abscname = &quot;無薪事假&quot;;				
	}else if(abstype==&quot;O&quot;||abstype.equals(&quot;O&quot;)){
		abscname = &quot;補休&quot;;
	}else if(abstype==&quot;P&quot;||abstype.equals(&quot;P&quot;)){
		abscname = &quot;產檢假&quot;;		
	}else if(abstype==&quot;Q&quot;||abstype.equals(&quot;Q&quot;)){
		abscname = &quot;育嬰假&quot;;
	}else if(abstype==&quot;R&quot;||abstype.equals(&quot;R&quot;)){
		abscname = &quot;換休假&quot;;  
	}else if(abstype==&quot;R1&quot;||abstype.equals(&quot;R1&quot;)){
		abscname = &quot;換休假&quot;;
	}else if(abstype==&quot;R3&quot;||abstype.equals(&quot;R3&quot;)){
		abscname = &quot;換休假&quot;;
	}else if(abstype==&quot;T&quot;||abstype.equals(&quot;T&quot;)){
		abscname = &quot;預支特休&quot;; 				
	}else if(abstype==&quot;1&quot;||abstype.equals(&quot;1&quot;)){
		abscname = &quot;遲到&quot;;						
	}else if(abstype==&quot;2&quot;||abstype.equals(&quot;2&quot;)){
		abscname = &quot;早退&quot;;
	}else if(abstype==&quot;3&quot;||abstype.equals(&quot;3&quot;)){
		abscname = &quot;遲到+早退&quot;;
	}
	return abscname;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>常用的函式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00011366944386927</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2014/06/18 17:06:01</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.WorkingTime</string> 
     </void> 
     <void property="id"> 
      <string>SCL00011366944386927</string> 
     </void> 
     <void property="name"> 
      <string>WorkingTime</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function sortTable(tableName, col){
		//以下處理簽核紀錄表格排序 
	    var signTable = Form.getComponent(tableName); 
	    var vec = java.util.Vector(); 
	    for( var l = 0, p = signTable.getRowCount(); l &lt; p; l++){  
	         var rowData = signTable.getRowData(l);  
	         var signTime = rowData.get(col);  
	         rowData.put(col, signTime);  
	         vec.add(rowData); 
	    }  
	    var LList = new java.util.LinkedList();
	    for(var a = 0, b = vec.size(); a &lt; b; a++){  
	        insertNum = vec.get( a ).get(col);    
	        if(LList.size() == 0){   
	           LList.add(0, vec.get( a ));   
	           continue;  
	        }    
			for(var i = 0, j = LList.size(); i &lt; j; i ++){   
				if( insertNum &lt; LList.get( i ).get(col)){    
				    LList.add(0, vec.get( a ));    
				    break;   
				}else if(i+1 &lt; j){     
			        if( insertNum &gt;= LList.get( i ).get(col) &amp;&amp; insertNum &lt; LList.get(i+1).get(col)){     
						LList.add(i+1, vec.get( a ));     
						break;    
					}   
				}else if(i+1 &gt;= j){    
					LList.addLast(vec.get( a ));    
					break;   
				}  
			} 
		} 
	    var newSignTable = java.util.Vector(); 
	    for(var r = 0, s = LList.size(); r &lt; s; r++){  
	    	newSignTable.add(LList.get(r));  
			var signTime = LList.get(r).get(col).toString();  
			LList.get(r).put(col, signTime); 
	    } 
	    Form.setValue(tableName, newSignTable);
	}
	function setHR(factory){
		var sql =  &quot;select value1 HR,value2 HRPM1,value3 HRPM2 ,description HRPM3 from a_parameter_data &quot;;
			sql += &quot;where parameter = &apos;HR_SCH_WORKINGHOURS&apos; and key1 =&apos;&quot; + factory + &quot;&apos;&quot;;
		var vec = Client.SQLloadValue(sql);
		if (vec.size() &gt; 0){
			Form.setValue(&quot;HR&quot;,vec.get(0).get(&quot;HR&quot;));
			Form.setValue(&quot;HRPM1&quot;,vec.get(0).get(&quot;HRPM1&quot;));
			Form.setValue(&quot;HRPM2&quot;,vec.get(0).get(&quot;HRPM2&quot;));
			Form.setValue(&quot;HRPM3&quot;,vec.get(0).get(&quot;HRPM3&quot;));
		}else{//如果抓不到資料則無法送出簽核
			Form.showMessageDialog(&quot;無法取得人事主辦、人事主管名單，請與資訊處聯絡。&quot;);
		}		
	}
	function setVerifyLevel(factory){
		var dptno =Form.getValue(&quot;dptno&quot;)
		var dptid = &quot;DEP&quot; + factory.substring(0,1) + dptno;
		var dep = Client.getDepartment(dptid);
		var SUVERVISOR = dep.getResopnsibility().split(&quot;;&quot;)[1];
		if (SUVERVISOR.equals(&quot;MEMT1003694&quot;)){
			SUVERVISOR = dep.getResopnsibility().split(&quot;;&quot;)[0];
		}
		var member = Client.getMemberByID(SUVERVISOR);
		var memberRoleID = member.getMainRoleID();
		var mbrLv = Client.getRole(memberRoleID).getMyID();
		Form.setValue(&quot;Verify_Level&quot;,mbrLv);
	}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>大陸三廠工時異常相關函數</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021096524133452</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/09/30 14:02:13</string> 
     </void> 
     <void property="fullName"> 
      <string>com.flowring.project.leave.leaveApply</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021096524133452</string> 
     </void> 
     <void property="name"> 
      <string>leaveApply</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00061096524105449</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//script library &quot;com.flowring.project.leave.leaveApply&quot;

//審核關卡若是代理人代審時在表單上fieldName欄位註記,原欄位內容向下推一行
function checkDeputySign(fieldName) {
	var mID = MyTask.getMemberID(); //會抓到真正task owner
	var realID = MyTask.getRealExecutor();//目前Task 的執行者member id
	if (!mID.equals(realID)) {
		var realMember = Client.getMemberByID(realID);
		Form.setValue(fieldName, &quot;本工作為由代理人 &quot; + realMember.getName() + &quot; 處理\n&quot; +  Form.getValue(fieldName));
	}
}


//簽核歷程表格加入一筆
function appendProcessTable(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;processTable&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數
	
	var hm = java.util.HashMap();
	var proName = MyTask.getProcessName();//關卡名稱
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	var Ob_date = new Packages.pase.agenda.MyDate();
	var Is_date = Ob_date.getCurrentDate();
	hm.put(&quot;ITEM5&quot;, Is_date);
	hm.put(&quot;ITEM6&quot;, department);//Department 部門
	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
	hm.put(&quot;ITEM4&quot;, name);//Name 姓名
	if (isAgree == true) {
		hm.put(&quot;ITEM3&quot;,&quot;true&quot;);//同意
		hm.put(&quot;ITEM2&quot;,&quot;false&quot;);
	} else {
		hm.put(&quot;ITEM3&quot;,&quot;false&quot;);
		hm.put(&quot;ITEM2&quot;,&quot;true&quot;);
	}
	hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
	
	vecTableData.add(rowCount,hm);
	aInstance.setAppValue(&quot;processTable&quot;,vecTableData);
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021105070711231</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.AssignApprovalManager</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021105070711231</string> 
     </void> 
     <void property="name"> 
      <string>AssignApprovalManager</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//放入預設的簽核主管
function setDefaultManager(){
	var task = Form.getCurrentTask();
	var mID = task.getRealExecutor();
      
	var cMember = Client.getMemberByID(mID);
	var memRoleID = cMember.getMainRoleID();
	var memDR = cMember.getMemberDR(memRoleID);
	var department = Client.getDepartment(memDR.getDepartmentID());

	var managerRoleID = department.getManagerID();
	var managerRole = Client.getRole(managerRoleID);
	var managerID = managerRole.getMemberList().get(0);
	var manager = Client.getMemberByID(managerID);
	Form.setValue(&quot;txtNextHandlerName&quot;, manager.getName());
	Form.setValue(&quot;txtNextHandlerID&quot;, managerID);
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>指定審核人員</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021110507127984</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/03/11 10:12:08</string> 
     </void> 
     <void property="fullName"> 
      <string>com.flowring.oa</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021110507127984</string> 
     </void> 
     <void property="name"> 
      <string>oa</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011181776157390</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//查詢所有員工假別時數的資料，並載入到Table中
function searchAllEmpData() {
	var table = Form.getComponent(&quot;Table1&quot;);
	table.clear();
	var str = &quot;SELECT MemID, UserName, ID FROM Mem_GenInf WHERE MemID != &apos;Administrator&apos; AND Resign = &apos;false&apos; ORDER BY ID&quot;;
	var RecordSet = Client.SQLloadValue(str);
	for (var i = 0; i &lt; RecordSet.size(); i++) {
		var ht = RecordSet.get(i);
		var memID = ht.get(&quot;MemID&quot;);
		var member = Client.getMemberByID(memID);
		try {
			var mainRID = member.getMainRoleID();
			var memberDR = member.getMemberDR(mainRID);
			var depName = memberDR.getDepartmentName();
			var roleName = memberDR.getRoleName();
		} catch(e) {
			continue;
		}
		var row = table.newRow() - 1;
		var id = ht.get(&quot;ID&quot;);		
		var userName = ht.get(&quot;UserName&quot;);
		table.setValueAt(depName, row, &quot;部門&quot;);
		table.setValueAt(roleName, row, &quot;職稱&quot;);
		table.setValueAt(id, row, &quot;員工編號&quot;);
		table.setValueAt(userName, row, &quot;姓名&quot;);
		var j = java.lang.Integer.toString(i+1);
		table.setValueAt(memID, row, &quot;MEMID&quot;);
		table.setValueAt(j, row, &quot;序&quot;);
		
		var str_s = &quot;SELECT * FROM art01411136514214625_ins WHERE InsID = &apos;&quot; + memID + &quot;&apos;&quot;;           
		var s_s = Client.SQLloadValue(str_s);
		if (s_s.size() &gt; 0) {
			var hh = s_s.get(0);
			table.setValueAt(hh.get(&quot;ITEM3&quot;), row, &quot;特休&quot;);
			table.setValueAt(hh.get(&quot;ITEM4&quot;), row, &quot;補休&quot;);
			table.setValueAt(hh.get(&quot;ITEM5&quot;), row, &quot;彈休&quot;);
			table.setValueAt(hh.get(&quot;ITEM6&quot;), row, &quot;給薪病假&quot;);
			table.setValueAt(hh.get(&quot;ITEM7&quot;), row, &quot;扣薪病假&quot;);
			table.setValueAt(hh.get(&quot;ITEM8&quot;), row, &quot;事假&quot;);
			table.setValueAt(hh.get(&quot;ITEM14&quot;), row, &quot;生理假&quot;);
			table.setValueAt(hh.get(&quot;ITEM15&quot;), row, &quot;公假&quot;);
			table.setValueAt(hh.get(&quot;ITEM9&quot;), row, &quot;家庭照顧假&quot;);
			table.setValueAt(hh.get(&quot;ITEM10&quot;), row, &quot;婚假&quot;);
			table.setValueAt(hh.get(&quot;ITEM11&quot;), row, &quot;產假&quot;);
			table.setValueAt(hh.get(&quot;ITEM12&quot;), row, &quot;流產假&quot;);
			table.setValueAt(hh.get(&quot;ITEM13&quot;), row, &quot;陪產假&quot;);
			table.setValueAt(hh.get(&quot;ITEM16&quot;), row, &quot;喪假&quot;);
		}
	}
} 
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021132401004006</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/11/19 19:50:04</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.SystemFunction.CustomKeyWordFormat</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021132401004006</string> 
     </void> 
     <void property="name"> 
      <string>CustomKeyWordFormat</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function updateKeyWord(objIssueNo){
		//將單號及主旨加到工作主題中
		var keyWord = Form.getCurrentTask().getKeyWord();
		var newKeyWord = &quot;[&quot; + Form.getValue(objIssueNo.toString()) +&quot;]&quot;;
		Form.getCurrentTask().setKeyWord(newKeyWord);
		var rootID = Form.getCurrentTask().getRootID();
		var prjTask = Client.getTask(rootID);
		prjTask.setKeyWord(newKeyWord);
		Client.updateTask(prjTask);
}	
function updateKeyWordWithComment(objIssueNo,comment){
		//將單號及主旨加到工作主題中
		var keyWord = Form.getCurrentTask().getKeyWord();
		var newKeyWord = &quot;[&quot; + Form.getValue(objIssueNo.toString()) +&quot;]&quot;+comment.toString();
		Form.getCurrentTask().setKeyWord(newKeyWord);
		var rootID = Form.getCurrentTask().getRootID();
		var prjTask = Client.getTask(rootID);
		prjTask.setKeyWord(newKeyWord);
		Client.updateTask(prjTask);
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>將單號及主旨加到工作主題中</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021179559590828</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/05/19 15:26:30</string> 
     </void> 
     <void property="fullName"> 
      <string>com.realtek.ecn.ClientUtils</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021179559590828</string> 
     </void> 
     <void property="name"> 
      <string>ClientUtils</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041179559576781</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//=====================================================
//子產品線選擇  依公司別帶出產品線
//=====================================================
function loadProduct_Definition() {
try	{
		var conn = Client.createSessionConnection(&quot;seattle&quot;);
		//select distinct cmpy_id ,prd_line ,sub_prd_line from product_definition  order by 1,2,3
		var sql = &quot;select distinct cmpy_id ,prd_line ,sub_prd_line from product_definition where cmpy_id = &apos;&quot; + Form.getValue(&quot;Company&quot;)+ &quot;&apos;&quot;;
//					 and prd_line = &apos;&quot;+ Form.getValue(&quot;Prod_Line&quot;) + &quot;&apos; and sub_prd_line = &apos;&quot; + Form.getValue(&quot;Sub_Prod_Line&quot;) + &quot;&apos;&quot; ;
		var data = conn.loadValue(sql);
	 	var table = Form.getComponent(&quot;Product_Table&quot;);
	table.clear();
	for (var i = 0; i &lt; data.size(); i++) {
		var hm = data.get(i);
		table.newRow();
		table.setValueAt(hm.get(&quot;cmpy_id&quot;), i, &quot;公司別&quot;);
		table.setValueAt(hm.get(&quot;prd_line&quot;), i, &quot;產品線&quot;);
		table.setValueAt(hm.get(&quot;sub_prd_line&quot;), i, &quot;子產品線&quot;);
		//table.setValueAt(hm.get(&quot;sub_prd_group&quot;), i, &quot;子產品線名稱&quot;);		
	}
	}catch(e){
		conn.rollback();
	}

if(conn != null){
		try	{
			conn.commit();
		}catch(e){}
		conn.close();
	}
}

//=====================================================
//ECN會簽規則設定重新載入Sign_TableA
//=====================================================
function reload_sign_tableA(){
var s_sqlA = &quot;select * from A_ECN_Sign_Config where sign_type = &apos;A&apos; order by 2&quot;;
 	var vca = Client.SQLloadValue(s_sqlA);
	var table = Form.getComponent(&quot;Sign_TableA&quot;);
	table.clear();
	for (var i = 0; i &lt; vca.size(); i++) {
		var hm = vca.get(i);
		table.newRow();
		table.setValueAt(hm.get(&quot;ecn_type&quot;), i, &quot;類別&quot;);
		table.setValueAt(hm.get(&quot;c1&quot;), i, &quot;RD_Designer&quot;);
		table.setValueAt(hm.get(&quot;c2&quot;), i, &quot;PM&quot;);		
		table.setValueAt(hm.get(&quot;c3&quot;), i, &quot;BU_Designer&quot;);	
		table.setValueAt(hm.get(&quot;c4&quot;), i, &quot;Testing&quot;);	
		table.setValueAt(hm.get(&quot;c5&quot;), i, &quot;SW&quot;);	
		table.setValueAt(hm.get(&quot;c6&quot;), i, &quot;HW&quot;);	
		table.setValueAt(hm.get(&quot;c7&quot;), i, &quot;品管&quot;);	
		table.setValueAt(hm.get(&quot;c8&quot;), i, &quot;生產&quot;);	
		table.setValueAt(hm.get(&quot;c9&quot;), i, &quot;資材&quot;);	
		table.setValueAt(hm.get(&quot;c10&quot;), i, &quot;產品&quot;);	
		table.setValueAt(hm.get(&quot;c11&quot;), i, &quot;設備&quot;);	
		table.setValueAt(hm.get(&quot;c12&quot;), i, &quot;測試&quot;);			
	}
}	


//=====================================================
//ECN會簽規則設定重新載入Sign_TableB
//=====================================================
function reload_sign_tableB(){
	var s_sqlB = &quot;select * from A_ECN_Sign_Config where sign_type = &apos;B&apos; order by 2 &quot;;
 	var vcb = Client.SQLloadValue(s_sqlB);
	var table = Form.getComponent(&quot;Sign_TableB&quot;);
	table.clear();
	for (var i = 0; i &lt; vcb.size(); i++) {
		var hm = vcb.get(i);
		table.newRow();
		table.setValueAt(hm.get(&quot;ecn_type&quot;), i, &quot;類別&quot;);
		table.setValueAt(hm.get(&quot;c1&quot;), i, &quot;RD_Designer&quot;);
		table.setValueAt(hm.get(&quot;c2&quot;), i, &quot;PM&quot;);		
		table.setValueAt(hm.get(&quot;c3&quot;), i, &quot;BU_Designer&quot;);	
		table.setValueAt(hm.get(&quot;c4&quot;), i, &quot;Testing&quot;);	
		table.setValueAt(hm.get(&quot;c5&quot;), i, &quot;SW&quot;);	
		table.setValueAt(hm.get(&quot;c6&quot;), i, &quot;HW&quot;);	
		table.setValueAt(hm.get(&quot;c7&quot;), i, &quot;品管&quot;);	
		table.setValueAt(hm.get(&quot;c8&quot;), i, &quot;生產&quot;);	
		table.setValueAt(hm.get(&quot;c9&quot;), i, &quot;資材&quot;);	
		table.setValueAt(hm.get(&quot;c10&quot;), i, &quot;產品&quot;);	
		table.setValueAt(hm.get(&quot;c11&quot;), i, &quot;設備&quot;);	
		table.setValueAt(hm.get(&quot;c12&quot;), i, &quot;測試&quot;);			
	}
}


//=====================================================
//ECN會簽人原設定_事業處設定重新載入Sign_Table
//=====================================================
function reload_sign_table_dep(form){
var s_sql = &quot;select * from A_ECN_Sign_member where (c2_Name is not null  or c3_Name is not null or c4_Name is not null or c5_Name is not null or c6_Name is not null ) and Department=&apos;&quot;+form.getValue(&quot;Department&quot;) +&quot;&apos; order by 1,2 &quot;;
 	var vc = Client.SQLloadValue(s_sql);
	Client.setLocalObject(&quot;vc&quot;,vc);
	var table = form.getComponent(&quot;Sign_Table&quot;);
	table.clear();
	var row = 0;
	var l_row_data =&quot;&quot;;
	Form.setValue(&quot;Count&quot;,vc.size()+&quot;&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vc.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);
	showTable_dep(1);
	
}
//===================================================================
// 分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================
function showTable_dep(P){
	var vc = Client.getLocalObject(&quot;vc&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vc.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;Sign_Table&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vc.size()&lt; E){
		E = vc.size();
	}
	for (var i = (P-1)*N ; i &lt; E; i++) {
		row = table.newRow()-1 + &quot;&quot;;
		table.setValueAt(vc.get(i).get(&quot;Scope&quot;), row, &quot;適用範圍&quot;);
		table.setValueAt(vc.get(i).get(&quot;Scope_Content&quot;), row, &quot;名稱&quot;);
		table.setValueAt(vc.get(i).get(&quot;c2_name&quot;), row, &quot;PM&quot;);
		table.setValueAt(vc.get(i).get(&quot;c2_mem&quot;), row, &quot;PM_Mem&quot;);

		table.setValueAt(vc.get(i).get(&quot;c3_name&quot;), row, &quot;BU_Designer&quot;);
		table.setValueAt(vc.get(i).get(&quot;c3_mem&quot;), row, &quot;BU_Designer_Mem&quot;);

		table.setValueAt(vc.get(i).get(&quot;c4_name&quot;), row, &quot;Testing&quot;);
		table.setValueAt(vc.get(i).get(&quot;c4_mem&quot;), row, &quot;Testing_Mem&quot;);

		table.setValueAt(vc.get(i).get(&quot;c5_name&quot;), row, &quot;SW&quot;);
		table.setValueAt(vc.get(i).get(&quot;c5_mem&quot;), row, &quot;SW_Mem&quot;);

		table.setValueAt(vc.get(i).get(&quot;c6_name&quot;), row, &quot;HW&quot;);
		table.setValueAt(vc.get(i).get(&quot;c6_mem&quot;), row, &quot;HW_Mem&quot;);

	}
}


//=====================================================
//ECN會簽人原設定_製造處設定重新載入Sign_Table
//=====================================================
function reload_sign_table_make(form){
var s_sql = &quot;select * from A_ECN_Sign_member where (c8_Name is not null  or c9_Name is not null or c10_Name is not null or c11_Name is not null or c12_Name is not null ) order by 1,2 &quot;;
 	var vc = Client.SQLloadValue(s_sql);
	Client.setLocalObject(&quot;vc&quot;,vc);
	var table = form.getComponent(&quot;Sign_Table&quot;);
	table.clear();
	var row = 0;
	var l_row_data =&quot;&quot;;
	Form.setValue(&quot;Count&quot;,vc.size()+&quot;&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vc.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);
	showTable_make(1);
}

//===================================================================
// 分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================
function showTable_make(P){
	var vc = Client.getLocalObject(&quot;vc&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vc.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;Sign_Table&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vc.size()&lt; E){
		E = vc.size();
	}
	for (var i = (P-1)*N ; i &lt; E; i++) {
		row = table.newRow()-1 + &quot;&quot;;
		table.setValueAt(vc.get(i).get(&quot;Scope&quot;), row, &quot;適用範圍&quot;);
		table.setValueAt(vc.get(i).get(&quot;Scope_Content&quot;), row, &quot;名稱&quot;);
		table.setValueAt(vc.get(i).get(&quot;c8_name&quot;), row, &quot;生產&quot;);
		table.setValueAt(vc.get(i).get(&quot;c8_mem&quot;), row, &quot;生產_Mem&quot;);

		table.setValueAt(vc.get(i).get(&quot;c9_name&quot;), row, &quot;資材&quot;);
		table.setValueAt(vc.get(i).get(&quot;c9_mem&quot;), row, &quot;資材_Mem&quot;);

		table.setValueAt(vc.get(i).get(&quot;c10_name&quot;), row, &quot;產品&quot;);
		table.setValueAt(vc.get(i).get(&quot;c10_mem&quot;), row, &quot;產品_Mem&quot;);

		table.setValueAt(vc.get(i).get(&quot;c11_name&quot;), row, &quot;設備&quot;);
		table.setValueAt(vc.get(i).get(&quot;c11_mem&quot;), row, &quot;設備_Mem&quot;);

		table.setValueAt(vc.get(i).get(&quot;c12_name&quot;), row, &quot;測試&quot;);
		table.setValueAt(vc.get(i).get(&quot;c12_mem&quot;), row, &quot;測試_Mem&quot;);

	}
}

//=====================================================
//ECN會簽人原設定_研發處設定重新載入Sign_Table
//=====================================================
function reload_sign_table_rd(form){
var s_sql = &quot;select * from A_ECN_Sign_member where (c1_Name is not null  ) order by 1,2 &quot;;
 	var vc = Client.SQLloadValue(s_sql);
	Client.setLocalObject(&quot;vc&quot;,vc);
	var table = form.getComponent(&quot;Sign_Table&quot;);
	table.clear();
	var row = 0;
	var l_row_data =&quot;&quot;;
	Form.setValue(&quot;Count&quot;,vc.size()+&quot;&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vc.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);
	showTable_rd(1);
}

//===================================================================
// 分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================
function showTable_rd(P){
	var vc = Client.getLocalObject(&quot;vc&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vc.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;Sign_Table&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vc.size()&lt; E){
		E = vc.size();
	}
	for (var i = (P-1)*N ; i &lt; E; i++) {
		row = table.newRow()-1 + &quot;&quot;;
		table.setValueAt(vc.get(i).get(&quot;Scope&quot;), row, &quot;適用範圍&quot;);
		table.setValueAt(vc.get(i).get(&quot;Scope_Content&quot;), row, &quot;名稱&quot;);
		table.setValueAt(vc.get(i).get(&quot;c1_name&quot;), row, &quot;RD_Designer&quot;);
		table.setValueAt(vc.get(i).get(&quot;c1_mem&quot;), row, &quot;RD_Designer_Mem&quot;);
	}
}


//=====================================================
//ECN會簽人原設定_品管設定重新載入Sign_Table
//=====================================================
function reload_sign_table_iqc(form){
var s_sql = &quot;select * from A_ECN_Sign_member where (c7_Name is not null  ) order by 1,2 &quot;;
 	var vc = Client.SQLloadValue(s_sql);
	Client.setLocalObject(&quot;vc&quot;,vc);
	var table = form.getComponent(&quot;Sign_Table&quot;);
	table.clear();
	var row = 0;
	var l_row_data =&quot;&quot;;	
	Form.setValue(&quot;Count&quot;,vc.size()+&quot;&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vc.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);
	showTable_iqc(1);
	
}		

//===================================================================
// 分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================
function showTable_iqc(P){
	var vc = Client.getLocalObject(&quot;vc&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vc.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;Sign_Table&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vc.size()&lt; E){
		E = vc.size();
	}
	for (var i = (P-1)*N ; i &lt; E; i++) {
		row = table.newRow()-1 + &quot;&quot;;
		table.setValueAt(vc.get(i).get(&quot;Scope&quot;), row, &quot;適用範圍&quot;);
		table.setValueAt(vc.get(i).get(&quot;Scope_Content&quot;), row, &quot;名稱&quot;);
		table.setValueAt(vc.get(i).get(&quot;c7_name&quot;), row, &quot;品管&quot;);
		table.setValueAt(vc.get(i).get(&quot;c7_mem&quot;), row, &quot;品管_Mem&quot;);

	}
}


	//=======================================================================
	//設定會簽的必選
	//=======================================================================
	function setSign(C){
		try{
			var sql_sign = &quot; SELECT   count(1) count FROM  A_ECN_Sign_Config where &quot;+ C +&quot; =&apos;true&apos; &quot;;
			var vec_sign = Client.SQLloadValue(sql_sign);
			if(vec_sign != null &amp;&amp; 0&lt; vec_sign.get(0).get(&quot;count&quot;)){
				Form.setValue(C,&quot;true&quot;);
				var comp = Form.getComponent(&quot;lb&quot;+C);
				comp.setForeground(new Packages.java.awt.Color(0,0,1));		
			}
		}catch(e){}
	}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021194753061796</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/11/11 11:51:01</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.DMS.DMSConfig</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021194753061796</string> 
     </void> 
     <void property="name"> 
      <string>DMSConfig</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011194752256531</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
var DMSSERVERIP = &quot;127.0.0.1&quot;;
var DMSSERVERPORT = &quot;1299&quot;;

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021203777218718</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2013/03/26 09:17:41</string> 
     </void> 
     <void property="fullName"> 
      <string>com.eland.dms.Doc_List</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021203777218718</string> 
     </void> 
     <void property="name"> 
      <string>Doc_List</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011203496283609</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

//loadLibrary(&quot;&quot;);

	
//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			var hm = vec.get(i);
			var row = table.newRow()-1;
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;Subject&quot;),     	row, &quot;文件標題&quot;);
			table.setValueAt(hm.get(&quot;Mem_Name&quot;),     	row, &quot;作者&quot;);
			table.setValueAt(hm.get(&quot;GCE_Doc_Sn&quot;),     	row, &quot;文件編號&quot;);
			table.setValueAt(hm.get(&quot;GCE_Ver_Sn&quot;),     	row, &quot;版本&quot;);
			table.setValueAt(hm.get(&quot;Dept_Name&quot;),     	row, &quot;發表部門&quot;);
			table.setValueAt(hm.get(&quot;Doc_ID&quot;),     	row, &quot;Doc_ID&quot;);
			table.setValueAt(hm.get(&quot;Ver_ID&quot;),     	row, &quot;Ver_ID&quot;);
			table.setValueAt(hm.get(&quot;Category_id&quot;),     	row, &quot;Category_ID&quot;);
			table.setValueAt(hm.get(&quot;Path&quot;),     	row, &quot;Path&quot;);			
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	/*
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			sSQL += &quot; AND ITEM141 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
		}
	}
	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM141 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
		}
	}	
	*/
	// 文件標題
	var Subject = Form.getValue(&quot;Subject&quot;);	 
	if (!&quot;&quot;.equals(Subject)) {
		sSQL += &quot; AND Subject like &apos;%&quot; + Subject + &quot;%&apos;&quot;;
	}
	// 文件編號
	var Doc_Sn = Form.getValue(&quot;Doc_Sn&quot;);	
	if (!&quot;&quot;.equals(Doc_Sn)) {
		sSQL += &quot; AND V.GCE_Doc_Sn like &apos;%&quot; + Doc_Sn + &quot;%&apos;&quot;;
	}	
	// 部門名稱
	var Dept_ID = Form.getValue(&quot;Dept_ID&quot;);	
	if (!&quot;&quot;.equals(Dept_ID)) {
		sSQL += &quot; AND V.Dept= &apos;&quot; + Dept_ID + &quot;&apos;&quot;;
	}
	// 作者
	var Login_ID = Form.getValue(&quot;Login_ID&quot;);	
	if (!&quot;&quot;.equals(Login_ID)) {
		sSQL += &quot; AND V.Creator = &apos;&quot; + Login_ID + &quot;&apos;&quot;;
	}	
	
	
	return sSQL;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>編輯文件清單</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021211161988159</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2010/10/02 12:49:11</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.MAN.sendMail</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021211161988159</string> 
     </void> 
     <void property="name"> 
      <string>sendMail</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001209032361851</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function sendNoticeMail(){
	var InsID = MyTask.getArtInstance();
	var dataMap = InsID.getAppDataMap();
	var cMember = Server.getMember(MyTask.getMemberID());
	var fromMail= Server.getMember(&quot;Administrator&quot;).getEmail();//系統管理員為寄件者
//	var toEMail = cMember.getEmail();
	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	//流程上的成員
	var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;exeid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;exeid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;); //排除 Administrator
		//memset.remove(&quot;MEM00211172832334935&quot;);
	}
	var totalccMail = &quot;&quot;;
	var title = &quot;請會簽&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單&quot;;
	var urlData = &quot;&lt;a href=\&quot;$webAgendaURL$mailOpenFormCheckpass\&quot;&gt;會簽單&lt;/a&gt;&quot;;
	var data = &quot; 您好：&quot;+&quot;\n&quot;+&quot;\n&quot;;
	data = data + &quot;這是系統自動發出的一封通知信，請至 EIP 上進行會簽簽核，\n&quot;;
	data = data +&quot;表單內容為：&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單 \n&quot;;
	data = data +&quot;會簽簽核時請點選「加會意見」及請務必填寫「同意」或「不同意」\n&quot;;
   data = data + &quot; 您可以開啟 &quot;+urlData+&quot;，來查看該表單。&quot;+&quot;\n  \n \n   MIS &quot;;
   data = &quot;&lt;pre&gt;&quot;+data+&quot;&lt;/pre&gt;&quot;;
    var vector = new java.util.Vector();
     //taskID
    var taskID = MyTask.getID();  
    Server.sendHTMLMailExt(fromMail,toEMail,totalccMail,title,data,vector,taskID);  	
	}
/**
 撤單(拉回前一關)時發出的 mail
 發給被撤的那一關(task.realexecutor)
 用於 Client
*/
function sendGoBackMail(MyTask){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Client.getMember(&quot;administrator&quot;).getEmail();  		
        //var to = getProcessMailAddressList(groupname); 
		//var to = Client.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail();
		var realexecutor_mail = Client.getMember(MyTask.getRealExecutor()).getEmail();
		var to = realexecutor_mail;
        var cc = &quot;&quot;; //cc觀察用 
        var subject = dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」已被撤回-[&quot;+ MyTask.getKeyWord() +&quot;]&quot;; // Mail Subject 
		var text = getGoBackMailContent(dataMap,MyTask);
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
		Client.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
//-------------------
// 撤單通知內容
//-------------------
function getGoBackMailContent(dataMap,MyTask){
		//var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核「撤回」通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Client.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Client.getMember(Client.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Client.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Client.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		//text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   資訊部服務信箱: mis@gce.com.tw  &lt;br&gt;&quot;;
		text += &quot;   資訊部服務電話: (02)xxxxxxxxx 分機 xxxx  &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

/**
 會簽時發出的 mail
*/
function sendCSMail(){
	var InsID = MyTask.getArtInstance();
	var dataMap = InsID.getAppDataMap();
	var cMember = Server.getMember(MyTask.getMemberID());
	var fromMail= Server.getMember(&quot;Administrator&quot;).getEmail();//系統管理員為寄件者
	var toEMail = cMember.getEmail();
	var totalccMail = &quot;&quot;;
	var title = &quot;請會簽&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單&quot;;
	var urlData = &quot;&lt;a href=\&quot;$webAgendaURL$mailOpenFormCheckpass\&quot;&gt;會簽單&lt;/a&gt;&quot;;
	var data = &quot; 您好：&quot;+&quot;\n&quot;+&quot;\n&quot;;
	data = data + &quot;這是系統自動發出的一封通知信，請至 EIP 上進行會簽簽核，\n&quot;;
	data = data +&quot;表單內容為：&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單 \n&quot;;
	data = data +&quot;會簽簽核時請點選「加會意見」及請務必填寫「同意」或「不同意」\n&quot;;
   data = data + &quot; 您可以開啟 &quot;+urlData+&quot;，來查看該表單。&quot;+&quot;\n  \n \n   MIS &quot;;
   data = &quot;&lt;pre&gt;&quot;+data+&quot;&lt;/pre&gt;&quot;;
    var vector = new java.util.Vector();
     //taskID
    var taskID = MyTask.getID();  
    Server.sendHTMLMailExt(fromMail,toEMail,totalccMail,title,data,vector,taskID);  
 }
/**
 審核通過時發出的 mail
 通知申請者&amp;填單者
 沒有要多傳給特定人 groupname 傳 &quot;&quot;

function sendAcceptMail_old(groupname){ 
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        //var to = getProcessMailAddressList(groupname); 
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail();
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}
        var cc = &quot;&quot;; //cc觀察用 
        var subject = dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」已審核通過-[&quot;+ MyTask.getKeyWord() +&quot;]&quot;; // Mail Subject 
		var text = getAcceptMailContent(dataMap);
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
*/
/**
 審核通過時發出的 mail
 通知申請者&amp;填單者
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
 20080502 mail to 名單加入 TableA 上的人員
*/
function sendAcceptMail(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        //var to = getProcessMailAddressList(groupname); //通知簽核過的人員
		
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}
		to += getMailAddressTableA(dataMap);
        var cc = &quot;&quot;; //cc觀察用 
        var subject = dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」已審核通過-[&quot;+ MyTask.getKeyWord() +&quot;]&quot;; // Mail Subject 
		var text = getAcceptMailContent(dataMap);
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}

/**
	TABLEA 內的 ID 會有 DEPID or MEMID
	DEPID 要取所有部門成員的 Email address
*/
function getMailAddressTableA(dataMap){
	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	try{
		var tablea = dataMap.get(&quot;TableA&quot;);
		if( tablea != null &amp;&amp; tablea.size()&gt;0  ){
			for(var t=0;t&lt;tablea.size();t++){
				var id = tablea.get(t).get(&quot;ITEM2&quot;);//DEPID or MEMID
				if(id.startsWith(&quot;MEM&quot;)&amp;&amp; Server.getMember(id) != null &amp;&amp; !Server.getMember(id).isResign()){
					memset.add(id);
				}else if(id.startsWith(&quot;DEP&quot;) &amp;&amp; Server.getDepartment(id) != null){
					var depname = Server.getDepartment(id).getName();
					memset = addDepAllMemID(depname,memset);
				}
			}
		}
		
		// memset --&gt; email address
			var key = memset.iterator();
			while(key.hasNext()){
				var memid = key.next();
				if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
					emailaddress += Server.getMember(memid).getEmail() + &quot;;&quot; ;
				}
			}

	}catch(e){
		var emailaddress = Server.getMember(&quot;administrator&quot;).getEmail();  
	}
	return emailaddress;
}
/**
	20080503
	將 DEP 內的所有人員加入 memset 內(含子部門)
*/
function addDepAllMemID(depname,memset){
	var DepartmentList = Server.getAllDepartmentByName(depname);
	//var memberNameList  = new java.util.Vector();
	for(var i=0;i&lt;DepartmentList.size();i++){
			var depObj =DepartmentList.get(i);
			var depID = depObj.getID();
			var memList = Server.getSubMemberIDOfDR(depID,true);
			for(var j = 0; j&lt; memList.size();j++){
				var memid = memList.get(j);
				if(memid != null &amp;&amp; memid != &quot;&quot;){
					memset.add(memid);
				}
			}
	}
	return memset;
}

 //-------------------
// 駁回通知內容
//-------------------
function getAcceptMailContent(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核通過通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   資訊部服務信箱: mis@gce.com.tw  &lt;br&gt;&quot;;
		text += &quot;   資訊部服務電話: (02)xxxxxxxxx 分機 xxxx  &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

/**
 駁回時發出的 mail
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
*/
function sendRejectMail(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        var to = getProcessMailAddressList(groupname); 
        var cc = &quot;&quot;; //cc觀察用 
        var subject = dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」已退回申請人-[&quot;+ MyTask.getKeyWord() +&quot;]&quot;; // Mail Subject 
		var text = getMailContent(dataMap);
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
 //-------------------
// 駁回通知內容
//-------------------
function getMailContent(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核退回通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   資訊部服務信箱: mis@gce.com.tw  &lt;br&gt;&quot;;
		text += &quot;   資訊部服務電話: (02)xxxxxxxxx 分機 xxxx  &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}


/**
	取得Root Task 流程所經過的人+ 特定 table 抓出來的 email address 字串
*/
function getProcessMailAddressList(groupname){

	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	//流程上的成員
		var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;exeid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;exeid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;); //排除 Administrator
		//memset.remove(&quot;MEM00211172832334935&quot;);
	}
	//Table 上的成員
	if(groupname != &quot;&quot;){
		var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
		var vec = Server.SQLloadValue(sql); 
		if(vec != null &amp;&amp; vec.size() &gt; 0){
			for(var i=0;i&lt;vec.size();i++){
				if(Server.getMember(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;memid&quot;)).isResign()){
						memset.add(vec.get(i).get(&quot;memid&quot;));
				}
			}
				memset.remove(&quot;Administrator&quot;);
		}
	}

	var key = memset.iterator();
	while(key.hasNext()){
		var memid = key.next();
		if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
			emailaddress += Server.getMember(memid).getEmail() + &quot;;&quot; ;
		}
	}
	return emailaddress;	
}

 
 

//---------------------------------------------------------
//取得Root Task 流程所經過的人+ 特定 table 抓出來的 memid set
//扣掉上一關的人
function getProcessMemberList(groupname){
	var emailaddress = &quot;&quot;;
	var fronttaskid = MyTask.getFrontID();
	var frontmemid = Server.getTask(fronttaskid).getRealExecutor();
	var memset = java.util.TreeSet();
	//流程上的成員
	var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid and exeid !=&apos;&quot;+ frontmemid + &quot;&apos; &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			//去除已離職的人
			if(Server.getMember(vec.get(i).get(&quot;exeid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;exeid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;);
	}
	//Table 上的成員
	var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;memid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;memid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;);
	}
	return memset;	
}
//---------------------------------------------------------- 


//------------------------
// 發 mail 開啟連結用的 URL 
// n == 1 //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件 ( ie7 無法直接開 ) 
// n == 2 //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
// n == 3 //email開表單，需密碼
// n == 4 //email開表單，不需密碼
//------------------------
function getUrl(n){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           var aInstance = MyTask.getArtInstance(); 
           var dataMap = aInstance.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                     //var userName = member.getName();
                     var userName = member.getLoginID();
                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }
           return url;
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021225676980243</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/04/19 09:26:05</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PH.PH_ITEMSELECT</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021225676980243</string> 
     </void> 
     <void property="name"> 
      <string>PH_ITEMSELECT</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00321216878882287</string> 
     </void> 
     <void property="scriptSource"> 
      <string>	
//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
//			table.setValueAt(java.lang.Integer.parseInt(i),    	row, &quot;序&quot;);			
			table.setValueAt(i,    	row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ITEM_DESC&quot;),    	row, &quot;品名/規格&quot;);
			table.setValueAt(hm.get(&quot;ITEM_NO&quot;),    	row, &quot;料號&quot;);
			table.setValueAt(hm.get(&quot;UOM&quot;), 	row, &quot;單位&quot;);
			table.setValueAt(hm.get(&quot;PO_DATE&quot;), 	row, &quot;購買日期&quot;);
			table.setValueAt(hm.get(&quot;GBDEPT&quot;),   	row, &quot;歸屬部門&quot;);
			table.setValueAt(hm.get(&quot;PO_QTY&quot;),  	row, &quot;數量&quot;);
			table.setValueAt(hm.get(&quot;CATEGORY_CONCAT_SEGS&quot;),   	row, &quot;Category&quot;);
			table.setValueAt(hm.get(&quot;CATEGORY_ID&quot;),   	row, &quot;Category ID&quot;);
			table.setValueAt(hm.get(&quot;ITEM_ID&quot;),   	row, &quot;ITEMID&quot;);			
			table.setValueAt(hm.get(&quot;get_idlist&quot;),   	row, &quot;get_idlist&quot;);			
			
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

//-------------
function showTableHM(P){	// 
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}	
	if (vec.size()&gt;0) {
		var dataRow = null;
		var juVec = new java.util.Vector();
		for (var i = (P-1)*N ; i &lt; E; i++) {
			dataRow = new java.util.HashMap();
			var hm = vec.get(i);
			var row = table.newRow()-1;			
			dataRow.put( &quot;序&quot;, i+&quot;&quot; );
			dataRow.put( &quot;品名/規格&quot;, hm.get(&quot;ITEM_DESC&quot;));
			dataRow.put( &quot;料號&quot; ,hm.get(&quot;ITEM_NO&quot;));
			dataRow.put( &quot;單位&quot; ,hm.get(&quot;UOM&quot;));
			dataRow.put( &quot;購買日期&quot; ,hm.get(&quot;PO_DATE&quot;));
			dataRow.put( &quot;歸屬部門&quot; ,hm.get(&quot;GBDEPT&quot;));
			dataRow.put( &quot;數量&quot; ,hm.get(&quot;PO_QTY&quot;));
			dataRow.put( &quot;Category&quot; ,hm.get(&quot;CATEGORY_CONCAT_SEGS&quot;));
			dataRow.put( &quot;Category ID&quot; ,hm.get(&quot;CATEGORY_ID&quot;));
			dataRow.put( &quot;ITEMID&quot; ,hm.get(&quot;ITEM_ID&quot;));
			dataRow.put( &quot;get_idlist&quot; ,hm.get(&quot;get_idlist&quot;));
			dataRow.put( &quot;PR_TYPE&quot; ,hm.get(&quot;PR_TYPE&quot;));			 	// add by wangwei@2019/04/14
			dataRow.put( &quot;類別&quot; ,hm.get(&quot;FLOW_TYPE&quot;));			// add by wangwei@2019/04/14	 		
			juVec.add(dataRow);			
		}
		table.setRowList(juVec);
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
//===================================================================
// 加會簽選單
//===================================================================	
function showTable_addsign(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;SOURCETABLE&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			table.setValueAt(&quot;false&quot;,row,&quot;選取&quot;);
			table.setValueAt(hm.get(&quot;NAME&quot;),    	row, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;JOBTITLE&quot;),    	row, &quot;職稱&quot;);
			table.setValueAt(hm.get(&quot;EMPCODE&quot;), 	row, &quot;工號&quot;);
			table.setValueAt(hm.get(&quot;USERNAME&quot;), 	row, &quot;姓名&quot;);
			
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;無資料&quot;);
	}
}
//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}else{
					sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
		}
	}
	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}else{
					sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}			
		}
	}
	// 文件編號
	var Doc_Sn = Form.getValue(&quot;Sn&quot;);	
	if (!&quot;&quot;.equals(Doc_Sn)) {
		sSQL += &quot; AND ITEM138 like &apos;%&quot; + Doc_Sn + &quot;%&apos;&quot;;
	}	
	
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM144 like &apos;%&quot; + MemName + &quot;%&apos;&quot;;
	}	
	var appname = Form.getValue(&quot;appname&quot;);	
	if (!&quot;&quot;.equals(appname)) {
		sSQL += &quot; AND ITEM27 like &apos;%&quot; + appname + &quot;%&apos;&quot;;
	}	

	var PHSTATUS = Form.getValue(&quot;FComboBox0&quot;);

//	if (!&quot;&quot;.equals(PHSTATUS)) {
//		if(&quot;採購已收件&quot;.equals(PHSTATUS)){
//			sSQL += &quot; AND ITEM131 = &apos;W&apos;&quot;;
//		}
//		else if(&quot;已轉入ERP&quot;.equals(PHSTATUS)){
//			sSQL += &quot; AND ITEM131 = &apos;Y&apos;&quot;;
//		}
//		else{
//			sSQL += &quot; AND (ITEM131 &lt;&gt; &apos;W&apos; and  ITEM131 &lt;&gt; &apos;Y&apos;) AND ITEM155 = &apos;false&apos; AND ITEM115 is not null&quot;;
//		}
//		}
//		else		{
//				var Status = Form.getValue(&quot;Status&quot;);	 
//				if (!&quot;全部&quot;.equals(Status)) {
//						if (&quot;已結案&quot;.equals(Status)) {
//							sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM115 is not null &quot;;
//						}else if (&quot;未結案&quot;.equals(Status)){
//							sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
//						}				
//				}
//		}
	//文件狀態

				var Status = Form.getValue(&quot;Status&quot;);	 
				if (!&quot;全部&quot;.equals(Status)) {
						if (&quot;已結案&quot;.equals(Status)) {
							sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM115 is not null &quot;;
						}else if (&quot;未結案&quot;.equals(Status)){
							sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
						}				
				}	
	
	// 用途說明
	var spec = Form.getValue(&quot;spec&quot;);	
	if (!&quot;&quot;.equals(spec)) {
		sSQL += &quot; AND ITEM15 like &apos;%&quot; + spec + &quot;%&apos;&quot;;
	}		
	// 品名規格
	var Subject = Form.getValue(&quot;Subject&quot;);	
	if (!&quot;&quot;.equals(Subject)) {
		sSQL += &quot; AND ITEM165 like &apos;%&quot; + Subject + &quot;%&apos;&quot;;
	}		
	return sSQL;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021227755663885</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/11/27 11:14:23</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.QC.Process</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021227755663885</string> 
     </void> 
     <void property="name"> 
      <string>Process</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011221465024953</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//=========================================
//將簽核區資訊放入簽核歷程表格
//=========================================
function setProcessTable(){
//	var department = Server.getDepartment(MyTask.getDepartmentID()).getName();
	var depid = MyTask.getDepartmentID();
	var dep = Server.getDepartment(depid);
	var rMember = Server.getMember(MyTask.getRealExecutor()); //執行者
//	var roleTitle = Server.getRole(rMember.getMainRoleID()).getName();	
//	var roleTitle = Server.getRole(MyTask.getRoleID()).getName();	
	var roleTitle = rMember.getJobTitle();
	
	var department = &quot;x&quot;;
	if(dep != null){
		department = dep.getName();
	}else{
		//抓不到部門(可能是專案職務)，就抓主要職務的部門
		var roleID = rMember.getMainRoleID();
		var memDR = rMember.getMemberDR(roleID);
		var department = memDR.getDepartmentName();	//使用者部門名稱
	}
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
		//Set 流程控制
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
		var roleid = Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
		dataMap.put(&quot;From_User_Role_ID&quot;, roleid);	
		//dataMap.put(&quot;From_User_Role_ID&quot;, MyTask.getRoleID());	 // 很奇怪會一直往上抓
	//var roleTitle = aInstance.getAppValue(&quot;verifyTitle&quot;);
	var name = aInstance.getAppValue(&quot;Verify_Name&quot;);
	var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
	var con_Reject = aInstance.getAppValue(&quot;con_Reject&quot;);// add by bischoff 2008/11/27, 不同意的欄位
	var isAgree = true;
//	if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))) {by bischoff 2008/11/27
	if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))||con_Reject==&quot;true&quot;) {// add by bischoff 2008/11/27
		isAgree = false;
		//主管退回時mail通知之前簽核過的主管
		//rejectMail(mID, aInstance.getAppValue(&quot;verifyName&quot;));
	}
	appendProcessTable(department, roleTitle, name, isAgree, reason);

}


//=========================================
//簽核歷程表格加入一筆
//=========================================
function appendProcessTable(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數	
	var member = Server.getMemberByCName(name);
	var id = member.getMyID();
	var vApp_Name = aInstance.getAppValue(&quot;App_Name&quot;);  // add by wangwei 2008/05/27 
	var con_Reject = aInstance.getAppValue(&quot;con_Reject&quot;);// add by bischoff 2008/11/27, 不同意的欄位
	var Reject = aInstance.getAppValue(&quot;Reject&quot;);// add by bischoff 2008/11/27, 不駁回的欄位
	//加入代理人資訊 20070625
	if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
		name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
	}		
	var hm = java.util.HashMap();
	var proName = MyTask.getProcessName();//關卡名稱
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
	hm.put(&quot;ITEM6&quot;, department);//Department 部門
	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
	hm.put(&quot;ITEM2&quot;, id);//ID 工號	
	hm.put(&quot;ITEM4&quot;, name);//Name 姓名
	if (isAgree == true) {
		hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		//hm.put(&quot;ITEM2&quot;,&quot;false&quot;);
		if(rowCount == 0){
			hm.put(&quot;ITEM3&quot;,&quot;提出&quot;);//同意
		}else{			
			// 找出Process_Table序號為1的關卡名稱與目前關卡名稱比較是否為再提出 970929 	
			for(var i=0;i&lt;rowCount;i++){
				var rowData = vecTableData.get(i);
				var rowProcessNo = rowData.get(&quot;ITEM7&quot;);	
				java.lang.System.out.println(&quot;rowProcessNo:&quot;+rowProcessNo);
				if(rowProcessNo.equals(&quot;1&quot;)||rowProcessNo==&quot;1&quot;){
					var rowProcessName = rowData.get(&quot;ITEM8&quot;);
					if(proName.equals(rowProcessName)){
						hm.put(&quot;ITEM3&quot;,&quot;再提出&quot;);//同意	
						break;
					}
				}
			}
//			if(name.equals(vApp_Name)){ 
//			if(proName.equals(row1ProcessName)){//970923
//				hm.put(&quot;ITEM3&quot;,&quot;再提出&quot;);//同意				
//			}
		}
	} else {
		// add by bischoff 2008/11/27
		if(Reject==&quot;true&quot;){
			hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);
		}
		else if(con_Reject==&quot;true&quot;){
			hm.put(&quot;ITEM3&quot;,&quot;不同意&quot;);
		} //add by bischoff 2008/11/27
//		  hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);//by bischoff 2008/11/27
		//hm.put(&quot;ITEM2&quot;,&quot;true&quot;);
	}
	
	hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
	hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
	vecTableData.add(rowCount,hm);
	aInstance.setAppValue(&quot;Process_Table&quot;,vecTableData);
		formDataMap.put(&quot;Agree&quot;,&quot;true&quot;);
		formDataMap.put(&quot;Reject&quot;,&quot;false&quot;);
		formDataMap.put(&quot;con_Reject&quot;,&quot;false&quot;);// add by bischoff 2008/11/27, 不同意的欄位
		formDataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
}
function autoSetProcessTable(isAgree){
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數	
	var hm = java.util.HashMap();	
	hm.put(&quot;ITEM8&quot;,&quot;系統判斷分會結果&quot;);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
//	hm.put(&quot;ITEM6&quot;, department);//Department 部門
//	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
//	hm.put(&quot;ITEM2&quot;, id);//ID 工號	
	hm.put(&quot;ITEM4&quot;, &quot;Administrator&quot;);//Name 姓名
	if(isAgree){
		hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
	}
	else{
		hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);
	}
	hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID
	vecTableData.add(rowCount,hm);
	aInstance.setAppValue(&quot;Process_Table&quot;,vecTableData);	
}
 function getFormatedCurrentTime(){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
        return simpledateformat.format(date);
    }
</string> 
     </void> 
     <void property="synopsis"> 
      <string>處理簽核相關函數</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021229675716182</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/12/19 16:35:16</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Server.TravelRelated</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021229675716182</string> 
     </void> 
     <void property="name"> 
      <string>TravelRelated</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011227091263550</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//=========================================
//將簽核區資訊放入簽核歷程表格, 因為共用的會改寫Role所以另外加一個
//=========================================
function setProcessTable(){
	var depid = MyTask.getDepartmentID();
	var dep = Server.getDepartment(depid);
	var rMember = Server.getMember(MyTask.getRealExecutor()); //執行者
	var roleTitle = rMember.getJobTitle();	
	var department = &quot;x&quot;;
	if(dep != null){
		department = dep.getName();
	}else{
		//抓不到部門(可能是專案職務)，就抓主要職務的部門
		var roleID = rMember.getMainRoleID();
		var memDR = rMember.getMemberDR(roleID);
		var department = memDR.getDepartmentName();	//使用者部門名稱
	}
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	// 20081219 主要是刪掉這一行,會影響自動簽核	
	var roleid = Server.getMember(MyTask.getRealExecutor()).getMainRoleID();	
	var name = aInstance.getAppValue(&quot;Verify_Name&quot;);
	var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
	var isAgree = true;
	if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))) {
		isAgree = false;
		//主管退回時mail通知之前簽核過的主管
	}
	loadLibrary(&quot;com.A.Common.Server.ProcessTable&quot;);
	appendProcessTable(department, roleTitle, name, isAgree, reason);
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>出差單Server端相關函式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00021366945149256</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2016/05/09 09:19:37</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Server.WorkingTime</string> 
     </void> 
     <void property="id"> 
      <string>SCL00021366945149256</string> 
     </void> 
     <void property="name"> 
      <string>WorkingTime</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011227091263550</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function closeAction(){
		//人事相關關卡有簽核意見時,於流程結束皆需通知
		// 取得簽核意見
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var vTitle = dataMap.get(&quot;Subject2&quot;);
		var vDptno = dataMap.get(&quot;dptno&quot;);
		var empEMail  = Server.getMemberByID(dataMap.get(&quot;HR&quot;)).getEmail() + &quot;;&quot; ;
			empEMail += Server.getMemberByID(dataMap.get(&quot;HRPM1&quot;)).getEmail() + &quot;;&quot; ;
			empEMail += Server.getMemberByID(dataMap.get(&quot;HRPM2&quot;)).getEmail() + &quot;;&quot; ;
			empEMail += Server.getMemberByID(dataMap.get(&quot;HRPM3&quot;)).getEmail();
	  // 取得第一關簽核資料
	  var vProcess_Table = dataMap.get(&quot;Process_Table&quot;);
	  var rowCount = vProcess_Table.size();//取得筆數
	  var text=&quot;&quot; 			   
	  if (rowCount &gt; 0 ){
		  for(var i=0;i&lt;rowCount;i++){
			  var ls_reason = vProcess_Table.get(i).get(&quot;ITEM1&quot;);
			  var ls_empno = vProcess_Table.get(i).get(&quot;ITEM2&quot;);
			  var ls_cname = vProcess_Table.get(i).get(&quot;ITEM4&quot;);
			  var ls_process = vProcess_Table.get(i).get(&quot;ITEM8&quot;);
				
			  if (&quot;單位主管審核&quot;==ls_process.trim()){
							
				  var sql = &quot; SELECT MemID,Email FROM  Mem_GenInf WHERE ID=&apos;&quot;+ls_empno+&quot;&apos; AND USERNAME=&apos;&quot;+ls_cname+&quot;&apos;&quot;; 
				  var vec = Server.SQLloadValue(sql); 
				  if ( vec != null &amp;&amp; vec.size() &gt; 0){
					   for( var j=0;j&lt;vec.size();j++){
							if(Server.getMember(vec.get(j).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(j).get(&quot;memid&quot;)).isResign()){
							   var emailaddress = vec.get(j).get(&quot;Email&quot;);
							}			
					   }
				  }				
			  }else if (&quot;人事主管確認&quot;==ls_process.trim()){				
				
					 if (&quot;&quot; != ls_reason.trim()){
						if (&quot;&quot; != text){
							text += &quot;　　　　　　　　　　:&quot;+ls_reason.trim()+&quot;。&lt;br&gt;&quot;;
						}else{
							text += &quot;人資主管意見回覆內容:&quot;+ls_reason.trim()+&quot;。&lt;br&gt;&quot;;
						}
					}		
			  }else if (&quot;人事副理確認&quot;==ls_process.trim()){
					
					 if (&quot;&quot; != ls_reason.trim()){
						if (&quot;&quot; != text){
							text += &quot;　　　　　　　　　　:&quot;+ls_reason.trim()+&quot;。&lt;br&gt;&quot;;
						}else{
							text += &quot;人資主管意見回覆內容:&quot;+ls_reason.trim()+&quot;。&lt;br&gt;&quot;;
						}
					}		
			  }else if (&quot;人事經理確認&quot;==ls_process.trim()){
					
					 if (&quot;&quot; != ls_reason.trim()){
						if (&quot;&quot; != text){
							text += &quot;　　　　　　　　　　:&quot;+ls_reason.trim()+&quot;。&lt;br&gt;&quot;;
						}else{
							text += &quot;人資主管意見回覆內容:&quot;+ls_reason.trim()+&quot;。&lt;br&gt;&quot;;
						}
					}				
			  }
		  }
	  }
	
		if (&quot;&quot; !=text){
			// 發送MAIL 	  	  
			sendMail(emailaddress,vDptno+&quot;_&quot;+vTitle,text,empEMail);
		 
			// 人事主管簽核意見回覆通知
			var fileList = new Packages.java.util.Vector(); 
//			Server.sendHTMLMailExt(&quot;yingchieh_wang@gce.com.tw&quot;,&quot;yingchieh_wang@gce.com.tw&quot;,&quot;&quot;,vDptno+&quot;_&quot;+vTitle,&quot;簽核意見:&quot;+text,fileList,MyTask); 
		
			Server.flowTo(MyTask, &quot;結案&quot;);
		}else{
			Server.flowTo(MyTask, &quot;結案&quot;);
		}
	}
//人事經理簽核完成時發出的 mail
//通知流程第一關主管
function sendMail(emailaddress,titleA,Content,empEMail){
	if (emailaddress == &quot;&quot; || emailaddress == &quot;wtadmin@gce.com.tw&quot;){
	}else{
		var cMember = Server.getMember(MyTask.getMemberID());
		var fromMail= &quot;MyGCE&quot;;//系統管理員為寄件者
		var toEMail = emailaddress;
        var arturl = getUrl(2) ;
		var title = &quot;[簽核意見回覆]&quot; + titleA ;	
		var data =  &quot;您好：&lt;br&gt;&quot;;
		data = data + &quot;&lt;p&gt;這是&quot;+titleA+&quot;[簽核意見回覆]!&lt;br&gt;&quot;
		data = data + &quot;詳細內容如下:&lt;br&gt;&quot;;
		data = data + &quot;&lt;p&gt;&quot;+Content +&quot;&lt;br&gt;&quot;;
		data = data + &quot;&lt;p&gt;您可直接按這裡&quot;+arturl+&quot;&lt;br&gt;&quot;;
		data = data + &quot;&lt;p&gt;此為系統自動發出！操作上有任何問題 請與資訊處-王英傑(22717) 聯絡  &lt;br&gt;&quot;;
		var vector = new java.util.Vector();
		var taskID = MyTask.getID();  
		Server.sendHTMLMailExt(fromMail,toEMail,empEMail,title,data,vector,taskID);  
	}
}

 
/**
   發 mail 開啟連結用的 URL 
   n == 1 //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件 ( ie7 無法直接開 ) 
   n == 2 //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
   n == 3 //email開表單，需密碼
   n == 4 //email開表單，不需密碼
**/
function getUrl(n){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           var aInstance = MyTask.getArtInstance(); 
           var dataMap = aInstance.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=false&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                     //var userName = member.getName();
                     var userName = member.getLoginID();
                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }
           return url;
}
			
</string> 
     </void> 
     <void property="synopsis"> 
      <string>大陸三廠工時異常相關函數</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00031090380546207</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/07/21 11:29:06</string> 
     </void> 
     <void property="fullName"> 
      <string>com.flowring.privilege</string> 
     </void> 
     <void property="id"> 
      <string>SCL00031090380546207</string> 
     </void> 
     <void property="name"> 
      <string>privilege</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011181776157390</string> 
     </void> 
     <void property="scriptSource"> 
      <string>	function getValueBound(fieldName, defaultValue, degree){
		//讀取權限表之欄位值
		var sql = &quot;Select &quot; + fieldName + &quot; from ART00081079138869931_Ins Where ITEM2=&apos;&quot; + degree + &quot;&apos;&quot;;
		var DataSet = Client.SQLloadValue(sql);
		var valueBound = defaultValue;
		if (DataSet.size()&gt;0) {
			var Record = DataSet.get(0);
			var bound = Record.get(fieldName);
			if (bound != null){
				try{
					valueBound = java.lang.Double.parseDouble(bound);
				}catch(e){}
			}
		}
		return valueBound;
	}

	function getMDegreeValueBound(classification){
		var valueBound = 0;
		if (classification.indexOf(&quot;01&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM3&quot;,10000,&quot;M&quot;); 
		} else if (classification.indexOf(&quot;02&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM4&quot;,10000,&quot;M&quot;); 
		} else if (classification.indexOf(&quot;03&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM5&quot;,0,&quot;M&quot;); 
		} else if (classification.indexOf(&quot;04&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM6&quot;,10000,&quot;M&quot;); 
		} else if (classification.indexOf(&quot;05&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM7&quot;,0,&quot;M&quot;); 
		} else if (classification.indexOf(&quot;06&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM8&quot;,10000,&quot;M&quot;); 
		} else if (classification.indexOf(&quot;07&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM9&quot;,10000,&quot;M&quot;); 
		} else if (classification.indexOf(&quot;08&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM10&quot;,5000,&quot;M&quot;); 
		} else if (classification.indexOf(&quot;09&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM11&quot;,5000,&quot;M&quot;); 
		}
		return valueBound;
	}

	function getGDegreeValueBound(classification){
		var valueBound = 0;
		if (classification.indexOf(&quot;01&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM3&quot;,Packages.java.lang.Double.MAX_VALUE,&quot;G&quot;); 
		} else if (classification.indexOf(&quot;02&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM4&quot;,Packages.java.lang.Double.MAX_VALUE,&quot;G&quot;); 
		} else if (classification.indexOf(&quot;03&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM5&quot;,1000000,&quot;G&quot;); 
		} else if (classification.indexOf(&quot;04&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM6&quot;,100000,&quot;G&quot;); 
		} else if (classification.indexOf(&quot;05&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM7&quot;,0,&quot;G&quot;); 
		} else if (classification.indexOf(&quot;06&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM8&quot;,200000,&quot;G&quot;); 
		} else if (classification.indexOf(&quot;07&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM9&quot;,100000,&quot;G&quot;); 
		} else if (classification.indexOf(&quot;08&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM10&quot;,100000,&quot;G&quot;); 
		} else if (classification.indexOf(&quot;09&quot;) != -1) {
			valueBound = getValueBound(&quot;ITEM11&quot;,100000,&quot;G&quot;); 
		}
		return valueBound;
	}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>Validation of acception criteria</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00031110519447000</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/03/11 13:37:27</string> 
     </void> 
     <void property="fullName"> 
      <string>com.flowring.sql</string> 
     </void> 
     <void property="id"> 
      <string>SCL00031110519447000</string> 
     </void> 
     <void property="name"> 
      <string>sql</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011181776157390</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/**
建立SQL查詢條件for checkBox group  
*/
function margeSQLCondit(checkNameArray,itemName){
	var conditVector = new java.util.Vector();	
	for(var i=0;i&lt;checkNameArray.length;i++){
	        var checkName = checkNameArray[i];
	        //var isCheck = &quot;true&quot;;
	        var isCheck = Form.getValue(checkName);
	        if(&quot;true&quot;.equals(isCheck)){
	        	var formObj = Form.getComponent(checkName);
	        	if(formObj != null){
	        		var Text = formObj.getText();
	        		var condit =&quot; &quot;+itemName+&quot; = &apos;&quot;+Text+&quot;&apos; &quot;;
					conditVector.add(condit);
				}
	        }
	}
	return conditVector;
}
/**
	建立SQL的查詢條件for 日期區間
*/
function dateSQLCondit(startDateName,endDateName,itemName){
		var startDate  = Form.getValue(startDateName);
		var endDate = Form.getValue(endDateName);
		var sb = new java.lang.StringBuffer(&quot; (&quot;);
		sb.append(itemName+&quot; &gt;= &apos;&quot;+startDate+&quot;&apos;&quot;);
		sb.append(&quot; and &quot;);
		sb.append(itemName+&quot; &lt;= &apos;&quot;+endDate+&quot;&apos;&quot;);
		sb.append(&quot;) &quot;);

		return sb.toString();
}

/**
透過條件建立整個SQL語法
*/
function genSQLString(conditVector,sqlChar){
	var sqlVector = new java.util.Vector();
	var it = conditVector.iterator();
	if(it.hasNext()){
		//sqlString.append(&quot;(&quot;);
		while(it.hasNext()){
			var condit = it.next();	
			if(condit != null &amp;&amp; !&quot;&quot;.equals(condit)){
				sqlVector.add(condit);
			}
		}
	}
	var it2 = sqlVector.iterator();
	var sqlString = new java.lang.StringBuffer();
	if(it2.hasNext()){
		sqlString.append(&quot;(&quot;);
		while(it2.hasNext()){
			var condit = it2.next();	
			sqlString.append(condit);
			if(it2.hasNext())
				sqlString.append(sqlChar);
		}
		sqlString.append(&quot;)&quot;);
	}

	return sqlString.toString();
}</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00031132401425963</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/11/19 19:57:05</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.SetItemToComboBox</string> 
     </void> 
     <void property="id"> 
      <string>SCL00031132401425963</string> 
     </void> 
     <void property="name"> 
      <string>SetItemToComboBox</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//設定主項目的內容
function setMainItem(tblName,colName,cbName){
	
		var sqlQuery = &quot;select distinct &quot;+ colName.toString()+&quot; from &quot;+tblName.toString();
        java.lang.System.out.println(sqlQuery.toString());
		
		result = Client.SQLloadValue(sqlQuery);
        setItemToComboBox(result,cbName,colName);	
}
//根據where條件設定次項目的內容
function setDetailItemByWhere(tblName,colName,cbName,whereContent){
	    
		var sqlQuery = &quot;select distinct &quot;+ colName.toString()+&quot; from &quot;+tblName.toString()+ &quot; where &quot; +whereContent ;
        java.lang.System.out.println(sqlQuery.toString());
		
		result = Client.SQLloadValue(sqlQuery);
        setItemToComboBox(result,cbName,colName);

}
//根據另一項目選取結果設定次項目的內容
function setDetailItemBySelected(tblName,colName,cbName,selectedCol,selectedItem){
	    
		var sqlQuery = &quot;select distinct &quot;+ colName.toString()+&quot; from &quot;+tblName.toString()+ &quot; where &quot; +selectedCol.toString()+&quot;=&apos;&quot;+selectedItem.toString()+&quot;&apos;&quot; ;
		java.lang.System.out.println(sqlQuery.toString());
		
		result = Client.SQLloadValue(sqlQuery);
        setItemToComboBox(result,cbName,colName);

}
//根據where條件設定兩個項目的內容
function setTwoItemsToOneComboByWhere(tblName,colName1,colName2,cbName,whereContent){
	    
		var sqlQuery = &quot;select distinct &quot;+ colName1.toString()+&quot;,&quot;+colName2.toString()+&quot; from &quot;+tblName.toString()+ &quot; where &quot; +whereContent ;
        java.lang.System.out.println(sqlQuery.toString());
		
		result = Client.SQLloadValue(sqlQuery);
        setTwoItemsToComboBox(result,cbName,colName1,colName2);

}
//將駁回原因加入ComboBox 
function setRejectReason(cbName){
	
	    loadLibrary(&quot;ScriptLibary.SystemFunction.ProcessInfoFunction&quot;);
		var outProcessList = getCurrentOutProcessList();
		for(var i = 0; i &lt; outProcessList.size(); i++){
			var aRow = outProcessList.get(i);
			
			
			if(aRow.toString().indexOf(&quot;駁回&quot;) == -1 &amp;&amp; 
			  aRow.toString().indexOf(&quot;重新&quot;) == -1 &amp;&amp;
			  aRow.toString().indexOf(&quot;退回&quot;) == -1 &amp;&amp;
			  aRow.toString().indexOf(&quot;錯誤&quot;) == -1 ||
			  aRow.toString().indexOf(&quot;通過&quot;) == 0) {
				  outProcessList.remove(aRow);
				  i-=1;
			  }
			
			if (Form.getValue(&quot;ckCountersignIT&quot;).equals(&quot;false&quot;))  
			   if(aRow.toString().indexOf(&quot;資訊&quot;) &gt; -1) {
				  outProcessList.remove(aRow);
				  i-=1;
			   }	   
		}
		setItemNameToComboBox(outProcessList,cbName)
        

}
function setRejectReasonNormal(cbName){
	
	    loadLibrary(&quot;ScriptLibary.SystemFunction.ProcessInfoFunction&quot;);
		var outProcessList = getCurrentOutProcessList();
		for(var i = 0; i &lt; outProcessList.size(); i++){
			var aRow = outProcessList.get(i);
			
			if ((aRow.toString().indexOf(&quot;駁回&quot;) == -1 &amp;&amp;  
			   aRow.toString().indexOf(&quot;重新&quot;) == -1 &amp;&amp; 
			   aRow.toString().indexOf(&quot;退回&quot;) == -1 &amp;&amp;
			   aRow.toString().indexOf(&quot;錯誤&quot;) == -1) ||
			   aRow.toString().indexOf(&quot;通過&quot;) == 0) {
			   outProcessList.remove(aRow);
			   continue;
			}
			
		}
		setItemNameToComboBox(outProcessList,cbName)
        

}
//將Vector中之特定兩個欄位加入ComboBox
function setTwoItemsToComboBox(objVector,cbName,colName1,colName2){
   		
		var cb= Form.getComponent(cbName.toString());
		cb.removeAllItems();		
		for(var i = 0; i &lt; objVector.size(); i++){
			var aRow = objVector.get(i);
			var aRowCol = aRow.get(colName1.toString())+&quot; &quot;+aRow.get(colName2.toString());
			cb.addItem(aRowCol);
		}
		
        cb.insertItemAt(&quot;---請選擇---&quot;,0);       
	    Form.setValue(cbName.toString(),&quot;---請選擇---&quot;);

}
//將Vector中之特定欄位加入ComboBox
function setItemToComboBox(objVector,cbName,colName){
   		
		var cb= Form.getComponent(cbName.toString());
		cb.removeAllItems();		
		for(var i = 0; i &lt; objVector.size(); i++){
			var aRow = objVector.get(i);
			var aRowCol = aRow.get(colName.toString());
			cb.addItem(aRowCol);
		}
		
        cb.insertItemAt(&quot;---請選擇---&quot;,0);       
	    Form.setValue(cbName.toString(),&quot;---請選擇---&quot;);

}
//將Vector中之一組(兩個)特定欄位其中 colName1加入ComboBox colName2存入隱藏物件
function setItemPairToComboBox(objVector,cbName,colName1,colName2){
   		
		var cb= Form.getComponent(cbName.toString());
		var tempMap = new java.util.HashMap(); 
		cb.removeAllItems();		
		for(var i = 0; i &lt; objVector.size(); i++){
			var aRow = objVector.get(i);
			var aRowCol = aRow.get(colName1.toString());
			cb.addItem(aRowCol);
			tempMap.put(aRowCol,aRow.get(colName2.toString()));
		}
		
        cb.insertItemAt(&quot;---請選擇---&quot;,0);       
	    Form.setValue(cbName.toString(),&quot;---請選擇---&quot;);
		
		Client.setLocalObject(cbName.toString(),tempMap);
}
//將Vector中之物件加入comboBox
function setItemNameToComboBox(objVector,cbName){
   		
		var cb= Form.getComponent(cbName.toString());
		cb.removeAllItems();		
		for(var i = 0; i &lt; objVector.size(); i++){
			var aRowCol = objVector.get(i).getLabel();
			cb.addItem(aRowCol);
		}
        cb.insertItemAt(&quot;---請選擇---&quot;,0);       
	    Form.setValue(cbName.toString(),&quot;---請選擇---&quot;);
	   
}
//傳入員工列表物件,取得員工姓名,作為ComboBox的項目
function getMemberNameList(memberList,cbName){
			
	//將member物件中之姓名欄位加入ComboBox
	var cb = Form.getComponent(cbName.toString());
	var tempMap = new java.util.HashMap(); 
	cb.removeAllItems();		
	for(var i = 0; i &lt; memberList.size(); i++){
		var aRow = memberList.get(i);
		var aRowCol =aRow.getLoginID()+&quot; &quot;+ aRow.getName();
		cb.addItem(aRowCol);
		tempMap.put(aRowCol,aRow.getID());
	}
    cb.insertItemAt(&quot;---請選擇---&quot;,0);       
	Form.setValue(cbName.toString(),&quot;---請選擇---&quot;);
	
	Client.setLocalObject(cbName.toString(),tempMap);
}
//傳入部門列表物件,取得部門名稱,作為ComboBox的項目
function getDepartmentNameList(DepartmentList,cbName){
			
	//將member物件中之姓名欄位加入ComboBox
	var cb= Form.getComponent(cbName.toString());
	cb.removeAllItems();
	var tempMap = new java.util.HashMap();
    java.lang.System.out.println(DepartmentList.size());
		
	for(var i = 0; i &lt; DepartmentList.size(); i++){
		var aRow = DepartmentList.get(i);
		var aRowCol = aRow.getName() ;
		cb.addItem(aRowCol);
		tempMap.put(aRowCol,aRow.getID());
	}
	
    cb.insertItemAt(&quot;---請選擇---&quot;,0);       
	Form.setValue(cbName.toString(),&quot;---請選擇---&quot;);
	
	Client.setLocalObject(cbName.toString(),tempMap);

}
//傳入部門列表物件,取得部門代號及部門名稱,作為ComboBox的項目
function getDepartmentIDAndNameList(DepartmentList,cbName){
			
	//將member物件中之姓名欄位加入ComboBox
	var cb= Form.getComponent(cbName.toString());
	cb.removeAllItems();
	var tempMap = new java.util.HashMap();
    java.lang.System.out.println(DepartmentList.size());
		
	for(var i = 0; i &lt; DepartmentList.size(); i++){
		var aRow = DepartmentList.get(i);
		var aRowCol = aRow.getMyID() +&quot; &quot;+ aRow.getName() ;
		cb.addItem(aRowCol);
		tempMap.put(aRowCol,aRow.getID());
	}
	
    cb.insertItemAt(&quot;---請選擇---&quot;,0);       
	Form.setValue(cbName.toString(),&quot;---請選擇---&quot;);
	
	Client.setLocalObject(cbName.toString(),tempMap);

}
//傳入字串陣列,作為ComboBox的項目
function setStringArrToComboBox(stringArr,cbName){
			
	//將字串陣列加入ComboBox
	var cb= Form.getComponent(cbName.toString());
	cb.removeAllItems();
	java.lang.System.out.println(stringArr.length);
		
	for(var i = 0; i &lt; stringArr.length; i++){
		var aString = stringArr[i];
		cb.addItem(aString);
	}
	
    cb.insertItemAt(&quot;---請選擇---&quot;,0);       
	Form.setValue(cbName.toString(),&quot;---請選擇---&quot;);

}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>設定特定資料來源,作為ComboBox的項目</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00031153280417375</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/07/19 11:40:17</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Process_Type_Maintain</string> 
     </void> 
     <void property="id"> 
      <string>SCL00031153280417375</string> 
     </void> 
     <void property="name"> 
      <string>Process_Type_Maintain</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011152000677625</string> 
     </void> 
     <void property="scriptSource"> 
      <string>



function reloadProcess_Type_Maintain(){
	//function 功能:抓取 table A_Process_Type 的 資料到表單上的 TableA 元件
		reloadTable(&quot;TableA&quot;);		
}

//===================================================================================
function reloadTable(tableA){
			if(tableA != null){
				var sql = &quot; select * from A_Process_Type where project = &apos;&quot;+ Form.getValue(&quot;Project&quot;) +&quot;&apos; and af_process_id =&apos;&quot;+Form.getValue(&quot;AF_Process_ID&quot;)+&quot;&apos; order by Project &quot;   ;
				var vecData = Client.SQLloadValue(sql);
				var table = Form.getComponent(tableA);					
				table.clear();
				if(vecData.size()&gt;0){
					Form.setValue(&quot;Modify_Date&quot;,(vecData.get(0).get(&quot;Modify_date&quot;)));//.toString().substring(0,16));
					Form.setValue(&quot;Modify_ID&quot;,vecData.get(0).get(&quot;modify_id&quot;));	
					for(var j= 0; j &lt; vecData.size(); j++){
						var row = table.newRow()-1 ;
						table.setValueAt(vecData.get(j).get(&quot;ID&quot;),row,&quot;ID&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Project&quot;),row,&quot;Project&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;AF_Process_ID&quot;),row,&quot;AF_Process_ID&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;AF_Process_Name&quot;),row,&quot;AF_Process_Name&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Process_Type_ID&quot;),row,&quot;Process_Type_ID&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Process_Type_Name&quot;),row,&quot;Process_Type_Name&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Description&quot;),row,&quot;Description&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Remarks&quot;),row,&quot;Remarks&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Active&quot;),row,&quot;Active&quot;); //
					}//for
				}
			}
}//function

//清維護畫面
function clearProcess_Type(){
	Form.setValue(&quot;AF_Process_ID&quot;,&quot;&quot;);
	Form.setValue(&quot;AF_Process_Name&quot;,&quot;&quot;);
//	Form.setValue(&quot;Process_Type_ID&quot;,&quot;&quot;);
//	Form.setValue(&quot;Process_Type_Name&quot;,&quot;&quot;);
	Form.setValue(&quot;Remarks&quot;,&quot;&quot;);	
	Form.setValue(&quot;Description&quot;,&quot;&quot;);
	Form.setValue(&quot;Active&quot;,&quot;true&quot;);	
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00031156609563578</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/08/27 00:26:03</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Server.Process</string> 
     </void> 
     <void property="id"> 
      <string>SCL00031156609563578</string> 
     </void> 
     <void property="name"> 
      <string>Process</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021156610951562</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//===================================================
 //表單編碼方式為【E0743099】 
 //&quot;07&quot;年份 , &quot;43&quot; 週 , &quot;099&quot;流水號。 
 // a= &quot;E&quot;
 // artid = ART00101173841772296_Ins
 // itemid = ITEM143 (Sn)
 //===================================================
function setSn(a,itemid){
	try{
	   var artIns = MyTask.getArtInstance(); 
	   var dataMap = artIns.getAppDataMap();
	   var cancel = dataMap.get(&quot;Cancel&quot;);
	   var artid = artIns.getArtifactID();
	   if(&quot;false&quot;.equals(cancel) &amp;&amp; dataMap.get(&quot;Sn&quot;) == &quot;&quot;){
		   var sn = &quot;&quot;;
		   try{
		   	   var year = new java.text.SimpleDateFormat(&quot;y&quot;).format(new java.util.Date()); // 07
		   	   var week = new java.text.SimpleDateFormat(&quot;w&quot;).format(new java.util.Date()); // 49
				   //補0
				   if(week.length() == 1){
					   week = &quot;0&quot; + week;
				   }			   
			   var sn5 = a + year + week ; //E0749
			   var sn_n = &quot;001&quot;;			   
			   // var sql_sn = &quot; select Right(max(&quot;+ itemid +&quot;),3) MAXNO from &quot;+ artid +&quot;_Ins where &quot;+ itemid + &quot; LIKE &apos;&quot;+ sn5 +&quot;%&apos;&quot;; // MS-SQL :
			   var sql_sn = &quot; select substr(max(&quot;+ itemid +&quot;),-3,3) MAXNO from &quot;+ artid +&quot;_Ins where &quot;+ itemid + &quot; LIKE &apos;&quot;+ sn5 +&quot;%&apos;&quot;; // oracel
			   var vec_sn = Server.SQLloadValue(sql_sn);
			   if(vec_sn != null &amp;&amp; vec_sn.size()&gt;0 &amp;&amp; vec_sn.get(0).get(&quot;MAXNO&quot;) != &quot;&quot;){
				   var maxno_str = vec_sn.get(0).get(&quot;MAXNO&quot;);
				   var maxno_int = java.lang.Integer.parseInt(maxno_str) + 1;
				   var sn_n = java.lang.Integer.toString(maxno_int);
				   //補0
				   if(sn_n.length() == 1){
					   sn_n = &quot;00&quot; + sn_n;
				   }else if(sn_n.length() == 2){
					   sn_n = &quot;0&quot; + sn_n;
				   }
			   }
			   var sn = sn5 + sn_n; //E0749001
			   dataMap.put(&quot;Sn&quot;,sn);
		   }catch(e){}
	   }
	  }catch(e){}
}


//===============================================
//用在第一關的 post action
// copy from initPostAction
// 再加一個參數用於工作主題前面ex:檢核.. 駁回....
// 原來程式只有三個參數,不影響 call 此function 的程式
//===============================================
function initPostAction(key1,key2,key3){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var artState = MyTask.getArtInstance().getArtState().getName();
	setTaskKeyWord(dataMap,key1,key2,key3);	
	if(dataMap.get(&quot;Start_Time&quot;)== &quot;&quot; ){
		dataMap.put(&quot;Start_Time&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
	}
}

//===============================================
//用在第一關的 post action
// copy from initPostAction
// 再加一個參數用於工作主題前面ex:檢核.. 駁回....
// 原來程式只有三個參數,不影響 call 此function 的程式
//===============================================
function initPostActionExt(key1,key2,key3,key4){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var artState = MyTask.getArtInstance().getArtState().getName();
	setTaskKeyWordExt(dataMap,key1,key2,key3,key4);	
	if(dataMap.get(&quot;Start_Time&quot;)== &quot;&quot; ){
		dataMap.put(&quot;Start_Time&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
	}
}

//===============================================
//用在第一關的 post action
// copy from initPostAction
// 再加一個參數用於表單欄位傳入工作主題後面 ex:Sn +Sugjec ....
// 原來程式只有三個參數,不影響 call 此function 的程式
//===============================================
function initPostAction_Detail(key1,key2,key3,key4){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var artState = MyTask.getArtInstance().getArtState().getName();
	setTaskKeyWord_Detail(dataMap,key1,key2,key3,key4);	
	if(dataMap.get(&quot;Start_Time&quot;)== &quot;&quot; ){
		dataMap.put(&quot;Start_Time&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
	}
}


//===============================================
// 用在最後一關的 post action
//===============================================
function closeProcess(){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	dataMap.put(&quot;Close_Time&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
}	

// 
function setTaskKeyWord(dataMap,key1,key2,key3){
	var rootTask = Server.getTask(MyTask.getRootID());
	var keyWord = &quot;[簽核&quot; + dataMap.get(&quot;Factory&quot;) + &quot;]&quot; + dataMap.get(key1) +key2+ getSubString(dataMap.get(key3),20) ;
	rootTask.setKeyWord(keyWord);
	Server.updateTask(rootTask);
	MyTask.setKeyWord(keyWord);
}
// 再加一個參數用於表單欄位傳入工作主題後面 ex:Sn +Sugjec ....
function setTaskKeyWord_Detail(dataMap,key1,key2,key3,key4){
	var rootTask = Server.getTask(MyTask.getRootID());
	var keyWord = &quot;[簽核&quot; + dataMap.get(&quot;Factory&quot;) + &quot;]&quot; + dataMap.get(key1) +key2+ getSubString(dataMap.get(key3),30) + &quot;:&quot; + getSubString(dataMap.get(key4),20) ;
	rootTask.setKeyWord(keyWord);
	Server.updateTask(rootTask);
	MyTask.setKeyWord(keyWord);
}
// 再加一個參數用於工作主題前面ex:檢核.. 駁回....
function setTaskKeyWordExt(dataMap,key1,key2,key3,key4){
	var rootTask = Server.getTask(MyTask.getRootID());
	var keyWord = &quot;[&quot;+ key4+ dataMap.get(&quot;Factory&quot;) + &quot;]&quot; + dataMap.get(key1) +key2+ getSubString(dataMap.get(key3),20) ;
	rootTask.setKeyWord(keyWord);
	Server.updateTask(rootTask);
	MyTask.setKeyWord(keyWord);
}

function getSubString(s1,n){
	if(s1 != null &amp;&amp; s1.length()&gt;n){
		s1 = s1.substring(0,n) + &quot;...&quot;;
	}
	return s1;
}

function setPriority(dataMap){
	var rootkey = MyTask.getRootID();
    var roottask = Server.getTask(rootkey);
    var Priority= dataMap.get(&quot;Speed&quot;); 
	if(Priority==&quot;特急件&quot;){
		var	Prioritykey=0;
		}
	if(Priority==&quot;急件&quot;){
		var	Prioritykey=1;
		}
	if(Priority==&quot;一般件&quot;){
		var	Prioritykey=2;
		}	
	//roottask.setPriority(0);  //設定啟動主流程關卡緊急程度 (如：0 = 緊急)
    MyTask.setPriority(Prioritykey); // 設定目前填寫關卡 緊急程度(如：1 = 普通)
    //var result=Server.updateTask(roottask);
}


function setVerifyLevel(verify_level){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
		dataMap.put(&quot;Verify_Level&quot;,verify_level);	
}


function initialProcess(){	
	//抓取文件狀態
	var artState = MyTask.getArtInstance().getArtState().getName();
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	//使用者姓名
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	if(artState == &quot;初始化&quot; ){
		initialForm(dataMap);
	}else if (artState != &quot;主管駁回&quot;){
		//dataMap.put(&quot;VerifyName&quot;,sUserName);
	}
		//判斷下一關主管用，被駁回時也要 update
		var roleID = MyTask.getRoleID();
		dataMap.put(&quot;From_User_ID&quot;,cMember.getID());
		dataMap.put(&quot;From_User_Role_ID&quot;,roleID);
		dataMap.put(&quot;Next_Member_Role&quot;,&quot;&quot;); 
		dataMap.put(&quot;Next_Member_ID&quot;,&quot;&quot;); 	
}
	
function initialForm(dataMap){
	//抓取使用者相關資料
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	//使用者姓名
//	var roleID = MyTask.getRoleID();
	var roleID = cMember.getMainRoleID();	
	var memDR = cMember.getMemberDR(roleID);
	var sDepName = memDR.getDepartmentName();	//使用者部門名稱
	var sDepID = Server.getDepartment(memDR.getDepartmentID()).getMyID();
	var sRoleName = memDR.getRoleName();	//使用者職務名稱
	var sCompanyID = cMember.getAreaCode(); //使用者公司代碼
	
		
		//設定填表人姓名、員工編號...
		//dataMap.put(&quot;Sn&quot;,MyTask.getArtInstance().getMyID());
		dataMap.put(&quot;Creator&quot;,sUserName+&quot;(&quot;+cMember.getMyID()+&quot;)&quot;);
		//dataMap.put(&quot;Creator_ID&quot;,cMember.getMyID());
		dataMap.put(&quot;Creator_ID&quot;,cMember.getID());		
		dataMap.put(&quot;App_Name&quot;,sUserName);
		dataMap.put(&quot;App_MemID&quot;,mID);
		dataMap.put(&quot;App_ID&quot;,cMember.getMyID());
		//dataMap.put(&quot;App_Title&quot;,sRoleName);
		dataMap.put(&quot;App_Title&quot;,cMember.getJobTitle());
		dataMap.put(&quot;App_Tel&quot;,cMember.getOfficePhone());
		dataMap.put(&quot;App_Dep&quot;,sDepName);
		dataMap.put(&quot;App_Dep_ID&quot;,sDepID);		
		dataMap.put(&quot;App_DepID&quot;,memDR.getDepartmentID());		//&quot;DEPxxx&quot;	
		dataMap.put(&quot;Factory&quot;,&quot;(&quot; + sCompanyID + &quot;)&quot;);//廠別
		//loadLibrary(&quot;com.A.Common.Server.Util&quot;);
		dataMap.put(&quot;Create_Date&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
		

		
		
}//fun initForm


//--------------------------------------------------------------	
	function managerPostAction(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		//Set 流程控制
		//dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor()); //以代理人的level來簽
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getMemberID()); //以 task owner level 來簽
		dataMap.put(&quot;From_User_Role_ID&quot;, MyTask.getRoleID());
		
		//Set 簽核意見

		setTotalNote();
	}
	
function setTotalNote(){
		
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		//Set 簽核意見
		var mID = MyTask.getMemberID();
		var cMember = Server.getMemberByID(mID);
		var cMemberName = Server.getMemberByID(MyTask.getMemberID()).getName();
		var rolName = Server.getRole(MyTask.getRoleID()).getName();
		var roleID = MyTask.getRoleID();
		var memDR = cMember.getMemberDR(roleID);
		var sDepName = memDR.getDepartmentName();	//使用者部門名稱
		
		var rMember = Server.getMemberByID(MyTask.getRealExecutor()); //代理人
		var rMemberName = rMember.getName();
		if(cMember != rMember){
			cMemberName = rMemberName + &quot;( Agent &quot;+ cMemberName + &quot;)&quot; ;
		}
		var verify_record = dataMap.get(&quot;Verify_Record&quot;);
		var verify_note = dataMap.get(&quot;Verify_Note&quot;);
		var isagree = &quot;Agree&quot;;
		var agree = dataMap.get(&quot;Agree&quot;);
		if(agree != &quot;true&quot;){
		     isagree = &quot;Reject&quot;;
		}
		var processname = MyTask.getProcessName();
		//[ PM Sign吳至中_Stephen(Agent 鐘春城_CC), SBU1 , 2006/0711 10:45] Agree Good Job!
		verify_record = verify_record + &quot;[&quot; + processname+ &quot;,&quot; + cMemberName + &quot;,&quot; + sDepName + &quot;,&quot; + getFormatedCurrentTime() + &quot;]  &quot;  + isagree +&quot; &quot;+verify_note +&quot;\n&quot;;    
		dataMap.put(&quot;Verify_Record&quot;,verify_record);

}

    function getFormatedCurrentTime(){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
        return simpledateformat.format(date);
    }
//--------------------------------------------------------------

	function managerPreAction(){
		//設定主管簽核姓名
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		dataMap.put(&quot;Verify_ID&quot;,Server.getMember(MyTask.getRealExecutor()).getLoginID() );		
		dataMap.put(&quot;Verify_Name&quot;,Server.getMember(MyTask.getRealExecutor()).getName() );
		//清簽核欄
		dataMap.put(&quot;Agree&quot;,&quot;true&quot;);
		dataMap.put(&quot;Reject&quot;,&quot;false&quot;);
		dataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
	}



//-------------------------------------
//有多少職務
//-------------------------------------
function checkMulti_Role_Size(mID){
	//var vec_role = cMember.getAllRoleList(); //這個有含 prj role
	var sql_rol = &quot;SELECT d.Name + &apos;_&apos; + rg.Name + &apos;_&apos; + rg.RolID AS role,rg.RolID roleid,d.id depid,d.name depname &quot;
		+ &quot;  FROM Rol_Mem rm  INNER JOIN Rol_GenInf rg ON rm.RolID = rg.RolID INNER JOIN &quot; 
        + &quot; Dep_GenInf d ON rg.DepID = d.DepID &quot;
		+ &quot; WHERE   (rm.MemID = &apos;&quot;+ mID +&quot;&apos;) &quot;;
	var vec_role = Server.SQLloadValue(sql_rol);
	return vec_role.size();
}


//===============================================================================
// Server.SQLloadValue 抓一個值回來
//===============================================================================
function getKeyValue(sql){
	var keyvalue = &quot;&quot;;
	var data = Server.SQLloadValue(sql);
	if(data != null &amp;&amp; data.size()&gt;0){
		keyvalue = data.get(0).get(&quot;keyvalue&quot;);
	}
	return keyvalue;
}

//===============================================================================
// DBConn.loadValue 抓一個值回來
//===============================================================================
function getKeyValueByDBConn(sql,conn_erp){
		var keyvalue = &quot;&quot;;
		var data = conn_erp.loadValue(sql);
		if(data.size() &gt; 0 ){
				keyvalue = data.get(0).get(&quot;keyvalue&quot;);
		}
		return keyvalue;
}

//===============================================================================
// 丟 Y 或 N 進去換 true / false
//===============================================================================
function changeBoolean(YN){
	var flg = true;
	if(&quot;N&quot;.equals(YN)){
		flg = false;		
	}
	return flg;
}

//===============================================================================
// 用來切字串，如去掉小數點 str = &quot;.&quot;
//===============================================================================
function subStringB(s,str){
	try{
	if(s != null &amp;&amp; s.length() &gt; 1 ){
		//s = s.substring(s.lastIndexOf(str)+1); //後
		s = s.substring(0,s.lastIndexOf(str)); //前
	}
	}catch(e){}
	return s;
}

//===============================================================================
// 用來切字串，如去掉小數點 str = &quot;.&quot; s 為 java string
//===============================================================================
function subStringA(s,str){
	try{
	if(s != null &amp;&amp; s.length &gt; 1 ){
		//s = s.substring(s.lastIndexOf(str)+1); //後
		s = s.substring(0,s.lastIndexOf(str)); //前
	}
	}catch(e){}
	return s;
}

		
	function setManager(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var App_MemID = dataMap.get(&quot;App_MemID&quot;);
		var App_mem = Server.getMember(App_MemID);
		var Manager_ID = &quot;Administrator&quot;;
		if(App_mem != null){
			Manager_ID = App_mem.getPager();
		}
		dataMap.put(&quot;Next_Member_ID&quot;,Manager_ID);
		dataMap.put(&quot;Manager_ID&quot;,Manager_ID);
		
	}

	
	
	function initialProcess_wolf(){	
	//抓取文件狀態
	var artState = MyTask.getArtInstance().getArtState().getName();
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	//使用者姓名
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	if(artState == &quot;初始化&quot; ){
		initialForm_wolf(dataMap);
	}else if (artState != &quot;主管駁回&quot;){
		//dataMap.put(&quot;VerifyName&quot;,sUserName);
	}
		//判斷下一關主管用，被駁回時也要 update
		var roleID = MyTask.getRoleID();
		dataMap.put(&quot;From_User_ID&quot;,cMember.getID());
		dataMap.put(&quot;From_User_Role_ID&quot;,roleID);
		dataMap.put(&quot;Next_Member_Role&quot;,&quot;&quot;); 
		dataMap.put(&quot;Next_Member_ID&quot;,&quot;&quot;);
	
}


function initialForm_wolf(dataMap){
	//抓取使用者相關資料
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	//使用者姓名
	var roleID = MyTask.getRoleID();
	var memDR = cMember.getMemberDR(roleID);
	var sDepName = memDR.getDepartmentName();	//使用者部門名稱
	var sDepID = Server.getDepartment(memDR.getDepartmentID()).getMyID();
	var sRoleName = memDR.getRoleName();	//使用者職務名稱
	var sCompanyID = cMember.getAreaCode(); //使用者公司代碼
	
		
	
		dataMap.put(&quot;Creator&quot;,sUserName+&quot;(&quot;+cMember.getMyID()+&quot;)&quot;);
		dataMap.put(&quot;Creator_ID&quot;,cMember.getMyID());
		
		dataMap.put(&quot;App_MemID&quot;,mID);
			
		dataMap.put(&quot;App_DepID&quot;,memDR.getDepartmentID());		//&quot;DEPxxx&quot;	
		dataMap.put(&quot;Factory&quot;,&quot;(&quot; + sCompanyID + &quot;)&quot;);//廠別
		
		dataMap.put(&quot;Create_Date&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
}

	
	function setManager_wolf(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();		
		var mID = MyTask.getRealExecutor();	   
	    var roleID = MyTask.getRoleID();
		dataMap.put(&quot;App_MemID&quot;,&quot;&quot;);
			dataMap.put(&quot;App_MemID&quot;,mID);
		var App_mem = Server.getMember(mID);
		var Manager_ID = &quot;Administrator&quot;;
		if(App_mem != null){
			Manager_ID = App_mem.getPager();
		}
		dataMap.put(&quot;Next_Member_ID&quot;,Manager_ID);
		
		var nextmember = Server.getMemberByID(Manager_ID) ;
  	    nextmember = Server.getMember(Manager_ID) ;
	    var nextroleID = nextmember.getMainRoleID();

		dataMap.put(&quot;Next_Member_Role&quot;,nextroleID)
		
	}
	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>20070528</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00031195270894828</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/11/17 11:41:34</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Server.AddASAudit</string> 
     </void> 
     <void property="id"> 
      <string>SCL00031195270894828</string> 
     </void> 
     <void property="name"> 
      <string>AddASAudit</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021156610951562</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

//設定會簽人員 from table
function addAddASAudit(sign_table,itemid){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var vac = dataMap.get(sign_table);
	if(vac.size()&gt;0){
		MyTask.setExecuteAddAS(true);
		MyTask.setAddASType(MyTask.ADD_PARALLEL_ANNOUNCE);
		//MyTask.addAddASAudit(&quot;MEM01619&quot;,&quot;ROLH010ACF&quot;,&quot;DEPH010A&quot;);
        for(var i = 0;i&lt; vac.size();i++){
           try{
			   var username = vac.get(i).get(itemid);
               var member = Server.getMember(username);
               if(member != null){
				   var roleid = member.getMainRoleID();
                   if(roleid == &apos;&apos;){
					   var rolelist = member.getRoleList()
					   if(rolelist.size()&gt;0){
						   roleid = rolelist.get(0);
					   }
                    }
				  var memberdr = member.getMemberDR(roleid);
				  var depid = memberdr.getDepartmentID();
                  MyTask.addAddASAudit(member.getID(),roleid ,depid);
                  }
		    }catch(e){}
		}
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00031203786161875</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2014/08/11 10:59:14</string> 
     </void> 
     <void property="fullName"> 
      <string>com.eland.dms.DMSAP</string> 
     </void> 
     <void property="id"> 
      <string>SCL00031203786161875</string> 
     </void> 
     <void property="name"> 
      <string>DMSAP</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011203496283609</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//loadLibrary(&quot;com.eland.dms.DMSAP&quot;);

	
//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P,ArtName){	
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);  // ---- add by wangwei@2009/04/07
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	var vStatus=Form.getValue(&quot;Status&quot;);//
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
//			try{
			var hm = vec.get(i);			
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
// ----------------------------				
				var vMemList = getUnsignMemName(task); // 加會簽
					if(&quot;&quot;==vMemList){
						vMemList = getUnsignMemNameExt(task);
						}
// ------------------------------------------	
				var row = table.newRow()-1;					
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				if(asign_member(task)==&quot;&quot; &amp;&amp; vMemList==&quot;&quot;){
					table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);				
				}else{
					if (vMemList==&quot;&quot;){
						table.setValueAt(asign_member(task),  row, &quot;目前處理者&quot;);	}else
					{
						table.setValueAt(vMemList,  row, &quot;目前處理者&quot;);
					}			
					}
				//table.setValueAt(getPriorityString(task), i, &quot;緊急程度&quot;);			
				table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
				table.setValueAt(hm.get(&quot;ITEM10&quot;),    	row, &quot;表單編號&quot;);			
				table.setValueAt(hm.get(&quot;ITEM186&quot;), 	row, &quot;部門&quot;);
				table.setValueAt(hm.get(&quot;ITEM24&quot;),  	row, &quot;申請人姓名&quot;);
				table.setValueAt(hm.get(&quot;ITEM12&quot;),   	row, &quot;填寫日期&quot;);			
				table.setValueAt(hm.get(&quot;ITEM106&quot;),   	row, &quot;文件標題&quot;);
				table.setValueAt(hm.get(&quot;ITEM51&quot;),  	row, &quot;文件類別&quot;);
				table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
//文件新增申請單 - ITEM132
//文件變更確認單 -ITEM147
				if(&quot;文件新增申請單&quot;==ArtName){
					table.setValueAt(hm.get(&quot;ITEM132&quot;),row, &quot;訓練天數&quot;);
					table.setValueAt(hm.get(&quot;ITEM87&quot;),row, &quot;生效日期&quot;);
				}
				if(&quot;文件變更確認單&quot;==ArtName){
					table.setValueAt(hm.get(&quot;ITEM147&quot;),row, &quot;訓練天數&quot;);
					table.setValueAt(hm.get(&quot;ITEM87&quot;),row, &quot;生效日期&quot;);					
				}	
				if(&quot;文件變更確認單&quot;!=ArtName &amp;&amp; &quot;文件新增申請單&quot;!=ArtName){  // add by wangwei@2014/08/11
					var hideCols = [&quot;訓練天數&quot;,&quot;生效日期&quot;];
					table.setColHiding(hideCols);
				}else{
					var hideCols = [];
					table.setColHiding(hideCols);					
				}
				
			}
	
//			}catch(e){
//				Form.showMessageDialog(&quot;!!注意!!讀取資料有誤!請與系統負責人聯繫!!&quot;);	
//			}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	// 起始日期
    if(&quot;true&quot;==Form.getValue(&quot;FR_app&quot;)){  // 申請日期
		var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
		if (&quot;true&quot;.equals(ckbSDate)){	
			var sDate = Form.getValue(&quot;sDate&quot;);	
			if (!&quot;&quot;.equals(sDate)) {
				sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
			}
		}	
	// 終止日期
		var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
		if (&quot;true&quot;.equals(ckbEDate)){	
			var eDate = Form.getValue(&quot;eDate&quot;);	
			if (!&quot;&quot;.equals(eDate)) {
				sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
			}
		}	
	}else{                                    // 生效日期
		var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
		if (&quot;true&quot;.equals(ckbSDate)){	
			var sDate = Form.getValue(&quot;sDate&quot;);	
			if (!&quot;&quot;.equals(sDate)) {
				sSQL += &quot; AND ITEM87 &gt;= &apos;&quot; + sDate + &quot;&apos;&quot;;
			}
		}	
	// 終止日期
		var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
		if (&quot;true&quot;.equals(ckbEDate)){	
			var eDate = Form.getValue(&quot;eDate&quot;);	
			if (!&quot;&quot;.equals(eDate)) {
				sSQL += &quot; AND ITEM87 &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;
			}
		}			
			
	}
	
	// 部門名稱
	var DepName = Form.getValue(&quot;DepName&quot;);	
	if (!&quot;&quot;.equals(DepName)) {
		sSQL += &quot; AND ITEM186= &apos;&quot; + DepName + &quot;&apos;&quot;;
	}
	// 申請人姓名
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM24= &apos;&quot; + MemName + &quot;&apos;&quot;;
	}	
	// 文件編號 item16 是 sn 表單編號不要混到
	var sn= Form.getValue(&quot;Sn&quot;);	
	var artifact_name = Form.getValue(&quot;Artifact&quot;);		

	if (&quot;文件變更申請單&quot;==artifact_name){
		if (!&quot;&quot;.equals(sn)) {
			sSQL += &quot; AND ITEM83 like &apos;%&quot; + sn + &quot;%&apos;&quot;;
		}
	}else{
		if (!&quot;&quot;.equals(sn) &amp;&amp; artifact_name!=&quot;ISO文件申請單&quot;) {
			sSQL += &quot; AND ITEM84 like &apos;%&quot; + sn + &quot;%&apos;&quot;;	
		}					
	}
	// 文件標題
	if(&quot;ISO文件申請單&quot;!=artifact_name){
		var DocName = Form.getValue(&quot;Subject&quot;);	 
		if (!&quot;&quot;.equals(DocName)) {
			sSQL += &quot; AND ITEM106 like &apos;%&quot; + DocName + &quot;%&apos;&quot;;
		}
	}
	
	//
	var vFC_cancel= Form.getValue(&quot;FC_cancel&quot;)//含作廢否
	if (!&quot;true&quot;.equals(vFC_cancel)){	
		sSQL += &quot; AND ITEM155 = &apos;false&apos; &quot;;		
		}
	// 文件類別
	var DocTypeName = Form.getValue(&quot;DocTypeName&quot;);	 
	if (!&quot;--&quot;.equals(DocTypeName)) {
		sSQL += &quot; AND ITEM51 like &apos;%&quot; + DocTypeName + &quot;%&apos;&quot;;
	}
	//文件狀態
	var Status = Form.getValue(&quot;Status&quot;);	 
	if (!&quot;全部&quot;.equals(Status)) {
			if (&quot;已結案&quot;.equals(Status)) {
				sSQL += &quot; AND ITEM115 is not null &quot;;
			}else if (&quot;未結案&quot;.equals(Status)){
				sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
			}				
	}	
	return sSQL;
}


function asign_member(task){		
//  讀取是否有子流程 ---------------------------------------------
	try{
		var vTskID=task.getID(); // 取task ID
		var sql_t = &quot; select *from Task_CreatePro  where tskid = &apos;&quot;+vTskID+&quot;&apos; and iscomplete = &apos;false&apos;  &quot;;
		var vec_t = Client.SQLloadValue(sql_t);
			if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
			   var vName = &quot;&quot;;
			   for(var r = 0;r&lt;vec_t.size();r++){
				   var r_task = Client.getTask(vec_t.get(r).get(&quot;CPROOTTSKID&quot;));
				   var vMid = r_task.getRealExecutor();
				   var vExec = Client.getMemberByID(vMid).getName();
					   vName = vName+vExec+&quot;;&quot;;
				}
			  }else{
			    var vName = &quot;&quot;;
			  }
		}catch(e){}
	return vName;		
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>應用程式:文件查詢</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00031211433598746</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/02/22 13:27:03</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.MAN.updateArtForm</string> 
     </void> 
     <void property="id"> 
      <string>SCL00031211433598746</string> 
     </void> 
     <void property="name"> 
      <string>updateArtForm</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001209032361851</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//com.gce.MAN.updateArtForm
// 更新已核准之申請單狀態
function updateStatus( vStatus ){ 
	   var artIns = MyTask.getArtInstance(); 
	   var artid  = artIns.getArtifactID();	  	
	   var vID = artIns.getID(); // 報告單單號
	   var dataMap = artIns.getAppDataMap();
	   var vSn = dataMap.get(&quot;Sn&quot;);  			// 報告單編號
	   var vInsID = dataMap.get(&quot;InsID&quot;);  		// 申請單單號	   
	   var vFrom = dataMap.get(&quot;new_or_old&quot;);   // 來源 EZFlow or AF
	   var vapp_sn = dataMap.get(&quot;app_sn&quot;)       //申請單編號
//單狀態0:申請單簽核中1:申請單已核准2:報告單審核中9:報告單已核准	
	  var vJ00001a901=&quot;&quot; ;
		 if( vStatus==&quot;1&quot; ){
				var vJ00001a901=&quot;&quot; ;
			}							
		 if( vStatus==&quot;2&quot; ){
				var vJ00001a901=&quot;報告單審核中&quot; ;
			}				
		 if( vStatus==&quot;9&quot; ){
				var vJ00001a901=&quot;報告單結案&quot; ;
			}
		if( vFrom==&quot;EZFlow&quot; ){
			 if( vStatus==&quot;1&quot; ){
			 		var vJ00001a900 = &quot;N&quot;;     	// 沒有報告單
					vID=&quot;&quot;
				}							
			 if( vStatus==&quot;2&quot; ){
			 		var vJ00001a900 = &quot;Y&quot;;		// 有報告單
				}				
			 if( vStatus==&quot;9&quot; ){
			 		var vJ00001a900 = &quot;Y&quot;;		// 有報告單
				}								
			try{
				var conn_oa = Server.createSessionConnection(&quot;EZFlow&quot;);
		  		var sql_update = &quot; update j00001a set j00001a900 = &apos;&quot;+vJ00001a900 +&quot;&apos; ,j00001a901 = &apos;&quot;+vJ00001a901+&quot;&apos; ,InsID= &apos;&quot;+vID+&quot;&apos; where j00001a002=&apos;&quot;+vInsID+&quot;&apos;&quot;;
				conn_oa.updateValue(sql_update);	
				conn_oa.commit();									
			}catch(e){}
//			conn_oa.close();	
			if(conn_oa != null)	{
				conn_oa.close();					
				}	
			}
		if( vFrom==&quot;AF&quot; ){	
			 if( vStatus==&quot;1&quot; ){
				 vID=&quot;&quot;;                  	  			 // 沒有報告單
				 vSn=&quot;&quot;;
				 }
// 2016/06/01 改用API　update Form Value				 
			var vAPPArtForm = Server.getArtInstance(vInsID);
			vAPPArtForm.setAppValue(&quot;InsID&quot;,vID);
			vAPPArtForm.setAppValue(&quot;rep_sn&quot;,vSn);		
			vAPPArtForm.setAppValue(&quot;report_sn&quot;,vSn);		
			vAPPArtForm.setAppValue(&quot;status&quot;,vStatus);		
			vAPPArtForm.setAppValue(&quot;report_status&quot;,vJ00001a901);	
			Server.updateArtInstance(vAPPArtForm);   // add by wangwei@2016/06/07 12:52
			Server.addDebugLog(&quot;Call updateStatus 原物枓報告單:&quot;+vSn+&quot;狀態:&quot;+vJ00001a901+&quot;申請單:&quot;+vapp_sn + &quot;INSID:&quot;+vInsID); // add by wangwei@2016/06/07
			try{		// 2016/06/30 再加上SQL update 
			var sql_update = &quot;update ART00031208141153140_INS set &quot;;
				sql_update += &quot; ITEM170 =&apos;&quot;+vStatus +&quot;&apos;, &quot; ;  // 原ITEM131 --&gt;170@2016/05/27
				sql_update += &quot; ITEM154 = &apos;&quot;+ vID+&quot;&apos;, &quot;;  // 報告單單號  InsID
				sql_update += &quot; ITEM160 = &apos;&quot;+ vSn+&quot;&apos; &quot;;	 // 報告單編號	rep_sn		
				sql_update += &quot; where ITEM10=&apos;&quot;+ vapp_sn +&quot;&apos;&quot;; // 申請單編號				2016/05/27 改為申請單編號
//				sql_update += &quot;where insid=&apos;&quot;+ vInsID +&quot;&apos;&quot;; // 申請單單號				
				Server.SQLupdateValue(sql_update );
				Server.addDebugLog(&quot;Call updateStatus原物枓報告單 SQL:&quot;+sql_update);
			var sql_update = &quot;update ART00031208141153140_log set &quot;;
				sql_update += &quot; ITEM170 =&apos;&quot;+vStatus +&quot;&apos;, &quot; ;  // 原ITEM131 --&gt;170@2016/05/27
				sql_update += &quot; ITEM154 = &apos;&quot;+ vID+&quot;&apos;, &quot;;  // 報告單單號  InsID
				sql_update += &quot; ITEM160 = &apos;&quot;+ vSn+&quot;&apos; &quot;;	 // 報告單編號	rep_sn		
				sql_update += &quot; where ITEM10=&apos;&quot;+ vapp_sn +&quot;&apos;&quot;; // 申請單編號				2016/05/27 改為申請單編號				
				Server.SQLupdateValue(sql_update );
			}catch(e){
				Server.addErrLog(&quot;原物料報告單call updateStatus ERROR:&quot;+sql_update);
			}
		}

}
/*
SELECT insid as InsID, 
      ITEM10 as sn ,
      ITEM24 as app_name ,
      ITEM60 as Subject,
      ITEM62 as supply_name,
      ITEM154 as insid,
      ITEM160 as rep_sn,
      ITEM131 as status,
      &apos;AF&apos; as com_from  
FROM ART00031208141153140_INS ;
*/


function getQueryCondition(vColumn){
	var sSQL=&quot;&quot;;
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
		}
	}	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
		}
	}
	// 部門名稱
	var DepName = Form.getValue(&quot;DepName&quot;);	
	if (!&quot;&quot;.equals(DepName)) {
		sSQL += &quot; AND ITEM186= &apos;&quot; + DepName + &quot;&apos;&quot;;
	}
	// 申請人姓名
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM24= &apos;&quot; + MemName + &quot;&apos;&quot;;
	}	
	// 文件編號 item16 是 sn 表單編號不要混到
	var sn= Form.getValue(&quot;Sn&quot;);	
	if (!&quot;&quot;.equals(sn)) {
		sSQL += &quot; AND ITEM10 like &apos;&quot; + sn + &quot;%&apos;&quot;;
	}
	// 文件標題
	var DocName = Form.getValue(&quot;Subject&quot;);	 
	if (!&quot;&quot;.equals(DocName)) {
		sSQL += &quot; AND &quot;+vColumn +&quot; like &apos;%&quot; + DocName + &quot;%&apos;&quot;;
	}
	
	// 文件類別
	var DocTypeName = Form.getValue(&quot;DocTypeName&quot;);	 
	if (!&quot;--&quot;.equals(DocTypeName)) {
		sSQL += &quot; AND ITEM51 like &apos;%&quot; + DocTypeName + &quot;%&apos;&quot;;
	}
	//文件狀態
	var Status = Form.getValue(&quot;Status&quot;);	 
	if (!&quot;全部&quot;.equals(Status)) {
			if (&quot;已結案&quot;.equals(Status)) {
				sSQL += &quot; AND ITEM115 is not null &quot;;
			}else if (&quot;未結案&quot;.equals(Status)){
				sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
			}				
	}	
	// 若是申請單則再檢查是否查詢報告單 add by wangwie@2016/05/27	
	if (vColumn == &quot;ITEM60&quot;){
		var vRepState = Form.getValue(&quot;report_status&quot;);
		if(vRepState==&quot;沒有報告單&quot;){
			//sSQL += &quot; AND ITEM170 not in ( &apos;2&apos;,&apos;9&apos;) &quot;	// 
			sSQL += &quot; AND ITEM10 not in ( select rep.item27 from ART00041208747409078_ins rep where  rep.item27 is not null and rep.item155 =&apos;false&apos; )&quot;;			
		}else if(vRepState==&quot;報告單審核中&quot;){
			sSQL += &quot; AND ITEM170 = &apos;2&apos; &quot;	// 
		}else if(vRepState==&quot;報告單已核准&quot;){
			sSQL += &quot; AND ITEM170 = &apos;9&apos; &quot;	// 
		}
	}  //-------------------------------------------------------------
		
	return sSQL;
}
//===========================================================================================
function showTable(P,vForm){	
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);  // ---- add by wangwei@2009/04/07
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var vCancelFlag = Form.getValue(&quot;cancel_flag&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);

	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		try{
		for (var i = (P-1)*N ; i &lt; E; i++) {		
			var hm = vec.get(i);
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var roottask = Client.getTask(task.getRootID());
				var processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;
				}else if(&quot;complete&quot; == roottask.getTaskState()){
					processname = &quot;已結案&quot;;
					var vProcessTime = roottask.getProcessTime()/86400000;
				}		
// ----------------------------				
				var vMemList = getUnsignMemName(task); // 加會簽
					if(&quot;&quot;==vMemList){
						vMemList = getUnsignMemNameExt(task);
						}
// ------------------------------------------						
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
			}			
			if( &quot;false&quot; == hm.get(&quot;ITEM155&quot;) || &quot;true&quot; == hm.get(&quot;ITEM155&quot;)&amp;&amp; vCancelFlag.equals(&quot;true&quot;)  ){
				var row = table.newRow()-1;				
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);			
				if(&quot;&quot;==vMemList){
					table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);				
				}else{
					table.setValueAt(vMemList,  row, &quot;目前處理者&quot;);				
					}
//  再去讀取是否有子流程 ---------------------------------------------
					var vTskID=task.getID(); // 取task ID
					var sql_t = &quot; select *from Task_CreatePro  where tskid = &apos;&quot;+vTskID+&quot;&apos; and iscomplete = &apos;false&apos;  &quot;;
					var vec_t = Client.SQLloadValue(sql_t);
					if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
						var vName = &quot;&quot;;
						for(var r = 0;r&lt;vec_t.size();r++){
							var r_task = Client.getTask(vec_t.get(r).get(&quot;CPROOTTSKID&quot;));
							var vMid = r_task.getRealExecutor();
							var vExec = Client.getMemberByID(vMid).getName();
								vName = vName+vExec+&quot;;&quot;;
						}
						table.setValueAt(vName,  row, &quot;目前處理者&quot;);
						table.setValueAt(&quot;相關單位主管會簽&quot;,   row, &quot;目前關卡&quot;);	
					}
//-----------------------------------------------------------------------------------------	
				table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
				table.setValueAt(hm.get(&quot;ITEM10&quot;),    	row, &quot;表單編號&quot;);			
				table.setValueAt(hm.get(&quot;dptno&quot;), 	row, &quot;部門&quot;);
				table.setValueAt(hm.get(&quot;ITEM24&quot;),  	row, &quot;申請人姓名&quot;);
				table.setValueAt(hm.get(&quot;ITEM12&quot;),   	row, &quot;填寫日期&quot;);			
				table.setValueAt(hm.get(&quot;Subject&quot;),   	row, &quot;原物料名稱&quot;);
				table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
				table.setValueAt(hm.get(&quot;ITEM113&quot;),   	row, &quot;StartTime&quot;);
				table.setValueAt(hm.get(&quot;ITEM115&quot;),   	row, &quot;簽核結束日&quot;);
				table.setValueAt(vProcessTime,   	row, &quot;ProcessTime&quot;);
				if(&quot;作廢&quot;==processname||&quot;已結案&quot;==processname){  // add by wangwei@2011/11/01 
					table.setValueAt(&quot;--&quot;,  row, &quot;目前處理者&quot;);
				}
				if(vForm==&quot;APP&quot;){
					table.setValueAt(hm.get(&quot;SN&quot;), row, &quot;報告單編號&quot;);
					var hideCols = [&quot;申請單編號&quot;,&quot;ins_app_rep&quot;,&quot;ProcessTime&quot;,&quot;StartTime&quot;,&quot;原物料類別&quot;,&quot;供應商名稱&quot;,&quot;使用製程&quot;];  //,&quot;EndTime&quot; 因採購要求show 這欄位 modi by wangwei@2017/12/258
				} else if(vForm==&quot;REP&quot;){	
					table.setValueAt(hm.get(&quot;MType&quot;),  	row, &quot;原物料類別&quot;);
					table.setValueAt(hm.get(&quot;Vender&quot;),   row, &quot;供應商名稱&quot;);
					table.setValueAt(hm.get(&quot;UseProcess&quot;),  row, &quot;使用製程&quot;);	
					table.setValueAt(hm.get(&quot;SN&quot;), row, &quot;申請單編號&quot;);
					var hideCols = [&quot;報告單編號&quot;,&quot;ins_app_rep&quot;,&quot;ProcessTime&quot;,&quot;StartTime&quot;,&quot;簽核結束日&quot;];
				}else{
					table.setValueAt(hm.get(&quot;SN&quot;), row, &quot;申請單編號&quot;);
					var hideCols = [&quot;報告單編號&quot;,&quot;ins_app_rep&quot;,&quot;ProcessTime&quot;,&quot;StartTime&quot;,&quot;簽核結束日&quot;,&quot;原物料類別&quot;,&quot;供應商名稱&quot;,&quot;使用製程&quot;];					
				}
				table.setColHiding(hideCols);
			}
			
		}
		}catch(e){}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
function getTaskByInsID(InsID){
	var task = null;
	var vecTask = Client.SQLloadValue(&quot;select max(tskid) taskid from task_artins where insid =&apos;&quot;+ InsID +&quot;&apos;&quot;);
	if(vecTask.get(0).get(&quot;taskid&quot;) != null ){
		task = Client.getTask(vecTask.get(0).get(&quot;taskid&quot;));
	}
	return task;
}


function getQueryCondition_a(vColumn){
	var sSQL=&quot;&quot;;
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			sSQL += &quot; AND ITEM10 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
		}
	}	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM10 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
		}
	}
	// 部門名稱
	var DepName = Form.getValue(&quot;DepName&quot;);	
	if (!&quot;&quot;.equals(DepName)) {
		sSQL += &quot; AND ITEM186= &apos;&quot; + DepName + &quot;&apos;&quot;;
	}
	// 申請人姓名
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM24= &apos;&quot; + MemName + &quot;&apos;&quot;;
	}	
	// 文件編號 item16 是 sn 表單編號不要混到
	var sn= Form.getValue(&quot;Sn&quot;);	
	if (!&quot;&quot;.equals(sn)) {
		sSQL += &quot; AND ITEM60 like &apos;&quot; + sn + &quot;%&apos;&quot;;
	}
	// 文件標題
	var DocName = Form.getValue(&quot;Subject&quot;);	 
	if (!&quot;&quot;.equals(DocName)) {
		sSQL += &quot; AND &quot;+vColumn +&quot; like &apos;%&quot; + DocName + &quot;%&apos;&quot;;
	}
	
	// 文件類別
	var DocTypeName = Form.getValue(&quot;DocTypeName&quot;);	 
	if (!&quot;--&quot;.equals(DocTypeName)) {
		sSQL += &quot; AND ITEM51 like &apos;%&quot; + DocTypeName + &quot;%&apos;&quot;;
	}
	//文件狀態
	var Status = Form.getValue(&quot;Status&quot;);	 
	if (!&quot;全部&quot;.equals(Status)) {
			if (&quot;已結案&quot;.equals(Status)) {
				sSQL += &quot; AND ITEM115 is not null &quot;;
			}else if (&quot;未結案&quot;.equals(Status)){
				sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
			}				
	}	
	// 若是申請單則再檢查是否查詢報告單 add by wangwie@2016/05/27	
	if (vColumn == &quot;ITEM60&quot;){
		var vRepState = Form.getValue(&quot;report_status&quot;);
		if(vRepState==&quot;沒有報告單&quot;){
			sSQL += &quot; AND ITEM170 not in ( &apos;2&apos;,&apos;9&apos;) &quot;	// 
		}else if(vRepState==&quot;報告單審核中&quot;){
			sSQL += &quot; AND ITEM170 = &apos;2&apos; &quot;	// 
		}else if(vRepState==&quot;報告單已核准&quot;){
			sSQL += &quot; AND ITEM170 = &apos;9&apos; &quot;	// 
		}
	}  //-------------------------------------------------------------
		
	return sSQL;
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00031225701287691</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2015/12/24 13:13:41</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PH.PROCESS</string> 
     </void> 
     <void property="id"> 
      <string>SCL00031225701287691</string> 
     </void> 
     <void property="name"> 
      <string>PROCESS</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00321216878882287</string> 
     </void> 
     <void property="scriptSource"> 
      <string>  function setReject_first_tsk(){           
                     var artIns = MyTask.getArtInstance();
                     var dataMap = artIns.getAppDataMap();
                     var rootid = MyTask.getRootID();
                     //var vec = Server.getSubTaskList(rootid);
                     //for (var i=0;i&lt;vec.size();i++) {
                     //var Task=vec.get(i);
                     //}
                     //取得 rootid 後第一關
                     var sql_task = &quot;  select min(tskid) tskid from task where tskid != rootid and rootid =&apos;&quot;+ rootid +&quot;&apos;  &quot;;
                     var vec_task = Server.SQLloadValue(sql_task);                                                                                                 
                     //var task = Form.getCurrentTask();
                     //if (Client.checkTaskComplete(task)) {}
                     if(vec_task != null &amp;&amp; vec_task.size()&gt;0 &amp;&amp; vec_task.get(0).get(&quot;tskid&quot;)!= &quot;&quot;){
                     var first_tskid = vec_task.get(0).get(&quot;tskid&quot;);
                     var first_tsk = Server.getTask(first_tskid);
                     if( first_tsk != null){
                                                     //重送到提出者手上
                                                     //var realExecutorMemID = first_tsk.getRealExecutor();
                                                     //var memberRecord = Client.getMemberByID(realExecutorMemID);
                                                     //var current_member = Client.getCurrentMember();                                   
                                                     var first_processid = first_tsk.getProcessID();
                                                     //first_processid = &quot;SGN00791220930848976&quot; ;  
                                                     flg = Server.goBackTo(first_tskid,first_processid,true);          
                                           }
                     }                    
           }                    

		   
// com.gce.PH.PROCESS
// 設備驗收單簽核關卡的前置動作 add by wangwei@2012/01/27
function setPreAction(vChecklevel){
	var vProcessName = MyTask.getProcessName();
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
//	dataMap.put(&quot;CheckLevel&quot;,vChecklevel)
	dataMap.put(&quot;CheckLevel&quot;,getSeqByProcessName(vProcessName));	
	dataMap.put(&quot;GM_ADDS_FLAG&quot;,&quot;&quot;)  								// 將加會簽的Flag清空
	dataMap.put(&quot;ProcessName&quot;, vProcessName);	   					// add by wangwei@2012/09/03
	var AddAs_Table = dataMap.get(&quot;AddAs_Table&quot;);	   				// 加會簽的資料
	AddAs_Table.clear();	  	
}
		  
// 設備驗收單設定各關卡書記 add by wangwei2012/01/27		   
function setProcessClerk(vChecklevel){
	//取得表單資料
	if(vChecklevel==&quot;&quot;){
		return ;
	}
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();	
	  // 取得第一關簽核資料
	var vProcess_Table = dataMap.get(&quot;Process_List&quot;); //指定驗收關卡table
	var rowCount = vProcess_Table.size();//取得筆數
	var text=&quot;&quot;    
	var checklevel = vChecklevel   //&quot;1&quot;;  
	if (checklevel&lt;&quot;9&quot;){
		text=&quot;變更驗收窗口&quot;  
	}
	for( var i=0 ; i&lt;rowCount ; i++) {
		if( checklevel.equals(vProcess_Table.get(i).get(&quot;ITEM27&quot;))){ //i序號與checklevel相同，則抓取驗收的row	  
			if (vProcess_Table.get(i).get(&quot;ITEM12&quot;)== &quot;true&quot;){
				var Change_MemID   = vProcess_Table.get(i).get(&quot;ITEM10&quot;);   //關卡書記ID
				var Change_MemName = vProcess_Table.get(i).get(&quot;ITEM4&quot;);	//關卡書記名字
				var ME_MemID       = vProcess_Table.get(i).get(&quot;ITEM1&quot;);	//驗收窗口ID
				var ME_MemName     = vProcess_Table.get(i).get(&quot;ITEM8&quot;);	//驗收窗口名字		  
				var vVerify_Level  = vProcess_Table.get(i).get(&quot;ITEM3&quot;); 	//簽核等級
				dataMap.put(&quot;Verify_Level&quot;,vVerify_Level);
				dataMap.put(&quot;Verify_Note&quot;,text);
				if(Change_MemID==&quot;MEMT1022228&quot;){						// 李玉婷 ==&gt; 宋惠敏@2015/12/24
					Change_MemID=&quot;MEMT1015298&quot; ;
				}  
				dataMap.put(&quot;Change_MEMID&quot;,Change_MemID);
				dataMap.put(&quot;Change_Name&quot;,Change_MemName);	
				dataMap.put(&quot;Manager_ID&quot;,ME_MemID);
				dataMap.put(&quot;Manager_Name&quot;,ME_MemName);		
				dataMap.put(&quot;Next_Member_ID&quot;,&quot;&quot;);	   
		   } 		  
		}
	}   
}
// 設備驗收單關卡自動判斷流程走向  add by wangwei 2012/01/27
function setAutoFlowTo(vChecklevel){	
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var vProcess_Table = dataMap.get(&quot;Process_List&quot;); 				  	//指定驗收關卡table
	var rowCount = vProcess_Table.size(); 							  	//取得筆數
	var checklevel = vChecklevel ;  									//取得第 N 關簽核資料
	var index =&quot;&quot;;
	for( var i=0 ; i&lt;rowCount ; i++){
		if(checklevel.equals(vProcess_Table.get(i).get(&quot;ITEM27&quot;))){     //i序號與checklevel相同，則抓取驗收的row
			index = vProcess_Table.get(i).get(&quot;ITEM27&quot;);  			  	// 將第i筆記錄的&quot;序&quot;欄中的資料取出		  
			if (vProcess_Table.get(i).get(&quot;ITEM12&quot;)== &quot;true&quot;){	  
				Server.flowTo(MyTask,&quot;此關需要驗收&quot;);		  
			}else{
				Server.flowTo(MyTask,&quot;此關不需驗收&quot;);		 
			} 		  
		}
	}
	if (&quot;&quot;.equals(index)){   // 這是預防用
		Server.flowTo(MyTask,&quot;此關不需驗收&quot;);
	}  		
}


// 以簽核關卡名稱取seq
function getSeqByProcessName(vProcesName){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var vProcess_Table = dataMap.get(&quot;Process_List&quot;); 				  	//指定驗收關卡table
	var rowCount = vProcess_Table.size();
    var vSeq = &quot;0&quot;;   					 							  	//取得筆數
	for( var i=0 ; i&lt;rowCount ; i++){
		if(vProcesName.indexOf(vProcess_Table.get(i).get(&quot;ITEM9&quot;))&gt;=0){ // ITEM9 : 關卡名稱
			vSeq = vProcess_Table.get(i).get(&quot;ITEM27&quot;);  			    // 將第i筆記錄的&quot;序&quot;欄中的資料取出		  
		}
	}		
	return vSeq;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00031368775140247</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/09/05 14:53:27</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.AppRelated_SCH</string> 
     </void> 
     <void property="id"> 
      <string>SCL00031368775140247</string> 
     </void> 
     <void property="name"> 
      <string>AppRelated_SCH</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>getQUOTA//取得年假剩餘時數
function getRemainAnnual(){
	var App_ID = Form.getValue(&quot;App_ID&quot;);
	var App_MemID = Form.getValue(&quot;App_MemID&quot;);
	var abstype = Form.getValue(&quot;cbxType&quot;);
	var beginTerm; //上月月結時間
	var total = 0;
	var Ob_date = new Packages.pase.agenda.MyDate();
	var year = Ob_date.getCurrentYear();
	ConStartDate = Client.getMember(App_MemID).getOnBoardDate();//入廠日
	//未滿一年直接給0
	if (Ob_date.getSubtractDay(ConStartDate,Ob_date.toString().substring(0,10)) &lt; 365){
		return 0;
	}
	var dbname_KY = Form.getValue(&quot;dbname_KY&quot;);//嘉陽DB
	var conn_KY = Client.createSessionConnection(dbname_KY);
	var vec_KY;
	var sql_KY;
	try{
		var RestTotal = 0;
		var RestTotal_KY = 0;
		//(S)將該假別的時數取出，1.簽核未轉、結案未轉、本次已請、2.嘉楊系統內月結資料_已轉入時數
		//簽核未轉、結案未轉、本次已請
		
		RestTotal = getInProcApp(App_MemID,&quot;A.年假&quot;);
		
		//嘉楊系統內月結資料_已轉入時數
		sql_KY =  &quot; select badge,sum(num) abshours from V_aleaveregister_ALL &quot;;
		sql_KY += &quot;where badge=&apos;&quot; + App_ID + &quot;&apos; and year(begindate) =&apos;&quot; + year + &quot;&apos; &quot;;
		sql_KY += &quot;group by badge &quot;;
		vec_KY = conn_KY.loadValue(sql_KY);
		if(vec_KY.size() &gt; 0){
			if (vec_KY.get(0).get(&quot;abshours&quot;) &gt; 0){
				RestTotal_KY = vec_KY.get(0).get(&quot;abshours&quot;);
			}
		}
		//取上月月結時間(讀取嘉楊系統內的資料)
		sql_KY = &quot;select MAX(TERM) beginTerm  from oa_dinner_salary where type=&apos;salary&apos;&quot;;
		vec_KY = conn_KY.loadValue(sql_KY);		
		if(vec_KY.size() == 0){
			return &quot;無法連結HR DB！&quot;;
		}else{
			beginTerm = vec_KY.get(0).get(&quot;beginTerm&quot;);
		}
		//上月月結時結餘的時數(以下為新的語法，由andy提供)		
		//sql_KY  = &quot;select term,badge,name,depid,lastremain,haved,used,remind,tolremind  &quot;;
		//sql_KY += &quot;from aannual_all  &quot;;
		//sql_KY += &quot;where datediff(month,term,&apos;&quot;+ beginTerm +&quot;&apos;)=0 and badge=&apos;&quot;+App_ID+&quot;&apos; &quot;;
		if ((beginTerm+&quot;&quot;).substring(0,10).equals(&quot;2013-12-31&quot;)){
			sql_KY  = &quot;select term,badge,name,depid,lastremain,haved,used,remind,tolremind  &quot;;
			sql_KY += &quot;from aannual_all  &quot;;
			sql_KY += &quot;where datediff(month,term,&apos;2014-1-31&apos;)=0 and badge=&apos;&quot;+App_ID+&quot;&apos; &quot;;
		}else{
			sql_KY  = &quot;select term,badge,name,depid,lastremain,haved,used,remind,tolremind  &quot;;
			sql_KY += &quot;from aannual_all  &quot;;
			sql_KY += &quot;where datediff(month,term,&apos;&quot;+ beginTerm +&quot;&apos;)=0 and badge=&apos;&quot;+App_ID+&quot;&apos; &quot;;
		}		
		vec_KY = conn_KY.loadValue(sql_KY);
		var tolremind=0;
		if (vec_KY.size() == 0){
		}else{
			tolremind = vec_KY.get(0).get(&quot;haved&quot;) * 1 + vec_KY.get(0).get(&quot;lastremain&quot;) * 1;
			Client.addDebugLog(&quot;tolremind:&quot;+tolremind);
		}
		total = tolremind * 1 - RestTotal_KY * 1 - RestTotal * 1;
		Client.addDebugLog(&quot;大陸假單年假檢查:&quot;+App_ID+&quot;,可請:&quot;+tolremind+&quot;,已請:&quot;+RestTotal_KY +&quot;,簽核:&quot;+RestTotal);
	}catch(e){
		Client.addDebugLog(&quot;請假單異常_sql:&quot;+sql_KY);
	}finally{
		conn_KY.close();
	}
	return total;
}

//取得簽核中的時數
function getInProcApp(App_MemID,abstype){
	var RestTotal = 0;
	var sql  = &quot;select sum(i.item76) as abshours from ART00091301018362482_ins i &quot;;
		sql += &quot;where ((i.item149 = &apos;結案&apos; and i.item4 is null ) or i.item149 = &apos;簽核&apos;) &quot;;
		sql += &quot;and i.item43 = &apos;&quot; + App_MemID + &quot;&apos; and i.item23 = &apos;&quot; + abstype + &quot;&apos;&quot;;
	var vec = Client.SQLloadValue(sql);	
	if (vec.size() &gt; 0){
		if (vec.get(0).get(&quot;abshours&quot;) * 1 &gt; 0){
			Client.addDebugLog(&quot;abshours = &quot; + vec);
			RestTotal = vec.get(0).get(&quot;abshours&quot;);
			Client.addDebugLog(&quot;簽核中時數:&quot;+RestTotal);
		}
	}else{
		RestTotal = 0;
	}
	return RestTotal;	
}

function getRemainSalaryPrivate(){
	if (!Form.getValue(&quot;wkgreat&quot;).equals(&quot;M&quot;)){
		return 0;
	}
	var App_ID = Form.getValue(&quot;App_ID&quot;);
	var App_MemID = Form.getValue(&quot;App_MemID&quot;);
	var abstype = Form.getValue(&quot;cbxType&quot;);
	var beginTerm; //上月月結時間
	var total = 0;
	var Ob_date = new Packages.pase.agenda.MyDate();
	var year = Ob_date.getCurrentYear();
	var dbname_KY = Form.getValue(&quot;dbname_KY&quot;);//嘉陽DB
	var conn_KY = Client.createSessionConnection(dbname_KY);
	var vec_KY;
	var sql_KY;
	try{
		var RestTotal = 0;
		var RestTotal_KY = 0;
		//(S)將該假別的時數取出，1.簽核未轉、結案未轉、本次已請、2.嘉楊系統內月結資料_已轉入時數
		//簽核未轉、結案未轉、本次已請
		RestTotal = getInProcApp(App_MemID,&quot;D.有薪事假&quot;);
		//嘉楊系統內月結資料_已轉入時數
		var sql_KY =  &quot; select badge,leavetype,sum(num) abshours from &quot;;
			sql_KY += &quot;(select * from aleave_register_all where badge=&apos;&quot; + App_ID + &quot;&apos; and year(begindate) =&apos;&quot; + year + &quot;&apos; &quot;;
			sql_KY += &quot;and leavetype=&apos;SalaryPrivate&apos; &quot;;
			sql_KY += &quot;union &quot;;
			sql_KY += &quot;select * from aleave_register where badge=&apos;&quot; + App_ID + &quot;&apos; &quot;;
			sql_KY += &quot;and leavetype=&apos;SalaryPrivate&apos;) t   &quot;;
			sql_KY += &quot;group by badge ,leavetype order by leavetype &quot;;
			vec_KY = conn_KY.loadValue(sql_KY);
		if(vec_KY.size() &gt; 0){
			if (vec_KY.get(0).get(&quot;abshours&quot;) &gt; 0){
				RestTotal_KY = vec_KY.get(0).get(&quot;abshours&quot;);
			}
		}else{
			RestTotal_KY = 0;
		}
		var totalrest = 0;
		//一月份有薪事假強制為4小時，不參考cLeavePara_ALL。
		if (Form.getValue(&quot;txtStart&quot;).substring(5,7).equals(&quot;01&quot;)){
			totalrest = 4;				
		}else{
			sql_KY = &quot;select top 1 *,month(term) month from cLeavePara_ALL where badge =&apos;&quot; + App_ID + &quot;&apos; order by term desc&quot;;
			vec_KY = conn_KY.loadValue(sql_KY);
			if(vec_KY.size() &gt; 0){
				var thisMonth = Form.getValue(&quot;txtStart&quot;).substring(5,7);
				if (thisMonth - vec_KY.get(0).get(&quot;month&quot;) &gt;= 2){
					totalrest = vec_KY.get(0).get(&quot;salaryperleaves&quot;) * 1 + 8;
				}else{
					totalrest = vec_KY.get(0).get(&quot;salaryperleaves&quot;) * 1 + 4;
				}
			}
		}
		total = totalrest * 1 - RestTotal_KY * 1 - RestTotal * 1;
	}catch(e){
		Client.addDebugLog(e);
	}finally{
		conn_KY.close();
	}
	return total;
}


// 取得簽核中或結案同意未轉的該假別請假時數(大陸廠)(新)
function getOldAppFromForm(apply_type,thisDay,isSpecial,App_MemID){
	var myDate = new Packages.pase.agenda.MyDate();
	var oldApp;
	var year = thisDay.substring(0,4);
	// 與簽核中的比較運算,也要考慮為今年度的
	var sql =  &quot;select t.item11 hdate,i.ITEM17 empno,t.item3 apptype,t.item7 apphours,t.item4 appdate &quot;;
		sql += &quot; from ART01691418890220937_ins i , ART01691418890220937ITEM84 t &quot; ;
		sql += &quot; where i.INSID = t.INSID and i.ITEM43 =&apos;&quot;+ App_MemID	+&quot;&apos; &quot;	;
		sql += &quot; and (i.item149=&apos;簽核&apos; or (i.item149=&apos;結案&apos; and t.item13 is null  )) &quot; ;
		sql += &quot;and substr(t.item4,0,4)=&apos;&quot; + year + &quot;&apos;&quot;;
	Client.addDebugLog(&quot;getOldAppFromForm sql = &quot; + sql);
	oldApp = getOldApp(sql,thisDay,isSpecial,apply_type);
	return oldApp;
}

// 部分假別要做例外處理(大陸廠)(新)
function getOldApp(sql,thisDay,isSpecial,apply_type){
	var oldApp = 0;	
	var vec = Client.SQLloadValue(sql);
	var hdate;
	if(isSpecial){// 特殊假別,可以從tableAdv中抓出來				
		// 第一段:取得各特殊假別的發生日期
		hdate = Form.getValue(&quot;hDate&quot;);	
	}
	var thisYear = thisDay.split(&quot;/&quot;)[0];
	var thisMonth = thisDay.split(&quot;/&quot;)[1];
	if(vec.size()&gt;0){
		for(var i=0;i&lt;vec.size();i++){
			var result = vec.get(i);
			var apptype = result.get(&quot;apptype&quot;).trim();// 假別
			var index = apptype.indexOf(&quot;.&quot;);
			apptype = apptype.substring(0,index);
			var appdate = result.get(&quot;appdate&quot;);// 日期
			var apphours = result.get(&quot;apphours&quot;);// 時數
			apphours = getInt(apphours);
			if(apptype.equals(apply_type)){// 如果假別相同就計算已請過的時數				
				if(apptype.equals(&quot;L&quot;)||apptype.equals(&quot;J&quot;)||apptype.equals(&quot;k&quot;)||apptype.equals(&quot;K5&quot;) ||apptype.equals(&quot;K6&quot;)){
					var _hdate = result.get(&quot;hdate&quot;);// 發生日期
					if(_hdate.equals(hdate)){// 發生日期相同時計算
						oldApp += apphours;
					}					
				}else{// 其他假別計算請過的時數
					oldApp += apphours;
				}
			}
		}
	}
	return oldApp;
}

// 取得簽核中或結案同意未轉的該假別請假時數(大陸廠)(新)
function getOldAppFromForm4R(App_MemID,thisDay){

	
	var myDate = new Packages.pase.agenda.MyDate();
	var oldApp;
	var year = thisDay.substring(0,4);
	// 與簽核中的比較運算,也要考慮為今年度的
	var sql =  &quot;select t.item11 hdate,i.ITEM17 empno,t.item3 apptype,t.item7 apphours,t.item4 appdate &quot;;
		sql += &quot; from ART01691418890220937_ins i , ART01691418890220937ITEM84 t &quot; ;
		sql += &quot; where i.INSID = t.INSID and i.ITEM43 =&apos;&quot;+ App_MemID	+&quot;&apos; &quot;	;
		sql += &quot; and (i.item149=&apos;簽核&apos; or (i.item149=&apos;結案&apos; and t.item22 is null  )) &quot; ;
		sql += &quot;and substr(t.item4,0,4)=&apos;&quot; + year + &quot;&apos; and t.item3=&apos;R.調休假&apos;&quot;;
	oldApp = getOldApp(sql,thisDay,&quot;false&quot;,&quot;R&quot;);
	Client.addDebugLog(&quot;getOldAppFromForm4R sql = &quot; + sql);
	Client.addDebugLog(&quot;getOldAppFromForm4R oldApp = &quot; + oldApp);
	return oldApp;

	
}

function getQUOTA(col , empno , dbName , type){
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);	
	var cnt = 0;
	if (col.equals(&quot;i_cnt&quot;)){ //年假特殊判斷，加計去年延用邏輯 add by yingchieh@20170522
		//col = &quot;(i_cnt + i_last - (select nvl(sum(i_use_s),0) from empm217 where empno=&apos;&quot;+empno+&quot;&apos; and substr(salarytimes,0,4) = year(current)))  &quot;;
		var _format = new Packages.java.text.SimpleDateFormat(&quot;yyyy/MM/dd&quot;);
		var _format2 = new Packages.java.text.SimpleDateFormat(&quot;yyyy-MM-dd&quot;);
		var myDate = new Packages.pase.agenda.MyDate();	
		var thisDay = myDate.toString().substring(0,10);
		var YY = thisDay.substring(0,4);//取得請假年
		thisDay = _format2.format(_format.parse(thisDay));		
		var deadline = YY + &quot;-06-30&quot;;//I假延用時間		

		var p1_use = 0;//延用期間請的假
		var p2_use = 0 ;//非延用期間請的假
		
		// 取得該員當年度特休時數
		//增加年假抵扣排休(i_use_s) add by yingchieh@20170706
		var sql =  &quot; select first 1 i_cnt,i_last, (select nvl(sum(i_use_s),0) from empm217 where empno=&apos;&quot;+empno+&quot;&apos; and substr(salarytimes,0,4) = year(current)) i_use_s &quot;;
			sql += &quot; from empm217 where empno=&apos;&quot;+empno+&quot;&apos; and substr(salarytimes,0,4) =year(current) order by salarytimes desc;&quot;;
		var vec = loadSQL(sql,dbName);
		var QUOTA = 0 ;
		var QUOTA2 = 0 ;
		var i_use_s = 0;
		if(vec.size()&gt;0){ //確認QUOTA值
			var result = vec.get(0);
			var i_cnt = result.get(&quot;i_cnt&quot;);
			var i_last = result.get(&quot;i_last&quot;);
			var i_use_s = result.get(&quot;i_use_s&quot;);
			QUOTA = getInt(i_cnt);// 取得當年度特休時數
			QUOTA2 = getInt(i_last);// 取得去年度特休時數
		}	
		//取得延用期間請的假
		sql = &quot;select abstype, sum(timecnt) as sums from empm060 &quot;
			+ &quot;where empno=&apos;&quot;+empno+&quot;&apos; and absdate between &apos;&quot;+YY +&quot;-01-01&apos; and &apos;&quot;+ deadline
			+ &quot;&apos; and abstype in (&apos;I&apos;,&apos;V&apos;) group by abstype&quot;;
		vec = loadSQL(sql,dbName);
		if(vec.size()&gt;0){
			var result = vec.get(0);
			p1_use = result.get(&quot;sums&quot;);			
		}
		//取得非延用期間請的假
		sql = &quot;select abstype, sum(timecnt) as sums from empm060 &quot;
			+ &quot;where empno=&apos;&quot;+empno+&quot;&apos; and absdate between &apos;&quot;+myDate.addDay(deadline,1) +&quot;&apos; and &apos;&quot;+ YY +&quot;-12-31&apos; &quot;
			+ &quot;and abstype in (&apos;I&apos;,&apos;V&apos;) group by abstype&quot;;
		vec = loadSQL(sql,dbName);
		if(vec.size()&gt;0){
			var result = vec.get(0);
			p2_use = result.get(&quot;sums&quot;);			
		}
		if(thisDay &lt;= deadline){//可延用
			BFREE = getInt(QUOTA) + getInt(QUOTA2) - getInt(p1_use) - getInt(i_use_s);
			Client.addDebugLog(&quot;大陸廠請假單_i_cnt-sql:QUOTA=&quot;+QUOTA+&quot;,QUOTA2=&quot;+QUOTA2+&quot;,p1_use=&quot;+p1_use+&quot;,i_use_s=&quot;+i_use_s);
		}else{//不可延用
			if (p1_use &lt; QUOTA2){
				QUOTA2 = p1_use;
			}
			BFREE = getInt(QUOTA)+ getInt(QUOTA2) - getInt(p1_use) - getInt(p2_use) - getInt(i_use_s);
		}
		cnt = BFREE
	}else{
		if (col.equals(&quot;b_cnt&quot;)){ //事假要加上抵扣累計
			col = &quot;(b_cnt + b_cnt_back)  &quot;;
		}		
		var	sql  = &quot; select &quot; + col + &quot; col from empm217 where empno=&apos;&quot; + empno + &quot;&apos; order by salarytimes desc&quot;;
		var vec = loadSQL_new(sql , dbName , type);
		if(vec.size() &gt; 0){
			cnt = vec.get(0).get(&quot;col&quot;);
		}
	}	
	return cnt;
}

function getQUOTA4R(empno,thisDay , dbName , type){
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var cnt = 0;
	var sql =  &quot; select empm113.empno,(sum(case when empm113.classno=&apos;X&apos; Then 480 else empm090.ot2time end) /60 ) col &quot;;
		sql += &quot; from empm113, outer empm090 where empm113.classno=empm090.classno &quot;;
		sql += &quot; and  empno=&apos;&quot;+empno+&quot;&apos; and year(day)=&quot; + thisDay.substring(0,4) ;
		sql += &quot; and month(day)= &quot; + thisDay.substring(5,7)+ &quot; group by empm113.empno&quot;;
	var vec = loadSQL_new(sql , Form.getValue(&quot;dbName&quot;) ,&quot;大陸廠請假單_取得調休假上限時數&quot;);
	if(vec.size() &gt; 0){
		cnt = vec.get(0).get(&quot;col&quot;);
	}
	return cnt;
}

//R.調休假上限
function getQUOTA4R_new(empno,thisDay , dbName , type ,IDL){
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var cnt = 0;
	var sql = &quot;&quot;;
	var thisYear = thisDay.substring(0,4);
	var thisMonth = thisDay.substring(5,7);	
	Client.addDebugLog(&quot;DL or IDL&quot;+ IDL);
	if (IDL.equals(&quot;D&quot;)){
		sql =  &quot;select (count(*) * 10 ) col from empm113 where empno=&apos;&quot;+empno+&quot;&apos; &quot;;
		sql += &quot; and year(day)=&quot; + thisYear + &quot; and month(day) = &quot; + thisMonth ;
		sql += &quot; and classno in (&apos;A4&apos;,&apos;B4&apos;) ;&quot; ; 
		Client.addDebugLog(&quot;大陸廠請假單_取得調休假上限時數(1)-sql&quot;+sql);
		var vec = loadSQL_new(sql , dbName ,&quot;大陸廠請假單_取得調休假上限時數(1)&quot;);
		if(vec.size() &gt; 0){
			cnt = vec.get(0).get(&quot;col&quot;);
		}	
	}else{
		cnt = getQUOTA(&quot;o_cnt&quot; , empno , dbName , &quot;大陸廠請假單_取得當月補休假上限&quot;);
	}   
	return cnt;
}

//R.調休假上限(不足時則以當月的實際二倍加班時數為主)
function getQUOTA4R_new_a(empno,thisDay , dbName , type ,IDL){
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var cnt = 0;
	var sql = &quot;&quot;;
	var thisYear = thisDay.substring(0,4);
	var thisMonth = thisDay.substring(5,7);	
	sql =  &quot;select nvl(sum(over2),0) col from empm070 where empno =&apos;&quot; + empno + &quot;&apos; &quot;;
	sql += &quot;and year(overdate)=&quot; + thisYear + &quot; and month(overdate) = &quot; + thisMonth ;
	sql += &quot; and over_type=&apos;X&apos; ;&quot;;
	var vec = loadSQL_new(sql , dbName ,&quot;大陸廠請假單_取得調休假上限時數(2)&quot;);
	if(vec.size() &gt; 0){
		cnt = vec.get(0).get(&quot;col&quot;);
	}
	return cnt;
}

//取得台幹台灣廠對應的工號 add by yingchieh@20170324
function getTwEmpno(cname){
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var tempno = &quot;&quot;;
	var sql = &quot;&quot;;
	sql += &quot;select empno from empm020 where cname = &apos;&quot;+cname+&quot;&apos;;&quot;;
	var vec = loadSQL_new(sql , &quot;T-MES&quot; ,&quot;大陸廠請假單_取得台幹台灣廠帳號&quot;);
	if(vec.size() &gt; 0){
		tempno = vec.get(0).get(&quot;empno&quot;);
	}
	return tempno;
}


//R.調休假上限 新版  add by yingchieh@20170523
function getQUOTA4R_new_b(empno,thisDay , dbName , type ,IDL){
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var myDate = new Packages.pase.agenda.MyDate();	
	var thisDay_beg = myDate.addMonth(thisDay,-5);
	var thisDay_end = myDate.addMonth(thisDay,-1);
	var cnt = 0;
	var sql = &quot;&quot;;
	var thisYear = thisDay.substring(0,4);
	var thisMonth = thisDay.substring(5,7);		
	//sql += &quot;select sum(nvl(o_cnt_this_have,0) - nvl(o_cnt_this_use_r,0)) col from empm217 where empno =&apos;&quot;+empno+&quot;&apos; &quot;; 
	//sql += &quot;and o_cnt_this_enddate &gt;= &apos;&quot; + thisDay_beg.substring(0,4) + thisDay_beg.substring(5,7) + &quot;&apos; and salarytimes &lt;= &apos;&quot; + thisDay_end.substring(0,4)+thisDay_end.substring(5,7) + &quot;&apos;; &quot;;
	//var vec = loadSQL_new(sql , dbName , &quot;大陸廠請假單_取得當月補休假上限(20170523new)&quot;);
	sql += &quot;select nvl(sum(nvl(o_cnt_this_have,0) - nvl(o_cnt_this_use_r,0)),0) col from empm217 where empno =&apos;&quot;+empno+&quot;&apos; &quot;; 
	//sql += &quot;and o_cnt_this_enddate &gt;= date(current); &quot;;
	sql += &quot;and o_cnt_this_enddate &gt;= to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;); &quot;;
	var vec = loadSQL_new(sql , dbName , &quot;大陸廠請假單_取得當月補休假上限(20170703new)&quot;);
	if(vec.size() &gt; 0){
		cnt = vec.get(0).get(&quot;col&quot;);
	}
	return cnt;
}

// 用來取得已請假時數,資料庫的(調休假)
function apply_old4R_b(empno,thisDay,dbName){
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var empno = Form.getValue(&quot;App_ID&quot;);
	var apply_oldsum = 0;
	var sql = &quot;&quot;;
	sql +=  &quot;select sum(timecnt) as sums from empm060 where empno = &apos;&quot; + empno + &quot;&apos; &quot;;
	sql +=  &quot;and to_char(absdate,&apos;%Y%m&apos;) = &apos;&quot; + thisDay.substring(0,4)+thisDay.substring(5,7) + &quot;&apos; &quot;;
	sql +=  &quot;and abstype=&apos;R&apos;; &quot;;
	var vec = loadSQL_new(sql , dbName , &quot;大陸廠請假單_取得調休假已請時數(20170524new)&quot;);//此段不用改修改20170703
	if(vec.size()&gt;0){
		var result = vec.get(0);
		apply_oldsum = result.get(&quot;sums&quot;);
	}else{
		apply_oldsum = 0;
	}
	return apply_oldsum;
}

//R.調休假上限 新版 (隱藏時數) add by yingchieh@20170523(不再使用)
function getQUOTA4R_ex(empno,thisDay , dbName , type ,IDL){
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var myDate = new Packages.pase.agenda.MyDate();	
	var thisDay_beg = myDate.addMonth(thisDay,-5);
	var cnt = 0;
	var sql = &quot;&quot;;
	var thisYear = thisDay.substring(0,4);
	var thisMonth = thisDay.substring(5,7);		
	sql += &quot;select first 1 nvl(o_cnt,0) - nvl(o_cnt_use_r,0) as  col from empm217 where empno =&apos;&quot; + empno + &quot;&apos; order by salarytimes desc;&quot;; 
	var vec = loadSQL_new(sql , dbName , &quot;大陸廠請假單_取得當月補休假上限(隱藏)(20170523new)&quot;);
	if(vec.size() &gt; 0){
		cnt = vec.get(0).get(&quot;col&quot;);
	}
	return cnt;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>大陸廠請假單Client端相關共用程式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00041105352225910</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/01/10 18:17:05</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.FormFunction.CheckApproval</string> 
     </void> 
     <void property="id"> 
      <string>SCL00041105352225910</string> 
     </void> 
     <void property="name"> 
      <string>CheckApproval</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011105352183360</string> 
     </void> 
     <void property="scriptSource"> 
      <string>// 檢查審核意見是否有勾選
function checkApproval(){
	var radioAgree = Form.getValue(&quot;radioAgree&quot;);
	var radioReject = Form.getValue(&quot;radioReject&quot;);
	
	
	Form.setComplete(false);
	var message = &quot;&quot;;

	if(!radioAgree.equals(&quot;true&quot;) &amp;&amp; !radioReject.equals(&quot;true&quot;)){
		message += &quot;請選擇「同意」或「駁回」!!&quot;;
	}
	
	var taSuggest = Form.getValue(&quot;taSuggest&quot;).trim();
	if(radioReject.equals(&quot;true&quot;)  &amp;&amp; taSuggest.equals(&quot;&quot;)){
		message += &quot;請選擇「駁回意見」!!&quot;;
	}
        
	if(message.equals(&quot;&quot;)){
		return true;
	}else{
		Form.showMessageDialog(message);
		return false;
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>檢查審核意見是否有勾選</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00041132647811822</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/11/22 16:23:31</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.SystemFunction.ApproveLevel</string> 
     </void> 
     <void property="id"> 
      <string>SCL00041132647811822</string> 
     </void> 
     <void property="name"> 
      <string>ApproveLevel</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function InitApproveLevel (){
	  var member = Client.getCurrentMember();
      var rID = member.getMainRoleID();
      var role = Client.getRole(rID); 
      var mID = member.getID();
      var initLevel = role.getSynopsis();
      var task = Form.getCurrentTask();
                    
      java.lang.System.out.println(&quot;initLevel  &quot;+initLevel.toString());
     
  
	  
      // 設定 Level   及 Role  ID           
      Form.setValue(&quot;initLevel&quot;,initLevel); 
      //Form.setValue(&quot;rule&quot;,Form.getValue(&quot;txtNegotiateTotal&quot;));
      Form.setValue(&quot;txtManagerID&quot;,mID); 
     
      var inLevel = Form.getValue(&quot;initLevel&quot;) ;
      //var rl=Form.getValue(&quot;rule&quot;);
      java.lang.System.out.println(&quot;initLevel  &quot;+inLevel.toString());    
      //java.lang.System.out.println(&quot;rule  &quot;+rl.toString());

      var ManagerID = Form.getValue(&quot;txtManagerID&quot;) ;
      java.lang.System.out.println(&quot;Manager ID  &quot;+ManagerID.toString());  
	
}
function InitApproveLevelForApplicant(txtApplicantMID){
	  var member = Client.getMemberByID(txtApplicantMID.toString());
      var rID = member.getMainRoleID();
      var role = Client.getRole(rID); 
      var mID = member.getID();
      var initLevel = role.getSynopsis();
                         
      java.lang.System.out.println(&quot;initLevel  &quot;+initLevel.toString());
     
    
      // 設定 Level   及 Role  ID           
      Form.setValue(&quot;initLevel&quot;,initLevel); 
      //Form.setValue(&quot;rule&quot;,Form.getValue(&quot;txtNegotiateTotal&quot;));
      Form.setValue(&quot;txtManagerID&quot;,mID); 
     
      var inLevel = Form.getValue(&quot;initLevel&quot;) ;
      //var rl=Form.getValue(&quot;rule&quot;);
      java.lang.System.out.println(&quot;initLevel  &quot;+inLevel.toString());    
      //java.lang.System.out.println(&quot;rule  &quot;+rl.toString());

      var ManagerID = Form.getValue(&quot;txtManagerID&quot;) ;
      java.lang.System.out.println(&quot;Manager ID  &quot;+ManagerID.toString());  
	
}
function GetApproveLevel_Server(){

	  var artIns =MyTask.getArtInstance();
	  var memberID = MyTask.getMemberID();
	  var rID = MyTask.getRoleID();  
		  
      var mID = memberID;        
 	  var role = Server.getRole(rID); 
      var topLevel = role.getSynopsis();
                          
      java.lang.System.out.println(&quot;topLevel  &quot;+topLevel.toString());
        
      artIns.setAppValue(&quot;topLevel&quot;,topLevel);
	  artIns.setAppValue(&quot;roleID&quot;,rID);
      artIns.setAppValue(&quot;txtManagerID&quot;,mID);
    
      var toLevel = artIns.getAppValue(&quot;topLevel&quot;) ;
      java.lang.System.out.println(&quot;topLevel  &quot;+toLevel.toString());    
      
      var ManagerID = artIns.getAppValue(&quot;txtManagerID&quot;) ;
      java.lang.System.out.println(&quot;Manager ID  &quot;+ManagerID.toString());    	
}
function GetApproveLevel(){
	  
	  var task = Form.getCurrentTask();
	  var memberID = task.getMemberID();
	  var rID = task.getRoleID();  
		  
      var mID = memberID;        
 	  var role = Client.getRole(rID); 
      var topLevel = role.getSynopsis();
                          
      java.lang.System.out.println(&quot;topLevel  &quot;+topLevel.toString());
        
      Form.setValue(&quot;topLevel&quot;,topLevel);
	  Form.setValue(&quot;roleID&quot;,rID);
      Form.setValue(&quot;txtManagerID&quot;,mID);
    
      var toLevel = Form.getValue(&quot;topLevel&quot;) ;
      java.lang.System.out.println(&quot;topLevel  &quot;+toLevel.toString());    
      
      var ManagerID = Form.getValue(&quot;txtManagerID&quot;) ;
      java.lang.System.out.println(&quot;Manager ID  &quot;+ManagerID.toString());    	
}
function GetApproveLevel_old(){
	
      var member = Client.getCurrentMember();
      var  rID   = member.getMainRoleID();
      var role = Client.getRole(rID); 
      var mID = member.getID();        


      var topLevel = role.getSynopsis();
                          
      java.lang.System.out.println(&quot;topLevel  &quot;+topLevel.toString());
        
      Form.setValue(&quot;topLevel&quot;,topLevel);
      Form.setValue(&quot;txtManagerID&quot;,mID);
    
      var toLevel = Form.getValue(&quot;topLevel&quot;) ;
      java.lang.System.out.println(&quot;topLevel  &quot;+toLevel.toString());    
      
      var ManagerID = Form.getValue(&quot;txtManagerID&quot;) ;
      java.lang.System.out.println(&quot;Manager ID  &quot;+ManagerID.toString());    	
}
function GetApproveLevelWithRoleName_Server(){
	
	  var artIns =MyTask.getArtInstance();
	  var memberID = MyTask.getMemberID();
	  var rID = MyTask.getRoleID();  
	 	 	     
      var role = Server.getRole(rID); 
      var mID = memberID;        
	 	 
      var topLevel = role.getSynopsis();
	  var roleName = role.getName();
	  
      java.lang.System.out.println(&quot;roleID  &quot;+rID.toString());                    
      java.lang.System.out.println(&quot;topLevel  &quot;+topLevel.toString());
      java.lang.System.out.println(&quot;roleName  &quot;+roleName.toString());
	 	  
      artIns.setAppValue(&quot;topLevel&quot;,topLevel);
	  artIns.setAppValue(&quot;roleName&quot;,roleName);
      artIns.setAppValue(&quot;txtManagerID&quot;,mID);
	  artIns.setAppValue(&quot;roleID&quot;,rID);   
      
	  var toLevel = artIns.getAppValue(&quot;topLevel&quot;) ;
      java.lang.System.out.println(&quot;topLevel  &quot;+toLevel.toString());
	  
      var roName = artIns.getAppValue(&quot;roleName&quot;) ;
      java.lang.System.out.println(&quot;roleName  &quot;+roName.toString());
	  
      
      var ManagerID = artIns.getAppValue(&quot;txtManagerID&quot;) ;
      java.lang.System.out.println(&quot;Manager ID  &quot;+ManagerID.toString());    	
}
function GetApproveLevelWithRoleName(){
	
	  var task = Form.getCurrentTask();
	  var memberID = task.getMemberID();
	  var rID = task.getRoleID(); 
	 	 	     
      var role = Client.getRole(rID); 
      var mID = memberID;        
	 	 
      var topLevel = role.getSynopsis();
	  var roleName = role.getName();
	  
      java.lang.System.out.println(&quot;roleID  &quot;+rID.toString());                    
      java.lang.System.out.println(&quot;topLevel  &quot;+topLevel.toString());
      java.lang.System.out.println(&quot;roleName  &quot;+roleName.toString());
	 	  
      Form.setValue(&quot;topLevel&quot;,topLevel);
	  Form.setValue(&quot;roleName&quot;,roleName);
      Form.setValue(&quot;txtManagerID&quot;,mID);
	  Form.setValue(&quot;roleID&quot;,rID);   
      
	  var toLevel = Form.getValue(&quot;topLevel&quot;) ;
      java.lang.System.out.println(&quot;topLevel  &quot;+toLevel.toString());
	  
      var roName = Form.getValue(&quot;roleName&quot;) ;
      java.lang.System.out.println(&quot;roleName  &quot;+roName.toString());
	  
      
      var ManagerID = Form.getValue(&quot;txtManagerID&quot;) ;
      java.lang.System.out.println(&quot;Manager ID  &quot;+ManagerID.toString());    	
}
function GetApproveLevelWithRoleName_old(){
	
      var member = Client.getCurrentMember();
      var  rID   = member.getMainRoleID();
      var role = Client.getRole(rID); 
      var mID = member.getID();        


      var topLevel = role.getSynopsis();
	  var roleName = role.getName();
                          
      java.lang.System.out.println(&quot;topLevel  &quot;+topLevel.toString());
      java.lang.System.out.println(&quot;roleName  &quot;+roleName.toString());
	  
      Form.setValue(&quot;topLevel&quot;,topLevel);
	  Form.setValue(&quot;roleName&quot;,roleName);
      Form.setValue(&quot;txtManagerID&quot;,mID);
    
      var toLevel = Form.getValue(&quot;topLevel&quot;) ;
      java.lang.System.out.println(&quot;topLevel  &quot;+toLevel.toString());
	  
      var roName = Form.getValue(&quot;roleName&quot;) ;
      java.lang.System.out.println(&quot;roleName  &quot;+roName.toString());
	  
      
      var ManagerID = Form.getValue(&quot;txtManagerID&quot;) ;
      java.lang.System.out.println(&quot;Manager ID  &quot;+ManagerID.toString());    	
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>取得裁決權限</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00041153405120156</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/07/20 22:18:40</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Sign_Rule_for_Boss</string> 
     </void> 
     <void property="id"> 
      <string>SCL00041153405120156</string> 
     </void> 
     <void property="name"> 
      <string>Sign_Rule_for_Boss</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011152000677625</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//清維護畫面
function clear_Sign_Rule_for_Boss(){
	Form.setValue(&quot;Low_Limit_Amount&quot;,&quot;&quot;);	
	Form.setValue(&quot;Active&quot;,&quot;true&quot;);	
}


function reloadSign_Rule_for_Boss(){
	//function 功能:抓取 table A_Sign_Rule_for_Boss 的 資料到表單上的 TableA 元件
		reloadTable(&quot;TableA&quot;);		
}

//===================================================================================
function reloadTable(tableA){
			if(tableA != null){
				//oracle var sql = &quot; select a.af_process_id||&apos;_&apos;||b.AF_PROCESS_NAME AF_Process,a.Process_Type_ID||&apos;_&apos;||b.Process_Type_Name Process_Type,a.* from a_sign_rule_for_boss a, a_process_type b where b.AF_PROCESS_ID(+) = a.AF_PROCESS_ID and b.PROCESS_TYPE_ID=a.PROCESS_TYPE_ID and a.Project =&apos;&quot;+ Form.getValue(&quot;Project&quot;) +&quot;&apos; and a.af_process_id = &apos;&quot;+ getSubString(Form.getValue(&quot;AF_Process&quot;),&quot;a&quot;) +&quot;&apos; order by a.Project,a.AF_Process_ID,a.Process_Type_ID,a.Low_Limit_Amount &quot;   ;
				var sql = &quot; select a.af_process_id + &apos;_&apos; + b.AF_PROCESS_NAME AF_Process,a.Process_Type_ID + &apos;_&apos; + b.Process_Type_Name Process_Type,a.* from a_sign_rule_for_boss a, a_process_type b where b.AF_PROCESS_ID = a.AF_PROCESS_ID and b.PROCESS_TYPE_ID=a.PROCESS_TYPE_ID and a.Project =&apos;&quot;+ Form.getValue(&quot;Project&quot;) +&quot;&apos; and a.af_process_id = &apos;&quot;+ getSubString(Form.getValue(&quot;AF_Process&quot;),&quot;a&quot;) +&quot;&apos; order by a.Project,a.AF_Process_ID,a.Process_Type_ID,a.Low_Limit_Amount &quot;   ;
				var vecData = Client.SQLloadValue(sql);
				var table = Form.getComponent(tableA);					
				table.clear();
				if(vecData.size()&gt;0){
					Form.setValue(&quot;Modify_Date&quot;,(vecData.get(0).get(&quot;Modify_date&quot;)));//.toString().substring(0,16));
					Form.setValue(&quot;Modify_ID&quot;,vecData.get(0).get(&quot;modify_id&quot;));	
					for(var j= 0; j &lt; vecData.size(); j++){
						var row = table.newRow()-1 ;
						table.setValueAt(vecData.get(j).get(&quot;ID&quot;),row,&quot;ID&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Project&quot;),row,&quot;Project&quot;); //						
						table.setValueAt(vecData.get(j).get(&quot;AF_Process&quot;),row,&quot;AF_Process&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Process_Type&quot;),row,&quot;Process_Type&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Low_Limit_Amount&quot;),row,&quot;Low_Limit_Amount&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Job_Level&quot;),row,&quot;Job_Level&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Active&quot;),row,&quot;Active&quot;); //
					}//for
				}
			}
}//function

//==============================================================================================================
 
function getSubString(str,s){
	if(str.length()&gt;1){
		if(&quot;b&quot;.equals(s)){
			str = str.substring(str.lastIndexOf(&apos;_&apos;)+1); //後
		}else{
			str = str.substring(0,str.lastIndexOf(&apos;_&apos;)); //前
		}
	}
	return str;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00041196616571406</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/12/03 01:29:31</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Util.Date</string> 
     </void> 
     <void property="id"> 
      <string>SCL00041196616571406</string> 
     </void> 
     <void property="name"> 
      <string>Date</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021196616535609</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
/**
	test case.
*/
function testCase() {
	var cal = new java.util.GregorianCalendar();
	cal.set(2007, 6, 5, 0, 0, 0);
	var start = cal.getTime();
	cal.set(2007, 6, 6, 0, 0, 0);
	var end = cal.getTimeInMillis();
	var duration = getProcessTimeByRange(start, end);
	var timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;01:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 8, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 9, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;00:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 5, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 7, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;02:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 5, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 11, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;04:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 5, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 14, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;07:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 5, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 17, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;08:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 7, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 8, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;00:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 7, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 11, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;02:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 7, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 14, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;05:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 7, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 17, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;06:00:00:00 = &quot; + timeStr);
}
//傳入時間差(毫秒)，轉成幾天幾小時幾分
function countDuration(dif){
  var timeString = &quot;00:00:00:00&quot;;
  if((dif-0) &gt; 0){
	var day = (dif/(1000*60*60*24)).toString();
	var dayInt = getInt(day);
	var hourse = getInt(dif/1000/60/60 - 24*dayInt);
	var minutes = getInt(dif/1000/60 - dayInt*24*60 - hourse*60);
	var seconds = getInt(dif/1000 - dayInt*24*60*60 - hourse*60*60 - minutes*60);
	//timeString = dayInt+&quot;天&quot;+hourse+&quot;小時&quot;+minutes+&quot;分&quot;;
	if(minutes &lt; 10){
		minutes = &quot;0&quot; + minutes;
	}
	if(dayInt &lt; 10){
		dayInt = &quot;0&quot; + dayInt;
	}
	if(hourse &lt; 10){
		hourse = &quot;0&quot; + hourse;
	}
	if(seconds &lt; 10){
		seconds = &quot;0&quot; + seconds;
	}
	//timeString = (dayInt*24 + hourse) + &quot;:&quot; + minutes + &quot;:&quot; + seconds;
	timeString = dayInt + &quot;:&quot; + hourse + &quot;:&quot; + minutes + &quot;:&quot; + seconds;
  }
  return timeString;
}
/**
	計算經過時間，扣除Agentflow內所設定的假日
	@param (long, String, Date) 傳入參數必須是long時間或Date物件或是taskID
	@return long
*/
function getProcessTime(start) {
	var DATE_FORMAT = &quot;yyyy/MM/dd&quot;;
	/**
		將傳入參數轉為毫秒
	*/
	var taskStartTime = null;
	if ((typeof(start)).equals(&quot;number&quot;)) { //傳入毫秒
		taskStartTime = start;
	} else if ((typeof(start)).equals(&quot;string&quot;)) { //傳入taskID
		taskStartTime = Server.getTask(start).getStartTime();
	} else if ((typeof(start)).equals(&quot;object&quot;)) { //傳入Date物件
		taskStartTime = start.getTime();
	}
	/**
		計算啟動時間至現在時間扣掉假日的總天數
	*/
	var myDateObj = new Packages.pase.agenda.MyDate();
	var startDate = new java.util.Date(taskStartTime);
	var currDate = new java.util.Date();
	var currTime = Server.getServerTime();
	var dateFormat = new Packages.java.text.SimpleDateFormat(DATE_FORMAT);
	var startTime = dateFormat.format(startDate); //啟動時間
	currTime = dateFormat.format(currDate); //現在時間
	var durationDays = myDateObj.getSubtractDay(startTime, currTime); //啟動時間至現在時間的天數，從當天開始算起，不包含最後一天
	var holidaySum = 0; 
	for (var j = 0; j &lt;= durationDays; j++) {
		var addDate = myDateObj.add(startTime, j);
		if (Server.isHoliday(addDate)) {
			holidaySum = holidaySum + 1;
		}
	}
	var totalPassTime = ((durationDays + 1) - holidaySum) * 24 * 60 * 60 * 1000;
	/**
		檢查開始時間是否為假日
	*/
	if (!Server.isHoliday(myDateObj.add(startTime, 0))) {
		var cal = new java.util.GregorianCalendar();
		cal.setTime(startDate);
		var thisYear = cal.get(java.util.Calendar.YEAR);
		var thisMonth = cal.get(java.util.Calendar.MONTH);
		var thisDay = cal.get(java.util.Calendar.DATE);
		var cal2 = new java.util.GregorianCalendar(thisYear, thisMonth, thisDay);
		var dif = cal.getTimeInMillis() - cal2.getTimeInMillis();
		dif = java.lang.Math.abs(dif);
		totalPassTime -= dif;
	}
	/**
		檢查送出時間是否為假日
	*/
	if (!Server.isHoliday(myDateObj.add(startTime, durationDays))) {
		var cal = new java.util.GregorianCalendar();
		cal.setTime(currDate);
		var thisYear = cal.get(java.util.Calendar.YEAR);
		var thisMonth = cal.get(java.util.Calendar.MONTH);
		var thisDay = cal.get(java.util.Calendar.DATE);
		var cal2 = new java.util.GregorianCalendar(thisYear, thisMonth, thisDay);
		var dif = cal.getTimeInMillis() - cal2.getTimeInMillis();
		dif = (1000 * 3600 * 24) - dif;
		dif = java.lang.Math.abs(dif);
		totalPassTime -= dif;
	}
	return totalPassTime;
}
/**
	計算經過時間，扣除Agentflow內所設定的假日
	@param (long, String, Date) 傳入參數必須是long時間或Date物件或是taskID
	@param end 結束時間
	@return long
*/
function getProcessTimeByRange(start, end) {
	var DATE_FORMAT = &quot;yyyy/MM/dd&quot;;
	/**
		將傳入參數轉為毫秒
	*/
	var taskStartTime = null;
	if ((typeof(start)).equals(&quot;number&quot;)) { //傳入毫秒
		taskStartTime = start;
	} else if ((typeof(start)).equals(&quot;string&quot;)) { //傳入taskID
		taskStartTime = Server.getTask(start).getStartTime();
	} else if ((typeof(start)).equals(&quot;object&quot;)) { //傳入Date物件
		taskStartTime = start.getTime();
	}
	/**
		計算啟動時間至現在時間扣掉假日的總天數
	*/
	var myDateObj = new Packages.pase.agenda.MyDate();
	var startDate = new java.util.Date(taskStartTime);
	var currDate = new java.util.Date(new java.lang.Long(end).longValue()); //現在時刻
	var dateFormat = new Packages.java.text.SimpleDateFormat(DATE_FORMAT);
	var startTime = dateFormat.format(startDate); //啟動時間
	var currTime = dateFormat.format(currDate); //現在時間
	var durationDays = myDateObj.getSubtractDay(startTime, currTime); //啟動時間至現在時間的天數，從當天開始算起，不包含最後一天
	var holidaySum = 0;
	for (var j = 0; j &lt;= durationDays; j++) {
		var addDate = myDateObj.add(startTime, j);
		if (Server.isHoliday(addDate)) {
			holidaySum += 1;
		}
	}
	var totalPassTime = ((durationDays + 1) - holidaySum) * 24 * 60 * 60 * 1000;
	/**
		檢查開始時間是否為假日
	*/
	if (!Server.isHoliday(myDateObj.add(startTime, 0))) {
		var cal = new java.util.GregorianCalendar();
		cal.setTime(startDate);
		var thisYear = cal.get(java.util.Calendar.YEAR);
		var thisMonth = cal.get(java.util.Calendar.MONTH);
		var thisDay = cal.get(java.util.Calendar.DATE);
		var cal2 = new java.util.GregorianCalendar(thisYear, thisMonth, thisDay);
		var dif = cal.getTimeInMillis() - cal2.getTimeInMillis();
		dif = java.lang.Math.abs(dif);
		totalPassTime -= dif;
	}
	/**
		檢查送出時間是否為假日
	*/
	if (!Server.isHoliday(myDateObj.add(startTime, durationDays))) {
		var cal = new java.util.GregorianCalendar();
		cal.setTime(currDate);
		var thisYear = cal.get(java.util.Calendar.YEAR);
		var thisMonth = cal.get(java.util.Calendar.MONTH);
		var thisDay = cal.get(java.util.Calendar.DATE);
		var cal2 = new java.util.GregorianCalendar(thisYear, thisMonth, thisDay);
		var dif = cal.getTimeInMillis() - cal2.getTimeInMillis();
		dif = (1000 * 3600 * 24) - dif;
		dif = java.lang.Math.abs(dif);
		totalPassTime -= dif;
	}
	return totalPassTime;
}
/**
	因為處理的狀況不完整，所以重新設計演算法
*/
//傳入起始時間(Date or 毫秒)or taskID，扣除假日(六日)，傳出時間差(毫秒)
//此taskID若放rootID則，若流程完成則可算出全流程時間,若尚未完成則算到現在時間
//若是傳入時間必須是 number or Date 型態
//若是傳入taskID必須是string型態
//function getProcessTime(startTime){
//	var cTime = new java.util.Date();//現在時刻
//	var msecCTime = cTime.getTime();
//	var processTime = startTime;
//	var msecProcessTime;
//	if ((typeof(startTime)).equals(&quot;number&quot;)) {//傳入毫秒
//		msecProcessTime = startTime;
//		processTime = new java.util.Date(startTime);
//	}else if ((typeof(startTime)).equals(&quot;string&quot;)) {//傳入taskID
//	//}else if (startTime.toString()).startsWith(&quot;Tsk&quot;)) {//傳入taskID
//		var aTask = Server.getTask(startTime);
//		var taskState = aTask.getTaskState();
//		processTime = new java.util.Date(aTask.getStartTime());
//		msecProcessTime = processTime.getTime();
//		if(taskState.equals(aTask.TASK_STATE_COMPLETE)){
//			cTime = new java.util.Date(aTask.getEndTime());
//			msecCTime = cTime.getTime();
//		}
//	}else if ((typeof(startTime)).equals(&quot;object&quot;)) {//傳入Date物件
//		msecProcessTime = startTime.getTime();
//	}
//	var dif = cTime.getTime() - msecProcessTime;
//	if(cTime.toString().startsWith(&quot;Sat&quot;)){//如果現在時間是星期六，把現在時間設到上星期五的23:59:59
//		var clock = cTime.toString().substring(11,19);
//		var hour = clock.substring(0,2);
//		var minute = clock.substring(3,5);
//		var sec = clock.substring(6,8);
//		msecCTime = msecCTime - (hour*1000*60*60 + minute*1000*60 + sec*1000)-1000;
//		cTime = new java.util.Date(msecCTime);
//	}
//	if(cTime.toString().startsWith(&quot;Sun&quot;)){//如果現在時間是星期日，把現在時間設到上星期五的23:59:59
//		var clock = cTime.toString().substring(11,19);
//		var hour = clock.substring(0,2);
//		var minute = clock.substring(3,5);
//		var sec = clock.substring(6,8);
//		msecCTime = msecCTime - (hour*1000*60*60 + minute*1000*60 + sec*1000) - (1000*60*60*24)-1000;
//		cTime = new java.util.Date(msecCTime);
//	}
//	if(!cTime.toString().startsWith(&quot;Sat&quot;) &amp;&amp; !cTime.toString().startsWith(&quot;Sun&quot;)){
//	    while(msecCTime &gt; msecProcessTime){	
//			if(processTime.toString().startsWith(&quot;Sat&quot;) || processTime.toString().startsWith(&quot;Sun&quot;)){
//				dif = dif - 1000*60*60*24 ;
//				msecProcessTime += 1000*60*60*24;
//				processTime = new java.util.Date(msecProcessTime);
//			}else{
//				msecProcessTime += 1000*60*60*24;
//				processTime = new java.util.Date(msecProcessTime);
//			}
//	    }
//	}
//	return dif;
//}
/**
	因為處理的狀況不完整，所以重新設計演算法
*/
//傳入起始時間(Date or 毫秒)or taskID，扣除假日(六日)，傳出時間差(毫秒)
//此taskID若放rootID則，若流程完成則可算出全流程時間,若尚未完成則算到現在時間
//若是傳入時間必須是 number or Date 型態
//若是傳入taskID必須是string型態
//function getProcessTimeByRange(startTime, endTime){
//	var cTime = new java.util.Date(new java.lang.Long(endTime).longValue());//現在時刻
//	var msecCTime = cTime.getTime();
//	var processTime = startTime;
//	var msecProcessTime;
//	if ((typeof(startTime)).equals(&quot;number&quot;)) {//傳入毫秒
//		msecProcessTime = startTime;
//		processTime = new java.util.Date(startTime);
//	}else if ((typeof(startTime)).equals(&quot;string&quot;)) {//傳入taskID
//	//}else if (startTime.toString()).startsWith(&quot;Tsk&quot;)) {//傳入taskID
//		var aTask = Server.getTask(startTime);
//		var taskState = aTask.getTaskState();
//		processTime = new java.util.Date(aTask.getStartTime())
//		msecProcessTime = processTime.getTime();
//		if(taskState.equals(aTask.TASK_STATE_COMPLETE)){
//			cTime = new java.util.Date(aTask.getEndTime());
//			msecCTime = cTime.getTime();
//		}
//	}else if ((typeof(startTime)).equals(&quot;object&quot;)) {//傳入Date物件
//		msecProcessTime = startTime.getTime();
//	}
//	var dif = cTime.getTime() - msecProcessTime;
//	if(cTime.toString().startsWith(&quot;Sat&quot;)){//如果現在時間是星期六，把現在時間設到上星期五的23:59:59
//		var clock = cTime.toString().substring(11,19);
//		var hour = clock.substring(0,2);
//		var minute = clock.substring(3,5);
//		var sec = clock.substring(6,8);
//		msecCTime = msecCTime - (hour*1000*60*60 + minute*1000*60 + sec*1000)-1000;
//		cTime = new java.util.Date(msecCTime);
//	}
//	if(cTime.toString().startsWith(&quot;Sun&quot;)){//如果現在時間是星期日，把現在時間設到上星期五的23:59:59
//		var clock = cTime.toString().substring(11,19);
//		var hour = clock.substring(0,2);
//		var minute = clock.substring(3,5);
//		var sec = clock.substring(6,8);
//		msecCTime = msecCTime - (hour*1000*60*60 + minute*1000*60 + sec*1000) - (1000*60*60*24)-1000;
//		cTime = new java.util.Date(msecCTime);
//	}
//	if(!cTime.toString().startsWith(&quot;Sat&quot;) &amp;&amp; !cTime.toString().startsWith(&quot;Sun&quot;)){
//	    while(msecCTime &gt; msecProcessTime){	
//		if(processTime.toString().startsWith(&quot;Sat&quot;) || processTime.toString().startsWith(&quot;Sun&quot;)){
//			dif = dif - 1000*60*60*24 ;
//			msecProcessTime += 1000*60*60*24;
//			processTime = new java.util.Date(msecProcessTime);
//		}else{
//			msecProcessTime += 1000*60*60*24;
//			processTime = new java.util.Date(msecProcessTime);
//		}
//	    }
//	}
//	return dif;
//}

//傳入String，捨小數點後位數
function getInt(abc){
	var abcInt = &quot;&quot;;
	var st = new java.util.StringTokenizer(abc, &quot;.&quot;);
    if (st.hasMoreTokens()) {
		abcInt = st.nextToken();
    }
    return abcInt;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>日期的運算</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00041211339797866</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/05/21 11:16:37</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.RMA.fill_form_data</string> 
     </void> 
     <void property="id"> 
      <string>SCL00041211339797866</string> 
     </void> 
     <void property="name"> 
      <string>fill_form_data</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00061211339110866</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function fill_rma_table1(){ 
	
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	//使用者姓名
	var roleID = MyTask.getRoleID();
	var memDR = cMember.getMemberDR(roleID);
	var sDepName = memDR.getDepartmentName();	//使用者部門名稱
	var sDepID = Server.getDepartment(memDR.getDepartmentID()).getMyID();
	var sRoleName = memDR.getRoleName();	//使用者職務名稱
	var companyID = cMember.getAreaCode(); //使用者公司代碼

	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();

    var RMATable_a = appDataMap.get(&quot;RMATABLE_1&quot;);
    RMATable_a.clear();	
//------------	
	var artid = aInstance.getArtifactID();
//
//


var SQL = &quot; SELECT TCM.RMA_ID&quot;
SQL = SQL +  &quot;        ,TCM.RMA_NO&quot;
SQL = SQL +  &quot;        ,TCM.RMA_DATE&quot;
SQL = SQL +  &quot;        ,TCM.RMA_STUS,TCM.STUS_DESCRIPTION&quot;
SQL = SQL +  &quot;        ,TCM.RMA_TYPE_DESC&quot;
SQL = SQL +  &quot;        ,TCM.CURR_CODE,TCM.RMA_CREDIT_AMT,TCM.RETURN_SORTING_NO&quot;
SQL = SQL +  &quot;        ,TCM.CUSTOMER_NUMBER||&apos;-&apos;||TCM.CUSTOMER_NAME CUST&quot;
SQL = SQL +  &quot;        ,TCM.LOCATION&quot;
SQL = SQL +  &quot;        ,TCM.RESOURCE_NAME&quot;
SQL = SQL +  &quot;        ,TCM.REBUILD_DESCRIPTION&quot;
SQL = SQL +  &quot;        ,TCM.RETURN_YN&quot;
SQL = SQL +  &quot;        ,TCM.QUALITY_DESCRIPTION&quot;
SQL = SQL +  &quot;        ,DECODE(TCM.QUALITY_STATUS,&apos;1&apos;,&apos;狀況1.退回重工(重工地點:&apos;,&apos;2&apos;,&apos;狀況2.當地報廢(報廢地點:&apos;,&apos;3&apos;,&apos;狀況3.費用Charge/&apos;,&apos;4&apos;,&apos;狀況4.退回分析(簡述分析結果:&apos;,&apos; &apos;)||TCM.QUALITY_STATUS_DESC||&apos;)&apos; QUALITY_DESC&quot;
SQL = SQL +  &quot;        ,TCM.FCHECK_ENG_NAME&quot;
SQL = SQL +  &quot;        ,TCM.CHECK_DESCRIPTION&quot;
SQL = SQL +  &quot;        ,TCM.GCE_YN&quot;
SQL = SQL +  &quot;        ,TCM.CM_YN&quot;
SQL = SQL +  &quot;        ,TCD.RESP_DESCRIPTION,TCM.CONFIRM_DATE,TCM.AR_CLOSE_DATE,TCM.SALES_CLOSE_DATE&quot;
SQL = SQL +  &quot;        ,TCD.ITEM_NO&quot;
SQL = SQL +  &quot;        ,TCD.INVENTORY_ITEM_ID &quot;
SQL = SQL +  &quot;        ,TCD.CUSTOMER_ITEM_NUMBER&quot;
SQL = SQL +  &quot;        ,TCD.TYPE&quot;
SQL = SQL +  &quot;        ,TCD.PCB_PRICE&quot;
SQL = SQL +  &quot;        ,TCD.PCBA_PRICE&quot;
SQL = SQL +  &quot;        ,decode(tcd.pcba_price,null,null,round(tcd.pcba_price/tcd.pcb_price,2)) BA&quot;
SQL = SQL +  &quot;        ,SUM(TCD.QUANTITY) QTY&quot;
SQL = SQL +  &quot;        ,SUM(TCD.ITEM_RETURN_AMOUNT) RETURN_AMT&quot;
SQL = SQL +  &quot;        ,SUM((NVL(TGC_UPI_UTILITIES_PKG.GET_SQFT(TCD.INVENTORY_ITEM_ID,DECODE(TCM.ORG_ID,30,31,174,173,114,115,234,235,31),&apos;00&apos;,&apos;WPNL&apos;),0)/&quot;
SQL = SQL +  &quot;          TO_NUMBER(NVL(TGC_UPI_UTILITIES_PKG.ITEM_CATALOG_VALUE(TCD.INVENTORY_ITEM_ID,DECODE(TCM.ORG_ID,30,31,174,173,114,115,234,235,31),&apos;PCS_WPNL&apos;,&apos;00&apos;),&apos;0&apos;))) &quot;
SQL = SQL +  &quot;          * TCD.QUANTITY)  WPNL&quot;
SQL = SQL +  &quot;   FROM ( SELECT/*+ RULE */ RCM.ORG_ID,RCM.RMA_ID,RCM.RMA_NO,RCM.RMA_DATE,RCM.RMA_CREDIT_AMT,RCM.RETURN_SORTING_NO, &quot;
SQL = SQL +  &quot;                            RCM.CUSTOMER_ID,RC.CUSTOMER_NUMBER,RC.CUSTOMER_NAME,RCM.LOCATION_ID,RU.LOCATION, &quot;
SQL = SQL +  &quot;                            RCM.SALESREP_ID,                       &quot;
SQL = SQL +  &quot;               (SELECT JR.NAME&quot;
SQL = SQL +  &quot;                  FROM JTF_RS_SALESREPS JR ,jtf_rs_resource_extns JRRE&quot;
SQL = SQL +  &quot;                 WHERE JRRE.RESOURCE_NUMBER = RCM.SALESREP_ID &quot;
SQL = SQL +  &quot;                   AND JRRE.RESOURCE_ID =  JR.RESOURCE_ID&quot;
SQL = SQL +  &quot;                   AND JR.END_DATE_ACTIVE IS NULL) RESOURCE_NAME ,&quot;
SQL = SQL +  &quot;                             RCM.REBUILD_LOCATION,&quot;
SQL = SQL +  &quot;                            (SELECT FVV1.DESCRIPTION &quot;
SQL = SQL +  &quot;                                FROM  FND_LOOKUP_VALUES FVV1&quot;
SQL = SQL +  &quot;                               WHERE RCM.REBUILD_LOCATION=FVV1.LOOKUP_CODE &quot;
SQL = SQL +  &quot;                                 AND FVV1.LOOKUP_TYPE=&apos;RMA_EXAM_LOCATION&apos; &quot;
SQL = SQL +  &quot;                                AND FVV1.ENABLED_FLAG =&apos;Y&apos;  ) REBUILD_DESCRIPTION,&quot;
SQL = SQL +  &quot;                             RCM.CREDIT_TYPE,RCM.RETURN_YN,RCM.QUALITY_STATUS,&quot;
SQL = SQL +  &quot;                           (SELECT FVV2.DESCRIPTION &quot;
SQL = SQL +  &quot;                              FROM  FND_LOOKUP_VALUES FVV2&quot;
SQL = SQL +  &quot;                             WHERE FVV2.LOOKUP_TYPE=&apos;RMA_QUALITY_STATUS&apos; &quot;
SQL = SQL +  &quot;                               AND FVV2.ENABLED_FLAG =&apos;Y&apos; &quot;
SQL = SQL +  &quot;                               AND RCM.QUALITY_STATUS=FVV2.LOOKUP_CODE ) QUALITY_DESCRIPTION,&quot;
SQL = SQL +  &quot;                             RCM.QUALITY_STATUS_DESC,RCM.FCHECK_ENG_NAME,RCM.CHECK_ENG_ID,&quot;
SQL = SQL +  &quot;                           (SELECT FU2.DESCRIPTION&quot;
SQL = SQL +  &quot;                              FROM FND_USER FU2&quot;
SQL = SQL +  &quot;                             WHERE RCM.CHECK_ENG_ID=FU2.USER_ID ) CHECK_DESCRIPTION,&quot;
SQL = SQL +  &quot;                             RCM.GCE_YN,RCM.CM_YN,RCM.CONFIRM_DATE,RCM.SALES_CLOSE_DATE,RCM.AR_CLOSE_DATE,&quot;
SQL = SQL +  &quot;                             RCM.CREATION_DATE,RCM.CREATED_BY,RCM.LAST_UPDATE_DATE,RCM.LAST_UPDATED_BY,&quot;
SQL = SQL +  &quot;                             RCM.LAST_UPDATE_LOGIN,RCM.RMA_STUS,&quot;
SQL = SQL +  &quot;                             (SELECT FVV4.DESCRIPTION &quot;
SQL = SQL +  &quot;                             FROM  FND_LOOKUP_VALUES FVV4&quot;
SQL = SQL +  &quot;                               WHERE FVV4.LOOKUP_CODE = RCM.RMA_STUS &quot;
SQL = SQL +  &quot;                                AND FVV4.LOOKUP_TYPE=&apos;RMA_STATUS_TYPE&apos; &quot;
SQL = SQL +  &quot;                                AND FVV4.ENABLED_FLAG =&apos;Y&apos;) STUS_DESCRIPTION,&quot;
SQL = SQL +  &quot;                             RCM.PRINT_DATE,RCM.CURR_CODE,RCM.RMA_TYPE,&quot;
SQL = SQL +  &quot;                         (SELECT FVV5.DESCRIPTION &quot;
SQL = SQL +  &quot;                            FROM FND_LOOKUP_VALUES FVV5&quot;
SQL = SQL +  &quot;                            WHERE FVV5.LOOKUP_CODE = RCM.RMA_TYPE &quot;
SQL = SQL +  &quot;                               AND FVV5.LOOKUP_TYPE=&apos;RMA_TYPE_LIST&apos; &quot;
SQL = SQL +  &quot;                               AND FVV5.ENABLED_FLAG =&apos;Y&apos; ) RMA_TYPE_DESC ,&quot;
SQL = SQL +  &quot;                             RCM.REBUILD_NOTES,RCM.SALES_CLOSED_BY,RCM.AR_CLOSED_BY,RCM.AGENT ,RCM.CREDIT_NO&quot;
SQL = SQL +  &quot;    FROM TG_RMA_CREDIT_M RCM,RA_CUSTOMERS RC&quot;
SQL = SQL +  &quot;         ,RA_SITE_USES_ALL RU&quot;
SQL = SQL +  &quot;    WHERE RCM.CUSTOMER_ID =RC.CUSTOMER_ID&quot;
SQL = SQL +  &quot;      AND RCM.LOCATION_ID =RU.SITE_USE_ID  ) TCM,&quot;
SQL = SQL +  &quot;   (SELECT RCD.RMA_ID,RCD.EXAM_ID,RQM.EXAM_NO,RCD.ITEM_NO,RQD.INVENTORY_ITEM_ID,RCD.CUSTOMER_ITEM_NUMBER,RCD.TYPE,RCD.PCB_PRICE,RCD.PCBA_PRICE, &quot;
SQL = SQL +  &quot;           RCD.QUANTITY,RCD.ITEM_RETURN_AMOUNT,RCD.RETURN_NOTES,RCD.CREATION_DATE,RCD.CREATED_BY, &quot;
SQL = SQL +  &quot;           RCD.LAST_UPDATE_DATE,RCD.LAST_UPDATED_BY,RCD.LAST_UPDATE_LOGIN,RCD.EXAM_D_ID,RQD.LINE_NO,RQD.PCB_SN,&quot;
SQL = SQL +  &quot;           (SELECT FVV5.DESCRIPTION &quot;
SQL = SQL +  &quot;               FROM FND_LOOKUP_VALUES FVV5&quot;
SQL = SQL +  &quot;              WHERE FVV5.LOOKUP_CODE = RQD.RESP_CODE&quot;
SQL = SQL +  &quot;                AND FVV5.LOOKUP_TYPE=&apos;RMA_RESPONSIBILITY_TYPE&apos; &quot;
SQL = SQL +  &quot;                AND FVV5.ENABLED_FLAG =&apos;Y&apos; ) RESP_DESCRIPTION,&quot;
SQL = SQL +  &quot;           (SELECT PVV.VENDOR_NAME&quot;
SQL = SQL +  &quot;              FROM PO_VENDORS PVV&quot;
SQL = SQL +  &quot;              WHERE PVV.VENDOR_ID=RQD.VENDOR_ID ) VENDOR_NAME ,&quot;
SQL = SQL +  &quot;             RQD.DATE_CODE,RCD.ORGANIZATION_ID&quot;
SQL = SQL +  &quot;     FROM TG_RMA_CREDIT_D RCD,TG_RMA_QUALITY_D RQD,TG_RMA_QUALITY_M RQM &quot;
SQL = SQL +  &quot;    WHERE RCD.EXAM_ID=RQM.EXAM_ID &quot;
SQL = SQL +  &quot;      AND RQD.EXAM_ID=RQM.EXAM_ID &quot;
SQL = SQL +  &quot;    AND RCD.EXAM_D_ID=RQD.EXAM_D_ID ) TCD&quot;
SQL = SQL +  &quot;  WHERE TCM.RMA_ID=TCD.RMA_ID(+)&quot;
SQL = SQL +  &quot;    AND TCM.RMA_NO =&apos;R200712121&apos;&quot;
SQL = SQL +  &quot; GROUP BY TCM.RMA_ID,TCM.RMA_NO,TCM.RMA_DATE,TCM.RMA_STUS,TCM.STUS_DESCRIPTION,TCM.CURR_CODE,TCM.RMA_CREDIT_AMT,TCM.RETURN_SORTING_NO,TCM.CUSTOMER_NUMBER||&apos;-&apos;||TCM.CUSTOMER_NAME,TCM.LOCATION&quot;
SQL = SQL +  &quot;         ,TCM.RESOURCE_NAME,TCM.REBUILD_DESCRIPTION,TCM.RETURN_YN,TCM.QUALITY_DESCRIPTION,TCM.QUALITY_STATUS_DESC,TCM.FCHECK_ENG_NAME&quot;
SQL = SQL +  &quot;         ,TCM.CHECK_DESCRIPTION,TCM.GCE_YN,TCM.CM_YN,TCD.RESP_DESCRIPTION,TCM.CONFIRM_DATE,TCM.AR_CLOSE_DATE,TCM.SALES_CLOSE_DATE,TCD.ITEM_NO,TCD.INVENTORY_ITEM_ID,TCD.CUSTOMER_ITEM_NUMBER&quot;
SQL = SQL +  &quot;         ,TCD.TYPE,TCD.PCB_PRICE,TCD.PCBA_PRICE,TCM.QUALITY_STATUS,TCM.RMA_TYPE_DESC&quot;

  var conn = Server.createSessionConnection(&quot;PROD&quot;);
  var vector = conn.loadValue(SQL); 

//    var vector = Server.SQLloadValue(SQL);
    if ( vector != null ){
	   if (vector.size()&gt;0){
		  for(var i=0;i&lt;vector.size();i++)  {
			  var ht = vector.get(i);
			  var CUSTOMER_ITEM_NUMBER = ht.get(&quot;CUSTOMER_ITEM_NUMBER&quot;) //客戶料號
			  var ITEM_NO = ht.get(&quot;ITEM_NO&quot;)// 金像料號
			  var PCB_PRICE = ht.get(&quot;PCB_PRICE&quot;) // PCB 單價
			  var PCBA_PRICE = ht.get(&quot;PCBA_PRICE&quot;)     //PCBA單價
			  var QTY = ht.get(&quot;QTY&quot;)  //數量
			  var BA = ht.get(&quot;BA&quot;)    //倍數
			  var RETURN_AMT = ht.get(&quot;RETURN_AMT&quot;)//折讓金額

			  var UQUALITY_DESC = ht.get(&quot;UQUALITY_DESC&quot;)//處理說明
			  var RESOURCE_NAME = ht.get(&quot;UQUALITY_DESC&quot;)//業務負責人
			  var REBUILD_DESCRIPTION = ht.get(&quot;REBUILD_DESCRIPTION&quot;)//地點
  			  var FCHECK_ENG_NAME = ht.get(&quot;FCHECK_ENG_NAME&quot;)//初判工程師
   			  var CHECK_DESCRIPTION	 = ht.get(&quot;CHECK_DESCRIPTION	&quot;)//客服負責人
  			  var WPNL = ht.get(&quot;WPNL&quot;)//WPNL

			  			  
			  var row = new Packages.java.util.HashMap()		 
			  row.put(&quot;CUSTOMER_ITEM_NUMBER&quot;,CUSTOMER_ITEM_NUMBER);
			  row.put(&quot;ITEM_NO&quot;,ht.get(&quot;ITEM_NO&quot;)); 
			  row.put(&quot;PCB_PRICE&quot;,PCB_PRICE);  
			  row.put(&quot;PCBA_PRICE&quot;,PCBA_PRICE);			
			  row.put(&quot;QTY&quot;,QTY);			 
			  row.put(&quot;BA&quot;,BA);			 
			  row.put(&quot;RETURN_AMT&quot;,RETURN_AMT);
			  RMATABLE_1.add(RMATABLE_1.size(), row);			  
			 }
		  }//for
		}
	appDataMap.put(&quot;RMATABLE_1&quot;, RMATable_a);
	aInstance.setAppDataMap(appDataMap);
	}		

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00041226456872524</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2017/03/03 17:22:48</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.MIS.MIS_SEARCH</string> 
     </void> 
     <void property="id"> 
      <string>SCL00041226456872524</string> 
     </void> 
     <void property="name"> 
      <string>MIS_SEARCH</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051221612480089</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//loadLibrary(&quot;com.eland.dms.DMSAP&quot;);

	
//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;
//				}else if(&quot;complete&quot; == task.getTaskState()){
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);
				var rootid = task.getRootID();
				var proid = task.getProcessID();
				var addAsList = isExecuteAddAS(rootid,proid);//add by edison@20120518 判斷是否有加會簽並取出人員名單
				if(addAsList!=&quot;&quot;){
					table.setValueAt(addAsList,  row, &quot;目前處理者&quot;);
				}else{
					var realExecutorMemID = task.getRealExecutor();
					var memberRecord = Client.getMemberByID(realExecutorMemID);
					if (processname == &quot;已結案&quot;||processname == &quot;作廢&quot;){
						table.setValueAt(&quot;--&quot;,  row, &quot;目前處理者&quot;);
					}else{
						table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
					}
				}
				//table.setValueAt(getPriorityString(task), i, &quot;緊急程度&quot;);
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ITEM12&quot;).substring(0,10),    	row, &quot;開單日期&quot;);
			
			if(hm.get(&quot;ITEM115&quot;).length()&gt;1){
				var fm_closedate = hm.get(&quot;ITEM115&quot;).substring(0,10);
			}else{
				var fm_closedate = &quot;--&quot;;
			}
//			table.setValueAt(fm_closedate,    	row, &quot;流程結束日期&quot;);			//不要show了
			table.setValueAt(hm.get(&quot;ITEM24&quot;),    	row, &quot;申請人&quot;);			
			table.setValueAt(hm.get(&quot;ITEM4&quot;),    	row, &quot;需求日期&quot;);
			table.setValueAt(hm.get(&quot;ITEM137&quot;), 	row, &quot;系統類別&quot;);
			table.setValueAt(hm.get(&quot;ITEM133&quot;),    	row, &quot;優先順序&quot;);
			table.setValueAt(hm.get(&quot;ITEM134&quot;),    	row, &quot;申請類別&quot;);			
			table.setValueAt(hm.get(&quot;ITEM38&quot;),  	row, &quot;需求目的&quot;);
			table.setValueAt(hm.get(&quot;ITEM15&quot;),   	row, &quot;需求說明&quot;);
			table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

function isExecuteAddAS(rootid,proid){
		var sql = &quot;select tskid from add_task where signtskid=&quot;;
		    sql +=&quot;(select min(tskid) from task where rootid=&apos;&quot;+rootid+&quot;&apos; and proid=&apos;&quot;+proid+&quot;&apos; and state&lt;&gt;&apos;complete&apos;)&quot;;
		    sql +=&quot; and signtime=0 order by tskid&quot;;
		var vec = Client.SQLloadValue(sql);
		var name_list = new Packages.java.lang.StringBuffer();
		if(vec!=null &amp;&amp; vec.size()&gt;0){
			for(var i =0;i&lt;vec.size();i++){
				if(vec.size()&gt;1 &amp;&amp; i==0){	//當有加會簽人員,就不顯示啟動加會簽人員本身				
				}else{
					var Task = Client.getTask(vec.get(i).get(&quot;tskid&quot;));
					var realExecutorMemID = Task.getRealExecutor();
					var memberRecord = Client.getMemberByID(realExecutorMemID);
					var username = memberRecord.getName();
					name_list.append(username);
					name_list.append(&quot;;&quot;);
				}
			}			
		}
		return name_list;
	}

//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}else{
					sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
		}
	}
	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}else{
					sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}			
		}
	}	
	
	// 作者姓名
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
			sSQL += &quot; AND ITEM24 = &apos;&quot; + MemName + &quot;&apos;&quot;;
	}	
	//  廠別　add by wangwei@2017/03/03 for Susan req.
	var vFactory = Form.getValue(&quot;Factory&quot;);
	if (!&quot;全部&quot;.equals(vFactory)) {
			sSQL += &quot; AND ITEM2 = &apos;&quot; + vFactory + &quot;&apos;&quot;;
	}		
	// priority
	var priority = Form.getValue(&quot;priority&quot;);	
	if (!&quot;全部&quot;.equals(priority)) {
		sSQL += &quot; AND ITEM133 like &apos;%&quot; + priority + &quot;%&apos;&quot;;
	}
	// apptype
	var apptype = Form.getValue(&quot;apptype&quot;);	 
	if (!&quot;全部&quot;.equals(apptype)) {
		sSQL += &quot; AND ITEM134 like &apos;%&quot; + apptype + &quot;%&apos;&quot;;
	}
	// Apdesc
	var Apdesc = Form.getValue(&quot;Apdesc&quot;);	 
	if (!&quot;全部&quot;.equals(Apdesc)) {
		sSQL += &quot; AND ITEM137 like &apos;%&quot; + Apdesc + &quot;%&apos;&quot;;
	}
	// needfor
	var needfor = Form.getValue(&quot;needfor&quot;).toUpperCase();	 
	if (!&quot;&quot;.equals(needfor)) {
		sSQL += &quot; AND upper(ITEM38) like &apos;%&quot; + needfor + &quot;%&apos;&quot;;
	}
	// needdesc
	var needdesc = Form.getValue(&quot;needdesc&quot;).toUpperCase();	 
	if (!&quot;&quot;.equals(needdesc)) {
		sSQL += &quot; AND upper(ITEM15) like &apos;%&quot; + needdesc + &quot;%&apos;&quot;;
	}
	
	//文件狀態
	var Status = Form.getValue(&quot;Status&quot;);	 
	if (!&quot;全部&quot;.equals(Status)) {
			if (&quot;已結案&quot;.equals(Status)) {
				sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM115 is not null &quot;;
			}else if (&quot;未結案&quot;.equals(Status)){
				sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
			}				
	}
	// 表單單號　　Sn
	var vSn = Form.getValue(&quot;Sn&quot;);	
	if (!&quot;&quot;.equals(vSn)) {
		sSQL += &quot; AND INSID like &apos;%&quot;+vSn+&quot;%&apos;&quot;;
	}	
	return sSQL;
}
function sendAcceptMail(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        //var to = getProcessMailAddressList(groupname); //通知簽核過的人員		
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}
		to += &quot;;&quot; +getMailAddressTableA(dataMap);		
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;wangwei@gce.com.tw&quot;; //cc觀察用 
		if( vFactory==&quot;(SGCE)&quot; ||vFactory==&quot;(CGCE)&quot;  ){
			cc = &quot;jay.jiang@gcecn.com;wangwei@gce.com.tw&quot;; //cc觀察用 
		}				
//        var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」已審核通過&quot;; // Mail Subject 
		var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		var text = getAcceptMailContent(dataMap);
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00041226985850508</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2016/11/07 17:07:33</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.HRManager</string> 
     </void> 
     <void property="id"> 
      <string>SCL00041226985850508</string> 
     </void> 
     <void property="name"> 
      <string>HRManager</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var tableList = Form.getComponent(&quot;tableList&quot;);
	tableList.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}	
	if (vec.size()&gt;0) {
		for(var i = (P-1)*N ; i &lt; E; i++){
			var result = vec.get(i);
			var insid = result.get(&quot;insid&quot;);
			var statuss = result.get(&quot;status&quot;);
			var no = result.get(&quot;no&quot;);// 表單編號
			var dpt = result.get(&quot;dpt&quot;);
			var mid = result.get(&quot;mid&quot;);
			var cname = result.get(&quot;cname&quot;);			
			var approve = result.get(&quot;approve&quot;);
			var apptype = result.get(&quot;apptype&quot;);
			var apphours = result.get(&quot;apphours&quot;);
			var appdate = result.get(&quot;appdate&quot;);
			var apptime = result.get(&quot;apptime&quot;);
			var wk = result.get(&quot;wk&quot;);
			var cont = result.get(&quot;cont&quot;);
			var reason = result.get(&quot;reason&quot;);
			var hrnote = result.get(&quot;hrnote&quot;);// HR操作記錄			
			var webAgendaURL = result.get(&quot;webAgendaURL&quot;);
			var overtime = result.get(&quot;overtime&quot;);//期別	
			var isNeedDoc = result.get(&quot;isNeedDoc&quot;);// 是否需要證明
			var getdoc = result.get(&quot;getdoc&quot;);// 證明文件取得狀態
			var R1_no = result.get(&quot;R1_no&quot;);//R1單號
			var R1_H = result.get(&quot;R1_H&quot;);//R1使用時數
			var rowno = result.get(&quot;rowno&quot;);// 在請假明細裏第幾筆記錄
			var row = tableList.newRow()-1;
			if(!(overtime==&quot;&quot;)){
				tableList.setValueAt(overtime,row,&quot;期別&quot;);
			}
			tableList.setValueAt(no,row,&quot;單號&quot;);
			tableList.setValueAt(dpt+&quot; - &quot;+mid+&quot;(&quot;+cname+&quot;)&quot;,row,&quot;請假人&quot;);
			tableList.setValueAt(appdate,row,&quot;請假日期&quot;);
			tableList.setValueAt(apptime,row,&quot;請假區間&quot;);
			tableList.setValueAt(apphours,row,&quot;時數&quot;);
			tableList.setValueAt(apptype,row,&quot;假別&quot;);
			var artIns = Client.getArtInstance(insid);
			var dataMap = artIns.getAppDataMap();
			var AttachedFile = dataMap.get(&quot;AttachedFile&quot;);		
			var fileList = getFileLink(AttachedFile,webAgendaURL);
			tableList.setValueAt(apptype,row,&quot;假別&quot;);			
			if(statuss.equals(&quot;簽核&quot;)){
				approve=&quot;簽核中&quot;;
			}else{
				if(approve==&quot;true&quot;){
					approve=&quot;同意&quot;;
				}else{
					approve=&quot;駁回&quot;;
				}				
			}
			tableList.setValueAt(&quot;請假原因:&quot;+reason+&quot;\n簽核結果:&quot;+approve,row,&quot;請假原因&quot;);			
			tableList.setValueAt(hrnote,row,&quot;HR操作紀錄&quot;);
			tableList.setValueAt(insid,row,&quot;insid&quot;);
			tableList.setValueAt(rowno,row,&quot;序號&quot;);
			tableList.setValueAt(R1_no,row,&quot;R1單號&quot;);
			tableList.setValueAt(R1_H,row,&quot;R1使用時數&quot;);
			if(isNeedDoc==&quot;是&quot;){
				if(getdoc==&quot;&quot;){
					tableList.setValueAt(&quot;未取得&quot;,row,&quot;證明文件&quot;);
				}else{
					tableList.setValueAt(&quot;已取得&quot;,row,&quot;證明文件&quot;);
				}
			}else{
				tableList.setValueAt(&quot;不需要&quot;,row,&quot;證明文件&quot;);
			}
		}
	}else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

function showDptTable(P){
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var tableList = Form.getComponent(&quot;tableList&quot;);
	tableList.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}	
	if (vec.size()&gt;0) {
		loadLibrary(&quot;com.A.Common.Client.Util&quot;);// 裡面有getTaskByInsID()
		for(var i = (P-1)*N ; i &lt; E; i++){
			var result = vec.get(i);
			var insid = result.get(&quot;insid&quot;);
			var _insid = result.get(&quot;insid2&quot;);
			var statuss = result.get(&quot;status&quot;);
			var no = result.get(&quot;no&quot;);// 表單編號
			var dpt = result.get(&quot;dpt&quot;);
			var mid = result.get(&quot;mid&quot;);
			var cname = result.get(&quot;cname&quot;);
			var approve = result.get(&quot;approve&quot;);
			var apptype = result.get(&quot;apptype&quot;);
			var apphours = result.get(&quot;apphours&quot;);
			var appdate = result.get(&quot;appdate&quot;);
			var apptime = result.get(&quot;apptime&quot;);
			var R1_no = result.get(&quot;R1_no&quot;);//R1單號
			var R1_H = result.get(&quot;R1_H&quot;);//R1使用時數
			var agentID = result.get(&quot;agentID&quot;);// 代理人
			var agentMember=&quot;&quot;;
			var agentName=&quot;&quot;;
			var AgentApprove=&quot;同意&quot;;
			var AgentDate=&quot;&quot;;
			if(!(agentID==&quot;&quot;)){// 不需要代理人
				agentMember = Client.getMember(agentID);
				agentID = agentMember.getMyID();// 短的id
				agentName = agentMember.getName();
				AgentApprove = result.get(&quot;AgentApprove&quot;);// 代理人處理
				AgentDate = result.get(&quot;AgentDate&quot;);// 代理人處理
			}
			var Close_Time = result.get(&quot;Close_Time&quot;);// 結案時間			
			var wk = result.get(&quot;wk&quot;);
			var cont = result.get(&quot;cont&quot;);
			var reason = result.get(&quot;reason&quot;);
			var artIns = Client.getArtInstance(insid);// 取得表單
			var dataMap = artIns.getAppDataMap();
			var flowList = sortTable(dataMap.get(&quot;flowList&quot;));// 取得簽核流程人員名單
			var row = tableList.newRow()-1;
			tableList.setValueAt(mid+&quot;(&quot;+cname+&quot;)&quot;,row,&quot;職員&quot;);
			tableList.setValueAt(no,row,&quot;單號&quot;);
			tableList.setValueAt(apphours,row,&quot;時數&quot;);
			tableList.setValueAt(appdate,row,&quot;請假日期&quot;);
			tableList.setValueAt(apptime,row,&quot;請假區間&quot;);
			tableList.setValueAt(apptype,row,&quot;請假別&quot;);
			tableList.setValueAt(reason,row,&quot;請假事由&quot;);			
			tableList.setValueAt(agentName,row,&quot;代理人&quot;);	
			tableList.setValueAt(R1_no,row,&quot;R1單號&quot;);
			tableList.setValueAt(R1_H,row,&quot;R1使用時數&quot;);
			tableList.setValueAt(insid,row,&quot;insid&quot;);
			tableList.setValueAt(_insid,row,&quot;_insid&quot;);
			// 代理人處理狀況			
			var _approve = result.get(&quot;ITEM19&quot;);
			var _date = result.get(&quot;ITEM29&quot;);				
			var str = getVerifyStr(_approve,_date);
			tableList.setValueAt(&quot;代理人&quot;+str,row,&quot;流程一&quot;);				
			for(var j=0;j&lt;flowList.size();j++){
				var rowData = flowList.get(j);				
				var cname = rowData.get(&quot;ITEM2&quot;);							
				if(j==0){// 流程二設定
					var _approve = result.get(&quot;ITEM20&quot;);
					var _date = result.get(&quot;ITEM30&quot;);
					var str = getVerifyStr(_approve,_date);
					tableList.setValueAt(cname+str,row,&quot;流程二&quot;);			
				}else if(j==1){// 流程三設定					
					var _approve = result.get(&quot;ITEM21&quot;);
					var _date = result.get(&quot;ITEM31&quot;);
					var str = getVerifyStr(_approve,_date);
					tableList.setValueAt(cname+str,row,&quot;流程三&quot;);					
				}else if(j==2){// 流程四設定					
					var _approve = result.get(&quot;ITEM22&quot;);
					var _date = result.get(&quot;ITEM32&quot;);
					var str = getVerifyStr(_approve,_date);
					tableList.setValueAt(cname+str,row,&quot;流程四&quot;);					
				}else if(j==3){// 流程五設定					
					var _approve = result.get(&quot;ITEM23&quot;);
					var _date = result.get(&quot;ITEM33&quot;);
					var str = getVerifyStr(_approve,_date);
					tableList.setValueAt(cname+str,row,&quot;流程五&quot;);
				}else if(j==4){// 流程六設定					
					var _approve = result.get(&quot;ITEM27&quot;);
					var _date = result.get(&quot;ITEM28&quot;);
					var str = getVerifyStr(_approve,_date);
					tableList.setValueAt(cname+str,row,&quot;流程六&quot;);						
				}
			}
			if(!(Close_Time==&quot;&quot;)){// 設定最後簽核結果
				if(approve==&quot;true&quot;){
					approve = &quot;同意&quot;;
				}else{
					approve = &quot;不同意&quot;;
				}
				tableList.setValueAt(approve+&quot;\n&quot;+no,row,&quot;簽核結果&quot;);	// 結果加表單單號
			}
		}
	}else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

function getFileLink(AttachedFile0,webAgendaURL){
	var fileList = Packages.pe.filesystem.AttachFileInfo.parseAttachFileInfo(AttachedFile0);
	var _format = new Packages.java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);	
	var vecFile = new java.util.Vector();
	for(var i=0;i&lt;fileList.size();i++){
		var fileInfo = fileList.get(i);			
		var fileName = fileInfo.getFileName();// 檔案名稱
		var fileMember = fileInfo.getMemberName();// 上傳人員姓名
		var fileSaveTime = fileInfo.getSaveTime();// 存檔時間
		var fileSaveDate = new java.util.Date(fileSaveTime);
		fileSaveDate = _format.format(fileSaveDate);
		var fileNote = fileInfo.getNote();// 檔案備註
		var artInsID = fileInfo.getArtInsID();
		var itemID = fileInfo.getItemID();
		var fileID = fileInfo.getFileID();	
		var hyperlink = &quot;&lt;a href=&quot;+ webAgendaURL + &quot;/download?modelName=AttachedFile0&quot;
			+&quot;&amp;itemID=&quot;+itemID+&quot;&amp;artInsID=&quot;+artInsID+&quot;&amp;fileID=&quot;+fileID+&quot;&gt;&quot;+fileName+&quot;&lt;/a&gt;&quot;;		
		vecFile.add(hyperlink);
	}
	return vecFile;
}

function setUIDateRangeHR(sDate,eDate){
	Form.setValue(&quot;calBegin&quot;,sDate);
	Form.setValue(&quot;calEnd&quot;,eDate);
}

function getVerifyStr(approve,date){
	if(approve==&quot;true&quot;){
		approve = &quot;同意&quot;;
	}else{
		approve = &quot;不同意&quot;;
	}
	if(!(date==&quot;&quot;)){
		return &quot;(&quot;+approve+&quot;)\n&quot;+date;
	}else{
		return &quot;()&quot;;
	}	
}

function showEmpTable(P){
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var tableList = Form.getComponent(&quot;ResultTable&quot;);
	tableList.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}	
	if (vec.size()&gt;0) {
		loadLibrary(&quot;com.A.Common.Client.Util&quot;);// 裡面有getTaskByInsID()
		for(var i = (P-1)*N ; i &lt; E; i++){
			var result = vec.get(i);
			var row = tableList.newRow()-1;	
			var insid = result.get(&quot;insid&quot;);// 填單insid
			var _insid = result.get(&quot;insid2&quot;);// 簽核單insid
			var statuss = result.get(&quot;status&quot;);
			// 20081204 如果為退件時則表單關卡用填單的insid , 這樣目前關卡才會對
			var task;
			if(statuss.equals(&quot;退件&quot;)||statuss==&quot;退件&quot;){
				task = getTaskByInsID(insid);
			}else{
				task = getTaskByInsID(_insid);
			}
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;true&quot; == result.get(&quot;ITEM155&quot;)||statuss.equals(&quot;作廢&quot;)){
					processname = &quot;作廢&quot;;
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				tableList.setValueAt(processname,row, &quot;目前關卡&quot;);
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				tableList.setValueAt(memberRecord.getName(),row, &quot;目前處理者&quot;);
			}			
			var no = result.get(&quot;no&quot;);// 表單編號
			var dpt = result.get(&quot;dpt&quot;);
			var mid = result.get(&quot;mid&quot;);
			var cname = result.get(&quot;cname&quot;);
			var wtime = result.get(&quot;wtime&quot;);
			var details = result.get(&quot;details&quot;);
			tableList.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);			
			tableList.setValueAt(mid+&quot;(&quot;+cname+&quot;)&quot;,row,&quot;職員&quot;);
			tableList.setValueAt(no,row,&quot;單號&quot;);
			tableList.setValueAt(cname,row,&quot;申請人姓名&quot;);
			tableList.setValueAt(wtime,row,&quot;填寫日期&quot;);
			tableList.setValueAt(details,row,&quot;請假總覽&quot;);
			tableList.setValueAt(insid,row,&quot;insid&quot;);
			tableList.setValueAt(_insid,row,&quot;_insid&quot;);
		}
	}else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

//===================================================================
// 換休申請單查詢
// 查詢條件
//===================================================================	
function getQueryConditionExt(){
	var sSQL=&quot;&quot;;
	var Ob_date = new Packages.pase.agenda.MyDate();
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	// 起始日期
	if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; !&quot;true&quot;.equals(ckbEDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			sSQL += &quot; AND ITEM134 &gt;= &apos;&quot; + sDate + &quot;&apos;&quot;;
		}
	}	
	// 終止日期
	if (&quot;true&quot;.equals(ckbEDate) &amp;&amp; !&quot;true&quot;.equals(ckbSDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM134 &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;
		}
	}	
	// 起始日期 ~ 終止日期
      if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; &quot;true&quot;.equals(ckbEDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		var eDate = Form.getValue(&quot;eDate&quot;);
		var eDate1= Ob_date.add(Form.getValue(&quot;eDate&quot;),1); 
		if (!&quot;&quot;.equals(sDate)&amp;&amp; !&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM134 &gt;= &apos;&quot; + sDate + &quot;&apos;&quot; + &quot; AND ITEM134 &lt;= &apos;&quot; + eDate1 + &quot;&apos;&quot;;
		}
	}	
	// 申請人姓名
	if (Form.getValue(&quot;RB1&quot;).equals(&quot;true&quot;)){
		var MemName = Form.getValue(&quot;MemName&quot;);	
		if (!&quot;&quot;.equals(MemName)) {
			sSQL += &quot; AND ITEM24 like &apos;&quot; + MemName + &quot;%&apos;&quot;;
		}
	}
	
	// 申請人部門
	if (Form.getValue(&quot;RB2&quot;).equals(&quot;true&quot;)){
		var DepID = Form.getValue(&quot;DepID&quot;);	
		if (!&quot;&quot;.equals(DepID)) {
			sSQL += &quot; AND substr(item108,5,6) =  &apos;&quot; + DepID + &quot;&apos;&quot;;
		}
	}
	
	return sSQL;
}

//===================================================================
// 換休申請單查詢
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable_R1(P){
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;Count&quot;,vec.size()+&quot;&quot;);
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	if (vec.size()&gt;0) {
		var vTot = 0;
		var vI = 0;
         for (var i = (P-1)*N ; i &lt; E; i++) {
			var vG =0;
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();				
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;					
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);				
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				if( &quot;已結案&quot;==processname || &quot;作廢&quot; ==processname ){
					table.setValueAt(&quot;--&quot;, row, &quot;申請人&quot;);
				}else{
					table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
				}				
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ITEM186&quot;), row, &quot;部門&quot;);	
			table.setValueAt(hm.get(&quot;ITEM24&quot;), row, &quot;申請人&quot;);
			table.setValueAt(hm.get(&quot;ITEM10&quot;),  row, &quot;開單日期&quot;);			
			table.setValueAt(hm.get(&quot;ITEM115&quot;), row, &quot;結案日期&quot;);						
			table.setValueAt(hm.get(&quot;INSID&quot;),  row, &quot;InsID&quot;);
			table.setValueAt(hm.get(&quot;ITEM73&quot;),  row, &quot;出勤資訊&quot;);			
			}catch(e){}
		}
	   }else{
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
       }
}

function sortTable(data){
	var date = [];		
	var prior = [];			
		Client.addDebugLog(&quot;_____data=&quot;+data);
	for(var i=0;i&lt;data.size();i++){
		var rowData = data.get(i);
		Client.addDebugLog(&quot;__data=&quot;+rowData);
		date[i] = Client.getRole(Client.getMember(rowData.get(&quot;ITEM1&quot;)).getMainRoleID()).getMyID();;//level			
		Client.addDebugLog(&quot;data=&quot;+date[i]);
		prior[i] = i;// 排順序index	
	}		
	bubbleSortDate(date,data.size(),prior);		
	var tableVec = new java.util.Vector();
	for(var i=0;i&lt;data.size();i++){// 設定排序後的請假資訊
		var rowMap = new java.util.HashMap();
		var rowData = data.get(prior[i]);// 抓取日期,從小到大
		for(var j=1;j&lt;4;j++){
			rowMap.put(&quot;ITEM&quot;+j,rowData.get(&quot;ITEM&quot;+j));
		}
		tableVec.add(rowMap);
	}
	//for(var i=0;i&lt;data.size();i++){// 清空排序前的請假資訊
		data.clear();
	//}
	data=tableVec;	
	return data;
}

function bubbleSortDate(date,rowCount,prior){// 日期的氣泡排序法,由小到大
	var i,j,tmp;
	for(i=rowCount-1;i&gt;0;i--){
		for(j=0;j&lt;i;j++){
			if(date[j]&gt;date[j+1]){				
				tmp=prior[j];
				prior[j]=prior[j+1];
				prior[j+1]=tmp;
				tmp=date[j];
				date[j]=date[j+1];
				date[j+1]=tmp;
			}
		}
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>人事管理介面相關函式 for Client</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00041307504406693</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/06/13 09:23:33</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.scrap.server.addAsignList</string> 
     </void> 
     <void property="id"> 
      <string>SCL00041307504406693</string> 
     </void> 
     <void property="name"> 
      <string>addAsignList</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041307504199431</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/*
  原物料報廢申請單
  指派窗口及主管使用
*/
function addAsignList(parameter,value3,description,field){
	var Ati = MyTask.getArtInstance();
	var hm = Ati.getAppDataMap();
	var factory = hm.get(&quot;Factory&quot;) ;
    var v_factory=factory.substring(1,5);
	
	var SQL =    &quot; select VALUE2 memid ,VALUE1 username ,RESIGN  from A_PARAMETER_ITEM , A_PARAMETER_DATA, MEM_GENINF &quot;;
	SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
	SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
	SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+parameter+&quot;&apos;&quot;;
	SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 = &apos;&quot;+v_factory+&quot;&apos;&quot;  ;	
	SQL = SQL +  &quot; and MEM_GENINF .MEMID=A_PARAMETER_DATA.VALUE2&quot;;
	if(value3!=&quot;&quot;){
		SQL = SQL +  &quot; and A_PARAMETER_DATA.VALUE3 = &apos;&quot;+value3+&quot;&apos;&quot;  ;
	}
	if(description!=&quot;&quot;){
		SQL = SQL +  &quot; and A_PARAMETER_DATA.DESCRIPTION = &apos;&quot;+description+&quot;&apos;&quot;  ;
	}
	var vec = Server.SQLloadValue(SQL);	
	try{
		if(vec.size()&gt;0){
			var onerlist =&quot;&quot;; 
			for(var i = 0;i&lt;vec.size();i++){
				onerlist += vec.get(i).get(&quot;memid&quot;)+&quot;,&quot;;
			}
			hm.put(field,onerlist);
		}else{
			hm.put(field,&quot;&quot;);
		}
	}catch(e){
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00051105352286045</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/01/10 18:18:06</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.FormFunction.AppendOpinion</string> 
     </void> 
     <void property="id"> 
      <string>SCL00051105352286045</string> 
     </void> 
     <void property="name"> 
      <string>AppendOpinion</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011105352183360</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/*
 *  將簽核結果寫回簽核記錄中
 */
function appendOpinion(agree,suggest){	 
		// 讀取簽核人資料
		
		var task = Form.getCurrentTask();
				
		var member = Client.getCurrentMember();
		var name = &quot;&quot;;
		var roleId =&quot;&quot;;
		
		if (member.equals(Client.getMemberByID(task.getMemberID()))){
			name = member.getName();
			roleId = task.getRoleID();
		} else {
			name = member.getName() + &quot;(代理)&quot;;
			roleId = member.getMainRoleID();
		}	
						
		var taskName = task.getProcessName();	
		
		var memberDR = member.getMemberDR(roleId);
		var role = memberDR.getRoleName();
		var department = memberDR.getDepartmentName();
		
		
		// 讀取簽核時間
		var date = new Packages.pase.agenda.MyDate();
		//var date = new Packages.com.bcom.util.BcomDate(Client);
		var currentTime = date.getCurrentDate(&quot;y/M/d H:m s&quot;);
		
		// 讀取簽核結果
		var radioAgree = Form.getValue(&quot;radioAgree&quot;);
		var radioReject = Form.getValue(&quot;radioReject&quot;);
		if(agree == null)
			agree = &quot;false&quot;;
		if(radioAgree.equals(&quot;true&quot;)){
			agree = &quot;true&quot;;
		}else if(radioReject.equals(&quot;true&quot;)){
			agree = &quot;false&quot;;
		}
		
		//讀取簽核意見
		if(suggest == null){
			suggest = Form.getValue(&quot;taSuggest&quot;);
		}
	
		var tableApprovalHistory = Form.getComponent(&quot;tableApprovalHistory&quot;);

		var newRow = tableApprovalHistory.newRow();
		newRow --;
		
		// 序號
		var count = new java.lang.String(newRow + 1);
		if(count.length() == 1)  //補成兩位,數
			count = &quot;0&quot; + count;
		tableApprovalHistory.setValueAt(count, newRow, 0);
	
		// 日期
		tableApprovalHistory.setValueAt(currentTime, newRow ,  1);
	
		// 關卡名稱
		tableApprovalHistory.setValueAt(taskName, newRow ,  2);
	
		// 職稱
		tableApprovalHistory.setValueAt(role, newRow ,  3);
		
		// 姓名
		tableApprovalHistory.setValueAt(name, newRow,  4 );
		
	
		// 同意
		if(agree.equals(&quot;true&quot;)){
			tableApprovalHistory.setValueAt(&quot;true&quot;, newRow, 5);
		}else{
			tableApprovalHistory.setValueAt(&quot;true&quot;, newRow, 6);
		}
		// 簽核意見
		tableApprovalHistory.setValueAt(suggest, newRow, 7);
}
	
function appendOpinion_old(agree,suggest){	 
		// 讀取簽核人資料
		var member = Client.getCurrentMember();
		var name = member.getName();
		var roleId = member.getMainRoleID();
		var memberDR = member.getMemberDR(roleId);
		var role = memberDR.getRoleName();
		var department = memberDR.getDepartmentName();
	
		var task = Form.getCurrentTask();
		var taskName = task.getProcessName();
		
		// 讀取簽核時間
		var date = new Packages.pase.agenda.MyDate();
		//var date = new Packages.com.bcom.util.BcomDate(Client);
		var currentTime = date.getCurrentDate(&quot;y/M/d H:m s&quot;);
		
		// 讀取簽核結果
		var radioAgree = Form.getValue(&quot;radioAgree&quot;);
		var radioReject = Form.getValue(&quot;radioReject&quot;);
		
		if(agree == null)
			agree = false;
			
		if(radioAgree.equals(&quot;true&quot;)){
			agree = true;
		}else if(radioReject.equals(&quot;true&quot;)){
			agree = false;
		}
		
		//讀取簽核意見
		if(suggest == null){
			suggest = &quot;&quot;;
			//先檢查快速選項
			/*
			var cbRejectReason = Form.getValue(&quot;cbRejectReason&quot;);
			if(!cbRejectReason.equals(&quot;無&quot;))
				suggest += cbRejectReason + &quot;; &quot;;
			*/	
			suggest += Form.getValue(&quot;taSuggest&quot;);
		}
	
		var tableApprovalHistory = Form.getComponent(&quot;tableApprovalHistory&quot;);

		var newRow = tableApprovalHistory.newRow();
		newRow --;
		
		// 序號
		var count = new java.lang.String(newRow + 1);
		if(count.length() == 1)  //補成兩位,數
			count = &quot;0&quot; + count;
		tableApprovalHistory.setValueAt(count, newRow, 0);
	
		// 日期
		tableApprovalHistory.setValueAt(currentTime, newRow ,  1);
	
		// 關卡名稱
		tableApprovalHistory.setValueAt(taskName, newRow ,  2);
	
		// 職稱
		tableApprovalHistory.setValueAt(role, newRow ,  3);
		
		// 姓名
		tableApprovalHistory.setValueAt(name, newRow,  4 );
		
	
		// 同意
		if(agree.toString() ==&quot;true&quot;){
			tableApprovalHistory.setValueAt(true, newRow, 5);
		}else{
			tableApprovalHistory.setValueAt(true, newRow, 6);
		}
		// 簽核意見
		tableApprovalHistory.setValueAt(suggest, newRow, 7);
}
/*
 *  將簽核結果寫回簽核記錄中
 */	
function appendOpinion_Server(agree,suggest){	 
		// 讀取簽核人資料
		var artInstance = MyTask.getArtInstance();
		var memID = MyTask.getMemberID();
		var member = Server.getMember(memID);
		var name = &quot;&quot;;
		var roleID =&quot;&quot;;
		
		if (member.equals(Server.getMemberByID(memID))){
			name = member.getName();
			roleID = MyTask.getRoleID();
		} else {
			name = member.getName() + &quot;(代理)&quot;;
			roleID = member.getMainRoleID();
		}			

		var memberDR = member.getMemberDR(roleID);
		var role = memberDR.getRoleName();
		var department = memberDR.getDepartmentName();
	
		var taskName = MyTask.getProcessName();
		
		// 讀取簽核時間
		var date = new Packages.pase.agenda.MyDate();
		//var date = new Packages.com.bcom.util.BcomDate(Client);
		var currentTime = date.getCurrentDate(&quot;y/M/d H:m s&quot;);
		
		//讀取簽核意見
		if(suggest == null){
			suggest = &quot;&quot;;
			/*
			//先檢查快速選項
			var cbRejectReason = artInstance.getAppValue(&quot;cbRejectReason&quot;);
			if(!cbRejectReason.equals(&quot;無&quot;))
				suggest += cbRejectReason + &quot;; &quot;;
			*/	
			suggest += artInstance.getAppValue(&quot;taSuggest&quot;);
		}

		var agreeOption = &quot;false&quot;;
		var rejectOption = &quot;false&quot;;
		if(agree == null){
			agreeOption = artInstance.getAppValue(&quot;radioAgree&quot;);
			rejectOption = artInstance.getAppValue(&quot;radioReject&quot;);
		}else if(agree.equals(&quot;true&quot;)){
			agreeOption = &quot;true&quot;;
			rejectOption = &quot;false&quot;;
		}else{
			agreeOption = &quot;false&quot;;
			rejectOption = &quot;true&quot;;
		}
		
		//將意見放入 Table 中
		var dataMap = artInstance.getAppDataMap();
		var tableApprovalHistory = dataMap.get(&quot;tableApprovalHistory&quot;);
	
		var aRow = new Packages.java.util.HashMap();
		// 序號
		var count = new java.lang.String(tableApprovalHistory.size() + 1);
		if(count.length() == 1)  //補成兩位,數
			count = &quot;0&quot; + count;
			
		aRow.put(&quot;ITEM5&quot;,count); //序號
		aRow.put(&quot;ITEM2&quot;,currentTime); //日期
		aRow.put(&quot;ITEM6&quot;,taskName); //關卡名稱
		aRow.put(&quot;ITEM7&quot;,role); //職稱
		aRow.put(&quot;ITEM1&quot;,member.getName()); //姓名
		aRow.put(&quot;ITEM3&quot;,agreeOption); //同意
		aRow.put(&quot;ITEM8&quot;,rejectOption); //駁回
		aRow.put(&quot;ITEM4&quot;,suggest); //意見
	
		tableApprovalHistory.add(aRow);

		//清空記錄, 以供下一關人員填寫
		artInstance.setAppValue(&quot;radioAgree&quot;,&quot;false&quot;);
		artInstance.setAppValue(&quot;radioReject&quot;,&quot;false&quot;);
		artInstance.setAppValue(&quot;taSuggest&quot;,&quot;&quot;);
		/*
		artInstance.setAppValue(&quot;cbRejectReason&quot;,&quot;無&quot;);
		*/
}
function appendOpinion_Server_old(agree,suggest){	 
		// 讀取簽核人資料
		var artInstance = MyTask.getArtInstance();
		var memID = MyTask.getMemberID();
		var member = Server.getMember(memID);
		var roleID = member.getMainRoleID();
		var memberDR = member.getMemberDR(roleID);
		var role = memberDR.getRoleName();
		var department = memberDR.getDepartmentName();
	
		var taskName = MyTask.getProcessName();
		
		// 讀取簽核時間
		var date = new Packages.pase.agenda.MyDate();
		//var date = new Packages.com.bcom.util.BcomDate(Client);
		var currentTime = date.getCurrentDate(&quot;y/M/d H:m s&quot;);
		
		//讀取簽核意見
		if(suggest == null){
			suggest = &quot;&quot;;
			/*
			//先檢查快速選項
			var cbRejectReason = artInstance.getAppValue(&quot;cbRejectReason&quot;);
			if(!cbRejectReason.equals(&quot;無&quot;))
				suggest += cbRejectReason + &quot;; &quot;;
			*/	
			suggest += artInstance.getAppValue(&quot;taSuggest&quot;);
		}

		var agreeOption = &quot;false&quot;;
		var rejectOption = &quot;false&quot;;
		if(agree == null){
			agreeOption = artInstance.getAppValue(&quot;radioAgree&quot;);
			rejectOption = artInstance.getAppValue(&quot;radioReject&quot;);
		}else if(agree.equals(&quot;true&quot;)){
			agreeOption = &quot;true&quot;;
			rejectOption = &quot;false&quot;;
		}else{
			agreeOption = &quot;false&quot;;
			rejectOption = &quot;true&quot;;
		}
		
		//將意見放入 Table 中
		var dataMap = artInstance.getAppDataMap();
		var tableApprovalHistory = dataMap.get(&quot;tableApprovalHistory&quot;);
	
		var aRow = new Packages.java.util.HashMap();
		// 序號
		var count = new java.lang.String(tableApprovalHistory.size() + 1);
		if(count.length() == 1)  //補成兩位,數
			count = &quot;0&quot; + count;
			
		aRow.put(&quot;ITEM5&quot;,count); //序號
		aRow.put(&quot;ITEM2&quot;,currentTime); //日期
		aRow.put(&quot;ITEM6&quot;,taskName); //關卡名稱
		aRow.put(&quot;ITEM7&quot;,role); //職稱
		aRow.put(&quot;ITEM1&quot;,member.getName()); //姓名
		aRow.put(&quot;ITEM3&quot;,agreeOption); //同意
		aRow.put(&quot;ITEM8&quot;,rejectOption); //駁回
		aRow.put(&quot;ITEM4&quot;,suggest); //意見
	
		tableApprovalHistory.add(aRow);

		//清空記錄, 以供下一關人員填寫
		artInstance.setAppValue(&quot;radioAgree&quot;,&quot;false&quot;);
		artInstance.setAppValue(&quot;radioReject&quot;,&quot;false&quot;);
		artInstance.setAppValue(&quot;taSuggest&quot;,&quot;&quot;);
		/*
		artInstance.setAppValue(&quot;cbRejectReason&quot;,&quot;無&quot;);
		*/
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string> 將簽核結果寫回簽核記錄中</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00051156611878250</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/08/27 01:04:38</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Client.Util</string> 
     </void> 
     <void property="id"> 
      <string>SCL00051156611878250</string> 
     </void> 
     <void property="name"> 
      <string>Util</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011156610928578</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//重載申請人
function updateApp(){
	var mID = Form.getValue(&quot;App_MemID&quot;);
	var cMember = Client.getMember(mID);	

	//抓取使用者相關資料
	var sUserName = cMember.getName();
	var roleID = cMember.getMainRoleID();
	var memDR = cMember.getMemberDR(roleID);
	var sDepName = memDR.getDepartmentName();	//使用者部門名稱
	var sDepID = Client.getDepartment(memDR.getDepartmentID()).getMyID();	
	var sRoleName = memDR.getRoleName();	//使用者職務名稱
		//設定申請人姓名、員工編號
		Form.setValue(&quot;App_ID&quot;,cMember.getMyID());
		Form.setValue(&quot;App_Tel&quot;,cMember.getOfficePhone());
		//Form.setValue(&quot;From_User_ID&quot;,cMember.getID());
		//Form.setValue(&quot;From_User_RoleID&quot;,roleID);

		//設定申請部門及申請人職稱					
		Form.setValue(&quot;App_Dep&quot;,sDepName);
		Form.setValue(&quot;App_Dep_ID&quot;,sDepID);	
		Form.setValue(&quot;App_DepID&quot;,memDR.getDepartmentID());
		//Form.setValue(&quot;App_Title&quot;,sRoleName);
		Form.setValue(&quot;App_Title&quot;,cMember.getJobTitle());
		//Form.setValue(&quot;App_Email&quot;,cMember.getEmail());
}
	
	
	function checkValueIsDouble(tablename,keyname,ID){
		var flg = false;
		var sql_check = &quot;select &quot;+ keyname +&quot; from &quot;+ tablename +&quot; where &quot;+ keyname +&quot;=&quot;+ ID ;
		var vec_check = Client.SQLloadValue(sql_check);
		if(vec_check.size()&gt;0){
			flg = true;			
		}
		return flg;
	}
	

//用在查詢表單
function createAPForm(artid,h,w){
		//寫在母表單的按鈕上
		//用舊的 ins 會開不起來 20061013 cc
   		if (!&quot;&quot;.equals(artid)){
  
		      var artIns = Client.createArtInstance(artid);
		      var artInsID = artIns.getID();

		//createForm(java.lang.String artInsID, java.lang.String stateName, boolean bRunScript, boolean bSave, boolean print, int close, int x, int y, int width, int height) 
		var panel = Client.createForm(artInsID.toString(),&quot;CreateForm&quot;,true,false,true,0,10,10, h,w) ; 
		//createFormExt(java.lang.String artInsID, java.lang.String stateName, boolean isRunScript, boolean canSave, boolean canPrint, boolean canReviewProcess) 
		//	Client.createFormExt(artInsID.toString(),&quot;CreateForm&quot;,true,false,true,true);
		}
}

//用在表單上開子視窗
function createAPFormExt(artid,h,w,forprint){
		//寫在母表單的按鈕上
		//開啟唯一一張表單,沒有就新產生一張//ART00051102931547837
		//用舊的 ins 會開不起來 20061013 cc
   		if (!&quot;&quot;.equals(artid)){	    
		      var artIns = Client.createArtInstance(artid);	
			  var artInsID = artIns.getID();
		//	  Client.createFormExt(artInsID.toString(),&quot;CreateForm&quot;,true,false,true,true);
		//createForm(java.lang.String artInsID, java.lang.String stateName, boolean bRunScript, boolean bSave, boolean print, int close, int x, int y, int width, int height) 
		var panel = Client.createForm(artInsID.toString(),&quot;CreateForm&quot;,true,false,forprint,0,10,10, h,w) ; 
		}
}
//取得 keyValue
function getKeyValue(table_name,key_name,key_item_name,key_value,key2_item_name,key2_value){
	var keyvalue =&quot;&quot;;
	var sql_key = &quot; select &quot; + key_name  + &quot; from &quot;+ table_name +&quot; where &quot;+ key_item_name +&quot;=&apos;&quot;+ key_value +&quot;&apos; and &quot; + key2_item_name +&quot;=&apos;&quot;+ key2_value +&quot;&apos;&quot;;
	var vector_ver = Client.SQLloadValue(sql_key);
	if(vector_ver.size()&gt;0 &amp;&amp; vector_ver.get(0).get(key_name) != &quot;&quot; ){
		keyvalue = vector_ver.get(0).get(key_name);
	}
	return keyvalue;
}



//取得部門名稱 by 員工姓名或員工ID	20060815
function getDepName(id){
	var sDepName = &quot;&quot;;
	var cMember = Client.getMemberByName(id);	
	var sUserName = cMember.getName();	//使用者姓名
	var roleID = cMember.getMainRoleID();
	var memDR = cMember.getMemberDR(roleID);
	var sDepName = memDR.getDepartmentName();	//使用者部門名稱
	return sDepName;
}		

function getYN(s1){
	if(&quot;true&quot;.equals(s1)){
		return &quot;Y&quot;;
	}
	return &quot;N&quot;;
}

function getTrueFalse(s1){
	if(&quot;Y&quot;.equals(s1)){
		return true;
	}
	return false;
}

function getFormatedCurrentTime(format){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(format);
        return simpledateformat.format(date);
}


//function setCombox(component_name,sql){
//		var comboxitem = Form.getComponent(component_name);
//		var dataVector = Client.SQLloadValue(sql);
		//addItemVectorWithPls(comboxitem,component_name,dataVector);
//		comboxitem.removeAllItems();
//		comboxitem.addItem(&quot;--請選擇--&quot;);
//		for(var i=0;i&lt;dataVector.size();i++) {
//			var item = dataVector.get(i).get(component_name);
//			comboxitem.addItem(item);
//		}
//		if(dataVector.size()&gt;0){
//			Form.setValue(component_name,dataVector.get(0).get(component_name));	
//		}

//	}//function 

function setCombox(component_name,sql){
		var comboxitem = Form.getComponent(component_name);
		var c_value = Form.getValue(component_name);
		var dataVector = Client.SQLloadValue(sql);
		//addItemVectorWithPls(comboxitem,component_name,dataVector);
		comboxitem.removeAllItems();
//		comboxitem.addItem(&quot;--請選擇--&quot;);
		for(var i=0;i&lt;dataVector.size();i++) {
			var item = dataVector.get(i).get(component_name);
			comboxitem.addItem(item);
		}
		if(&quot;&quot; != c_value){
			Form.setValue(component_name,c_value);
		}else if(dataVector.size()&gt;0){
			Form.setValue(component_name,dataVector.get(0).get(component_name));	
		}

	}//function
	
	
/**
	20080423
	修改保留預設值的寫法
*/
function setCombox_2(component_name,sql){
		var comboxitem = Form.getComponent(component_name);
		var c_value = Form.getValue(component_name);
		var dataVector = Client.SQLloadValue(sql);
		//addItemVectorWithPls(comboxitem,component_name,dataVector);
		comboxitem.removeAllItems();
//		comboxitem.addItem(&quot;--請選擇--&quot;);
		for(var i=0;i&lt;dataVector.size();i++) {
			var item = dataVector.get(i).get(component_name);
			comboxitem.addItem(item);
		}
		if(&quot;&quot; != c_value){
			Form.setValue(component_name,c_value);
		}else if(dataVector.size()&gt;0){
			Form.setValue(component_name,dataVector.get(0).get(component_name));	
		}

	}//function
	
	
 function addItemVector(comp,itemName,dataVector) {
  comp.removeAllItems();
  //comp.addItem(&quot;--請選擇--&quot;);
  for(var i=0;i&lt;dataVector.size();i++) {
	  var dataRow = dataVector.elementAt(i);
	  var item = dataRow.get(itemName);
	  comp.addItem(item);
  }
  if(dataVector.size()&gt;0){Form.setValue(comp.getName(),dataVector.get(0).get(itemName))};
 }//function

 
 
function getSubString(str,s){
	if(str.length()&gt;1){
		if(&quot;b&quot;.equals(s)){
			str = str.substring(str.lastIndexOf(&apos;-&apos;)+1); //後
		}else{
			str = str.substring(0,str.lastIndexOf(&apos;_&apos;)); //前
		}
	}
	return str;
}

//========================================================================================
// 應用程式之查詢共用 取得流程的狀態
//========================================================================================
function getEipStatus(insid){
		var EIPstatus =&quot;&quot;;
		instance = Client.getArtInstance(insid) ;
		if (instance != null){
			EIPstatus = instance.getArtState().getName();

			if (EIPstatus.equals(&quot;初始化&quot;)){
				EIPstatus = &quot;填寫中&quot;;
			}else if(EIPstatus.equals(&quot;填寫完畢&quot;)){
				EIPstatus = &quot;主管審核中&quot;;
			}
			var task = getTaskByInsID(insid);
			var parentTask = Client.getTask(task.getParentID());
			if (&quot;signing&quot;.equals(parentTask.getTaskState())){   	// 會簽
				//var type = parentTask.getAddASType();
				//if (type.equals(&quot;AddParallelAnnounce&quot;)){			// 分會
					EIPstatus = &quot;會簽中&quot;;
				//}
			}
			var memNameString = getUnsignMemName(task);
			if (&quot;&quot;.equals(memNameString)){
				var l_member = Client.getMemberByID(task.getRealExecutor());
				memNameString = l_member.getName();
			}
		}
		EIPstatus = &quot;[&quot; + memNameString + &quot;]&quot; + EIPstatus;
		return EIPstatus;
}		



//========================================================================================
// 取得應用程式之查詢共用條件的SQL
//========================================================================================
function getTaskByInsID(InsID){
	var task = null;
	var vecTask = Client.SQLloadValue(&quot;select max(tskid) taskid from task_artins where insid =&apos;&quot;+ InsID +&quot;&apos;&quot;);
	if(vecTask.get(0).get(&quot;taskid&quot;) != null ){
		task = Client.getTask(vecTask.get(0).get(&quot;taskid&quot;));
	}
	return task;
}

//========================================================================================
//  取得動態加會簽節點Task物件的尚未簽核的姓名
//========================================================================================
function getUnsignMemName(task){
	var memNames = &quot;&quot;;
	var parentTask = Client.getTask(task.getParentID());
	if (&quot;signing&quot;.equals(parentTask.getTaskState())){   	// 會簽
		var type = parentTask.getAddASType();
		if (type.equals(&quot;AddParallelAnnounce&quot;)){			// 分會
			//取得所有分會出去的Task list
			var taskList = Client.getSubTaskList(parentTask.getID());
			//判斷分會Task完成數目
			for (var i = 0; i &lt; taskList.size(); i++) {
				var task = taskList.get(i);
				if(task.getTaskState().equals(&quot;complete&quot;) || task.getTaskState().equals(&quot;running&quot;) ) {
					continue;
				} else {
					var memID = task.getRealExecutor();
					var memberRecord = Client.getMemberByID(memID);
					memNames = memNames + memberRecord.getName() + &quot;,&quot;; 
				}
			}
		}
	}

	
	var memNameString  = new java.lang.String(memNames);
	var len = memNameString.length();
	if (len&gt;0){
		memNameString = memNameString.substring(0,len-1);
	}	
	return memNameString;
}

//========================================================================================
//  取得動態加會簽節點Task物件的尚未簽核的姓名 
// add by wangwei@2007/04/07 copy from getUnsignMemName
// 會簽關卡未簽核人員
//========================================================================================
function getUnsignMemNameExt(task){
	var memNames = &quot;&quot;;
	var vTaskID = task.getID(); // 取得ID
	var parentTask = Client.getTask(task.getParentID());
	var vProID =	task.getProcessID();  // SNGXXXXXXXXX
	var taskList = Client.getSubTaskList(parentTask.getID());
			if(&quot;SGN&quot;==vProID.substring(0,3)){
				for(var i=0;i&lt;taskList.size();i++){
				  var subtask = taskList.get(i);  
				  var subproid =subtask.getProcessID();	
							if(vProID.equals(subproid)){
								 if( !subtask.getTaskState().equals(&quot;complete&quot;)){
								 		var vExeMemID = subtask.getRealExecutor();							
										var memberRecord = Client.getMemberByID(vExeMemID);								 		
								 				memNames = memNames + memberRecord.getName() + &quot;,&quot;; 
								}
							}				  
				} // end for
			}
	var memNameString  = new java.lang.String(memNames);
	var len = memNameString.length();
	if (len&gt;0){
		memNameString = memNameString.substring(0,len-1);
	}	
	return memNameString;
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00051188310399187</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/08/28 22:13:19</string> 
     </void> 
     <void property="fullName"> 
      <string>com.realtek.ecn.SendMail</string> 
     </void> 
     <void property="id"> 
      <string>SCL00051188310399187</string> 
     </void> 
     <void property="name"> 
      <string>SendMail</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041179559576781</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//===============================================================================
// sendMail
// type : 1.會簽駁回
//===============================================================================
function sendMail(type){
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var from = Server.getMember(&quot;ADM&quot;).getEmail();  		
		var to = Server.getMember(MyTask.getRealExecutor()).getEmail(); 
        var cc = &quot;&quot;; 

		if(&quot;會簽未通過&quot;.equals(type)){
			to = getProcessMailAddressList(&quot;沒有&quot;);
			var subject = &quot;ECN&quot;+type+&quot;通知 :( 單號:&quot; + dataMap.get(&quot;Sn&quot;) + &quot;)&quot; + dataMap.get(&quot;Subject&quot;)  ; // Mail Subject 
			var text = getMailContent1(dataMap);
	
		}
        var fileList = new Packages.java.util.Vector(); 
        Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
}

//-------------------
// 1.會簽駁回
//-------------------
function getMailContent1(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;  很抱歉！！此份ECN於會簽流程中因有以下會簽意見，無法生效！！: &lt;br&gt;&quot;;
		text += &quot;   請申請人視需要進行相關溝通、修改。若有需要請再提出新申請。謝謝！&lt;br&gt;&quot;;			
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot; 簽核意見  &lt;br&gt;&quot;;
		text += getVerifyNotice();		
		try{
		
		var creator = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)) ;
		var roottask = Server.getTask(MyTask.getRootID());
		var roleID = MyTask.getRoleID();
		var mainroleid = creator.getMainRoleID();
		var depname = &quot;&quot;;
		if(mainroleid != &quot;&quot;){
			var memDR = creator.getMemberDR(mainroleid);
		//		var memDR = creator.getMemberDR(roleID);
			depname = memDR.getDepartmentName();	//部門名稱
		}
		text += &quot;   流程的啟動者 : &quot; + dataMap.get(&quot;Creator&quot;)	+&quot;&lt;br&gt;&quot;;				
		// text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
		var frontuser = Server.getMember(MyTask.getFrontUser());
		// text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		

		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;				
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   使用上的問題，請連絡資訊工程部莊正元 Peter #3655. &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}



function haveAttachFile(){
	var str = &quot;否&quot;;
	var taskID = MyTask.getID();
	var artInstance = MyTask.getArtInstance(); 
    var artID = artInstance.getArtifactID();
    var InsID = artInstance.getID();
    var sql = &quot;select  FileName from AttachFile where  ArtInsID = &apos;&quot;+InsID+&quot;&apos;&quot;;
    var vc = Server.SQLloadValue(sql);
    if (vc.size()&gt;0){
		str = &quot;是&quot;;
    }
	return str;
}


function isReplace(flg_is){
	var str = &quot;否&quot;;
    if (&quot;true&quot;.equals(flg_is)){
		str = &quot;是&quot;;
    }
	return str;
}

//------------------------
// 發 mail 開啟連結用的 URL 
// n == 1 //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件 ( ie7 無法直接開 ) 
// n == 2 //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
// n == 3 //email開表單，需密碼
// n == 4 //email開表單，不需密碼
//------------------------
function getUrl(n){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
           var aInstance = MyTask.getArtInstance(); 
           var dataMap = aInstance.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                     //var userName = member.getName();
                     var userName = member.getLoginID();
                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
           }
           return url;
}

//=====================================================================
//取得Root Task 流程所經過的人+ 特定 table 抓出來的 email address 字串
//=====================================================================
function getProcessMailAddressList(groupname){
	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	//流程上的成員
	var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;exeid&quot;)) != null){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
	}
	//Table 上的成員
	var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;memid&quot;)) != null){
					memset.add(vec.get(i).get(&quot;memid&quot;));
			}
		}
	}
	
	var key = memset.iterator();
	while(key.hasNext()){
		var memid = key.next();
		if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
			emailaddress += Server.getMember(memid).getEmail() + &quot;;&quot; ;
		}
	}
	return emailaddress;	
}
//---------------------------------------------------------- 


//===============================================================================
//取得最後一筆的意見 20070625
//===============================================================================
		function getLastVerifyNotice(){
			var verify_notice = &quot;&quot;;
			try{
				var aInstance = MyTask.getArtInstance();
				var formDataMap = aInstance.getAppDataMap();
				var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
				//抓最後一筆的簽核意見記錄
				var row = vecTableData.size()-1;
				if(row &gt;= 0 ){
					verify_notice = vecTableData.get(row).get(&quot;ITEM1&quot;); //簽核意見
				}
			}catch(e){}
			return verify_notice ;
		}


//===============================================================================
//取得所有簽核意見 20070828
//===============================================================================
		function getVerifyNotice(){
			var verify_notice = &quot;&quot;;
			try{
				var aInstance = MyTask.getArtInstance();
				var formDataMap = aInstance.getAppDataMap();
				var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
				//抓所有簽核意見記錄
				verify_notice += &quot;&lt;table border=&apos;1&apos; &gt;&quot;;
				verify_notice += &quot;&lt;tr&gt;&lt;td&gt;序號&lt;/td&gt;&lt;td&gt;審核日期&lt;/td&gt;&lt;td&gt;關卡名稱&lt;/td&gt;&lt;td&gt;部門&lt;/td&gt;&lt;td&gt;職稱&lt;/td&gt;&lt;td&gt;姓名&lt;/td&gt;&lt;td&gt;是否核淮&lt;/td&gt;&lt;td&gt;審核意見&lt;/td&gt;&lt;/tr&gt;&quot;;
				for(var i=0;i&lt;vecTableData.size();i++){
					try{
						verify_notice += &quot;&lt;tr&gt;&quot;;
						verify_notice += &quot;&lt;td&gt;&quot; + vecTableData.get(i).get(&quot;ITEM7&quot;) + &quot;&lt;/td&gt;&quot;; //序號
						verify_notice += &quot;&lt;td&gt;&quot; + vecTableData.get(i).get(&quot;ITEM5&quot;) + &quot;&lt;/td&gt;&quot;; //審核日期
						verify_notice += &quot;&lt;td&gt;&quot; + vecTableData.get(i).get(&quot;ITEM8&quot;) + &quot;&lt;/td&gt;&quot;; //關卡名稱
						verify_notice += &quot;&lt;td&gt;&quot; + vecTableData.get(i).get(&quot;ITEM6&quot;) + &quot;&lt;/td&gt;&quot;; //部門
						verify_notice += &quot;&lt;td&gt;&quot; + vecTableData.get(i).get(&quot;ITEM9&quot;) + &quot;&lt;/td&gt;&quot;; //職稱
						verify_notice += &quot;&lt;td&gt;&quot; + vecTableData.get(i).get(&quot;ITEM4&quot;) + &quot;&lt;/td&gt;&quot;; //姓名
						verify_notice += &quot;&lt;td&gt;&quot; + vecTableData.get(i).get(&quot;ITEM3&quot;) + &quot;&lt;/td&gt;&quot;; //是否核淮
						verify_notice += &quot;&lt;td&gt;&quot; + vecTableData.get(i).get(&quot;ITEM1&quot;) + &quot;&lt;/td&gt;&quot;; //審核意見			
						verify_notice += &quot;&lt;/tr&gt;&quot;;						
					}catch(e){}
				}
				verify_notice += &quot;&lt;/table&gt;&quot;;						
			}catch(e){}
			return verify_notice ;
		}
		
</string> 
     </void> 
     <void property="synopsis"> 
      <string>SendMail</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00051196792258437</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/12/05 02:17:38</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Client.APUtil</string> 
     </void> 
     <void property="id"> 
      <string>SCL00051196792258437</string> 
     </void> 
     <void property="name"> 
      <string>APUtil</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011156610928578</string> 
     </void> 
     <void property="scriptSource"> 
      <string>



//========================================================================================
// 取出從今天算起的日期
//========================================================================================
function getDateSinceNow(diff){
	var myDate = new Packages.pase.agenda.MyDate();
	var currDate = myDate.getCurrentDate();	
	var aDate = myDate.add(currDate,diff);
	return aDate;
}
//========================================================================================
// 取出本月月初的日期
//========================================================================================
function getBeginDateByThisMonth(){
	var myDate = new Packages.pase.agenda.MyDate();
	var currDate = myDate.getCurrentDate();
	var sDate = currDate.substring(0,8) + &quot;01&quot;;
	return sDate;
}
//========================================================================================
// 取出本月月底的日期
//========================================================================================
function getEndDateByThisMonth(){
	var cal = new Packages.java.util.Calendar.getInstance();
	var lastday = cal.getActualMaximum(Packages.java.util.Calendar.DATE);
	var myDate = new Packages.pase.agenda.MyDate();
	var currDate = myDate.getCurrentDate();
	var eDate = currDate.substring(0,8) + lastday;
	return eDate;
}
//========================================================================================
// 取出上月月底的日期
//========================================================================================
function getEndDateByLastMonth(){
	var myDate = new Packages.pase.agenda.MyDate();
	var currDate = myDate.getCurrentDate();	
	var diff    = myDate.getCurrentDay()*(-1);
	var eDate = myDate.add(currDate,diff);
	return eDate;
}
//========================================================================================
// 取出上月月初的日期
//========================================================================================
function getBeginDateByLastMonth(){
	var eDate = getEndDateByLastMonth();
	var sDate = eDate.substring(0,8) + &quot;01&quot;;
	return sDate;
}
//========================================================================================
// 設定畫面查詢條件
//========================================================================================
function setUIDateRange(sDate,eDate){
	Form.setValue(&quot;ckbSDate&quot;,true);
	Form.setValue(&quot;ckbEDate&quot;,true);
	Form.setValue(&quot;sDate&quot;,sDate);
	Form.setValue(&quot;eDate&quot;,eDate);
}





//========================================================================================
//  ISO文件生效查詢單
//========================================================================================
function setResultTableByISOArt() {
	
	try{
		
		var sql = &quot;SELECT * FROM ART00701190304871812_INS&quot; +
		&quot; WHERE ITEM16 != &apos;null&apos; &quot; + getQueryCondition() + &apos; ORDER BY ITEM16&apos;;
		var vec = Client.SQLloadValue(sql);
	}catch(e){
				
	}
			

	var table = Form.getComponent(&quot;ResultTable&quot;);	
	table.clear();
	if (vec.size()&gt;0) {
		for (var i = 0; i &lt; vec.size(); i++) {
			var hm = vec.get(i);
			table.newRow();
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				table.setValueAt(task.getProcessName(),   i, &quot;目前關卡&quot;);
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				table.setValueAt(memberRecord.getName(),  i, &quot;目前處理者&quot;);
				//table.setValueAt(getPriorityString(task), i, &quot;緊急程度&quot;);
			}
			table.setValueAt((i + 1) + &quot;&quot;, i, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ITEM16&quot;),     	i, &quot;表單編號&quot;);
			table.setValueAt(hm.get(&quot;ITEM186&quot;), 	i, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;ITEM24&quot;),  	i, &quot;申請人姓名&quot;);
			table.setValueAt(hm.get(&quot;ITEM141&quot;),   	i, &quot;填寫日期&quot;);			
			table.setValueAt(hm.get(&quot;ITEM106&quot;),   	i, &quot;文件標題&quot;);
			table.setValueAt(hm.get(&quot;ITEM39&quot;),  	i, &quot;文件類別&quot;);
			table.setValueAt(hm.get(&quot;INSID&quot;),   	i, &quot;InsID&quot;);
			
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}

}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00051204017948203</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/05/31 16:50:09</string> 
     </void> 
     <void property="fullName"> 
      <string>com.eland.dms.Techdoc_Auth_Record</string> 
     </void> 
     <void property="id"> 
      <string>SCL00051204017948203</string> 
     </void> 
     <void property="name"> 
      <string>Techdoc_Auth_Record</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011203496283609</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
/**
	20080226
	techdoc_auth_record（文件審核記錄）

CREATE TABLE techdoc_auth_record ( 
    doc_id     varchar(32)  NULL,
    ver_id      number(15)  NULL,
    InsID                  varchar(32)  NULL,
    auth_no             varchar(32)  NULL,
    auth_account              varchar(32) NULL,
    auth_dept          varchar(32) NULL,
    auth_title           varchar(32) NULL,
    auth_flow           varchar(255) NULL,
    process_datetime    number(15) NULL,
    certified_datetime    number(15) NULL,
    auth_result         varchar(255) NULL,
    auth_comment        varchar(1000) NULL
)

	row.put(&quot;ITEM7&quot;, records.size() + 1 + &quot;&quot;);
	row.put(&quot;ITEM5&quot;, addasTime);
	row.put(&quot;ITEM8&quot;, &quot;會簽單位&quot;);
	row.put(&quot;ITEM6&quot;, addasDep);
	row.put(&quot;ITEM9&quot;, addasRole);
	row.put(&quot;ITEM4&quot;, addasName);
	var l_member = Server.getMemberByCName(addasName);
	var l_id = l_member.getMyID();				
	row.put(&quot;ITEM2&quot;, l_id); //工號
	row.put(&quot;ITEM3&quot;, addasResult);
	row.put(&quot;ITEM1&quot;, addasMsg);
	row.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID

*/

function insertTechdoc_auth_record(){
	var tableName = &quot;Process_Table&quot;;
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	//因最後一關,暫時不判斷條件~
//	if(&quot;完成&quot; == aInstance.getArtState().getName() || &quot;報廢&quot; == aInstance.getArtState().getName() ){		
		var records = dataMap.get(tableName);
		try{
				var conn_ekm = Server.createSessionConnection(&quot;EKM&quot;);
				var keys = &quot; doc_id,ver_id,InsID,auth_no,auth_account,auth_dept,auth_title,auth_flow, process_name,certified_datetime ,  auth_result, auth_comment &quot;; //
				var doc_id = dataMap.get(&quot;Doc_ID&quot;);
				var ver_id = dataMap.get(&quot;Ver_ID&quot;);
				var roottaskname = Server.getTask(MyTask.getRootID()).getName();
				Server.addDebugLog(&quot;Insert techdoc_auth_record:&quot;+roottaskname);
				if(&quot;文件變更取消申請單&quot; == roottaskname ){
					ver_id = dataMap.get(&quot;OVer_ID&quot;);
				}
				var insid = aInstance.getID();
				var artifact_name = aInstance.getName();
				for(var i=0;i&lt;records.size();i++){
					var hm = records.get(i);
					var values = &quot;&quot;;
					values += &quot;&apos;&quot; + doc_id + &quot;&apos;,&apos;&quot;;
					values += ver_id    + &quot;&apos;,&apos;&quot;;
					values += insid 	+ &quot;&apos;,&apos;&quot;;
					values += hm.get(&quot;ITEM2&quot;)  + &quot;&apos;,&apos;&quot;;
					values += hm.get(&quot;ITEM4&quot;) + &quot;&apos;,&apos;&quot;;
					values += hm.get(&quot;ITEM6&quot;) + &quot;&apos;,&apos;&quot;;
					values += hm.get(&quot;ITEM9&quot;) + &quot;&apos;,&apos;&quot;;
					values += hm.get(&quot;ITEM8&quot;) + &quot;&apos;,&apos;&quot;;
					values += artifact_name + &quot;&apos;,&apos;&quot;;
					values += hm.get(&quot;ITEM5&quot;) + &quot;&apos;,&apos;&quot;;
					values += hm.get(&quot;ITEM3&quot;) + &quot;&apos;,&apos;&quot;;
					values += hm.get(&quot;ITEM1&quot;) + &quot;&apos;&quot;;
					
					var sql = &quot; insert into techdoc_auth_record (&quot;+ keys +&quot;)values(&quot; + values + &quot;) &quot;;
					conn_ekm.updateValue(sql);
				}
				conn_ekm.commit();
		}catch(e){
			 Server.addDebugLog(&quot;Insert techdoc_auth_record Fail&quot;);
		}finally{			
			conn_ekm.close();			
		}

}

/**
	20080924 cc
	回寫Reason「變更原因」到 techdoc_version  的 description 欄位
*/
function insertTechdoc_Description(){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
//	if(&quot;完成&quot; == aInstance.getArtState().getName()){
		var reason = dataMap.get(&quot;Reason&quot;);
		var description= dataMap.get(&quot;Description&quot;);
		if(description != null &amp;&amp; &quot;&quot; != description){
			description = description.replaceAll(&quot;&apos;&quot;,&quot;&apos;&apos;&quot;);
		}
		if(reason != null &amp;&amp; &quot;&quot; != reason){
			reason = reason.replaceAll(&quot;&apos;&quot;,&quot;&apos;&apos;&quot;);
			try{
				var conn_ekm = Server.createSessionConnection(&quot;EKM&quot;);					
				var doc_id = dataMap.get(&quot;Doc_ID&quot;);
				var ver_id = dataMap.get(&quot;Ver_ID&quot;);
//				var sql = &quot; update techdoc_version set description =&apos;&quot;+ reason +&quot;&apos; , abstract =&apos;&quot;+ description +&quot;&apos; where DOC_ID = &apos;&quot;+ doc_id +&quot;&apos; and VER_ID = &quot;+ ver_id +&quot; &quot;;
				var sql = &quot; update techdoc_version set  abstract =&apos;&quot;+ description +&quot;&apos; where DOC_ID = &apos;&quot;+ doc_id +&quot;&apos; and VER_ID = &quot;+ ver_id +&quot; &quot;;
				conn_ekm.updateValue(sql);
			}catch(e){}
				if(conn_ekm != null)	{
					try	{
						conn_ekm.commit();
					}catch(e){}
					conn_ekm.close();
				}
		}
//	}
}

//回寫變更原因&amp;修訂說明 add by edison@20190531
function insertTechdoc_Description_(){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	var reason = dataMap.get(&quot;Reason&quot;);//變更原因
	var vac= dataMap.get(&quot;Table2&quot;);//修訂說明
	var statement = &quot;&quot;;
	if(vac.size() &gt; 0 ){
		for(var i = 0;i&lt;vac.size();i++){			
			var sn = vac.get(i).get(&quot;ITEM1&quot;);
			var revision = vac.get(i).get(&quot;ITEM5&quot;);
			statement += sn + &quot;.&quot; + revision.replaceAll(&quot;&apos;&quot;,&quot;&apos;&apos;&quot;) +&quot;。\n&quot;;
		}		
	}	
		if(reason != null &amp;&amp; &quot;&quot; != reason &amp;&amp; statement != null &amp;&amp; &quot;&quot; != statement){
			reason = reason.replaceAll(&quot;&apos;&quot;,&quot;&apos;&apos;&quot;);
//			statement = statement.replaceAll(&quot;&apos;&quot;,&quot;&apos;&apos;&quot;);
			try{
				var conn_ekm = Server.createSessionConnection(&quot;EKM&quot;);					
				var doc_id = dataMap.get(&quot;Doc_ID&quot;);
				var ver_id = dataMap.get(&quot;Ver_ID&quot;);
				var sql = &quot; update techdoc_version set description =&apos;&quot;+ statement +&quot;&apos; , abstract =&apos;&quot;+ reason +&quot;&apos; where DOC_ID = &apos;&quot;+ doc_id +&quot;&apos; and VER_ID = &quot;+ ver_id +&quot; &quot;;
				
				conn_ekm.updateValue(sql);
			}catch(e){}
				if(conn_ekm != null)	{
					try	{
						conn_ekm.commit();
					}catch(e){}
					conn_ekm.close();
				}
		}

}

/**
	20110124 cc
	回寫GCE_DOC_SN、GCE_VER_SN「文件編號和版本」到 techdoc_version  的 description 欄位
*/
function insertTechdoc_Doc_Ver(){
		var aInstance = MyTask.getArtInstance();
		var dataMap = aInstance.getAppDataMap();
		var GCE_DOC_SN = dataMap.get(&quot;GCE_Doc_Sn&quot;);
		var GCE_VER_SN = dataMap.get(&quot;GCE_Ver_Sn&quot;);
		if(GCE_DOC_SN != null &amp;&amp; &quot;&quot; != GCE_DOC_SN){
			try{
				var conn_ekm = Server.createSessionConnection(&quot;EKM&quot;);					
				var doc_id = dataMap.get(&quot;Doc_ID&quot;);
				var ver_id = dataMap.get(&quot;Ver_ID&quot;);
				var sql = &quot; update techdoc_version set GCE_DOC_SN =&apos;&quot;+ GCE_DOC_SN +&quot;&apos; , GCE_VER_SN =&apos;&quot;+ GCE_VER_SN +&quot;&apos; where DOC_ID = &apos;&quot;+ doc_id +&quot;&apos; and VER_ID = &quot;+ ver_id +&quot; &quot;;
				conn_ekm.updateValue(sql);
			}catch(e){}
				if(conn_ekm != null)	{
					try	{
						conn_ekm.commit();
					}catch(e){}
					conn_ekm.close();
				}
		}
}
/*
全廠共用變更確認使用-同步作廢三廠文件
20110527 add by edison_wang
*/
function insertTechdoc_auth_record_out(){
	var conn_ekm = Server.createSessionConnection(&quot;EKM&quot;);
	var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var vec = dataMap.get(&quot;Table1&quot;);
		var loginid =dataMap.get(&quot;App_ID&quot;);
		var App_Name =dataMap.get(&quot;App_Name&quot;);
		var App_Title =dataMap.get(&quot;App_Title&quot;);
		var App_Dep =dataMap.get(&quot;App_Dep&quot;);
		var ob_date = new Packages.pase.agenda.MyDate();
        var date = ob_date.getCurrentDate(&quot;Y/M/D&quot;);  //當天日期
		try{
			if(vec.size()&gt;0){
				var doc_id = &quot;&quot;;
				var ver_id = &quot;&quot;;
				var category_id = &quot;&quot;;
				var insid = &quot;&quot;;
				for(var i=0;i&lt;vec.size();i++){
					doc_id = vec.get(i).get(&quot;ITEM4&quot;);
					ver_id = vec.get(i).get(&quot;ITEM5&quot;);
					category_id = vec.get(i).get(&quot;ITEM6&quot;);
					insid = vec.get(i).get(&quot;ITEM7&quot;);
					if(doc_id!=&quot;&quot; &amp;&amp; ver_id!=&quot;&quot; &amp;&amp; category_id!=&quot;&quot;){
						var sql =&quot;Insert into techdoc_auth_record&quot;;
                            sql +=&quot;(DOC_ID, VER_ID, INSID, AUTH_NO, AUTH_ACCOUNT, AUTH_DEPT, AUTH_TITLE, AUTH_FLOW, PROCESS_NAME, CERTIFIED_DATETIME, AUTH_RESULT)&quot;;
                            sql +=&quot;Values&quot;;
                            sql +=&quot;(&apos;&quot;+doc_id+&quot;&apos;, &apos;&quot;+ver_id+&quot;&apos;, &apos;&quot;+insid+&quot;&apos;, &apos;&quot;+loginid+&quot;&apos;, &apos;&quot;+App_Name+&quot;&apos;, &apos;&quot;+App_Dep+&quot;&apos;, &apos;&quot;+App_Title+&quot;&apos;, &apos;文件同步作廢&apos;, &apos;全廠共用-變更確認單&apos;, &apos;&quot;+date+&quot;&apos;, &apos;同意&apos;)&quot;;	
							conn_ekm.updateValue(sql);
					}					
				}
			}
		}catch(e){
		}finally{
			conn_ekm.close();
		}
	
	
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>審核記錄回寫ekm</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00051211866267548</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/05/27 13:31:07</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.RMA.auto_assign_sales</string> 
     </void> 
     <void property="id"> 
      <string>SCL00051211866267548</string> 
     </void> 
     <void property="name"> 
      <string>auto_assign_sales</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00061211339110866</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/**
  only for GCE 
  member.getPager() 為主管的 MEMID
  
*/		
	function getManager(memid){
		var mem = Server.getMember(memid);
		var managerMemID = &quot;Administrator&quot;;
		if(mem != null){
			managerMemID = mem.getPager();
		}
		var manager = Server.getMember(managerMemID);
		return manager;
	}
	
function check_count15(toManager,toAgree){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var mbrLv = &quot;010&quot;;
		var mbrLv = Server.getRole(dataMap.get(&quot;From_User_Role_ID&quot;)).getMyID();
		if (mbrLv == null){
				mbrLv = &quot;010&quot;;
		}
		//沒有核決權限就簽到 104 部門經理
		//var verLv = java.lang.Integer.parseInt(dataMap.get(&quot;Verify_Level&quot;));
		var verLv = dataMap.get(&quot;Verify_Level&quot;);
		if(verLv == &quot;&quot; || verLv == null){
			verLv = &quot;104&quot;;
		}
		if (mbrLv &lt; verLv ){
			//核決權限不足需再簽核
				if (dataMap.get(&quot;Assign_Manager&quot;).equals(&quot;true&quot;) &amp;&amp; dataMap.get(&quot;Manager_ID&quot;) != &quot;&quot;){//增加指定主管
					dataMap.put(&quot;Next_Member_ID&quot;,dataMap.get(&quot;Manager_ID&quot;));
					//清掉指定的主管
					dataMap.put(&quot;Manager_ID&quot;,&quot;&quot;);
					dataMap.put(&quot;Manager_Name&quot;,&quot;&quot;);
					dataMap.put(&quot;Assign_Manager&quot;,&quot;false&quot;);
				}else{//抓 Org 主管
					var from_user_id = dataMap.get(&quot;From_User_ID&quot;);
					var manager = getManager(from_user_id);
					var mgrRoleid = manager.getMainRoleID();
						if(mgrRoleid != null){
							dataMap.put(&quot;Next_Member_Role&quot;,mgrRoleid);
						}
						var next_member_id = manager.getID();
						var next_member = Server.getMember(next_member_id);
						// 當主管啟動代理人，則要再 check 代理人是否和上一關同一人(from_user_id) 同一人的話就再往上找 20070121
						if(next_member.getDeputyState() &amp;&amp; !next_member.isByDeputyRule() &amp;&amp; Server.getMember(next_member.getDeputyID())!= null ){
								var deputy_member_id = next_member.getDeputyID(); //取代理人當下一個人
								if(from_user_id.equals(deputy_member_id)){
									//為同一人，要再 check 是否超核
									mgrRoleid = getManager().getMainRoleID();
									mgrLv =  Server.getRole(mgrRoleid).getMyID();
									if(mgrLv &gt; verLv){
										Server.flowTo(MyTask,toAgree);
										return;
									}									
								}
							}else{
							//沒有代理人的情況
								if(from_user_id.equals(next_member_id)){
									//為同一人，要再 check 是否超核
									//還是抓到同一個人 : Server.getManagerRole(mgrRole.getID()) 不能用
									
									mgrRoleid = getManager().getMainRoleID();
									mgrLv =  Server.getRole(mgrRoleid).getMyID();
									if(mgrLv &gt; verLv){
										Server.flowTo(MyTask,toAgree);
										return;
									}
								}
							}
							dataMap.put(&quot;Next_Member_ID&quot;,next_member_id);
				}
				Server.flowTo(MyTask,toManager);// 主管簽核
		}else{
				
				Server.flowTo(MyTask,toAgree);
		}
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00051481792955176</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2017/05/08 16:14:44</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.R</string> 
     </void> 
     <void property="id"> 
      <string>SCL00051481792955176</string> 
     </void> 
     <void property="name"> 
      <string>R</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function getDinnerTime_A(Start,End){
	var myDate = new Packages.pase.agenda.MyDate();
	var App_date = Form.getValue(&quot;App_date&quot;);
	var total = 0;
	var overBeg = Start;
	var dinnerA_S = App_date + &quot; &quot; + &quot;12:00:00&quot;;
	var dinnerA_E = App_date + &quot; &quot; + &quot;13:00:00&quot;;
	var dinnerB_S = App_date + &quot; &quot; + &quot;18:00:00&quot;;
	var dinnerB_E = App_date + &quot; &quot; + &quot;18:30:00&quot;;
	var dinnerC_S = App_date + &quot; &quot; + &quot;02:00:00&quot;;
	var dinnerC_E = App_date + &quot; &quot; + &quot;03:00:00&quot;;
	if (dinnerA_E &lt; overBeg){
		dinnerA_S =  myDate.addDay(dinnerA_S,1);	
	}
	if (dinnerA_E &lt; overBeg){
		dinnerA_E =  myDate.addDay(dinnerA_E,1);	
	}
	if (dinnerB_S &lt; overBeg){
		dinnerB_S =  myDate.addDay(dinnerB_S,1);	
	}
	if (dinnerB_E &lt; overBeg){
		dinnerB_E =  myDate.addDay(dinnerB_E,1);	
	}
	if (dinnerC_S &lt; overBeg){
		dinnerC_S =  myDate.addDay(dinnerC_S,1);
	}
	if (dinnerC_E &lt; overBeg){
		dinnerC_E =  myDate.addDay(dinnerC_E,1);	
	}
	var beg = Start;
	var end = End;
	if (beg &lt; overBeg){//表示跨一日了
		beg =  myDate.addDay(beg,1);	
	}
	if (end &lt; overBeg ){//表示跨一日了
		end =  myDate.addDay(end,1);
	}
	total = calDinner(beg,end,dinnerA_S,dinnerA_E) + calDinner(beg,end,dinnerB_S,dinnerB_E) + calDinner(beg,end,dinnerC_S,dinnerC_E) ;

	return total;
}

function getDinnerTime(){
	var myDate = new Packages.pase.agenda.MyDate();
	var RecordInfo = Form.getComponent(&quot;RecordInfo&quot;);//將表單中的Table物件取出
	var rowCountf0 = RecordInfo.getRowCount();
	var total = 0;
	var overBeg = RecordInfo.getValueAt(0,&quot;出勤日期&quot;) + &quot; &quot; + RecordInfo.getValueAt(0,&quot;出勤時段&quot;).substring(0,5);
	var dinnerA_S = RecordInfo.getValueAt(0,&quot;出勤日期&quot;) + &quot; &quot; + &quot;12:00&quot;;
	var dinnerA_E = RecordInfo.getValueAt(0,&quot;出勤日期&quot;) + &quot; &quot; + &quot;13:00&quot;;
	var dinnerB_S = RecordInfo.getValueAt(0,&quot;出勤日期&quot;) + &quot; &quot; + &quot;18:00&quot;;
	var dinnerB_E = RecordInfo.getValueAt(0,&quot;出勤日期&quot;) + &quot; &quot; + &quot;18:30&quot;;
	var dinnerC_S = RecordInfo.getValueAt(0,&quot;出勤日期&quot;) + &quot; &quot; + &quot;02:00&quot;;
	var dinnerC_E = RecordInfo.getValueAt(0,&quot;出勤日期&quot;) + &quot; &quot; + &quot;03:00&quot;;
	if (dinnerA_S &lt; overBeg){
		dinnerA_S =  myDate.addDay(dinnerA_S,1);	
	}
	if (dinnerA_E &lt; overBeg){
		dinnerA_E =  myDate.addDay(dinnerA_E,1);	
	}
	if (dinnerB_S &lt; overBeg){
		dinnerB_S =  myDate.addDay(dinnerB_S,1);	
	}
	if (dinnerB_E &lt; overBeg){
		dinnerB_E =  myDate.addDay(dinnerB_E,1);	
	}
	if (dinnerC_S &lt; overBeg){
		dinnerC_S =  myDate.addDay(dinnerC_S,1);
	}
	if (dinnerC_E &lt; overBeg){
		dinnerC_E =  myDate.addDay(dinnerC_E,1);	
	}
	for(var i = 0 ; i &lt;rowCountf0 ; i++){
		var timef0 = RecordInfo.getValueAt(i,&quot;出勤日期&quot;);
	    var xtimef0 = RecordInfo.getValueAt(i,&quot;出勤時段&quot;);
		var beg = timef0+&quot; &quot;+xtimef0.substring(0,5);// 舊有請假起始時間
		var end = timef0+&quot; &quot;+xtimef0.substring(6,11);// 舊有請假結束時間
		if (beg &lt; overBeg){//表示跨一日了
			beg =  myDate.addDay(beg,1);	
		}
		if (end &lt; overBeg ){//表示跨一日了
			end =  myDate.addDay(end,1);
		}
		total = calDinner(beg,end,dinnerA_S,dinnerA_E) + calDinner(beg,end,dinnerB_S,dinnerB_E) + calDinner(beg,end,dinnerC_S,dinnerC_E) ;
	}
	return total;
}

function calDinner(beg,end,dinner_S,dinner_E){
	var myDate = new Packages.pase.agenda.MyDate();
	var S;
	var E;
	var total = 0;
	var diff_S = myDate.getSubtractSecond(beg,dinner_S)
	var diff_E =myDate.getSubtractSecond(end,dinner_E)
	if(diff_S &gt; 0){
		S = dinner_S;
	}else{
		S = beg;
	}
	if(diff_E &lt; 0){
		E = dinner_E;
	}else{
		E = end;
	}
	if(S &gt; E){
	}else{
		total = myDate.getSubtractSecond(S,E) ;
	}
	return total;
}


function chkHoliday(App_date){
	var sql =  &quot; select *from a_parameter_data where parameter=&apos;HR_TGCE_R1_DATE&apos; &quot;;
		sql += &quot; and value1=&apos;&quot;+ App_date +&quot;&apos; &quot;;
		sql += &quot; and (&apos;&quot; + Form.getValue(&quot;App_Dep_ID&quot;) + &quot;&apos; like value2  or value2 =&apos;ALL&apos;) &quot;;
	var vec = Client.SQLloadValue(sql);
	if (vec.size() &gt; 0){
		return true;			
	}
	var myDate = new Packages.pase.agenda.MyDate();
	var dayOfWeekIndex = java.lang.Integer.parseInt(myDate.getDayOfWeek(App_date));// 取得請假日為星期幾					
	if(dayOfWeekIndex==6||dayOfWeekIndex==0){
		return true;// 該日休假
	}
	try{
		var sql = &quot;SELECT * from empm110 where date(holiday) = date(&apos;&quot; + App_date + &quot;&apos;)&quot;;
		var conn = Client.createSessionConnection(&quot;T-MES&quot;);
		var vec = conn.loadValue(sql);
		if(vec.size()&gt;0){
			return true;// 該日休假
		}else{
			return false;
		}
	}catch(e){
		Form.showMessageDialog(e);
		loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
		sendErrorMail_Client(e);
	}finally{
		conn.close();
	}
}

//根據Empm061判斷當天是否已申請過換休算申請單
function compareAppWithEmpm061_new(empno,thisDate){
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var sql =  &quot;select * from empm061 &quot;;
		sql	+= &quot;where empno=&apos;&quot; + empno + &quot;&apos; and absdate=date(&apos;&quot; + thisDate + &quot;&apos;) &quot;;
	var vec = loadSQL(sql,&quot;T-MES&quot;);
	if(vec.size()&gt;0){
		return thisDate+&quot;已提換休申請單或換休結算申請單，且已結案無法再次申當日換休，請確認。&quot;;
	}else{
		return &quot;&quot;;
	}
}

//設定出勤記錄 (本日+前後一日)
function setRecord(App_date){
	var Record = Form.getComponent(&quot;Record&quot;);
	var App_ID = Form.getValue(&quot;App_ID&quot;);
	var myDate = new Packages.pase.agenda.MyDate();	
	var _format1 = new java.text.SimpleDateFormat(&quot;yyyy/mm/dd&quot;);
	var _format2 = new java.text.SimpleDateFormat(&quot;yyyymmdd&quot;);
	var App_date = _format1.parse(Form.getValue(&quot;App_date&quot;));
	var App_date1 = myDate.addDay(Form.getValue(&quot;App_date&quot;),-1);
	var App_date2 = myDate.addDay(Form.getValue(&quot;App_date&quot;),1);
	Record.clear();
	var sql = &quot;select * from empm085 where empno = &apos;&quot; + App_ID + &quot;&apos; and f_date between  &apos;&quot; + _format2.format(_format1.parse(App_date1))	+ &quot;&apos; and &apos;&quot; + _format2.format(_format1.parse(App_date2))	+ &quot;&apos;&quot;;		
	var record = new java.util.Vector();// 存放當月出勤記錄
	try{
		var conn = Client.createSessionConnection(&quot;T-MES&quot;);
		var vec = conn.loadValue(sql);
		if(vec.size()&gt;0){
			for(var i=0;i&lt;vec.size();i++){
				var result = vec.get(i);
				var GETSTRday = result.get(&quot;f_datetime&quot;);
				var GETWAYS = result.get(&quot;in_out&quot;);
				var gate_name = result.get(&quot;gate_name&quot;);
				var gate_empno = result.get(&quot;empno&quot;);
				var gate_dptno = result.get(&quot;dptno&quot;);
				if(GETWAYS==&quot;1&quot;){
					GETWAYS = &quot;進&quot;;
				}else{
					GETWAYS = &quot;出&quot;;
				}
				var row = Record.newRow() -1;
				Record.setValueAt(i+1+&quot;&quot;,row,&quot;序號&quot;);
				Record.setValueAt(GETWAYS +&quot;：&quot;+ GETSTRday,row,&quot;出勤記錄&quot;);
				Record.setValueAt(gate_name,row,&quot;門禁名稱&quot;);	
				Record.setValueAt(gate_empno,row,&quot;工號&quot;);	
				Record.setValueAt(gate_dptno,row,&quot;部門&quot;);	
			}
		}
	}catch(e){
		loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
		sendErrorMail_Client(&quot;資料庫連線異常：\n&quot;+e);
	}finally{
		conn.close();
	}
}

//取得整數值
function getIntegerValue(appHour){
	var strAppHour = java.lang.Float.toString(appHour);
	var index = strAppHour.indexOf(&quot;.&quot;);
	strAppHour = strAppHour.substring(0,index);
	return java.lang.Integer.parseInt(strAppHour);
}

//根簽核單的做比較,如果有簽中的則不可再次申請
function compareAppWithForm_new(App_MemID,thisDate){
	//ART00001291889937745  換休申請單
	//ART01871481616380347  換休結算申請單
	// 與簽核中未轉的比較
	var sql =  &quot;select a.insid from ART00001291889937745_INS a, ART00001291889937745ITEM13 b &quot;;
		sql += &quot;where a.insid = b.insid and a.ITEM43=&apos;&quot; + App_MemID + &quot;&apos; and b.ITEM3=&apos;&quot;+thisDate+&quot;&apos; &quot;;
		sql	+= &quot;and item149=&apos;簽核&apos;&quot;;
		sql	+= &quot; union &quot;;
		sql =  &quot;select c.insid from ART01871481616380347_INS c, ART01871481616380347ITEM13 d &quot;;
		sql += &quot;where c.insid = d.insid and c.ITEM43=&apos;&quot; + App_MemID + &quot;&apos; and d.ITEM3=&apos;&quot;+thisDate+&quot;&apos; &quot;;
		sql	+= &quot;and item149=&apos;簽核&apos;&quot;;
	var vec = Client.SQLloadValue(sql);
	if(vec.size()&gt;0){
		return thisDate+ &quot;已有簽核中之換休申請單或換休結算申請單，請確認。&quot;;// 代表已經有該請假區間			
	}else{
		return &quot;&quot;;
	}	
}

function chkApplyUp(App_MemID,App_date,txtTotal){
	var total = 0;
	var thisYear = App_date.substring(0,4);
	var thisMonth = App_date.substring(5,7) * 1;
	var empno = App_MemID.substring(5,7);
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var sql =  &quot; select nvl(sum(timecnt),0) timecnt from empm061 &quot;;
		sql	+= &quot; where empno=&apos;&quot; + empno + &quot;&apos;  and abstype=&apos;R2&apos;&quot;;
		sql += &quot; and year(absdate)= &quot; + thisYear+&quot; and month(absdate) = &quot; + thisMonth;
	var vec = loadSQL(sql,&quot;T-MES&quot;);
	var empm060_timecnt = vec.get(0).get(&quot;timecnt&quot;);
	var sql =  &quot;select sum(c.item119) item119 from ART01871481616380347_INS c, ART01871481616380347ITEM13 d &quot;;
		sql += &quot;where c.insid = d.insid and c.ITEM43=&apos;&quot; + App_MemID + &quot;&apos; and d.ITEM3=&apos;&quot;+App_date+&quot;&apos; &quot;;
		sql	+= &quot;and item149=&apos;簽核&apos;&quot;;
	var vec = Client.SQLloadValue(sql);
	var form_item119 = vec.get(0).get(&quot;item119&quot;);
	total = empm060_timecnt * 1 + empm060_timecnt * 1 + txtTotal *1;
 	var jobLevel = Client.getMember(App_MemID).getJobLevel().substring(1,2);
	if(jobLevel == &quot;4&quot; || jobLevel == &quot;5&quot; || jobLevel == &quot;6&quot;){
		if (total &gt; 24){
			return &quot;4-6職等每月最多只可申請24小時換休結算！\n已申請(含本次):&quot;+ total;
		}
	}else if(jobLevel == &quot;7&quot;){
		if (total &gt; 12){
			return &quot;7職等每月最多只可申請12小時換休結算！\n已申請(含本次):&quot;+ total;
		}	
	}else{
		return &quot;非4-7職等，不得提出換休結算申請單！&quot;;
	}
	return &quot;&quot;;
}

function getR1R2_recore_table(App_ID,App_date){
	var thisYear = App_date.substring(0,4);
	var thisMonth = App_date.substring(5,7);
	var X1,X2,X3,X4,X5,X6,X7;
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var sql =  &quot; select nvl(sum(timecnt),0) timecnt from empm061 &quot;;
		sql	+= &quot; where empno=&apos;&quot; + App_ID + &quot;&apos;  and abstype=&apos;R1&apos;&quot;;
		sql += &quot; and year(absdate)= &quot; + thisYear+&quot; and month(absdate) = &quot; + thisMonth;
	var vec = loadSQL(sql,&quot;T-MES&quot;);
	var X1 = vec.get(0).get(&quot;timecnt&quot;);

	var sql =  &quot; select nvl(sum(timecnt),0) timecnt from empm061 &quot;;
	sql	+= &quot; where empno=&apos;&quot; + App_ID + &quot;&apos;  and abstype=&apos;R2&apos;&quot;;
	sql += &quot; and year(absdate)= &quot; + thisYear+&quot; and month(absdate) = &quot; + thisMonth;
	var vec = loadSQL(sql,&quot;T-MES&quot;);
	var X2 = vec.get(0).get(&quot;timecnt&quot;);

	var sql =  &quot; select nvl(sum(timecnt),0) timecnt from empm061 &quot;;
	sql	+= &quot; where empno=&apos;&quot; + App_ID + &quot;&apos;  and abstype=&apos;R1&apos;&quot;;
	sql += &quot; and year(absdate)= &quot; + thisYear;
	var vec = loadSQL(sql,&quot;T-MES&quot;);
	var X4 = vec.get(0).get(&quot;timecnt&quot;);
	
	
	var sql =  &quot; select nvl(sum(timecnt),0) timecnt from empm061 &quot;;
	sql	+= &quot; where empno=&apos;&quot; + App_ID + &quot;&apos;  and abstype=&apos;R2&apos;&quot;;
	sql += &quot; and year(absdate)= &quot; + thisYear;
	var vec = loadSQL(sql,&quot;T-MES&quot;);
	var X7 = vec.get(0).get(&quot;timecnt&quot;);
	
	X3 = X4*1+X7*1;
	
	var sql =  &quot; select nvl(sum(timecnt),0) timecnt from empm060 &quot;;
	sql	+= &quot; where empno=&apos;&quot; + App_ID + &quot;&apos;  and abstype=&apos;R1&apos;&quot;;
	sql += &quot; and year(absdate)= &quot; + thisYear;
	var vec = loadSQL(sql,&quot;T-MES&quot;);
	var X5 = vec.get(0).get(&quot;timecnt&quot;);
	
	X6 = X4*1 - X5*1 ;
	Form.setValue(&quot;X1&quot;,X1);//本月換休
	Form.setValue(&quot;X2&quot;,X2);//本月換休結算
	Form.setValue(&quot;X3&quot;,X3);//本年度換休與換休結算總時數
	Form.setValue(&quot;X4&quot;,X4);//本年度換休時數
	Form.setValue(&quot;X5&quot;,X5);//本年度已換休時數
	Form.setValue(&quot;X6&quot;,X6);//本年度剩餘可換休時數
	Form.setValue(&quot;X7&quot;,X7);//本年度換休結算總時數						
}

//根簽核單的做比較,如果有簽中的則不可再次申請
function compareAppWithForm_new_a(App_MemID,writebegintimef0,writeendtimef0){
	//ART00001291889937745  換休申請單
	//ART01871481616380347  換休結算申請單
	// 與簽核中未轉的比較
	var sql =  &quot;select a.insid from ART00001291889937745_INS a, ART00001291889937745ITEM13 b &quot;;
		sql += &quot;where a.insid = b.insid and a.ITEM43=&apos;&quot; + App_MemID + &quot;&apos; &quot;;
		sql += &quot;and ((&apos;&quot;+writebegintimef0+&quot;&apos; &gt;= b.item3 || &apos; &apos; || substr(b.item4,1,5) and &apos;&quot; + writebegintimef0 + &quot;&apos; &lt; b.item3 || &apos; &apos; || substr(b.item4,7,5)) or  &quot;;
		sql += &quot;( &apos;&quot;+writeendtimef0+&quot;&apos; &gt; b.item3 || &apos; &apos; || substr(b.item4,1,5) and &apos;&quot; + writeendtimef0 + &quot;&apos; &lt;= b.item3 || &apos; &apos; || substr(b.item4,7,5)) )&quot;;
		sql	+= &quot; and item149=&apos;簽核&apos;&quot;;
		sql	+= &quot; union &quot;;
		sql +=  &quot;select c.insid from ART01871481616380347_INS c, ART01871481616380347ITEM13 d &quot;;
		sql += &quot;where c.insid = d.insid and c.ITEM43=&apos;&quot; + App_MemID + &quot;&apos; &quot;;
		sql += &quot;and ((&apos;&quot;+writebegintimef0+&quot;&apos; &gt;= d.item3 || &apos; &apos; || substr(d.item4,1,5) and &apos;&quot; + writebegintimef0 + &quot;&apos; &lt; d.item3 || &apos; &apos; || substr(d.item4,7,5)) or  &quot;;
		sql += &quot;( &apos;&quot;+writeendtimef0+&quot;&apos; &gt; d.item3 || &apos; &apos; || substr(d.item4,1,5) and &apos;&quot; + writeendtimef0 + &quot;&apos; &lt;= d.item3 || &apos; &apos; || substr(d.item4,7,5)) )&quot;;
		sql	+= &quot; and item149=&apos;簽核&apos;&quot;;
	var vec = Client.SQLloadValue(sql);
	Client.addDebugLog(&quot;compareAppWithForm_new_a=&quot;+sql)
	if(vec.size()&gt;0){
		return writebegintimef0 + &quot;-&quot;+ writeendtimef0 + &quot;已有簽核中之換休申請單或換休結算申請單，請確認。&quot;;// 代表已經有該請假區間			
	}else{
		return &quot;&quot;;
	}	
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>R假相關共用程式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00061139206122020</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/02/06 14:08:42</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.SystemFunction.MailFunction</string> 
     </void> 
     <void property="id"> 
      <string>SCL00061139206122020</string> 
     </void> 
     <void property="name"> 
      <string>MailFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//第一關的mail通知 (只能用於表單)
function mailForFirst(){
	var task = Form.getCurrentTask();
	var rootUser = task.getRootUser();   //表單開啟者
	var processName = task.getProcessName();   //工作名稱
	var rootName = task.getRootName();   //流程名稱
	var keyWord = task.getKeyWord();   //工作主題
	var synopsis = task.getSynopsis();   //說明
	var priority = task.getPriority();   //優先順序
	var id = task.getID();   //taskID

	if (priority == 0) priority = &quot;最速件&quot;;
	else if (priority == 1) priority = &quot;速件&quot;;
	else if (priority == 2) priority = &quot;普通件&quot;;
	else priority = &quot;一般&quot;;

	var from = &quot;Administrator@bcom.com&quot;;   //信件來源 e-mail
	var to = Client.getCurrentMember().getEmail();  //表單開啟人
	var subject = rootUser + &apos;\u0020&apos; + rootName + &apos;\u0020&apos; + &quot;工作已開始通知&quot;;   //信件主旨
	var content = &quot;您有一份工作(名稱：&quot; + processName + &quot;)已經送到&quot; +
			&quot;\n          您的手上，請儘速處理!&quot; +
			&quot;\n               流程名稱：&quot; + rootName +
			&quot;\n               工作名稱：&quot; + processName +
			&quot;\n               工作主題：&quot; + keyWord +
			&quot;\n               工作說明：&quot; + synopsis +
			&quot;\n               等級：&quot; + priority +
			&quot;\n               申請人：&quot; + rootUser +
			&quot;\n               工作編號：&quot; + id +
			&quot;\n               網址：http://portal.mybcom.com/wps/portal&quot;;
	Client.sendMail(from,to,subject,content);   //傳送 e-mail 給該員工

}

//手動mail通知
//bSendflag A: 申請人
//bSendflag W: 填表人
//bRejectflag true :駁回信件 
//bRejectflag false :核准信件   
function mailForManual_Server(bSendflag,subjectAppend,content){
	
	var artInstance = MyTask.getArtInstance();
	var memID = MyTask.getRealExecutor();   //表單執行者
	var member = Server.getMember(memID);
	var processName = MyTask.getProcessName(); //工作名稱
	var rootName = MyTask.getRootName();	//流程名稱
	var keyWord = MyTask.getKeyWord();  //工作主題
	var applicantID = artInstance.getAppValue(&quot;txtApplicantID&quot;); //申請人代號
	var writerID = artInstance.getAppValue(&quot;txtUserID&quot;); //填表人代號
	var toEmail =&quot;&quot;;
	var toName =&quot;&quot;;
	var status =&quot;&quot;; 
	
	if (bSendflag.equals(&quot;A&quot;)){
		toEmail = Server.getMember(applicantID).getEmail(); //申請人
		toName = Server.getMember(applicantID).getName();
	} else if (bSendflag.equals(&quot;W&quot;)){
		toEmail = Server.getMember(writerID).getEmail(); //填表人
		toName = Server.getMember(writerID).getName();
	} else {
		
	}
	
	var from = member.getEmail();   //信件來源 e-mail
	var to = toEmail;
	var subject	= toName + subjectAppend;
	Server.sendMail(from,to,subject,content);   //傳送 e-mail 給該員工

}
//取得文管中心所有成員的 Mail List, 以作為副件名單
function getDocumentCenterMailList(){
	var depName = &quot;資料中心&quot;;
	var result = &quot;&quot;;
	var department = Client.getOneDepartmentByName(depName);
	if(department!=null){
		var roleList = department.getRoleList();
		var i = roleList.iterator();
		while(i.hasNext()){
			var roleId = i.next();
			var role = Client.getRole(roleId);
			var memberList = role.getMemberList();
			var j = memberList.iterator();
			while(j.hasNext()){
				var memberId = j.next();
				var member = Client.getMemberByID(memberId);
				if(member != null){
					//避免重複寄送
					var index = mailList.indexOf(member.getEmail());
					if(index == -1)
						result += member.getEmail() + &quot;;&quot;;
				}
			}
		}	
	}
	return result;	
}
//取得指定職務的人員的 mail
function getRoleMemberMail(roleID, orgMailList){
	var iRole = Client.getRole(roleID);
	var iMemberList = iRole.getMemberList();
	for(j = 0; j &lt; iMemberList.size(); j ++){
		var jMember = Client.getMember(iMemberList.get(j));
		if(jMember != null){
			//避免重複
			var indexStr = orgMailList.indexOf(jMember.getEmail());
			if(indexStr == -1){
				orgMailList += jMember.getEmail() + &quot;;&quot;;
			}
		}
	}
	
	return orgMailList;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>寄信功能
</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00061156729683843</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/08/28 09:48:03</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Server.SystemAutoAssign</string> 
     </void> 
     <void property="id"> 
      <string>SCL00061156729683843</string> 
     </void> 
     <void property="name"> 
      <string>SystemAutoAssign</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021156610951562</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/**
  only for GCE 
  member.getPager() 為主管的 MEMID
  
*/		
	function getManager(memid){
		var mem = Server.getMember(memid);
		var managerMemID = &quot;Administrator&quot;;
		if(mem != null){
			managerMemID = mem.getPager();
		}
		var manager = Server.getMember(managerMemID);
		return manager;
	}
// 有主管下屬有兩個單位,且直屬主管也有兩位	add by wangwei@2009/02/25
	function getManagerExt(memid,vDept){
		var mem = Server.getMember(memid);
		var managerMemID = &quot;Administrator&quot;;
		if(mem != null){
			managerMemID = mem.getPager();
		}			
// 再select  設定檔		
	    var sql = &quot; select trim(value1) as pager from a_parameter_data where parameter = &apos;MUTIL_DEPARTMENT&apos; and key1 = &apos;&quot;+memid+&quot;&apos; and  value2 = &apos;&quot;+vDept+&quot;&apos;&quot;  ;
		var vector = Server.SQLloadValue(sql);				
			if ( vector != null ){
				if (vector.size()&gt;0){
					managerMemID = vector.get(0).get(&quot;pager&quot;);
				}
			}	
		var manager = Server.getMember(managerMemID);
		return manager;
	}



function autoAssignManager(toManager,toAgree){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var mbrLv = &quot;010&quot;;
		var vApp_DepID= dataMap.get(&quot;App_DepID&quot;);
		var mbrLv = Server.getRole(dataMap.get(&quot;From_User_Role_ID&quot;)).getMyID();
		if (mbrLv == null){
				mbrLv = &quot;010&quot;;
		}
		//沒有核決權限就簽到 104 部門經理
		//var verLv = java.lang.Integer.parseInt(dataMap.get(&quot;Verify_Level&quot;));
		var verLv = dataMap.get(&quot;Verify_Level&quot;);
		if(verLv == &quot;&quot; || verLv == null){
			verLv = &quot;104&quot;;
		}
		if (mbrLv &lt; verLv ){
			//核決權限不足需再簽核
				if (dataMap.get(&quot;Assign_Manager&quot;).equals(&quot;true&quot;) &amp;&amp; dataMap.get(&quot;Manager_ID&quot;) != &quot;&quot;){//增加指定主管
					dataMap.put(&quot;Next_Member_ID&quot;,dataMap.get(&quot;Manager_ID&quot;));
					//清掉指定的主管
					dataMap.put(&quot;Manager_ID&quot;,&quot;&quot;);
					dataMap.put(&quot;Manager_Name&quot;,&quot;&quot;);
					dataMap.put(&quot;Assign_Manager&quot;,&quot;false&quot;);
				}else{//抓 Org 主管
					var from_user_id = dataMap.get(&quot;From_User_ID&quot;);
					var manager = getManagerExt(from_user_id,vApp_DepID);
					var mgrRoleid = manager.getMainRoleID();
						if(mgrRoleid != null){
							dataMap.put(&quot;Next_Member_Role&quot;,mgrRoleid);
						}
						var next_member_id = manager.getID();
						var next_member = Server.getMember(next_member_id);
						// 當主管啟動代理人，則要再 check 代理人是否和上一關同一人(from_user_id) 同一人的話就再往上找 20070121
						if(next_member.getDeputyState() &amp;&amp; !next_member.isByDeputyRule() &amp;&amp; Server.getMember(next_member.getDeputyID())!= null ){
								var deputy_member_id = next_member.getDeputyID(); //取代理人當下一個人
								if(from_user_id.equals(deputy_member_id)){
									//為同一人，再向上找一層，要再 check 是否超核
									mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
									next_member_id = getManagerExt(next_member_id,vApp_DepID).getID();
									mgrLv =  Server.getRole(mgrRoleid).getMyID();
									if(mgrLv &gt; verLv){
										Server.flowTo(MyTask,toAgree);
										return;
									}									
								}
							}else{
							//沒有代理人的情況
								if(from_user_id.equals(next_member_id)){
									//為同一人，要再 check 是否超核
									//還是抓到同一個人 : Server.getManagerRole(mgrRole.getID()) 不能用
									next_member_id = getManagerExt(next_member_id,vApp_DepID).getID();
									mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
									mgrLv =  Server.getRole(mgrRoleid).getMyID();								
									if(mgrLv &gt; verLv){
										Server.flowTo(MyTask,toAgree);
										return;
									}
								}
							}
							dataMap.put(&quot;Next_Member_ID&quot;,next_member_id);
				}
				Server.flowTo(MyTask,toManager);// 主管簽核
		}else{
				
				Server.flowTo(MyTask,toAgree);
		}
}


	function autoAssignManager_wolf(toManager,toAgree){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		//var mbrLv = &quot;010&quot;;
		//var mbrLv = Server.getRole(dataMap.get(&quot;From_User_Role_ID&quot;)).getMyID();
	   // var cMember = Server.getMemberByID(dataMap.get(&quot;Next_Member_ID&quot;));		   
	    var mbrLv =Server.getRole(dataMap.get(&quot;Next_Member_Role&quot;)).getMyID();	
		//var mbrLv = Server.getRole(roleID).getMyID();
		if (mbrLv == null){
				mbrLv = &quot;010&quot;;
		}
		
	
		//沒有核決權限就簽到 104 部門經理
		//var verLv = java.lang.Integer.parseInt(dataMap.get(&quot;Verify_Level&quot;));
		var verLv = dataMap.get(&quot;Verify_Level&quot;);
		if(verLv == &quot;&quot; || verLv == null){
			verLv = &quot;104&quot;;
		}
		if (mbrLv &lt; verLv ){
			//核決權限不足需再簽核
		Server.flowTo(MyTask,toManager);// 主管簽核
		}else{
				
				Server.flowTo(MyTask,toAgree);
		}
}


function autoAssignManager2(toManager,toAgree){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var vApp_DepID=dataMap.get(&quot;App_DepID&quot;);
		var mbrLv = &quot;010&quot;;
		var mbrLv = Server.getRole(dataMap.get(&quot;From_User_Role_ID&quot;)).getMyID();
		if (mbrLv == null){
				mbrLv = &quot;010&quot;;
		}
		//沒有核決權限就簽到 104 部門經理
		//var verLv = java.lang.Integer.parseInt(dataMap.get(&quot;Verify_Level&quot;));
		var verLv = dataMap.get(&quot;Verify_Level&quot;);
		if(verLv == &quot;&quot; || verLv == null){
			verLv = &quot;104&quot;;
		}
		if (mbrLv &lt; verLv ){
			//核決權限不足需再簽核
				if (dataMap.get(&quot;Assign_Manager&quot;).equals(&quot;true&quot;) &amp;&amp; dataMap.get(&quot;Manager_ID&quot;) != &quot;&quot;){//增加指定主管
					dataMap.put(&quot;Next_Member_ID&quot;,dataMap.get(&quot;Manager_ID&quot;));
					//清掉指定的主管
					dataMap.put(&quot;Manager_ID&quot;,&quot;&quot;);
					dataMap.put(&quot;Manager_Name&quot;,&quot;&quot;);
					dataMap.put(&quot;Assign_Manager&quot;,&quot;false&quot;);
				}else{//抓 Org 主管
					var from_user_id = dataMap.get(&quot;From_User_ID&quot;);
					var manager = getManagerExt(from_user_id,vApp_DepID);
					var mgrRoleid = manager.getMainRoleID();
						if(mgrRoleid != null){
							dataMap.put(&quot;Next_Member_Role&quot;,mgrRoleid);
						}
						var next_member_id = manager.getID();
						var next_member = Server.getMember(next_member_id);
						// 當主管啟動代理人，則要再 check 代理人是否和上一關同一人(from_user_id) 同一人的話就再往上找 20070121
						if(next_member.getDeputyState() &amp;&amp; !next_member.isByDeputyRule() &amp;&amp; Server.getMember(next_member.getDeputyID())!= null ){
								var deputy_member_id = next_member.getDeputyID(); //取代理人當下一個人
								if(from_user_id.equals(deputy_member_id)){
									//為同一人，要再 check 是否超核
									mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
									mgrLv =  Server.getRole(mgrRoleid).getMyID();
									if(mgrLv &gt; verLv){
										Server.flowTo(MyTask,toAgree);
										return;
									}									
								}
							}else{
							//沒有代理人的情況
								if(from_user_id.equals(next_member_id)){
									//為同一人，要再 check 是否超核
									//還是抓到同一個人 : Server.getManagerRole(mgrRole.getID()) 不能用
									
									mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
									mgrLv =  Server.getRole(mgrRoleid).getMyID();
									if(mgrLv &gt; verLv){
										Server.flowTo(MyTask,toAgree);
										return;
									}
								}
							}
							dataMap.put(&quot;Next_Member_ID&quot;,next_member_id);
				}
				Server.flowTo(MyTask,toManager);// 主管簽核
		}else{
				
				Server.flowTo(MyTask,toAgree);
		}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00061197197728734</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/12/09 18:55:28</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.DMS.DMSAP</string> 
     </void> 
     <void property="id"> 
      <string>SCL00061197197728734</string> 
     </void> 
     <void property="name"> 
      <string>DMSAP</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011194752256531</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//loadLibrary(&quot;com.A.DMS.DMSAP&quot;);

	
//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showChangeTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				table.setValueAt(task.getProcessName(),   row, &quot;目前關卡&quot;);
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
				//table.setValueAt(getPriorityString(task), i, &quot;緊急程度&quot;);
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ITEM16&quot;),     	row, &quot;表單編號&quot;);
			table.setValueAt(hm.get(&quot;ITEM122&quot;),    	row, &quot;文件編號&quot;);			
			table.setValueAt(hm.get(&quot;ITEM186&quot;), 	row, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;ITEM24&quot;),  	row, &quot;申請人姓名&quot;);
			table.setValueAt(hm.get(&quot;ITEM141&quot;),   	row, &quot;填寫日期&quot;);			
			table.setValueAt(hm.get(&quot;ITEM106&quot;),   	row, &quot;文件標題&quot;);
			table.setValueAt(hm.get(&quot;ITEM39&quot;),  	row, &quot;文件類別&quot;);
			table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getChangeQueryCondition(){
	var sSQL=&quot;&quot;;
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			sSQL += &quot; AND ITEM141 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
		}
	}
	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM141 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
		}
	}	
	
	
	// 部門名稱
	var DepName = Form.getValue(&quot;DepName&quot;);	
	if (!&quot;&quot;.equals(DepName)) {
		sSQL += &quot; AND ITEM186= &apos;&quot; + DepName + &quot;&apos;&quot;;
	}
	// 申請人姓名
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM24= &apos;&quot; + MemName + &quot;&apos;&quot;;
	}	
	// 文件編號 item16 是 sn 表單編號不要混到
	var sn= Form.getValue(&quot;Sn&quot;);	
	if (!&quot;&quot;.equals(sn)) {
		sSQL += &quot; AND ITEM122 like &apos;%&quot; + sn + &quot;%&apos;&quot;;
	}
	// 文件標題
	var DocName = Form.getValue(&quot;DocName&quot;);	 
	if (!&quot;&quot;.equals(DocName)) {
		sSQL += &quot; AND ITEM106 like &apos;%&quot; + DocName + &quot;%&apos;&quot;;
	}
	// 文件類別
	var DocTypeName = Form.getValue(&quot;DocTypeName&quot;);	 
	if (!&quot;--&quot;.equals(DocTypeName)) {
		sSQL += &quot; AND ITEM39 like &apos;%&quot; + DocTypeName + &quot;%&apos;&quot;;
	}
	//文件狀態
	var Status = Form.getValue(&quot;Status&quot;);	 
	if (!&quot;全部&quot;.equals(Status)) {
			if (&quot;已結案&quot;.equals(Status)) {
				sSQL += &quot; AND ITEM93 is not null &quot;;
			}else if (&quot;未結案&quot;.equals(Status)){
				sSQL += &quot; AND ITEM93 is null &quot;;
			}				
	}


	
	
	return sSQL;
}
//===============================================================
// 文件申請紀錄 查詢重新載入
//===============================================================
function reloadResultTable(){
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);

	try{
		var conn = Client.createSessionConnection(&quot;EDC&quot;);
		var sql = &quot;SELECT * FROM A_DOCUMENT_APPLY_LIST &quot; +
		&quot; WHERE 1=1  &quot; + getQueryCondition() + &apos; ORDER BY APP_DATE desc&apos;;
		var vec = conn.loadValue(sql);
		Client.setLocalObject(&quot;vec&quot;,vec);
	}catch(e){	}
	if(conn != null)	{
				try	{
					conn.commit();
				}catch(e){
				}
				conn.close();
	}		

	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();	
	var row = 0;
	if(vec != null &amp;&amp; vec.size()&gt;0){
		Form.setValue(&quot;Count&quot;,vec.size()+&quot;&quot;);
		var N = Form.getValue(&quot;N&quot;);
		var T = Math.ceil(vec.size()/N); //無條件進位
		Form.setValue(&quot;T&quot;,&quot;&quot;+T);
		showDCCTable(1);
	}else{
		Form.showMessageDialog(&quot;查無資料!&quot;);
	}
}	
//===================================================================
// 文件申請紀錄分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showDCCTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));			
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;KEY_ID&quot;),     	row, &quot;Key_ID&quot;);
			table.setValueAt(hm.get(&quot;SOURCE&quot;),     	row, &quot;申請目的&quot;);
			table.setValueAt(hm.get(&quot;APP_DATE&quot;),    row, &quot;申請日期&quot;);
			table.setValueAt(hm.get(&quot;APP_NAME&quot;), 	row, &quot;申請者&quot;);
			table.setValueAt(hm.get(&quot;APP_DEP&quot;),  	row, &quot;申請者部門&quot;);
			table.setValueAt(hm.get(&quot;DOC_ID&quot;),   	row, &quot;文件編號&quot;);			
			table.setValueAt(hm.get(&quot;DOC_NAME&quot;),   	row, &quot;文件標題&quot;);
			table.setValueAt(hm.get(&quot;Version&quot;),   	row, &quot;版本&quot;);			
			table.setValueAt(hm.get(&quot;DOC_DEP&quot;),  	row, &quot;文件所屬部門&quot;);
			table.setValueAt(hm.get(&quot;SECURITY&quot;),    row, &quot;安全等級&quot;);
			table.setValueAt(hm.get(&quot;QTY&quot;),     	row, &quot;數量&quot;);
			table.setValueAt(hm.get(&quot;APPLIED_TYPE&quot;),row, &quot;申請型態&quot;);
			table.setValueAt(hm.get(&quot;RETURN&quot;),     	row, &quot;繳回&quot;);
			table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			table.setValueAt(hm.get(&quot;DOC_KEY&quot;),     row, &quot;Doc_Key&quot;);
			table.setValueAt(hm.get(&quot;APP_MemID&quot;),   row, &quot;App_MemID&quot;);
			table.setValueAt(hm.get(&quot;DOC_SOURCE&quot;),   row, &quot;文件來源&quot;);
			
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}


//========================================================================================
// 文件申請紀錄之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			sSQL += &quot; AND APP_DATE &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
		}
	}
	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND APP_DATE &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
		}
	}	
	
	
	// 部門名稱
	var DepName = Form.getValue(&quot;DepName&quot;);	
	if (!&quot;&quot;.equals(DepName)) {
		sSQL += &quot; AND APP_DEP like &apos;%&quot; + DepName + &quot;%&apos;&quot;;
	}
	// 申請人姓名
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND APP_NAME = &apos;&quot; + MemName + &quot;&apos;&quot;;
	}	
	// 文件編號
	var sn= Form.getValue(&quot;Sn&quot;);	
	if (!&quot;&quot;.equals(sn)) {
		sSQL += &quot; AND DOC_ID like &apos;%&quot; + sn + &quot;%&apos;&quot;;
	}
	// 文件標題
	var DocName = Form.getValue(&quot;Doc_Name_Query&quot;);	 
	if (!&quot;&quot;.equals(DocName)) {
		sSQL += &quot; AND DOC_NAME like &apos;%&quot; + DocName + &quot;%&apos;&quot;;
	}
	// 文件所屬部門
	var Doc_Dep = Form.getValue(&quot;Doc_Dep_Query&quot;);	 
	if (!&quot;&quot;.equals(Doc_Dep)) {
		sSQL += &quot; AND DOC_DEP like  &apos;%&quot; + Doc_Dep + &quot;%&apos;&quot;;
	}
	//文件分發
	var Return = Form.getValue(&quot;Return_Query&quot;);	 
	if (!&quot;全部&quot;.equals(Return)) {
		sSQL += &quot; AND RETURN = &apos;&quot; + Return + &quot;&apos;&quot;;
	}
	// 文件來源
	var DocSource = Form.getValue(&quot;Doc_Source_Query&quot;);	 
	if (!&quot;全部&quot;.equals(DocSource)) {
		sSQL += &quot; AND Doc_Source = &apos;&quot; + DocSource + &quot;&apos;&quot;;
	}
	// 申請目的
	var Purpose = Form.getValue(&quot;Purpose&quot;);	 
	if (!&quot;全部&quot;.equals(Purpose)) {
		sSQL += &quot; AND Source = &apos;&quot; + Purpose + &quot;&apos;&quot;;
	}
	return sSQL;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>DMS 相關應用程式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00061208585687703</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/01/18 14:58:40</string> 
     </void> 
     <void property="fullName"> 
      <string>com.eland.dms.Config</string> 
     </void> 
     <void property="id"> 
      <string>SCL00061208585687703</string> 
     </void> 
     <void property="name"> 
      <string>Config</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011203496283609</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//var hostname = &quot;localhost&quot;; 
//var hostname = &quot;mygce&quot;; //GCE 正式機
var hostname = &quot;bpmdbx64dev&quot;; //GCE 測試機
//var hostname = &quot;oadb&quot;; //GCE 
//eland 測試機 172.18.13.15
</string> 
     </void> 
     <void property="synopsis"> 
      <string>設定 ekm hostname </string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00061213176883566</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/06/11 17:34:43</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.Common.Server.Process</string> 
     </void> 
     <void property="id"> 
      <string>SCL00061213176883566</string> 
     </void> 
     <void property="name"> 
      <string>Process</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00251213176848084</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//===================================================
 //金像一般表單編碼方式為 = 廠別(1碼) ＋ 專案代號(2碼) ＋ YY ＋ MM ＋ &apos;-&apos; ＋ XXXXX 
 //ex:TA10803-00001
 //&quot;07&quot;年份 ,&quot;06&quot; 月 , &quot;43&quot; 週 , &quot;00099&quot;流水號。 
 // pro= &quot;A1&quot;表單代碼
 // artid = ART00101173841772296_Ins
 // itemid = ITEM143 (Sn)
 //===================================================
 //Parameters:itemid=表單代碼;pro=表單欄位
function setSn(pro,itemid){
	try{
	   var artIns = MyTask.getArtInstance(); 
	   var dataMap = artIns.getAppDataMap();
	   var cancel = dataMap.get(&quot;Cancel&quot;);
	   var artid = artIns.getArtifactID();  
	   	//抓取使用者相關資料
	   var mID = MyTask.getRealExecutor();
	   var cMember = Server.getMemberByID(mID);	
	   var sCompanyID = cMember.getAreaCode(); //使用者公司代碼	       	   
	   if(&quot;false&quot;.equals(cancel) &amp;&amp; dataMap.get(&quot;Sn&quot;) == &quot;&quot;){
		   var sn = &quot;&quot;;
		   try{
		   	   var year = new java.text.SimpleDateFormat(&quot;y&quot;).format(new java.util.Date()); // 07
			   var month = new java.text.SimpleDateFormat(&quot;M&quot;).format(new java.util.Date()); // 07
		   	   //var week = new java.text.SimpleDateFormat(&quot;w&quot;).format(new java.util.Date()); // 49
				   //week 補0
				   //if(week.length() == 1){
				   //   week = &quot;0&quot; + week;
				   //}	
				   //month 補0
				   if(month.length() == 1){
					   month = &quot;0&quot; + month;
				   }				   
			   //var sn5 = getSubString(sCompanyID,0,1) + pro + year + month ; //TPL0749
			   var sn5 = sCompanyID.substring(0,1) + pro + year + month ;	//TPL0749	   
			   var sn_n = &quot;00001&quot;;			   
			   var sql_sn = &quot; select max(substr(&quot;+itemid+&quot;,-5,5))  MAXNO from &quot;+ artid +&quot;_Ins where &quot;+ itemid + &quot; LIKE &apos;&quot;+ sn5 +&quot;%&apos;&quot;; // oracel
			   var vec_sn = Server.SQLloadValue(sql_sn);
			   if(vec_sn != null &amp;&amp; vec_sn.size()&gt;0 &amp;&amp; vec_sn.get(0).get(&quot;MAXNO&quot;) != &quot;&quot;){
				   var maxno_str = vec_sn.get(0).get(&quot;MAXNO&quot;);
				   var maxno_int = java.lang.Integer.parseInt(maxno_str) + 1;
				   var sn_n = java.lang.Integer.toString(maxno_int);
				   //補0
				   if(sn_n.length() == 1){
					   sn_n = &quot;0000&quot; + sn_n;
				   }else if(sn_n.length() == 2){
					   sn_n = &quot;000&quot; + sn_n;
				   }else if(sn_n.length() == 3){
					   sn_n = &quot;00&quot; + sn_n;
				   }else if(sn_n.length() == 4){
					   sn_n = &quot;0&quot; + sn_n;
				   }				   
			   }
			   var sn = sn5 + &quot;-&quot; + sn_n; //TA10803-00001
			   dataMap.put(&quot;Sn&quot;,sn);
		   }catch(e){}
	   }
	  }catch(e){}
}


function initialProcess(){	
	//抓取文件狀態
	var artState = MyTask.getArtInstance().getArtState().getName();
	var mID = MyTask.getRealExecutor();
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	//if(artState == &quot;初始化&quot; ){
		//initialForm(dataMap);
	//}else if (artState != &quot;主管駁回&quot;){
		//dataMap.put(&quot;VerifyName&quot;,sUserName);
	//}			
		dataMap.put(&quot;Process_ID&quot;,MyTask.getProcessID());
		dataMap.put(&quot;Tsk_Id&quot;,MyTask.getID());	
}





//=========================================
//清除兩張表格內memid相同的紀錄
//=========================================
function clearSameData(Master,Slave){
	var artIns = MyTask.getArtInstance();
	/*
		方法一:利用getAppDataMap()取得表單內所有dataMap資料後,再取得需比較的表格欄位
	*/
	var formDataMap = artIns.getAppDataMap();
	var master = formDataMap.get(Master);// 取得table Master的內容
	var slave = formDataMap.get(Slave);// 取得table Slave的內容
	/*
		方法二:利用資料庫查詢取得表格內容
	*/
	//var artID = artIns.getArtifactID();// 取得表單ID
	//var insID = artIns.getID();// 取得表單的instanceID,通常啟動一個流程會有一個insID
	//var sql = &amp;quot;SELECT * FROM &amp;quot;+artID+&amp;quot;ITEM2 Where INSID=&amp;apos;&amp;quot;+insID+&amp;quot;&amp;apos;&amp;quot;;// 取得table Master的內容
	//var master = Server.SQLloadValue(sql);// 取得table Master的內容
	//sql = &amp;quot;SELECT * FROM &amp;quot;+artID+&amp;quot;ITEM3 Where INSID=&amp;apos;&amp;quot;+insID+&amp;quot;&amp;apos;&amp;quot;;// 取得table Slave的內容
	//var slave = Server.SQLloadValue(sql);// 取得table Slave的內容
	if(master.size()&gt;0&amp;&amp;slave.size()&gt;0){// 只有在兩個table都有值才要做比對
		var newVector = new java.util.Vector();
		for(var i=0;i&lt;slave.size();i++){
			var slaveRowDate = slave.get(i);
			var isR = false;// 以此判斷是否要留Slave的內容
			for(var j=0;j&lt;master.size();j++){			
				var masterRowData = master.get(j);			
				var masterMemid = masterRowData.get(&quot;ITEM1&quot;);
				var slaveMemid = slaveRowDate.get(&quot;ITEM1&quot;);			
				if(masterMemid==slaveMemid||masterMemid.equals(slaveMemid)){// memid相等時,isR=true,代表重複
					//java.lang.System.out.println(&amp;quot;masterMemid=&amp;quot;+masterMemid);
					//java.lang.System.out.println(&amp;quot;slaveMemid=&amp;quot;+slaveMemid);
					isR=true;// 重複
					break;
				}		
			}
			if(!isR){// 不重複就是要留的
				var slaveMemid = slaveRowDate.get(&quot;ITEM1&quot;);
				var slaveCname = slaveRowDate.get(&quot;ITEM2&quot;);
				var newHashMap = new java.util.HashMap();
				newHashMap.put(&quot;ITEM1&quot;,slaveMemid);
				newHashMap.put(&quot;ITEM2&quot;,slaveCname);
				newVector.add(newHashMap);
			}
		}	
		artIns.setAppValue(Slave,newVector);// 設定值回表單上的Slave
		Server.updateArtInstance(artIns);// 表單刷新
	}
}



</string> 
     </void> 
     <void property="synopsis"> 
      <string>金像一般表單編碼方式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00061228293410074</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2017/11/13 09:37:26</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.AppRelated</string> 
     </void> 
     <void property="id"> 
      <string>SCL00061228293410074</string> 
     </void> 
     <void property="name"> 
      <string>AppRelated</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//取得員工為empno及日期為insDate的班別時刻
function getClassTime(insDate,empno){
	var conn = Client.createSessionConnection(&quot;T-MES&quot;);
	var sql = &quot;&quot;;
	var vec = &quot;&quot;;
	try{
		sql =  &quot;SELECT w.wktype, w.classno, w.classbeg, w.classend from empm020 e, empm090 w &quot;;
		sql	+= &quot;where e.wktype = w.wktype and e.classno = w.classno and &quot;;
		sql	+= &quot;e.empno = &apos;&quot; + empno +&quot;&apos;&quot;;		
		vec = conn.loadValue(sql);
		var wktype = &quot;&quot;;//工作類別
		var classno = &quot;&quot;;//班別
		var myDate = new Packages.pase.agenda.MyDate();		
		if(vec.size() &gt; 0){
			var result = vec.get(0);
			wktype = result.get(&quot;wktype&quot;);
			classno = result.get(&quot;classno&quot;);
			Form.setValue(&quot;wktype&quot;,wktype);
		}
		sql  = &quot;select classno from empm300 where empno = &apos;&quot; + empno;
		sql += &quot;&apos; and (chgdaybeg &lt;= date(&apos;&quot; + insDate;
		sql += &quot;&apos;))  AND ( chgdayend &gt;= date(&apos;&quot; + insDate + &quot;&apos;))&quot;;
		vec = conn.loadValue(sql);//調班判斷開始:查詢該日是否調班,是的話則將classno改成調班後的班別
		if(vec.size() &gt; 0){//若有調班,則將資料寫入vec中
			var result = vec.get(0);
			classno = result.get(&quot;classno&quot;); 
		}
		//目前現行之班別設定,皆已採用單一工作型態(即無隔週休,週六上半天之型態),故此處省略工作型態之判別
		sql  = &quot;select * from empm280 where (date_beg &lt;= date(&apos;&quot; + insDate;
		sql += &quot;&apos;)) AND ( date_end &gt;= date(&apos;&quot; + insDate;
		sql += &quot;&apos;)) and wktype=&apos;&quot; + wktype + &quot;&apos; and classno=&apos;&quot; + classno + &quot;&apos;&quot;;
		vec = conn.loadValue(sql);
		var timeList = new java.util.Vector();//上班時段表
		var simpleDateFormat = new Packages.java.text.SimpleDateFormat(&quot;yyyy-MM-dd HH:mm&quot;);
		if(vec.size() &gt; 0){
			var hm = vec.get(0);
			for(var i = 1 ; i &lt; 12 ; i++){
				var wktime = hm.get(&quot;wktime_&quot; + i);
				var wwk = hm.get(&quot;wwk_&quot; + i);
				if(i == 1 &amp;&amp; !(wktime == &quot;&quot; || wktime == null)){//i=1即為上班碼,會緩15分鐘,故要減掉15分鐘,才是正確的上班時間
					var indexHH = wktime.indexOf(&quot;:&quot;);
					var realHH = wktime.substring(indexHH - 2 , indexHH);
					var thisTime = simpleDateFormat.parse(wktime);
					var time = new Packages.pase.agenda.MyDate(thisTime);
					if(wwk == &quot;Y&quot;){//有工作碼才需新增
						thisTime = myDate.addMin(time.toString(),-15);
						time = new Packages.pase.agenda.MyDate(thisTime);
						var hh = time.getCurrentHour();
						var mm = time.getCurrentMinute();
						if(java.lang.Integer.parseInt(realHH) &gt;= 12){
							hh += 12;
						}
						if(hh &lt; 10){
							hh = &quot;0&quot; + hh;
						}
						if(mm &lt; 10){
							mm = &quot;0&quot; + mm;
						}
						timeList.add(hh + &quot;:&quot; + mm);
					}
				}else if(i &gt; 1 &amp;&amp; i &lt; 10 &amp;&amp; !(wktime == &quot;&quot; || wktime == null)){
					var indexHH = wktime.indexOf(&quot;:&quot;);
					var realHH = wktime.substring(indexHH - 2 , indexHH);
					var wwkAdd1 = hm.get(&quot;wwk_&quot; + (i+1));
					var wwkAdd2 = hm.get(&quot;wwk_&quot; + (i+2));					
					var thisTime = simpleDateFormat.parse(wktime);
					var time = new Packages.pase.agenda.MyDate(thisTime);
					if(wwkAdd1 != &quot;Y&quot; &amp;&amp; wwkAdd2 != &quot;Y&quot;){
						thisTime = myDate.addMin(time.toString(),15);
					}
					if(wwk == &quot;Y&quot;){	
						time = new Packages.pase.agenda.MyDate(thisTime);
						var hh = time.getCurrentHour();
						var mm = time.getCurrentMinute();
						if (classno == &quot;B3&quot; &amp;&amp; hh == 0 &amp;&amp; mm == 10){
							realHH = 0;
						}
						if(java.lang.Integer.parseInt(realHH) &gt;= 12 || (classno == &quot;C2&quot; &amp;&amp; hh == 0 &amp;&amp; mm == 0) ){
							hh += 12;
						}
						if(hh &lt; 10){
							hh = &quot;0&quot; + hh;
						}
						if(mm &lt; 10){
							mm = &quot;0&quot; + mm;
						}
						timeList.add(hh + &quot;:&quot; + mm);
					}
				}else if(i==10&amp;&amp;!(wktime==&quot;&quot;||wktime==null)){
					var indexHH = wktime.indexOf(&quot;:&quot;);
					var realHH = wktime.substring(indexHH-2,indexHH);
					var wwkAdd1 = hm.get(&quot;wwk_&quot;+(i+1));
					var thisTime = simpleDateFormat.parse(wktime);
					var time = new Packages.pase.agenda.MyDate(thisTime);
					if(wwkAdd1!=&quot;Y&quot;){
						thisTime = myDate.addMin(time.toString(),15);
					}
					if(wwk==&quot;Y&quot;){
						time = new Packages.pase.agenda.MyDate(thisTime);
						var hh = time.getCurrentHour();
						var mm = time.getCurrentMinute();
						if(java.lang.Integer.parseInt(realHH)&gt;=12){
							hh += 12;
						}
						if(hh&lt;10){
							hh = &quot;0&quot; + hh;
						}
						if(mm&lt;10){
							mm = &quot;0&quot; + mm;
						}
						timeList.add(hh+&quot;:&quot;+mm);
					}
				}else{
					if(wwk==&quot;Y&quot;&amp;&amp;!(wktime==&quot;&quot;||wktime==null)){
						var indexHH = wktime.indexOf(&quot;:&quot;);
						var realHH = wktime.substring(indexHH-2,indexHH);
						var thisTime = simpleDateFormat.parse(wktime);
						var time = new Packages.pase.agenda.MyDate(thisTime);
						thisTime = myDate.addMin(time.toString(),15);
						time = new Packages.pase.agenda.MyDate(thisTime);
						var hh = time.getCurrentHour();
						var mm = time.getCurrentMinute();
						if(java.lang.Integer.parseInt(realHH)&gt;=12){
							hh += 12;
						}
						if(hh&lt;10){
							hh = &quot;0&quot; + hh;
						}
						if(mm&lt;10){
							mm = &quot;0&quot; + mm;
						}
						timeList.add(hh+&quot;:&quot;+mm);
					}
				}
			}
		}
	}catch(e){
		Client.addErrLog(&quot;語法為:&quot;+sql);
	}finally{
		conn.close();
	}
	return timeList;
}

// 檢查此次明細所有假別是否有超過剩餘請假的時間(請確認有沒有用到)
//function checkAllApp(){
//	var tableList = Form.getComponent(&quot;tableList&quot;);
//}

//(請確認有沒有用到)
function getFormatedCurrentTime(){
	var date = new java.util.Date(java.lang.System.currentTimeMillis());
    var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd&quot;);
    return simpledateformat.format(date);
}

// 取得流程簽核人員名單
function getFlow(days){
	var flowList = new java.util.Vector();// 簽核人名單
	var App_MemID = Form.getValue(&quot;App_MemID&quot;);
	var noAgentGroup = Client.getLocalObject(&quot;noAgentGroup&quot;);
	var isNeedAgent = checkIsNeedAgent(Form.getValue(&quot;App_ID&quot;)); //檢查是否需要代理
	var vec;
	var sql = &quot;select * from a_parameter_data where parameter =&apos;HR_FLOW_SPECIAL&apos; and value2=&apos;&quot;+App_MemID+&quot;&apos;&quot;;
	vec = Client.SQLloadValue(sql);
	//特殊簽核流程人員名單中,用等殊簽核流程的來顯示
	if (vec.size() &gt; 0){
		var list = vec.get(0).get(&quot;remarks&quot;);
		//一階為總經理，二階為副董，且請假時數小於等於3小時者，二階不用再簽副董 add by yingchieh@20121005
		if (list.equals(&quot;MEMT1012949;MEMT1012627&quot;) &amp;&amp; Form.getValue(&quot;txtTotal&quot;) &lt;=3 ){
			list = &quot;MEMT1012949&quot;;
		}
		var st = new java.util.StringTokenizer(list,&quot;;&quot;);
		while(st.hasMoreTokens()){
			var memid = st.nextToken();
			var memMap = new java.util.HashMap();
			memMap.put(&quot;ITEM1&quot;,memid);// 放memid
			memMap.put(&quot;ITEM2&quot;,Client.getMember(memid));	 			
			flowList.add(memMap);
		}
	}else{
//		loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
//		var dbName = getDBName();
		var insID  = Form.getArtInstanceID();
		var artIns = Client.getArtInstance(insID);
		var level = &quot;&quot;;
		var App_ID = Form.getValue(&quot;App_ID&quot;);// 請假人ID
		var App_Dep_ID = Form.getValue(&quot;App_Dep_ID&quot;);// 請假人部門
		var dptno = Form.getValue(&quot;App_Dep_ID&quot;);//請假人部門
		var wkgreat = Form.getValue(&quot;wkgreat&quot;);//職級
		if (wkgreat == &quot;0&quot; ||wkgreat.equals(&quot;0&quot;)){//不列等人員判斷,自動改成M職等
			wkgreat = &quot;M&quot;;
		}
		var wktype = Form.getValue(&quot;wktype&quot;);//工作型態
		var isFlushcard = false;// 是不是刷卡處理人員
		var flushcard_verify_level;// 刷卡處理人員的簽核層級
		var LastManager;
		var isError = true;//流程解是否出錯,預設流程有誤
		//1.以請假天數決定簽核層級 2.需依照各工作型態設定每天工時
		if(days &lt; 2){// 請假天數兩天以內,簽核層級為1
			level = &quot;1&quot;;
			var sql = &quot;select flow_1 from empm032 where dptno=&apos;&quot; + dptno + &quot;&apos; and wkgreat=&apos;&quot; + wkgreat + &quot;&apos;&quot;;
			LastManager = getLastManager(sql,&quot;flow_1&quot;);	
			flushcard_verify_level = Client.getRole(Client.getMember(LastManager).getMainRoleID()).getMyID();
		}else if(days &gt;= 2 &amp;&amp; days &lt; 3){// 請假天數2~未滿3天,簽核層級為2
			level = &quot;2&quot;;
			var sql = &quot;select flow_2 from empm032 where dptno=&apos;&quot; + dptno + &quot;&apos; and wkgreat=&apos;&quot; + wkgreat + &quot;&apos;&quot;;
			LastManager = getLastManager(sql,&quot;flow_2&quot;);
			flushcard_verify_level = Client.getRole(Client.getMember(LastManager).getMainRoleID()).getMyID();
		}else{// 3天(含)以上,簽核層級為3
			level = &quot;3&quot;;
			var sql = &quot;select flow_3 from empm032 where dptno=&apos;&quot; + dptno + &quot;&apos; and wkgreat=&apos;&quot; + wkgreat + &quot;&apos;&quot;;
			LastManager = getLastManager(sql,&quot;flow_3&quot;);
			flushcard_verify_level = Client.getRole(Client.getMember(LastManager).getMainRoleID()).getMyID();
		}
	
		var nextMemberID = Form.getValue(&quot;App_MemID&quot;);
		var vice_presidentID = &quot;MEMT1012627&quot;;// 副董事長
		var bigManagerID = &quot;MEMT1012949&quot;;//總經理,直接設定，避免進DB再次讀取資料
//		var bigManagerID = getSpecialVerify();
		var isSpecial = getSpecialProc(App_ID);
//		var isSpecial2 = getSpecialProc2(App_ID);
		var isSpecial3 = getSpecialProc3(App_ID);
		var VPProc = isVPProc(App_ID);//是否為副董直接簽核的流程
		if(VPProc == &quot;true&quot; || VPProc.equals(&quot;true&quot;)){
			var member = Client.getMember(vice_presidentID);
			var memMap = new java.util.HashMap();
			memMap.put(&quot;ITEM1&quot;,vice_presidentID);
			memMap.put(&quot;ITEM2&quot;,member.getName());
			flowList.add(memMap);
		}else{
			if(isSpecial==&quot;true&quot; || isSpecial.equals(&quot;true&quot;) || isSpecial3==&quot;true&quot; || isSpecial3.equals(&quot;true&quot;)){// 特定人員請假時，系統自動於流程最後加簽總經理劉中天，特定人員名單由人力資源部透過管理介面維護	
				LastManager = bigManagerID;
				var member = Client.getMember(nextMemberID);
				nextMemberID = member.getPager();// 取得直屬主管mid
				member = Client.getMember(nextMemberID);  
				while(!(nextMemberID.equals(LastManager))){// 簽核人與最後簽核者是同一個人時		
					var memMap = new java.util.HashMap();
					memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
					memMap.put(&quot;ITEM2&quot;,member.getName());	 			
					flowList.add(memMap);
					nextMemberID = member.getPager();// 取得直屬主管mid
					member = Client.getMember(nextMemberID);
				}
				var memMap = new java.util.HashMap();
				memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
				memMap.put(&quot;ITEM2&quot;,member.getName());	 	
				flowList.add(memMap);
//使用特殊簽核流程來跑
//			}else if (isSpecial2==&quot;true&quot; || isSpecial2.equals(&quot;true&quot;)){
//				LastManager = vice_presidentID;
//				var member = Client.getMember(nextMemberID);
//				nextMemberID = member.getPager();// 取得直屬主管mid
//				member = Client.getMember(nextMemberID);  
//				while(!(nextMemberID.equals(LastManager))){// 簽核人與最後簽核者是同一個人時		
//					var memMap = new java.util.HashMap();
//					memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
//					memMap.put(&quot;ITEM2&quot;,member.getName());	 			
//					flowList.add(memMap);
//					nextMemberID = member.getPager();// 取得直屬主管mid
//					member = Client.getMember(nextMemberID);
//				}
//				var memMap = new java.util.HashMap();
//				memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
//				memMap.put(&quot;ITEM2&quot;,member.getName());	 	
//				flowList.add(memMap);
			}else{
				//刷卡處理人員的簽核方式
				if(isFlushcard){// 刷卡處理人員流程名單設定,根據flushcard_verify_level
					var member = Client.getMember(nextMemberID);// memberRecord
					nextMemberID = member.getPager();// 取得直屬主管mid
					member = Client.getMember(nextMemberID);    
					var roleID = member.getMainRoleID();
					var mbrLv = Client.getRole(roleID).getMyID();// 取得職務等級
					mbrLv = java.lang.Integer.parseInt(mbrLv);		
					while(mbrLv &lt;= flushcard_verify_level){
						var memMap = new java.util.HashMap();
						memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
						memMap.put(&quot;ITEM2&quot;,member.getName());
						flowList.add(memMap);
						nextMemberID = member.getPager();// 取得直屬主管mid
						member = Client.getMember(nextMemberID); 
						roleID = member.getMainRoleID();
						mbrLv = Client.getRole(roleID).getMyID();// 取得職務等級
						mbrLv = java.lang.Integer.parseInt(mbrLv);
					}
				}else{// 刷卡不處理人員流程名單設定,根據LastManager				
					var member = Client.getMember(nextMemberID); 
					//先判斷審核人是不是自己
					if(nextMemberID.equals(LastManager)){// 代表審核人就是自己,系統自動加簽請假人上一階直屬主管。
						nextMemberID = member.getPager();// 取得直屬主管mid
						member = Client.getMember(nextMemberID);
						LastManager = nextMemberID;
					}else{
						nextMemberID = member.getPager();// 取得直屬主管mid
						member = Client.getMember(nextMemberID);
						var count = 0;
						if (Client.getRole(Client.getMember(nextMemberID).getMainRoleID()).getMyID() &gt; Client.getRole(Client.getMember(LastManager).getMainRoleID()).getMyID()){
							LastManager=nextMemberID;
						}
						while(!(nextMemberID.equals(LastManager))){// 簽核人與最後簽核者是同一個人時		
							var memMap = new java.util.HashMap();
							memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
							memMap.put(&quot;ITEM2&quot;,member.getName());	 			
							flowList.add(memMap);
							nextMemberID = member.getPager();// 取得直屬主管mid
							member = Client.getMember(nextMemberID);
							count++;
							if(count&gt;10){
								break;
							}
							if(nextMemberID==&quot;MEMT1001296&quot;){// add by edison@20111104 避免(部門請假簽核設定檔維護)設定錯誤,會出現異常
								break;
							}
						}
					}
					var memMap = new java.util.HashMap();
					memMap.put(&quot;ITEM1&quot;,nextMemberID);// 放memid
					memMap.put(&quot;ITEM2&quot;,member.getName());	 	
					flowList.add(memMap);
					for(var i = 0 ; i &lt; flowList.size();i++){
						if(flowList.get(i).get(&quot;ITEM1&quot;).equals(LastManager)){
							isError = false;//false=流程無誤  true=流程錯誤
						}
					}
					if(isError!=false){
						sendFlowErrorMail(flowList,LastManager);
						flowList = &quot;&quot;;
					}
				}
			}
		}
	}
	return flowList;// 回傳簽核人員清單
}

function getLastManager(sql,flow){// 設定最後一位簽核人
	try{
		loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
		var conn = Client.createSessionConnection(&quot;T-MES&quot;);
		var vec	= conn.loadValue(sql);
		var result = vec.get(0);
		var LastManager	= result.get(flow);
		//需完整工號
		if(LastManager.substring(0,1).equals(&quot;0&quot;)){
			LastManager = &quot;MEMT1&quot; + LastManager;
		}else if(LastManager.substring(0,1).equals(&quot;S&quot;)){
			LastManager = &quot;MEMS10&quot; + LastManager.substring(1,6);
		}else if(LastManager.substring(0,1).equals(&quot;C&quot;)){
			LastManager = &quot;MEMC10&quot; + LastManager.substring(1,6);
		}else if(LastManager.substring(0,1).equals(&quot;H&quot;)){
			LastManager = &quot;MEMH10&quot; + LastManager.substring(1,6);
		}		
		return LastManager;
	}catch(e){
		java.lang.System.out.println(e);
	}finally{
		conn.close();
	}
}
// 取得特定流程簽核人id
//此function 建議取消，因為故定取總經理的MEMID       add by yingchieh@20121001
function getSpecialVerify(){
	var sql = &quot;select ITEM56 from ART00311223536033565_INS&quot;;
	var vec = Client.SQLloadValue(sql);
	var id = &quot;&quot;;
	if(vec.size() &gt; 0){
		var result = vec.get(0);
		id = result.get(&quot;ITEM56&quot;);
		id = &quot;MEMT1&quot; + id;
	}
	return id;
}

//是否為副董直接簽核人員
function isVPProc(App_ID){
	var sql = &quot;select ITEM66 from ART00311223536033565_INS where ITEM66 like &apos;%&quot; + App_ID + &quot;%&apos;&quot;;
	var vec = Client.SQLloadValue(sql);
	var VPProc = &quot;false&quot;;
	if(vec.size() &gt; 0){
		VPProc = &quot;true&quot;;
	}
	return VPProc;
}

//是否為特殊人員,最後一關加總經理
//總經理目前只簽一階主?。故此項已不再用  add by yingchieh@20121001
function getSpecialProc(App_ID){ 
	var sql = &quot;select ITEM52 from ART00311223536033565_INS where ITEM52 like &apos;%&quot; + App_ID + &quot;%&apos;&quot;;
	var vec = Client.SQLloadValue(sql);
	var isSpecial = &quot;false&quot;;
	if(vec.size() &gt; 0){
		isSpecial = &quot;true&quot;;
	}
	return isSpecial;
}

//是否為特殊人員,最後一關加總經理(bryan專用)
//此項已移入特殊簽核流程設定 add by yingchieh@20121001
function getSpecialProc2(App_ID){ 
	var isSpecial2 = &quot;false&quot;;
	if(App_ID == &quot;001296&quot; || App_ID.equals(&quot;001296&quot;)){
		isSpecial2 = &quot;true&quot;;
	}
	return isSpecial2;
}

//是否為特殊人員,最後一關加總經理
function getSpecialProc3(App_ID){
//	var sql = &quot;SELECT * FROM mem_geninf WHERE ( pager IN (SELECT memid FROM mem_geninf WHERE pager = &apos;MEMT1012949&apos;)) AND resign = &apos;false&apos; and ( joblevel like &apos;M10%&apos; or joblevel like &apos;M11%&apos; or joblevel like &apos;M12%&apos; or joblevel like &apos;0不列等%&apos;) and memid =&apos;MEMT1&quot;+App_ID+&quot;&apos;&quot;;
//	var vec = Client.SQLloadValue(sql);
//	var isSpecial3=&quot;false&quot;;
//	if(vec.size()&gt;0){
//		isSpecial3=&quot;true&quot;;
//	}
//	return isSpecial3;
	//取消二階副理級以上簽至總經理的功能  add by yingchieh@20121001
	return &quot;false&quot;;
}

// 更新申請人資訊
function updateAppInfo(empno){
	mID = &quot;MEMT1&quot; + empno;
	try{
		//抓取文件狀態
		var cMember = Client.getMemberByID(mID);
		var sUserName = cMember.getName();	//使用者姓名
		//判斷下一關主管用，被駁回時也要 update
		var roleID = cMember.getMainRoleID();
		//抓取使用者相關資料
		var memDR = cMember.getMemberDR(roleID);
		var sDepName = memDR.getDepartmentName();	//使用者部門名稱
		var sDepID = Client.getDepartment(memDR.getDepartmentID()).getMyID();
		var sRoleName = memDR.getRoleName();	//使用者職務名稱
		var sCompanyID = cMember.getAreaCode(); //使用者公司代碼//設定填表人姓名、員工編號...		
		var Manager_ID = &quot;Administrator&quot;;
		if(cMember != null){
			Manager_ID = cMember.getPager();
		}
		Form.setValue(&quot;Next_Member_ID&quot;,Manager_ID);
		Form.setValue(&quot;Manager_ID&quot;,Manager_ID);
		Form.setValue(&quot;App_Name&quot;,sUserName);
		Form.setValue(&quot;App_MemID&quot;,mID);
		Form.setValue(&quot;App_ID&quot;,cMember.getMyID());
		Form.setValue(&quot;App_Title&quot;,cMember.getJobTitle());
		Form.setValue(&quot;App_Tel&quot;,cMember.getOfficePhone());
		Form.setValue(&quot;App_Dep&quot;,sDepName);
		Form.setValue(&quot;App_Dep_ID&quot;,sDepID);		
		Form.setValue(&quot;App_DepID&quot;,memDR.getDepartmentID());//&quot;DEPxxx&quot;	
		Form.setValue(&quot;Factory&quot;,&quot;(&quot; + sCompanyID + &quot;)&quot;);//廠別
		Form.setValue(&quot;From_User_ID&quot;,mID);
		Form.setValue(&quot;From_User_Role_ID&quot;,roleID);		
		Form.setValue(&quot;App_User_Role_ID&quot;,roleID);
		Form.setValue(&quot;Next_Member_Role&quot;,&quot;&quot;); 			
	}catch(e){
		var App_MemID = Form.getValue(&quot;App_MemID&quot;);
		var member = Client.getMember(App_MemID);
		var myID = member.getMyID();
		Form.setValue(&quot;App_ID&quot;,myID);// 設回前一個ID
		Form.showMessageDialog(&quot;您輸入了無效的員工編號&quot;);
	}
}

//寄流程解析錯誤mail
//新增警示視窗加入錯的流程，供填單人參考
function sendFlowErrorMail(flowList,LastManager){
	var flowMsg = &quot;&quot;;
	var flowMsg_2 = &quot;&quot;;
	var noAgentGroup = Client.getLocalObject(&quot;noAgentGroup&quot;);
	var App_ID = Form.getValue(&quot;App_ID&quot;);
	var App_Dep_ID = Form.getValue(&quot;App_Dep_ID&quot;);
	var App_Name = Form.getValue(&quot;App_Name&quot;);
	var isNeedAgent = true;
	for(var i=0;i&lt;noAgentGroup.size();i++){// 這些人員不需代理人簽核	
		var empno = noAgentGroup.get(i);
		if(App_ID.equals(empno)){
			isNeedAgent = false;
			break;
		}
	}
	if(isNeedAgent){// 需要代理人
		var hm = new java.util.HashMap();
		hm.put(&quot;ITEM2&quot;,&quot;代理人&quot;);
		flowList.insertElementAt(hm,0);
	}
	for(var i=0;i&lt;flowList.size();i++){
		var data = flowList.get(i);
		var cname = data.get(&quot;ITEM2&quot;);
		flowMsg = flowMsg + &quot;第&quot;+(i+1)+&quot;關：&quot;+cname+&quot;&lt;br&gt;&quot;;
		flowMsg_2 = flowMsg_2 + &quot;第&quot;+(i+1)+&quot;關：&quot;+cname+&quot;\n&quot;; //警示視窗用
	}
	var mailFrom = &quot;hr@gce.com.tw&quot;;//寄
	var mailto   = &quot;yingchieh_wang@gce.com.tw;regina_ke@gce.com.tw&quot;;//收
	var content  = App_Dep_ID + &quot;-&quot; + App_Name + &quot;(&quot; + App_ID + &quot;)的簽核流程有誤,請檢查!!&lt;br&gt;&quot;;
		content += &quot;簽核流程：&lt;br&gt;&quot;;
		content += flowMsg;
		content += &quot;&lt;br&gt;&quot;;
		content += &quot;最後一關簽核者：&quot; + Client.getMember(LastManager);
	var subject  = App_Dep_ID + &quot;-&quot; + App_Name + &quot;(&quot; + App_ID + &quot;)的簽核流程有誤,請檢查!!&quot;;
    var vector = new java.util.Vector();
	var task =  Form.getCurrentTask();
	Client.sendHTMLMailExt(mailFrom,mailto,&quot;&quot;,subject,content,vector,task.getID());
	Form.showMessageDialog(&quot;您的請假單將無法送出！\n簽核流程有誤，已通知人資單位，並請聯繫單位書記處理，謝謝！\n錯誤流程如下：\n&quot; + flowMsg_2+&quot;\n最後一關簽核者：&quot;+ Client.getMember(LastManager));
}

function getAnnualMap(empno,thisDay){	
	var msg;
	var QUOTA = 0;
	var apply_oldsum = 0;
	var conn = Client.createSessionConnection(&quot;T-MES&quot;);
	var sql = &quot;&quot;;
	var vec = &quot;&quot;;
	try{
sql += &quot;select  dptno ,empno,cname,enterworkday,enterworkday_a,close_amt_new,i_up_2017_new,i_up_2018_new,day1_b,day1,day2_b,day2, &quot;;
sql += &quot;close_amt,i_up_2017,i_up_2018,type,a_timecnt,b_timecnt,c_timecnt,timecnt_a,timecnt_b,timecnt_c,timecnt_d,close_amt_remain,timecnt_p1_use,timecnt_p2_use, &quot;;
sql += &quot;0 as timecnt_1_remain,0 as timecnt_2_remain,i_use_2017,i_2017_use_close_amt,i_2017_use_2018, &quot;;
sql += &quot;case when type=&apos;A&apos; or type =&apos;B&apos;  or type =&apos;C&apos;  or type = &apos;D&apos; then &quot;;
sql += &quot;	case when close_amt_new - i_2017_use_close_amt &gt;= 0 then &quot;;
sql += &quot;		case when (close_amt_new - i_2017_use_close_amt) &gt;= (	i_use_2018- i_2017_use_2018) then &quot;;
sql += &quot;				i_use_2018- i_2017_use_2018+i_2017_use_close_amt &quot;;
sql += &quot;		else &quot;;
sql += &quot;				close_amt_new &quot;;
sql += &quot;		end &quot;;
sql += &quot;	else &quot;;
sql += &quot;		0 &quot;;
sql += &quot;	end &quot;;
sql += &quot;else &quot;;
sql += &quot;	i_2017_use_close_amt  &quot;;
sql += &quot;end as i_use_2016, &quot;;
sql += &quot;case when type=&apos;A&apos; or type=&apos;B&apos; or type =&apos;C&apos; or type=&apos;D&apos; then &quot;;
sql += &quot;	case when close_amt_new - i_2017_use_close_amt &gt; 0 then &quot;;
sql += &quot;		case when (close_amt_new - i_2017_use_close_amt) &gt;= (	i_use_2018- i_2017_use_2018) then &quot;;
sql += &quot;			i_use_2018- i_2017_use_2018 - (i_use_2018- i_2017_use_2018) &quot;;
sql += &quot;		else &quot;;
sql += &quot;			(i_use_2018- i_2017_use_2018) -   (close_amt_new - i_2017_use_close_amt) &quot;;
sql += &quot;		end &quot;;
sql += &quot;	else &quot;;
sql += &quot;		i_use_2018- i_2017_use_2018 &quot;;
sql += &quot;	end &quot;;
sql += &quot;else &quot;;
sql += &quot;	i_use_2018- i_2017_use_2018  &quot;;
sql += &quot;end as i_use_2018, &quot;;
sql += &quot;case when type=&apos;A&apos; or type=&apos;B&apos; or type =&apos;C&apos; or type=&apos;D&apos; then &quot;;
sql += &quot;	case when close_amt_new - i_2017_use_close_amt &gt; 0 then &quot;;
sql += &quot;		case when 	i_use_2018- i_2017_use_2018 &gt; 0 then &quot;;
sql += &quot;			case when (close_amt_new - i_2017_use_close_amt) &gt;= (	i_use_2018- i_2017_use_2018)  then &quot;;
sql += &quot;					i_use_2018 - i_2017_use_2018 &quot;;
sql += &quot;			else &quot;;
sql += &quot;					close_amt_new - i_2017_use_close_amt &quot;;
sql += &quot;			end &quot;;
sql += &quot;		else &quot;;
sql += &quot;			0 &quot;;
sql += &quot;		end &quot;;
sql += &quot;	else &quot;;
sql += &quot;		0 &quot;;
sql += &quot;	end &quot;;
sql += &quot;else &quot;;
sql += &quot;	0 &quot;;
sql += &quot;end as i_2018_use_close_amt &quot;;
sql += &quot;from ( &quot;;
sql += &quot;select dptno ,empno,cname,enterworkday,enterworkday_a,close_amt_new,i_up_2017_new,i_up_2018_new,day1_b,day1,day2_b,day2, &quot;;
sql += &quot;close_amt,i_up_2017,i_up_2018,type,a_timecnt,b_timecnt,c_timecnt,timecnt_a,timecnt_b,timecnt_c,timecnt_d,i_use_2016,close_amt_remain, &quot;;
sql += &quot;0 as timecnt_1_remain,0 as timecnt_2_remain,timecnt_p1_use,timecnt_p2_use, &quot;;
sql += &quot;i_use_2016, i_use_2018, &quot;;
sql += &quot;case when type= &apos;A&apos; then   &quot;;
sql += &quot;	case when i_up_2017_new - i_use_2017 &gt;= 0 then &quot;;
sql += &quot;		case when timecnt_b &gt; i_up_2017_new - i_use_2017 then &quot;;
sql += &quot;			i_use_2017 +  (i_up_2017_new - i_use_2017) &quot;;
sql += &quot;		else &quot;;
sql += &quot;			i_use_2017+ timecnt_b &quot;;
sql += &quot;		end &quot;;
sql += &quot;	else &quot;;
sql += &quot;		case when   (i_up_2017_new - i_use_2017) + close_amt_new &gt;= 0 then &quot;;
sql += &quot;			i_up_2017_new &quot;;
sql += &quot;		else			 &quot;;
sql += &quot;			i_use_2017 - close_amt_new&quot;;
sql += &quot;		end &quot;;
sql += &quot;	end &quot;;
sql += &quot;when type= &apos;B&apos; or type= &apos;C&apos;  or type =&apos;D&apos;    then  &quot;;
sql += &quot;	case when i_up_2017_new - i_use_2017 &gt;= 0 then &quot;;
sql += &quot;		i_use_2017 &quot;;
sql += &quot;	else &quot;;
sql += &quot;		case when   (i_up_2017_new - i_use_2017) + close_amt_new &gt;= 0 then &quot;;
sql += &quot;			i_up_2017_new &quot;;
sql += &quot;		else &quot;;
sql += &quot;			i_use_2017 -  close_amt_new &quot;;
sql += &quot;		end &quot;;
sql += &quot;	end	 &quot;;
sql += &quot;when  type =&apos;E&apos; then  &quot;;
sql += &quot;	case when close_amt_new &gt; 0 then &quot;;
sql += &quot;		case when i_use_2017 &lt;= close_amt_new then &quot;;
sql += &quot;			0 &quot;;
sql += &quot;		else &quot;;
sql += &quot;			i_use_2017 - close_amt_new &quot;;
sql += &quot;		end &quot;;
sql += &quot;	else &quot;;
sql += &quot;		i_use_2017 &quot;;
sql += &quot;	end &quot;;
sql += &quot;when type= &apos;F&apos; then i_use_2017 &quot;;
sql += &quot;when type= &apos;G&apos; then i_use_2017 &quot;;
sql += &quot;end as i_use_2017, &quot;;
sql += &quot;case when type =&apos;A&apos; then &quot;;
sql += &quot;	case when i_up_2017_new - i_use_2017 &gt;= 0 then &quot;;
sql += &quot;		case when timecnt_b &gt; i_up_2017_new - i_use_2017 then &quot;;
sql += &quot;		  i_up_2017_new - i_use_2017 &quot;;
sql += &quot;		else &quot;;
sql += &quot;			timecnt_b &quot;;
sql += &quot;		end &quot;;
sql += &quot;	else &quot;;
sql += &quot;		0 &quot;;
sql += &quot;	end &quot;;
sql += &quot;else 0 end as i_2017_use_2018, &quot;;
sql += &quot;case when type= &apos;A&apos;  or type  = &apos;B&apos; or type= &apos;C&apos; or type = &apos;D&apos; then   &quot;;
sql += &quot;	case when i_up_2017_new - i_use_2017 &gt;= 0 then &quot;;
sql += &quot;		0 &quot;;
sql += &quot;	else &quot;;
sql += &quot;		case when close_amt_new + (i_up_2017_new - i_use_2017) &lt;= 0 then &quot;;
sql += &quot;			close_amt_new &quot;;
sql += &quot;		else &quot;;
sql += &quot;			-(i_up_2017_new - i_use_2017) &quot;;
sql += &quot;		end &quot;;
sql += &quot;	end &quot;;
sql += &quot;when  type =&apos;E&apos; then  &quot;;
sql += &quot;	case when close_amt_new &gt; 0 then &quot;;
sql += &quot;		case when i_use_2017 &lt;= close_amt_new then &quot;;
sql += &quot;			i_use_2017  &quot;;
sql += &quot;		else &quot;;
sql += &quot;			close_amt_new &quot;;
sql += &quot;		end &quot;;
sql += &quot;	else &quot;;
sql += &quot;		0 &quot;;
sql += &quot;	end &quot;;
sql += &quot;when type= &apos;F&apos; then 0 &quot;;
sql += &quot;when type= &apos;G&apos; then 0 &quot;;
sql += &quot;end as i_2017_use_close_amt &quot;;
sql += &quot;from  ( &quot;;
sql += &quot;select dptno,empno,cname,enterworkday,	enterworkday_a,close_amt_new,timecnt_1_new as i_up_2017_new , timecnt_2_new as i_up_2018_new, &quot;;
sql += &quot;date_beg_1 as day1_b,date_end_1 as day1,date_beg_2 as day2_b,date_end_2 as day2,close_amt ,0 as i_up_2017,0 as i_up_2018,type,timecnt_p1_use,timecnt_p2_use, &quot;;
sql += &quot;0    as i_use_2016, &quot;;
sql += &quot; timecnt_p1_use    as i_use_2017, &quot;;
sql += &quot;timecnt_p2_use as i_use_2018, &quot;;
sql += &quot;0 as close_amt_remain,0 as timecnt_1_remain,0 as timecnt_2_remain, 0 as a_timecnt,0 as b_timecnt,0 as c_timecnt, &quot;;
sql += &quot;timecnt_a,timecnt_b,timecnt_c,timecnt_d &quot;;
sql += &quot;from (select *, &quot;;
sql += &quot;		case when type =&apos;A&apos; or type = &apos;B&apos; or type = &apos;G&apos; then timecnt_a  &quot;;
sql += &quot;				when type=&apos;C&apos; or type =&apos;D&apos;  or type =&apos;F&apos; then timecnt_a + timecnt_b  &quot;;
sql += &quot;				when type=&apos;E&apos;   then timecnt_a + timecnt_b + timecnt_c &quot;;
sql += &quot;				end as timecnt_p1_use, &quot;;
sql += &quot;		case when type =&apos;A&apos;  then timecnt_b+timecnt_c+timecnt_d &quot;;
sql += &quot;				when type=&apos;B&apos;  then timecnt_b + timecnt_c &quot;;
sql += &quot;				when type=&apos;C&apos;  then timecnt_c + timecnt_d &quot;;
sql += &quot;				when type=&apos;D&apos; or type =&apos;F&apos;  then timecnt_c &quot;;
sql += &quot;				when type=&apos;E&apos;  then timecnt_d &quot;;
sql += &quot;				when type=&apos;G&apos;  then timecnt_b &quot;;
sql += &quot;				end as timecnt_p2_use &quot;;
sql += &quot;from (select *, &quot;;
sql += &quot;		(select nvl(sum(timecnt),0) from empm060 where abstype=&apos;I&apos; and absdate &gt;= date_a_beg and absdate&lt;= date_a_end and empno= x3.empno) as timecnt_a, &quot;;
sql += &quot;		(select nvl(sum(timecnt),0) from empm060 where abstype=&apos;I&apos; and absdate &gt;= date_b_beg and absdate&lt;= date_b_end and empno= x3.empno) as timecnt_b, &quot;;
sql += &quot;		case when type=&apos;A&apos; or type=&apos;B&apos; or type=&apos;C&apos; or type=&apos;D&apos; or type=&apos;E&apos; or type=&apos;F&apos; then &quot;;
sql += &quot;			(select nvl(sum(timecnt),0) from empm060 where abstype=&apos;I&apos; and absdate &gt;= date_c_beg and absdate&lt;= date_c_end and empno= x3.empno) &quot;;
sql += &quot;				else 0 end as timecnt_c, &quot;;
sql += &quot;		case when type=&apos;A&apos; or type = &apos;C&apos; or type=&apos;E&apos;  then &quot;;
sql += &quot;			(select nvl(sum(timecnt),0) from empm060 where abstype=&apos;I&apos; and absdate &gt;= date_d_beg and absdate&lt;= date_d_end and empno= x3.empno) &quot;;
sql += &quot;				else 0 end as timecnt_d &quot;;
sql += &quot;from (select *, &quot;;
sql += &quot;	case when type = &apos;A&apos; or type = &apos;B&apos; or type=&apos;C&apos; or type = &apos;D&apos; Then to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;)  &quot;;
sql += &quot;			when type=&apos;E&apos; or type =&apos;F&apos; or type =&apos;G&apos; then to_date(to_char(date_beg_1,&apos;%Y-%m-%d&apos;),&apos;%Y-%m-%d&apos;) end as date_a_beg, &quot;;
sql += &quot;	case when type = &apos;A&apos;  or type = &apos;G&apos; then to_date(to_char(date_end_1,&apos;%Y-%m-%d&apos;),&apos;%Y-%m-%d&apos;)  &quot;;
sql += &quot;		   when type = &apos;B&apos; or type= &apos;C&apos; or type= &apos;D&apos; or type=&apos;E&apos; then to_date(&apos;2017-3-31&apos; ,&apos;%Y-%m-%d&apos;)  &quot;;
sql += &quot;			when  type = &apos;F&apos; then to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;) end as date_a_end, &quot;;
sql += &quot;	case when type = &apos;A&apos; or type =&apos;G&apos; then to_date(to_char(date_beg_2,&apos;%Y-%m-%d&apos;),&apos;%Y-%m-%d&apos;)  &quot;;
sql += &quot;           when type = &apos;B&apos; or type =&apos;C&apos; or type =&apos;D&apos; or type =&apos;E&apos;  then to_date(&apos;2017-4-1&apos; ,&apos;%Y-%m-%d&apos;) &quot;;
sql += &quot;		   when type = &apos;F&apos; then to_date(&apos;2017-7-1&apos; ,&apos;%Y-%m-%d&apos;) end as date_b_beg, &quot;;
sql += &quot;	case when type = &apos;A&apos; then to_date(&apos;2017-3-31&apos; ,&apos;%Y-%m-%d&apos;) &quot;;
sql += &quot;			when type = &apos;B&apos; or type =&apos;D&apos; or type =&apos;E&apos; then to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;) &quot;;
sql += &quot;			when type = &apos;C&apos; or type = &apos;F&apos; or type =&apos;G&apos; then to_date(to_char(date_end_1,&apos;%Y-%m-%d&apos;),&apos;%Y-%m-%d&apos;) end as date_b_end, &quot;;
sql += &quot;	case when type = &apos;A&apos; then  to_date(&apos;2017-4-1&apos; ,&apos;%Y-%m-%d&apos;)  &quot;;
sql += &quot;			when type = &apos;B&apos; or type = &apos;D&apos; or type = &apos;E&apos; then  to_date(&apos;2017-7-1&apos; ,&apos;%Y-%m-%d&apos;)  &quot;;
sql += &quot;			when type = &apos;C&apos; or type = &apos;F&apos; then  to_date(to_char(date_beg_2,&apos;%Y-%m-%d&apos;),&apos;%Y-%m-%d&apos;) end as date_c_beg, &quot;;
sql += &quot;	case when type = &apos;A&apos; or type =&apos;C&apos;  then to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;)  &quot;;
sql += &quot;		   when type = &apos;B&apos; or type = &apos;D&apos; then to_date(to_char(date_end_2,&apos;%Y-%m-%d&apos;),&apos;%Y-%m-%d&apos;) &quot;;
sql += &quot;			when type = &apos;E&apos; then to_date(to_char(date_end_1,&apos;%Y-%m-%d&apos;),&apos;%Y-%m-%d&apos;)  &quot;;
sql += &quot;			when type = &apos;F&apos; then to_date(to_char(date_end_2,&apos;%Y-%m-%d&apos;),&apos;%Y-%m-%d&apos;) end as date_c_end, &quot;;
sql += &quot;	case when type = &apos;A&apos; or type = &apos;C&apos; then to_date(&apos;2017-7-1&apos; ,&apos;%Y-%m-%d&apos;)   &quot;;
sql += &quot;			when type = &apos;E&apos; then to_date(to_char(date_beg_2,&apos;%Y-%m-%d&apos;),&apos;%Y-%m-%d&apos;) end as date_d_beg, &quot;;
sql += &quot;	case when type = &apos;A&apos; or type = &apos;C&apos; or type =&apos;E&apos; then to_date(to_char(date_end_2,&apos;%Y-%m-%d&apos;),&apos;%Y-%m-%d&apos;) end date_d_end &quot;;
sql += &quot;from (select *, &quot;;
sql += &quot;		case when close_amt &lt; 0 then 0 else close_amt end close_amt_new, &quot;;
sql += &quot;        case when close_amt &lt; 0 and close_amt + timecnt_1 &gt;= 0 then  close_amt+timecnt_1  &quot;;
sql += &quot;				when close_amt &lt; 0 and close_amt + timecnt_1 &lt; 0 then  0 &quot;;
sql += &quot;				else timecnt_1 end  as timecnt_1_new, &quot;;
sql += &quot;		case when close_amt &lt; 0 and close_amt + timecnt_1 &gt;= 0 then  timecnt_2 &quot;;
sql += &quot;			   when close_amt &lt; 0 and close_amt + timecnt_1 &lt; 0 then  close_amt+timecnt_1 + timecnt_2 &quot;;
sql += &quot;			   else timecnt_2 end as timecnt_2_new, &quot;;
sql += &quot;		case when date_end_1 &lt;= to_date(&apos;2017-3-30&apos; ,&apos;%Y-%m-%d&apos;) then &apos;A&apos; &quot;;
sql += &quot;				when date_end_1 = to_date(&apos;2017-3-31&apos; ,&apos;%Y-%m-%d&apos;) then	&apos;B&apos; &quot;;
sql += &quot;				when date_end_1 &gt;= to_date(&apos;2017-4-1&apos; ,&apos;%Y-%m-%d&apos;) and date_end_1 &lt; to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;)  then &apos;C&apos; &quot;;
sql += &quot;				when date_end_1 = to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;) then &apos;D&apos; &quot;;
sql += &quot;				when date_end_1 &gt;= to_date(&apos;2017-7-1&apos; ,&apos;%Y-%m-%d&apos;)  then &quot;;
sql += &quot;					case when date_beg_1 &lt;= to_date(&apos;2017-3-31&apos; ,&apos;%Y-%m-%d&apos;) then &apos;E&apos; &quot;;
sql += &quot;						   when date_beg_1 &gt;= to_date(&apos;2017-4-1&apos; ,&apos;%Y-%m-%d&apos;) and date_beg_1 &lt;= to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;) then &apos;F&apos; &quot;;
sql += &quot;					       else &apos;G&apos; end &quot;;
sql += &quot;				end as type &quot;;
sql += &quot;from(select case when dptno=&apos;2L1&apos; then dptno1 else dptno end as dptno,empno,cname,enterworkday,directcode, &quot;;
sql += &quot;		(date(enterworkday) + nvl((select sum(date(reworkday) - date(applyday)  + 1)  &quot;;
sql += &quot;											   from empm130 where empno=empm020.empno   &quot;;
sql += &quot;											  and applyday &gt; empm020.enterworkday ),0) units day ) as enterworkday_a, &quot;;
sql += &quot;	(select date_beg from (select (select count(*) from empm031 as t  &quot;;
sql += &quot;	where t.date_beg &lt; empm031.date_beg and empno=empm031.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and t.abstype=&apos;I&apos; ) + 1 as rownum,* &quot;;
sql += &quot;	from empm031 where empno=empm020.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and abstype=&apos;I&apos; ) where rownum=1) as date_beg_1, &quot;;
sql += &quot;	(select date_end from (select (select count(*) from empm031 as t  &quot;;
sql += &quot;	where t.date_beg &lt; empm031.date_beg and empno=empm031.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and t.abstype=&apos;I&apos;) + 1 as rownum,* &quot;;
sql += &quot;	from empm031 where empno=empm020.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and abstype=&apos;I&apos;) where rownum=1) as date_end_1, &quot;;
sql += &quot;	(select timecnt from (select (select count(*) from empm031 as t &quot;;
sql += &quot;	where t.date_beg &lt; empm031.date_beg and empno=empm031.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and t.abstype=&apos;I&apos;) + 1 as rownum,* &quot;;
sql += &quot;	from empm031 where empno=empm020.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and abstype=&apos;I&apos; ) where rownum=1) as timecnt_1, &quot;;
sql += &quot;	(select date_beg from (select (select count(*) from empm031 as t  &quot;;
sql += &quot;	where t.date_beg &lt; empm031.date_beg and empno=empm031.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and t.abstype=&apos;I&apos;) + 1 as rownum,* &quot;;
sql += &quot;	from empm031 where empno=empm020.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and abstype=&apos;I&apos; ) where rownum=2) as date_beg_2, &quot;;
sql += &quot;	(select date_end from (select (select count(*) from empm031 as t &quot;;
sql += &quot;	where t.date_beg &lt; empm031.date_beg and empno=empm031.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and t.abstype=&apos;I&apos;) + 1 as rownum,* &quot;;
sql += &quot;	from empm031 where empno=empm020.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and abstype=&apos;I&apos; ) where rownum=2) as date_end_2, &quot;;
sql += &quot;	(select timecnt from (select (select count(*) from empm031 as t &quot;;
sql += &quot;	where t.date_beg &lt; empm031.date_beg and empno=empm031.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and t.abstype=&apos;I&apos;) + 1 as rownum,* &quot;;
sql += &quot;	from empm031 where empno=empm020.empno and date_beg &gt;= to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) and abstype=&apos;I&apos; ) where rownum=2) as timecnt_2, &quot;;
sql += &quot;	(nvl((select close_amt from paym140 where empno = empm020.empno and abstype=&apos;I&apos; and salarytimes = &apos;2016122&apos;),0)) as close_amt &quot;;
sql += &quot;from empm020 where empno = &apos;&quot;+empno+&quot;&apos; &quot;;
sql += &quot;) AS X1) as X2) as X3) as X4 )as X5 ) as X6 ) as X7 &quot;;
sql += &quot;; &quot;;
		vec = conn.loadValue(sql);
		if(vec.size() &gt; 0){
			var result = vec.get(0);
			day1_b = (result.get(&quot;day1_b&quot;)+&quot;&quot;).substring(0,10).replace(&quot;-&quot;,&quot;/&quot;).replace(&quot;-&quot;,&quot;/&quot;);
			day1 = (result.get(&quot;day1&quot;)+&quot;&quot;).substring(0,10).replace(&quot;-&quot;,&quot;/&quot;).replace(&quot;-&quot;,&quot;/&quot;);
			day2_b = (result.get(&quot;day2_b&quot;)+&quot;&quot;).substring(0,10).replace(&quot;-&quot;,&quot;/&quot;).replace(&quot;-&quot;,&quot;/&quot;);
			day2 = (result.get(&quot;day2&quot;)+&quot;&quot;).substring(0,10).replace(&quot;-&quot;,&quot;/&quot;).replace(&quot;-&quot;,&quot;/&quot;);
			close_amt_new = result.get(&quot;close_amt_new&quot;);
			i_up_2017_new = result.get(&quot;i_up_2017_new&quot;);
			i_up_2018_new = result.get(&quot;i_up_2018_new&quot;);
			i_use_2016 = result.get(&quot;i_use_2016&quot;);
			i_use_2017 = result.get(&quot;i_use_2017&quot;);
			i_use_2018 = result.get(&quot;i_use_2018&quot;);
			Client.addDebugLog(&quot;day1=&quot;+day1+&quot;,thisday=&quot;+thisDay);
			if (thisDay &gt;= day2_b &amp;&amp; thisDay &lt;= day2){
				QUOTA = i_up_2018_new * 1 + close_amt_new*1;
				apply_oldsum = i_use_2018 *1 + i_use_2016 * 1;
			}else if (thisDay &gt;= day1_b &amp;&amp; thisDay &lt;= day1){
				QUOTA = i_up_2017_new * 1  + close_amt_new * 1;
				apply_oldsum = i_use_2017 * 1 + i_use_2016 * 1;
			}else{
				QUOTA = 0;
				apply_oldsum = 0;
			}
		}
	}catch(e){
		Client.addErrLog(&quot;語法為:&quot;+sql);
	}finally{
		conn.close();
	}
	var msgMap = new java.util.HashMap();
	msgMap.put(&quot;msg&quot;,msg);
	msgMap.put(&quot;apply_oldsum&quot;,apply_oldsum);
	msgMap.put(&quot;QUOTA&quot;,QUOTA);
	return msgMap;
}


function getAnnualMap_old(empno,thisDay){	
	var msg;
	var QUOTA = 0;
	var apply_oldsum = 0;
	var conn = Client.createSessionConnection(&quot;T-MES&quot;);
	var sql = &quot;&quot;;
	var vec = &quot;&quot;;
	try{
		sql+=&quot;select dptno,empno,cname,enterworkday,	enterworkday_a,close_amt,i_up_2017,i_up_2018,close_amt_new, &quot;;
		sql+=&quot;		 i_up_2017_new, &quot;;
		sql+=&quot;		 i_up_2018_new,day1_b,d.day1,day2_b,d.day2,type, &quot;;
		sql+=&quot;		case when type = &apos;A&apos;  then &quot;;
		sql+=&quot;				case when day1 &lt;= to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;) and  a_timecnt + b_timecnt &lt;= i_up_2017_new then &quot;;
		sql+=&quot;							case when a_timecnt + b_timecnt &lt;= i_up_2017_new Then 0 &quot;;
		sql+=&quot;									 when a_timecnt + b_timecnt &gt; i_up_2017_new Then a_timecnt + b_timecnt - i_up_2017_new &quot;;
		sql+=&quot;							end &quot;;
		sql+=&quot;						 else  &quot;;
		sql+=&quot;							case when a_timecnt + b_timecnt &lt;= close_amt_new Then a_timecnt + b_timecnt &quot;;
		sql+=&quot;									 when a_timecnt + b_timecnt &gt; close_amt_new Then close_amt_new &quot;;
		sql+=&quot;							end &quot;;
		sql+=&quot;						 end	 &quot;;
		sql+=&quot;			   when type = &apos;B&apos;  then  &quot;;
		sql+=&quot;						case when a_timecnt &lt;=close_amt_new then a_timecnt &quot;;
		sql+=&quot;							   when a_timecnt &gt; close_amt_new then close_amt_new &quot;;
		sql+=&quot;						end &quot;;
		sql+=&quot;			   when type = &apos;C&apos;  then  &quot;;
		sql+=&quot;					case when a_timecnt &lt;= close_amt_new then a_timecnt &quot;;
		sql+=&quot;                            when a_timecnt &gt; close_amt_new then close_amt_new &quot;;
		sql+=&quot;					End  &quot;;
		sql+=&quot;			end as i_use_2016, &quot;;
		sql+=&quot;		case when type = &apos;A&apos;  then  &quot;;
		sql+=&quot;					case when day1 &lt;= to_date(&apos;2017-6-30&apos;,&apos;%Y-%m-%d&apos;) and a_timecnt + b_timecnt &lt;= i_up_2017_new  then &quot;;
		sql+=&quot;								case when a_timecnt + b_timecnt &lt;= i_up_2017_new Then a_timecnt + b_timecnt &quot;;
		sql+=&quot;										 when a_timecnt + b_timecnt &gt; i_up_2017_new Then i_up_2017_new &quot;;
		sql+=&quot;								end &quot;;
		sql+=&quot;							else &quot;;
		sql+=&quot;								case when a_timecnt + b_timecnt &lt;= close_amt_new Then 0 &quot;;
		sql+=&quot;										 when a_timecnt + b_timecnt &gt; close_amt_new Then a_timecnt + b_timecnt -close_amt_new &quot;;
		sql+=&quot;								end &quot;;
		sql+=&quot;						end					 &quot;;
		sql+=&quot;			   when type = &apos;B&apos;  then  &quot;;
		sql+=&quot;					case when a_timecnt &lt;=close_amt_new then b_timecnt &quot;;
		sql+=&quot;						   when a_timecnt &gt; close_amt_new then a_timecnt+b_timecnt - close_amt_new &quot;;
		sql+=&quot;					end &quot;;
		sql+=&quot;			  when type = &apos;C&apos;  then  &quot;;
		sql+=&quot;					case when a_timecnt &lt;= close_amt_new then 0 &quot;;
		sql+=&quot;                            when a_timecnt &gt; close_amt_new then a_timecnt - close_amt_new &quot;;
		sql+=&quot;					End  &quot;;
		sql+=&quot;			end   as i_use_2017, &quot;;
		sql+=&quot;		case when type = &apos;A&apos;  then b_timecnt + c_timecnt  &quot;;
		sql+=&quot;			   when type = &apos;B&apos;  then c_timecnt &quot;;
		sql+=&quot;			   when type = &apos;C&apos;  then b_timecnt end   as i_use_2018, &quot;;
		sql+=&quot;			a_timecnt,b_timecnt,c_timecnt &quot;;
		sql+=&quot;from (select  dptno,empno,cname,enterworkday,enterworkday_a ,type, &quot;;
		sql+=&quot;		date_a_b,date_a_e,		date_b_b,date_b_e,		date_c_b,date_c_e,day1_b,day2_b , &quot;;
		sql+=&quot;		nvl((select sum(timecnt) from empm060 where empno = C.empno and abstype=&apos;I&apos; and absdate &gt;= date_a_b and absdate &lt;= date_a_e),0) as a_timecnt, &quot;;
		sql+=&quot;		nvl((select sum(timecnt) from empm060 where empno = C.empno and abstype=&apos;I&apos; and absdate &gt;= date_b_b and absdate &lt;= date_b_e),0) as b_timecnt, &quot;;
		sql+=&quot;		nvl((select sum(timecnt) from empm060 where empno = C.empno and abstype=&apos;I&apos; and absdate &gt;= date_c_b and absdate &lt;= date_c_e),0) as c_timecnt, &quot;;
		sql+=&quot;		close_amt, &quot;;
		sql+=&quot;		i_up_2017, &quot;;
		sql+=&quot;		i_up_2018, &quot;;
		sql+=&quot;		day1,day2, &quot;;
		sql+=&quot;		case when close_amt &lt; 0 then 0 else close_amt end close_amt_new, &quot;;
		sql+=&quot;		case when empno = &apos;031065&apos; or empno = &apos;031077&apos; or empno = &apos;031078&apos; or empno = &apos;031079&apos; then &quot;;
		sql+=&quot;							0 &quot;;
		sql+=&quot;				else  &quot;;
		sql+=&quot;				case when close_amt &lt; 0 and close_amt + i_up_2017 &gt;= 0 then  close_amt+i_up_2017  &quot;;
		sql+=&quot;			   		when close_amt &lt; 0 and close_amt + i_up_2017 &lt; 0 then  0 &quot;;
		sql+=&quot;						else i_up_2017 end  &quot;;
		sql+=&quot;				end as i_up_2017_new, &quot;;
		sql+=&quot;		case when close_amt &lt; 0 and close_amt + i_up_2017 &gt;= 0 then  i_up_2018 &quot;;
		sql+=&quot;			   when close_amt &lt; 0 and close_amt + i_up_2017 &lt; 0 then  close_amt+i_up_2017 + i_up_2018 &quot;;
		sql+=&quot;				else i_up_2018 end as i_up_2018_new &quot;;
		sql+=&quot;from (select dptno,empno,cname,enterworkday,enterworkday_a,close_amt ,type,day1_b,day2_b , &quot;;
		sql+=&quot;		to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) as date_a_b, &quot;;
		sql+=&quot;		case when type=&apos;C&apos; or type=&apos;B&apos; Then date(to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;)) &quot;;
		sql+=&quot;			   when type=&apos;A&apos; Then date(day1) end as date_a_e, &quot;;
		sql+=&quot;		case when type=&apos;C&apos; or type=&apos;B&apos;  Then date(to_date(&apos;2017-7-1&apos; ,&apos;%Y-%m-%d&apos;)) &quot;;
		sql+=&quot;			   when type=&apos;A&apos; Then date(day1 + 1 units day) end as date_b_b, &quot;;
		sql+=&quot;		case when type=&apos;B&apos; Then date(day1) &quot;;
		sql+=&quot;				when type=&apos;A&apos; Then date(to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;)) &quot;;
		sql+=&quot;			  	when type=&apos;C&apos; Then date(day2)   end as date_b_e, &quot;;
		sql+=&quot;		case when type=&apos;A&apos; Then  date(to_date(&apos;2017-7-1&apos; ,&apos;%Y-%m-%d&apos;) ) &quot;;
		sql+=&quot;			   when type=&apos;B&apos; Then date(day1 +1 units day) end as date_c_b, &quot;;
		sql+=&quot;		case when type=&apos;A&apos; or type=&apos;B&apos; Then date(day2) end as date_c_e, &quot;;
		//sql+=&quot;		case when day1 &lt; date(to_date(&apos;2017-3-31&apos; ,&apos;%Y-%m-%d&apos;)) then to_date(&apos;2017/3/31&apos;,&apos;%Y/%m/%d&apos;) else day1 end as day1, &quot;;
		sql+=&quot;		day1, &quot;;
		sql+=&quot;		day2, &quot;;
		sql+=&quot;		case when enterworkday &gt;= to_date(&apos;2016-1-1&apos; ,&apos;%Y-%m-%d&apos;) and enterworkday &lt;= to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;) then &quot;;
		sql+=&quot;			case when date((enterworkday + 6 units month ))  &gt; date(current) then 0 else 24 end  &quot;;
		sql+=&quot;		else &quot;;
		sql+=&quot;  		case when day1 = to_date(&apos;2017-12-31&apos; ,&apos;%Y-%m-%d&apos;) then &quot;;
		sql+=&quot;				(select icnt from empm320 where gyear = (2018 - year(enterworkday_a)-1) and imonth = 0)  &quot;;
		sql+=&quot;			else &quot;;
		sql+=&quot;				round(nvl((select  icnt from empm320 where gyear = (2017 - year(enterworkday_a) -1) and imonth = 0),24)*  (month(enterworkday_a))/ 12,0)  &quot;;
		sql+=&quot;			end &quot;;
		sql+=&quot;		end as i_up_2017, &quot;;
		sql+=&quot;		case when day1 = to_date(&apos;2017-12-31&apos; ,&apos;%Y-%m-%d&apos;) then &quot;;
		sql+=&quot;			(select icnt from empm320 where gyear = (2019 - year(enterworkday_a)-1) and imonth = 0) &quot;;
		sql+=&quot;		else  &quot;;
		sql+=&quot;			(select icnt from empm320 where gyear = (2018 - year(enterworkday_a)-1) and imonth = 0) &quot;;
		sql+=&quot;		end as i_up_2018 &quot;;
		sql+=&quot;from  &quot;;
		sql+=&quot;(select dptno,empno,cname,enterworkday,enterworkday_a,day1,day2,close_amt,type,day1,day2,day2_b , &quot;;
		sql+=&quot;	case when day1_b &lt; to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) then to_date(&apos;2017-1-1&apos; ,&apos;%Y-%m-%d&apos;) else day1_b end as day1_b &quot;;
		sql+=&quot;from ( &quot;;
		sql+=&quot;		select dptno,empno,cname,enterworkday,enterworkday_a,day1,day2 ,day1_b,day2_b , &quot;;
		sql+=&quot;	(nvl((select close_amt from paym140 where empno = A1.empno and abstype=&apos;I&apos; and salarytimes = &apos;2016122&apos;),0)) as close_amt, &quot;;
		sql+=&quot;				case when (date(to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;)) - date(to_date(&apos;2017/&apos; || to_char((date(enterworkday)  + nvl((select sum(date(reworkday) - date(applyday)  + 1)  &quot;;
		sql+=&quot;																				from empm130 where empno=A1.empno) &quot;;
		sql+=&quot;																			   ,0)    units day ),&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;)  - 1 units day )) &gt; &apos;0&apos; then &apos;A&apos;   &quot;;
		sql+=&quot;					when (date(to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;)) - date(to_date(&apos;2017/&apos; || to_char((date(enterworkday)  + nvl((select sum(date(reworkday) - date(applyday)  + 1)  &quot;;
		sql+=&quot;																				from empm130 where empno=A1.empno) &quot;;
		sql+=&quot;																			   ,0)   units day ),&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;)  - 1 units day )) &lt; &apos;0&apos; then &apos;B&apos;    &quot;;
		sql+=&quot;					when (date(to_date(&apos;2017-6-30&apos; ,&apos;%Y-%m-%d&apos;)) - date(to_date(&apos;2017/&apos; || to_char((date(enterworkday)  + nvl((select sum(date(reworkday) - date(applyday)  + 1)  &quot;;
		sql+=&quot;																				from empm130 where empno=A1.empno) &quot;;
		sql+=&quot;																			   ,0)   units day ),&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;)  - 1 units day )) = &apos;0&apos; then &apos;C&apos; end as type &quot;;
		sql+=&quot;from  &quot;;
		sql+=&quot;(select dptno,empno,cname,enterworkday,enterworkday_a, &quot;;
		sql+=&quot;		case when to_char(enterworkday_a,&apos;%m-%d&apos;) = &apos;01-01&apos; then &quot;;
		sql+=&quot;					to_date(&apos;2017/&apos; || to_char(enterworkday_a ,&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;)  &quot;;
		sql+=&quot;				else &quot;;
		sql+=&quot;						to_date(&apos;2016/&apos; || to_char(enterworkday_a ,&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;)   &quot;;
		sql+=&quot;				end as day1_b, &quot;;
		sql+=&quot;		case when to_char(enterworkday_a,&apos;%m-%d&apos;)=&apos;01-01&apos; then &quot;;
		sql+=&quot;					to_date(&apos;2018/&apos; || to_char(enterworkday_a ,&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;) - 1 units day 				 &quot;;
		sql+=&quot;				else &quot;;
		//sql+=&quot;					case when to_date(&apos;2017/&apos; || to_char(enterworkday_a ,&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;) - 1 units day &lt; date(to_date(&apos;2017-3-31&apos; ,&apos;%Y-%m-%d&apos;)) then  &quot;;
		//sql+=&quot;								to_date(&apos;2017/3/31&apos;,&apos;%Y/%m/%d&apos;)  &quot;;
		//sql+=&quot;							else  &quot;;
		sql+=&quot;								to_date(&apos;2017/&apos; || to_char(enterworkday_a ,&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;) - 1 units day  &quot;;
		//sql+=&quot;							end &quot;;
		sql+=&quot;				end as day1, &quot;;
		sql+=&quot;		case when to_char(enterworkday_a,&apos;%m-%d&apos;)=&apos;01-01&apos; then &quot;;
		sql+=&quot;							to_date(&apos;2018/&apos; || to_char(enterworkday_a,&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;)  &quot;;
		sql+=&quot;						else &quot;;
		sql+=&quot;							to_date(&apos;2017/&apos; || to_char(enterworkday_a,&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;)  &quot;;
		sql+=&quot;				end as day2_b	, &quot;;
		sql+=&quot;		case when to_char(enterworkday_a,&apos;%m-%d&apos;)=&apos;01-01&apos; then &quot;;
		sql+=&quot;							to_date(&apos;2019/&apos; || to_char(enterworkday_a,&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;)  - 1 units day   &quot;;
		sql+=&quot;						else &quot;;
		sql+=&quot;							to_date(&apos;2018/&apos; || to_char(enterworkday_a,&apos;%m/%d&apos;),&apos;%Y/%m/%d&apos;)  - 1 units day   &quot;;
		sql+=&quot;				end as day2						             &quot;;
		sql+=&quot;from ( &quot;;
		sql+=&quot;select dptno,empno,cname,enterworkday, &quot;;
		sql+=&quot;		(date(enterworkday) + nvl((select sum(date(reworkday) - date(applyday)  + 1) from empm130 where empno=empm020.empno  and applyday &gt; empm020.enterworkday ),0) units day ) as enterworkday_a &quot;;
		sql+=&quot;from empm020  &quot;;
		sql+=&quot;where  empno = &apos;&quot;+ empno +&quot;&apos; &quot;;
		sql+=&quot;)as A2 ) as A1) as A) as B) as C ) as D order by dptno,day1 &quot;;
		vec = conn.loadValue(sql);
		if(vec.size() &gt; 0){
			var result = vec.get(0);
			day1 = (result.get(&quot;day1&quot;)+&quot;&quot;).substring(0,10).replace(&quot;-&quot;,&quot;/&quot;).replace(&quot;-&quot;,&quot;/&quot;);;
			close_amt_new = result.get(&quot;close_amt_new&quot;);
			i_up_2017_new = result.get(&quot;i_up_2017_new&quot;);
			i_up_2018_new = result.get(&quot;i_up_2018_new&quot;);
			i_use_2016 = result.get(&quot;i_use_2016&quot;);
			i_use_2017 = result.get(&quot;i_use_2017&quot;);
			i_use_2018 = result.get(&quot;i_use_2018&quot;);
			Client.addDebugLog(&quot;day1=&quot;+day1+&quot;,thisday=&quot;+thisDay);
			if (thisDay &gt; day1){
				QUOTA = i_up_2018_new;
				apply_oldsum = i_use_2018;
			}else{
				QUOTA = i_up_2017_new *1  + close_amt_new*1;
				apply_oldsum = i_use_2017 * 1 + i_use_2016 * 1;
			}
		}
	}catch(e){
		Client.addErrLog(&quot;語法為:&quot;+sql);
	}finally{
		conn.close();
	}
	var msgMap = new java.util.HashMap();
	msgMap.put(&quot;msg&quot;,msg);
	msgMap.put(&quot;apply_oldsum&quot;,apply_oldsum);
	msgMap.put(&quot;QUOTA&quot;,QUOTA);
	return msgMap;
}

//TGCE2017新版特休
function getAnnualMap_ex(empno,thisDay){	
	Client.addDebugLog(&quot;getAnnualMap_ex(start)=&quot;+empno);
	var msg;
	var QUOTA = 0;
	var apply_oldsum = 0;
	var conn = Client.createSessionConnection(&quot;T-MES&quot;);
	var sql = &quot;&quot;;
	var vec = &quot;&quot;;
	try{
		sql += &quot; select X1.*,  &quot;;
		sql += &quot; nvl((select sum(timecnt) from empm060 where empno = X1.empno and abstype=&apos;I&apos; and absdate between X1.date_beg and X1.date_end),0) i_use, &quot;;
		sql += &quot; nvl((select sum(timecnt) from empm031 where empno = X1.empno and substr(abstype,1,1) = &apos;X&apos; and date_beg = X1.date_beg and date_end = X1.date_end),0)  de, &quot;;
		sql += &quot; 0 as remain, &quot;;
		sql += &quot; &apos;&apos; as remark &quot;;
		sql += &quot; from (select case when empm020.dptno=&apos;2L1&apos; then empm020.dptno1 else empm020.dptno end as dptno,empm020.empno, &quot;;
		sql += &quot; 	empm020.cname,empm020.enterworkday, &quot;;
		sql += &quot; 		(date(empm020.enterworkday) + nvl((select sum(date(reworkday) - date(applyday)  + 1)  &quot;;
		sql += &quot; 											   from empm130 where empno=empm020.empno   &quot;;
		sql += &quot; 											  and applyday &gt; empm020.enterworkday ),0) units day ) as enterworkday_a, empm020.directcode, &quot;;
		sql += &quot; 	empm031.date_beg,empm031.date_end,empm031.type,nvl(empm031.timecnt,0) timecnt &quot;;
		sql += &quot; from  empm020 LEFT OUTER JOIN  empm031  &quot;;
		sql += &quot; 	on empm020.empno = empm031.empno  &quot;;
		sql += &quot; 	and to_date(&apos;&quot;+thisDay+&quot;&apos;,&apos;%Y/%m/%d&apos;)  between empm031.date_beg  and empm031.date_end  &quot;;
		sql += &quot; 	and empm031.abstype=&apos;I&apos; &quot;;
		sql += &quot; where  empm020.empno =&apos;&quot; + empno + &quot;&apos;  &quot;;
		sql += &quot; order by empm020.dptno, empm020.empno) as X1; &quot;;
		vec = conn.loadValue(sql);		
		if(vec.size() &gt; 0){
			var result = vec.get(0);			
			QUOTA = result.get(&quot;timecnt&quot;) * 1 + result.get(&quot;de&quot;) * 1;
			apply_oldsum = result.get(&quot;i_use&quot;) * 1;			
		}
	}catch(e){
		Client.addErrLog(&quot;語法為:&quot;+sql);
	}finally{
		conn.close();
	}
	var msgMap = new java.util.HashMap();
	msgMap.put(&quot;msg&quot;,msg);
	msgMap.put(&quot;apply_oldsum&quot;,apply_oldsum);
	msgMap.put(&quot;QUOTA&quot;,QUOTA);
	Client.addDebugLog(&quot;getAnnualMap_ex(end)=&quot;+empno);
	return msgMap;
}


//取得有薪事上限　　add by yingchieh@20170720
function getQUOTA_M(empno,thisDay){
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	 var myDate = new Packages.pase.agenda.MyDate();
	var mcnt = 0;
	var empm020_mcnt = 0;
	var sql = &quot;&quot;;
	var vec;
	var enterworkday;
	var apply_oldsum= 0;
	sql =  &quot;select   to_char((date(enterworkday) +  &quot;;
	sql += &quot;   nvl((select sum(date(reworkday) - date(applyday)  + 1)    &quot;;
	sql += &quot;				from empm130  &quot;;
	sql += &quot;				where empno=empm020.empno   &quot;;
	sql += &quot;				and applyday &gt; empm020.enterworkday ),0) units day ),&apos;%Y/%m/%d&apos;) as  enterworkday,mcnt &quot;;
	sql += &quot;	from empm020  &quot;;
	sql += &quot;	where empno =&apos;&quot; + empno + &quot;&apos; and (titalcode&gt;=&apos;03&apos; or title_oversea &gt;= &apos;03&apos;); &quot;;
	vec = loadSQL_new(sql,&quot;T-MES&quot;,&quot;TGCE取得該員實際的入廠日期(加扣停薪留職日)&quot;);
	if(vec.size()&gt;0){
		enterworkday= vec.get(0).get(&quot;enterworkday&quot;);
		empm020_mcnt= vec.get(0).get(&quot;mcnt&quot;); // 主檔內的有薪事假
	}else{
		//return 0;//如果取不到值，則回傳0
		var msgMap = new java.util.HashMap();
		msgMap.put(&quot;QUOTA&quot;,0);
		msgMap.put(&quot;apply_oldsum&quot;,0);
		msgMap.put(&quot;oldApp&quot;,0);
		msgMap.put(&quot;enterworkday&quot;,&quot;&quot;);
		msgMap.put(&quot;date_beg&quot;,&quot;&quot;);
		msgMap.put(&quot;date_end&quot;,&quot;&quot;);
		msgMap.put(&quot;chgdate&quot;,&quot;&quot;);
		return msgMap;
	}
	//當周年起始日
	//當周年結束日
	var date_beg = thisDay.substring(0,4) + &quot;/&quot; + enterworkday.substring(5,10);
	var date_end;
	if (thisDay &lt; date_beg){//小於當週年
		date_beg = (thisDay.substring(0,4) - 1) + &quot;/&quot; + enterworkday.substring(5,10);
		date_end = myDate.addDay(thisDay.substring(0,4) + &quot;/&quot; + enterworkday.substring(5,10),-1);
		if (date_end.substring(0,4)== 2017){
			date_beg = &quot;2017/01/01&quot;;
		}		
	}else{
		date_end = myDate.addDay((date_beg.substring(0,4) * 1 + 1) + &quot;/&quot; + enterworkday.substring(5,10) , -1 );
	}

	if (thisDay &lt;= date_end &amp;&amp; date_end.substring(0,4)== 2017 ){//小於當週年且為2017年
		mcnt = thisDay.substring(5,7) * 4 ;
	}else{
		sql =  &quot;select case when to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;) &gt;= to_date(year(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;)) || &apos;-&apos; || to_char(to_date(&apos;&quot; + enterworkday + &quot;&apos;,&apos;%Y/%m/%d&apos;),&apos;%m-%d&apos;),&apos;%Y-%m-%d&apos;) then &quot;;
		sql += &quot;			TRUNC(MONTHS_BETWEEN(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;) ,  to_date(year(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;)) || &apos;-&apos; || to_char(to_date(&apos;&quot; + enterworkday + &quot;&apos;,&apos;%Y/%m/%d&apos;),&apos;%m-%d&apos;),&apos;%Y-%m-%d&apos;))+1,0) *4 &quot;;
		sql += &quot;		else  &quot;;
		sql += &quot;			TRUNC(MONTHS_BETWEEN(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;),  to_date(year(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;)) || &apos;-&apos; || to_char(to_date(&apos;&quot; + enterworkday + &quot;&apos;,&apos;%Y/%m/%d&apos;),&apos;%m-%d&apos;),&apos;%Y-%m-%d&apos;))+13,0) *4 end as cal_mcnt &quot;;
		sql += &quot; from (	select  (date(enterworkday) +  &quot;;
		sql += &quot;		   nvl((select sum(date(reworkday) - date(applyday)  + 1)    &quot;;
		sql += &quot;				from empm130  &quot;;
		sql += &quot;				where empno=empm020.empno   &quot;;
		sql += &quot;				and applyday &gt; empm020.enterworkday ),0) units day ) as enterworkday &quot;;
		sql += &quot;	from empm020  &quot;;
		sql += &quot;	where empno =&apos;&quot; + empno + &quot;&apos; and (titalcode&gt;=&apos;03&apos; or title_oversea &gt;= &apos;03&apos;) ); &quot;;
		vec = loadSQL_new(sql,&quot;T-MES&quot;,&quot;TGCE依入廠月份算有薪事假&quot;);
		if(vec.size() &gt; 0){
			mcnt = vec.get(0).get(&quot;cal_mcnt&quot;);
		}
	}
	
	apply_oldsum = apply_old_M(empno,date_beg,date_end,enterworkday);//已轉入empm060
	oldApp = getOldAppFromForm_ex(empno,&quot;M&quot;,thisDay,date_beg,date_end,false)//簽核中
	
	//如果有轉正記錄，則要以主檔的mcnt為主
	var chgdate =&quot;&quot;;
	sql =  &quot;select to_char(chgday,&apos;%Y/%m/%d&apos;) chgdate &quot;;
	sql += &quot;from empm160  &quot;;
	sql += &quot;where substr(wkgreat_u,1,1) in (&apos;0&apos;,&apos;M&apos;)  &quot;;
	sql += &quot;and substr(wkgreat_o  ,1,1)  not in (&apos;0&apos;,&apos;M&apos;)  &quot;;
	sql += &quot;and wkgreat_u &lt;&gt; &apos;M3&apos; &quot;;
	sql += &quot;and not(substr(dptno_o,1,1) in (&apos;5&apos;,&apos;6&apos;,&apos;8&apos;) and substr(dptno_u,1,1) = &apos;2&apos;) &quot;;
	sql += &quot;and empno = &apos;&quot; + empno + &quot;&apos; &quot;;
	sql += &quot;and (chgday &gt;= to_date(year(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;)) || &apos;-&apos; || to_char(to_date(&apos;&quot; + enterworkday + &quot;&apos;,&apos;%Y/%m/%d&apos;),&apos;%m-%d&apos;),&apos;%Y-%m-%d&apos;) - 1 units year &quot;;
	sql += &quot;and chgday &lt;= to_date(year(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;)) || &apos;-&apos; || to_char(to_date(&apos;&quot; + enterworkday + &quot;&apos;,&apos;%Y/%m/%d&apos;),&apos;%m-%d&apos;),&apos;%Y-%m-%d&apos;) - 1 units day &quot;;
	sql += &quot;or chgday &gt;= to_date(&apos;&quot; + date_beg + &quot;&apos;,&apos;%Y/%m/%d&apos;) and chgday &lt;= to_date(&apos;&quot; + date_end + &quot;&apos;,&apos;%Y/%m/%d&apos;));&quot;;
	vec = loadSQL_new(sql,&quot;T-MES&quot;,&quot;TGCE判斷否有轉主管職&quot;);
	if(vec.size() &gt; 0){
		//mcnt = empm020_mcnt;
		chgdate = vec.get(0).get(&quot;chgdate&quot;);
		if (date_beg == &quot;2017/01/01&quot;){//還沒跨到2017周年
			if (chgdate.substring(0,4) == &quot;2016&quot;){
				mcnt = thisDay.substring(5,7) * 4 ;
			}else{
				mcnt = ((thisDay.substring(5,7) - chgdate.substring(5,7)) + 1 ) * 4;
			}
		}else{//跨過2017周年
			//if (thisDay &lt; date_beg){
				sql =  &quot;select case when to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;) &gt;= to_date(year(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;)) || &apos;-&apos; || to_char(to_date(&apos;&quot; + chgdate + &quot;&apos;,&apos;%Y/%m/%d&apos;),&apos;%m-%d&apos;),&apos;%Y-%m-%d&apos;) then &quot;;
				sql += &quot;			TRUNC(MONTHS_BETWEEN(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;) ,  to_date(year(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;)) || &apos;-&apos; || to_char(to_date(&apos;&quot; + chgdate + &quot;&apos;,&apos;%Y/%m/%d&apos;),&apos;%m-%d&apos;),&apos;%Y-%m-%d&apos;)),0) *4 &quot;;
				sql += &quot;		else  &quot;;
				sql += &quot;			TRUNC(MONTHS_BETWEEN(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;),  to_date(year(to_date(&apos;&quot; + thisDay + &quot;&apos;,&apos;%Y/%m/%d&apos;)) || &apos;-&apos; || to_char(to_date(&apos;&quot; + chgdate + &quot;&apos;,&apos;%Y/%m/%d&apos;),&apos;%m-%d&apos;),&apos;%Y-%m-%d&apos;))+12,0) *4 end as cal_mcnt &quot;;
				sql += &quot; from (	select  (date(enterworkday) +  &quot;;
				sql += &quot;		   nvl((select sum(date(reworkday) - date(applyday)  + 1)    &quot;;
				sql += &quot;				from empm130  &quot;;
				sql += &quot;				where empno=empm020.empno   &quot;;
				sql += &quot;				and applyday &gt; empm020.enterworkday ),0) units day ) as enterworkday &quot;;
				sql += &quot;	from empm020  &quot;;
				sql += &quot;	where empno =&apos;&quot; + empno + &quot;&apos;); &quot;;
				vec = loadSQL_new(sql,&quot;T-MES&quot;,&quot;TGCE依入廠月份算有薪事假&quot;);
				if(vec.size() &gt; 0){
					mcnt = vec.get(0).get(&quot;cal_mcnt&quot;);
				}
			//}
		}
		
	}
	if (empno == &quot;004068&quot; &amp;&amp; date_beg == &quot;2017/01/22&quot;){
		mcnt = mcnt * 1 + 4;
	}
	if (empno == &quot;029806&quot; &amp;&amp; date_beg.substring(0,4) == &quot;2017&quot;){
	
	}
	var msgMap = new java.util.HashMap();
	msgMap.put(&quot;QUOTA&quot;,mcnt);
	msgMap.put(&quot;apply_oldsum&quot;,apply_oldsum);
	msgMap.put(&quot;oldApp&quot;,oldApp);
	msgMap.put(&quot;enterworkday&quot;,enterworkday);
	msgMap.put(&quot;date_beg&quot;,date_beg);
	msgMap.put(&quot;date_end&quot;,date_end);
	msgMap.put(&quot;chgdate&quot;,chgdate);
	return msgMap;
}

function apply_old_M(empno,date_beg,date_end,enterworkday){// 用來取得已請假時數,資料庫的(M假專用)
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var apply_oldsum = 0;
	var sql ;
	var myDate = new Packages.pase.agenda.MyDate();	

	sql =  &quot;select  nvl(sum(timecnt),0) as sums from empm060 &quot;;
	sql += &quot;where empno=&apos;&quot; + empno + &quot;&apos; and abstype = &apos;M&apos; &quot;;
	sql += &quot;and absdate &gt;= date(&apos;&quot; + enterworkday + &quot;&apos;) and absdate &gt;= date(&apos;&quot; + date_beg + &quot;&apos;) and absdate &lt;= date(&apos;&quot; + date_end + &quot;&apos;);&quot;;
	var vec = loadSQL_new(sql,&quot;T-MES&quot;,&quot;TGCE計算有薪事假已請时數&quot;);
	if(vec.size()&gt;0){		
		apply_oldsum = vec.get(0).get(&quot;sums&quot;);			
	}else{
		apply_oldsum = 0;
	}	
	return apply_oldsum;
}

// 取得簽核中或結案同意的該假別請假時數
function getOldAppFromForm_ex(empno,apply_type,thisDay,date_beg,date_end,isSpecial){
	var oldApp;
	var sql;
	var year = thisDay.substring(0,4);
	// 與簽核中的比較運算,也要考慮為今年度的
	sql =  &quot; select t.item10 hdate,i.ITEM17 empno,t.item3 apptype,t.item7 apphours,t.item4 appdate &quot;;
	sql += &quot; from ART00251222410285944_ins i,ART00251222410285944ITEM84 t &quot;;
	sql	+= &quot; where i.INSID=t.INSID and i.ITEM17 = &apos;&quot; + empno + &quot;&apos; and i.item149 = &apos;簽核&apos; &quot;		;
	sql	+= &quot; and ((t.item13&lt;&gt;&apos;已轉&apos; and t.item13&lt;&gt;&apos;退件&apos;) or t.item13 is null) &quot;;
	if (apply_type == &quot;M&quot;){
		sql	+= &quot; and t.item4 &gt;= &apos;&quot; + date_beg + &quot;&apos; and t.item4 &lt;= &apos;&quot; + date_end + &quot;&apos; &quot;;
	}else{
		sql	+= &quot; and substr(t.item4,0,4)=&apos;&quot;+year+&quot;&apos;&quot;;
	}	
	oldApp = getOldApp_ex(sql,thisDay,isSpecial,apply_type);
	if(oldApp==-1){// 代表已請過生理假
		return -1;
	}else{		
		return oldApp;
	}
}

// 部分假別要做例外處理
function getOldApp_ex(sql,thisDay,isSpecial,apply_type){
	var oldApp = 0;	
	var vec = Client.SQLloadValue(sql);
	var hdate;
	if(isSpecial){// 特殊假別,可以從tableAdv中抓出來				
		// 第一段:取得各特殊假別的發生日期
		hdate = Form.getValue(&quot;hDate&quot;);	
	}
	var thisYear = thisDay.split(&quot;/&quot;)[0];
	var thisMonth = thisDay.split(&quot;/&quot;)[1];
	if(vec.size() &gt; 0){
		for(var i = 0 ;  i &lt; vec.size(); i++){
			var result = vec.get(i);
			var apptype = result.get(&quot;apptype&quot;).trim();// 假別
			var index = apptype.indexOf(&quot;.&quot;);
			apptype = apptype.substring(0,index);
			var appdate = result.get(&quot;appdate&quot;);// 日期
			var apphours = result.get(&quot;apphours&quot;);// 時數
			apphours = getInt(apphours);
			if(apptype.equals(apply_type)){// 如果假別相同就計算已請過的時數				
				if(apptype.indexOf(&quot;D1&quot;)&gt;=0){// 生理假只要判斷同月份是否有請過
					var oldAppYear = appdate.split(&quot;/&quot;)[0];
					var oldAppMonth = appdate.split(&quot;/&quot;)[1];
					if(thisYear.equals(oldAppYear)&amp;&amp;thisMonth.equals(oldAppMonth)){
						oldApp = -1;
					}
				}else if(apptype.equals(&quot;L&quot;)||apptype.equals(&quot;J&quot;)||apptype.equals(&quot;k&quot;)||apptype.equals(&quot;K1&quot;)||apptype.equals(&quot;K2&quot;)||apptype.equals(&quot;K3&quot;)){
					var _hdate = result.get(&quot;hdate&quot;);// 發生日期
					if(_hdate.equals(hdate)){// 發生日期相同時計算
						oldApp += apphours;
					}				
				}else{// 其他假別計算請過的時數
					oldApp += apphours;
				}
			}
		}
	}
	return oldApp;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>請假單相關函式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00061245913402440</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2009/06/25 15:03:22</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.TGCE.MISTOOL.FASEARCH</string> 
     </void> 
     <void property="id"> 
      <string>SCL00061245913402440</string> 
     </void> 
     <void property="name"> 
      <string>FASEARCH</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00061245913388659</string> 
     </void> 
     <void property="scriptSource"> 
      <string>	
//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;SOURCETABLE&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
//			table.setValueAt(java.lang.Integer.parseInt(i),    	row, &quot;序&quot;);			
			table.setValueAt(i,    	row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;DATA_TYPE&quot;),    	row, &quot;資料型態&quot;);
			table.setValueAt(hm.get(&quot;USER_ID&quot;),    	row, &quot;員工編號&quot;);
			table.setValueAt(hm.get(&quot;USER_NAME&quot;),    	row, &quot;員工姓名&quot;);
			table.setValueAt(hm.get(&quot;DEPT&quot;), 	row, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;MACH_NO&quot;), 	row, &quot;資產編號&quot;);
			table.setValueAt(hm.get(&quot;MACH_NAME&quot;),   	row, &quot;資產名稱&quot;);
			table.setValueAt(hm.get(&quot;REMARKS&quot;),  	row, &quot;備註&quot;);
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
//===================================================================
// 加會簽選單
//===================================================================	
function showTable_addsign(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;SOURCETABLE&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			table.setValueAt(&quot;false&quot;,row,&quot;選取&quot;);
			table.setValueAt(hm.get(&quot;NAME&quot;),    	row, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;JOBTITLE&quot;),    	row, &quot;職稱&quot;);
			table.setValueAt(hm.get(&quot;EMPCODE&quot;), 	row, &quot;工號&quot;);
			table.setValueAt(hm.get(&quot;USERNAME&quot;), 	row, &quot;姓名&quot;);
			
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;無資料&quot;);
	}
}
//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}else{
					sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
		}
	}
	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}else{
					sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}			
		}
	}
	// 文件編號
	var Doc_Sn = Form.getValue(&quot;Sn&quot;);	
	if (!&quot;&quot;.equals(Doc_Sn)) {
		sSQL += &quot; AND ITEM138 like &apos;%&quot; + Doc_Sn + &quot;%&apos;&quot;;
	}	
	
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM144 like &apos;%&quot; + MemName + &quot;%&apos;&quot;;
	}	
	var appname = Form.getValue(&quot;appname&quot;);	
	if (!&quot;&quot;.equals(appname)) {
		sSQL += &quot; AND ITEM27 like &apos;%&quot; + appname + &quot;%&apos;&quot;;
	}	

	var PHSTATUS = Form.getValue(&quot;FComboBox0&quot;);

//	if (!&quot;&quot;.equals(PHSTATUS)) {
//		if(&quot;採購已收件&quot;.equals(PHSTATUS)){
//			sSQL += &quot; AND ITEM131 = &apos;W&apos;&quot;;
//		}
//		else if(&quot;已轉入ERP&quot;.equals(PHSTATUS)){
//			sSQL += &quot; AND ITEM131 = &apos;Y&apos;&quot;;
//		}
//		else{
//			sSQL += &quot; AND (ITEM131 &lt;&gt; &apos;W&apos; and  ITEM131 &lt;&gt; &apos;Y&apos;) AND ITEM155 = &apos;false&apos; AND ITEM115 is not null&quot;;
//		}
//		}
//		else		{
//				var Status = Form.getValue(&quot;Status&quot;);	 
//				if (!&quot;全部&quot;.equals(Status)) {
//						if (&quot;已結案&quot;.equals(Status)) {
//							sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM115 is not null &quot;;
//						}else if (&quot;未結案&quot;.equals(Status)){
//							sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
//						}				
//				}
//		}
	//文件狀態

				var Status = Form.getValue(&quot;Status&quot;);	 
				if (!&quot;全部&quot;.equals(Status)) {
						if (&quot;已結案&quot;.equals(Status)) {
							sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM115 is not null &quot;;
						}else if (&quot;未結案&quot;.equals(Status)){
							sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
						}				
				}	
	
	// 用途說明
	var spec = Form.getValue(&quot;spec&quot;);	
	if (!&quot;&quot;.equals(spec)) {
		sSQL += &quot; AND ITEM15 like &apos;%&quot; + spec + &quot;%&apos;&quot;;
	}		
	// 品名規格
	var Subject = Form.getValue(&quot;Subject&quot;);	
	if (!&quot;&quot;.equals(Subject)) {
		sSQL += &quot; AND ITEM165 like &apos;%&quot; + Subject + &quot;%&apos;&quot;;
	}		
	return sSQL;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00061307586058505</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2015/07/01 17:34:53</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.scrap.client.Util</string> 
     </void> 
     <void property="id"> 
      <string>SCL00061307586058505</string> 
     </void> 
     <void property="name"> 
      <string>Util</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051307586042458</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//===================================================================
// 原物料報廢申請單-線邊倉子畫面顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){		
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var row = 0;	
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	var artIns = Form.getArtInstance() ;
	var dataMap = artIns.getAppDataMap() ;
	var tVector = dataMap.get(&quot;ResultTable&quot;);
	tVector.clear();
	var dataRow = null;	
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {						
			var record = null;			 
			dataRow = new java.util.HashMap();			
			record = vec.get(i);			
			var pno = dataMap.get(&quot;temp&quot;);
			if(pno.indexOf(record.get(&quot;rowid&quot;))&lt;0){
				dataRow.put(&quot;勾選&quot;,&quot;false&quot;);
			}else{
				dataRow.put(&quot;勾選&quot;,&quot;true&quot;);
			}
            dataRow.put(&quot;廠別&quot;,record.get(&quot;factory_no&quot;).trim());		
			dataRow.put(&quot;品名&quot;,record.get(&quot;item_no&quot;).trim());
			dataRow.put(&quot;站別&quot;,record.get(&quot;work_no&quot;).trim());
			dataRow.put(&quot;線別&quot;,record.get(&quot;line_no&quot;).trim());
			dataRow.put(&quot;規格&quot;,record.get(&quot;itdsc&quot;).trim());	
			dataRow.put(&quot;單位&quot;,record.get(&quot;unmsr1&quot;).trim());	
			dataRow.put(&quot;數量&quot;,record.get(&quot;scrp_qty&quot;).trim());	
			dataRow.put(&quot;報廢面積(SF)&quot;,record.get(&quot;sf&quot;).trim());	
			dataRow.put(&quot;版序&quot;,record.get(&quot;gce_ver&quot;).trim());
			dataRow.put(&quot;年&quot;,record.get(&quot;period_year&quot;).trim());
			dataRow.put(&quot;月&quot;,record.get(&quot;period_month&quot;).trim());
			dataRow.put(&quot;rowid&quot;,record.get(&quot;rowid&quot;).trim());	
			tVector.add(dataRow);
			Form.setValue(&quot;ResultTable&quot;,tVector);	

		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關資料！&quot;);
	}
}

//===================================================================
// 常用應用程式-已簽核表單查詢 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTableA(P){		
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var row = 0;	
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	var artIns = Form.getArtInstance() ;
	var dataMap = artIns.getAppDataMap() ;
	var tVector = dataMap.get(&quot;ResultTable&quot;);
	tVector.clear();
	var dataRow = null;	
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {						
			var record = null;			 
			dataRow = new java.util.HashMap();			
			record = vec.get(i);					
			dataRow.put(&quot;序&quot;,(i+1)+&quot;&quot;);
			dataRow.put(&quot;流程名稱&quot;,record.get(&quot;flow_name&quot;));
			dataRow.put(&quot;關卡名稱&quot;,record.get(&quot;proces_name&quot;));
			dataRow.put(&quot;工作主題&quot;,record.get(&quot;keyword&quot;));
			dataRow.put(&quot;送達時間&quot;,record.get(&quot;starttime&quot;));
			dataRow.put(&quot;結束時間&quot;,record.get(&quot;endtime&quot;));
			dataRow.put(&quot;tskid&quot;,record.get(&quot;tskid&quot;));
			dataRow.put(&quot;insid&quot;,record.get(&quot;insid&quot;));
			tVector.add(dataRow);
			Form.setValue(&quot;ResultTable&quot;,tVector);			

		}


	} else {
		Form.showMessageDialog(&quot;查無任何相關資料！&quot;);
	}
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00071105353068885</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/01/10 18:31:08</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.CheckExpenseApproval</string> 
     </void> 
     <void property="id"> 
      <string>SCL00071105353068885</string> 
     </void> 
     <void property="name"> 
      <string>CheckExpenseApproval</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>// 檢查審核意見是否有勾選
function checkApproval(){
	var radioAgree = Form.getValue(&quot;radioAgree&quot;);
	var radioReject = Form.getValue(&quot;radioReject&quot;);
	
	
	Form.setComplete(false);
	var message = &quot;&quot;;

	if(!radioAgree.equals(&quot;true&quot;) &amp;&amp; !radioReject.equals(&quot;true&quot;)){
		message += &quot;請選擇「同意」或「駁回」!!&quot;;
	}
	
	var taSuggest = Form.getValue(&quot;taSuggest&quot;).trim();
	var cbRejectReason = Form.getValue(&quot;cbRejectReason&quot;);
	if(radioReject.equals(&quot;true&quot;)  &amp;&amp; cbRejectReason.equals(&quot;無&quot;) &amp;&amp; taSuggest.equals(&quot;&quot;)){
		message += &quot;請選擇「駁回原因」!!&quot;;
	}
        
	if(message.equals(&quot;&quot;)){
		return true;
	}else{
		Form.showMessageDialog(message);
		return false;
	}
}
// 檢查審核意見是否有勾選
function checkApproval2(){
	var radioAgree = Form.getValue(&quot;radioAgree&quot;);
	var radioReject = Form.getValue(&quot;radioReject&quot;);
	
	
	Form.setComplete(false);
	var message = &quot;&quot;;

	if(!radioAgree.equals(&quot;true&quot;) &amp;&amp; !radioReject.equals(&quot;true&quot;)){
		message += &quot;請選擇「同意」或「駁回」!!&quot;;
	}
	
	var taSuggest = Form.getValue(&quot;taSuggest&quot;).trim();
	var cbRejectReason = Form.getValue(&quot;cbRejectReason&quot;);
	if(radioReject.equals(&quot;true&quot;)  &amp;&amp; (cbRejectReason.equals(&quot;---請選擇---&quot;) || taSuggest.equals(&quot;&quot;) ||cbRejectReason.equals(&quot;&quot;))){
		message += &quot;請選擇「駁回原因」及填寫意見!!&quot;;
	} 
        
	if(message.equals(&quot;&quot;)){
		return true;
	}else{
		Form.showMessageDialog(message);
		return false;
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>檢查審核人員是否有勾選同意或駁回選項,駁回時可只選預設的原因而不寫意見</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00071142688806091</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/03/18 21:33:26</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.ExcelExportFunction</string> 
     </void> 
     <void property="id"> 
      <string>SCL00071142688806091</string> 
     </void> 
     <void property="name"> 
      <string>ExcelExportFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//將指定的table元件內的資料匯出至Excel
function exportToExcel (index,workbook,objTable,sheetName,hidenColumns,bNewSheet){

	try {

		//建立工作表
		if (bNewSheet) 
			var newSheet = workbook.createSheet();
		else 
			var newSheet = workbook.getSheetAt(index);
			
			
		workbook.setSheetName(index, sheetName,new java.lang.Short(1));
		//取得 table 元件的的欄位列表			
		var columnList = objTable.getColumnNodeVector();
		var newColumnList = new java.util.Vector();
		java.lang.System.out.println(&quot;columnList:&quot; + columnList.toString());
		
		//去除不想匯出欄位	
		for(var i = 0; i &lt; columnList.size(); i++) {
			var columnName = columnList.get(i).toString();
			if (hidenColumns.indexOf(columnList.get(i).toString())==-1) {
				 newColumnList.add(columnName);
			}			
		}
		java.lang.System.out.println(&quot;newColumnList:&quot; + newColumnList.toString());
		
		//建立儲存格(標題)
		var headRow = newSheet.createRow(new java.lang.Short(0));
		for(var i = 0; i &lt; newColumnList.size(); i++) {
			 var columnName = newColumnList.get(i).toString();
			 
			 java.lang.System.out.println(&quot;columnName:&quot; + columnName.toString());
			
			 var headCell = headRow.createCell(new java.lang.Short(i));
			 headCell.setEncoding(new java.lang.Short(1));
			 headCell.setCellValue(columnName);
				
		 
		}	 
		 
		//建立儲存格(表格內容)
		for(var i = 0; i &lt; objTable.getRowCount(); i++){
			var contextRow = newSheet.createRow(new java.lang.Short(i+1));
			
			for (var j = 0; j &lt; newColumnList.size(); j++) {
				var columnName = newColumnList.get(j).toString();
   			    var contextCell = contextRow.createCell(new java.lang.Short(j));
				contextCell.setEncoding(new java.lang.Short(1));
				var contextCellData =  objTable.getValueAt(i,columnName).toString() ;
			    contextCell.setCellValue(contextCellData);
					

			}	
		
		}			
	
	} catch (e) {
		
		Form.showMessageDialog(&quot;資料無法匯出!!&quot;);
		java.lang.System.out.println(&quot;資料無法匯出!!&quot;); 
		java.lang.System.out.println(&quot;Error :&quot;+ e.toString()); 
	
    }		
	
}	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>Excel匯出功能</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00071157709108062</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/09/08 17:51:48</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ECN.TiptopClient</string> 
     </void> 
     <void property="id"> 
      <string>SCL00071157709108062</string> 
     </void> 
     <void property="name"> 
      <string>TiptopClient</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031157709081640</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

//--- test tiptop start ------
function updateERP_ECN(){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var ecn_no = dataMap.get(&quot;ECN_No&quot;);
	var tiptop_locate = dataMap.get(&quot;Tiptop_Locate&quot;);
	var tiptop_program_no = getSubString(dataMap.get(&quot;Tiptop_Program_No&quot;),&quot;a&quot;);
	var erp_message = &quot;&quot;;
	var line_message = &quot;&quot;;
	var flg = true; //flg = true 表示完全更新成功，可以結案。
	var vac = dataMap.get(&quot;TableAzp&quot;);
	for(var i = 0;i&lt; vac.size();i++){
		var checked = vac.get(i).get(&quot;ITEM1&quot;); //選取
		var updated = vac.get(i).get(&quot;ITEM4&quot;); //更新
		if(checked == &quot;true&quot; &amp;&amp; updated != &quot;Y&quot;){
			var tiptop_locate = vac.get(i).get(&quot;ITEM2&quot;); //代號		
			line_message = updateERP_ECNLine(tiptop_program_no,ecn_no,tiptop_locate); //line_message = &quot;Y&quot; or &quot;N&quot;
			//ITEM4 更新 ，只要有一個 tiptop locate 失敗 就送去等待再更新ERP
			vac.get(i).put(&quot;ITEM4&quot;,line_message);
			if(&quot;Y&quot; != line_message){
				flg = false;
			}
		}
	}
	
	erp_message += tiptop_locate + &quot;:&quot; + line_message + &quot; &quot;;
	dataMap.put(&quot;Tiptop_Message&quot;,erp_message);
	return flg;  //flg = true 表示完全更新成功，可以結案。
}
	
function updateERP_ECNLine(tiptop_program_no,ecn_no,tiptop_locate){
	try{
		var tiptop_y = &quot;N&quot;;
		//var tiptopclient = new Packages.com.ezlag.pittop.TipTopClient(host, port, encoding, userid,passwd);
		var tiptopclient = new Packages.com.ezlag.pittop.TipTopClient(&quot;192.168.1.13&quot;, 23, &quot;MS950&quot;, &quot;af&quot;,&quot;aflow&quot;);
		// udm4: 產品結構系統 -&gt; 工程變異管理 -&gt; 多主件工程變異單資料維護作業
		// abmi710: Q.查詢 -&gt; escape -&gt; escape -&gt; Y.確認
		/*
		tiptopclient.setField(&quot;aoos901&quot;, &quot;ff0_1_0&quot;, plantId).clickButton(&quot;udm4&quot;,
				&quot;產品結構系統&quot;).clickButton(&quot;udm4&quot;, &quot;工程變異管理&quot;).clickButton(&quot;udm4&quot;,
				&quot;多主件工程變異單資料維護作業&quot;).sendKey(&quot;abmi710&quot;, &quot;q&quot;).setField(&quot;abmi710&quot;,
				&quot;ff0_1_0&quot;, recNo).clickButton(&quot;abmi710&quot;, &quot;OK&quot;).clickButton(
				&quot;abmi710&quot;, &quot;OK&quot;).clickButton(&quot;abmi710&quot;, &quot;OK&quot;).sendKey(
				&quot;abmi710&quot;, &quot;y&quot;).clickDefaultButton(&quot;abmi710&quot;);
	*/
	// abmi710 多主件工程變異單資料維護作業
		if(tiptop_program_no==&quot;abmi710&quot;){
				tiptopclient.setField(&quot;aoos901&quot;, &quot;ff0_1_0&quot;, tiptop_locate).clickButton(&quot;udm4&quot;,
				&quot;產品結構系統&quot;).clickButton(&quot;udm4&quot;, &quot;工程變異管理&quot;).clickButton(&quot;udm4&quot;,
				&quot;多主件工程變異單資料維護作業&quot;).sendKey(tiptop_program_no, &quot;q&quot;).setField(tiptop_program_no,
				&quot;ff0_1_0&quot;, ecn_no).clickButton(tiptop_program_no, &quot;OK&quot;).clickButton(
				tiptop_program_no, &quot;OK&quot;).clickButton(tiptop_program_no, &quot;OK&quot;).sendKey(
				tiptop_program_no, &quot;y&quot;).clickDefaultButton(tiptop_program_no);
				tiptop_y = tiptopclient.getField(tiptop_program_no,&quot;ff8_18_0&quot;);	
		}else if(tiptop_program_no==&quot;abmi720&quot;){
		//abmi720 單一主件工程變異單資料維護作業
				tiptopclient.setField(&quot;aoos901&quot;, &quot;ff0_1_0&quot;, tiptop_locate).clickButton(&quot;udm4&quot;,
				&quot;產品結構系統&quot;).clickButton(&quot;udm4&quot;, &quot;工程變異管理&quot;).clickButton(&quot;udm4&quot;,
				&quot;單一主件工程變異單資料維護作業&quot;).sendKey(tiptop_program_no, &quot;q&quot;).setField(tiptop_program_no,
				&quot;ff0_1_0&quot;, ecn_no).clickButton(tiptop_program_no, &quot;OK&quot;).clickButton(
				tiptop_program_no, &quot;OK&quot;).sendKey(
				tiptop_program_no, &quot;y&quot;).clickDefaultButton(tiptop_program_no);
				tiptop_y = tiptopclient.getField(tiptop_program_no,&quot;ff5_15_0&quot;);
		}
		}catch(e){	
			tiptop_y = &quot;N&quot;;
		}
		tiptopclient.closeSafely(tiptop_program_no);
		//tiptopclient.close(); 不用這個

	return tiptop_y ;
}
//--- tiptop end ------

 
function getSubString(str,s){
	if(str.length()&gt;1){
		if(&quot;b&quot;.equals(s)){
			str = str.substring(str.lastIndexOf(&apos;_&apos;)+1); //後
		}else{
			str = str.substring(0,str.lastIndexOf(&apos;_&apos;)); //前
		}
	}
	return str;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00071197301741640</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/12/10 23:49:01</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.DMS.Doc_Change</string> 
     </void> 
     <void property="id"> 
      <string>SCL00071197301741640</string> 
     </void> 
     <void property="name"> 
      <string>Doc_Change</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011194752256531</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//切換「新增」「修改」「廢止」時要清資料
function clearDoc(){
		Form.setValue(&quot;Doc_ID&quot;,&quot;&quot;);
		Form.setValue(&quot;Doc_Type&quot;,&quot;&quot;);
		Form.setValue(&quot;Publish_Folder&quot;,&quot;&quot;);
		Form.setValue(&quot;Doc_Dep&quot;,Form.getValue(&quot;App_Dep&quot;)); //帶申請人的部門
		Form.setValue(&quot;Doc_Level&quot;,&quot;&quot;);	
		Form.setValue(&quot;Doc_Version&quot;,&quot;01&quot;) //版本預設為01
		Form.setValue(&quot;Doc_New_Version&quot;,&quot;&quot;);
		Form.setValue(&quot;Doc_Name&quot;,&quot;&quot;);
		Form.setValue(&quot;Doc_Desc&quot;,&quot;&quot;);
		Form.setValue(&quot;Doc_Key&quot;,&quot;&quot;);
		Form.setValue(&quot;Doc_DepID&quot;,Form.getValue(&quot;App_DepID&quot;)); //帶申請人的部門
		Form.setValue(&quot;Doc_Type_ID&quot;,&quot;&quot;);
		Form.setValue(&quot;Publish_Folder_ID&quot;,&quot;&quot;);
		Form.getComponent(&quot;Table_RelatedLv4Doc&quot;).clear();
}

function setRadioButton(){
	var flg1 = false;
	var flg2 = false;
	var flg3 = false;	
	if(&quot;true&quot;.equals(Form.getValue(&quot;Change1&quot;))){
		flg1 = true;
	}else if(&quot;true&quot;.equals(Form.getValue(&quot;Change2&quot;))){
		flg2 = true;
	}else if(&quot;true&quot;.equals(Form.getValue(&quot;Change3&quot;))){
		flg3 = true;
	}
	//1
	Form.getComponent(&quot;Change11&quot;).setEnabled(flg1);	
	Form.getComponent(&quot;Change1_Name&quot;).setEnabled(flg1);	
	Form.getComponent(&quot;Change1_ECCB&quot;).setEnabled(flg1);		
	Form.getComponent(&quot;Change1_Yes&quot;).setEnabled(flg1);	
	Form.getComponent(&quot;Change1_No&quot;).setEnabled(flg1);		
	//2
	Form.getComponent(&quot;Change2_No&quot;).setEnabled(flg2);
	Form.getComponent(&quot;Change2_Yes&quot;).setEnabled(flg2);	
	Form.getComponent(&quot;Change2_Name&quot;).setEnabled(flg2);	
	//3
	Form.getComponent(&quot;Change31&quot;).setEnabled(flg3);	
	Form.getComponent(&quot;Change3_Date&quot;).setEnabled(flg3);	
	Form.getComponent(&quot;Change3_Name&quot;).setEnabled(flg3);		
	Form.getComponent(&quot;Change3_Yes&quot;).setEnabled(flg3);	
	Form.getComponent(&quot;Change3_No&quot;).setEnabled(flg3);		
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>文件變更申請單</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00071211441967003</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/07/03 14:58:49</string> 
     </void> 
     <void property="fullName"> 
      <string>com.eland.dms.Client</string> 
     </void> 
     <void property="id"> 
      <string>SCL00071211441967003</string> 
     </void> 
     <void property="name"> 
      <string>Client</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011203496283609</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/**
 載入上一版的通知名單
*/

function setPreNoticeList(){
	var GCE_Doc_Sn = Form.getValue(&quot;GCE_Doc_Sn&quot;);
	var GCE_Ver_Sn = Form.getValue(&quot;GCE_Ver_Sn&quot;);
	var vFactory = Form.getValue(&quot;Factory&quot;);
	if(&quot;B&quot;==GCE_Ver_Sn){
		var sql = &quot;select max(insid) insid from ART00001192729061671_Ins where item84 = &apos;&quot; + GCE_Doc_Sn + &quot;&apos; and  item2 =&apos;&quot;+ vFactory + &quot;&apos; and insid !=&apos;&quot;+ Form.getArtInstance().getID() +&quot;&apos; and item155 !=&apos;true&apos;&quot;; //item155 Cancel
	}else{
		var sql = &quot;select max(insid) insid from &quot;+ Form.getArtifactID() +&quot;_Ins where item84 = &apos;&quot; + GCE_Doc_Sn + &quot;&apos; and  item2 =&apos;&quot;+ vFactory + &quot;&apos; and insid !=&apos;&quot;+ Form.getArtInstance().getID() +&quot;&apos; and item155 !=&apos;true&apos;&quot;; //item155 Cancel
	}			
	var vec = Client.SQLloadValue(sql);
	if(vec != null &amp;&amp; vec.size()&gt;0 &amp;&amp; &quot;&quot; != vec.get(0).get(&quot;insid&quot;) ){
		var insid = vec.get(0).get(&quot;insid&quot;);
		var ins = Client.getArtInstance(insid);
		var dataMap = ins.getAppDataMap();
		if(dataMap != null){
			Form.setValue(&quot;TableA&quot;,dataMap.get(&quot;TableA&quot;));
		}
	}
}

/**
select * from isoeka where
isoeka003 = &apos;G-QP-09-06&apos;  文件編號
and isoeka004 = &apos;O&apos;          文件版號
and isoeka006 = &apos;ISOE000&apos;     通知單類別：ISOE000:失效通知單
select distinct(resdb007) from resdb where
resdb001 = &apos;ISOE002&apos;
and resdb002 = &apos;0000014054&apos;   通知單編號 
*/
	
function setOldNoticeList(){
		var message = &quot;&quot;;
		var vFactory = Form.getValue(&quot;Factory&quot;);
		//EF2KWeb  --&gt;&gt; 改EZFlow
		var GCE_Doc_Sn = Form.getValue(&quot;GCE_Doc_Sn&quot;);
		try{
			if( vFactory==&quot;(TGCE)&quot; ){
				var conn_ez = Client.createSessionConnection(&quot;EZFlow&quot;);
			}
			if( vFactory==&quot;(SGCE)&quot; ){
				var conn_ez = Client.createSessionConnection(&quot;EZFlow_S&quot;);
			}		
			if( vFactory==&quot;(CGCE)&quot; ){
				var conn_ez = Client.createSessionConnection(&quot;EZFlow_C&quot;);
			}					
			
//				var conn_ez = Client.createSessionConnection(&quot;EZFlow&quot;);
//				var sql_iso = &quot; select * from isoeka where isoeka003 = &apos;&quot;+ GCE_Doc_Sn +&quot;&apos; order by isoeka005 desc  &quot;;  // 005 是日期
				var sql_iso = &quot; select * from isoeka where isoeka003 = &apos;&quot;+ GCE_Doc_Sn +&quot;&apos; order by isoeka004 desc  &quot;;  // 004 是文件版本
				var vec_iso = conn_ez.loadValue(sql_iso);
				if(vec_iso != null  &amp;&amp; vec_iso.size()&gt;0){
							var sql_res = &quot; select distinct(resdb007) resdb007 from resdb where resdb001 = &apos;&quot;+ vec_iso.get(0).get(&quot;isoeka001&quot;) +&quot;&apos; and resdb002 = &apos;&quot;+ vec_iso.get(0).get(&quot;isoeka002&quot;) +&quot;&apos;&quot; ;
							var vec_res = conn_ez.loadValue(sql_res);
							if(vec_res != null  &amp;&amp; vec_res.size()&gt;0){
								var table = Form.getComponent(&quot;TableA&quot;);
								table.clear();
								var factory = Form.getValue(&quot;Factory&quot;);
								var mem_pre = &quot;MEMT1&quot;;
								if(&quot;CGCE&quot; == factory){
									mem_pre = &quot;MEMC1&quot;;
								}else if(&quot;SGCE&quot; == factory){
									mem_pre = &quot;MEMS1&quot;;
								}
								for( var i=0;i&lt;vec_res.size();i++ ){
									var id = vec_res.get(i).get(&quot;resdb007&quot;);
									var member = Client.getMember(mem_pre + id);
									if(member != null){
										var row = table.newRow()-1;
										table.setValueAt(member.getID(),row,&quot;ID&quot;);
										table.setValueAt(member.getID(),row,&quot;MEMID&quot;);
										table.setValueAt(member.getName(),row,&quot;通知名單&quot;);
									}
								}
							}
				}else{
					message = &quot;沒有對應的名單!&quot;;
				}
				
		}catch(e){ 					
			message = &quot; load member list Exception !&quot;;
		}
			if(conn_ez != null)	{
				try	{
					conn_ez.commit();
				}catch(e){}
				conn_ez.close();
			}
		if(message != &quot;&quot;){
			Form.showMessageDialog(message);
		}
}
// add by wangwei@2010/10/15 依新增的ISO path設定廠別
// 解決跨廠人員新增及變更文件
// 再加上是否為全廠共用的文件 add by wangwei@2010/11/15 
function setFactoryByPath(){
	var vReturn =&quot;&quot;;
	var vDOC_ID= Form.getValue(&quot;Doc_ID&quot;);
	var vVER_ID= Form.getValue(&quot;Ver_ID&quot;);
	var conn_eKM = Client.createSessionConnection(&quot;EKM&quot;);
	 try{
		 var vSQL = &quot;SELECT eland_category.path  path FROM techdoc_version ,eland_category &quot;;    
		     vSQL = vSQL + &quot; WHERE ( techdoc_version.category_id = eland_category.category_id ) and  &quot;;
			 vSQL = vSQL + &quot; (  techdoc_version.doc_id =&apos;&quot;+vDOC_ID+&quot;&apos; and techdoc_version.ver_id = &apos;&quot;+vVER_ID+&quot;&apos;)&quot;		 
		var vec = conn_eKM.loadValue(vSQL);		
		 if(vec.size() &gt; 0 ){
// 預設依USER所屬廠別			 
			 vPATH = vec.get(0).get(&quot;path&quot;);  
			 if(vPATH.indexOf(&quot;hgce&quot;)&gt;0){
				 Form.setValue(&quot;Factory&quot;,&quot;(HGCE)&quot;);
			 }
			 if(vPATH.indexOf(&quot;suzhou_root&quot;)&gt;0){
				 Form.setValue(&quot;Factory&quot;,&quot;(SGCE)&quot;);
			 }	
			 if(vPATH.indexOf(&quot;changshu_root&quot;)&gt;0){
				 Form.setValue(&quot;Factory&quot;,&quot;(CGCE)&quot;);
			 }		
			 if(vPATH.indexOf(&quot;taiwan_root&quot;)&gt;0){
				 Form.setValue(&quot;Factory&quot;,&quot;(TGCE)&quot;);
			 }					 
// 若屬全廠共用文件,則將表單欄位set &quot;全廠共用&quot;
			 if(vPATH.indexOf(&quot;share_root&quot;)&gt;0){
				 var vDep = Form.getValue(&quot;App_DepID&quot;);
				 vReturn = &quot;share&quot;;
//				 setAssoc(vDep);　　// function 在下面 不要問function call function
			 }else{
				 Form.setValue(&quot;share_root&quot;,&quot;&quot;);
			 }
		 }
	 }catch(e){
	 }finally{
		 conn_eKM .close();
	 }
	 return vReturn; // 回傳若是全廠共用則== share		
}

//設定共用文件會簽人員
function setAsMem(){
	addAsMember(&quot;MEMT1032095&quot;);//吳雅雯
	addAsMember(&quot;MEMS1000244&quot;);//黎祥
	addAsMember(&quot;MEMH1021866&quot;);//庹峰
	addAsMember(&quot;MEMC1008827&quot;);//顧祥飛
}
function addAsMember(userid){
	var tableD = Form.getComponent(&quot;TableD&quot;);
	var flag = true;
	if(tableD.getRowCount() &gt; 0 ){
		for(var j = 0;j&lt; tableD.getRowCount();j++){
			if (userid.equals(tableD.getValueAt(j,&quot;MEMID&quot;))){
				flag = false;				// &gt;0 表示已先有選要 check 一下有無重複，重複就不塞了 
			}
		}
	}
	if(flag){
		var row = tableD.newRow()-1;
		tableD.setValueAt(userid ,row,&quot;ID&quot;);
		tableD.setValueAt(userid,row,&quot;MEMID&quot;); 
		tableD.setValueAt(Client.getMemberByID(userid).getName(),row,&quot;會簽名單&quot;);	
	}			
	
	
}

// 設定全廠會簽文入相對應之會簽人員 課級主管及理級主管
function setAssoc(vDep){
	var tableC = Form.getComponent(&quot;TableC&quot;);
	var tableD = Form.getComponent(&quot;TableD&quot;);
	if(&quot;&quot;==vDep){
		var vDep = Form.getValue(&quot;App_DepID&quot;);		
		}
	Form.setValue(&quot;share_root&quot;,&quot;全廠共用&quot;);
	var vDeptno = vDep.substring(4,7)   // 取出來的 == 2F0
	var vDepLike = vDep.substring(5,7)   // 取出來的 == F0
// 讀他廠對應單位之課級主管	042 ~ 064
	var vSQL = &quot;select memid,username, mainroleid,loginid ,substr(mainroleid,8,3) from mem_geninf where  substr(mainroleid,8,3) &gt;=&apos;042&apos; and substr(mainroleid,8,3) &lt;=&apos;064&apos; and resign =&apos;false&apos; and &quot;;
	    vSQL = vSQL +&quot; mainroleid like &apos;%&quot;+vDepLike+&quot;%&apos; and mainroleid not like &apos;%&quot;+vDeptno+&quot;%&apos;&quot; ; 
	var vec = Client.SQLloadValue(vSQL);
// 注意迴圈...	
	if(vec.size()&gt;0){  // 判斷是否有資料
		for(var i=0;i&lt;vec.size();i++){	// 有資料則RUN LOOP
			var flag = true;	// 再檢核table中是否已有資料	
			var vID = vec.get(i).get(&quot;memid&quot;) ;
			if(tableC.getRowCount() &gt; 0 ){
				for(var j = 0;j&lt; tableC.getRowCount();j++){
					if (vID.equals(tableC.getValueAt(j,&quot;MEMID&quot;))){
						flag = false;				// &gt;0 表示已先有選要 check 一下有無重複，重複就不塞了 
					}
				}
			}				
			if(flag){
				var row = tableC.newRow()-1;
				tableC.setValueAt(vec.get(i).get(&quot;memid&quot;) ,row,&quot;ID&quot;);
				tableC.setValueAt(vec.get(i).get(&quot;memid&quot;),row,&quot;MEMID&quot;); 
				tableC.setValueAt(vec.get(i).get(&quot;username&quot;),row,&quot;會簽名單&quot;);		
// 以課級主管讀取直屬主管, 理論上應是取得理級主管	
				var vMEM = Client.getMember(vID);	
				var vPager = vMEM.getPager();
				var flag = true;	// 再檢核table中是否已有資料	
				if(tableD.getRowCount() &gt; 0 ){
					for(var j = 0;j&lt; tableD.getRowCount();j++){
						if (vPager.equals(tableD.getValueAt(j,&quot;MEMID&quot;))){
							flag = false;				// &gt;0 表示已先有選要 check 一下有無重複，重複就不塞了 
						}
					}
				}	
				if(flag){
					var vManager = Client.getMember(vPager); // 直屬主管
					var row = tableD.newRow()-1;
					tableD.setValueAt(vPager ,row,&quot;ID&quot;);
					tableD.setValueAt(vPager,row,&quot;MEMID&quot;); 
					tableD.setValueAt(vManager.getName(),row,&quot;會簽名單&quot;);		
				}
			}							
		}
	}	
}


</string> 
     </void> 
     <void property="synopsis"> 
      <string>表單上用</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00071213180226962</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/11/22 13:48:47</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Server.Process</string> 
     </void> 
     <void property="id"> 
      <string>SCL00071213180226962</string> 
     </void> 
     <void property="name"> 
      <string>Process</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00281213180209899</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//===================================================
 //金像一般表單編碼方式為 = 廠別(1碼) ＋ 專案代號(2碼) ＋ YY ＋ MM ＋ &apos;-&apos; ＋ XXXXX 
 //ex:TA10803-00001
 //&quot;07&quot;年份 ,&quot;06&quot; 月 , &quot;43&quot; 週 , &quot;00099&quot;流水號。 
 // pro= &quot;A1&quot;表單代碼
 // artid = ART00101173841772296_Ins
 // itemid = ITEM143 (Sn)
 //===================================================
 //Parameters:itemid=flow表單代碼;pro=表單代碼
    function setPLMNum(docType,itemid)
    {
	   try{
	   var sn = &quot;&quot;;			
       var isoNum=null;
	   var artIns = MyTask.getArtInstance(); 
	   var dataMap = artIns.getAppDataMap();
	   var cancel = dataMap.get(&quot;Cancel&quot;);
	   var GCE_Doc_Sn = dataMap.get(&quot;GCE_Doc_Sn&quot;);
	   var App_Dep_ID = dataMap.get(&quot;App_Dep_ID&quot;);
	   var artid = artIns.getArtifactID();
	    //抓取使用者相關資料
	   var mID = MyTask.getRealExecutor();
	   var cMember = Server.getMemberByID(mID);	
	   var sCompanyID = cMember.getAreaCode(); //使用者公司代碼	
   	   var year = new java.text.SimpleDateFormat(&quot;y&quot;).format(new java.util.Date()); // 07
	   var month = new java.text.SimpleDateFormat(&quot;M&quot;).format(new java.util.Date()); // 07
	   var day = new java.text.SimpleDateFormat(&quot;d&quot;).format(new java.util.Date()); // 07
 	   //month 補0
	   if(month.length() == 1){ month = &quot;0&quot; + month; }	
	   if(day.length() == 1){ day = &quot;0&quot; + day; }		
	   
        if( docType.equals(&quot;GCE2&quot;) ){        //客戶資料待確認單
            isoNum = &quot;MQP0202&quot;;
			sn = GCE_Doc_Sn + &quot;-&quot; + isoNum ; 
		}
		 else if ( docType.equals(&quot;GCE3&quot;) ){            //ECR
            isoNum = &quot;MQP0202&quot;;
			sn = GCE_Doc_Sn +&quot;-&quot;+ sCompanyID.substring(0,1)+ &quot;BD&quot; + year +&quot;-&quot;+ getECRSequence(itemid) ; 
		}
		else if ( docType.equals(&quot;GCE4&quot;) ){            //ECN
            isoNum = &quot;MQP0202&quot;;
			sn = GCE_Doc_Sn + &quot;-&quot; + isoNum ; 
		}
        else if ( docType.equals(&quot;GCE5&quot;) ){      //工程矯正回饋單
            isoNum = &quot;MQP0302&quot;;
			sn = GCE_Doc_Sn + &quot;-&quot; + isoNum ;
		}
        else if ( docType.equals(&quot;GCE6&quot;) ){      //製程條件變更單
            isoNum = &quot;MQP0302&quot;;
			sn = GCE_Doc_Sn + &quot;-&quot; + year + &quot;-&quot; + month + &quot;-&quot; + day + &quot;-&quot; + getMECNSequence(itemid) + &quot;-&quot; + App_Dep_ID ;
		}		
        else if ( docType.equals(&quot;GCE7&quot;) ){  //孔徑圖資料表
            isoNum = &quot;APERTURE&quot;;
			sn = GCE_Doc_Sn + &quot;-&quot; + isoNum ;
		}   
        else if ( docType.equals(&quot;GCE8&quot;) ){ //阻抗控制參數表
            isoNum = &quot;MWI0401&quot;;
			sn = GCE_Doc_Sn + &quot;-&quot; + isoNum ;
		}
        else if ( docType.equals(&quot;GCE9&quot;) ){ //壓合結構
            isoNum = &quot;MWI0407&quot;;
			sn = GCE_Doc_Sn + &quot;-&quot; + isoNum ;
		}    
        else if ( docType.equals(&quot;GCE10&quot;) ){ //客戶資料簽收單
            isoNum = &quot;MQP0102E&quot;;
			sn = GCE_Doc_Sn + &quot;-&quot; + isoNum ; 
		}   
        else if ( docType.equals(&quot;GCE11&quot;) ){ //CAM文件
            isoNum = &quot;MQP0102E&quot;;
			sn = GCE_Doc_Sn + &quot;-&quot; + isoNum ; 
		} 		
        else if ( docType.equals(&quot;GCE12&quot;) ){  //NC成型
            isoNum = &quot;NC&quot;; 
			sn = GCE_Doc_Sn + &quot;-&quot; + isoNum ;
		}    
        else if ( docType.equals(&quot;GCE15&quot;) ){  //發料通知單
            isoNum = &quot;NC&quot;; 
			sn = GCE_Doc_Sn + &quot;-&quot; + isoNum ;
		}   		
		dataMap.put(&quot;GCE_Doc_Sn&quot;,sn);
		dataMap.put(&quot;Sn&quot;,sn);
		}catch(e){}
    }

/*
    function getMECNSequence(itemid)
    {
		var year = new java.text.SimpleDateFormat(&quot;y&quot;).format(new java.util.Date()); // 07
  	    var month = new java.text.SimpleDateFormat(&quot;M&quot;).format(new java.util.Date()); // 07
 	    var day = new java.text.SimpleDateFormat(&quot;d&quot;).format(new java.util.Date()); // 07
		if(month.length() == 1){
			month = &quot;0&quot; + month;
		}	
		if(day.length() == 1){
			day = &quot;0&quot; + day;
		}					
        var seq =&quot;&quot;;
        //如月-日-年-流水號-2J1&amp;2J2
		//如年-月-日-流水號-2J1&amp;2J2
        seq = year + &quot;-&quot; + month + &quot;-&quot; + day + &quot;-&quot; + this.getSequence() + &quot;-&quot; + this.getDepartmentMap(docNumber);
        //如月-日-年-流水號
        //seq = this.getDateString() + &quot;-&quot; + this.getSequence();
        //System.out.println( &quot;sequence=&quot; + seq );
        return seq;	    
    }
*/	
function getMECNSequence(itemid){
	   try{
	   var artIns = MyTask.getArtInstance(); 
	   var artid = artIns.getArtifactID(); 
		var sn_n = &quot;00001&quot;;			   
		var sql_sn = &quot; select max(substr(&quot;+itemid+&quot;,-5,5))  MAXNO from &quot;+ artid +&quot;_Ins &quot;; // oracel
		var vec_sn = Server.SQLloadValue(sql_sn);
		if(vec_sn != null &amp;&amp; vec_sn.size()&gt;0 &amp;&amp; vec_sn.get(0).get(&quot;MAXNO&quot;) != &quot;&quot;){
			var maxno_str = vec_sn.get(0).get(&quot;MAXNO&quot;);
			var maxno_int = java.lang.Integer.parseInt(maxno_str) + 1;
			var sn_n = java.lang.Integer.toString(maxno_int);
			//補0
			if(sn_n.length() == 1){
				sn_n = &quot;0000&quot; + sn_n;
			}else if(sn_n.length() == 2){
				sn_n = &quot;000&quot; + sn_n;
			}else if(sn_n.length() == 3){
				sn_n = &quot;00&quot; + sn_n;
			}else if(sn_n.length() == 4){
				sn_n = &quot;0&quot; + sn_n;
				}				   
			}
		}catch(e){}
		return sn_n;   
    }
	
function getEQequence(){
		var year = new java.text.SimpleDateFormat(&quot;y&quot;).format(new java.util.Date());
        var seq =&quot;&quot;;
        seq = year + &quot;-&quot; + this.getSequenceEQ() ;
        return seq;
    }
	
//=========	
function getECRSequence(itemid){
	   try{
	   var artIns = MyTask.getArtInstance(); 
	   var artid = artIns.getArtifactID(); 
		var sn_n = &quot;00001&quot;;			   
		var sql_sn = &quot; select max(substr(&quot;+itemid+&quot;,-5,5))  MAXNO from &quot;+ artid +&quot;_Ins &quot;; // oracel
		var vec_sn = Server.SQLloadValue(sql_sn);
		if(vec_sn != null &amp;&amp; vec_sn.size()&gt;0 &amp;&amp; vec_sn.get(0).get(&quot;MAXNO&quot;) != &quot;&quot;){
			var maxno_str = vec_sn.get(0).get(&quot;MAXNO&quot;);
			var maxno_int = java.lang.Integer.parseInt(maxno_str) + 1;
			var sn_n = java.lang.Integer.toString(maxno_int);
			//補0
			if(sn_n.length() == 1){
				sn_n = &quot;0000&quot; + sn_n;
			}else if(sn_n.length() == 2){
				sn_n = &quot;000&quot; + sn_n;
			}else if(sn_n.length() == 3){
				sn_n = &quot;00&quot; + sn_n;
			}else if(sn_n.length() == 4){
				sn_n = &quot;0&quot; + sn_n;
				}				   
			}
		}catch(e){}
		return sn_n;   
    }
//==============	
function getSn(itemid){
	   try{
	   var artIns = MyTask.getArtInstance(); 
	   var artid = artIns.getArtifactID(); 
		var sn_n = &quot;00001&quot;;			   
		var sql_sn = &quot; select max(substr(&quot;+itemid+&quot;,-5,5))  MAXNO from &quot;+ artid +&quot;_Ins where &quot;+ itemid + &quot; LIKE &apos;&quot;+ sn5 +&quot;%&apos;&quot;; // oracel
		var vec_sn = Server.SQLloadValue(sql_sn);
		if(vec_sn != null &amp;&amp; vec_sn.size()&gt;0 &amp;&amp; vec_sn.get(0).get(&quot;MAXNO&quot;) != &quot;&quot;){
			var maxno_str = vec_sn.get(0).get(&quot;MAXNO&quot;);
			var maxno_int = java.lang.Integer.parseInt(maxno_str) + 1;
			var sn_n = java.lang.Integer.toString(maxno_int);
			//補0
			if(sn_n.length() == 1){
				sn_n = &quot;0000&quot; + sn_n;
			}else if(sn_n.length() == 2){
				sn_n = &quot;000&quot; + sn_n;
			}else if(sn_n.length() == 3){
				sn_n = &quot;00&quot; + sn_n;
			}else if(sn_n.length() == 4){
				sn_n = &quot;0&quot; + sn_n;
				}				   
			}
		}catch(e){}
		return sn_n;		
	}
	
//========================================================================================
// 會簽子流程抓取流程線ID 程式
//========================================================================================

//取 ArtStateID 20091012

function getStateID(ins,state_name){
        var stateid = &quot;&quot;;
        var sql_art = &quot; select ASTID from ART_STATE where ARTID=&apos;&quot;+ ins +&quot;&apos; and NAME =&apos;&quot;+ state_name +&quot;&apos;&quot;;
        var vec_art = Server.SQLloadValue(sql_art);
        if(vec_art !=null &amp;&amp; vec_art.size()&gt;0  ){
            stateid = vec_art.get(0).get(&quot;ASTID&quot;);
        }
        return stateid;
}

//=========================================
//PDM 會簽子流程，Complete 或 Waitting 
//=========================================
function pdm_sub_process(SignTable,SignTable_G,nextflow,temp){	
	//20091006 cc
	//如果 Agree
		//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
		//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
		//A3.查出要 complete 的 task,進行 complete
		//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
		//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
	
	//如果是 reject 
		//R1.查出要 complete 的 task,進行 complete
		//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回填單人	
	try{
		var flg = false;
		var groupid = &quot;&quot;;
		var memid_str = &quot;&apos;administrator&apos;&quot;;
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
		var project_id =MyTask.projectID;
		var Source_Ins_ID = dataMap.get(&quot;Source_Ins_ID&quot;);   // 這個是由資料拋轉(DDT)傳入的,是母表單的INSID
		var Source_Ins = Server.getArtInstance(Source_Ins_ID);
		var agree = dataMap.get(&quot;Agree&quot;);
		
		loadLibrary(&quot;com.A.Common.Server.Process&quot;);
	    setProcessTable_ext();
 	    Server.updateArtInstance(Source_Ins);
		
		//檢查紀錄會簽子流程名單table,若無資料則代表不正常,mail通知系統負責人  
			//add by edison@20130322
			var process_name = MyTask.getProcessName();
			if( Source_Ins != null ){
				var source_datamap = Source_Ins.getAppDataMap();
				var Assign_Table = source_datamap.get(&quot;Assign_Table&quot;);
				var Assign_Table_G = source_datamap.get(&quot;Assign_Table_G&quot;);
				if(Assign_Table!=null &amp;&amp; Assign_Table_G!=null &amp;&amp; (Assign_Table.size()==0 || Assign_Table_G.size()==0)){
				//if(true){	
					try{
						var aInstance = MyTask.getArtInstance(); 
						var dataMap = aInstance.getAppDataMap(); 
						var roottaskname = MyTask.getRootName();
						var from = Server.getMember(&quot;administrator&quot;).getEmail(); 					
						var to = &quot;edison_wang@gce.com.tw&quot;;
						var cc = &quot;&quot;;
						var subject = &quot;[PDM異常通知]&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot; 所申請-&quot; + roottaskname+&quot;(&quot;+process_name+&quot;)&quot; +&quot; 單號:&quot;+dataMap.get(&quot;Sn&quot;); // Mail Subject 
						var text = &quot;Assign_Table 沒資料!!&quot;;
						var fileList = new Packages.java.util.Vector(); 
						Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
					}catch(e){}
				}
			}
		
//		var SignTable = &quot;MemTable_DE_Reply&quot;;
//		var SignTable_G = &quot;MemTable_DE_Reply_G&quot;;
//		var nextflow = &quot;客戶已回覆完成&quot;;

		if( agree == &quot;true&quot;){
			//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
			if(Source_Ins != null){
				var source_dataMap = Source_Ins.getAppDataMap();
				var MemberTable_MAN = source_dataMap.get(SignTable);  // 這個table 是在母表單,是記錄會簽的人員
				var exeid = MyTask.getMemberID();
				var rootmemid = Server.getTask(MyTask.getRootID()).getMemberID();//取得原本該簽的人 add by edison@20130925
//                var exeid =dataMap.get(&quot;Verify_MemberID&quot;);
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var memid = MemberTable_MAN.get(s).get(&quot;ITEM1&quot;);
						
						if(memid.equals(exeid) || memid.equals(rootmemid)){
							groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);
							s = MemberTable_MAN.size();
							flg = true;
						}
					}
				}
			}

			//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
			if(flg &amp;&amp; groupid != &quot;&quot;){
				flg = false;
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var r_groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);   // 注意這是ITEM不是欄位的名稱
						if(r_groupid.equals(groupid)){
							//同 groupid 
							memid_str += &quot;,&apos;&quot;+ MemberTable_MAN.get(s).get(&quot;ITEM1&quot;) + &quot;&apos;&quot;;
							//memid_str += &quot;,&apos;&quot;+ MemberTable_MAN.get(s).get(&quot;ITEM1&quot;) + &quot;&apos;&quot; + getDuty(MemberTable_MAN.get(s).get(&quot;ITEM1&quot;));//加入代理人
						}
					}
					flg = true;
				}
			}

			//A3.查出要 complete 的 task,進行 complete
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
				var artExitStateID = getStateID(Source_Ins.getArtifactID(),&quot;完成&quot;); //完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
//				var artExitStateID = &quot;AST00471254125966334&quot;;//完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
			// 找出由root觸發出來的子流程
				//modi by edison@20111201 抓exeid會有代理人問題,導致子流程未被結案,但行政管理師轉單仍須注意,需再去改會簽清單
				//var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and exeid in (&quot;+ memid_str +&quot;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;; 				
				var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and memid in (&quot;+ memid_str +&quot;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;; 
				var vec_t = Server.SQLloadValue(sql_t);
				if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
					try{  // 把try catch move from for loop modi by wangwei@2011/12/14
						for(var r = 0;r&lt;vec_t.size();r++){
								var r_task = Server.getTask(vec_t.get(r).get(&quot;tskid&quot;));
								if(r_task != null){
									Server.completeTask(r_task,artExitStateID);
								}
						}
					}catch(e){}
				}
			}
			Server.addDebugLog(&quot;pdm_sub_process_flg3=&quot;+flg);
			//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
			if(flg &amp; groupid != &quot;&quot;){
				var Table_Group = source_dataMap.get(SignTable_G);				
				if(Table_Group != null &amp;&amp; Table_Group.size()&gt;0){
					for(var r=0;r&lt;Table_Group.size();r++){
						var hm = Table_Group.get(r);
						var r_groupid = hm.get(&quot;ITEM1&quot;);
						if(groupid.equals(r_groupid)){
							hm.put(&quot;ITEM2&quot;,true);
							hm.put(&quot;ITEM3&quot;,agree);							
							//r = Table_Group.size();//需整個走完才知道是不是所有的 group 都已完成
							Table_Group.set(r,hm);
							Source_Ins.setAppValue(SignTable_G,Table_Group);

						}else{
							var r_complete = hm.get(&quot;ITEM2&quot;);//complete
							if(&quot;false&quot; == r_complete){
								//只要有一個未完成就是未完成
								flg = false;
							}
						}
					}
				}
			}

			//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),nextflow);  
//				var artExitStateID = &quot;AST00421254125327838&quot;;   //會簽完成  ========&gt;&gt; 母流程的會簽完成
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;);
				var task_wait = Server.getTask(TaskID_Wait);
				if(task_wait != null &amp;&amp; &quot;complete&quot; != task_wait.getTaskState()){
					Server.completeTask(task_wait,artExitStateID);

				}
			}
		}
		if( agree == &quot;false&quot;){
			//Reject
			//R1.查出要 complete 的 task,進行 complete
			//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回填單人			
			//R1.查出全部未 complete 的 task,進行 complete
//			    loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
				var artExitStateID = getStateID(Source_Ins.getArtifactID(),&quot;完成&quot;);
//				var artExitStateID = &quot;AST00471254125966334&quot;;		//完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
				var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;;
				var vec_t = Server.SQLloadValue(sql_t);
				if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
					for(var r = 0;r&lt;vec_t.size();r++){
						var r_task = Server.getTask(vec_t.get(r).get(&quot;tskid&quot;));
						if(r_task != null){
							try{
								Server.completeTask(r_task,artExitStateID);
							}catch(e){
								Server.addErrLog(&quot;Call pdm_sub_process Fail--- completeTask &quot;+r_task);
							}
						}
					}
					
				}
			//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回申請人
			if(Source_Ins != null ){
				var source_dataMap = Source_Ins.getAppDataMap();
                if (temp == &quot;&quot; ){ 
                     var back_app_user = &quot;退回申請人&quot;;
				}else{
				     var back_app_user = temp;
				}
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),back_app_user);
//				var artExitStateID = &quot;AST00361253948661023&quot;;//退回申請人     ========&gt;&gt; 母流程的退回申請人
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;);
				var task_wait = Server.getTask(TaskID_Wait);
				if(task_wait != null &amp;&amp; &quot;complete&quot; != task_wait.getTaskState()){
					Server.completeTask(task_wait,artExitStateID);
				}
			}
		}
	}catch(e){
		Server.addErrLog(&quot;Call pdm_sub_process Fail:&quot;+nextflow);  // add by wangwei@2011/12/14
	}
	Server.flowTo(MyTask,&quot;完成&quot;);	
    Server.updateArtInstance(Source_Ins);
}

function pdm_sub_process_(SignTable,SignTable_G,nextflow,temp){	
	//20091006 cc
	//如果 Agree
		//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
		//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
		//A3.查出要 complete 的 task,進行 complete
		//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
		//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
	
	//如果是 reject 
		//R1.查出要 complete 的 task,進行 complete
		//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回填單人	
	try{
		var flg = false;
		var groupid = &quot;&quot;;
		var memid_str = &quot;&apos;administrator&apos;&quot;;
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
		var project_id =MyTask.projectID;
		var Source_Ins_ID = dataMap.get(&quot;Source_Ins_ID&quot;);   // 這個是由資料拋轉(DDT)傳入的,是母表單的INSID
		var Source_Ins = Server.getArtInstance(Source_Ins_ID);
		var agree = dataMap.get(&quot;Agree&quot;);
		var Reject = dataMap.get(&quot;Reject&quot;);
		
		loadLibrary(&quot;com.A.Common.Server.Process&quot;);
	    setProcessTable_ext();
 	    Server.updateArtInstance(Source_Ins);
		
//		var SignTable = &quot;MemTable_DE_Reply&quot;;
//		var SignTable_G = &quot;MemTable_DE_Reply_G&quot;;
//		var nextflow = &quot;客戶已回覆完成&quot;;
		if( agree == &quot;true&quot; || Reject == &quot;true&quot;){
			//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
			if(Source_Ins != null){
				var source_dataMap = Source_Ins.getAppDataMap();
				var MemberTable_MAN = source_dataMap.get(SignTable);  // 這個table 是在母表單,是記錄會簽的人員
				var exeid = MyTask.getMemberID();
				var rootmemid = Server.getTask(MyTask.getRootID()).getMemberID();//取得原本該簽的人 add by edison@20130925
//                var exeid =dataMap.get(&quot;Verify_MemberID&quot;);
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var memid = MemberTable_MAN.get(s).get(&quot;ITEM1&quot;);
						if(memid.equals(exeid) || memid.equals(rootmemid)){
							groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);
							s = MemberTable_MAN.size();
							flg = true;
						}
					}
				}
			}
			//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
			if(flg &amp;&amp; groupid != &quot;&quot;){
				flg = false;
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var r_groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);   // 注意這是ITEM不是欄位的名稱
						if(r_groupid.equals(groupid)){
							//同 groupid 
							memid_str += &quot;,&apos;&quot;+ MemberTable_MAN.get(s).get(&quot;ITEM1&quot;) + &quot;&apos;&quot;;
						}
					}
					flg = true;
				}
			}
			//A3.查出要 complete 的 task,進行 complete
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
				var artExitStateID = getStateID(Source_Ins.getArtifactID(),&quot;完成&quot;); //完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
//				var artExitStateID = &quot;AST00471254125966334&quot;;//完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
			// 找出由root觸發出來的子流程
				//modi by edison@20111201 抓exeid會有代理人問題,導致子流程未被結案,但行政管理師轉單仍須注意,需再去改會簽清單
				//var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and exeid in (&quot;+ memid_str +&quot;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;; 				
				var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and memid in (&quot;+ memid_str +&quot;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;; 
				var vec_t = Server.SQLloadValue(sql_t);
				if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
					try{  // 把try catch move from for loop modi by wangwei@2011/12/14
						for(var r = 0;r&lt;vec_t.size();r++){
								var r_task = Server.getTask(vec_t.get(r).get(&quot;tskid&quot;));
								if(r_task != null){
									Server.completeTask(r_task,artExitStateID);
								}
						}
					}catch(e){}
				}
			}
			//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
			if(flg &amp; groupid != &quot;&quot;){
				var Table_Group = source_dataMap.get(SignTable_G);				
				if(Table_Group != null &amp;&amp; Table_Group.size()&gt;0){
					for(var r=0;r&lt;Table_Group.size();r++){
						var hm = Table_Group.get(r);
						var r_groupid = hm.get(&quot;ITEM1&quot;);
						if(groupid.equals(r_groupid)){
							hm.put(&quot;ITEM2&quot;,true);
							hm.put(&quot;ITEM3&quot;,agree);							
							//r = Table_Group.size();//需整個走完才知道是不是所有的 group 都已完成
							Table_Group.set(r,hm);
							Source_Ins.setAppValue(SignTable_G,Table_Group);
						}else{
							var r_complete = hm.get(&quot;ITEM2&quot;);//complete
							if(r_complete==null || r_complete==&quot;&quot; || &quot;false&quot; == r_complete){
								//只要有一個未完成就是未完成
								flg = false;
							}
						}
					}
				}
			}
			//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),nextflow);  
//				var artExitStateID = &quot;AST00421254125327838&quot;;   //會簽完成  ========&gt;&gt; 母流程的會簽完成
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;);
				var task_wait = Server.getTask(TaskID_Wait);
				if(task_wait != null &amp;&amp; &quot;complete&quot; != task_wait.getTaskState()){
					Server.completeTask(task_wait,artExitStateID);
				}
			}
		}
		if( dataMap.get(&quot;reject&quot;) == &quot;true&quot;){
			//Reject
			//R1.查出要 complete 的 task,進行 complete
			//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回填單人			
			//R1.查出全部未 complete 的 task,進行 complete
//			    loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
				var artExitStateID = getStateID(Source_Ins.getArtifactID(),&quot;完成&quot;);
//				var artExitStateID = &quot;AST00471254125966334&quot;;		//完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
				var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;;
				var vec_t = Server.SQLloadValue(sql_t);
				if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
					for(var r = 0;r&lt;vec_t.size();r++){
						var r_task = Server.getTask(vec_t.get(r).get(&quot;tskid&quot;));
						if(r_task != null){
							try{
								Server.completeTask(r_task,artExitStateID);
							}catch(e){
								Server.addErrLog(&quot;Call pdm_sub_process Fail--- completeTask &quot;+r_task);
							}
						}
					}
					
				}
			//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回申請人
			if(Source_Ins != null ){
				var source_dataMap = Source_Ins.getAppDataMap();
                if (temp == &quot;&quot; ){ 
                     var back_app_user = &quot;退回申請人&quot;;
				}else{
				     var back_app_user = temp;
				}
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),back_app_user);
//				var artExitStateID = &quot;AST00361253948661023&quot;;//退回申請人     ========&gt;&gt; 母流程的退回申請人
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;);
				var task_wait = Server.getTask(TaskID_Wait);
				if(task_wait != null &amp;&amp; &quot;complete&quot; != task_wait.getTaskState()){
					Server.completeTask(task_wait,artExitStateID);
				}
			}
		}
	}catch(e){
		Server.addErrLog(&quot;Call pdm_sub_process_ Fail&quot;); 
	}
	Server.flowTo(MyTask,&quot;完成&quot;);	
    Server.updateArtInstance(Source_Ins);
}
//=========================================
//PDM 會簽子流程_For ECN 結束ER，Complete 或 Waitting 
//=========================================
function pdm_sub_process_ECNtoER(SignTable,nextflow,temp,v_Source_Ins_ID,process){
	Server.addInfoLog(&quot;pdm_sub_process_ECNtoER：start&quot;);//ECN 自動Close ER 開始
	//20110103 irene_chang
	//如果 Agree
		//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
		//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
		//A3.查出要 complete 的 task,進行 complete
		//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
		//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
	
	//如果是 reject 
		//R1.查出要 complete 的 task,進行 complete
		//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回填單人	
	try{
		var flg = false;
		var groupid = &quot;&quot;;	
		var memid_str = &quot;&apos;administrator&apos;&quot;;
		var proName = &quot;工程矯正執行(ECN)&quot;;
		var Source_Ins = Server.getArtInstance(v_Source_Ins_ID); //傳入ER 母表單的INSID	
		var agree = &quot;true&quot;;
        add_Process_Table(v_Source_Ins_ID,proName);
 	    Server.updateArtInstance(Source_Ins);
		
		var SignTable_G = SignTable+&quot;_G&quot;;
//		if(process.indexOf(&quot;ER V3_序列群簽&quot;)&lt;0){
		if( agree == &quot;true&quot;){
			//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
			if(Source_Ins != null){
				var source_dataMap = Source_Ins.getAppDataMap();
				var MemberTable_MAN = source_dataMap.get(SignTable);  // 這個table 是在母表單,是記錄會簽的人員
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;); // 表單wait_taskid
				var v_factory = source_dataMap.get(&quot;Factory&quot;).substr(1,4); // Factory		
				
				var exeid = MyTask.getMemberID();
				var rootmemid = Server.getTask(MyTask.getRootID()).getMemberID();//取得原本該簽的人 add by edison@20130925
//                var exeid =dataMap.get(&quot;Verify_MemberID&quot;);
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var memid = MemberTable_MAN.get(s).get(&quot;ITEM1&quot;);
						var cname = MemberTable_MAN.get(s).get(&quot;ITEM2&quot;);
						if(memid.equals(exeid)|| cname.equals(v_factory+&quot;OPE(ER)&quot;) || memid.equals(rootmemid)){
							groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);
							s = MemberTable_MAN.size();
							flg = true;
						}
					}
				}
			}
			//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
			if(flg &amp;&amp; groupid != &quot;&quot;){
				flg = false;
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var r_groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);   // 注意這是ITEM不是欄位的名稱
						if(r_groupid.equals(groupid)){
							//同 groupid 
							memid_str += &quot;,&apos;&quot;+ MemberTable_MAN.get(s).get(&quot;ITEM1&quot;) + &quot;&apos;&quot;;
						}
					}
					flg = true;
				}
			}
			//A3.查出要 complete 的 task,進行 complete
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
				var artExitStateID = getStateID(Source_Ins.getArtifactID(),&quot;完成&quot;); //完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
//				var artExitStateID = &quot;AST00471254125966334&quot;;//完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
			// 找出由root觸發出來的子流程	
               var sql_t = &quot; select tskid from task where rootid in(&quot;;
                  sql_t += &quot; select CPROOTTSKID from Task_CreatePro where tskid =&quot;;
                  sql_t += &quot; (select max(a.tskid) from task a where type &lt;&gt; &apos;root&apos;  and a.rootid=(select rootid from task where tskid=&apos;&quot;+ TaskID_Wait +&quot;&apos;)&quot;;
				  sql_t += &quot; and a.tskid&lt;&gt;(select max(b.tskid) from task b where type &lt;&gt; &apos;root&apos;  and b.rootid=(select rootid from task where tskid=&apos;&quot;+ TaskID_Wait +&quot;&apos;)))&quot;;
                  sql_t += &quot; and iscomplete = &apos;false&apos;) &quot;;
                  sql_t +=&quot;  and memid in (&quot;+ memid_str +&quot;)&quot;;//modi by edison@20111201				  
                  sql_t += &quot; and state=&apos;ready&apos;&quot;;					  
//				var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and exeid in (&quot;+ memid_str +&quot;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;; 
				var vec_t = Server.SQLloadValue(sql_t);
				if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
					for(var r = 0;r&lt;vec_t.size();r++){
						var r_task = Server.getTask(vec_t.get(r).get(&quot;tskid&quot;));
						if(r_task != null){	
							try{			
								Server.completeTask(r_task,artExitStateID);
							}catch(e){
								
							}					
						}
					}
				}
			}
			//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
			if(flg &amp; groupid != &quot;&quot;){
				var Table_Group = source_dataMap.get(SignTable_G);				
				if(Table_Group != null &amp;&amp; Table_Group.size()&gt;0){
					for(var r=0;r&lt;Table_Group.size();r++){
						var hm = Table_Group.get(r);
						var r_groupid = hm.get(&quot;ITEM1&quot;);
						if(groupid.equals(r_groupid)){
							hm.put(&quot;ITEM2&quot;,true);
							hm.put(&quot;ITEM3&quot;,agree);							
							//r = Table_Group.size();//需整個走完才知道是不是所有的 group 都已完成
							Table_Group.set(r,hm);
							Source_Ins.setAppValue(SignTable_G,Table_Group);
						}else{
							var r_complete = hm.get(&quot;ITEM2&quot;);//complete
							if(&quot;false&quot; == r_complete){
								//只要有一個未完成就是未完成
								flg = false;
							}
						}
					}
				}
			}
			//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),nextflow);  
//				var artExitStateID = &quot;AST00421254125327838&quot;;   //會簽完成  ========&gt;&gt; 母流程的會簽完成
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;);
				var task_wait = Server.getTask(TaskID_Wait);
				if(task_wait != null &amp;&amp; &quot;complete&quot; != task_wait.getTaskState()){
					Server.completeTask(task_wait,artExitStateID);
				}
			}
		}
		if( agree == &quot;false&quot;){
			//Reject
			//R1.查出要 complete 的 task,進行 complete
			//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回填單人			
			//R1.查出全部未 complete 的 task,進行 complete
//			    loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
				var artExitStateID = getStateID(Source_Ins.getArtifactID(),&quot;完成&quot;);
//				var artExitStateID = &quot;AST00471254125966334&quot;;		//完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
                 var sql_t = &quot; select tskid from task where rootid in(&quot;;
                     sql_t += &quot; select CPROOTTSKID from Task_CreatePro where tskid =&quot;;
                     sql_t += &quot; (select max(a.tskid) from task a where type &lt;&gt; &apos;root&apos;  and a.rootid=(select rootid from task where tskid=&apos;&quot;+ TaskID_Wait +&quot;&apos;) &quot;;
					 sql_t += &quot; and a.tskid&lt;&gt;(select max(b.tskid) from task b where type &lt;&gt; &apos;root&apos;  and b.rootid=(select rootid from task where tskid=&apos;&quot;+ TaskID_Wait +&quot;&apos;)))&quot;;
                     sql_t += &quot; and iscomplete = &apos;false&apos;) &quot;;
                  	 sql_t += &quot; and state=&apos;ready&apos;&quot;;			 
				 var vec_t = Server.SQLloadValue(sql_t);
				if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
					for(var r = 0;r&lt;vec_t.size();r++){
						var r_task = Server.getTask(vec_t.get(r).get(&quot;tskid&quot;));
						if(r_task != null){
							try{
								Server.completeTask(r_task,artExitStateID);
							}catch(e){
								Server.addErrLog(&quot;Call pdm_sub_process_ECNtoER Fail complete Task:&quot;+r_task);  // add by wangwei@2011/12/14
							}
						}
					}
				}
			//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回申請人
			if(Source_Ins != null ){
				var source_dataMap = Source_Ins.getAppDataMap();
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
                if (temp == &quot;&quot; ){ 
                     var back_app_user = &quot;退回申請人&quot;;
				}else{
				     var back_app_user = temp;
				}
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),back_app_user);
//				var artExitStateID = &quot;AST00361253948661023&quot;;//退回申請人     ========&gt;&gt; 母流程的退回申請人
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;);
				var task_wait = Server.getTask(TaskID_Wait);
				if(task_wait != null &amp;&amp; &quot;complete&quot; != task_wait.getTaskState()){
					Server.completeTask(task_wait,artExitStateID);
				}
			}
		}
//	 }	
	}catch(e){
		Server.addErrLog(&quot;Call pdm_sub_process_ECNtoER Fail&quot;);  // add by wangwei@2011/12/14
	}
//	if(process.indexOf(&quot;V2&quot;)&gt;=0){
	Server.flowTo(MyTask,&quot;完成&quot;);	
//	}else{
//	Server.flowTo(MyTask,&quot;OP檢閱與執行完成&quot;);	
//	}
    Server.updateArtInstance(Source_Ins);
	Server.addInfoLog(&quot;pdm_sub_process_ECNtoER：End&quot;);//ECN 自動Close ER 開始
}

function add_Process_Table(v_Source_Ins_ID,proName){
	var Source_Ins = Server.getArtInstance(v_Source_Ins_ID);

	if(Source_Ins != null){	
		var source_dataMap = Source_Ins.getAppDataMap();		
		var vecTableData = source_dataMap.get(&quot;Process_Table&quot;);
		var rowCount = vecTableData.size();//vecTableData裡資料筆數
		var depid = MyTask.getDepartmentID();
		var dep = Server.getDepartment(depid);		
		var member = Server.getMember(MyTask.getRealExecutor()); //執行者
		var id = member.getMyID();
		var roleTitle = member.getJobTitle();
		
		var department = &quot;x&quot;;
		   if(dep != null){
			  department = dep.getName();
		   }else{
			//抓不到部門(可能是專案職務)，就抓主要職務的部門
			var roleID = member.getMainRoleID();
			var memDR = member.getMemberDR(roleID);
			var department = memDR.getDepartmentName();	//使用者部門名稱
		   }
		
		
		//加入代理人資訊 20070625
		if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
			name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
		}
		var hm = java.util.HashMap();
		if (proName==&quot;&quot;){
		    var proName = MyTask.getProcessName();//關卡名稱
		}
//		var proName = &quot;會簽(觸發)&quot;;//關卡名稱
		hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
		hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
		hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
		hm.put(&quot;ITEM6&quot;, department);//Department 部門
		hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
		hm.put(&quot;ITEM2&quot;, id);//ID 工號	
		hm.put(&quot;ITEM4&quot;, member);//Name 姓名
		hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		hm.put(&quot;ITEM1&quot;, &quot;&quot;);//Opinion 意見
//		hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
		vecTableData.add(rowCount,hm);
		Source_Ins.setAppValue(&quot;Process_Table&quot;,vecTableData);
	}
}	

//=========================================
//PDM 會簽子流程，Complete 或 Waitting 
//=========================================
function pdm_sub_process_another_factory(SignTable,SignTable_G,nextflow,temp){	
	//20110811 by irenechang
	//不管 Agree 或 reject 走同邏輯
		//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
		//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
		//A3.查出要 complete 的 task,進行 complete
		//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
		//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
	
	//如果是 reject 
		//R1.查出要 complete 的 task,進行 complete
		//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回填單人	
	try{
		var flg = false;
		var groupid = &quot;&quot;;
		var memid_str = &quot;&apos;administrator&apos;&quot;;
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
		var project_id =MyTask.projectID;
		var Source_Ins_ID = dataMap.get(&quot;Source_Ins_ID&quot;);   // 這個是由資料拋轉(DDT)傳入的,是母表單的INSID
		var Source_Ins = Server.getArtInstance(Source_Ins_ID);
		var agree = dataMap.get(&quot;Agree&quot;);
		
		loadLibrary(&quot;com.A.Common.Server.Process&quot;);
	    setProcessTable_ext();
 	    Server.updateArtInstance(Source_Ins);
		
//		var SignTable = &quot;MemTable_DE_Reply&quot;;
//		var SignTable_G = &quot;MemTable_DE_Reply_G&quot;;
//		var nextflow = &quot;客戶已回覆完成&quot;;
//		if( agree == &quot;true&quot;){
			//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
			if(Source_Ins != null){
				var source_dataMap = Source_Ins.getAppDataMap();
				var MemberTable_MAN = source_dataMap.get(SignTable);  // 這個table 是在母表單,是記錄會簽的人員
				var exeid = MyTask.getMemberID();
				var rootmemid = Server.getTask(MyTask.getRootID()).getMemberID();//取得原本該簽的人 add by edison@20130925
//                var exeid =dataMap.get(&quot;Verify_MemberID&quot;);
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var memid = MemberTable_MAN.get(s).get(&quot;ITEM1&quot;);
						if(memid.equals(exeid) || memid.equals(rootmemid)){
							groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);
							s = MemberTable_MAN.size();
							flg = true;
						}
					}
				}
			}
			//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
			if(flg &amp;&amp; groupid != &quot;&quot;){
				flg = false;
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var r_groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);   // 注意這是ITEM不是欄位的名稱
						if(r_groupid.equals(groupid)){
							//同 groupid 
							memid_str += &quot;,&apos;&quot;+ MemberTable_MAN.get(s).get(&quot;ITEM1&quot;) + &quot;&apos;&quot;;
						}
					}
					flg = true;
				}
			}
			//A3.查出要 complete 的 task,進行 complete
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
				var artExitStateID = getStateID(Source_Ins.getArtifactID(),&quot;完成&quot;); //完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
//				var artExitStateID = &quot;AST00471254125966334&quot;;//完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
			// 找出由root觸發出來的子流程				
				var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and memid in (&quot;+ memid_str +&quot;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;; 
				var vec_t = Server.SQLloadValue(sql_t);
				if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
					for(var r = 0;r&lt;vec_t.size();r++){
							var r_task = Server.getTask(vec_t.get(r).get(&quot;tskid&quot;));
							if(r_task != null){
								try{
									Server.completeTask(r_task,artExitStateID);
								}catch(e){
								
								}
							}
					}
				}
			}
			//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
			if(flg &amp; groupid != &quot;&quot;){
				var Table_Group = source_dataMap.get(SignTable_G);				
				if(Table_Group != null &amp;&amp; Table_Group.size()&gt;0){
					for(var r=0;r&lt;Table_Group.size();r++){
						var hm = Table_Group.get(r);
						var r_groupid = hm.get(&quot;ITEM1&quot;);
						if(groupid.equals(r_groupid)){
							hm.put(&quot;ITEM2&quot;,true);
							hm.put(&quot;ITEM3&quot;,true);							
							//r = Table_Group.size();//需整個走完才知道是不是所有的 group 都已完成
							Table_Group.set(r,hm);
							Source_Ins.setAppValue(SignTable_G,Table_Group);
							//Server.updateArtInstance(Source_Ins);
						}else{
							var r_complete = hm.get(&quot;ITEM2&quot;);//complete
							if(r_complete==null || r_complete==&quot;&quot; || &quot;false&quot; == r_complete){
								//只要有一個未完成就是未完成
								flg = false;
							}
						}
					}
				}
			}
			//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),nextflow);  
//				var artExitStateID = &quot;AST00421254125327838&quot;;   //會簽完成  ========&gt;&gt; 母流程的會簽完成
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;);
				var task_wait = Server.getTask(TaskID_Wait);
				if(task_wait != null &amp;&amp; &quot;complete&quot; != task_wait.getTaskState()){
					Server.completeTask(task_wait,artExitStateID);
				}
			}
//		}
	}catch(e){
		Server.addErrLog(&quot;Call pdm_sub_process_another_factory Fail&quot;);  // add by wangwei@2011/12/14
	}
	Server.flowTo(MyTask,&quot;完成&quot;);	
    Server.updateArtInstance(Source_Ins);
}

//原物料報廢申請單(物管)使用
function pdm_sub_process_p(SignTable,SignTable_G,nextflow,temp){	
	//20091006 cc
	//如果 Agree
		//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
		//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
		//A3.查出要 complete 的 task,進行 complete
		//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
		//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
	
	//如果是 reject 
		//R1.查出要 complete 的 task,進行 complete
		//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回填單人	
	try{
		var flg = false;
		var groupid = &quot;&quot;;
		var memid_str = &quot;&apos;administrator&apos;&quot;;
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
		var project_id =MyTask.projectID;
		var Source_Ins_ID = dataMap.get(&quot;Source_Ins_ID&quot;);   // 這個是由資料拋轉(DDT)傳入的,是母表單的INSID
		var Source_Ins = Server.getArtInstance(Source_Ins_ID);
		var agree = dataMap.get(&quot;Agree&quot;);
		
		loadLibrary(&quot;com.A.Common.Server.Process&quot;);
	    setProcessTable_ext();
 	    Server.updateArtInstance(Source_Ins);
		
		//檢查紀錄會簽子流程名單table,若無資料則代表不正常,mail通知系統負責人  
			//add by edison@20130322
			var process_name = MyTask.getProcessName();
			if( Source_Ins != null ){
				var source_datamap = Source_Ins.getAppDataMap();
				var Assign_Table = source_datamap.get(SignTable);
				var Assign_Table_G = source_datamap.get(SignTable_G);
				if(Assign_Table!=null &amp;&amp; Assign_Table_G!=null &amp;&amp; (Assign_Table.size()==0 || Assign_Table_G.size()==0)){
				//if(true){	
					try{
						var aInstance = MyTask.getArtInstance(); 
						var dataMap = aInstance.getAppDataMap(); 
						var roottaskname = MyTask.getRootName();
						var from = Server.getMember(&quot;administrator&quot;).getEmail(); 					
						var to = &quot;edison_wang@gce.com.tw&quot;;
						var cc = &quot;&quot;;
						var subject = &quot;[PDM異常通知]&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot; 所申請-&quot; + roottaskname+&quot;(&quot;+process_name+&quot;)&quot; +&quot; 單號:&quot;+dataMap.get(&quot;Sn&quot;); // Mail Subject 
						var text = &quot;Assign_Table 沒資料!!&quot;;
						var fileList = new Packages.java.util.Vector(); 
						Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
					}catch(e){}
				}
			}
		
//		var SignTable = &quot;MemTable_DE_Reply&quot;;
//		var SignTable_G = &quot;MemTable_DE_Reply_G&quot;;
//		var nextflow = &quot;客戶已回覆完成&quot;;

		if( agree == &quot;true&quot;){
			//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
			if(Source_Ins != null){
				var source_dataMap = Source_Ins.getAppDataMap();
				var MemberTable_MAN = source_dataMap.get(SignTable);  // 這個table 是在母表單,是記錄會簽的人員
				var exeid = MyTask.getMemberID();
				var rootmemid = Server.getTask(MyTask.getRootID()).getMemberID();//取得原本該簽的人 add by edison@20130925
//                var exeid =dataMap.get(&quot;Verify_MemberID&quot;);
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var memid = MemberTable_MAN.get(s).get(&quot;ITEM3&quot;);
						
						if(memid.equals(exeid) || memid.equals(rootmemid)){
							groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);
							s = MemberTable_MAN.size();
							flg = true;
						}
					}
				}
			}

			//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
			if(flg &amp;&amp; groupid != &quot;&quot;){
				flg = false;
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var r_groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);   // 注意這是ITEM不是欄位的名稱
						if(r_groupid.equals(groupid)){
							//同 groupid 
							memid_str += &quot;,&apos;&quot;+ MemberTable_MAN.get(s).get(&quot;ITEM3&quot;) + &quot;&apos;&quot;;
						}
					}
					flg = true;
				}
			}

			//A3.查出要 complete 的 task,進行 complete
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
				var artExitStateID = getStateID(Source_Ins.getArtifactID(),&quot;完成&quot;); //完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
//				var artExitStateID = &quot;AST00471254125966334&quot;;//完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
			// 找出由root觸發出來的子流程
				//modi by edison@20111201 抓exeid會有代理人問題,導致子流程未被結案,但行政管理師轉單仍須注意,需再去改會簽清單
				//var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and exeid in (&quot;+ memid_str +&quot;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;; 				
				var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and memid in (&quot;+ memid_str +&quot;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;; 
				var vec_t = Server.SQLloadValue(sql_t);
				if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
					try{  // 把try catch move from for loop modi by wangwei@2011/12/14
						for(var r = 0;r&lt;vec_t.size();r++){
								var r_task = Server.getTask(vec_t.get(r).get(&quot;tskid&quot;));
								if(r_task != null){
									Server.completeTask(r_task,artExitStateID);
								}
						}
					}catch(e){}
				}
			}
			Server.addDebugLog(&quot;pdm_sub_process_flg3=&quot;+flg);
			//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
			if(flg &amp; groupid != &quot;&quot;){
				var Table_Group = source_dataMap.get(SignTable_G);				
				if(Table_Group != null &amp;&amp; Table_Group.size()&gt;0){
					for(var r=0;r&lt;Table_Group.size();r++){
						var hm = Table_Group.get(r);
						var r_groupid = hm.get(&quot;ITEM1&quot;);
						if(groupid.equals(r_groupid)){
							hm.put(&quot;ITEM2&quot;,true);
							hm.put(&quot;ITEM3&quot;,agree);							
							//r = Table_Group.size();//需整個走完才知道是不是所有的 group 都已完成
							Table_Group.set(r,hm);
							Source_Ins.setAppValue(SignTable_G,Table_Group);

						}else{
							var r_complete = hm.get(&quot;ITEM2&quot;);//complete
							if(&quot;false&quot; == r_complete){
								//只要有一個未完成就是未完成
								flg = false;
							}
						}
					}
				}
			}

			//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),nextflow);  
//				var artExitStateID = &quot;AST00421254125327838&quot;;   //會簽完成  ========&gt;&gt; 母流程的會簽完成
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;);
				var task_wait = Server.getTask(TaskID_Wait);
				if(task_wait != null &amp;&amp; &quot;complete&quot; != task_wait.getTaskState()){
					Server.completeTask(task_wait,artExitStateID);

				}
			}
		}
		if( agree == &quot;false&quot;){
			//Reject
			//R1.查出要 complete 的 task,進行 complete
			//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回填單人			
			//R1.查出全部未 complete 的 task,進行 complete
//			    loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
				var artExitStateID = getStateID(Source_Ins.getArtifactID(),&quot;完成&quot;);
//				var artExitStateID = &quot;AST00471254125966334&quot;;		//完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
				var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;;
				var vec_t = Server.SQLloadValue(sql_t);
				if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
					for(var r = 0;r&lt;vec_t.size();r++){
						var r_task = Server.getTask(vec_t.get(r).get(&quot;tskid&quot;));
						if(r_task != null){
							try{
								Server.completeTask(r_task,artExitStateID);
							}catch(e){
								Server.addErrLog(&quot;Call pdm_sub_process Fail--- completeTask &quot;+r_task);
							}
						}
					}
					
				}
			//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回申請人
			if(Source_Ins != null ){
				var source_dataMap = Source_Ins.getAppDataMap();
                if (temp == &quot;&quot; ){ 
                     var back_app_user = &quot;退回申請人&quot;;
				}else{
				     var back_app_user = temp;
				}
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),back_app_user);
//				var artExitStateID = &quot;AST00361253948661023&quot;;//退回申請人     ========&gt;&gt; 母流程的退回申請人
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;);
				var task_wait = Server.getTask(TaskID_Wait);
				if(task_wait != null &amp;&amp; &quot;complete&quot; != task_wait.getTaskState()){
					Server.completeTask(task_wait,artExitStateID);
				}
			}
		}
	}catch(e){
		Server.addErrLog(&quot;Call pdm_sub_process Fail:&quot;+nextflow);  // add by wangwei@2011/12/14
	}
	Server.flowTo(MyTask,&quot;完成&quot;);	
    Server.updateArtInstance(Source_Ins);
}

function getDuty(memid){
	var deputyID = &quot;&quot;; 
	var memRC = Server.getMemberByID(memid);
	var deputyState = memRC.getDeputyState();
	if(deputyState == true) {
		deputyID = memRC.getDeputyID();
		deputyID = &quot;,&apos;&quot;+deputyID+&quot;&apos;&quot;;
	}
	return deputyID;
}

//GCE對策水平展開追蹤單使用
function pdm_sub_process_cl(SignTable,SignTable_G,nextflow,temp){	
	//20091006 cc
	//如果 Agree
		//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
		//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
		//A3.查出要 complete 的 task,進行 complete
		//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
		//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
	
	//如果是 reject 
		//R1.查出要 complete 的 task,進行 complete
		//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回填單人	
	try{
		var flg = false;
		var groupid = &quot;&quot;;
		var memid_str = &quot;&apos;administrator&apos;&quot;;
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
		var project_id =MyTask.projectID;
		var Source_Ins_ID = dataMap.get(&quot;Source_Ins_ID&quot;);   // 這個是由資料拋轉(DDT)傳入的,是母表單的INSID
		var Source_Ins = Server.getArtInstance(Source_Ins_ID);
		var agree = dataMap.get(&quot;Agree&quot;);
		
		loadLibrary(&quot;com.A.Common.Server.Process&quot;);
	    setProcessTable_ext();
 	    Server.updateArtInstance(Source_Ins);
		
		//檢查紀錄會簽子流程名單table,若無資料則代表不正常,mail通知系統負責人  
			//add by edison@20130322
			var process_name = MyTask.getProcessName();
			if( Source_Ins != null ){
				var source_datamap = Source_Ins.getAppDataMap();
				var Assign_Table = source_datamap.get(SignTable);
				var Assign_Table_G = source_datamap.get(SignTable_G);
				if(Assign_Table!=null &amp;&amp; Assign_Table_G!=null &amp;&amp; (Assign_Table.size()==0 || Assign_Table_G.size()==0)){
				//if(true){	
					try{
						var aInstance = MyTask.getArtInstance(); 
						var dataMap = aInstance.getAppDataMap(); 
						var roottaskname = MyTask.getRootName();
						var from = Server.getMember(&quot;administrator&quot;).getEmail(); 					
						var to = &quot;edison_wang@gce.com.tw&quot;;
						var cc = &quot;&quot;;
						var subject = &quot;[PDM異常通知]&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot; 所申請-&quot; + roottaskname+&quot;(&quot;+process_name+&quot;)&quot; +&quot; 單號:&quot;+dataMap.get(&quot;Sn&quot;); // Mail Subject 
						var text = &quot;Assign_Table 沒資料!!&quot;;
						var fileList = new Packages.java.util.Vector(); 
						Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
					}catch(e){}
				}
			}
		
//		var SignTable = &quot;MemTable_DE_Reply&quot;;
//		var SignTable_G = &quot;MemTable_DE_Reply_G&quot;;
//		var nextflow = &quot;客戶已回覆完成&quot;;

		if( agree == &quot;true&quot;){
			//A1.先確定這個 task 的 groupid : 由 Source_Ins_ID 查到 MemberTable_MAN
			if(Source_Ins != null){
				var source_dataMap = Source_Ins.getAppDataMap();
				var MemberTable_MAN = source_dataMap.get(SignTable);  // 這個table 是在母表單,是記錄會簽的人員
				var exeid = MyTask.getMemberID();
				var rootmemid = Server.getTask(MyTask.getRootID()).getMemberID();//取得原本該簽的人 add by edison@20130925
//                var exeid =dataMap.get(&quot;Verify_MemberID&quot;);
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var memid = MemberTable_MAN.get(s).get(&quot;ITEM1&quot;);
						
						if(memid.equals(exeid) || memid.equals(rootmemid)){
							groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);
							s = MemberTable_MAN.size();
							flg = true;
						}
					}
				}
			}

			//A2.查出所有這個 groupid 的 memid 黏成一個字串(單引號相連結) 
			if(flg &amp;&amp; groupid != &quot;&quot;){
				flg = false;
				if(MemberTable_MAN != null &amp;&amp; MemberTable_MAN.size()&gt;0){
					for(var s=0;s&lt;MemberTable_MAN.size();s++){
						var r_groupid = MemberTable_MAN.get(s).get(&quot;ITEM5&quot;);   // 注意這是ITEM不是欄位的名稱
						if(r_groupid.equals(groupid)){
							//同 groupid 
							memid_str += &quot;,&apos;&quot;+ MemberTable_MAN.get(s).get(&quot;ITEM1&quot;) + &quot;&apos;&quot;;
						}
					}
					flg = true;
				}
			}

			//A3.查出要 complete 的 task,進行 complete
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
//				var artExitStateID = getStateID(Source_Ins.getArtifactID(),&quot;完成&quot;); //完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
//				var artExitStateID = getStateID(&quot;ART04641539827710587&quot;,&quot;完成&quot;);
				//ART04641539827710587
				var artExitStateID = &quot;AST34541539829716327&quot;;//完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
			// 找出由root觸發出來的子流程
				//modi by edison@20111201 抓exeid會有代理人問題,導致子流程未被結案,但行政管理師轉單仍須注意,需再去改會簽清單
				//var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and exeid in (&quot;+ memid_str +&quot;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;; 				
				var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and memid in (&quot;+ memid_str +&quot;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;; 
				var vec_t = Server.SQLloadValue(sql_t);
				if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
					try{  // 把try catch move from for loop modi by wangwei@2011/12/14
						for(var r = 0;r&lt;vec_t.size();r++){
								var r_task = Server.getTask(vec_t.get(r).get(&quot;tskid&quot;));
								if(r_task != null){
									Server.completeTask(r_task,artExitStateID);
								}
						}
					}catch(e){}
				}
			}
			Server.addDebugLog(&quot;pdm_sub_process_flg3=&quot;+flg);
			//A4.註記 Table_Group 的這個 groupid complete &amp; Agree/Reject
			if(flg &amp; groupid != &quot;&quot;){
				var Table_Group = source_dataMap.get(SignTable_G);				
				if(Table_Group != null &amp;&amp; Table_Group.size()&gt;0){
					for(var r=0;r&lt;Table_Group.size();r++){
						var hm = Table_Group.get(r);
						var r_groupid = hm.get(&quot;ITEM1&quot;);
						if(groupid.equals(r_groupid)){
							hm.put(&quot;ITEM2&quot;,true);
							hm.put(&quot;ITEM3&quot;,agree);							
							//r = Table_Group.size();//需整個走完才知道是不是所有的 group 都已完成
							Table_Group.set(r,hm);
							Source_Ins.setAppValue(SignTable_G,Table_Group);

						}else{
							var r_complete = hm.get(&quot;ITEM2&quot;);//complete
							if(&quot;false&quot; == r_complete){
								//只要有一個未完成就是未完成
								flg = false;
							}
						}
					}
				}
			}

			//A5.是否全部的 groupid 都已完成;如果是-把停在「等待xxx」的關卡 TaskID_Wait 完成
			if(flg){
//				loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),nextflow);  
//				var artExitStateID = &quot;AST00421254125327838&quot;;   //會簽完成  ========&gt;&gt; 母流程的會簽完成
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;);
				var task_wait = Server.getTask(TaskID_Wait);
				if(task_wait != null &amp;&amp; &quot;complete&quot; != task_wait.getTaskState()){
					Server.completeTask(task_wait,artExitStateID);

				}
			}
		}
		if( agree == &quot;false&quot;){
			//Reject
			//R1.查出要 complete 的 task,進行 complete
			//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回填單人			
			//R1.查出全部未 complete 的 task,進行 complete
//			    loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);
				var artExitStateID = getStateID(aInstance.getArtifactID(),&quot;完成&quot;);
//				var artExitStateID = &quot;AST00471254125966334&quot;;		//完成 =====------------&gt;&gt;&gt;&gt;&gt;&gt;請依各子流程取得ID
				var sql_t = &quot; select tskid from task where type &lt;&gt; &apos;root&apos; and tskid &lt;&gt; &apos;&quot;+ MyTask.getID() +&quot;&apos; and state not in(&apos;complete&apos;,&apos;dead&apos;) and RootID in ( select CPROOTTSKID from Task_CreatePro where tskid =(select MAX(TSKID) FROM Task_CreatePro WHERE CPROOTTSKID=&apos;&quot;+ MyTask.getRootID() +&quot;&apos;) and isComplete = &apos;false&apos;) &quot;;
				var vec_t = Server.SQLloadValue(sql_t);
				if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
					for(var r = 0;r&lt;vec_t.size();r++){
						var r_task = Server.getTask(vec_t.get(r).get(&quot;tskid&quot;));
						if(r_task != null){
							try{
								Server.completeTask(r_task,artExitStateID);
							}catch(e){
								Server.addErrLog(&quot;Call pdm_sub_process Fail--- completeTask &quot;+r_task);
							}
						}
					}
					
				}
			//R2.把停在「等待xxx」的關卡 TaskID_Wait 退回申請人
			if(Source_Ins != null ){
				var source_dataMap = Source_Ins.getAppDataMap();
                if (temp == &quot;&quot; ){ 
                     var back_app_user = &quot;退回申請人&quot;;
				}else{
				     var back_app_user = temp;
				}
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),back_app_user);
//				var artExitStateID = &quot;AST00361253948661023&quot;;//退回申請人     ========&gt;&gt; 母流程的退回申請人
				var TaskID_Wait = source_dataMap.get(&quot;TaskID_Wait&quot;);
				var task_wait = Server.getTask(TaskID_Wait);
				if(task_wait != null &amp;&amp; &quot;complete&quot; != task_wait.getTaskState()){
					Server.completeTask(task_wait,artExitStateID);
				}
			}
		}
	}catch(e){
		Server.addErrLog(&quot;Call pdm_sub_process Fail:&quot;+nextflow);  // add by wangwei@2011/12/14
	}
	Server.flowTo(MyTask,&quot;完成&quot;);	
    Server.updateArtInstance(Source_Ins);
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>Windchill編碼方式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00071247640723078</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/05/29 10:29:48</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PO.EPO_SEARCH</string> 
     </void> 
     <void property="id"> 
      <string>SCL00071247640723078</string> 
     </void> 
     <void property="name"> 
      <string>EPO_SEARCH</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00071247640707129</string> 
     </void> 
     <void property="scriptSource"> 
      <string>	
//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}	
	if (vec.size()&gt;0){
		try{
			for(var i = (P-1)*N ; i &lt; E; i++){
				var hm = vec.get(i);
				var row = table.newRow()-1;
				var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
				if (task != null){
					var processname = task.getProcessName();
					if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
						processname = &quot;作廢&quot;;
					}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
						processname = &quot;已結案&quot;;
					}
					table.setValueAt(processname,   row, &quot;目前關卡&quot;);
	//-------------------------以下copy from 資訊服務申請單---------------------------------------------------------------
					var rootid = task.getRootID();
					var proid = task.getProcessID();
					var addAsList = isExecuteAddAS(rootid,proid);//add by edison@20120518 判斷是否有加會簽並取出人員名單
					if(addAsList!=&quot;&quot;){
						table.setValueAt(addAsList,  row, &quot;目前處理者&quot;);
					}else{
						var vMemList = getUnsignMemName(task); // 加會簽
						if(&quot;&quot;==vMemList){
							vMemList = getUnsignMemNameExt(task);
						}						
						if(&quot;&quot;!=vMemList){		
							table.setValueAt(vMemList,  row, &quot;目前處理者&quot;);	
						}else{							
							var realExecutorMemID = task.getRealExecutor();
							var memberRecord = Client.getMemberByID(realExecutorMemID);
							if (processname == &quot;已結案&quot;||processname == &quot;作廢&quot;){
								table.setValueAt(&quot;--&quot;,  row, &quot;目前處理者&quot;);
							}else{
								table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
							}
						}
					}
	//---------------------------------------------------------------------				
				}
				table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
				table.setValueAt(hm.get(&quot;ITEM12&quot;).substring(0,10),    	row, &quot;開單日期&quot;);			
				if(hm.get(&quot;ITEM115&quot;).length()&gt;1){
					var fm_closedate = hm.get(&quot;ITEM115&quot;).substring(0,10);
				}else{
					var fm_closedate = &quot;--&quot;;
				}			
				table.setValueAt(hm.get(&quot;ITEM144&quot;),    	row, &quot;Buyer&quot;);
				table.setValueAt(hm.get(&quot;ITEM88&quot;)+&quot;/&quot;+hm.get(&quot;ITEM174&quot;), 	row, &quot;PR申請人&quot;);
				table.setValueAt(hm.get(&quot;ITEM191&quot;), 	row, &quot;PR開單部門&quot;);
				table.setValueAt(hm.get(&quot;ITEM15&quot;),   	row, &quot;用途說明&quot;);
				table.setValueAt(hm.get(&quot;ITEM165&quot;),  	row, &quot;品名/規格&quot;);
				table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);				
				table.setValueAt(fm_closedate,    	row, &quot;EPO結案日期&quot;);	
				table.setValueAt(hm.get(&quot;ITEM138&quot;),    	row, &quot;PR No.&quot;);				
				var epono = &quot;未取得&quot;;			
					var getorg = hm.get(&quot;ITEM2&quot;);   //(TGCE)
					if(&quot;(TGCE)&quot;.equals(getorg)){
						var ORG_ID = &quot;30&quot;;
					}else if(&quot;(SGCE)&quot;.equals(getorg)){
						var ORG_ID = &quot;174&quot;;
					}else if(&quot;(CGCE)&quot;.equals(getorg)){
						var ORG_ID = &quot;114&quot;;
					}else if(&quot;(HGCE)&quot;.equals(getorg)){
						var ORG_ID = &quot;274&quot;;
					}else{
						var ORG_ID = &quot;30&quot;;
					}			
				var sqls = &quot;SELECT TGC_UPI_PO_PKG.TG_OA_GET_EPO_NO(&quot;+ORG_ID+&quot;,&apos;&quot;+hm.get(&quot;ITEM138&quot;)+&quot;&apos;) EPO_NO FROM DUAL &quot;			
				var rs = Client.SQLloadValue(sqls);
				if(!&quot;&quot;.equals(rs.get(0).get(&quot;EPO_NO&quot;))){
					epono = &quot;PO_NO=&quot;+rs.get(0).get(&quot;EPO_NO&quot;);
					epono.replace(&quot;PO_NO=&quot;,&quot;No:&quot;);
					epono.replace(&quot;#&quot;,&quot;\n&quot;);
				}
				table.setValueAt(epono,    	row, &quot;PO No.&quot;);			

// --------	add by wangwei for: ISA.:20180228		
				var vPRNO = hm.get(&quot;ITEM138&quot;);
				var vSQL = &quot;select substr(ITEM115,0,10) PRENDDTIME from ART00651218173706391_ins Where ITEM138 = &apos;&quot;+vPRNO+&quot;&apos;&quot;;   	
				var vecPR = Client.SQLloadValue(vSQL);
				if(vecPR.size()&gt;0){
					table.setValueAt( vecPR.get(0).get(&quot;PRENDDTIME&quot;) ,row, &quot;EPR結案日期&quot;);			//		
				}//---------------------------
			}
		}catch(e){
			Form.showMessageDialog(&quot;讀取資料有誤：&quot;+e);				// add by wangwei@2012/08/07
		}		
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	// 起始日期
	if(!&quot;不限定&quot;.equals(Form.getValue(&quot;date_filters&quot;))){　　// 條件!&quot;不限定&quot;.equals(Form.getValue(&quot;date_filters&quot;))||&quot;全部&quot;.equals(PHSTATUS)
		var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
		if (&quot;true&quot;.equals(ckbSDate)){	
			var sDate = Form.getValue(&quot;sDate&quot;);	
			if (!&quot;&quot;.equals(sDate)) {
				if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}else if(&quot;依採購收件日&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM147||&apos; 00:00&apos; &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;				
				}else{
					sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
			}
		}
	// 終止日期
		var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
		if (&quot;true&quot;.equals(ckbEDate)){	
			var eDate = Form.getValue(&quot;eDate&quot;);	
			if (!&quot;&quot;.equals(eDate)) {
				if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;					
				}else if(&quot;依採購收件日&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM147||&apos; 00:00&apos; &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;			
				}else{
					sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}			
			}
		}
	}
	// 文件編號
	var Doc_Sn = Form.getValue(&quot;Sn&quot;).toUpperCase().trim(); // 加上trim by wangwei@2011/09/27
	if (!&quot;&quot;.equals(Doc_Sn)) {
		sSQL += &quot; AND ITEM138 like &apos;&quot; + Doc_Sn + &quot;%&apos;&quot;;  	// 只在後面自動加% FOR 改善查詢速度
	}		
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM144 like &apos;&quot; + MemName + &quot;%&apos;&quot;;  // 只在後面自動加% FOR 改善查詢速度
	}	
	var appname = Form.getValue(&quot;appname&quot;);	
	if (!&quot;&quot;.equals(appname)) {
		sSQL += &quot; AND ITEM88 like &apos;%&quot; + appname + &quot;%&apos;&quot;;  // 應該是item88才對啊!! modi by wangwei@2011/09/26
	}	
	var byappdept = Form.getValue(&quot;byappdept&quot;);	
	if (!&quot;&quot;.equals(byappdept)) {
		sSQL += &quot; AND ITEM191 like &apos;%&quot; + byappdept + &quot;%&apos;&quot;;//sSQL += &quot; AND ITEM186 like &apos;%&quot; + byappdept + &quot;%&apos;&quot;;
	}	
	var PHSTATUS = Form.getValue(&quot;FComboBox0&quot;);
	if (!&quot;全部&quot;.equals(PHSTATUS)) {
		if(&quot;採購已收件&quot;.equals(PHSTATUS)){
			var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
			if (&quot;true&quot;.equals(ckbSDate)){	
				var sDate = Form.getValue(&quot;sDate&quot;);	
				if (!&quot;&quot;.equals(sDate)) {
					sSQL += &quot; AND ITEM147 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
			}
			var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
			if (&quot;true&quot;.equals(ckbEDate)){	
				var eDate = Form.getValue(&quot;eDate&quot;);	
				if (!&quot;&quot;.equals(eDate)) {
					sSQL += &quot; AND ITEM147 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}
			}
			sSQL += &quot; AND ITEM131 = &apos;W&apos;&quot;;	   				// 	採購已收件	
		}else if(&quot;已轉入ERP&quot;.equals(PHSTATUS)){
			var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
			if (&quot;true&quot;.equals(ckbSDate)){	
				var sDate = Form.getValue(&quot;sDate&quot;);	
				if (!&quot;&quot;.equals(sDate)) {
					sSQL += &quot; AND ITEM149 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
			}
			var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
			if (&quot;true&quot;.equals(ckbEDate)){	
				var eDate = Form.getValue(&quot;eDate&quot;);	
				if (!&quot;&quot;.equals(eDate)){
					sSQL += &quot; AND ITEM149 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}
			}
			sSQL += &quot; AND ITEM131 = &apos;Y&apos;&quot;;   				// 已轉入ERP
		}else{
			sSQL += &quot; AND (ITEM131 &lt;&gt; &apos;W&apos; and  ITEM131 &lt;&gt; &apos;Y&apos;) &quot;;
		}
	}
	//文件狀態
	var Status = Form.getValue(&quot;Status&quot;);	 
	if (!&quot;全部&quot;.equals(Status)){
		if (&quot;已結案&quot;.equals(Status)){
			sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM314 in (&apos;W&apos;,&apos;Y&apos;) &quot;;
		}else if (&quot;未結案&quot;.equals(Status)){
			sSQL += &quot; AND ITEM155 = &apos;false&apos; AND (ITEM314 not in(&apos;W&apos;,&apos;Y&apos;) or ITEM314 is null ) &quot;;
		}else if (&quot;已取得正式PO號碼&quot;.equals(Status)){
			sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM314 = &apos;Y&apos; &quot;;
		}
	}
	//採購類別
	var PRTYPE = Form.getValue(&quot;PRTYPE&quot;);
	if (!&quot;全部&quot;.equals(PRTYPE)) {
		sSQL += &quot; AND ITEM66 = &apos;&quot;+PRTYPE+&quot;&apos; &quot;;
	}
	// 用途說明
	var spec = Form.getValue(&quot;spec&quot;);	
	if (!&quot;&quot;.equals(spec)) {
		sSQL += &quot; AND ITEM15 like &apos;%&quot; + spec + &quot;%&apos;&quot;;
	}		
	// 品名規格
	var Subject = Form.getValue(&quot;Subject&quot;);	
	if (!&quot;&quot;.equals(Subject)) {
		sSQL += &quot; AND ITEM165 like &apos;%&quot; + Subject + &quot;%&apos;&quot;;
	}		
	// QTA  add by wangwei@2016/09/26
	var vQTA = Form.getValue(&quot;QTA&quot;);
	if (&quot;true&quot;.equals(vQTA)){	
		sSQL += &quot; AND ITEM377 = &apos;true&apos; or  ART00821240794933606_ins.insid in (  select insid from   ART00821240794933606ITEM157 where ITEM96 = &apos;true&apos; )&quot;; //2019/05/21 增加明細
	}
	// 議價中@2018/10/05
	var vBargain = Form.getValue(&quot;CB_bargain&quot;);
	if (&quot;true&quot;.equals(vBargain)){	
		sSQL += &quot;AND ITEM155 = &apos;false&apos; AND ITEM395 is not null AND ITEM396 is null&quot;;		
	}		
	
	return sSQL;
}
// ----------------------------------------------------------------
function isExecuteAddAS(rootid,proid){  	// add by wangwei@2012/07/31 copy from 資訊服務申請單查詢
	var sql = &quot;select tskid from add_task where signtskid=&quot;;
		sql +=&quot;(select min(tskid) from task where rootid=&apos;&quot;+rootid+&quot;&apos; and proid=&apos;&quot;+proid+&quot;&apos; and state&lt;&gt;&apos;complete&apos;)&quot;;
		sql +=&quot; and signtime=0 order by tskid&quot;;
	var vec = Client.SQLloadValue(sql);	
	var name_list = new Packages.java.lang.StringBuffer();
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		for(var i =0;i&lt;vec.size();i++){
			var Task = Client.getTask(vec.get(i).get(&quot;tskid&quot;));
			var realExecutorMemID = Task.getRealExecutor();
			var memberRecord = Client.getMemberByID(realExecutorMemID);
			var username = memberRecord.getName();
			name_list.append(username);
			name_list.append(&quot;;&quot;);
		}
	}
	return name_list;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00071307685833337</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/06/13 09:44:33</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.scrap.server.SystemAutoAssign</string> 
     </void> 
     <void property="id"> 
      <string>SCL00071307685833337</string> 
     </void> 
     <void property="name"> 
      <string>SystemAutoAssign</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041307504199431</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/*
  原物料報廢申請單-檢查是否有簽核人員
*/
function autoAssignManager(toProcess,toNextProcess){
	var alnstance = MyTask.getArtInstance();
	var ManagerList = alnstance.getAppValue(&quot;onerList&quot;);
	if (!(ManagerList.equals(&quot;&quot;)) &amp;&amp; ManagerList.indexOf(&quot;,&quot;)!=-1){
		alnstance.setAppValue(&quot;oner&quot;,ManagerList.substring(0,ManagerList.indexOf(&quot;,&quot;)));
		alnstance.setAppValue(&quot;onerList&quot;,ManagerList.substring(ManagerList.indexOf(&quot;,&quot;)+1,ManagerList.length()));
		Server.flowTo(MyTask,toProcess);
	} else{
		alnstance.setAppValue(&quot;oner&quot;,&quot;&quot;);
		Server.flowTo(MyTask,toNextProcess);
	}
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>自動判斷有無簽核人員</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00081105425836005</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.MemberFunction.ManagerFunction</string> 
     </void> 
     <void property="id"> 
      <string>SCL00081105425836005</string> 
     </void> 
     <void property="name"> 
      <string>ManagerFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031102066129487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//取出該人員的主管
function getManagerOf(theMember){
	//先找該人員的部門主管
	var memRoleID = theMember.getMainRoleID();
	var memDR = theMember.getMemberDR(memRoleID);
	var department = Client.getDepartment(memDR.getDepartmentID());

	var managerRoleID = department.getManagerID();
	var managerRole = Client.getRole(managerRoleID);
	var managerID = managerRole.getMemberList().get(0);
	var manager = Client.getMemberByID(managerID);
	
	//若該人員自己就是主管,則再找上一層組織的主管
	if(manager.getMyID().equals(theMember.getMyID())){
		var parentDepID = department.getParentID();  //上層部門ID
		managerRoleID = Client.getDepartment(parentDepID).getManagerID();  //上層主管RoleID
		managerRole = Client.getRole(managerRoleID);
		managerID = managerRole.getMemberList().get(0);
		manager = Client.getMemberByID(managerID);
	}
	
	return manager;
}
//該人員是否主管
function isManager(theMember){
	//先找該人員的部門主管
	var memRoleID = theMember.getMainRoleID();
	var memDR = theMember.getMemberDR(memRoleID);
	var department = Client.getDepartment(memDR.getDepartmentID());

	var managerRoleID = department.getManagerID();
	var managerRole = Client.getRole(managerRoleID);
	var managerID = managerRole.getMemberList().get(0);
	var manager = Client.getMemberByID(managerID);
	
	//若該人員自己就是主管
	if(manager.getMyID().equals(theMember.getMyID())){
		return true;
	} else {
		return false;
	}	

}
//該人員是否為帳項部門主管
function isAccManager(theMember,accDepartment){
	//先找該人員的部門主管
	var memRoleID = theMember.getMainRoleID();
	var memDR = theMember.getMemberDR(memRoleID);
	var department = Client.getDepartment(memDR.getDepartmentID());

	var managerRoleID = department.getManagerID();
	var managerRole = Client.getRole(managerRoleID);
	var managerID = managerRole.getMemberList().get(0);
	var manager = Client.getMemberByID(managerID);
	
	java.lang.System.out.println(&quot;accDepartment:&quot; + accDepartment.getName());
	java.lang.System.out.println(&quot;department:&quot; + department.getName());
	
	//若該人員自己就是主管
	if(manager.getMyID().equals(theMember.getMyID()) &amp;&amp; department.getID().equals(accDepartment.getID())){
		return true;
	} else {
		return false;
	}	

}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>取得 Manager 的相關資訊</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00081144128900643</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/04/04 13:35:00</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.PDFExportFunction</string> 
     </void> 
     <void property="id"> 
      <string>SCL00081144128900643</string> 
     </void> 
     <void property="name"> 
      <string>PDFExportFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//建立document物件
function createDocument(filePath,fileName){

	//取得檔案物件
	var fileOut = new Packages.java.io.FileOutputStream(filePath + fileName); 
	
	//建立 Document 物件
	var document = new Packages.com.lowagie.text.Document(Packages.com.lowagie.text.PageSize.A4,40,40,35,35);
	//取得 PdfWriter 物件
	var writer = Packages.com.lowagie.text.pdf.PdfWriter.getInstance(document,fileOut);
	//設定 PDF 安全性 &quot;只能列印&quot;
	writer.setEncryption(false,&quot;&quot;,&quot;&quot;,2052);
	
	return document;
}
//產生 phrase 物件
function phrase (context,alignment,fontSize){
	
	var bf = null;
	var font = null;
	var ph = null;
	var fontName = &quot;MSungStd-Light&quot;; //細明體
	var encodingName =  &quot;UniCNS-UCS2-H&quot;; // Adobe-CNS 的 Unicode 編碼
	
	
	try {
		bf = Packages.com.lowagie.text.pdf.BaseFont.createFont(fontName,encodingName,false);
		font = new Packages.com.lowagie.text.Font(bf,fontSize);
		ph = new Packages.com.lowagie.text.Paragraph(context,font);
		ph.setAlignment(alignment);
	} catch (e){
		java.lang.System.out.println(e.toString());			
	}	
	return ph;
	
}	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>匯出至PDF相關功能</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00081157807667218</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/09/09 21:14:27</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ECN.Server</string> 
     </void> 
     <void property="id"> 
      <string>SCL00081157807667218</string> 
     </void> 
     <void property="name"> 
      <string>Server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031157709081640</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//erpartid ERP 單別ex: ECN
//itemid 表單欄位的 itemid ex: ITEM176
//itemname 表單欄位的名稱 ex : ECN_No
function setERPNo(erpartid,itemid,itemname){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	var artid = aInstance.getArtifactID(); //ART00021154532228237
	var erpid = getErpID(erpartid,itemid,artid+&quot;_Ins&quot;); //ECN / ECR / PCR,item176
	dataMap.put(itemname,erpid);
}



function getErpID(erpartid,itemid,tablename){
	var serverTime = Server.getServerTime();
	var myDate = new Packages.pase.agenda.MyDate(serverTime);
	var today = myDate.getCurrentDate(&quot;Y/M/D&quot;); 
	var month = today.substring(5,7);
	if (month.equals(&quot;10&quot;)){
		month = &quot;A&quot;;
	}else if (month.equals(&quot;11&quot;)){
		month = &quot;B&quot;;
	}else if (month.equals(&quot;12&quot;)){
		month = &quot;C&quot;;
	}else{
		month = today.substring(6,7);
	}
	var l_date = &quot;-&quot; + today.substring(2,4)+ month;
	//ECN-06A001 
	// SELECT RIGHT(ITEM176, 3) AS Expr1 FROM             ART00021154532228237_Ins WHERE         (ITEM176 &lt;&gt; &apos;&apos;) AND (ITEM176 IS NOT NULL) AND (ITEM176 LIKE &apos;ECN-068%&apos;)
	var l_sql = &quot; select Right(max(&quot;+ itemid + &quot;),3) MAXNO from &quot; + tablename + &quot; where &quot;+ itemid +&quot; &lt;&gt;&apos;&apos; and &quot;+ itemid +&quot; is not null and &quot;+ itemid + &quot; like &apos;&quot;+ erpartid + l_date +&quot;%&apos; &quot;;
	var data = Server.SQLloadValue(l_sql);
	if(data.get(0).get(&quot;MAXNO&quot;)!=&quot;&quot;){
		var maxno = data.get(0).get(&quot;MAXNO&quot;);
		var maxno = java.lang.Integer.parseInt(maxno) + 1;
		maxno = maxno + &quot;&quot;;//轉為 string
		if(maxno.length == 1 ){
			maxno = &quot;00&quot; + maxno;				
		}else if(maxno.length == 2 ) {
			maxno = &quot;0&quot; + maxno;				
		}else if(maxno.length == 3 ) {
			maxno = &quot;&quot; + maxno;				
		}
	}else{
		var maxno = &quot;001&quot;;
	}
	var erpid = erpartid  + l_date + maxno;
	return erpid ;
}



    function getFormatedCurrentTime(){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
        return simpledateformat.format(date);
    }
	

	
function setTableAzp(){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	var tableDataVector = new java.util.Vector();
	try{
		var conn_erp = Server.createSessionConnection(&quot;ERP&quot;);
		var sql = &quot; select azp01 代號, azp02 名稱 from azp_file where azp053 = &apos;Y&apos; &quot; ;
		var vector = conn_erp.loadValue(sql);
		if ( vector != null &amp;&amp; vector.size()&gt;0){
			for(var i=0;i&lt;vector.size();i++)	{
				var tableDataMap = new java.util.HashMap();
				
				tableDataMap.put(&quot;ITEM2&quot;, vector.get(i).get(&quot;代號&quot;));
				tableDataMap.put(&quot;ITEM3&quot;, vector.get(i).get(&quot;名稱&quot;));
				if(&quot;TW&quot; == vector.get(i).get(&quot;代號&quot;).trim()||&quot;DG&quot; == vector.get(i).get(&quot;代號&quot;).trim()){
						tableDataMap.put(&quot;ITEM1&quot;,&quot;true&quot;);
				}
				tableDataVector.add(tableDataMap);
			}//for

	 }
	
	}catch(e){}
	if(conn_erp != null)	{
		try	{
			conn_erp.commit();
		}catch(e){}
		conn_erp.close();
	}
	
	dataMap.put(&quot;TableAzp&quot;,tableDataVector);
}	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00081197709110953</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/12/15 16:58:30</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.DMS.DMSSearch</string> 
     </void> 
     <void property="id"> 
      <string>SCL00081197709110953</string> 
     </void> 
     <void property="name"> 
      <string>DMSSearch</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011194752256531</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//===================================================================
// 分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
				var hm = vec.get(i);
				var row = table.newRow()-1;
				table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
				table.setValueAt(hm.get(&quot;SERIALID&quot;) 	,row,&quot;文件編號&quot;);
				table.setValueAt(hm.get(&quot;DOCUMENTNAME&quot;) ,row,&quot;文件名稱&quot;);
				var depid = hm.get(&quot;BELONGTODEPT&quot;);
				if(depid != &quot;&quot;){
					var depname = &quot;&quot;;
					if(&quot;company&quot; == depid){
						depname = &quot;company&quot;;
					}else{
						depname = Client.getDepartment(depid).getName();
					}
					table.setValueAt(depname,row,&quot;所屬部門&quot;);
				}
				table.setValueAt(hm.get(&quot;TYPENAME&quot;) 	,row,&quot;文件類別&quot;);
				table.setValueAt(hm.get(&quot;AUTHORNAME&quot;)   ,row,&quot;作者&quot;);
				table.setValueAt(hm.get(&quot;VERSIONID&quot;)	,row,&quot;版本&quot;);			
				table.setValueAt(hm.get(&quot;acdate&quot;)   	,row,&quot;發佈日期&quot;);
				table.setValueAt(hm.get(&quot;STATUS&quot;)   	,row,&quot;狀態&quot;);			
				table.setValueAt(hm.get(&quot;DOCUMENTKEY&quot;)  ,row,&quot;DOCUMENTKEY&quot;);	
				table.setValueAt(hm.get(&quot;ATT27&quot;)    	,row,&quot;文件來源&quot;);	
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>文件搜尋使用</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00081229050014461</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/03/19 10:53:29</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Client.PDM_List</string> 
     </void> 
     <void property="id"> 
      <string>SCL00081229050014461</string> 
     </void> 
     <void property="name"> 
      <string>PDM_List</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021229049977055</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//========================================================================================
// MECN共用條件的SQL SEARCH 
//========================================================================================
function MECN_Search_check(){	
	var member = Client.getCurrentMember().getName();
	Client.addDebugLog(&quot;mecn search start -&quot;+member);
	var unfinish = Form.getValue(&quot;unfinish&quot;);
	
	Client.removeLocalObject(&quot;vec0&quot;);
	Client.removeLocalObject(&quot;vec1&quot;);
	Client.removeLocalObject(&quot;vec2&quot;);
	Client.removeLocalObject(&quot;vec3&quot;);
	Client.removeLocalObject(&quot;vec4&quot;);
	Client.removeLocalObject(&quot;vec5&quot;);
	Client.removeLocalObject(&quot;vec6&quot;);
	Client.removeLocalObject(&quot;vec7&quot;);
	Client.removeLocalObject(&quot;vec8&quot;);
	
	Form.setValue(&quot;apply_count&quot;,&quot;&quot;);
	Form.setValue(&quot;finish_count&quot;,&quot;&quot;);
	Form.setValue(&quot;unfinishe_count&quot;,&quot;&quot;);
	Form.setValue(&quot;cancel_count&quot;,&quot;&quot;);
	Form.setValue(&quot;reject_count&quot;,&quot;&quot;);
	Form.setValue(&quot;re_finish_count&quot;,&quot;&quot;);
	Form.setValue(&quot;re_unfinishe_count&quot;,&quot;&quot;);	
	Form.setValue(&quot;re_cancel_count&quot;,&quot;&quot;);

	//  MECN暫時用編號判斷廠別~~Where尚未增加~~
	var msg = &quot;&quot;;
//	if(&quot;true&quot;!= Form.getValue(&quot;TYPE_A&quot;)&amp;&amp;&quot;true&quot;!=Form.getValue(&quot;TYPE_B&quot;)&amp;&amp;&quot;true&quot;!=Form.getValue(&quot;TYPE_C1&quot;)&amp;&amp;&quot;true&quot;!=Form.getValue(&quot;TYPE_C2&quot;)){
//		msg += &quot;請至少選擇一筆相關類別!\n&quot;;			
//	}	
//	if(&quot;true&quot;!= Form.getValue(&quot;TGCE&quot;)&amp;&amp;&quot;true&quot;!=Form.getValue(&quot;SGCE&quot;)&amp;&amp;&quot;true&quot;!=Form.getValue(&quot;CGCE&quot;)){
//		msg += &quot;請至少選擇一筆相關廠別!\n&quot;;			
//	}		
	if(msg != &quot;&quot;){
		Form.setComplete(false);
		Form.showMessageDialog(msg);
	}else{  
		    var projectid_1 = &quot;PRJ00111211426688700&quot;;   //Project PDM
		    var projectid_2 = &quot;PRJ00311259303602271&quot;;	  //Project MECN
		
//		    var projectid = Form.getValue(&quot;projectid&quot;);
	        var artifact = Form.getValue(&quot;Artifact&quot;);
//			var v_version = Form.getValue(&quot;MECN_Version&quot;);
	        var sql = &quot;select artid  from art_geninf where prjid in (&apos;&quot; + projectid_1 + &quot;&apos;,&apos;&quot; + projectid_2 + &quot;&apos;) and name like &apos;&quot; + artifact + &quot;%V%&apos; order by name&quot;;

	        var vec0 = Client.SQLloadValue(sql);
			Client.setLocalObject(&quot;vec0&quot;,vec0);
			
			if(artifact != &quot;MECN核准單&quot;){
			  var artid = vec0.get(0).get(&quot;artid&quot;);
	           if(vec0.size()&gt;1){
			      var artid_1 = vec0.get(1).get(&quot;artid&quot;);
				  var artid_2 =  vec0.get(2).get(&quot;artid&quot;);
				  var artid_3 =  vec0.get(3).get(&quot;artid&quot;);	
				  var artid_4 =  vec0.get(4).get(&quot;artid&quot;);
			   }else{
				  var artid_1 =&quot;&quot;;
			      var artid_2 =&quot;&quot;;
			      var artid_3 =&quot;&quot;;	
				  var artid_4 =&quot;&quot;;
			   }
			
			}else{
				var artid = &quot;&quot;;
				var artid_1 = vec0.get(0).get(&quot;artid&quot;);
				var artid_2 = vec0.get(1).get(&quot;artid&quot;);				
				var artid_3 = vec0.get(2).get(&quot;artid&quot;);	
				var artid_4 = vec0.get(3).get(&quot;artid&quot;);					
			}	
			
			Form.setValue(&quot;artid&quot;,artid);
			Form.setValue(&quot;artid_1&quot;,artid_1);
			
			loadLibrary(&quot;com.A.Common.Client.Util&quot;);
			var cost_1 = &quot;&quot;;
			var cost_2 = &quot;&quot;;
			if(artifact == &quot;MECN申請單&quot;){
				var temp1 = &quot;,ITEM350 reason,A.ITEM11 context&quot;
				var temp2 = &quot;,ITEM161 reason,ITEM69 context&quot;
				//MECN申請單V6才有的欄位(成本增加相關欄位，匯出excel用) add by edison@20180108
				cost_1 = &quot;,&apos;&apos; ITEM529,&apos;&apos; ITEM534,&apos;&apos; ITEM535,&apos;&apos; ITEM536,&apos;&apos; ITEM537,&apos;&apos; ITEM538,&apos;&apos; ITEM543,&apos;&apos; ITEM545,&apos;&apos; ITEM546,&apos;&apos; ITEM548,&apos;&apos; paper_sign &quot;;				
				cost_2 = &quot;,ITEM529,ITEM534,ITEM535,ITEM536,ITEM537,ITEM538,to_char(ITEM543)ITEM543,ITEM545,ITEM546,ITEM548,decode(ITEM26,&apos;true&apos;,&apos;是&apos;,&apos;否&apos;)paper_sign &quot;;
			}else if(artifact == &quot;MECN實驗結果&quot;){
				var temp1 = &quot;,ITEM197 context,ITEM354 plan,&apos;&apos; result&quot;
				var temp2 = &quot;,ITEM274 context,A.ITEM11 plan ,ITEM92 result&quot;
			}else{
				var temp1 = &quot;,A.ITEM11 context&quot;
			  	var temp2 = &quot;,&apos;&apos; context&quot;
			}
			if(unfinish.equals(&quot;false&quot;)){
			//1
			try{
				var sql =&quot;SELECT INSID,ITEM62,ITEM325,ITEM318,ITEM12,ITEM200,ITEM66,ITEM155,ITEM115,ITEM231&quot;+temp1+cost_1;					
				    sql +=&quot; FROM &quot;+ artid_3 +&quot;_INS A &quot;;
					sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot;;
					sql +=&quot; AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += getQuery_MECN()+getManagerChk(&quot;1&quot;);
					//V6------------------
					sql +=&quot; union all &quot;;				
				    sql +=&quot;SELECT INSID,ITEM62,ITEM325,ITEM318,ITEM12,ITEM200,ITEM66,ITEM155,ITEM115,ITEM231&quot;+temp1+cost_2;					
				    sql +=&quot; FROM &quot;+ artid_4 +&quot;_INS A &quot;;
					sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot;;
					sql +=&quot; AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += getQuery_MECN()+getManagerChk(&quot;1&quot;);
					//V6------------------
				    sql +=&quot; union all &quot;;				
				    sql +=&quot;SELECT INSID,ITEM62,ITEM325,ITEM318,ITEM12,ITEM200,ITEM66,ITEM155,ITEM115,ITEM231&quot;+temp1+cost_1;
				    sql +=&quot; FROM &quot;+ artid_2 +&quot;_INS A &quot;;
					sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot;;
					sql +=&quot; AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += getQuery_MECN()+getManagerChk(&quot;2&quot;);
				    sql +=&quot; union all &quot;;
				    sql +=&quot;SELECT INSID,ITEM62,ITEM325,ITEM318,ITEM12,ITEM200,ITEM66,ITEM155,ITEM115,ITEM231&quot;+temp1+cost_1;
				    sql +=&quot; FROM &quot;+ artid_1 +&quot;_INS A &quot;;
					sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot;;
					sql +=&quot; AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += getQuery_MECN()+getManagerChk(&quot;2&quot;);
				if (artid != &quot;&quot;){
                    sql +=&quot; union all &quot;;
					sql +=&quot;SELECT INSID,ITEM62,ITEM325,ITEM318,ITEM12,ITEM200,ITEM66,ITEM155,ITEM115,&apos;&apos;&quot;+temp2+cost_1;
				    sql +=&quot; FROM &quot;+ artid +&quot;_INS A &quot;;
					sql +=&quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += getQuery_MECN()+getManagerChk(&quot;2&quot;);
				}	
					sql += &quot;ORDER BY ITEM12 desc &quot;;
//				Client.addDebugLog(&quot;mecn-sql1=&quot;+sql);	
				var vec1 = Client.SQLloadValue(sql);
				
				Client.setLocalObject(&quot;vec1&quot;,vec1);

			}catch(e){
				java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
			}	
			Form.setValue(&quot;apply_count&quot;,vec1.size()+&quot;&quot;);
			}
			if(unfinish.equals(&quot;false&quot;)){
			//2
			try{
				var sql = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_1; 
		            sql += &quot; FROM &quot;+ artid_3 +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot; WHERE ITEM62 != &apos;null&apos; &quot;;		
					sql += &quot; AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_finish_count(&quot;V5&quot;)+getManagerChk(&quot;1&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;
					//V6------------------
					sql +=&quot; union all &quot;;				
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_2; 					
		            sql += &quot; FROM &quot;+ artid_4 +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot; WHERE ITEM62 != &apos;null&apos; &quot;;		
					sql += &quot; AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_finish_count(&quot;V6&quot;)+getManagerChk(&quot;1&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;
					//V6------------------
					sql +=&quot; union all &quot;;				
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_1; 
		            sql += &quot; FROM &quot;+ artid_2 +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot; WHERE ITEM62 != &apos;null&apos; &quot;;		
					sql += &quot; AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_finish_count(&quot;V4&quot;)+getManagerChk(&quot;2&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;
					sql +=&quot; union all &quot;;
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_1; 
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot; WHERE ITEM62 != &apos;null&apos; &quot;;		
					sql += &quot; AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_finish_count(&quot;V3&quot;)+getManagerChk(&quot;2&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;
				if (artid != &quot;&quot; &amp;&amp; artifact != &quot;MECN實驗結果&quot;){		
					sql +=&quot; union all &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;&quot;+temp2+cost_1;
					sql += &quot; FROM &quot;+ artid +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;		
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_finish_count(&quot;V2&quot;)+getManagerChk(&quot;2&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;
			   }else if (artifact == &quot;MECN實驗結果&quot;){		
					sql +=&quot; union all &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;&quot;+temp2+cost_1;
					sql += &quot; FROM &quot;+ artid +&quot;_INS A &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;	
					sql += &quot;AND A.ITEM115 is  not null and A.ITEM155=&apos;false&apos; &quot;;
					sql += &quot;&quot; + getQuery_MECN() +getManagerChk(&quot;2&quot;);
			   }		
		            sql += &quot;ORDER BY ITEM12 desc &quot;;
//					Client.addDebugLog(&quot;mecn-sql2=&quot;+sql);
				var vec2 = Client.SQLloadValue(sql);
			    Client.setLocalObject(&quot;vec2&quot;,vec2);
				
				if (artid != &quot;&quot;){	
				if(vec2.size()&lt;=0){
				   	var sql = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115&quot;+temp2;
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A&quot;;
		            sql += &quot; WHERE ITEM62 != &apos;null&apos; &quot;;				
					sql += &quot;&quot; + getQuery_MECN()+getManagerChk(&quot;1&quot;);
					sql += &quot; AND A.ITEM115 is  not null AND ITEM155 = &apos;false&apos; &quot;; 
		            sql += &quot; ORDER BY ITEM12 desc&quot;;
					
				   var vec2 = Client.SQLloadValue(sql);
			       Client.setLocalObject(&quot;vec2&quot;,vec2);
				}
			  }	
			}catch(e){
				java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
			}	
			Form.setValue(&quot;finish_count&quot;,vec2.size()+&quot;&quot;);	
			}
			//3
			try{
				var sql  = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_1; 
		            sql += &quot; FROM &quot;+ artid_3 +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;	
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_unfinishe_count(&quot;V5&quot;)+getManagerChk(&quot;1&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;	
					sql +=&quot; union all &quot;;				
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_2; 					
		            sql += &quot; FROM &quot;+ artid_4 +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;	
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_unfinishe_count(&quot;V6&quot;)+getManagerChk(&quot;1&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;
					sql +=&quot; union all &quot;;				
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_1; 
		            sql += &quot; FROM &quot;+ artid_2 +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;	
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_unfinishe_count(&quot;V4&quot;)+getManagerChk(&quot;2&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;	
					sql +=&quot; union all &quot;;
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_1; 
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;	
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_unfinishe_count(&quot;V3&quot;)+getManagerChk(&quot;2&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;
  			    if (artid != &quot;&quot;){	
					sql +=&quot; union all &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;&quot;+temp2+cost_1; 
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;	
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_unfinishe_count(&quot;V2&quot;)+getManagerChk(&quot;2&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;
				}	
		            sql += &quot;ORDER BY ITEM12 desc&quot;;
//					Client.addDebugLog(&quot;mecn-sql3=&quot;+sql);
				var vec3 = Client.SQLloadValue(sql);
  			    Client.setLocalObject(&quot;vec3&quot;,vec3);
				
			}catch(e){
				java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
			}	
			Form.setValue(&quot;unfinishe_count&quot;,vec3.size()+&quot;&quot;);	
			if(unfinish.equals(&quot;false&quot;)){
			//4
			try{
				var sql =  &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_1;
				    sql += &quot; FROM &quot;+ artid_3 +&quot;_INS A &quot;;
					sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_cancel_count(&quot;V5&quot;)+getManagerChk(&quot;1&quot;);
					sql +=&quot; union all &quot;;						
				    sql +=  &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_2;					
				    sql += &quot; FROM &quot;+ artid_4 +&quot;_INS A &quot;;
					sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_cancel_count(&quot;V6&quot;)+getManagerChk(&quot;1&quot;);
			   	    sql +=&quot; union all &quot;;						
				    sql +=  &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_1;
				    sql += &quot; FROM &quot;+ artid_2 +&quot;_INS A &quot;;
					sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_cancel_count(&quot;V4&quot;)+getManagerChk(&quot;2&quot;);
			   	    sql +=&quot; union all &quot;;				
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1+cost_1;
				    sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A &quot;;
					sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_cancel_count(&quot;V3&quot;)+getManagerChk(&quot;2&quot;);
				if (artid != &quot;&quot;){	
			   	    sql +=&quot; union all &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;&quot;+temp2+cost_1;
				    sql += &quot; FROM &quot;+ artid +&quot;_INS A &quot;;
					sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_cancel_count(&quot;V2&quot;)+getManagerChk(&quot;2&quot;);
				}	
					sql += &quot; ORDER BY ITEM12 desc&quot;;
//					Client.addDebugLog(&quot;mecn-sql4=&quot;+sql);
				var vec4 = Client.SQLloadValue(sql);
	  		    Client.setLocalObject(&quot;vec4&quot;,vec4);
				
			}catch(e){
				java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
			}	
			Form.setValue(&quot;cancel_count&quot;,vec4.size()+&quot;&quot;);	
			}
			if(unfinish.equals(&quot;false&quot;)){
			//5
		    try{
				var sql =  &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1;
		            sql += &quot; FROM &quot;+ artid_3 +&quot;_INS A, &quot;+ artid_3 +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;	
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_reject_count(&quot;V5&quot;)+getManagerChk(&quot;1&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql +=&quot; union all &quot;;				
				    sql +=  &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_2;					
		            sql += &quot; FROM &quot;+ artid_4 +&quot;_INS A, &quot;+ artid_4 +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;	
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_reject_count(&quot;V6&quot;)+getManagerChk(&quot;1&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql +=&quot; union all &quot;;				
				    sql +=  &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1;
		            sql += &quot; FROM &quot;+ artid_2 +&quot;_INS A, &quot;+ artid_2 +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;	
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_reject_count(&quot;V4&quot;)+getManagerChk(&quot;2&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql +=&quot; union all &quot;;
		            sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1;
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A, &quot;+ artid_1 +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;	
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_reject_count(&quot;V3&quot;) +getManagerChk(&quot;2&quot;)+ &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
 			    if (artid != &quot;&quot;){	
					sql +=&quot; union all &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp2+cost_1;
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A, &quot;+ artid +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;	
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_reject_count(&quot;V2&quot;)+getManagerChk(&quot;2&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
				}	
		            sql += &quot;ORDER BY ITEM12 desc&quot;;
//					Client.addDebugLog(&quot;mecn-sql5=&quot;+sql);
		        var vec5 = Client.SQLloadValue(sql);
				
			    Client.setLocalObject(&quot;vec5&quot;,vec5);
				
	        }catch(e){
		        java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
	        }
			Form.setValue(&quot;reject_count&quot;,vec5.size()+&quot;&quot;);
			}
			if(unfinish.equals(&quot;false&quot;)){
			//6
			try{
				var sql = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1;
		            sql += &quot; FROM &quot;+ artid_3 +&quot;_INS A, &quot;+ artid_3 +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_finish_count(&quot;V5&quot;) +getManagerChk(&quot;1&quot;)+ &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;		
					sql +=&quot; union all &quot;;				
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_2;					
		            sql += &quot; FROM &quot;+ artid_4 +&quot;_INS A, &quot;+ artid_4 +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_finish_count(&quot;V6&quot;)+getManagerChk(&quot;1&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;
					sql +=&quot; union all &quot;;				
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1;
		            sql += &quot; FROM &quot;+ artid_2 +&quot;_INS A, &quot;+ artid_2 +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_finish_count(&quot;V4&quot;)+getManagerChk(&quot;2&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;		
					sql +=&quot; union all &quot;;
		            sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1;
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A, &quot;+ artid_1 +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_finish_count(&quot;V3&quot;) +getManagerChk(&quot;2&quot;)+ &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;	
				if (artid != &quot;&quot; &amp;&amp; artifact != &quot;MECN實驗結果&quot;){		
					sql +=&quot; union all &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp2+cost_1; 
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A, &quot;+ artid +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_finish_count(&quot;V2&quot;)+getManagerChk(&quot;2&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;	
				}else if(artifact == &quot;MECN實驗結果&quot;){	
					sql +=&quot; union all &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp2+cost_1; 
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A, &quot;+ artid +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM115 is  not null AND ITEM155 = &apos;false&apos; AND ITEM208=&apos;repeat&apos; &quot;;
					sql += &quot;AND A.INSID  = B.INSID &quot;;
		            sql += &quot;&quot; + getQuery_MECN()+getManagerChk(&quot;2&quot;) ;	
				}	
		            sql += &quot;ORDER BY ITEM12 desc&quot;;
//					Client.addDebugLog(&quot;mecn-sql6=&quot;+sql);
		        var vec6 = Client.SQLloadValue(sql);				
			    Client.setLocalObject(&quot;vec6&quot;,vec6);
				
	        }catch(e){
		        java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
	        }
			Form.setValue(&quot;re_finish_count&quot;,vec6.size()+&quot;&quot;);	
			}
			if(unfinish.equals(&quot;false&quot;)){
			//7
			try{
				var sql = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1; 		
		            sql += &quot; FROM &quot;+ artid_3 +&quot;_INS A, &quot;+ artid_3 +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;					
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_unfinishe_count(&quot;V5&quot;) +getManagerChk(&quot;1&quot;)+ &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;
					sql +=&quot; union all &quot;;				
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_2; 					
		            sql += &quot; FROM &quot;+ artid_4 +&quot;_INS A, &quot;+ artid_4 +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;					
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_unfinishe_count(&quot;V6&quot;)+getManagerChk(&quot;1&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;
					sql +=&quot; union all &quot;;				
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1; 		
		            sql += &quot; FROM &quot;+ artid_2 +&quot;_INS A, &quot;+ artid_2 +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;					
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_unfinishe_count(&quot;V4&quot;)+getManagerChk(&quot;2&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;	
					sql +=&quot; union all &quot;;
		            sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1; 		
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A, &quot;+ artid_1 +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;					
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_unfinishe_count(&quot;V3&quot;) +getManagerChk(&quot;2&quot;)+ &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;	
   			    if (artid != &quot;&quot;){	
					sql +=&quot; union all &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp2+cost_1; 			
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A, &quot;+ artid +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;			
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_unfinishe_count(&quot;V2&quot;) +getManagerChk(&quot;2&quot;)+ &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;	
				}	
		            sql += &quot;ORDER BY ITEM12 desc&quot;;
//				Client.addDebugLog(&quot;mecn-sql7=&quot;+sql);
		        var vec7 = Client.SQLloadValue(sql);
			
			    Client.setLocalObject(&quot;vec7&quot;,vec7); 
				
	        }catch(e){
		        java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
	        }
			Form.setValue(&quot;re_unfinishe_count&quot;,vec7.size()+&quot;&quot;);		
			}
			if(unfinish.equals(&quot;false&quot;)){
			//8
			try{
				var sql = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1; 
		            sql += &quot; FROM &quot;+ artid_3 +&quot;_INS A, &quot;+ artid_3 +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;							
		            sql +=  &quot;&quot; + getQuery_MECN() + getQueryCondition_re_cancel_count(&quot;V5&quot;) +getManagerChk(&quot;1&quot;)+ &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;	
					sql +=&quot; union all &quot;;					
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_2; 					
		            sql += &quot; FROM &quot;+ artid_4 +&quot;_INS A, &quot;+ artid_4 +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;							
		            sql +=  &quot;&quot; + getQuery_MECN() + getQueryCondition_re_cancel_count(&quot;V6&quot;)+getManagerChk(&quot;1&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql +=&quot; union all &quot;;					
				    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1; 
		            sql += &quot; FROM &quot;+ artid_2 +&quot;_INS A, &quot;+ artid_2 +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;							
		            sql +=  &quot;&quot; + getQuery_MECN() + getQueryCondition_re_cancel_count(&quot;V4&quot;)+getManagerChk(&quot;2&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;			
					sql +=&quot; union all &quot;;	
		            sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1+cost_1; 
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A, &quot;+ artid_1 +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;							
		            sql +=  &quot;&quot; + getQuery_MECN() + getQueryCondition_re_cancel_count(&quot;V3&quot;) +getManagerChk(&quot;2&quot;)+ &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
				if (artid != &quot;&quot;){					
					sql +=&quot; union all &quot;;	
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp2+cost_1; 
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A, &quot;+ artid +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;					
		            sql +=  &quot;&quot; + getQuery_MECN() + getQueryCondition_re_cancel_count(&quot;V2&quot;) +getManagerChk(&quot;2&quot;)+ &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
				}	
		            sql += &quot;ORDER BY ITEM12 desc&quot;;
//				Client.addDebugLog(&quot;mecn-sql8=&quot;+sql);
		        var vec8 = Client.SQLloadValue(sql);
				Client.addDebugLog(&quot;mecn-sql1-end&quot;);
			    Client.setLocalObject(&quot;vec8&quot;,vec8);
				
	        }catch(e){
		        java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
	        }	
			Form.setValue(&quot;re_cancel_count&quot;,vec8.size()+&quot;&quot;);
			}
			var table = Form.getComponent(&quot;ResultTable&quot;);
			table.clear();	
			Form.setValue(&quot;vec_temp&quot;,&quot;&quot;);	
			
	}
	Client.addDebugLog(&quot;mecn search end -&quot;+member);
}//function MECN_Search_check()
function MECN_Search(){	
	    var projectid_1 = &quot;PRJ00111211426688700&quot;;   //Project PDM
		    var projectid_2 = &quot;PRJ00311259303602271&quot;;	  //Project MECN
		
//		    var projectid = Form.getValue(&quot;projectid&quot;);
	        var artifact = Form.getValue(&quot;Artifact&quot;);
//			var v_version = Form.getValue(&quot;MECN_Version&quot;);
	        var sql = &quot;select artid  from art_geninf where prjid in (&apos;&quot; + projectid_1 + &quot;&apos;,&apos;&quot; + projectid_2 + &quot;&apos;) and name like &apos;&quot; + artifact + &quot;%V%&apos; order by name desc&quot;;

	        var vec0 = Client.SQLloadValue(sql);
			Client.setLocalObject(&quot;vec0&quot;,vec0);
			
			var artid = vec0.get(0).get(&quot;artid&quot;);
	        if(vec0.size()==2){
			    var artid_1 = vec0.get(1).get(&quot;artid&quot;);
			}else{
			   var artid_1 = &quot;&quot;;
			}
			Form.setValue(&quot;artid&quot;,artid);
			Form.setValue(&quot;artid_1&quot;,artid_1);
			
			loadLibrary(&quot;com.A.Common.Client.Util&quot;);
			
			if(artifact == &quot;MECN申請單&quot;){
				var temp1 = &quot;,ITEM350 reason,A.ITEM11 context&quot;
				var temp2 = &quot;,ITEM161 reason,ITEM69 context&quot;
			}else if(artifact == &quot;MECN實驗結果&quot;){
				var temp1 = &quot;,ITEM197 context,ITEM354 plan,&apos;&apos; result&quot;
				var temp2 = &quot;,ITEM274 context,A.ITEM11 plan ,ITEM92 result&quot;
			}else{
				var temp1 = &quot;,A.ITEM11 context&quot;
			  	var temp2 = &quot;,&apos;&apos; context&quot;
			}	
			//1
			try{
				var sql =&quot;SELECT INSID,ITEM62,ITEM325,ITEM318,ITEM12,ITEM200,ITEM66,ITEM155,ITEM115,ITEM231&quot;+temp1;
				    sql +=&quot; FROM &quot;+ artid +&quot;_INS A &quot;;
					sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot;;
					sql +=&quot; AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += getQuery_MECN();
				if (artid_1 != &quot;&quot;){
                    sql +=&quot; union  &quot;;
					sql +=&quot;SELECT INSID,ITEM62,ITEM325,ITEM318,ITEM12,ITEM200,ITEM66,ITEM155,ITEM115,&apos;&apos;&quot;+temp2;
				    sql +=&quot; FROM &quot;+ artid_1 +&quot;_INS A &quot;;
					sql +=&quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += getQuery_MECN();
				}	
					sql += &quot;ORDER BY ITEM12 desc &quot;;
				var vec1 = Client.SQLloadValue(sql);
				Client.setLocalObject(&quot;vec1&quot;,vec1);

			}catch(e){
				java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
			}	
			Form.setValue(&quot;apply_count&quot;,vec1.size()+&quot;&quot;);
			
			//2
			try{
				var sql = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1; 
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot; WHERE ITEM62 != &apos;null&apos; &quot;;		
					sql += &quot; AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_finish_count(&quot;V3&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;
				if (artid_1 != &quot;&quot; &amp;&amp; artifact != &quot;MECN實驗結果&quot;){		
					sql +=&quot; union  &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;&quot;+temp2;
					sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;		
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_finish_count(&quot;V2&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;
			   }else if (artifact == &quot;MECN實驗結果&quot;){		
					sql +=&quot; union  &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;&quot;+temp2;
					sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;	
					sql += &quot;AND A.ITEM115 is  not null&quot;;
					sql += &quot;&quot; + getQuery_MECN() ;
			   }		
		            sql += &quot;ORDER BY ITEM12 desc &quot;;
					
				var vec2 = Client.SQLloadValue(sql);
			    Client.setLocalObject(&quot;vec2&quot;,vec2);
				
				if (artid_1 != &quot;&quot;){	
				if(vec2.size()&lt;=0){
				   	var sql = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115&quot;+temp2;
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A&quot;;
		            sql += &quot; WHERE ITEM62 != &apos;null&apos; &quot;;				
					sql += &quot;&quot; + getQuery_MECN();
					sql += &quot; AND A.ITEM115 is  not null AND ITEM155 = &apos;false&apos; &quot;; 
		            sql += &quot; ORDER BY ITEM12 desc&quot;;
					
				   var vec2 = Client.SQLloadValue(sql);
			       Client.setLocalObject(&quot;vec2&quot;,vec2);
				}
			  }	
			}catch(e){
				java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
			}	
			Form.setValue(&quot;finish_count&quot;,vec2.size()+&quot;&quot;);	
			
			//3
			try{
				var sql  = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1; 
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;	
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_unfinishe_count(&quot;V3&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;	
  			    if (artid_1 != &quot;&quot;){	
					sql +=&quot; union  &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;&quot;+temp2; 
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A ,ARTINSTANCE B ,ART_STATE C &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;					
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_unfinishe_count(&quot;V2&quot;);
		            sql += &quot;AND A.INSID = B.INSID &quot;;
		            sql += &quot;AND B.ASTID=C.ASTID &quot;;
		            sql += &quot;AND B.ARTID=C.ARTID &quot;;
				}	
		            sql += &quot;ORDER BY ITEM12 desc&quot;;
				var vec3 = Client.SQLloadValue(sql);
  			    Client.setLocalObject(&quot;vec3&quot;,vec3);
		
			}catch(e){
				java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
			}	
			Form.setValue(&quot;unfinishe_count&quot;,vec3.size()+&quot;&quot;);	

			//4
			try{
				var sql =  &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231&quot;+temp1;
				    sql += &quot; FROM &quot;+ artid +&quot;_INS A &quot;;
					sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_cancel_count(&quot;V3&quot;);
				if (artid_1 != &quot;&quot;){	
			   	    sql +=&quot; union  &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;&quot;+temp2;
				    sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A &quot;;
					sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_cancel_count(&quot;V2&quot;);
				}	
					sql += &quot; ORDER BY ITEM12 desc&quot;;	
				var vec4 = Client.SQLloadValue(sql);			
	  		    Client.setLocalObject(&quot;vec4&quot;,vec4);
			}catch(e){
				java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
			}	
			Form.setValue(&quot;cancel_count&quot;,vec4.size()+&quot;&quot;);	
			
			//5
		    try{
		        var sql =  &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1;
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A, &quot;+ artid +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;	
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_reject_count(&quot;V3&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
 			    if (artid_1 != &quot;&quot;){	
					sql +=&quot; union  &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp2;
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A, &quot;+ artid_1 +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;	
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_reject_count(&quot;V2&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
				}	
		            sql += &quot;ORDER BY ITEM12 desc&quot;;
		        var vec5 = Client.SQLloadValue(sql);
			    Client.setLocalObject(&quot;vec5&quot;,vec5);
	        }catch(e){
		        java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
	        }
			Form.setValue(&quot;reject_count&quot;,vec5.size()+&quot;&quot;);	
			//6
			try{
		        var sql = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1;
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A, &quot;+ artid +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_finish_count(&quot;V3&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;	
				if (artid_1 != &quot;&quot; &amp;&amp; artifact != &quot;MECN實驗結果&quot;){		
					sql +=&quot; union  &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp2; 
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A, &quot;+ artid_1 +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_finish_count(&quot;V2&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;	
				}else if(artifact == &quot;MECN實驗結果&quot;){	
					sql +=&quot; union  &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp2; 
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A, &quot;+ artid_1 +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM115 is  not null AND ITEM155 = &apos;false&apos; AND ITEM208=&apos;repeat&apos; &quot;;
					sql += &quot;AND A.INSID  = B.INSID &quot;;
		            sql += &quot;&quot; + getQuery_MECN() ;	
				}	
		            sql += &quot;ORDER BY ITEM12 desc&quot;;
		        var vec6 = Client.SQLloadValue(sql);
			    Client.setLocalObject(&quot;vec6&quot;,vec6);
	        }catch(e){
		        java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
	        }
			Form.setValue(&quot;re_finish_count&quot;,vec6.size()+&quot;&quot;);	

			//7
			try{
		        var sql = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1; 		
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A, &quot;+ artid +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;					
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_unfinishe_count(&quot;V3&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;	
   			    if (artid_1 != &quot;&quot;){	
					sql +=&quot; union  &quot;;
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp2; 			
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A, &quot;+ artid_1 +&quot;ITEM28 B ,ARTINSTANCE C ,ART_STATE D &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;			
		            sql += &quot;&quot; + getQuery_MECN() + getQueryCondition_re_unfinishe_count(&quot;V2&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
					sql += &quot;AND A.INSID  = C.INSID &quot;;
					sql += &quot;AND C.ASTID  = D.ASTID &quot;;		
					sql += &quot;AND C.ARTID  = D.ARTID &quot;;	
				}	
		            sql += &quot;ORDER BY ITEM12 desc&quot;;
		        var vec7 = Client.SQLloadValue(sql);
			    Client.setLocalObject(&quot;vec7&quot;,vec7); 
	        }catch(e){
		        java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
	        }
			Form.setValue(&quot;re_unfinishe_count&quot;,vec7.size()+&quot;&quot;);		
			
			//8
			try{
		        var sql = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,A.ITEM231,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp1; 
		            sql += &quot; FROM &quot;+ artid +&quot;_INS A, &quot;+ artid +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += &quot;AND A.ITEM231=&apos;Y&apos;&quot;;							
		            sql +=  &quot;&quot; + getQuery_MECN() + getQueryCondition_re_cancel_count(&quot;V3&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
				if (artid_1 != &quot;&quot;){					
					sql +=&quot; union  &quot;;	
					sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM200,A.ITEM66,A.ITEM155,A.ITEM115,&apos;&apos;,B.ITEM6,B.ITEM4 manager,B.Item1&quot;+temp2; 
		            sql += &quot; FROM &quot;+ artid_1 +&quot;_INS A, &quot;+ artid_1 +&quot;ITEM28 B &quot;;
		            sql += &quot;WHERE ITEM62 != &apos;null&apos; &quot;;					
		            sql +=  &quot;&quot; + getQuery_MECN() + getQueryCondition_re_cancel_count(&quot;V2&quot;) + &quot; &quot;;
		            sql += &quot;AND A.INSID  = B.INSID &quot;;
		            sql += &quot;AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;
				}	
		            sql += &quot;ORDER BY ITEM12 desc&quot;;
		        var vec8 = Client.SQLloadValue(sql);
			    Client.setLocalObject(&quot;vec8&quot;,vec8);
	        }catch(e){
		        java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
	        }	
			Form.setValue(&quot;re_cancel_count&quot;,vec8.size()+&quot;&quot;);	
			var table = Form.getComponent(&quot;ResultTable&quot;);
			table.clear();	
			Form.setValue(&quot;vec_temp&quot;,&quot;&quot;);	
			
}			
//========================================================================================
// MECN共用條件的SQL SEARCH 
//========================================================================================
function getQuery_MECN(){	
	var sSQL=&quot;&quot;;	
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
		}
	}	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
		}
	}	
	// 部門名稱
	var DepName = Form.getValue(&quot;DepName&quot;);	
	if (!&quot;&quot;.equals(DepName)) {
		sSQL += &quot; AND ITEM325= &apos;&quot; + DepName + &quot;&apos;&quot;;
	}	
	// 申請人姓名
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM318= &apos;&quot; + MemName + &quot;&apos;&quot;;
	}			
	// 文件標題
	var Subject = Form.getValue(&quot;Subject&quot;);	 
	if (!&quot;&quot;.equals(Subject)) {
		sSQL += &quot; AND ITEM200 like &apos;&quot; + Subject + &quot;%&apos;&quot;;
	}
	// 文件編號
	var Sn = Form.getValue(&quot;Sn&quot;);	
	if (!&quot;&quot;.equals(Sn)) {
		sSQL += &quot; AND ITEM62 like &apos;&quot; + Sn + &quot;%&apos;&quot;;
	}	
	// 類別
	var type = &quot;&quot;;
	if(&quot;true&quot;== Form.getValue(&quot;TYPE_A&quot;)){
		type += &quot;&apos;A類:實驗申請與計畫&apos;,&apos;A類:量產條件變更&apos;,&quot;;	
	}
	if(&quot;true&quot;== Form.getValue(&quot;TYPE_B&quot;)){
		type += &quot;&apos;B類:改版直接大量生產&apos;,&apos;B類:特殊案件，有時間壓力&apos;,&quot;;	
	}
	if(&quot;true&quot;== Form.getValue(&quot;TYPE_C1&quot;)){
		type += &quot;&apos;C1類:常態性變更&apos;,&quot;;	
	}
	if(&quot;true&quot;== Form.getValue(&quot;TYPE_C2&quot;)){
		type += &quot;&apos;C2類:Sample變更&apos;,&apos;C2類:一般性變更&apos;,&quot;;	
	}	
	if(&quot;true&quot;== Form.getValue(&quot;TYPE_D&quot;)){
		type += &quot;&apos;D類:PMP變更&apos;,&quot;;	
	}	 
	if (!&quot;&quot;.equals(type)) {
		sSQL += &quot; AND ITEM66 in (&quot; + type + &quot;&apos;&apos;)&quot;;
	}else{
	    //sSQL += &quot; AND (ITEM66 in (&apos;A類:實驗申請與計畫&apos;,&apos;B類:改版直接大量生產&apos;,&apos;C1類:常態性變更&apos;,&apos;C2類:Sample變更&apos;,&apos;C2類:一般性變更&apos;,&apos;D類:PMP變更&apos;) or ITEM66 like&apos; %&apos;)&quot;;
	}		
	// 廠別 ITEM2 factory
	var factory = &quot;&quot;;
	if(&quot;true&quot;== Form.getValue(&quot;TGCE&quot;)){
		factory += &quot;&apos;(TGCE)&apos;,&quot;;	
	}
	if(&quot;true&quot;== Form.getValue(&quot;SGCE&quot;)){
		factory += &quot;&apos;(SGCE)&apos;,&quot;;	
	}
	if(&quot;true&quot;== Form.getValue(&quot;CGCE&quot;)){
		factory += &quot;&apos;(CGCE)&apos;,&quot;;	
	} 
	if(&quot;true&quot;== Form.getValue(&quot;HGCE&quot;)){
		factory += &quot;&apos;(HGCE)&apos;,&quot;;	
	} 
	if (!&quot;&quot;.equals(factory)) {
		sSQL += &quot; AND a.ITEM2 in (&quot; + factory + &quot;&apos;&apos;)&quot;;
	}		
	// 廠別 ITEM2 factory
	/*
	var design_t = &quot;false&quot;;
	var design_s = &quot;false&quot;;
	var design_c = &quot;false&quot;;	
	if(&quot;true&quot;== Form.getValue(&quot;TGCE&quot;)){
		design_t = &quot;true&quot;;	
	}
	if(&quot;true&quot;== Form.getValue(&quot;SGCE&quot;)){
		design_s = &quot;true&quot;;	
	}
	if(&quot;true&quot;== Form.getValue(&quot;CGCE&quot;)){
		design_c = &quot;true&quot;;	
	} 
	sSQL += &quot; AND ( ITEM16=&apos;&quot; + design_t + &quot;&apos; or A.ITEM6=&apos;&quot; + design_t + &quot;&apos; or ITEM202=&apos;&quot; + design_t + &quot;&apos; )&quot;;
	*/	
	return sSQL;	
}

//========================================================================================
// MECN共用條件的 SQL SEARCH 
// 1PDM (1.申請件數(2+3+4))
//========================================================================================
function getQueryCondition_apply_count(v_version){		 
	var sSQL=&quot;&quot;;
	if (v_version == &quot;V3&quot;){
	  sSQL += &quot; and item231=&apos;Y&apos;&quot;;	
	}else{
	  sSQL += &quot;&quot;;	
	}
	return sSQL;
}
	
//========================================================================================
// 2PDM (2.已結案)
//========================================================================================
function getQueryCondition_finish_count(v_version){		 
	var sSQL=&quot;&quot;;
	if (v_version == &quot;V3&quot;){
//	  sSQL += &quot; AND (C.NAME  in(&apos;A類別&apos;,&apos;B類別&apos;,&apos;第二階段通知完成&apos;) or A.ITEM115 is not null ) AND ITEM155 = &apos;false&apos; and item231=&apos;Y&apos; &quot;;
	  sSQL += &quot; AND ((C.NAME  in(&apos;A類別&apos;,&apos;B類別&apos;,&apos;第二階段通知完成&apos;) and A.ITEM187&lt;&gt;&apos;DE執行&apos;) or A.ITEM115 is not null ) AND ITEM155 = &apos;false&apos; and item231=&apos;Y&apos; &quot;;
//	  sSQL += &quot; AND (C.NAME  in(&apos;第二階段通知完成&apos;) or A.ITEM115 is not null ) AND ITEM155 = &apos;false&apos; and item231=&apos;Y&apos; &quot;;

	}else{
  	  sSQL += &quot; AND (C.NAME  in(&apos;二階段開始&apos;,&apos;DE執行完成&apos;)or  A.ITEM115 is  not null) AND ITEM155 = &apos;false&apos; &quot;;	
	}
	return sSQL;
}	
	
//========================================================================================
// 3PDM (3.未結案)
//========================================================================================
function getQueryCondition_unfinishe_count(v_version){
	var sSQL=&quot;&quot;;
	if (v_version == &quot;V3&quot;){
	  //sSQL += &quot; AND C.NAME not in(&apos;A類別&apos;,&apos;B類別&apos;,&apos;第二階段通知完成&apos;) AND ITEM115 is null AND ITEM155 = &apos;false&apos; and item231=&apos;Y&apos;&quot;;
 sSQL += &quot; AND (C.NAME not in(&apos;A類別&apos;,&apos;B類別&apos;,&apos;第二階段通知完成&apos;) or(C.NAME=&apos;A類別&apos; and A.ITEM187=&apos;DE執行&apos;)) AND ITEM115 is null  and item231=&apos;Y&apos; &quot;;
	}else{
	  //sSQL += &quot;AND C.NAME not in(&apos;二階段開始&apos;,&apos;DE執行完成&apos;) AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
	  sSQL += &quot;AND C.NAME not in(&apos;二階段開始&apos;,&apos;DE執行完成&apos;) AND ITEM115 is null &quot;;	  
	}		 
	return sSQL;
}	

//========================================================================================
// 4PDM (4.作廢)
//========================================================================================
function getQueryCondition_cancel_count(v_version){
	var sSQL=&quot;&quot;;
	if (v_version == &quot;V3&quot;){
	  sSQL += &quot; AND ITEM155 = &apos;true&apos; and item231=&apos;Y&apos; AND ITEM115 is not  null &quot;;
//	  sSQL += &quot; AND ITEM155 = &apos;true&apos; and item231=&apos;Y&apos; &quot;;	  
	}else{
//	  sSQL += &quot; AND ITEM155 = &apos;true&apos;  &quot;;	
	  sSQL += &quot; AND ITEM155 = &apos;true&apos; AND ITEM115 is not  null &quot;;		  
	}			 
	return sSQL;
}		
	
//========================================================================================
// 5PDM (5.退件數(6+7+8))
//========================================================================================
function getQueryCondition_reject_count(v_version){
	var sSQL=&quot;&quot;;
	if (v_version == &quot;V3&quot;){
	  sSQL += &quot; AND ITEM208=&apos;repeat&apos; and item231=&apos;Y&apos; &quot;;	
	}else{
	  sSQL += &quot; AND ITEM208=&apos;repeat&apos; &quot;;	
	}	
	return sSQL;
}	
	
//========================================================================================
// 6PDM (6.已結案(被退件過))
//========================================================================================
function getQueryCondition_re_finish_count(v_version){
	var sSQL=&quot;&quot;;
	if (v_version == &quot;V3&quot;){
//	  sSQL += &quot; AND ( D.NAME  in(&apos;第二階段通知完成&apos;) or  A.ITEM115 is  not null) AND ITEM155 = &apos;false&apos; AND ITEM208=&apos;repeat&apos; and item231=&apos;Y&apos; &quot;;	
	  sSQL += &quot; AND ((D.NAME  in(&apos;A類別&apos;,&apos;B類別&apos;,&apos;第二階段通知完成&apos;) and A.ITEM187&lt;&gt;&apos;DE執行&apos;) or A.ITEM115 is not null ) AND ITEM155 = &apos;false&apos; and item231=&apos;Y&apos; AND ITEM208=&apos;repeat&apos; &quot;;

	}else{
	  sSQL += &quot; AND ( D.NAME  in(&apos;二階段開始&apos;,&apos;DE執行完成&apos;) or  A.ITEM115 is  not null) AND ITEM155 = &apos;false&apos; AND ITEM208=&apos;repeat&apos; &quot;;	
	}
	return sSQL;
}	

//========================================================================================
// 7PDM (7.未結案(被退件過))
//========================================================================================
function getQueryCondition_re_unfinishe_count(v_version){
	var sSQL=&quot;&quot;;
	if (v_version == &quot;V3&quot;){
//	  sSQL += &quot; AND D.NAME not in(&apos;A類別&apos;,&apos;B類別&apos;,&apos;第二階段通知完成&apos;) AND ITEM115 is null AND ITEM155 = &apos;false&apos; AND ITEM208=&apos;repeat&apos;   and item231=&apos;Y&apos;&quot;;	
	   sSQL += &quot; AND (D.NAME not in(&apos;A類別&apos;,&apos;B類別&apos;,&apos;第二階段通知完成&apos;) or(D.NAME=&apos;A類別&apos; and A.ITEM187=&apos;DE執行&apos;)) AND ITEM115 is null  AND ITEM208=&apos;repeat&apos;   and item231=&apos;Y&apos; &quot;;	
	}else{
//	  sSQL +=  &quot;AND D.NAME not in(&apos;二階段開始&apos;,&apos;DE執行完成&apos;) AND ITEM115 is null AND ITEM155 = &apos;false&apos; AND ITEM208=&apos;repeat&apos; &quot;;
	   sSQL +=  &quot;AND D.NAME not in(&apos;二階段開始&apos;,&apos;DE執行完成&apos;) AND ITEM115 is null  AND ITEM208=&apos;repeat&apos; &quot;;

	}	 
	return sSQL;
}	

//========================================================================================
// 8PDM (8.作廢(被退件過))
//========================================================================================
function getQueryCondition_re_cancel_count(v_version){
	var sSQL=&quot;&quot;;
	if (v_version == &quot;V3&quot;){
	  sSQL += &quot; AND ITEM155 = &apos;true&apos; AND ITEM208=&apos;repeat&apos; and item231=&apos;Y&apos; AND ITEM115 is not  null &quot;;	
//	  sSQL += &quot; AND ITEM155 = &apos;true&apos; AND ITEM208=&apos;repeat&apos; and item231=&apos;Y&apos;&quot;;		  
	}else{
	  sSQL += &quot; AND ITEM155 = &apos;true&apos; AND ITEM208=&apos;repeat&apos; AND ITEM115 is not  null &quot;;	
//	  sSQL += &quot; AND ITEM155 = &apos;true&apos; AND ITEM208=&apos;repeat&apos;&quot;;		  
	}		 
	return sSQL;
}	

//=================================================================  Search MECN Report End	

//===================================================================
//  MECN共用條件的SQL SEARCH Report List
//  二階段MECN 使用
//===================================================================	
function count_showTable(vec){

	Form.setValue(&quot;vec_temp&quot;,vec);	
	var vec = Client.getLocalObject(vec);
	if(vec==null){
		Form.showMessageDialog(&quot;查無資料,請確認!&quot;);
	}else{
		var artid = Form.getValue(&quot;artid&quot;);
		var v_version = Form.getValue(&quot;MECN_Version&quot;);	
		Form.setValue(&quot;Count&quot;,vec.size()+&quot;&quot;);	
		var table = Form.getComponent(&quot;ResultTable&quot;);
		table.clear();
		var row = 0;	
		var N = Form.getValue(&quot;N&quot;);
		var T = Math.ceil(vec.size()/N); //無條件進位
		Form.setValue(&quot;T&quot;,&quot;&quot;+T);
	    showTable_N(1,vec);
	}
	
}

//===================================================================
//  MECN共用條件的SQL SEARCH Report List
//  二階段MECN 使用
//===================================================================	
function showTable(P,vec){	
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
//	var vec = Client.getLocalObject(vec);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				if(processname == &quot;[會簽-彙整步驟] MECN第一階段(申請)審核通過通知&quot;){
				   processname = &quot;第一階段結束&quot;;
				}				
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);
//				var realExecutorMemID = task.getRealExecutor();
//				var memberRecord = Client.getMemberByID(realExecutorMemID);
				table.setValueAt(getUnsignMemNameExt(task),  row, &quot;目前處理者&quot;);
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ITEM62&quot;),    	row, &quot;文件編號&quot;);			
			table.setValueAt(hm.get(&quot;ITEM325&quot;), 	row, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;ITEM318&quot;),  	row, &quot;申請人姓名&quot;);
			table.setValueAt(hm.get(&quot;ITEM12&quot;),   	row, &quot;填寫日期&quot;);			
			table.setValueAt(hm.get(&quot;ITEM200&quot;),   	row, &quot;文件標題&quot;);
			table.setValueAt(hm.get(&quot;ITEM66&quot;),  	row, &quot;文件類別&quot;);			
			table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

//===================================================================
//  MECN共用條件的SQL SEARCH Report List
//  三階段MECN 使用
//===================================================================
function showTable_N(P,vec){	
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));

//			if (task != null){
//				var processname = task.getProcessName();
//				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
//					processname = &quot;作廢&quot;;
//				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
//					processname = &quot;已結案&quot;;
//				}
//				if(processname == &quot;[會簽-彙整步驟] MECN第一階段(申請)審核通過通知&quot;){
//				   processname = &quot;第一階段結束&quot;;
//				}				
//				table.setValueAt(processname,   row, &quot;目前關卡&quot;);
//				table.setValueAt(getUnsignMemNameExt(task),  row, &quot;目前處理者&quot;);
//			}


//=======================================================================
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					if(processname == &quot;DE主管作廢審核&quot; || processname == &quot;提出單位最高主管&quot;){
					    if( hm.get(&quot;ITEM115&quot;)==&quot;&quot;){						
					     processname += &quot;【作廢】&quot;;
					   }else{
					     processname = &quot;作廢&quot;;
					  }
					}else{  	
					 if( hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){
					   processname = &quot;作廢&quot;;
					  } 
					}
//					Form.showMessageDialog(processname);
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}			
				if(processname == &quot;MECN第一階段(申請)審核通過通知&quot; || processname == &quot;[會簽-彙整步驟] MECN第一階段(申請)審核通過通知&quot;){
				   processname = &quot;第一階段結束&quot;;
				}else if(processname == &quot;MECN第二階段(申請)審核通過通知&quot;){
				   processname = &quot;第二階段結束&quot;;
				}   	
// ------------------------------------------------------------------------				
				var vMemList = getUnsignMemName(task); // 加會簽
				
					if(&quot;&quot;==vMemList){
						vMemList = getUnsignMemNameExt(task);
						
						}
// -------------------------------------------------------------------------						
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
			}	
//===============================================================================================			
			if( &quot;false&quot; == hm.get(&quot;ITEM155&quot;) || &quot;true&quot; == hm.get(&quot;ITEM155&quot;) ){
				var row = table.newRow()-1;				
		
				if(&quot;&quot;==vMemList){
					table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);				
				}else{
					
					table.setValueAt(vMemList,  row, &quot;目前處理者&quot;);	
				}
				
			    if(asign_member(task)==&quot;&quot;){		
			  	   table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);	
				   	if(&quot;&quot;!=vMemList){	
					table.setValueAt(vMemList,  row, &quot;目前處理者&quot;);	
					
				    }
			    }else{
					  table.setValueAt(asign_member(task),  row, &quot;目前處理者&quot;);
					  
			    }
//			    if (processname == &quot;已結案&quot; || processname == &quot;第一階段結束&quot; || processname == &quot;第二階段結束&quot; ){
				
				if(processname ==&quot;[會簽-簽核步驟] 它廠製工會簽&quot;){
					
			    }else if (processname == &quot;已結案&quot; || processname == &quot;第一階段結束&quot; || processname == &quot;第二階段結束&quot; ||hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){
			        table.setValueAt(&quot;&quot;,  row, &quot;目前處理者&quot;);
			    }else if (processname == &quot;申請人&quot;){
//					table.setValueAt(hm.get(&quot;ITEM318&quot;),  row, &quot;目前處理者&quot;);
					table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
				}
              table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			  table.setValueAt(processname,   row, &quot;目前關卡&quot;);	
			  table.setValueAt(hm.get(&quot;ITEM62&quot;),    	row, &quot;文件編號&quot;);			
			  table.setValueAt(hm.get(&quot;ITEM325&quot;), 	row, &quot;部門&quot;);
			  table.setValueAt(hm.get(&quot;ITEM318&quot;),  	row, &quot;申請人姓名&quot;);
			  table.setValueAt(hm.get(&quot;ITEM12&quot;),   	row, &quot;填寫日期&quot;);			
			  table.setValueAt(hm.get(&quot;ITEM200&quot;),   	row, &quot;文件標題&quot;);
			  table.setValueAt(hm.get(&quot;ITEM66&quot;),  	row, &quot;文件類別&quot;);			
			  table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			}
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
	
//===================================================================
// 2011/07/09 - irenechang
//  MECN共用條件的SQL SEARCH Report List
//  三階段MECN 使用
//===================================================================
 function showTable_New(P,table,table_temp){	
   	var table = Form.getComponent(table);
	table.clear();	
	
   	var table_temp = Form.getComponent(table_temp);	
    var v_count =table_temp.getRowCount();	
    var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(v_count/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	

	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(v_count &lt; E){
		E = v_count;
	}
	if (v_count &gt; 0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
           	 var row= table.newRow()-1;						 
			  table.setValueAt(i+1 + &quot;&quot;                           ,row,&quot;序&quot;);
			  table.setValueAt(table_temp.getValueAt(i,&quot;目前階段&quot;) ,row,&quot;目前階段&quot;);				  
			  table.setValueAt(table_temp.getValueAt(i,&quot;目前關卡&quot;)  ,row,&quot;目前關卡&quot;);	
			  table.setValueAt(table_temp.getValueAt(i,&quot;目前處理者&quot;),row,&quot;目前處理者&quot;);			  
			  table.setValueAt(table_temp.getValueAt(i,&quot;文件編號&quot;)  ,row,&quot;文件編號&quot;);			
			  table.setValueAt(table_temp.getValueAt(i,&quot;部門&quot;)      ,row,&quot;部門&quot;);
			  table.setValueAt(table_temp.getValueAt(i,&quot;申請人姓名&quot;) ,row,&quot;申請人姓名&quot;);
			  table.setValueAt(table_temp.getValueAt(i,&quot;填寫日期&quot;)   ,row,&quot;填寫日期&quot;);			
			  table.setValueAt(table_temp.getValueAt(i,&quot;文件標題&quot;)   ,row,&quot;文件標題&quot;);
			  table.setValueAt(table_temp.getValueAt(i,&quot;文件類別&quot;)   ,row,&quot;文件類別&quot;);			
			  table.setValueAt(table_temp.getValueAt(i,&quot;InsID&quot;)     ,row,&quot;InsID&quot;);
			  table.setValueAt(table_temp.getValueAt(i,&quot;InsID2&quot;)    ,row,&quot;InsID2&quot;);
			  table.setValueAt(table_temp.getValueAt(i,&quot;InsID3&quot;)    ,row,&quot;InsID3&quot;);			
      }
   }
   Form.setValue(&quot;Count&quot;,table_temp.getRowCount()+&quot;&quot;);      
}//function showTable_New(P,table,table_temp)	 


//===================================================================
//  MECN共用條件的SQL SEARCH Report List
//  List 多人加會簽 使用
//===================================================================
function asign_member(task){		
//  讀取是否有子流程 ---------------------------------------------
	try{
		var vTskID=task.getFrontID(); // 取task ID
		var sql_t = &quot; select *from Task_CreatePro  where tskid = &apos;&quot;+vTskID+&quot;&apos; and iscomplete = &apos;false&apos;  &quot;;
		
		var vec_t = Client.SQLloadValue(sql_t);
			if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
			   var vName = &quot;&quot;;
			   for(var r = 0;r&lt;vec_t.size();r++){
				   var r_task = Client.getTask(vec_t.get(r).get(&quot;CPROOTTSKID&quot;));
				   var vMid = r_task.getRealExecutor();
				   var vExec = Client.getMemberByID(vMid).getName();
					   vName = vName+vExec+&quot;;&quot;;
				}
			  }else{
			    var vName = &quot;&quot;;
			  }
		}catch(e){}
		
	return vName;		
}
//===================================================================
// MECN ISO 文件查詢
// 資料單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable_iso(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
//	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
//			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));

			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;CREATE_DATE&quot;),   	row, &quot;發行日期&quot;);		
			table.setValueAt(hm.get(&quot;GCE_DOC_SN&quot;),    	row, &quot;文件編號&quot;);			
			table.setValueAt(hm.get(&quot;GCE_VER_SN&quot;),    	row, &quot;文件版本&quot;);	
			table.setValueAt(hm.get(&quot;SUBJECT&quot;), 	row, &quot;標題&quot;);
			table.setValueAt(hm.get(&quot;DEPT&quot;), 	row, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;USERNAME&quot;),  	row, &quot;作者&quot;);
			table.setValueAt(hm.get(&quot;DOC_ID&quot;),   	row, &quot;DOC_ID&quot;);
			table.setValueAt(hm.get(&quot;ver_id&quot;),  	row, &quot;ver_id&quot;);
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
//===================================================================
// 客戶資料簽收單,訂單資料 
// 資料單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable_getECR(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ITEM62&quot;),    	row, &quot;文件編號&quot;);			
			table.setValueAt(hm.get(&quot;ITEM325&quot;), 	row, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;ITEM318&quot;),  	row, &quot;申請人姓名&quot;);
			table.setValueAt(hm.get(&quot;ITEM12&quot;),   	row, &quot;填寫日期&quot;);			
			table.setValueAt(hm.get(&quot;ITEM200&quot;),   	row, &quot;文件標題&quot;);
			table.setValueAt(hm.get(&quot;ITEM257&quot;),  	row, &quot;文件類別&quot;);
			table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
		

//===================================================================
// 客戶資料簽收單,訂單資料 
// 資料單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable_ORDER(P){
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {	
		for (var i = (P-1)*N ; i &lt; E; i++) {
			var hm = vec.get(i);
			var row = table.newRow()-1;
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ORDER_NUMBER&quot;),     	row, &quot;訂單編號&quot;);
			table.setValueAt(hm.get(&quot;PART_NUMBER&quot;),     	row, &quot;金像料號&quot;);
			table.setValueAt(hm.get(&quot;itout&quot;),     	        row, &quot;客戶料號&quot;);
			table.setValueAt(hm.get(&quot;ORDERED_QUANTITY&quot;),     	row, &quot;數量&quot;);
			table.setValueAt(hm.get(&quot;CUSTOMER_NAME&quot;),     	row, &quot;客戶名稱&quot;);
			table.setValueAt(hm.get(&quot;CUSTOMER_NUMBER&quot;),     	row, &quot;客戶編號&quot;);
			table.setValueAt(hm.get(&quot;SCHEDULE_SHIP_DATE&quot;),     	row, &quot;Schedule Date&quot;);		
			if(&quot;1&quot;==hm.get(&quot;TYPE&quot;)){
				var TYPE = &quot;樣本&quot;;
			}else{
				var TYPE = &quot;量產&quot;;
			}			
			table.setValueAt(TYPE,row,&quot;訂單型態&quot;);
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}	

//===================================================================
// 資料單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable_CUSTOMER(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			var hm = vec.get(i);
			var row = table.newRow()-1;
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;cusds&quot;),     	row, &quot;客戶名稱&quot;);
			table.setValueAt(hm.get(&quot;cusno&quot;),     	row, &quot;客戶編號&quot;);
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

//===================================================================
// 資料單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable_gce_item(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			var hm = vec.get(i);
			var row = table.newRow()-1;
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;itnbr&quot;),     	row, &quot;金像料號&quot;);
			table.setValueAt(hm.get(&quot;segment8&quot;),     	row, &quot;無鉛製程&quot;);
			table.setValueAt(hm.get(&quot;segment9&quot;),     	row, &quot;ROHS製程&quot;);
			table.setValueAt(hm.get(&quot;itdsc&quot;),     	row, &quot;說明&quot;);
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

//========================================================================================
// PDM共用條件的SQL SEARCH 
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;	
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
		}
	}	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
		}
	}	
	// 部門名稱
	var DepName = Form.getValue(&quot;DepName&quot;);	
	if (!&quot;&quot;.equals(DepName)) {
		sSQL += &quot; AND ITEM325= &apos;&quot; + DepName + &quot;&apos;&quot;;
	}	
	// 申請人姓名
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM318= &apos;&quot; + MemName + &quot;&apos;&quot;;
	}			
	// 文件標題
	var Subject = Form.getValue(&quot;Subject&quot;);	 
	if (!&quot;&quot;.equals(Subject)) {
		sSQL += &quot; AND ITEM200 like &apos;%&quot; + Subject + &quot;%&apos;&quot;;
	}
	// 文件編號
	var Sn = Form.getValue(&quot;Sn&quot;);	
	if (!&quot;&quot;.equals(Sn)) {
		sSQL += &quot; AND ITEM62 like &apos;%&quot; + Sn + &quot;%&apos;&quot;;
	}		
	
	return sSQL;	
}

//========================================================================================
// MECN Excel File
// 20100316 改版 by irenechang
//========================================================================================
function main(filename,vec,satus,stytle) {
	var serverTime = Client.getServerTime();
	var myDate = new Packages.pase.agenda.MyDate(serverTime);
	var today = myDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;);
	var date = myDate.getCurrentDate(&quot;YMDHmS&quot;);
	var vec = Client.getLocalObject(vec);
	if (vec.size()&gt;0){
      if(satus == &quot;1&quot;){
		 if(filename.indexOf(&quot;MECN&quot;)&gt;=0 ){
	        MECN_writeScriptToFile(&quot;C:\\temp\\&quot;+ filename +&quot;-&quot; + date + &quot;.csv&quot;, today, vec,filename);
		 }else if (filename.indexOf(&quot;PDM&quot;)&gt;=0){
			PDM_writeScriptToFile(&quot;C:\\temp\\&quot;+ filename +&quot;-&quot; + date + &quot;.csv&quot;, today, vec,filename); 
		 }else{
		    writeScriptToFile(&quot;C:\\temp\\&quot;+ filename +&quot;-&quot; + date + &quot;.csv&quot;, today, vec,filename);
		 }
	  }else{
		 if(filename.indexOf(&quot;MECN&quot;)&gt;=0 ){
	        MECN_writeScriptToFile_R(&quot;C:\\temp\\&quot;+ filename +&quot;-&quot; + date + &quot;.csv&quot;, today, vec,filename,stytle);
		 }else if (filename.indexOf(&quot;PDM&quot;)&gt;=0){
			PDM_writeScriptToFile_R(&quot;C:\\temp\\&quot;+ filename +&quot;-&quot; + date + &quot;.csv&quot;, today, vec,filename,stytle);
		 }else{
		    writeScriptToFile_R(&quot;C:\\temp\\&quot;+ filename +&quot;-&quot; + date + &quot;.csv&quot;, today, vec,filename,stytle);
		 }  
	  }
	  Form.downloadFile(&quot;C:\\temp\\&quot;, filename+&quot;-&quot; + date + &quot;.csv&quot;);	//for JSP
	}else{Form.showMessageDialog(&quot;查無任何相關記錄可產生！&quot;);}
}

function writeScriptToFile(m_filePath, today, vec,filename) {
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var form = Form.getValue(&quot;Artifact&quot;);
	if(form.indexOf(&quot;MECN&quot;)&gt;=0){
	   var v_version = Form.getValue(&quot;MECN_Version&quot;);
	}
	var file  = new Packages.java.io.File(m_filePath);
	file.createNewFile();
	var pw =  new Packages.java.io.PrintWriter(new Packages.java.io.FileOutputStream(file));
	//以下三行str為表頭,第一個要修改的地方 
	var str = filename + &quot; 列印日期: &quot; + today;
	pw.println(str);
	var str  = &quot;&quot;;
	pw.println(str);
	//下一行str各行標題,第二個要修改的地方 	
	//MECN 二階單
    if( form.indexOf(&quot;MECN申請單&quot;)&gt;=0 ){	
	        var str = &quot;序,目前關卡,文件編號,申請部門,申請人姓名,目前處理者,填寫日期,結案日期,文件標題,文件類別,分類,變更原因,變更內容&quot;;
    }else if(form.indexOf(&quot;MECN實驗結果&quot;)&gt;=0 ){
		if (Form.getValue(&quot;ITEM231&quot;)==&apos;Y&apos;){
			//MECN 三階單	
			var str = &quot;序,目前關卡,文件編號,申請部門,申請人姓名,目前處理者,填寫日期,結案日期,文件標題,文件類別,分類,變更內容,連續試做批實驗計畫&quot;;
		}else{
            var str = &quot;序,目前關卡,文件編號,申請部門,申請人姓名,目前處理者,填寫日期,結案日期,文件標題,文件類別,分類,變更內容,實驗計劃,實驗結果&quot;;
		}
    }else if(form.indexOf(&quot;MECN核准單&quot;)&gt;=0){		
	    var str = &quot;序,目前關卡,文件編號,申請部門,申請人姓名,目前處理者,填寫日期,結案日期,文件標題,文件類別,分類,變更內容&quot;;
	//不是MECN 表單	
	}else if (form.indexOf(&quot;工程矯正回饋單 V&quot;)&gt;=0){
	    var str = &quot;序,發行日期,Old Rev,New Rev,文件編號,變更內容說明,工具變更,傳承,廠別,申請人姓名,申請部門,目前關卡,目前處理者&quot;; 	 	 
	}else if (form.indexOf(&quot;MECN&quot;)&lt;0){
	    var str = &quot;序,目前關卡,文件編號,申請部門,申請人姓名,目前處理者,填寫日期,結案日期,文件標題,文件說明&quot;; 	 	 
	}
	pw.println(str);
	//表身
		for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
//			var task = getTaskByInsID(hm.get(&quot;ITEM261&quot;));
			var processname = &quot;&quot;;
			var realExecutor = &quot;&quot;;
			if (task != null){
				processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					if(processname == &quot;DE主管作廢審核&quot; || processname == &quot;提出單位最高主管&quot;){
					    if( hm.get(&quot;ITEM115&quot;)==&quot;&quot;){
					     processname += &quot;【作廢】&quot;;
					   }else{
					     processname = &quot;作廢&quot;;
					   }
					}else{   
					 if( hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){
					   processname = &quot;作廢&quot;;
					  } 
					}
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				if( form.indexOf(&quot;MECN&quot;)&gt;=0){
				    if(processname == &quot;MECN第一階段(申請)審核通過通知&quot;){
				       processname = &quot;第一階段結束&quot;;
				    }else if(processname == &quot;MECN第二階段(申請)審核通過通知&quot;){
				       processname = &quot;第二階段結束&quot;;
				    }   
                }
			    if (processname == &quot;已結案&quot; || processname == &quot;作廢&quot; || processname == &quot;第一階段結束&quot; || processname == &quot;第二階段結束&quot; ||hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){				
//			    if (processname == &quot;已結案&quot; || processname == &quot;作廢&quot; || processname == &quot;第一階段結束&quot; || processname == &quot;第二階段結束&quot;){
			        var realExecutor =&quot;&quot;;	
			    }else if (processname == &quot;申請人&quot;){
				    var realExecutor = hm.get(&quot;ITEM318&quot;);	
			    }else{
						
			 	var realExecutor =&quot;&quot;;	
			  	var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				
				var vMemList = getUnsignMemName(task); // 加會簽
					if(&quot;&quot;==vMemList){
						vMemList = getUnsignMemNameExt(task);
				}
             
             //===============================================================================================			
				if(&quot;&quot;==vMemList){
					var realExecutor = memberRecord.getName();			
				}else{
					var realExecutor = vMemList;	
				}
				var temp = asign_member(task);
			    if(temp==&quot;&quot;){		
			  	   var realExecutor = memberRecord.getName();	
				   	if(&quot;&quot;!=vMemList){	
					var realExecutor = vMemList;	
				    }
			    }else{
					 var realExecutor = temp;
			    }
//				var temp1  = realExecutor	
//				var realExecutor = temp1.replaceAll(&quot;,&quot;,&quot;.&quot;);	
			   }
			}
			var str1 = i + 1    				+ &quot;,&quot;; //序
		if (form.indexOf(&quot;工程矯正回饋單 V&quot;)&gt;=0){
			str1 = str1 + hm.get(&quot;ITEM12&quot;)    	+ &quot;,&quot;;//填寫日期	
			str1 = str1 + hm.get(&quot;ITEM61&quot;)    	+ &quot;,&quot;;//Old Rev	
			str1 = str1 + hm.get(&quot;ITEM96&quot;)    	+ &quot;,&quot;;//New Rev	
			str1 = str1 + hm.get(&quot;ITEM62&quot;) 	    + &quot;,&quot;;//文件編號		
			
			var msg2 = hm.get(&quot;ITEM4&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + msg2 	                + &quot;,&quot;;//變更內容說明
			var temp =&quot;&quot;;
			var count =&quot;1&quot;;
			if(hm.get(&quot;ITEM21&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;線路變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM79&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;孔位變更&quot;
				 var count = &quot;2&quot; ;
			   }else{
			     temp += &quot;/孔位變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM84&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;電鍍方式變更&quot;
				 var count = &quot;2&quot; ;
			   }else{
			     temp += &quot;/電鍍方式變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM87&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;防焊變更&quot;
				 var count = &quot;2&quot; ;
			   }else{
			     temp += &quot;/防焊變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM89&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;層次變更&quot;
				 var count = &quot;2&quot; ;
			   }else{
			     temp += &quot;/層次變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM90&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;排版變更&quot;
				 var count = &quot;2&quot; ;
			   }else{
			     temp += &quot;/排版變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM91&quot;)== &quot;true&quot;){
			     temp = &quot;不影響治具&quot; 
			}	
		
			str1 = str1 + temp	    + &quot;,&quot;;//工具變更
			
			if(hm.get(&quot;ITEM56&quot;)== &quot;true&quot;){
			str1 = str1 + &quot;是&quot; + &quot;,&quot;;//傳承
			}else{
			str1 = str1 + &quot;否&quot; + &quot;,&quot;;//傳承
			}
			str1 = str1 + hm.get(&quot;ITEM2&quot;).substring(1,5) + &quot;,&quot;;//廠別
			str1 = str1 + hm.get(&quot;ITEM318&quot;)  	+ &quot;,&quot;;//申請人姓名
			str1 = str1 + hm.get(&quot;ITEM325&quot;) 	+ &quot;,&quot;;//部門
			str1 = str1 + processname   		+ &quot;,&quot;;//目前關卡
			str1 = str1 + realExecutor  	    + &quot;,&quot;;//目前處理者

		}else{	
			str1 = str1 + processname   		+ &quot;,&quot;;//目前關卡
			str1 = str1 + hm.get(&quot;ITEM62&quot;) 	    + &quot;,&quot;;//文件編號
			str1 = str1 + hm.get(&quot;ITEM325&quot;) 	+ &quot;,&quot;;//部門
			str1 = str1 + hm.get(&quot;ITEM318&quot;)  	+ &quot;,&quot;;//申請人姓名
			
//			var msg = realExecutor.replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
          if( form.indexOf(&quot;MECN&quot;)&gt;=0  &amp;&amp; hm.get(&quot;ITEM231&quot;)!=&apos;Y&apos;){  	
				var msg = realExecutor.replaceAll(&quot;,&quot;,&quot;;&quot;);
		            str1 = str1 + msg 	        + &quot;,&quot;;//目前處理者	
			}else{
			   str1 = str1 + realExecutor  	    + &quot;,&quot;;//目前處理者		
			}
			str1 = str1 + hm.get(&quot;ITEM12&quot;)    	+ &quot;,&quot;;//填寫日期
			str1 = str1 + hm.get(&quot;ITEM115&quot;)    	+ &quot;,&quot;;//結案日期			
			
			var msg1 = hm.get(&quot;ITEM200&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + msg1 	                + &quot;,&quot;;//文件標題

           if( form.indexOf(&quot;MECN&quot;)&gt;=0 &amp;&amp;  hm.get(&quot;ITEM231&quot;)!=&apos;Y&apos;){			
			   str1 = str1 + hm.get(&quot;ITEM66&quot;)		+ &quot;,&quot;;//文件類別	
			   str1 = str1 + &quot; &quot;	    	        + &quot;,&quot;;//分類	

			  if(form.indexOf(&quot;MECN實驗結果&quot;)&gt;=0 &amp;&amp;  hm.get(&quot;ITEM231&quot;)!=&apos;Y&apos;){
			     var msg2 = hm.get(&quot;context&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		             str1 = str1 + msg2 	                + &quot;,&quot;;//變更內容 
				 var msg3 = hm.get(&quot;plan&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		             str1 = str1 + msg3 	                + &quot;,&quot;;//實驗計劃 	 
				 var msg4 = hm.get(&quot;result&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		             str1 = str1 + msg4 	                + &quot;,&quot;;//實驗結果 	 					

			  }else{ 			   
 	             var msg2 = hm.get(&quot;reason&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		         str1 = str1 + msg2 	                + &quot;,&quot;;//變更原因	 

			     var msg3 = hm.get(&quot;context&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		             str1 = str1 + msg3 	                + &quot;,&quot;;//變更內容 
			  } 
			   
			}else if (form.indexOf(&quot;MECN&quot;)&lt;0){
			      var msg2 = hm.get(&quot;ITEM4&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg2 	                + &quot;,&quot;;//文件說明		
				  
            }else{				  
			   str1 = str1 + hm.get(&quot;ITEM66&quot;)		+ &quot;,&quot;;//文件類別	
			   str1 = str1 + &quot; &quot;	    	        + &quot;,&quot;;//分類	
			   
			   if(form.indexOf(&quot;MECN申請單&quot;)&gt;=0){	
		          var msg2 = hm.get(&quot;reason&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg2 	                + &quot;,&quot;;//變更原因	

			      var msg3 = hm.get(&quot;context&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg3 	                + &quot;,&quot;;//變更內容 
				  
	           }else if(form.indexOf(&quot;MECN實驗結果&quot;)&gt;=0){	
		          var msg2 = hm.get(&quot;context&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg2 	                + &quot;,&quot;;//變更內容

			      var msg3 = hm.get(&quot;plan&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg3 	                + &quot;,&quot;;//連續試做批實驗計畫
				  
   	           }else if(form.indexOf(&quot;MECN核准單&quot;)&gt;=0){		
			      var msg3 = hm.get(&quot;context&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg3 	                + &quot;,&quot;;//變更內容 
			   }
			  }    
            }
			
			pw.println(str1);
			}catch(e){}
	}//for i
	pw.close();
}

function writeScriptToFile_R(m_filePath, today, vec,filename,stytle) {
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var v_version = Form.getValue(&quot;MECN_Version&quot;);
	var form = Form.getValue(&quot;Artifact&quot;);
	var file  = new Packages.java.io.File(m_filePath);
	file.createNewFile();
	var pw =  new Packages.java.io.PrintWriter(new Packages.java.io.FileOutputStream(file));
	//以下三行str為表頭,第一個要修改的地方 
	var str = filename + &quot; 列印日期: &quot; + today;
	pw.println(str);
	var str  = &quot;&quot;;
	pw.println(str);
	//下一行str各行標題,第二個要修改的地方 	
	  var str = &quot;序,目前關卡,文件編號,申請部門,申請人姓名,目前處理者,填寫日期,結案日期,文件標題,文件類別,駁回部門,駁回主管,駁回說明&quot;;
	pw.println(str);
	//表身
		for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			var processname = &quot;&quot;;
			var realExecutor = &quot;&quot;;
			if (task != null){
				processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					if(processname == &quot;DE主管作廢審核&quot; || processname == &quot;提出單位最高主管&quot;){
					    if( hm.get(&quot;ITEM115&quot;)==&quot;&quot;){
					     processname += &quot;【作廢】&quot;;
					   }else{
					     processname = &quot;作廢&quot;;
					   }
					}else{
					  if( hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){
					    processname = &quot;作廢&quot;;
					   }
					}
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				if(processname == &quot;MECN第一階段(申請)審核通過通知&quot;){
				   processname = &quot;第一階段結束&quot;;
				}else if(processname == &quot;MECN第二階段(申請)審核通過通知&quot;){
				   processname = &quot;第二階段結束&quot;;
				}   
			    if (processname == &quot;已結案&quot; || processname == &quot;作廢&quot; || processname == &quot;第一階段結束&quot; || processname == &quot;第二階段結束&quot; ||hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){				
//			    if (processname == &quot;已結案&quot; || processname == &quot;作廢&quot; || processname == &quot;第一階段結束&quot; || processname == &quot;第二階段結束&quot; ){
			        var realExecutor =&quot;&quot;;	
			    }else if (processname == &quot;申請人&quot;){
				    var realExecutor = hm.get(&quot;ITEM318&quot;);	
			    }else{	
				    if( form.indexOf(&quot;MECN申請單 V2&quot;)&lt;0 &amp;&amp; form.indexOf(&quot;MECN實驗結果 V2&quot;)&lt;0 ){	
						if(asign_member(task)==&quot;&quot;){		
							var realExecutorMemID = task.getRealExecutor();
				            var memberRecord = Client.getMemberByID(realExecutorMemID);
							realExecutor = memberRecord.getName();
			            }else{
					        realExecutor = asign_member(task);
			            }
	                }else{
					    realExecutor = getUnsignMemNameExt(task);
					    var realExecutor = realExecutor.replaceAll(&quot;,&quot;,&quot;/&quot;);	
	                }
			    }	
			}
			//.replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;)
		    //去空白、去換行、跳行、把&quot;,&quot;取代成 &quot;.&quot; 因為&quot;,&quot; .csv 視為分隔符號
			
			var str1 = i + 1    				+ &quot;,&quot;; //序
			str1 = str1 + processname   		+ &quot;,&quot;;//目前關卡
			str1 = str1 + hm.get(&quot;ITEM62&quot;) 	    + &quot;,&quot;;//文件編號
			str1 = str1 + hm.get(&quot;ITEM325&quot;) 	+ &quot;,&quot;;//部門
			str1 = str1 + hm.get(&quot;ITEM318&quot;)  	+ &quot;,&quot;;//申請人姓名
			
//			var msg = realExecutor.replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + realExecutor  	    + &quot;,&quot;;//目前處理者
			
			str1 = str1 + hm.get(&quot;ITEM12&quot;)    	+ &quot;,&quot;;//填寫日期
			str1 = str1 + hm.get(&quot;ITEM115&quot;)    	+ &quot;,&quot;;//結案日期				
			
			var msg1 = hm.get(&quot;ITEM200&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + msg1 	                + &quot;,&quot;;//文件標題

			str1 = str1 + hm.get(&quot;ITEM66&quot;)		+ &quot;,&quot;;//文件類別				
			str1 = str1 + hm.get(&quot;ITEM6&quot;)		+ &quot;,&quot;;//駁回部門
			str1 = str1 + hm.get(&quot;ITEM4&quot;)		+ &quot;,&quot;;//駁回主管	
			
		    var msg2 = hm.get(&quot;ITEM1&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + msg2 	                + &quot;,&quot;;//駁回說明	
				
			pw.println(str1);
			}catch(e){}
	}//for i
	pw.close();
}

//* -----------------------------------------------------------------------------------------------------------------------*//
//MECN //

function MECN_writeScriptToFile(m_filePath, today, vec,filename) {
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var form = Form.getValue(&quot;Artifact&quot;);
	var file  = new Packages.java.io.File(m_filePath);
	file.createNewFile();
	var pw =  new Packages.java.io.PrintWriter(new Packages.java.io.FileOutputStream(file));
	//以下三行str為表頭,第一個要修改的地方 
	var str = filename + &quot; 列印日期: &quot; + today;
	pw.println(str);
	var str  = &quot;&quot;;
	pw.println(str);
	//下一行str各行標題,第二個要修改的地方 	
	//MECN 二階單
    if( form.indexOf(&quot;MECN申請單&quot;)&gt;=0 ){	
	        var str = &quot;序,文件標題,文件編號,申請部門,申請人姓名,目前關卡,目前處理者,填寫日期,結案日期,文件類別,分類,變更原因,變更內容,成本增加,成本增加項目,成本增加計算公式,幣別,預估當月成本增加金額,重新review日期,MECN手簽本&quot;;
    }else if(form.indexOf(&quot;MECN實驗結果&quot;)&gt;=0 ){
		if (Form.getValue(&quot;ITEM231&quot;)==&apos;Y&apos;){
			//MECN 三階單	
			var str = &quot;序,文件標題,文件編號,申請部門,申請人姓名,目前關卡,目前處理者,填寫日期,結案日期,文件類別,分類,變更內容,連續試做批實驗計畫&quot;;
		}else{
            var str = &quot;序,文件標題,文件編號,申請部門,申請人姓名,目前關卡,目前處理者,填寫日期,結案日期,文件類別,分類,變更內容,實驗計劃,實驗結果&quot;;
		}
    }else if(form.indexOf(&quot;MECN核准單&quot;)&gt;=0){		
	        var str = &quot;序,文件標題,文件編號,申請部門,申請人姓名,目前關卡,目前處理者,填寫日期,結案日期,文件類別,分類,變更內容&quot;;
	}
	pw.println(str);
	//表身
		for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			var processname = &quot;&quot;;
			var realExecutor = &quot;&quot;;
			if (task != null){
				processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					if(processname == &quot;DE主管作廢審核&quot; || processname == &quot;提出單位最高主管&quot;){
					    if( hm.get(&quot;ITEM115&quot;)==&quot;&quot;){
					     processname += &quot;【作廢】&quot;;
					   }else{
					     processname = &quot;作廢&quot;;
					   }
					}else{
					 if( hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){
					   processname = &quot;作廢&quot;;
					  } 
					}
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				if( form.indexOf(&quot;MECN&quot;)&gt;=0){
				    if(processname == &quot;MECN第一階段(申請)審核通過通知&quot;){
				       processname = &quot;第一階段結束&quot;;
				    }else if(processname == &quot;MECN第二階段(申請)審核通過通知&quot;){
				       processname = &quot;第二階段結束&quot;;
				    }   
                }
			    if (processname == &quot;已結案&quot; || processname == &quot;作廢&quot; || processname == &quot;第一階段結束&quot; || processname == &quot;第二階段結束&quot; ||hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){				
//			    if (processname == &quot;已結案&quot; || processname == &quot;作廢&quot; || processname == &quot;第一階段結束&quot; || processname == &quot;第二階段結束&quot;){
			        var realExecutor =&quot;&quot;;	
			    }else if (processname == &quot;申請人&quot;){
				    var realExecutor = hm.get(&quot;ITEM318&quot;);	
			    }else{
						
			 	var realExecutor =&quot;&quot;;	
			  	var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				
				var vMemList = getUnsignMemName(task); // 加會簽
					if(&quot;&quot;==vMemList){
						vMemList = getUnsignMemNameExt(task);
				}
             
             //===============================================================================================			
				if(&quot;&quot;==vMemList){
					var realExecutor = memberRecord.getName();			
				}else{
					var realExecutor = vMemList;	
				}
				var temp = asign_member(task);
			    if(temp==&quot;&quot;){		
			  	   var realExecutor = memberRecord.getName();	
				   	if(&quot;&quot;!=vMemList){	
					var realExecutor = vMemList;	
				    }
			    }else{
					 var realExecutor = temp;
			    }
			   }
			}
			var str1 = i + 1    				+ &quot;,&quot;; //序	
			var msg1 = hm.get(&quot;ITEM200&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + msg1 	                + &quot;,&quot;;//文件標題
			
			str1 = str1 + hm.get(&quot;ITEM62&quot;) 	    + &quot;,&quot;;//文件編號
			str1 = str1 + hm.get(&quot;ITEM325&quot;) 	+ &quot;,&quot;;//部門
			str1 = str1 + hm.get(&quot;ITEM318&quot;)  	+ &quot;,&quot;;//申請人姓名
			str1 = str1 + processname   		+ &quot;,&quot;;//目前關卡
          if( form.indexOf(&quot;MECN&quot;)&gt;=0  &amp;&amp; hm.get(&quot;ITEM231&quot;)!=&apos;Y&apos;){  
			  if(realExecutor !=&quot;&quot;){
				var msg = realExecutor.replaceAll(&quot;,&quot;,&quot;;&quot;);
		            str1 = str1 + msg 	        + &quot;,&quot;;//目前處理者	
			  }else{
		            str1 = str1 + &quot;&quot; 	        + &quot;,&quot;;//目前處理者	
			  } 		
			}else{
			   str1 = str1 + realExecutor  	    + &quot;,&quot;;//目前處理者		
			}
			str1 = str1 + hm.get(&quot;ITEM12&quot;)    	+ &quot;,&quot;;//填寫日期
			str1 = str1 + hm.get(&quot;ITEM115&quot;)    	+ &quot;,&quot;;//結案日期			
			
			

           if( form.indexOf(&quot;MECN&quot;)&gt;=0 &amp;&amp;  hm.get(&quot;ITEM231&quot;)!=&apos;Y&apos;){			
			   str1 = str1 + hm.get(&quot;ITEM66&quot;)		+ &quot;,&quot;;//文件類別	
			   str1 = str1 + &quot; &quot;	    	        + &quot;,&quot;;//分類	

			  if(form.indexOf(&quot;MECN實驗結果&quot;)&gt;=0 &amp;&amp;  hm.get(&quot;ITEM231&quot;)!=&apos;Y&apos;){
			     var msg2 = hm.get(&quot;context&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		             str1 = str1 + msg2 	                + &quot;,&quot;;//變更內容 
				 var msg3 = hm.get(&quot;plan&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		             str1 = str1 + msg3 	                + &quot;,&quot;;//實驗計劃 	 
				 var msg4 = hm.get(&quot;result&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		             str1 = str1 + msg4 	                + &quot;,&quot;;//實驗結果 	 					

			  }else{ 			   
 	             var msg2 = hm.get(&quot;reason&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		         str1 = str1 + msg2 	                + &quot;,&quot;;//變更原因	 

			     var msg3 = hm.get(&quot;context&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		             str1 = str1 + msg3 	                + &quot;,&quot;;//變更內容 
			  } 
			   
			}else if (form.indexOf(&quot;MECN&quot;)&lt;0){
			      var msg2 = hm.get(&quot;ITEM4&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg2 	                + &quot;,&quot;;//文件說明		
				  
            }else{				  
			   str1 = str1 + hm.get(&quot;ITEM66&quot;)		+ &quot;,&quot;;//文件類別	
			   str1 = str1 + &quot; &quot;	    	        + &quot;,&quot;;//分類	
			   
			   if(form.indexOf(&quot;MECN申請單&quot;)&gt;=0){	
		          var msg2 = hm.get(&quot;reason&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg2 	                + &quot;,&quot;;//變更原因	

			      var msg3 = hm.get(&quot;context&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg3 	                + &quot;,&quot;;//變更內容 
				  
				  //成本增加,成本增加項目,成本增加計算公式,幣別,預估當月成本增加金額,MECN手簽本,重新review日期
				  if(hm.get(&quot;ITEM529&quot;)==&quot;true&quot;){//成本增加
					  str1 = str1 + &quot;YES&quot; 	                + &quot;,&quot;;//成本增加	
					  var item_tp = &quot;&quot;;
					  if(hm.get(&quot;ITEM534&quot;).equals(&quot;true&quot;)){
						  item_tp +=&quot;途程增加;&quot;;
					  }
					  if(hm.get(&quot;ITEM535&quot;).equals(&quot;true&quot;)){
						  item_tp +=&quot;壽命縮短;&quot;;
					  }
					  if(hm.get(&quot;ITEM536&quot;).equals(&quot;true&quot;)){
						  item_tp +=&quot;物料變更;&quot;;
					  }
					  if(hm.get(&quot;ITEM537&quot;).equals(&quot;true&quot;)){
						  item_tp +=&quot;保養頻率縮短;&quot;;
					  }
					  if(hm.get(&quot;ITEM538&quot;).equals(&quot;true&quot;)){
						  item_tp +=&quot;參數調整(規格加嚴);&quot;;
					  }
					  str1 = str1 + item_tp 	                + &quot;,&quot;;//成本增加項目
					  str1 = str1 + hm.get(&quot;ITEM543&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;)		+ &quot;,&quot;;//成本增加計算公式
					  str1 = str1 + hm.get(&quot;ITEM546&quot;)		+ &quot;,&quot;;//幣別
					  str1 = str1 + hm.get(&quot;ITEM548&quot;)		+ &quot;,&quot;;//預估當月成本增加金額
					  str1 = str1 + hm.get(&quot;ITEM545&quot;)		+ &quot;,&quot;;//重新review日期
					  str1 = str1 + hm.get(&quot;paper_sign&quot;)		+ &quot;,&quot;;//MECN手簽本
				  }else{
					  str1 = str1 + &quot;NO&quot; 	                + &quot;,&quot;;//成本增加
					  str1 = str1 + &quot;&quot; 	                + &quot;,&quot;;//成本增加項目
					  str1 = str1 + &quot;&quot;		+ &quot;,&quot;;//成本增加計算公式
					  str1 = str1 + &quot;&quot;		+ &quot;,&quot;;//幣別
					  str1 = str1 + &quot;&quot;		+ &quot;,&quot;;//預估當月成本增加金額
					  str1 = str1 + &quot;&quot;		+ &quot;,&quot;;//重新review日期
					  str1 = str1 + &quot;&quot;		+ &quot;,&quot;;//MECN手簽本
				  }
	           }else if(form.indexOf(&quot;MECN實驗結果&quot;)&gt;=0){	
		          var msg2 = hm.get(&quot;context&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg2 	                + &quot;,&quot;;//變更內容

			      var msg3 = hm.get(&quot;plan&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg3 	                + &quot;,&quot;;//連續試做批實驗計畫
				  
   	           }else if(form.indexOf(&quot;MECN核准單&quot;)&gt;=0){		
			      var msg3 = hm.get(&quot;context&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		          str1 = str1 + msg3 	                + &quot;,&quot;;//變更內容 
			   }
			  }    
//			  str1 = str1 + Client.getTask(task.getRootID()).getTaskState()    + &quot;,&quot;; //stuts
			pw.println(str1);
			}catch(e){}
	}//for i
	pw.close();
}


function MECN_writeScriptToFile_R(m_filePath, today, vec,filename,stytle) {
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var v_version = Form.getValue(&quot;MECN_Version&quot;);
	var form = Form.getValue(&quot;Artifact&quot;);
	var file  = new Packages.java.io.File(m_filePath);
	file.createNewFile();
	var pw =  new Packages.java.io.PrintWriter(new Packages.java.io.FileOutputStream(file));
	//以下三行str為表頭,第一個要修改的地方 
	var str = filename + &quot; 列印日期: &quot; + today;
	pw.println(str);
	var str  = &quot;&quot;;
	pw.println(str);
	//下一行str各行標題,第二個要修改的地方 	
	  var str = &quot;序,目前關卡,文件編號,申請部門,申請人姓名,目前處理者,填寫日期,結案日期,文件標題,文件類別,駁回部門,駁回主管,駁回說明&quot;;
	pw.println(str);
	//表身
		for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			var processname = &quot;&quot;;
			var realExecutor = &quot;&quot;;
			if (task != null){
				processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					if(processname == &quot;DE主管作廢審核&quot; || processname == &quot;提出單位最高主管&quot;){
					   if( hm.get(&quot;ITEM115&quot;)==&quot;&quot;){
					     processname += &quot;【作廢】&quot;;
					   }else{
					     processname = &quot;作廢&quot;;
					   }
					 if( hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){
					   processname = &quot;作廢&quot;;
					  } 
					}
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				if( form.indexOf(&quot;MECN&quot;)&gt;=0){
				    if(processname == &quot;MECN第一階段(申請)審核通過通知&quot;){
				       processname = &quot;第一階段結束&quot;;
				    }else if(processname == &quot;MECN第二階段(申請)審核通過通知&quot;){
				       processname = &quot;第二階段結束&quot;;
				    }   
                }
			    if (processname == &quot;已結案&quot; || processname == &quot;作廢&quot; || processname == &quot;第一階段結束&quot; || processname == &quot;第二階段結束&quot; ||hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){				
//			    if (processname == &quot;已結案&quot; || processname == &quot;作廢&quot; || processname == &quot;第一階段結束&quot; || processname == &quot;第二階段結束&quot; ){
			        var realExecutor =&quot;&quot;;	
			    }else if (processname == &quot;申請人&quot;){
				    var realExecutor = hm.get(&quot;ITEM318&quot;);	
			    }else{
						
			 	var realExecutor =&quot;&quot;;	
			  	var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				
				var vMemList = getUnsignMemName(task); // 加會簽
					if(&quot;&quot;==vMemList){
						vMemList = getUnsignMemNameExt(task);
				}
             
             //===============================================================================================			
				if(&quot;&quot;==vMemList){
					var realExecutor = memberRecord.getName();			
				}else{
					var realExecutor = vMemList;	
				}
				var temp = asign_member(task);
			    if(temp==&quot;&quot;){		
			  	   var realExecutor = memberRecord.getName();	
				   	if(&quot;&quot;!=vMemList){	
					var realExecutor = vMemList;	
				    }
			    }else{
					 var realExecutor = temp;
			    }
			   }
			}
			var str1 = i + 1    				+ &quot;,&quot;; //序
			str1 = str1 + processname   		+ &quot;,&quot;;//目前關卡
			str1 = str1 + hm.get(&quot;ITEM62&quot;) 	    + &quot;,&quot;;//文件編號
			str1 = str1 + hm.get(&quot;ITEM325&quot;) 	+ &quot;,&quot;;//部門
			str1 = str1 + hm.get(&quot;ITEM318&quot;)  	+ &quot;,&quot;;//申請人姓名
			
//			var msg = realExecutor.replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + realExecutor  	    + &quot;,&quot;;//目前處理者
			
			str1 = str1 + hm.get(&quot;ITEM12&quot;)    	+ &quot;,&quot;;//填寫日期
			str1 = str1 + hm.get(&quot;ITEM115&quot;)    	+ &quot;,&quot;;//結案日期				
			
			var msg1 = hm.get(&quot;ITEM200&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + msg1 	                + &quot;,&quot;;//文件標題

			str1 = str1 + hm.get(&quot;ITEM66&quot;)		+ &quot;,&quot;;//文件類別				
			str1 = str1 + hm.get(&quot;ITEM6&quot;)		+ &quot;,&quot;;//駁回部門
			str1 = str1 + hm.get(&quot;manager&quot;)		+ &quot;,&quot;;//駁回主管	
			
		    var msg2 = hm.get(&quot;ITEM1&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + msg2 	                + &quot;,&quot;;//駁回說明	
				
			pw.println(str1);
			}catch(e){}
	}//for i
	pw.close();
}
//* -----------------------------------------------------------------------------------------------------------------------*//
//PDM //
function PDM_writeScriptToFile(m_filePath, today, vec,filename) {
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var form = Form.getValue(&quot;Artifact&quot;);
	var file  = new Packages.java.io.File(m_filePath);
	file.createNewFile();
	var pw =  new Packages.java.io.PrintWriter(new Packages.java.io.FileOutputStream(file));
	//以下三行str為表頭,第一個要修改的地方 
	var str = filename + &quot; 列印日期: &quot; + today;
	pw.println(str);
	var str  = &quot;&quot;;
	pw.println(str);
	//下一行str各行標題,第二個要修改的地方 	
    if (form.indexOf(&quot;工程矯正回饋單&quot;)&gt;=0){
	    var str = &quot;序,發行日期,Old Rev,New Rev,文件編號,變更內容說明,工具變更,傳承,廠別,申請人姓名,申請部門,目前關卡,目前處理者&quot;; 	 	 
	}else if (form.indexOf(&quot;產品設計資料袋&quot;)&gt;=0){
	    var str = &quot;序,目前關卡,文件編號,申請部門,申請人姓名,目前處理者,填寫日期,結案日期&quot;; 	 	 
	}else{
	    var str = &quot;序,目前關卡,文件編號,申請部門,申請人姓名,目前處理者,填寫日期,結案日期,文件標題,文件說明&quot;; 	 	 
	}
	pw.println(str);
	//表身
		for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			var processname = &quot;&quot;;
			var realExecutor = &quot;&quot;;
			if (task != null){
				processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					   processname = &quot;作廢&quot;;
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}

			    if (processname == &quot;已結案&quot; || processname == &quot;作廢&quot;){
			        var realExecutor =&quot;&quot;;	
			    }else if (processname == &quot;申請人&quot;){
				    var realExecutor = hm.get(&quot;ITEM318&quot;);	
			    }else{
						
			 	var realExecutor =&quot;&quot;;	
			  	var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				
				var vMemList = getUnsignMemName(task); // 加會簽
					if(&quot;&quot;==vMemList){
						vMemList = getUnsignMemNameExt(task);
				}
             
             //===============================================================================================			
				if(&quot;&quot;==vMemList){
					var realExecutor = memberRecord.getName();			
				}else{
					var realExecutor = vMemList;	
				}
				var temp = asign_member(task);
			    if(temp==&quot;&quot;){		
			  	   var realExecutor = memberRecord.getName();	
				   	if(&quot;&quot;!=vMemList){	
					var realExecutor = vMemList;	
				    }
			    }else{
					 var realExecutor = temp;
			    }
			   }
			}
			var str1 = i + 1    				+ &quot;,&quot;; //序
		if (form.indexOf(&quot;工程矯正回饋單&quot;)&gt;=0){
			str1 = str1 + hm.get(&quot;ITEM12&quot;)    	+ &quot;,&quot;;//填寫日期	
			str1 = str1 + hm.get(&quot;ITEM61&quot;)    	+ &quot;,&quot;;//Old Rev	
			str1 = str1 + hm.get(&quot;ITEM96&quot;)    	+ &quot;,&quot;;//New Rev	
			str1 = str1 + hm.get(&quot;ITEM62&quot;) 	    + &quot;,&quot;;//文件編號		
			
			var msg2 = hm.get(&quot;ITEM4&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + msg2 	                + &quot;,&quot;;//變更內容說明
			var temp =&quot;&quot;;
			var count =&quot;1&quot;;
			if(hm.get(&quot;ITEM21&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;線路變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM79&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;孔位變更&quot;
				 var count = &quot;2&quot; ;
			   }else{
			     temp += &quot;/孔位變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM84&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;電鍍方式變更&quot;
				 var count = &quot;2&quot; ;
			   }else{
			     temp += &quot;/電鍍方式變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM87&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;防焊變更&quot;
				 var count = &quot;2&quot; ;
			   }else{
			     temp += &quot;/防焊變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM89&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;層次變更&quot;
				 var count = &quot;2&quot; ;
			   }else{
			     temp += &quot;/層次變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM90&quot;)== &quot;true&quot;){
			   if(count == &quot;1&quot;){
			     temp = &quot;排版變更&quot;
				 var count = &quot;2&quot; ;
			   }else{
			     temp += &quot;/排版變更&quot;
				 var count = &quot;2&quot; ;
			   }	 
			}
			if(hm.get(&quot;ITEM91&quot;)== &quot;true&quot;){
			     temp = &quot;不影響治具&quot; 
			}	
		
			str1 = str1 + temp	    + &quot;,&quot;;//工具變更
			
			if(hm.get(&quot;ITEM56&quot;)== &quot;true&quot;){
			str1 = str1 + &quot;是&quot; + &quot;,&quot;;//傳承
			}else{
			str1 = str1 + &quot;否&quot; + &quot;,&quot;;//傳承
			}
			str1 = str1 + hm.get(&quot;ITEM2&quot;).substring(1,5) + &quot;,&quot;;//廠別
			str1 = str1 + hm.get(&quot;ITEM318&quot;)  	+ &quot;,&quot;;//申請人姓名
			str1 = str1 + hm.get(&quot;ITEM325&quot;) 	+ &quot;,&quot;;//部門
			str1 = str1 + processname   		+ &quot;,&quot;;//目前關卡
			str1 = str1 + realExecutor  	    + &quot;,&quot;;//目前處理者

		}else{	
			str1 = str1 + processname   		+ &quot;,&quot;;//目前關卡
			str1 = str1 + hm.get(&quot;ITEM62&quot;) 	    + &quot;,&quot;;//文件編號
			str1 = str1 + hm.get(&quot;ITEM325&quot;) 	+ &quot;,&quot;;//部門
			str1 = str1 + hm.get(&quot;ITEM318&quot;)  	+ &quot;,&quot;;//申請人姓名
			str1 = str1 + realExecutor  	    + &quot;,&quot;;//目前處理者
			
			str1 = str1 + hm.get(&quot;ITEM12&quot;)    	+ &quot;,&quot;;//填寫日期
			str1 = str1 + hm.get(&quot;ITEM115&quot;)    	+ &quot;,&quot;;//結案日期			
			
			if (form.indexOf(&quot;產品設計資料袋&quot;)&lt;0){
			    var msg1 = hm.get(&quot;ITEM200&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		        str1 = str1 + msg1	                + &quot;,&quot;;//文件標題
			
			    var msg2 = hm.get(&quot;ITEM4&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		        str1 = str1 + msg2 	                + &quot;,&quot;;//文件說明
			}
			
          }
		  pw.println(str1);
	    }catch(e){}
	}//for i
	pw.close();
}

function PDM_writeScriptToFile_R(m_filePath, today, vec,filename,stytle) {
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var v_version = Form.getValue(&quot;MECN_Version&quot;);
	var form = Form.getValue(&quot;Artifact&quot;);
	var file  = new Packages.java.io.File(m_filePath);
	file.createNewFile();
	var pw =  new Packages.java.io.PrintWriter(new Packages.java.io.FileOutputStream(file));
	//以下三行str為表頭,第一個要修改的地方 
	var str = filename + &quot; 列印日期: &quot; + today;
	pw.println(str);
	var str  = &quot;&quot;;
	pw.println(str);
	//下一行str各行標題,第二個要修改的地方 	
	  var str = &quot;序,目前關卡,文件編號,申請部門,申請人姓名,目前處理者,填寫日期,結案日期,文件標題,駁回部門,駁回主管,駁回說明&quot;;
	pw.println(str);
	//表身
		for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			var processname = &quot;&quot;;
			var realExecutor = &quot;&quot;;
			if (task != null){
				processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					   processname = &quot;作廢&quot;;
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
			    if (processname == &quot;已結案&quot; || processname == &quot;作廢&quot;){
			        var realExecutor =&quot;&quot;;	
			    }else if (processname == &quot;申請人&quot;){
				    var realExecutor = hm.get(&quot;ITEM318&quot;);	
			    }else{
						
			 	var realExecutor =&quot;&quot;;	
			  	var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				
				var vMemList = getUnsignMemName(task); // 加會簽
					if(&quot;&quot;==vMemList){
						vMemList = getUnsignMemNameExt(task);
				}
             
             //===============================================================================================			
				if(&quot;&quot;==vMemList){
					var realExecutor = memberRecord.getName();			
				}else{
					var realExecutor = vMemList;	
				}
				var temp = asign_member(task);
			    if(temp==&quot;&quot;){		
			  	   var realExecutor = memberRecord.getName();	
				   	if(&quot;&quot;!=vMemList){	
					var realExecutor = vMemList;	
				    }
			    }else{
					 var realExecutor = temp;
			    }
			   }
			}
			var str1 = i + 1    				+ &quot;,&quot;; //序
			str1 = str1 + processname   		+ &quot;,&quot;;//目前關卡
			str1 = str1 + hm.get(&quot;ITEM62&quot;) 	    + &quot;,&quot;;//文件編號
			str1 = str1 + hm.get(&quot;ITEM325&quot;) 	+ &quot;,&quot;;//部門
			str1 = str1 + hm.get(&quot;ITEM318&quot;)  	+ &quot;,&quot;;//申請人姓名
			
//			var msg = realExecutor.replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + realExecutor  	    + &quot;,&quot;;//目前處理者
			
			str1 = str1 + hm.get(&quot;ITEM12&quot;)    	+ &quot;,&quot;;//填寫日期
			str1 = str1 + hm.get(&quot;ITEM115&quot;)    	+ &quot;,&quot;;//結案日期				
			
			var msg1 = hm.get(&quot;ITEM200&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + msg1 	                + &quot;,&quot;;//文件標題
			
			str1 = str1 + hm.get(&quot;ITEM6&quot;)		+ &quot;,&quot;;//駁回部門
			str1 = str1 + hm.get(&quot;manager&quot;)		+ &quot;,&quot;;//駁回主管	
			
		    var msg2 = hm.get(&quot;ITEM1&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		    str1 = str1 + msg2 	                + &quot;,&quot;;//駁回說明	
				
			pw.println(str1);
			}catch(e){}
	}//for i
	pw.close();
}

//========================================================================================
// PDM共用條件的SQL SEARCH  (ECR、Gerber、資料袋、ER、EQ、ECN、NC、MOS)
//========================================================================================

function search_data(){
	/**設定 artifact id*/
	var artifact_name = Form.getValue(&quot;Artifact&quot;);
	
	//PDM_EG   
	if(artifact_name == &quot;ECR申請單&quot;){
	   var artid_3 = &quot;ART03801480062913861&quot;; //ECR V5
	   var temp_3 =&quot;,A.ITEM200,A.ITEM4&quot;;//ECR V3
	   
	   var artid_2 = &quot;ART01281304586601221&quot;; //ECR V3
	   var temp_2 =&quot;,A.ITEM200,A.ITEM4&quot;;//ECR V3
		
	   var artid_1 = &quot;ART02141262697497713&quot;; //ECR V2
	   var temp_1 =&quot;,A.ITEM200,A.ITEM4&quot;;//ECR V2
	   
	   var artid = &quot;ART00241228098396686&quot;; //ECR
	   var temp =&quot;,A.ITEM200,A.ITEM4&quot;;//ECR

	}else if(artifact_name == &quot;客戶資料簽收單&quot;){
		
	   var artid_2 = &quot;ART01291304588645598&quot;; //客戶資料簽收單 V3
	   var temp_2 =&quot;,A.ITEM200,A.ITEM4&quot;;//客戶資料簽收單 V3
		
	   var artid_1 = &quot;ART02211262741750471&quot;; //客戶資料簽收單 V2
	   var temp_1 =&quot;,A.ITEM200,A.ITEM4&quot;;//客戶資料簽收單 V2
	   
	   var artid= &quot;ART01211231831408011&quot;; //客戶資料簽收單
	   var temp=&quot;,A.ITEM200,A.ITEM4&quot;;//客戶資料簽收單

	}else if(artifact_name == &quot;產品設計資料袋&quot;){
		
	   var artid_2 = &quot;ART02131262697493698&quot;; //產品設計資料袋 V3
	   var temp_2 =&quot;&quot;;//產品設計資料袋 V3
		
	   var artid_1 = &quot;ART02131262697493698&quot;; //產品設計資料袋 V2
	   var temp_1 =&quot;&quot;;//產品設計資料袋 V2
	   
	   var artid = &quot;ART00301212457208664&quot;; //產品設計資料袋
	   var temp =&quot;&quot;;//產品設計資料袋

    //PDM_DE
	}else if(artifact_name == &quot;ECN申請單&quot;){
	   var artid_2 = &quot;ART01321304651292005&quot;; //ECN申請單 V4
	   var temp_2 =&quot;,A.ITEM200,A.ITEM4&quot;;//ECN申請單 V4
		
	   var artid_1 = &quot;ART01641284974901884&quot;; //ECN申請單 V2
	   var temp_1 =&quot;,A.ITEM200,A.ITEM4&quot;;//ECN申請單 V2
	   
	   var artid = &quot;&quot;;
	   var temp =&quot;&quot;;

	}else if(artifact_name == &quot;工程矯正回饋單&quot;){
	   var artid_2 = &quot;ART01301304651222444&quot;; //工程矯正回饋單 V3
	   var temp_2 =&quot;,A.ITEM200,A.ITEM4,A.ITEM61,A.ITEM96,A.ITEM56,A.ITEM21,A.ITEM79,A.ITEM84,A.ITEM87,A.ITEM89,A.ITEM90,A.ITEM91&quot;;//工程矯正回饋單 V3
		
	   var artid_1 = &quot;ART01621284974838760&quot;; //工程矯正回饋單 V2
	   var temp_1 =&quot;,A.ITEM200,A.ITEM4,A.ITEM61,A.ITEM96,A.ITEM56,A.ITEM21,A.ITEM79,A.ITEM84,A.ITEM87,A.ITEM89,A.ITEM90,A.ITEM91&quot;;//工程矯正回饋單 V2
	   
	   var artid = &quot;&quot;;
	   var temp =&quot;&quot;;

	}else if(artifact_name == &quot;客戶資料待確認單&quot;){
	   var artid_2 = &quot;ART01311304651283083&quot;; //客戶資料待確認單 V3
	   var temp_2 =&quot;,A.ITEM200,A.ITEM4&quot;;//客戶資料待確認單 V3
		
	   var artid_1 = &quot;ART01631284974878134&quot;; //客戶資料待確認單 V2
	   var temp_1 =&quot;,A.ITEM200,A.ITEM4&quot;;//客戶資料待確認單 V2
	   
	   var artid = &quot;&quot;;
	   var temp =&quot;&quot;;
	//NC檢核單   
	}else if(artifact_name == &quot;成型檢核申請單&quot;){
	   var artid_2 = &quot;ART02081241511651423&quot;; //NC檢核單
	   var temp_2 =&quot;,A.ITEM200,A.ITEM4&quot;;//NC檢核單
		
	   var artid_1 = &quot;ART02081241511651423&quot;; //NC檢核單
	   var temp_1 =&quot;,A.ITEM200,A.ITEM4&quot;;//NC檢核單
	   
	   var artid = &quot;&quot;; //NC檢核單
	   var temp =&quot;&quot;;//NC檢核單
	//PDM_MOS   
	}else if(artifact_name == &quot;設計完成紀錄單&quot;){
	   var artid_2 = &quot;ART00551256801381550&quot;; //發料單V3
	   var temp_2 =&quot;,A.ITEM200,A.ITEM4&quot;;//發料單V3
		
	   var artid_1 = &quot;ART00551256801381550&quot;; //發料單V2
	   var temp_1 =&quot;,A.ITEM200,A.ITEM4&quot;;//發料單V2
	   
	   var artid = &quot;ART01881236563317760&quot;; //發料單
	   var temp =&quot;,A.ITEM200,A.ITEM4&quot;;//發料單
	}

	//文件狀態
	var Status = Form.getValue(&quot;Status&quot;);	
    loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	loadLibrary(&quot;com.gce.PLM.Common.Client.PDM_List&quot;);
	
	if (&quot;全部&quot;.equals(Status) || &quot;已結案&quot;.equals(Status) || &quot;未結案&quot;.equals(Status)|| &quot;已作廢&quot;.equals(Status)){
	  try{
		var sql = &quot;SELECT A.INSID,A.ITEM2,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM155,A.ITEM115&quot; + temp_2;
		    sql +=&quot;  FROM &quot;+ artid_2 +&quot;_INS A&quot;;
		    sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot; ;
		    sql += getQueryCondition() + getQueryCondition_ecr1(artifact_name) + check_status(Status)+chk_gerber(artifact_name,&quot;1&quot;);			
		    sql +=&quot; union  &quot;;	
		    sql += &quot;SELECT A.INSID,A.ITEM2,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM155,A.ITEM115&quot; + temp_1;
		    sql +=&quot;  FROM &quot;+ artid_1 +&quot;_INS A&quot;;
		    sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot; ;
		    sql += getQueryCondition() + getQueryCondition_ecr1(artifact_name) + check_status(Status)+chk_gerber(artifact_name,&quot;2&quot;);
		if (artid != &quot;&quot;){
            sql +=&quot; union  &quot;;
			sql +=&quot;SELECT A.INSID,A.ITEM2,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM155,A.ITEM115&quot; + temp;
		    sql +=&quot;  FROM &quot;+ artid +&quot;_INS A&quot;;
		    sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot; ;
            sql += getQueryCondition() + getQueryCondition_ecr(artifact_name) + check_status(Status)+chk_gerber(artifact_name,&quot;2&quot;);
		}	
		if(artifact_name == &quot;ECR申請單&quot;){
			sql +=&quot; union  &quot;;
			sql += &quot;SELECT A.INSID,A.ITEM2,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM155,A.ITEM115,A.ITEM200,A.ITEM4 &quot;;
		    sql +=&quot;  FROM ART01791330323904714_INS A&quot;;
		    sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot; ;
		    sql += getQueryCondition() + getQueryCondition_ecr4(artifact_name) + check_status(Status);
			sql +=&quot; union  &quot;;
			sql += &quot;SELECT A.INSID,A.ITEM2,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM155,A.ITEM115,A.ITEM200,A.ITEM4 &quot;;
		    sql +=&quot;  FROM ART03801480062913861_INS A&quot;;
		    sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot; ;
		    sql += getQueryCondition() + getQueryCondition_ecr4(artifact_name) + check_status(Status);
		}
		
		    sql += &quot;ORDER BY ITEM12 &quot;;		
		var vec = Client.SQLloadValue(sql);
		Client.addDebugLog(&quot;pdm_search_sql==&quot;+sql);
		Client.setLocalObject(&quot;vec&quot;,vec);
	 }catch(e){
		java.lang.System.out.println(&quot;PDM__List_error=&quot;+e);	
	 }
   // 已結案(被退件過) or 未結案(被退件過)
   }else{	
	 try{
		var sql = &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM155,A.ITEM115,B.ITEM6,B.ITEM4 manager,B.ITEM1&quot; + temp_2;
		    sql +=&quot;  FROM &quot;+ artid_1 +&quot;_INS A,&quot; +artid_1 +&quot;ITEM28 B&quot;;
		    sql +=&quot; WHERE A.ITEM62 != &apos;null&apos; &quot; ;
		    sql += getQueryCondition() + getQueryCondition_ecr1(artifact_name) + check_status(Status)+chk_gerber(artifact_name,&quot;1&quot;); 
	        sql +=&quot; union  &quot;;		
		    sql += &quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM155,A.ITEM115,B.ITEM6,B.ITEM4 manager,B.ITEM1&quot; + temp_1;
		    sql +=&quot;  FROM &quot;+ artid_1 +&quot;_INS A,&quot; +artid_1 +&quot;ITEM28 B&quot;;
		    sql +=&quot; WHERE A.ITEM62 != &apos;null&apos; &quot; ;
		    sql += getQueryCondition() + getQueryCondition_ecr1(artifact_name) + check_status(Status);
		if (artid != &quot;&quot;){
            sql +=&quot; union  &quot;;
			sql +=&quot;SELECT A.INSID,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM155,A.ITEM115,B.ITEM6,B.ITEM4 manager,B.ITEM1&quot; + temp;
		    sql +=&quot;  FROM &quot;+ artid +&quot;_INS A,&quot; +artid +&quot;ITEM28 B&quot;;
		    sql +=&quot; WHERE A.ITEM62 != &apos;null&apos; &quot; ;
            sql += getQueryCondition() + getQueryCondition_ecr(artifact_name) + check_status(Status)+chk_gerber(artifact_name,&quot;2&quot;);
		}	
		if(artifact_name == &quot;ECR申請單&quot;){
			sql +=&quot; union  &quot;;
			sql += &quot;SELECT A.INSID,A.ITEM2,A.ITEM62,A.ITEM325,A.ITEM318,A.ITEM12,A.ITEM155,A.ITEM115,A.ITEM200,A.ITEM4 &quot;;
		    sql +=&quot;  FROM ART01791330323904714_INS A&quot;;
		    sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot; ;
		    sql += getQueryCondition() + getQueryCondition_ecr4(artifact_name) + check_status(Status);
		}
		    sql += &quot;ORDER BY ITEM12 &quot;;		
		var vec = Client.SQLloadValue(sql);
		Client.setLocalObject(&quot;vec&quot;,vec);
		//Client.addDebugLog(&quot;sql..2.&quot;+sql);
	 }catch(e){
		java.lang.System.out.println(&quot;PDM_List_error=&quot;+e);	
	 }
	
	}
	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;Count&quot;,vec.size()+&quot;&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);
	showTable_N(1,vec);
}//function search_data()

function  chk_gerber(artifact_name,type){
	var sSQL = &quot;&quot;;
	var spno = Form.getValue(&quot;spno&quot;);
	if(artifact_name==&quot;客戶資料簽收單&quot; &amp;&amp; spno!=&quot;&quot;){		
		if(type==&quot;1&quot;){
			sSQL = &quot; AND ITEM78 like &apos;&quot; + spno + &quot;%&apos;&quot;;
		}else{
			sSQL = &quot; AND 1 = 2 &quot;;
		}
	}
	return sSQL;
}
function check_status(Status){
	var sSQL=&quot;&quot;;
	
    if (&quot;已結案&quot;.equals(Status)) {
				sSQL += &quot; AND ITEM115 is not null &quot;;
	}else if (&quot;未結案&quot;.equals(Status)){
				sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;	
	}else if (&quot;已作廢&quot;.equals(Status)){
				sSQL += &quot; AND ITEM155 = &apos;true&apos;  &quot;;			
	}else if (&quot;全部(被退件過)&quot;.equals(Status)){
				sSQL += &quot; AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) AND A.INSID  = B.INSID  &quot;;				
	}else if (&quot;已結案(被退件過)&quot;.equals(Status)){
				sSQL += &quot; AND A.ITEM115 is not null AND A.ITEM155 = &apos;false&apos; AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) AND A.INSID  = B.INSID   &quot;;		
	}else if (&quot;未結案(被退件過)&quot;.equals(Status)){
				sSQL += &quot; AND A.ITEM115 is null  AND A.ITEM155 = &apos;false&apos; AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) AND A.INSID  = B.INSID  &quot;;		
	}else if (&quot;作廢(被退件過)&quot;.equals(Status)){
				sSQL += &quot; AND A.ITEM155 = &apos;true&apos;  AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) AND A.INSID  = B.INSID  &quot;;								
	}else{
	     sSQL += &quot;&quot;;
	}	
    return sSQL;		
}

//抓取V2版表單
function getQueryCondition_ecr1(artifact_name){
	var sSQL=&quot;&quot;;
	var Status = Form.getValue(&quot;Status&quot;);
	
	//ECR V2 抓取母表單
	if (artifact_name == &quot;ECR申請單&quot;){
		//抓取廠別
	    sSQL +=check_factory(&quot;ITEM66&quot;,&quot;ITEM67&quot;,&quot;ITEM202&quot;,&quot;ITEM180&quot;);
		sSQL += &quot; AND ITEM105 = &apos;Y&apos; &quot;;
	    //只抓取不變更版本的ECR
	    sSQL += &quot;and ((ITEM51 is null and  Item77 is null) or(ITEM51 = Item77))&quot; ;		
	}else if (artifact_name == &quot;客戶資料簽收單&quot;){
		//抓取廠別
	    sSQL +=check_factory(&quot;ITEM16&quot;,&quot;ITEM6&quot;,&quot;ITEM202&quot;,&quot;ITEM73&quot;);
		sSQL += &quot; AND ITEM38 = &apos;Y&apos; &quot;;
	}else if (artifact_name == &quot;產品設計資料袋&quot;){
	    //抓取廠別
	    sSQL +=check_factory(&quot;ITEM16&quot;,&quot;ITEM9&quot;,&quot;ITEM202&quot;,&quot;ITEM10&quot;);
		sSQL += &quot; AND ITEM105 = &apos;Y&apos; &quot;;
	}else if (artifact_name == &quot;ECN申請單&quot;){
		//抓取廠別
	    sSQL +=check_factory(&quot;ITEM16&quot;,&quot;ITEM6&quot;,&quot;ITEM202&quot;,&quot;ITEM51&quot;);
		sSQL += &quot; AND ITEM53 = &apos;Y&apos; &quot;;		
	}else if (artifact_name == &quot;工程矯正回饋單&quot;){
		//抓取廠別
	    sSQL +=check_factory(&quot;ITEM16&quot;,&quot;ITEM6&quot;,&quot;ITEM202&quot;,&quot;ITEM230&quot;);
		sSQL += &quot; AND ITEM9 = &apos;Y&apos; &quot;;
	}else if (artifact_name == &quot;客戶資料待確認單&quot;){
		//抓取廠別
	    sSQL +=check_factory(&quot;ITEM16&quot;,&quot;ITEM6&quot;,&quot;ITEM202&quot;,&quot;ITEM54&quot;);
		sSQL += &quot; AND ITEM53 = &apos;Y&apos; &quot;;
    }else if (artifact_name == &quot;發料單&quot; ){
		//抓取廠別
	    sSQL +=check_factory(&quot;ITEM66&quot;,&quot;ITEM67&quot;,&quot;ITEM202&quot;,&quot;&quot;);
		if (&quot;未結案&quot;.equals(Status) || &quot;未結案(被退件過)&quot;.equals(Status) ||  &quot;全部&quot;.equals(Status)){
			     sSQL += &quot; AND ITEM98 is not null &quot;;
        }
	}else{
	   sSQL=&quot;&quot;;
	} 
    return sSQL;
}

//抓取V4版表單
function getQueryCondition_ecr4(artifact_name){
	var sSQL=&quot;&quot;;
	var Status = Form.getValue(&quot;Status&quot;);
	
	//ECR V2 抓取母表單
	if (artifact_name == &quot;ECR申請單&quot;){
		//抓取廠別
	    sSQL +=check_factory(&quot;ITEM153&quot;,&quot;ITEM154&quot;,&quot;ITEM156&quot;,&quot;ITEM157&quot;);
		sSQL += &quot; AND ITEM105 = &apos;Y&apos; &quot;;
	    //只抓取不變更版本的ECR
	    sSQL += &quot;and ((ITEM51 is null and  Item77 is null) or(ITEM51 = Item77))&quot; ;		
	}else{
	   sSQL=&quot;&quot;;
	} 
    return sSQL;
}

//抓取V1版表單
function getQueryCondition_ecr(artifact_name){
	var sSQL=&quot;&quot;;
	
	//ECR V2 抓取母表單
	if (artifact_name == &quot;ECR申請單&quot;){
		//抓取廠別
	    sSQL +=check_factory(&quot;ITEM66&quot;,&quot;ITEM67&quot;,&quot;ITEM202&quot;,&quot;&quot;);
	    //只抓取不變更版本的ECR
	    sSQL += &quot;and ((ITEM51 is null and  Item77 is null) or(ITEM51 = Item77))&quot; ;		
	}else if (artifact_name == &quot;客戶資料簽收單&quot;){
		//抓取廠別
	    sSQL +=check_factory(&quot;ITEM16&quot;,&quot;ITEM6&quot;,&quot;ITEM202&quot;,&quot;&quot;);
	}else if (artifact_name == &quot;產品設計資料袋&quot;){
	    //抓取廠別
	    sSQL +=check_factory(&quot;ITEM16&quot;,&quot;ITEM9&quot;,&quot;ITEM202&quot;,&quot;&quot;);
	}else if (artifact_name == &quot;成型檢核申請單&quot;){
		//抓取廠別
	    sSQL +=check_factory(&quot;ITEM16&quot;,&quot;ITEM6&quot;,&quot;ITEM202&quot;,&quot;ITEM60&quot;);
	}else if (artifact_name == &quot;發料單&quot; ){
		//抓取廠別
	    sSQL +=check_factory(&quot;ITEM66&quot;,&quot;ITEM67&quot;,&quot;ITEM202&quot;,&quot;&quot;);
	}else{
	   sSQL=&quot;&quot;;
	}
    return sSQL;
}

//抓取廠別
function check_factory(v_tgce,v_sgce,v_cgce,v_hgce){
	
  var factory = &quot;&quot;;
  var sSQL = &quot;&quot;;
  var con = &quot;1&quot;;
  if( Form.getValue(&quot;TGCE&quot;)== &quot;true&quot;){
	   if(con == &quot;1&quot;){
		      temp = &quot; and (&quot;;
	  }
	  var con = &quot;2&quot;;
	  sSQL += temp + v_tgce + &quot;=&apos;true&apos;&quot;;	
  }
  if( Form.getValue(&quot;SGCE&quot;) == &quot;true&quot; ){
	  if(con == &quot;1&quot;){
		      temp = &quot; and (&quot;;
	  }else{  temp = &quot; or &quot;;
	  }
	  var con = &quot;2&quot;;
	  sSQL += temp + v_sgce + &quot;=&apos;true&apos;&quot;;	
  }
  if( Form.getValue(&quot;CGCE&quot;) == &quot;true&quot; ){
	  if(con == &quot;1&quot;){
		      temp = &quot; and (&quot;;
	  }else{  temp = &quot; or &quot;;
	  }
	  var con = &quot;2&quot;;
	  sSQL += temp + v_cgce + &quot;=&apos;true&apos;&quot;;	
  }
  if( Form.getValue(&quot;HGCE&quot;) == &quot;true&quot; &amp;&amp; v_hgce!=&quot;&quot;){
	  if(con == &quot;1&quot;){
		      temp = &quot; and (&quot;;
	  }else{  temp = &quot; or &quot;;
	  }
	  sSQL += temp + v_hgce + &quot;=&apos;true&apos;&quot;;	
  }else if(Form.getValue(&quot;TGCE&quot;)!= &quot;true&quot; &amp;&amp; Form.getValue(&quot;SGCE&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;CGCE&quot;) != &quot;true&quot; &amp;&amp; v_hgce==&quot;&quot;){
      temp = &quot; and (&quot;;
	  sSQL += temp + v_tgce + &quot;!=&apos;true&apos; and &quot; + v_sgce + &quot;!=&apos;true&apos; and &quot; + v_cgce + &quot;!=&apos;true&apos;&quot;;	
  }else if(Form.getValue(&quot;TGCE&quot;)!= &quot;true&quot; &amp;&amp; Form.getValue(&quot;SGCE&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;CGCE&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;HGCE&quot;) != &quot;true&quot; &amp;&amp; v_hgce!=&quot;&quot;){
      temp = &quot; and (&quot;;
	  sSQL += temp + v_tgce + &quot;=&apos;true&apos; or &quot; + v_sgce + &quot;=&apos;true&apos; or &quot; + v_cgce + &quot;=&apos;true&apos; or &quot; + v_hgce + &quot;=&apos;true&apos;&quot;;	
  }  
    sSQL +=&quot; )&quot;;
	  
    return sSQL;
}


//========================================================================================
// MECN Excel File
// 20100316 改版 by irenechang
//========================================================================================
function mecn_main(filename,satus,table_temp) {
	var serverTime = Client.getServerTime();
	var myDate = new Packages.pase.agenda.MyDate(serverTime);
	var today = myDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;);
	var date = myDate.getCurrentDate(&quot;YMDHmS&quot;);
//	var vec = Client.getLocalObject(vec);
   	var table_temp_t = Form.getComponent(table_temp);	
    var v_count =table_temp_t.getRowCount();		
	if (v_count &gt; 0){
      if(satus == &quot;1&quot;){
	        MECN_writeScriptToFile_new(&quot;C:\\temp\\&quot;+ filename +&quot;-&quot; + date + &quot;.csv&quot;, today, filename,table_temp);
	  }else{
	        MECN_writeScriptToFile_R(&quot;C:\\temp\\&quot;+ filename +&quot;-&quot; + date + &quot;.csv&quot;, today, filename,table_temp);
	  }
	  Form.downloadFile(&quot;C:\\temp\\&quot;, filename+&quot;-&quot; + date + &quot;.csv&quot;);	//for JSP
	}else{Form.showMessageDialog(&quot;查無任何相關記錄可產生！&quot;);}
	
}//function mecn_main(filename,vec,satus,stytle,table_temp) 


//MECN //
function MECN_writeScriptToFile_new(m_filePath, today,filename,table_temp){
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var file  = new Packages.java.io.File(m_filePath);
	file.createNewFile();
	var pw =  new Packages.java.io.PrintWriter(new Packages.java.io.FileOutputStream(file));
	//以下三行str為表頭,第一個要修改的地方 
	var str = filename + &quot; 列印日期: &quot; + today;
	pw.println(str);
	var str  = &quot;&quot;;
	pw.println(str);
	//下一行str各行標題,第二個要修改的地方 	
    var str = &quot;序,目前階段,目前關卡,目前處理者,文件編號,申請部門,申請人姓名,填寫日期,結案日期,文件標題,文件類別,變更原因,變更內容,實驗計劃,實驗結果&quot;;
	pw.println(str);
   	var table_temp = Form.getComponent(table_temp);	
    var v_count =table_temp.getRowCount();	
	 try{
	  if (v_count &gt; 0){
		for (var i = 0; i &lt; v_count; i++) {

  			 var str1  = i + 1    				                  + &quot;,&quot;; //序	
			     str1 +=  table_temp.getValueAt(i,&quot;目前階段&quot;)	   	  + &quot;,&quot;;//目前階段			 
			     str1 +=  table_temp.getValueAt(i,&quot;目前關卡&quot;)   	  + &quot;,&quot;;//目前關卡
				 str1 +=  table_temp.getValueAt(i,&quot;目前處理者&quot;) 	  + &quot;,&quot;;//目前處理者					 
			     str1 +=  table_temp.getValueAt(i,&quot;文件編號&quot;) 	  + &quot;,&quot;;//文件編號
			     str1 +=  table_temp.getValueAt(i,&quot;部門&quot;) 	      + &quot;,&quot;;//申請部門
			     str1 +=  table_temp.getValueAt(i,&quot;申請人姓名&quot;)    + &quot;,&quot;;//申請人姓名			 
			     str1 +=  table_temp.getValueAt(i,&quot;填寫日期&quot;)      + &quot;,&quot;;//填寫日期
   		 	     var source_dataMap_V1 = Client.getArtInstance(table_temp.getValueAt(i,&quot;InsID&quot;)).getAppDataMap();						   
			     str1 +=  source_dataMap_V1.get(&quot;Close_Time&quot;)     + &quot;,&quot;;//結案日期				 
//			     str1 +=  &quot;&quot;     + &quot;,&quot;;//結案日期					 
				 
  			    var msg1 = table_temp.getValueAt(i,&quot;文件標題&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		            str1 +=  msg1 	                              + &quot;,&quot;;//文件標題				 
			        str1 +=  table_temp.getValueAt(i,&quot;文件類別&quot;)	      + &quot;,&quot;;//文件類別	
				 
				 
                 if(table_temp.getValueAt(i,&quot;version&quot;)==&quot;V2&quot;){
                    if(table_temp.getValueAt(i,&quot;InsID2&quot;)!=&quot;&quot;){
				   
				 	var source_dataMap_V1 = Client.getArtInstance(table_temp.getValueAt(i,&quot;InsID&quot;)).getAppDataMap();						   
				 	var source_dataMap_V2 = Client.getArtInstance(table_temp.getValueAt(i,&quot;InsID2&quot;)).getAppDataMap();	
					
					var msg2 = source_dataMap_V1.get(&quot;FTextArea0&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //變更原因
					var msg3 = source_dataMap_V2.get(&quot;FTextField_w732&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //變更內容 
					var msg4 = source_dataMap_V2.get(&quot;FTextArea2&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //實驗計畫 
					var msg5 = source_dataMap_V2.get(&quot;FTextArea3&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);    //實驗結果 					
					
				   }else{
					var source_dataMap_V1 = Client.getArtInstance(table_temp.getValueAt(i,&quot;InsID&quot;)).getAppDataMap();						   
					
					var msg2 = source_dataMap_V1.get(&quot;FTextArea0&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //變更原因
					var msg3 = source_dataMap_V1.get(&quot;FTextArea1&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //變更內容 
					var msg4 = source_dataMap_V1.get(&quot;FTextArea2&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //實驗計畫 
					var msg5 = &quot;&quot;;    //實驗結果 					
				   }
				   
				 }else{
				    if(table_temp.getValueAt(i,&quot;InsID3&quot;)!=&quot;&quot;){
				   
				 	var source_dataMap_V1 = Client.getArtInstance(table_temp.getValueAt(i,&quot;InsID&quot;)).getAppDataMap();						   
				 	var source_dataMap_V2 = Client.getArtInstance(table_temp.getValueAt(i,&quot;InsID2&quot;)).getAppDataMap();	
				 	var source_dataMap_V3 = Client.getArtInstance(table_temp.getValueAt(i,&quot;InsID3&quot;)).getAppDataMap();					
					
					var msg2 = source_dataMap_V1.get(&quot;FTextArea0&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //變更原因
					var msg3 = source_dataMap_V3.get(&quot;FTextArea2&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //變更內容 
					var msg4 = source_dataMap_V2.get(&quot;FTextArea4&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //實驗計畫 
					var msg5 = source_dataMap_V2.get(&quot;comment&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);    //實驗結果 					
	 
                    }else if(table_temp.getValueAt(i,&quot;InsID2&quot;)!=&quot;&quot;){
				   
				 	var source_dataMap_V1 = Client.getArtInstance(table_temp.getValueAt(i,&quot;InsID&quot;)).getAppDataMap();						   
				 	var source_dataMap_V2 = Client.getArtInstance(table_temp.getValueAt(i,&quot;InsID2&quot;)).getAppDataMap();	
					
					var msg2 = source_dataMap_V1.get(&quot;FTextArea0&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //變更原因
					var msg3 = source_dataMap_V2.get(&quot;FTextArea2&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //變更內容 
					var msg4 = source_dataMap_V2.get(&quot;FTextArea4&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //實驗計畫 
					var msg5 = source_dataMap_V2.get(&quot;comment&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);    //實驗結果 					
					
				   }else{
					var source_dataMap_V1 = Client.getArtInstance(table_temp.getValueAt(i,&quot;InsID&quot;)).getAppDataMap();						   
					
					var msg2 = source_dataMap_V1.get(&quot;FTextArea0&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //變更原因
					var msg3 = source_dataMap_V1.get(&quot;FTextArea2&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //變更內容 
					var msg4 = source_dataMap_V1.get(&quot;FTextArea4&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;); //實驗計畫 
					var msg5 = &quot;&quot;;    //實驗結果 					
				   }	
				 }	 
		          str1 +=  msg2 	                + &quot;,&quot;;//變更原因			
		          str1 +=  msg3 	                + &quot;,&quot;;//變更內容 	
		          str1 +=  msg4 	                + &quot;,&quot;;//實驗計劃 	 
		          str1 +=  msg5 	                + &quot;,&quot;;//實驗結果 	 					 

			pw.println(str1);
	 }//for i
	}//if (v_count &gt; 0)
   }catch(e){}	
   pw.close();
}// MECN_writeScriptToFile(m_filePath, today,filename,table_temp)

  
 //========================================================================================
// MECN共用條件的SQL SEARCH 
//========================================================================================
function MECN_Search_check_1(){	
	//  MECN暫時用編號判斷廠別~~Where尚未增加~~
	var msg = &quot;&quot;;	
	if(msg != &quot;&quot;){
		Form.setComplete(false);
		Form.showMessageDialog(msg);
	}else{  
		    var projectid_1 = &quot;PRJ00111211426688700&quot;;   //Project PDM
		    var projectid_2 = &quot;PRJ00311259303602271&quot;;	  //Project MECN
//
			loadLibrary(&quot;com.A.Common.Client.Util&quot;);
			
//			if(artifact == &quot;MECN申請單&quot;){
				var temp1 = &quot;,ITEM350 reason,A.ITEM11 context&quot;
				var temp2 = &quot;,ITEM161 reason,ITEM69 context&quot;
//			}else if(artifact == &quot;MECN實驗結果&quot;){
//				var temp1 = &quot;,ITEM197 context,ITEM354 plan,&apos;&apos; result&quot;
//				var temp2 = &quot;,ITEM274 context,ITEM11 plan ,ITEM92 result&quot;
//			}else{
//				var temp1 = &quot;,ITEM11 context&quot;
//			  	var temp2 = &quot;,&apos;&apos; context&quot;
//			}	
			//1
			var v_begin = 3;
   		    var v_end = 5;
			try{
			  var sql =&quot;&quot;;	
			  for(var i = v_begin; i &lt;= v_end; i++) {
				  var sql_temp = &quot;select artid  from art_geninf where prjid in (&apos;&quot; + projectid_1 + &quot;&apos;,&apos;&quot; + projectid_2 + &quot;&apos;) and name like &apos;MECN%V&quot; + i +&quot;%&apos; order by name&quot;;
	              var vec_temp = Client.SQLloadValue(sql_temp);
 			          Client.setLocalObject(&quot;vec_temp&quot;,vec_temp);
				      var artid_1 = vec_temp.get(0).get(&quot;artid&quot;);
				      var artid_2 = vec_temp.get(2).get(&quot;artid&quot;);					  
				      var artid_3 = vec_temp.get(1).get(&quot;artid&quot;);					  					  
					  				
				    sql +=&quot;SELECT INSID,ITEM62,ITEM325,ITEM318,ITEM12,ITEM200,ITEM66,ITEM155,ITEM115,ITEM231&quot;+temp1 +&quot;,&apos;V&quot;+ i +&quot;&apos; version&quot;;
					sql +=&quot;,(SELECT INSID FROM &quot;+ artid_2 +&quot;_INS WHERE ITEM231=&apos;Y&apos; and ITEM62=A.ITEM62 ) mecn_v2_insid&quot;
					sql +=&quot;,(SELECT INSID FROM &quot;+ artid_3 +&quot;_INS WHERE ITEM231=&apos;Y&apos; and ITEM62=A.ITEM62 ) mecn_v3_insid&quot;					
				    sql +=&quot; FROM &quot;+ artid_1 +&quot;_INS A &quot;;
					sql +=&quot; WHERE ITEM62 != &apos;null&apos; &quot;;
					sql +=&quot; AND ITEM231=&apos;Y&apos;&quot;;
					sql += getQuery_MECN();
				    sql +=&quot; union  &quot;;			
             }
			       var sql_temp2 = &quot;select artid  from art_geninf where prjid in (&apos;&quot; + projectid_1 + &quot;&apos;,&apos;&quot; + projectid_2 + &quot;&apos;) and name in(&apos;MECN申請單 V2&apos;,&apos;MECN實驗結果 V2&apos;) order by name&quot;;			 
		           var vec_temp2 = Client.SQLloadValue(sql_temp2);	
 			          Client.setLocalObject(&quot;vec_temp2&quot;,vec_temp2);
				      var artid = vec_temp2.get(0).get(&quot;artid&quot;);
				      var artid_0 = vec_temp2.get(1).get(&quot;artid&quot;);	
					sql +=&quot;SELECT INSID,ITEM62,ITEM325,ITEM318,ITEM12,ITEM200,ITEM66,ITEM155,ITEM115,&apos;&apos;&quot;+temp2 +&quot;,&apos;V2&apos; version&quot;;
                    sql +=&quot;,(SELECT INSID FROM &quot;+ artid_0 +&quot;_INS WHERE ITEM62=A.ITEM62 ) mecn_v2_insid&quot;					
                    sql +=&quot;,&apos;&apos; mecn_v3_insid &quot;;					
				    sql +=&quot; FROM &quot;+ artid +&quot;_INS A &quot;;
					sql +=&quot;WHERE ITEM62 != &apos;null&apos; &quot;;
					sql += getQuery_MECN();		
					sql += &quot;ORDER BY 13,5 desc &quot;;
			  		
				var vec = Client.SQLloadValue(sql);
				Client.setLocalObject(&quot;vec&quot;,vec);
//				
//				    sql_R +=&quot;SELECT INSID,ITEM62,ITEM325,ITEM318,ITEM12,ITEM200,ITEM66,ITEM155,ITEM115,ITEM231&quot;+temp1 +&quot;,&apos;V&quot;+ i +&quot;&apos; version&quot;;
//					sql_R +=&quot;,(SELECT INSID FROM &quot;+ artid_2 +&quot;_INS WHERE ITEM62 != &apos;null&apos;  AND ITEM231=&apos;Y&apos; and ITEM62=A.ITEM62 &quot; + getQuery_MECN()+&quot;) mecn_v2_insid&quot;
//					sql_R +=&quot;,(SELECT INSID FROM &quot;+ artid_3 +&quot;_INS WHERE ITEM62 != &apos;null&apos;  AND ITEM231=&apos;Y&apos; and ITEM62=A.ITEM62 &quot; + getQuery_MECN()+&quot;) mecn_v3_insid&quot;					
//				    sql_R +=&quot; FROM &quot;+ artid_1 +&quot;_INS A, &quot;+ artid_1 +&quot;ITEM28 B &quot;;
//					sql_R +=&quot; WHERE ITEM62 != &apos;null&apos; &quot;;
//					sql_R +=&quot; AND ITEM231=&apos;Y&apos;&quot;;
//                    sql_R +=&quot; AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;					
//                    sql_R += &quot;AND A.INSID  = B.INSID &quot;;								
//					sql_R += getQuery_MECN();
//				    sql_R +=&quot; union  &quot;;			
//					
//			       var sql_R_temp2 = &quot;select artid  from art_geninf where prjid in (&apos;&quot; + projectid_1 + &quot;&apos;,&apos;&quot; + projectid_2 + &quot;&apos;) and name in(&apos;MECN申請單 V2&apos;,&apos;MECN實驗結果 V2&apos;) order by name&quot;;			 
//		           var vec_temp2 = Client.SQLloadValue(sql_temp2);	
// 			          Client.setLocalObject(&quot;vec_temp2&quot;,vec_temp2);
//				      var artid = vec_temp2.get(0).get(&quot;artid&quot;);
//				      var artid_0 = vec_temp2.get(1).get(&quot;artid&quot;);	
//					sql_R +=&quot;SELECT INSID,ITEM62,ITEM325,ITEM318,ITEM12,ITEM200,ITEM66,ITEM155,ITEM115,&apos;&apos;&quot;+temp2 +&quot;,&apos;V2&apos; version&quot;;
//                    sql_R +=&quot;,(SELECT INSID FROM &quot;+ artid_0 +&quot;_INS WHERE ITEM62 != &apos;null&apos; and ITEM62=A.ITEM62 &quot; + getQuery_MECN()+&quot;) mecn_v2_insid&quot;					
//                    sql_R +=&quot;,&apos;&apos; mecn_v3_insid &quot;;					
//				    sql_R +=&quot; FROM &quot;+ artid +&quot;_INS A , &quot;+ artid +&quot;ITEM28 B &quot;;
//					sql_R +=&quot;WHERE ITEM62 != &apos;null&apos; &quot;;
//                    sql_R +=&quot; AND B.ITEM3 in (&apos;不同意&apos;,&apos;駁回&apos;) &quot;;		
//                    sql_R += &quot;AND A.INSID  = B.INSID &quot;;						
//					sql_R += getQuery_MECN();		
//					sql_R += &quot;ORDER BY 13,5 desc &quot;;
//			  		
//				var vec2 = Client.SQLloadValue(sql_R);
//				Client.setLocalObject(&quot;vec2&quot;,vec2);


			}catch(e){
				java.lang.System.out.println(&quot;MECN_error=&quot;+e);	
			}	

	}
	
}//function MECN_Search_check()

//  loadLibrary(&quot;com.gce.PLM.Common.Client.PDM_List&quot;);
//  count_showTable_1(&quot;vec1&quot;);
//  var vec = Client.getLocalObject(vec);  
//	    showTable_New_1(1,&quot;vec&quot;);  
		
//===================================================================
//  MECN共用條件的SQL SEARCH Report List
//  三階段MECN 使用
//===================================================================
function showTable_New_1(P,vec){	
	var vec = Client.getLocalObject(vec);
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var table_a = Form.getComponent(&quot;Table_A&quot;);
	var table_b = Form.getComponent(&quot;Table_B&quot;);	
	var table_c = Form.getComponent(&quot;Table_C&quot;);	
	var table_d = Form.getComponent(&quot;Table_D&quot;);		
	
	table_a.clear();
	table_b.clear();
	table_c.clear();
	table_d.clear();
	
	var row = 0;
	
	if (vec.size()&gt;0) {
		for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);	
			
			if(hm.get(&quot;mecn_v3_insid&quot;)!=&quot;&quot;){
			   var task = getTaskByInsID(hm.get(&quot;mecn_v3_insid&quot;));
			   var mecn_level =&quot;MECN第三階段&quot;;
			}else if(hm.get(&quot;mecn_v2_insid&quot;)!=&quot;&quot;){
			   var task = getTaskByInsID(hm.get(&quot;mecn_v2_insid&quot;));
			   var mecn_level =&quot;MECN第二階段&quot;;			   
			}else{
			   var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			   var mecn_level =&quot;MECN第一階段&quot;;			   
			}	
//=======================================================================
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					if(processname == &quot;DE主管作廢審核&quot; || processname == &quot;提出單位最高主管&quot;){
					    if( hm.get(&quot;ITEM115&quot;)==&quot;&quot;){						
					     processname += &quot;【作廢】&quot;;
					   }else{
					     processname = &quot;作廢&quot;;
					  }
					}else{  	
					 if( hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){
					   processname = &quot;作廢&quot;;
					  } 
					}
//					Form.showMessageDialog(processname);
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}			
				if(processname == &quot;MECN第一階段(申請)審核通過通知&quot; || processname == &quot;[會簽-彙整步驟] MECN第一階段(申請)審核通過通知&quot;){
				   processname = &quot;第一階段結束&quot;;
				}else if(processname == &quot;MECN第二階段(申請)審核通過通知&quot;){
				   processname = &quot;第二階段結束&quot;;
				}   	
// ------------------------------------------------------------------------				
				var vMemList = getUnsignMemName(task); // 加會簽
					if(&quot;&quot;==vMemList){
						vMemList = getUnsignMemNameExt(task);
						}
// -------------------------------------------------------------------------						
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
			}	
//===============================================================================================			
			if( &quot;false&quot; == hm.get(&quot;ITEM155&quot;) || &quot;true&quot; == hm.get(&quot;ITEM155&quot;) ){

				if(&quot;&quot;==vMemList){
                     var processuser = 	memberRecord.getName();						
				}else{
                     var processuser = 	vMemList ;				
				}
				
			    if(asign_member(task)==&quot;&quot;){	
                      var processuser = memberRecord.getName();					
				   	if(&quot;&quot;!=vMemList){	
                       var processuser = vMemList ;	 					
				    }
			    }else{
					var processuser = asign_member(task);
			    }
				
			    if (processname == &quot;已結案&quot; || processname == &quot;第一階段結束&quot; || processname == &quot;第二階段結束&quot; ||hm.get(&quot;ITEM115&quot;)!=&quot;&quot;){
					var processuser = &quot;&quot;;
			    }else if (processname == &quot;申請人&quot;){
					var processuser = hm.get(&quot;ITEM318&quot;);
				}
			 
			  //1.申請件數(2+3+4):
//			 if(hm.get(&quot;ITEM155&quot;) == &quot;true&quot;){				  
  			  var row_a = table_a.newRow()-1;					  
			  table_a.setValueAt((i + 1) + &quot;&quot;,           row_a , &quot;序&quot;);
			  table_a.setValueAt(mecn_level,             row_a , &quot;目前階段&quot;);				  
			  table_a.setValueAt(processname,            row_a , &quot;目前關卡&quot;);	
			  table_a.setValueAt(processuser,            row_a , &quot;目前處理者&quot;);			  
			  table_a.setValueAt(hm.get(&quot;ITEM62&quot;),       row_a , &quot;文件編號&quot;);			
			  table_a.setValueAt(hm.get(&quot;ITEM325&quot;), 	 row_a , &quot;部門&quot;);
			  table_a.setValueAt(hm.get(&quot;ITEM318&quot;),  	 row_a , &quot;申請人姓名&quot;);
			  table_a.setValueAt(hm.get(&quot;ITEM12&quot;),   	 row_a , &quot;填寫日期&quot;);			
			  table_a.setValueAt(hm.get(&quot;ITEM200&quot;),      row_a , &quot;文件標題&quot;);
			  table_a.setValueAt(hm.get(&quot;ITEM66&quot;),  	 row_a , &quot;文件類別&quot;);			
			  table_a.setValueAt(hm.get(&quot;INSID&quot;),   	 row_a , &quot;InsID&quot;);
			  table_a.setValueAt(hm.get(&quot;mecn_v2_insid&quot;),row_a , &quot;InsID2&quot;);
			  table_a.setValueAt(hm.get(&quot;mecn_v3_insid&quot;),row_a , &quot;InsID3&quot;);		
			  table_a.setValueAt(hm.get(&quot;version&quot;),row_a , &quot;version&quot;);					  
//			  }
//			  //4.作廢:	
			 if(hm.get(&quot;ITEM155&quot;) == &quot;true&quot;){			  	
              var row_d = table_d.newRow()-1;					  				 
			  table_d.setValueAt(row_d+1 + &quot;&quot;,             row_d , &quot;序&quot;);
			  table_d.setValueAt(mecn_level,             row_d , &quot;目前階段&quot;);				  
			  table_d.setValueAt(processname,            row_d , &quot;目前關卡&quot;);	
			  table_d.setValueAt(processuser,            row_d , &quot;目前處理者&quot;);			  
			  table_d.setValueAt(hm.get(&quot;ITEM62&quot;),       row_d , &quot;文件編號&quot;);			
			  table_d.setValueAt(hm.get(&quot;ITEM325&quot;), 	 row_d , &quot;部門&quot;);
			  table_d.setValueAt(hm.get(&quot;ITEM318&quot;),  	 row_d , &quot;申請人姓名&quot;);
			  table_d.setValueAt(hm.get(&quot;ITEM12&quot;),   	 row_d , &quot;填寫日期&quot;);			
			  table_d.setValueAt(hm.get(&quot;ITEM200&quot;),      row_d , &quot;文件標題&quot;);
			  table_d.setValueAt(hm.get(&quot;ITEM66&quot;),  	 row_d , &quot;文件類別&quot;);			
			  table_d.setValueAt(hm.get(&quot;INSID&quot;),   	 row_d , &quot;InsID&quot;);
			  table_d.setValueAt(hm.get(&quot;mecn_v2_insid&quot;),row_d , &quot;InsID2&quot;);
			  table_d.setValueAt(hm.get(&quot;mecn_v3_insid&quot;),row_d , &quot;InsID3&quot;);		
			  table_d.setValueAt(hm.get(&quot;version&quot;),row_d , &quot;version&quot;);					  
//			  //2.已結案:
			 }else if(processname ==&quot;已結案&quot;){
              var row_b = table_b.newRow()-1;					 
	          table_b.setValueAt(row_b+1 + &quot;&quot;,           row_b , &quot;序&quot;);
			  table_b.setValueAt(mecn_level,             row_b , &quot;目前階段&quot;);				  
			  table_b.setValueAt(processname,            row_b , &quot;目前關卡&quot;);	
			  table_b.setValueAt(processuser,            row_b , &quot;目前處理者&quot;);			  
			  table_b.setValueAt(hm.get(&quot;ITEM62&quot;),       row_b , &quot;文件編號&quot;);			
			  table_b.setValueAt(hm.get(&quot;ITEM325&quot;), 	 row_b , &quot;部門&quot;);
			  table_b.setValueAt(hm.get(&quot;ITEM318&quot;),  	 row_b , &quot;申請人姓名&quot;);
			  table_b.setValueAt(hm.get(&quot;ITEM12&quot;),   	 row_b , &quot;填寫日期&quot;);			
			  table_b.setValueAt(hm.get(&quot;ITEM200&quot;),      row_b , &quot;文件標題&quot;);
			  table_b.setValueAt(hm.get(&quot;ITEM66&quot;),  	 row_b , &quot;文件類別&quot;);			
			  table_b.setValueAt(hm.get(&quot;INSID&quot;),   	 row_b , &quot;InsID&quot;);
			  table_b.setValueAt(hm.get(&quot;mecn_v2_insid&quot;),row_b , &quot;InsID2&quot;);
			  table_b.setValueAt(hm.get(&quot;mecn_v3_insid&quot;),row_b , &quot;InsID3&quot;);	
			  table_b.setValueAt(hm.get(&quot;version&quot;),row_b , &quot;version&quot;);				  
			  //3.未結案:				 
			 }else{
  			  var row_c= table_c.newRow()-1;						 
			  table_c.setValueAt(row_c+1 + &quot;&quot;,           row_c , &quot;序&quot;);
			  table_c.setValueAt(mecn_level,             row_c , &quot;目前階段&quot;);				  
			  table_c.setValueAt(processname,            row_c , &quot;目前關卡&quot;);	
			  table_c.setValueAt(processuser,            row_c , &quot;目前處理者&quot;);			  
			  table_c.setValueAt(hm.get(&quot;ITEM62&quot;),       row_c , &quot;文件編號&quot;);			
			  table_c.setValueAt(hm.get(&quot;ITEM325&quot;), 	 row_c , &quot;部門&quot;);
			  table_c.setValueAt(hm.get(&quot;ITEM318&quot;),  	 row_c , &quot;申請人姓名&quot;);
			  table_c.setValueAt(hm.get(&quot;ITEM12&quot;),   	 row_c , &quot;填寫日期&quot;);			
			  table_c.setValueAt(hm.get(&quot;ITEM200&quot;),      row_c , &quot;文件標題&quot;);
			  table_c.setValueAt(hm.get(&quot;ITEM66&quot;),  	 row_c , &quot;文件類別&quot;);			
			  table_c.setValueAt(hm.get(&quot;INSID&quot;),   	 row_c , &quot;InsID&quot;);
			  table_c.setValueAt(hm.get(&quot;mecn_v2_insid&quot;),row_c , &quot;InsID2&quot;);
			  table_c.setValueAt(hm.get(&quot;mecn_v3_insid&quot;),row_c , &quot;InsID3&quot;);			
			  table_c.setValueAt(hm.get(&quot;version&quot;),row_c , &quot;version&quot;);					  
			 }  

			}
			}catch(e){}
		}
		
		Form.setValue(&quot;apply_count&quot;,table_a.getRowCount()+&quot;&quot;);
		Form.setValue(&quot;finish_count&quot;,table_b.getRowCount()+&quot;&quot;);
		Form.setValue(&quot;unfinishe_count&quot;,table_c.getRowCount()+&quot;&quot;);
		Form.setValue(&quot;cancel_count&quot;,table_d.getRowCount()+&quot;&quot;);		
		
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}	

function getManagerChk(s1){
	//1 申請單v5
	//2 實驗結果v5
	//3 核准單v5
	//4 其它
	var temp = &quot;&quot;;
	var Artifact = Form.getValue(&quot;Artifact&quot;);
	//Client.addDebugLog(&quot;######&quot;+(Form.getValue(&quot;manager&quot;).equals(&quot;true&quot;)));
	if(Form.getValue(&quot;manager&quot;).equals(&quot;true&quot;)){
		if(Artifact==&quot;MECN申請單&quot; &amp;&amp; s1==&quot;1&quot;){
			temp = &quot; and item216=&apos;true&apos; &quot;;
		}else if(Artifact==&quot;MECN實驗結果&quot; &amp;&amp; s1==&quot;1&quot;){
			temp = &quot; and item188=&apos;true&apos; &quot;;
		}else if(Artifact==&quot;MECN核准單&quot; &amp;&amp; s1==&quot;1&quot;){
			temp = &quot; and item298=&apos;true&apos; &quot;;
		}else if(s1==&quot;2&quot;){
			temp = &quot; and 1=2 &quot;;
		}else{
		}
	}
	
	return temp;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00081250573085426</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/06/08 14:41:42</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PH.OA_APPLY</string> 
     </void> 
     <void property="id"> 
      <string>SCL00081250573085426</string> 
     </void> 
     <void property="name"> 
      <string>OA_APPLY</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00321216878882287</string> 
     </void> 
     <void property="scriptSource"> 
      <string>	
//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				var memName = memberRecord.getName();		
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;
					memName = &quot;--&quot;;
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
					memName = &quot;--&quot;					
				}
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);
				table.setValueAt( memName,  row, &quot;目前處理者&quot;);
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);

			table.setValueAt(hm.get(&quot;ITEM12&quot;).substring(0,10),    	row, &quot;開單日期&quot;);
			
			if(hm.get(&quot;ITEM115&quot;).length()&gt;1){
				var fm_closedate = hm.get(&quot;ITEM115&quot;).substring(0,10);
			}else{
				var fm_closedate = &quot;--&quot;;
			}
			
			table.setValueAt(fm_closedate,    	row, &quot;結案日期&quot;);	
//			table.setValueAt(hm.get(&quot;ITEM138&quot;),    	row, &quot;PR No.&quot;);
//			var epono = &quot;未取得&quot;;
//			var sqls = &quot;SELECT TGC_UPI_PO_PKG.TG_OA_GET_EPO_NO(30,&apos;&quot;+hm.get(&quot;ITEM138&quot;)+&quot;&apos;) EPO_NO FROM DUAL &quot;
//			var rs = Client.SQLloadValue(sqls);
//			try{
//				if(!&quot;&quot;.equals(rs.get(0).get(&quot;EPO_NO&quot;))){
//					epono = &quot;PO_NO=&quot;+rs.get(0).get(&quot;EPO_NO&quot;);
//					epono.replace(&quot;PO_NO=&quot;,&quot;No:&quot;);
//					epono.replace(&quot;#&quot;,&quot;\n&quot;);
//					}
//			}
//			catch(e){
//
//			}


			table.setValueAt(hm.get(&quot;ITEM144&quot;),    	row, &quot;填單人&quot;);
			table.setValueAt(hm.get(&quot;ITEM180&quot;),    	row, &quot;請領部門&quot;);
			table.setValueAt(hm.get(&quot;ITEM138&quot;),    	row, &quot;請領單號&quot;);
			table.setValueAt(hm.get(&quot;ITEM26&quot;), 	row, &quot;年度&quot;);
			table.setValueAt(hm.get(&quot;ITEM32&quot;), 	row, &quot;月份&quot;);
			table.setValueAt(hm.get(&quot;ITEM18&quot;), 	row, &quot;文具金額&quot;);
			table.setValueAt(hm.get(&quot;ITEM49&quot;), 	row, &quot;耗材金額&quot;);
			table.setValueAt(hm.get(&quot;ITEM61&quot;), 	row, &quot;用紙金額&quot;);
			table.setValueAt(hm.get(&quot;INSID&quot;),  	row, &quot;InsID&quot;);
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	// 起始日期

	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
			else if(&quot;依採購收件日&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM147||&apos; 00:00&apos; &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;				
				}
			else{
					sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
		}
	}
	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;					
				}
			else if(&quot;依採購收件日&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM147||&apos; 00:00&apos; &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;			
			}
				else{
					sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}			
		}
	}
				var Status = Form.getValue(&quot;Status&quot;);	 
				if (!&quot;全部&quot;.equals(Status)) {
						if (&quot;已結案&quot;.equals(Status)) {
							sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM115 is not null &quot;;
						}else if (&quot;未結案&quot;.equals(Status)){
							sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
						}				
				}	
	// 文件編號
	var Doc_Sn = Form.getValue(&quot;Sn&quot;).toUpperCase();

	if (!&quot;&quot;.equals(Doc_Sn)) {
		sSQL += &quot; AND ITEM138 like &apos;%&quot; + Doc_Sn + &quot;%&apos;&quot;;
	}	
	
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM144 like &apos;%&quot; + MemName + &quot;%&apos;&quot;;
	}	
	var appname = Form.getValue(&quot;appname&quot;);	
	if (!&quot;&quot;.equals(appname)) {
		sSQL += &quot; AND ITEM24 like &apos;%&quot; + appname + &quot;%&apos;&quot;;
	}	

	// byappdept	
	var byappdept = Form.getValue(&quot;byappdept&quot;);	
	if (!&quot;&quot;.equals(byappdept)) {
		sSQL += &quot; AND ITEM186 like &apos;%&quot; + byappdept + &quot;%&apos;&quot;;
	}	

	return sSQL;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00081345181797965</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2015/10/20 12:03:01</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Server.HR_RP</string> 
     </void> 
     <void property="id"> 
      <string>SCL00081345181797965</string> 
     </void> 
     <void property="name"> 
      <string>HR_RP</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011227091263550</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//*************************************************************	
//檢查獎懲記錄是否寫入嘉揚系統
//*************************************************************
function CHK_HR_RP(v_factory){ 	
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	var req_user_ID = dataMap.get(&quot;User_ID&quot;);
	var vHR_No = dataMap.get(&quot;HR_No&quot;);
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;HR&quot;);
	var conn = Server.createSessionConnection(conn_name);
	try{
		var flag = true;
		var sql = &quot;select badge from erewpun where badge=&apos;&quot;+req_user_ID+&quot;&apos; and remark=&apos;&quot;+vHR_No+&quot;&apos;;&quot;;
		var vec = conn.loadValue(sql);
		if(vec==null || vec.size()==0){
			flag = false;
		}
		return flag;
	}catch(e){
	}finally{
		conn.close();	
	}
}

//*************************************************************	
//回寫獎懲記錄至HR
//*************************************************************
function INS_HR_RP(v_factory){ 	
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	var req_user_ID = dataMap.get(&quot;User_ID&quot;);
	var v_user_Name = dataMap.get(&quot;User_Name&quot;);	
	var req_chkType = dataMap.get(&quot;ChkType1&quot;);
	var vHR_No = dataMap.get(&quot;HR_No&quot;); 				
		if (v_user_Name.indexOf(&apos;(&apos;)&gt;0){
			var req_user_Name = v_user_Name.substring(0,v_user_Name.indexOf(&quot;(&quot;));		
		}else{
			var req_user_Name =dataMap.get(&quot;User_Name&quot;);
		} 
		var req_user_Dep_ID = dataMap.get(&quot;User_Dep_ID&quot;);		
        if (dataMap.get(&quot;Rorp&quot;)==&quot;1&quot;){
			 var req_rorp=&quot;獎&quot;;	
		}else{
			var req_rorp=&quot;懲&quot;;	
		}		
		if(req_chkType==&quot;解雇&quot;){
      		var req_rpmethod=&quot;公告&quot;;
		}else{
			var req_rpmethod=&quot;現金、公告&quot;;  
		}			
	   //*************************************************************	  
	   //Inser HR RP
       //*************************************************************	
		var req_rpamount = 0;
		if(dataMap.get(&quot;Rpamount1&quot;)!=&quot;&quot;){
			req_rpamount = java.lang.Integer.parseInt(dataMap.get(&quot;Rpamount1&quot;));
		}
		 
        var mydate = new Packages.pase.agenda.MyDate();
        var req_create_Date=mydate.getCurrentDate(&quot;Y/M/D H:M&quot;)
		var req_ftextArea0=dataMap.get(&quot;FTextArea0&quot;);		
		var req_rpdesc=dataMap.get(&quot;Rpdesc1&quot;);		
		if (dataMap.get(&quot;FTextArea5&quot;)== &quot;&quot;){
            var req_rpdesc1=dataMap.get(&quot;FTextArea4&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;);
		}else{
			var req_rpdesc1=dataMap.get(&quot;FTextArea5&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;);
		} 		
		var req_flag=&apos;1&apos;;
		loadLibrary(&quot;com.gce.Common.Util&quot;);
		var conn_name = conn_db(v_factory,&quot;HR&quot;);
		var conn = Server.createSessionConnection(conn_name);
	  try{
		  var delSql = &quot;delete from erewpun where remark=&apos;&quot;+vHR_No+&quot;&apos; and badge=&apos;&quot;+req_user_ID+&quot;&apos;;&quot;;
		  var rs = conn.updateValue(delSql);		  
		  if(rs==true){
			  conn.commit();
			  var upsql = &quot;Insert Into erewpun(badge,     name,                depid,           rorp,             rptype,               rpmethod,      rpamount,        rpdate,              remark,  flagexecrp,           evidence,       evidence_desc) Values (&quot;;
			     upsql +=&quot;&apos;&quot;+req_user_ID+&quot;&apos;,&apos;&quot;+req_user_Name+&quot;&apos;,&apos;&quot;+req_user_Dep_ID+&quot;&apos;,&apos;&quot;+req_rorp+&quot;&apos;,&apos;&quot;+req_chkType+&quot;&apos;,&apos;&quot;+req_rpmethod+&quot;&apos;,&quot;+req_rpamount+&quot;,&apos;&quot;+req_create_Date+&quot;&apos;,&apos;&quot;+ vHR_No +&quot;&apos;,&apos;&quot;+ req_flag +&quot;&apos;,&apos;&quot;+ req_rpdesc+&quot;&apos;,&apos;&quot;+ req_rpdesc1 +&quot;&apos;);&quot;;
				 Server.addDebugLog(&quot;Server1 insert erewpun sql==&quot;+upsql);				 
				 var result = conn.updateValue(upsql);
				 if(true==result){
					 conn.commit();			    										
				 }else{
					 conn.rollback();				
				 }
		 }else{			  
			  conn.rollback();
		  }
 	  }catch(e){
		  Server.addDebugLog(&quot;Server-新增至HR獎懲Table(erewpun)失敗:&quot;+upsql);
		  
	  }finally{
		  conn.close();		  
	  }
   }//function INS_HR_RP() End  ================================================================================

   
   //*************************************************************	
//檢查獎懲記錄是否寫入嘉揚系統
//*************************************************************
function CHK_HR_RP_new(v_factory){ 	
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	var req_user_ID = dataMap.get(&quot;User_ID&quot;);
	var vHR_No = dataMap.get(&quot;HR_No&quot;);
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);
	var conn = Server.createSessionConnection(conn_name);
	try{
		var flag = true;
		var sql = &quot;select empno from empm170 where empno=&apos;&quot;+req_user_ID+&quot;&apos; and Hr_no=&apos;&quot;+vHR_No+&quot;&apos;;&quot;;
		var vec = conn.loadValue(sql);
		if(vec==null || vec.size()==0){
			flag = false;
		}
		return flag;
	}catch(e){
	}finally{
		conn.close();
	}
}

//*************************************************************	
//回寫獎懲記錄至HR
//*************************************************************
function INS_HR_RP_new(v_factory){ 	
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	var req_user_ID = dataMap.get(&quot;User_ID&quot;);
	var v_user_Name = dataMap.get(&quot;User_Name&quot;);	
	var req_chkType = dataMap.get(&quot;ChkType1&quot;);
	var vHR_No = dataMap.get(&quot;HR_No&quot;); 				
		if (v_user_Name.indexOf(&apos;(&apos;)&gt;0){
			var req_user_Name = v_user_Name.substring(0,v_user_Name.indexOf(&quot;(&quot;));		
		}else{
			var req_user_Name =dataMap.get(&quot;User_Name&quot;);
		} 
		var req_user_Dep_ID = dataMap.get(&quot;User_Dep_ID&quot;);		
		if(req_chkType==&quot;解雇&quot;){
      		var req_rpmethod=&quot;公告&quot;;
		}else{
			var req_rpmethod=&quot;現金、公告&quot;;  
		}
		var req_chkType1;
		var req_score = 0;
		if(req_chkType==&quot;解雇&quot;){
			req_chkType1 = &quot;DE&quot;
		}else if (req_chkType==&quot;記大過&quot;){
			req_chkType1 = &quot;LB&quot;
			req_score = -9;
		}else if (req_chkType==&quot;記過&quot;){
			req_chkType1 = &quot;MB&quot;
			req_score = -3;
		}else if (req_chkType==&quot;警告&quot;){
			req_chkType1 = &quot;SB&quot;
			req_score = -1;
		}else if (req_chkType==&quot;記大功&quot;){
			req_chkType1 = &quot;LG&quot;
			req_score = 9;
		}else if(req_chkType==&quot;記功&quot;){
			req_chkType1 = &quot;MG&quot;
			req_score = 3;
		}else if (req_chkType==&quot;嘉獎&quot;){
			req_chkType1 = &quot;SG&quot;
			req_score = 1;
		}else if (req_chkType==&quot;獎狀或獎金（品）&quot;){
			req_chkType1 = &quot;AA&quot;
		}		
		var req_rpamount = 0;
		if(dataMap.get(&quot;Rpamount1&quot;)!=&quot;&quot;){
			req_rpamount = java.lang.Integer.parseInt(dataMap.get(&quot;Rpamount1&quot;));
		}		 
        var mydate = new Packages.pase.agenda.MyDate();
        var req_create_Date=mydate.getCurrentDate(&quot;Y/M/D H:M&quot;);
		var req_ftextArea0=dataMap.get(&quot;FTextArea0&quot;);
		var req_rpdesc=dataMap.get(&quot;Rpdesc1&quot;);
		if (dataMap.get(&quot;FTextArea5&quot;)== &quot;&quot;){
            var req_rpdesc1=dataMap.get(&quot;FTextArea4&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;).replaceAll(&quot;\r\n&quot;,&quot;&quot;);
			
		}else{
			var req_rpdesc1=dataMap.get(&quot;FTextArea5&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;).replaceAll(&quot;\r\n&quot;,&quot;&quot;);
		}
		var req_flag=&apos;1&apos;;
		loadLibrary(&quot;com.gce.Common.Util&quot;);
		var conn_name = conn_db(v_factory,&quot;MES&quot;);
		var conn = Server.createSessionConnection(conn_name);
	  try{
		  var delSql = &quot;delete from empm170 where Hr_no = &apos;&quot;+vHR_No+&quot;&apos; and empno = &apos;&quot;+req_user_ID+&quot;&apos;;&quot;;
		  var rs = conn.updateValue(delSql);		  
		  if(rs == true){
			  conn.commit();
			  var upsql = &quot;Insert Into empm170(empno,dptno,sbcode,sbcnt,score,sbmethod,Sbamount,sbdate,Hr_no,sbevidence,sbreason,ins_user,ins_dtime,Userno,chgdate) Values (&quot;;
			     upsql +=&quot;&apos;&quot;+req_user_ID+&quot;&apos;,&apos;&quot;+req_user_Dep_ID+&quot;&apos;,&apos;&quot;+req_chkType1+&quot;&apos;,1,&quot;+req_score+&quot;,&apos;&quot;+req_rpmethod+&quot;&apos;,&quot;+req_rpamount+&quot;,to_date(&apos;&quot;+req_create_Date+&quot;&apos;,&apos;%Y/%m/%d %H:%M&apos;),&apos;&quot;+ vHR_No +&quot;&apos;,&apos;&quot;+ req_rpdesc+&quot;&apos;,&apos;&quot;+ req_rpdesc1 +&quot;&apos;,&apos;AUTO&apos;,current,&apos;AUTO&apos;,current);&quot;;
				 Server.addDebugLog(&quot;Server1 insert empm170 sql==&quot;+upsql);				 
				 var result = conn.updateValue(upsql);
				 if(true==result){
					 conn.commit();			    										
				 }else{
					 conn.rollback();				
				 }
		 }else{			  
			  conn.rollback();
		  }
 	  }catch(e){
		  Server.addDebugLog(&quot;Server-新增至HR獎懲Table(empm170)失敗:&quot;+upsql);
		  
	  }finally{
		  conn.close();		  
	  }
   }//function INS_HR_RP() End  ================================================================================
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00091157866682468</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/09/10 13:38:02</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ECN.Client</string> 
     </void> 
     <void property="id"> 
      <string>SCL00091157866682468</string> 
     </void> 
     <void property="name"> 
      <string>Client</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031157709081640</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
function reloadTable_Copy_ECN(){
    var parentForm = Form.getParentForm();  //取得母表單
	var artState = &quot;ECN&quot;;
	if(parentForm != null){
		artState = parentForm.getValue(&quot;ECN_Copy&quot;);	
	}

	Form.setValue(&quot;ERP_Art_ID&quot;,artState);
	var date_start = Form.getValue(&quot;Date_Start&quot;);
	var date_end = Form.getValue(&quot;Date_End&quot;);	
	var sql = &quot;&quot;;
	if(artState == &quot;ECR&quot; ||  artState == &quot;ECR TO ECN&quot;){	
		Form.setValue(&quot;ERP_Art_ID&quot;,artState);
		//ART00011154532228237
		//sql = &quot; select item156 單號, item141 申請時間 ,item66 申請人,item57 產品型號,InsID from ART00011154532228237_Ins where item141 &gt;= &apos;&quot;+ date_start +&quot; 00:00&apos; and item141 &lt;= &apos;&quot;+ date_end +&quot; 23:59&apos; and item156 !=&apos;&quot;+ parentForm.getValue(&quot;ECR_No&quot;) +&quot;&apos;  ORDER BY  ITEM141 desc&quot;;		
		sql = &quot; select item156 單號, item141 申請時間 ,item66 申請人,item57 產品型號,InsID from ART00011154532228237_Ins where item141 &gt;= &apos;&quot;+ date_start +&quot; 00:00&apos; and item141 &lt;= &apos;&quot;+ date_end +&quot; 23:59&apos; and item156 !=&apos;&quot;+ parentForm.getValue(&quot;PCR_No&quot;) +&quot;&apos; &quot;;		
		if (Form.getValue(&quot;No&quot;) !=&quot;&quot;){sql = sql + &quot; and item156 =&apos;&quot; + Form.getValue(&quot;No&quot;) + &quot;&apos;&quot; ;}//單號
		if (Form.getValue(&quot;App_ID&quot;) != &quot;&quot;){sql = sql + &quot; and item45 =&apos;&quot; + Form.getValue(&quot;App_ID&quot;) + &quot;&apos;&quot; ;}//申請人工號
		if (Form.getValue(&quot;Item_Type_No&quot;) != &quot;&quot;){sql = sql + &quot; and item57 LIKE &apos;%&quot; + Form.getValue(&quot;Item_Type_No&quot;) + &quot;%&apos;&quot; ;}//型號
		//if (Form.getValue(&quot;Customer_ID&quot;) != &quot;&quot;){sql = sql + &quot; and item123 =&apos;&quot; + Form.getValue(&quot;Customer_ID&quot;) + &quot;&apos;&quot; ;}//客戶編號
		Form.getComponent(&quot;FLabel4&quot;).setVisible(false);
		Form.getComponent(&quot;ECN_Handle_ID&quot;).setVisible(false);
		Form.getComponent(&quot;ECN_Handle_Name&quot;).setVisible(false);
		Form.getComponent(&quot;FImageLabel1&quot;).setVisible(false);
		Form.getComponent(&quot;FImageLabel3&quot;).setVisible(false);
		Form.getComponent(&quot;FLabel42&quot;).setVisible(false);
		Form.getComponent(&quot;FLabel42&quot;).setVisible(false);
		Form.getComponent(&quot;Customer_ID&quot;).setVisible(false);
		Form.getComponent(&quot;FButton3&quot;).setVisible(false);
		Form.getComponent(&quot;Customer_Name&quot;).setVisible(false);
		if (Form.getValue(&quot;CloseItem&quot;) == &quot;true&quot;){sql = sql + &quot; and item115 &lt;&gt;&apos;&apos;&quot; ;}//是否找已完單
		sql = sql + &quot; ORDER BY  ITEM141 desc&quot;;
		
		
	}else if(artState == &quot;PCR&quot; || artState == &quot;PCR TO ECN&quot;) {
		Form.setValue(&quot;ERP_Art_ID&quot;,artState);
		//ART00001154532228237
		//sql = &quot; select item156 單號, item141 申請時間 ,item96 申請人,item200 產品型號,InsID from ART00001154532228237_Ins where item141 &gt;= &apos;&quot;+ date_start +&quot; 00:00&apos; and item141 &lt;= &apos;&quot;+ date_end +&quot; 23:59&apos; and item156 !=&apos;&quot;+ parentForm.getValue(&quot;PCR_No&quot;) +&quot;&apos;  ORDER BY  ITEM141 desc&quot;;		
		sql = &quot; select item156 單號, item141 申請時間 ,item88 申請人,item200 產品型號,InsID from ART00001154532228237_Ins where item141 &gt;= &apos;&quot;+ date_start +&quot; 00:00&apos; and item141 &lt;= &apos;&quot;+ date_end +&quot; 23:59&apos; and item156 !=&apos;&quot;+ parentForm.getValue(&quot;PCR_No&quot;) +&quot;&apos; &quot;;		
		if (Form.getValue(&quot;No&quot;) != &quot;&quot;){sql = sql + &quot; and item156 =&apos;&quot; + Form.getValue(&quot;No&quot;) + &quot;&apos;&quot; ;}//單號
		if (Form.getValue(&quot;App_ID&quot;) != &quot;&quot;){sql = sql + &quot; and item96 =&apos;&quot; + Form.getValue(&quot;App_ID&quot;) + &quot;&apos;&quot; ;}//申請人工號
		if (Form.getValue(&quot;Item_Type_No&quot;) != &quot;&quot;){sql = sql + &quot; and item200 LIKE &apos;%&quot; + Form.getValue(&quot;Item_Type_No&quot;) + &quot;%&apos;&quot; ;}//型號
		if (Form.getValue(&quot;Customer_ID&quot;) != &quot;&quot;){sql = sql + &quot; and item123 =&apos;&quot; + Form.getValue(&quot;Customer_ID&quot;) + &quot;&apos;&quot; ;}//客戶編號
		if (Form.getValue(&quot;ECN_Handle_ID&quot;) != &quot;&quot;){sql = sql + &quot; and item114 =&apos;&quot; + Form.getValue(&quot;ECN_Handle_ID&quot;) + &quot;&apos;&quot; ;}//ECN處理人
		if (Form.getValue(&quot;CloseItem&quot;) == &quot;true&quot;){sql = sql + &quot; and item115 &lt;&gt;&apos;&apos;&quot; ;}//是否找已完單
		sql = sql + &quot; ORDER BY  ITEM141 desc&quot;;
		
		
	}else if(artState == &quot;ECN&quot;) {
		Form.setValue(&quot;ERP_Art_ID&quot;,&quot;ECN&quot;);
	//ECN ART00021154532228237
		//sql = &quot; select item176 單號, item141 申請時間 ,item66 申請人,item56 產品型號,InsID from ART00021154532228237_Ins where item141 &gt;= &apos;&quot;+ date_start +&quot; 00:00&apos; and item141 &lt;= &apos;&quot;+ date_end +&quot; 23:59&apos; and item176 !=&apos;&quot;+ parentForm.getValue(&quot;ECN_No&quot;) +&quot;&apos;  ORDER BY  ITEM141 desc &quot;;
		sql = &quot; select item176 單號, item141 申請時間 ,item66 申請人,item56 產品型號,InsID from ART00021154532228237_Ins where item141 &gt;= &apos;&quot;+ date_start +&quot; 00:00&apos; and item141 &lt;= &apos;&quot;+ date_end +&quot; 23:59&apos; and item156 !=&apos;&quot;+ parentForm.getValue(&quot;PCR_No&quot;) +&quot;&apos; &quot;;		
		if (Form.getValue(&quot;No&quot;) != &quot;&quot;){sql = sql + &quot; and item176 =&apos;&quot; + Form.getValue(&quot;No&quot;) + &quot;&apos;&quot; ;}//單號
		if (Form.getValue(&quot;App_ID&quot;) != &quot;&quot;){sql = sql + &quot; and item52 =&apos;&quot; + Form.getValue(&quot;App_ID&quot;) + &quot;&apos;&quot; ;}//申請人工號
		if (Form.getValue(&quot;Item_Type_No&quot;) != &quot;&quot;){sql = sql + &quot; and item56 LIKE &apos;%&quot; + Form.getValue(&quot;Item_Type_No&quot;) + &quot;%&apos;&quot; ;}//型號
		//if (Form.getValue(&quot;Customer_ID&quot;) != &quot;&quot;){sql = sql + &quot; and item123 =&apos;&quot; + Form.getValue(&quot;Customer_ID&quot;) + &quot;&apos;&quot; ;}//客戶編號
		Form.getComponent(&quot;FLabel4&quot;).setVisible(false);
		Form.getComponent(&quot;ECN_Handle_ID&quot;).setVisible(false);
		Form.getComponent(&quot;ECN_Handle_Name&quot;).setVisible(false);
		Form.getComponent(&quot;FImageLabel1&quot;).setVisible(false);
		Form.getComponent(&quot;FImageLabel3&quot;).setVisible(false);
		Form.getComponent(&quot;FLabel42&quot;).setVisible(false);
		Form.getComponent(&quot;FLabel42&quot;).setVisible(false);
		Form.getComponent(&quot;Customer_ID&quot;).setVisible(false);
		Form.getComponent(&quot;FButton3&quot;).setVisible(false);
		Form.getComponent(&quot;Customer_Name&quot;).setVisible(false);
		
		if (Form.getValue(&quot;CloseItem&quot;) == &quot;true&quot;){sql = sql + &quot; and item115 &lt;&gt;&apos;&apos;&quot; ;}//是否找已完單
		sql = sql + &quot; ORDER BY  ITEM141 desc&quot;;

	}
	
	if(&quot;&quot; != sql){
		var vec = Client.SQLloadValue(sql);
	if(vec != null &amp;&amp; vec.size()&gt;0 ){
		var table = Form.getComponent(&quot;TableA&quot;);		
		Form.setValue(&quot;Count&quot;,vec.size());
		for (var i = 0;i&lt; vec.size();i++){
			var ht = vec.get(i);
			var row = table.newRow()-1;
			table.setValueAt(ht.get(&quot;單號&quot;),row,&quot;單號&quot;);
			table.setValueAt(ht.get(&quot;申請時間&quot;),row,&quot;申請時間&quot;);
			table.setValueAt(ht.get(&quot;申請人&quot;),row,&quot;申請人&quot;);
			table.setValueAt(ht.get(&quot;產品型號&quot;),row,&quot;產品型號&quot;);
			table.setValueAt(ht.get(&quot;InsID&quot;),row,&quot;InsID&quot;);			
		}
		
	}
	}
}


function reloadPCR(){
	var sql = &quot; select A_PCR_Change_Item.Type 類別 ,A_PCR_Change_Item.Item 變更項目,A_PCR_Change_Item.Dept 會簽單位,A_PCR_Change_Item.ID 工號,A_PCR_Change_Item.USERNAME 姓名 from A_PCR_Change_Item where A_PCR_Change_Item.Item != &apos;&apos; order by TYPE, item &quot; ;
	var vector = Client.SQLloadValue(sql);

	var table = Form.getComponent(&quot;TableA&quot;);
	table.clear();
	if ( vector != null ){
		Form.setValue(&quot;Count&quot;,vector.size());
	 if (vector.size()&gt;0){

		for(var i=0;i&lt;vector.size();i++)	{
			var ht = vector.get(i);
			var row = table.newRow()-1;
			//var cMember = Client.getMemberByName(ht.get(&quot;loginid&quot;));
			//var roleID = cMember.getMainRoleID();
			//var memDR = cMember.getMemberDR(roleID);
			//var sDepName = &quot;&quot;;
			//if(memDR != null ){
				//sDepName = memDR.getDepartmentName();	//使用者部門名稱
			//}
			//table.setValueAt(sDepName,row,&quot;部門&quot;);
			table.setValueAt(ht.get(&quot;類別&quot;),row,&quot;類別&quot;);
			table.setValueAt(ht.get(&quot;變更項目&quot;),row,&quot;變更項目&quot;);
			table.setValueAt(ht.get(&quot;會簽單位&quot;),row,&quot;會簽單位&quot;);			
			table.setValueAt(ht.get(&quot;工號&quot;),row,&quot;工號&quot;);
			table.setValueAt(ht.get(&quot;姓名&quot;),row,&quot;姓名&quot;);
		}//for

	 }
	}
}


function setPCR_Change_Item_Table(tableName,type){
	var table = Form.getComponent(tableName);
	if(table != null &amp;&amp; table.getColumnNodeVector() != null &amp;&amp; table.getColumnNodeVector().size()&gt;0){
	var columnsHeaderNode = table.getColumnNodeVector().get(0);  // 0代表  第一ColumnHeader欄位 座標
	var colVector = columnsHeaderNode.getColVector();
		colVector.clear();
	var str =&quot; select Item from  A_PCR_Change_Item where type =&apos;&quot;+ type + &quot;&apos;group by Item order by 1&quot;;
	var vector = Client.SQLloadValue(str);
	for (var i=0; i&lt; vector.size(); i++) {
		var result = vector.get(i);
		var item = result.get(&quot;Item&quot;);
		//var usrName = result.get(&quot;UserName&quot;);
    	//var item = Id + &quot;-&quot; + usrName;
    	colVector.add(item);
	}
	}
}

function setChangeTableInfo(tableName,type){
	var table = Form.getComponent(tableName);
	var item = table.getValueAt(table.getLastAccessIndex(),&quot;變更項目&quot;);
	var id = table.getValueAt(table.getLastAccessIndex(),&quot;工號&quot;);
	if (id == &apos;&apos;){
		//要防一抓再抓
		var s_sql =  &quot;SELECT * FROM A_PCR_Change_Item  WHERE item = &apos;&quot;+ item +&quot;&apos; and type = &apos;&quot;+ type +&quot;&apos;&quot;;
		var dataVector = Client.SQLloadValue(s_sql);
		for (var i=0; i&lt; dataVector.size(); i++) {
		if (dataVector != null &amp;&amp; dataVector.size()&gt;0){
			if (i==0){
			table.setValueAt(dataVector.get(0).get(&quot;Dept&quot;),table.getLastAccessIndex(),&quot;會簽單位&quot;);
			table.setValueAt(dataVector.get(0).get(&quot;ID&quot;),table.getLastAccessIndex(),&quot;工號&quot;);
			table.setValueAt(dataVector.get(0).get(&quot;UserName&quot;),table.getLastAccessIndex(),&quot;姓名&quot;);			
			}else{
			var row = table.newRow(); 
			row = row - 1;
			table.setValueAt(item,row,&quot;變更項目&quot;); 
			table.setValueAt(dataVector.get(i).get(&quot;Dept&quot;),row,&quot;會簽單位&quot;); 
			table.setValueAt(dataVector.get(i).get(&quot;ID&quot;),row,&quot;工號&quot;); 
			table.setValueAt(dataVector.get(i).get(&quot;UserName&quot;),row,&quot;姓名&quot;); 
			}
			}
		}	
	}
}

//ERP 影響評估
function loadERP_Effect(){
//for loop parentTable 的 TableA.料號
//先檢查料號存在嗎

try{
	var conn_erp = Client.createSessionConnection(&quot;ERP&quot;);
	var parentform = Form.getParentForm();
	var tableA = Form.getComponent(&quot;TableA&quot;);	
	tableA.clear();	
	if(parentform.getArtifact().getName()==&quot;PCR&quot; &amp;&amp; &quot;Handle_TableA&quot; == parentform.getValue(&quot;Handle_Table&quot;)){
		//PCR
		var table = parentform.getComponent(&quot;Handle_TableA&quot;);
		for(var j = 0;j&lt; table.getRowCount();j++){
			var ima01 = table.getValueAt(j,&quot;舊版料號&quot;);
			loadData(tableA,ima01,conn_erp);
		}
	}else if(parentform.getArtifact().getName()==&quot;PCR&quot; &amp;&amp; &quot;Handle_TableB&quot; == parentform.getValue(&quot;Handle_Table&quot;) ){
		//PCR
		var table = parentform.getComponent(&quot;Handle_TableB&quot;);
		for(var j = 0;j&lt; table.getRowCount();j++){
			var ima01 = table.getValueAt(j,&quot;舊版料號&quot;);
			loadData(tableA,ima01,conn_erp);
		}
	}else{
		//ECN
		var table = parentform.getComponent(&quot;TableA&quot;);
		for(var j = 0;j&lt; table.getRowCount();j++){
			var ima01 = table.getValueAt(j,&quot;料號&quot;);
			loadData(tableA,ima01,conn_erp);
		}
		
	}
}catch(e){}
	if(conn_erp != null)	{
		try	{
			conn_erp.commit();
		}catch(e){}
		conn_erp.close();
	}	
}
//------------------------------------------------------------------------

	function checkIma01(ima01,conn_erp){
		var flg = false;
		var sql = &quot; select count(*) count from ima_file where imaacti = &apos;Y&apos; and ima01 = &apos;&quot; + ima01 + &quot;&apos; &quot; ;
		var vector = conn_erp.loadValue(sql);
		if(vector != null &amp;&amp; vector.get(0).get(&quot;count&quot;)&gt;0){
			flg = true;
		}
		return flg;
	}


	function loadData(tableA,ima01,conn_erp){

		var row = tableA.newRow()-1;
		tableA.setValueAt(ima01,row,&quot;料號&quot;);
		if(checkIma01(ima01,conn_erp)){		
			//不/可用庫存
			var sql_ima = &quot; SELECT ima262 可用庫存,ima261 不可用庫存,ima02 品名 FROM ima_file WHERE  ima01 = &apos;&quot;+ ima01 +&quot;&apos;&quot; ;
			var vec_ima = conn_erp.loadValue(sql_ima);
			if(vec_ima != null &amp;&amp; vec_ima.size()&gt;0){
				tableA.setValueAt(vec_ima.get(0).get(&quot;品名&quot;),row,&quot;品名&quot;);
				tableA.setValueAt(vec_ima.get(0).get(&quot;不可用庫存&quot;),row,&quot;不可用庫存&quot;);
				tableA.setValueAt(vec_ima.get(0).get(&quot;可用庫存&quot;),row,&quot;可用庫存&quot;);
			}
			//工單在製
			var sql_ima = &quot; SELECT SUM((sfb08-sfb09-sfb10-sfb11-sfb12)*ima55_fac) 工單在製 FROM sfb_file, ima_file   WHERE sfb05=ima01 AND sfb05 = &apos;&quot;+ ima01 +&quot;&apos; AND sfb04 &lt;&apos;8&apos;  AND ( sfb02 !=&apos;7&apos; AND sfb02 !=&apos;11&apos; )     AND sfb08 &gt; (sfb09+sfb11+sfb12) AND sfb87!=&apos;X&apos; &quot;;
			var vec_ima = conn_erp.loadValue(sql_ima);
			if(vec_ima != null &amp;&amp; vec_ima.size()&gt;0){
				tableA.setValueAt(vec_ima.get(0).get(&quot;工單在製&quot;),row,&quot;工單在製&quot;);
			}
			//委外在製
			var sql_ima = &quot; SELECT SUM((sfb08-sfb09-sfb10-sfb11-sfb12)*ima55_fac) 委外在製 FROM sfb_file, ima_file   WHERE sfb05=ima01 AND sfb05 = &apos;&quot;+ ima01 +&quot;&apos; AND sfb04 &lt;&apos;8&apos;      AND sfb02=&apos;7&apos; AND sfb08 &gt; (sfb09+sfb10+sfb11+sfb12) &quot;;
			var vec_ima = conn_erp.loadValue(sql_ima);
			if(vec_ima != null &amp;&amp; vec_ima.size()&gt;0){
				tableA.setValueAt(vec_ima.get(0).get(&quot;委外在製&quot;),row,&quot;委外在製&quot;);
			}
			//FQC
			var sql_ima = &quot; SELECT SUM(sfb11) FQC FROM sfb_file  WHERE sfb05 = &apos;&quot; + ima01 +&quot;&apos; AND sfb02 &lt;&gt; &apos;7&apos; AND sfb87!=&apos;X&apos; AND sfb04 &lt;&apos;8&apos; &quot;;
			var vec_ima = conn_erp.loadValue(sql_ima);
			if(vec_ima != null &amp;&amp; vec_ima.size()&gt;0){
				tableA.setValueAt(vec_ima.get(0).get(&quot;FQC&quot;),row,&quot;FQC&quot;);
			}
			
			//請購
			var sql_ima = &quot; SELECT SUM((pml20-pml21)*pml09) 請購 FROM pml_file, pmk_file   WHERE pml04 = &apos;&quot;+ ima01 +&quot;&apos; AND pml01 = pmk01  AND pml20 &gt; pml21 AND pml16&lt;=&apos;2&apos; AND pml011 !=&apos;SUB&apos;       AND pmk18!= &apos;X&apos; &quot;;
			var vec_ima = conn_erp.loadValue(sql_ima);
			if(vec_ima != null &amp;&amp; vec_ima.size()&gt;0){
				tableA.setValueAt(vec_ima.get(0).get(&quot;請購&quot;),row,&quot;請購&quot;);
			}
			//採購
			var sql_ima = &quot; SELECT SUM((pmn20-pmn50+pmn55)*pmn09) 採購 FROM pmn_file, pmm_file   WHERE pmn04 = &apos;&quot;+ ima01 +&quot;&apos; AND pmn01 = pmm01     AND pmn20 &gt; pmn50-pmn55 AND pmn16 &lt;= &apos;2&apos; AND pmn011 !=&apos;SUB&apos;      AND pmm18 != &apos;X&apos; &quot;;
			var vec_ima = conn_erp.loadValue(sql_ima);
			if(vec_ima != null &amp;&amp; vec_ima.size()&gt;0){
				tableA.setValueAt(vec_ima.get(0).get(&quot;採購&quot;),row,&quot;採購&quot;);
			}
			//IQC
			var sql_ima = &quot; SELECT SUM((rvb07-rvb29-rvb30)*pmn09) IQC FROM rvb_file, rva_file, pmn_file   WHERE rvb05 = &apos;&quot;+ ima01 +&quot;&apos; AND rvb01=rva01   AND rvb04 = pmn01AND rvb03 = pmn02     AND rvb07&gt; (rvb29+rvb30) AND rvaconf=&apos;Y&apos;  &quot;;
			var vec_ima = conn_erp.loadValue(sql_ima);
			if(vec_ima != null &amp;&amp; vec_ima.size()&gt;0){
				tableA.setValueAt(vec_ima.get(0).get(&quot;IQC&quot;),row,&quot;IQC&quot;);
			}			
			//訂單
			var sql_ima = &quot; SELECT SUM((oeb12-oeb24)*oeb05_fac) 訂單 FROM oea_file,oeb_file   WHERE oeb04 = &apos;&quot;+ ima01 +&quot;&apos; AND oeb01 = oea01 AND oea00&lt;&gt;&apos;0&apos;  AND oeb70= &apos;N&apos; AND oeb12&gt; oeb24  AND oeaconf = &apos;Y&apos; &quot;;
			var vec_ima = conn_erp.loadValue(sql_ima);
			if(vec_ima != null &amp;&amp; vec_ima.size()&gt;0){
				tableA.setValueAt(vec_ima.get(0).get(&quot;訂單&quot;),row,&quot;訂單&quot;);
			}
			//工單備料
			var sql_ima = &quot; SELECT SUM((sfa05-sfa06-sfa065-sfa07)*sfa13),SUM(sfa07*sfa13) 工單備料    FROM sfb_file,sfa_file    WHERE sfa03 = &apos;&quot;+ ima01 +&quot;&apos; AND sfb01 = sfa01   AND sfb04 != &apos;8&apos; AND sfb87 != &apos;X&apos;)       AND ((sfa05&gt; (sfa06+sfa07+sfa065)) OR (sfa07 &gt; 0))  AND sfb87!=&apos;X&apos; &quot;;
			var vec_ima = conn_erp.loadValue(sql_ima);
			if(vec_ima != null &amp;&amp; vec_ima.size()&gt;0){
				tableA.setValueAt(vec_ima.get(0).get(&quot;工單備料&quot;),row,&quot;工單備料&quot;);
			}
			
			
		}else{
			tableA.setValueAt(&quot;未建檔&quot;,row,&quot;品名&quot;);
		}
	}



//------------------------------------------------------------------------
function reloadERP_ECN(){

if(Form.getValue(&quot;ECN_No&quot;)!= &quot;&quot; ){
try{
           var conn_erp = Client.createSessionConnection(&quot;ERP&quot;);
           //注意informix db 的差異
           var sql = &quot; select * from bmx_file,bmz_file where bmx01 = bmz01  and  bmx01 = &apos;&quot;+ Form.getValue(&quot;ECN_No&quot;) +&quot;&apos;&quot; ;
           var vector = conn_erp.loadValue(sql);

           var table = Form.getComponent(&quot;TableA&quot;);
           //變更主件
           table.clear();
            if (vector != null &amp;&amp; vector.size()&gt;0){
                      Form.setValue(&quot;Active_Date&quot;,vector.get(0).get(&quot;bmx07&quot;));
                      for(var i=0;i&lt;vector.size();i++)          {
                                var row = table.newRow()-1;
                                table.setValueAt(i+1+&quot;&quot;,row,&quot;序&quot;);      
                                var ima01 = vector.get(i).get(&quot;bmz02&quot;);
                                table.setValueAt(ima01,row,&quot;料號&quot;);
                                table.setValueAt(vector.get(i).get(&quot;bmz03&quot;),row,&quot;變異版本&quot;);
                                table.setValueAt(getImafile(ima01,&quot;ima02&quot;,conn_erp),row,&quot;品名&quot;);
                                table.setValueAt(getImafile(ima01,&quot;ima021&quot;,conn_erp),row,&quot;規格&quot;);                             
                     }//for   
           }
           var sql = &quot; select * from bmy_file where bmy01 =&apos;&quot;+ Form.getValue(&quot;ECN_No&quot;) +&quot;&apos; order by bmy02&quot; ;
           var vector = conn_erp.loadValue(sql);
           //變更內容
           var table = Form.getComponent(&quot;TableB&quot;);
           table.clear();
            if (vector != null &amp;&amp; vector.size()&gt;0){
                      for(var i=0;i&lt;vector.size();i++){
                                var row = table.newRow()-1;
                                table.setValueAt(vector.get(i).get(&quot;bmy02&quot;),row,&quot;項次&quot;);
								//var bmy02 = vector.get(i).get(&quot;bmy02&quot;);
                                table.setValueAt(vector.get(i).get(&quot;bmy03&quot;),row,&quot;變異別&quot;);
                                var change = &quot;&quot;;
                                var bmy03 = vector.get(i).get(&quot;bmy03&quot;);
                                //1失效2新增3修改4取代
                                if(&quot;1&quot; == bmy03){
                                           change = &quot;失效&quot;;
                                }else if(&quot;2&quot; == bmy03){
                                           change = &quot;新增&quot;;
                                }else if(&quot;3&quot; == bmy03){
                                           change = &quot;修改&quot;;
                                }else if(&quot;4&quot; == bmy03){
                                           change = &quot;取代&quot;;
                                }                    
                                table.setValueAt(change,row,&quot;變異方式&quot;);
                                //table.setValueAt(vector.get(i).get(&quot;bmy19&quot;),row,&quot;變異方式&quot;);
                                table.setValueAt(vector.get(i).get(&quot;bmy04&quot;),row,&quot;BOM項&quot;);               
                                table.setValueAt(vector.get(i).get(&quot;bmy14&quot;),row,&quot;主件&quot;);
                                var ima01 = vector.get(i).get(&quot;bmy05&quot;);
                                table.setValueAt(ima01,row,&quot;元件料號&quot;);
                                table.setValueAt(getImafile(ima01,&quot;ima02&quot;,conn_erp),row,&quot;品名&quot;);                                
                                table.setValueAt(vector.get(i).get(&quot;bmy10&quot;),row,&quot;單位&quot;);          
                                
                                var bmy16 = vector.get(i).get(&quot;bmy16&quot;);
                                if(&quot;0&quot; == bmy16){
                                           bmy16 = &quot;0-NO&quot;;
                                }else if(&quot;1&quot; == bmy16){
                                           bmy16 = &quot;1-UTE&quot;;
                                }else if(&quot;2&quot; == bmy16){
                                           bmy16 = &quot;2-SUB&quot;;
                                }                               
                                table.setValueAt(bmy16,row,&quot;取替代&quot;);                 
                                table.setValueAt(vector.get(i).get(&quot;bmy06&quot;),row,&quot;組成用量&quot;);             
                                table.setValueAt(vector.get(i).get(&quot;bmy07&quot;),row,&quot;底數&quot;);          
                                if(vector.get(i).get(&quot;bmy13&quot;) != null &amp;&amp; &quot;&quot; != vector.get(i).get(&quot;bmy13&quot;)){
                                           table.setValueAt(replaceString(vector.get(i).get(&quot;bmy13&quot;)),row,&quot;插件位置&quot;);                                       
                                }else{
                                           var sql_bmw = &quot; select bmw04 from bmw_file where bmw01=&apos;&quot;+ Form.getValue(&quot;ECN_No&quot;) + &quot;&apos;  and bmw02=&apos;&quot;+ vector.get(i).get(&quot;bmy02&quot;) + &quot;&apos;&quot;;
										   //var sql_bmw = &quot; select bmw04 from bmw_file where bmw01=&apos;&quot;+ Form.getValue(&quot;ECN_No&quot;) + &quot;&apos;  and bmw02=&apos;&quot;+ i +&quot;&apos;&quot;;
                                           var vector_bmw = conn_erp.loadValue(sql_bmw);
                                           if(vector_bmw != null &amp;&amp; vector_bmw.size()&gt;0 ){
                                                     var bmw04 = &quot;&quot;;
                                                     for(var b=0; b &lt; vector_bmw.size();b++){
                                                                bmw04 +=  vector_bmw.get(b).get(&quot;bmw04&quot;) + &quot;,&quot;;
                                                     }
                                                     table.setValueAt(replaceString(bmw04),row,&quot;插件位置&quot;);
                                           }
                                }

                     }//for 
           }
}catch(e){}
           if(conn_erp != null)         {
                     try       {
                                conn_erp.commit();
                     }catch(e){}
                     conn_erp.close();
           }
}
}


function replaceString(s){
	var s1 = java.lang.String(s);
	s1.replaceAll(&quot;,&quot;,&quot;\,&quot;);
	s1.replaceAll(&quot;-&quot;,&quot;\-&quot;);	
	return s1;
}

function getImafile(ima01,imakey,conn_erp){
	var imavalue = &quot;&quot;;
	var sql_ima = &quot; select * from ima_file where ima01 =&apos;&quot;+ ima01 +&quot;&apos; and imaacti = &apos;Y&apos; order by ima05 desc &quot;;
	var vec_ima = conn_erp.loadValue(sql_ima);	
	if (vec_ima != null &amp;&amp; vec_ima.size()&gt;0){
		imavalue = vec_ima.get(0).get(imakey);
	}
	return imavalue;
}

//=================================================================================

//erpartid ERP 單別ex: ECN
//itemid 表單欄位的 itemid ex: ITEM176
//itemname 表單欄位的名稱 ex : ECN_No
function setERPNo(erpartid,itemid,itemname){
	var artid = Form.getArtifactID(); //ART00021154532228237
	var erpid = getErpID(erpartid,itemid,artid+&quot;_Ins&quot;); //ECN / ECR / PCR,item176
	Form.setValue(itemname,erpid);
}



function getErpID(erpartid,itemid,tablename){
	var serverTime = Client.getServerTime();
	var myDate = new Packages.pase.agenda.MyDate(serverTime);
	var today = myDate.getCurrentDate(&quot;Y/M/D&quot;); 
	var month = today.substring(5,7);
	if (month.equals(&quot;10&quot;)){
		month = &quot;A&quot;;
	}else if (month.equals(&quot;11&quot;)){
		month = &quot;B&quot;;
	}else if (month.equals(&quot;12&quot;)){
		month = &quot;C&quot;;
	}else{
		month = today.substring(6,7);
	}
	var l_date = &quot;-&quot; + today.substring(2,4)+ month;
	//ECN-06A001 
	// SELECT RIGHT(ITEM176, 3) AS Expr1 FROM             ART00021154532228237_Ins WHERE         (ITEM176 &lt;&gt; &apos;&apos;) AND (ITEM176 IS NOT NULL) AND (ITEM176 LIKE &apos;ECN-068%&apos;)
	var l_sql = &quot; select Right(max(&quot;+ itemid + &quot;),3) MAXNO from &quot; + tablename + &quot; where &quot;+ itemid +&quot; &lt;&gt;&apos;&apos; and &quot;+ itemid +&quot; is not null and &quot;+ itemid + &quot; like &apos;&quot;+ erpartid + l_date +&quot;%&apos; &quot;;
	var data = Client.SQLloadValue(l_sql);
	if(data.get(0).get(&quot;MAXNO&quot;)!=&quot;&quot;){
		var maxno = data.get(0).get(&quot;MAXNO&quot;);
		var maxno = java.lang.Integer.parseInt(maxno) + 1;
		maxno = maxno + &quot;&quot;;//轉為 string
		if(maxno.length == 1 ){
			maxno = &quot;00&quot; + maxno;				
		}else if(maxno.length == 2 ) {
			maxno = &quot;0&quot; + maxno;				
		}else if(maxno.length == 3 ) {
			maxno = &quot;&quot; + maxno;				
		}
	}else{
		var maxno = &quot;001&quot;;
	}
	var erpid = erpartid  + l_date + maxno;
	return erpid ;
}

//----------------
// PCR 表單上的半成品會簽名單
//----------------

function setTableUser(tablename){
	//function 寫在 table 的 save script
	// input 部份姓名 output 全部姓名及工號、部門名稱
	var table = Form.getComponent(tablename);
	var id = table.getValueAt(table.getLastAccessIndex(),&quot;工號&quot;);
	var username = table.getValueAt(table.getLastAccessIndex(),&quot;姓名&quot;);
	//table.setValueAt(table.getLastAccessIndex()+1+&quot;&quot;,table.getLastAccessIndex(),&quot;序&quot;);
	if(id ==&quot;&quot; || username ==&quot;&quot;){
	if (!((id == null)||(id == &quot;&quot;))){
		//用工號來抓姓名及部門名稱
        var s_sql =  &quot;SELECT loginid FROM mem_geninf  WHERE id = &apos;&quot;+ id +&quot;&apos; and resign = &apos;false&apos;&quot;;
		var dataVector = Client.SQLloadValue(s_sql);
		if (dataVector != null &amp;&amp; dataVector.size()&gt;0){
     		var cMember = Client.getMemberByName(dataVector.get(0).get(&quot;loginid&quot;));
			table.setValueAt(cMember.getName(),table.getLastAccessIndex(),&quot;姓名&quot;);
			var memDR = cMember.getMemberDR(cMember.getMainRoleID());
			var sDepName = memDR.getDepartmentName();	//使用者部門名稱
			table.setValueAt(sDepName,table.getLastAccessIndex(),&quot;會簽單位&quot;);

		}else{
			Form.showMessageDialog(&quot;所填的工號不存在!&quot;);		
		}


	}else 	if (!((username == null)||(username == &quot;&quot;))){
		//用姓名來抓工號及部門名稱
        var s_sql =  &quot;SELECT COUNT(*) COUNT FROM mem_geninf  WHERE username like &apos;%&quot;+ username +&quot;%&apos; and resign = &apos;false&apos;&quot;;
		var dataVector = Client.SQLloadValue(s_sql);
		var count = 0;
		if (dataVector != null &amp;&amp; dataVector.size()&gt;0){
			 count = dataVector.get(0).get(&quot;COUNT&quot;);
		}
		if (count == 0 || count ==0.0)
		{
			Form.showMessageDialog(&quot;所填的姓名不存在!&quot;);		
		}else if(count == 1 || count ==1.0) {
	        var s_sql =  &quot;SELECT username FROM mem_geninf  WHERE username like &apos;%&quot;+ username +&quot;%&apos; and resign = &apos;false&apos;&quot;;
			var dataVector = Client.SQLloadValue(s_sql);
			username = dataVector.get(0).get(&quot;username&quot;);
			var cMember = Client.getMemberByCName(username);
			table.setValueAt(username,table.getLastAccessIndex(),&quot;姓名&quot;);
			table.setValueAt(cMember.getMyID(),table.getLastAccessIndex(),&quot;工號&quot;);
			var memDR = cMember.getMemberDR(cMember.getMainRoleID());
			var sDepName = memDR.getDepartmentName();	//使用者部門名稱
			table.setValueAt(sDepName,table.getLastAccessIndex(),&quot;會簽單位&quot;);
		}else if (count &gt;1){
			//有同名的人員

			//寫在母表單的按鈕上
			//開啟唯一一張表單,沒有就新產生一張//ART00051154844418515(選人)
			var ArtID = &quot;ART00051154844418515&quot;;
	      	var sSQL = &quot;SELECT InsID FROM &quot;+ ArtID +&quot;_Ins&quot;;
			var vec = Client.SQLloadValue(sSQL);
     	  	if (vec.size() == 0){  
		    	  var artIns = Client.createArtInstance(ArtID);
			      var artInsID = artIns.getID();
			}else{
	    	 	 var artInsID = vec.get(0).get(&quot;InsID&quot;);
	    	}

			//var panel = Client.createForm(artInsID,&quot;CreateForm&quot;,true);
			var panel = Client.createForm(artInsID,&quot;CreateForm&quot;,true,false,true,0,10,10, 550,400) ; 
 		}


	}
	}
	
	
}//function SingTableUser


	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00091215516896632</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/07/08 19:34:56</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.MAN.addAsignTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00091215516896632</string> 
     </void> 
     <void property="name"> 
      <string>addAsignTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00301215516853448</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//TGCE OP主管Sign_MemberTable_T_OPM
//TGCE OP工程師Sign_MemberTable_T_OP
//TGCE QAE(Local)Sign_MemberTable_T_QA
//TGCE QAE(QA)Sign_MemberTable_T_QAE
//TGCE QCSign_MemberTable_T_QC
//TGCE PMSign_MemberTable_T_PM
//TGCE CSSign_MemberTable_T_CS
//PE處級主管Sign_MemberTable_PE_HEAD
//ME 經副理Sign_MemberTable_T_ME
//ME處級主管Sign_MemberTable_ME_HEAD
// 
//===================================================
//Parameters:companyID=公司代碼;PARAMETER=角色代碼;Sign_MemberTable=暫存表單;clear_Table=清除TABLE資料


function addAsign_DEP_ME(Sign_MemberTable,appDataMap){ 
//PLM角色  //ME主管    //製程處 P1/P2/P3 
//	var aInstance = MyTask.getArtInstance();
//	var appDataMap = aInstance.getAppDataMap(); 
    var SignTable = appDataMap.get(Sign_MemberTable);
	var App_DepID = appDataMap.get(&quot;App_DepID&quot;); // 申請者部門代號
	var App_Dep_ID= appDataMap.get(&quot;App_Dep_ID&quot;); // 申請者部門代號 3碼
    //SignTable.clear();	
//------------	
	if( &quot;true&quot;==appDataMap.get(&quot;design-t&quot;) ){
	for(var i=1;i&lt;4;i++){	
			var Depart_ID = &quot;DEPT2P&quot;+i
			var Depart_MECN = &quot;MECN-P&quot;+i
			if( &quot;true&quot;==appDataMap.get(Depart_MECN)){
				var Department = Server.getDepartment(Depart_ID);
				if(Department != null){
					var memid = Department.getManagerID() ;
					var Member = Server.getMemberByID(memid);
					var username = Member.getName(); 
					var row = new Packages.java.util.HashMap()		 
					row.put(&quot;memid&quot;,memid);
					row.put(&quot;cname&quot;,username);
					row.put(&quot;jobtitle&quot;,&quot;T_DEP_ME&quot;);
					SignTable.add(SignTable.size(), row);	
				}
			}
		}	
	}
	if( &quot;true&quot;==appDataMap.get(&quot;design-s&quot;)  ){
		for(var i=1;i&lt;4;i++){	
			var Depart_ID = &quot;DEPS6P&quot;+i
			var Depart_MECN = &quot;MECN-P&quot;+i
			if( &quot;true&quot;==appDataMap.get(Depart_MECN)){
				var Department = Server.getDepartment(Depart_ID);
				if(Department != null){
					var memid = Department.getManagerID() ;
					var Member = Server.getMemberByID(memid);
					var username = Member.getName(); 
					var row = new Packages.java.util.HashMap()		 
					row.put(&quot;memid&quot;,memid);
					row.put(&quot;cname&quot;,username);
					row.put(&quot;jobtitle&quot;,&quot;S_DEP_ME&quot;);
					SignTable.add(SignTable.size(), row);	
				}
			}
		}	
	}
	if( &quot;true&quot;==appDataMap.get(&quot;design-c&quot;)  ){
		for(var i=1;i&lt;3;i++){	
			var Depart_ID = &quot;DEPC8P&quot;+i
			var Depart_MECN = &quot;MECN-P&quot;+i
			if( &quot;true&quot;==appDataMap.get(Depart_MECN)){
				var Department = Server.getDepartment(Depart_ID);
				if(Department != null){
					var memid = Department.getManagerID() ;
					var Member = Server.getMemberByID(memid);
					var username = Member.getName(); 
					var row = new Packages.java.util.HashMap()		 
					row.put(&quot;memid&quot;,memid);
					row.put(&quot;cname&quot;,username);
					row.put(&quot;jobtitle&quot;,&quot;C_DEP_ME&quot;);					
					SignTable.add(SignTable.size(), row);	
				}
			}
		}		
	}
	appDataMap.put(Sign_MemberTable, SignTable);
//	aInstance.setAppDataMap(appDataMap);
//	Server.updateArtInstance(aInstance);// 表單刷新	 
//PLM角色
}	



function addAsign_DEP_ME_MAX(Sign_MemberTable,appDataMap){ 
//PLM角色  ME最高主管  ex:高國明 廠長
//	var aInstance = MyTask.getArtInstance();
//	var appDataMap = aInstance.getAppDataMap(); 
    var SignTable = appDataMap.get(Sign_MemberTable);
	var App_DepID = appDataMap.get(&quot;App_DepID&quot;); // 申請者部門代號
	var App_Dep_ID= appDataMap.get(&quot;App_Dep_ID&quot;); // 申請者部門代號 3碼
    //SignTable.clear();	
	
//------------	
	if( &quot;true&quot;==appDataMap.get(&quot;design-t&quot;) ){
	
	//for(var i=1;i&lt;4;i++){	
			var Depart_ID = &quot;DEPT2P0&quot;
			var Department = Server.getDepartment(Depart_ID);
			if(Department != null){
				var memid = Department.getManagerID() ;
				var Member = Server.getMemberByID(memid);
				var username = Member.getName(); 
				var row = new Packages.java.util.HashMap()		 
				row.put(&quot;memid&quot;,memid);
				row.put(&quot;cname&quot;,username);
				row.put(&quot;jobtitle&quot;,&quot;T_ME_MAX&quot;);	
				SignTable.add(SignTable.size(), row);	
			}	
	//	}
	
	}
	if( &quot;true&quot;==appDataMap.get(&quot;design-s&quot;)  ){
	
		//for(var i=1;i&lt;4;i++){	
			var Depart_ID = &quot;DEPS6P0&quot;
			var Department = Server.getDepartment(Depart_ID);
			if(Department != null){
				var memid = Department.getManagerID() ;
				var Member = Server.getMemberByID(memid);
				var username = Member.getName(); 
				var row = new Packages.java.util.HashMap()		 
				row.put(&quot;memid&quot;,memid);
				row.put(&quot;cname&quot;,username);
				row.put(&quot;jobtitle&quot;,&quot;S_ME_MAX&quot;);				
				SignTable.add(SignTable.size(), row);	
			}	
	//	}
	
	}
	if( &quot;true&quot;==appDataMap.get(&quot;design-c&quot;)  ){
	
		//for(var i=1;i&lt;3;i++){	
			var Depart_ID = &quot;DEPC8P0&quot;
			var Department = Server.getDepartment(Depart_ID);
			if(Department != null){
				var memid = Department.getManagerID() ;
				var Member = Server.getMemberByID(memid);
				var username = Member.getName(); 
				var row = new Packages.java.util.HashMap()		 
				row.put(&quot;memid&quot;,memid);
				row.put(&quot;cname&quot;,username);
				row.put(&quot;jobtitle&quot;,&quot;C_ME_MAX&quot;);				
				SignTable.add(SignTable.size(), row);	
			}	
		//}
		
	}
	appDataMap.put(Sign_MemberTable, SignTable);
//	aInstance.setAppDataMap(appDataMap);	
//	Server.updateArtInstance(aInstance);// 表單刷新	
//PLM角色
}	




//PE/ME最高主管(ALL)   ex:湯智彬
function addAsign_DEP_PE_MAX(Sign_MemberTable,appDataMap){ 
//PLM角色
//	var aInstance = MyTask.getArtInstance();
//	var appDataMap = aInstance.getAppDataMap(); 
    var SignTable = appDataMap.get(Sign_MemberTable);
	var App_DepID = appDataMap.get(&quot;App_DepID&quot;); // 申請者部門代號
	var App_Dep_ID= appDataMap.get(&quot;App_Dep_ID&quot;); // 申請者部門代號 3碼
    //SignTable.clear();	
	
//------------	
//#DEPT2J0 #DEPT2J2 #DEPT2J5  yes都Run
	if( &quot;true&quot;==appDataMap.get(&quot;design-t&quot;) ){	
		for(var i=0;i&lt;6;i++){	
				if( i == 1 || i == 3 || i == 4 ){				
					continue ;
				}
				var Depart_ID = &quot;DEPT2J&quot;+i							 
				var Department = Server.getDepartment(Depart_ID);
				if(Department != null){
					var memid = Department.getManagerID() ;
					var Member = Server.getMemberByID(memid);
					var username = Member.getName(); 
					var row = new Packages.java.util.HashMap()		 
					row.put(&quot;memid&quot;,memid);
					row.put(&quot;cname&quot;,username);
					row.put(&quot;jobtitle&quot;,&quot;T_PE_MAX&quot;);						
					SignTable.add(SignTable.size(), row);	
				}
		}	
	}
		memid = &quot;MEMT1001852&quot;  // 先設給001852	    
		var cMember = Server.getMemberByID(memid);
		var row = new Packages.java.util.HashMap()		 
		row.put(&quot;memid&quot;,memid);
		row.put(&quot;cname&quot;,&quot;許朝政&quot;);
		SignTable.add(SignTable.size(), row);	
	//#DEPS6J0 #DEPS6J1 #DEPS6J2
	if( &quot;true&quot;==appDataMap.get(&quot;design-s&quot;)  ){
		for(var i=0;i&lt;3;i++){	
			var Depart_ID = &quot;DEPS6J&quot;+i
			var Department = Server.getDepartment(Depart_ID);
			if(Department != null){
				var memid = Department.getManagerID() ;
				var Member = Server.getMemberByID(memid);
				var username = Member.getName(); 
				var row = new Packages.java.util.HashMap()		 
				row.put(&quot;memid&quot;,memid);
				row.put(&quot;cname&quot;,username);
				row.put(&quot;jobtitle&quot;,&quot;S_PE_MAX&quot;);					
				SignTable.add(SignTable.size(), row);	
			}	
		}
	}
	//#DEPC8J1 #DEPC8J2							 
	if( &quot;true&quot;==appDataMap.get(&quot;design-c&quot;)  ){
		for(var i=1;i&lt;2;i++){	
			var Depart_ID = &quot;DEPC8J&quot;+i
			var Department = Server.getDepartment(Depart_ID);
			if(Department != null){
				var memid = Department.getManagerID() ;
				var Member = Server.getMemberByID(memid);
				var username = Member.getName(); 
				var row = new Packages.java.util.HashMap()		 
				row.put(&quot;memid&quot;,memid);
				row.put(&quot;cname&quot;,username);
				row.put(&quot;jobtitle&quot;,&quot;C_PE_MAX&quot;);					
				SignTable.add(SignTable.size(), row);	
			}	
		}	
	}
	appDataMap.put(Sign_MemberTable, SignTable);
//	aInstance.setAppDataMap(appDataMap);	
//	Server.updateArtInstance(aInstance);// 表單刷新	
//PLM角色
}	



function addAsignList(companyID,PARAMETER,Sign_MemberTable,appDataMap){ 
// 判斷不同廠別call 不同的funciton	
	//var mID = MyTask.getRealExecutor();
	//var cMember = Server.getMemberByID(mID);	
	//var sUserName = cMember.getName();	//使用者姓名
	//var roleID = MyTask.getRoleID();
	//var memDR = cMember.getMemberDR(roleID);
	//var sDepName = memDR.getDepartmentName();	//使用者部門名稱
	//var sDepID = Server.getDepartment(memDR.getDepartmentID()).getMyID();
	//var sRoleName = memDR.getRoleName();	//使用者職務名稱
	//var companyID = cMember.getAreaCode(); //使用者公司代碼
//PLM角色
//	var aInstance = MyTask.getArtInstance();
//	var appDataMap = aInstance.getAppDataMap(); 
    var SignTable = appDataMap.get(Sign_MemberTable);
	var App_DepID = appDataMap.get(&quot;App_DepID&quot;); // 申請者部門代號
	var App_Dep_ID= appDataMap.get(&quot;App_Dep_ID&quot;); // 申請者部門代號 3碼
    //SignTable.clear();	
//------------	
//	var artid = aInstance.getArtifactID();
		var SQL =    &quot; select VALUE2 memid ,VALUE1 username  from A_PARAMETER_ITEM , A_PARAMETER_DATA &quot;;
		SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 = &apos;&quot;+ companyID +&quot;&apos; &quot;  ;	
    var vector = Server.SQLloadValue(SQL);		
    if ( vector != null ){
	   if (vector.size()&gt;0){
		  for(var i=0;i&lt;vector.size();i++)  {
			  var ht = vector.get(i);
			  var memid = ht.get(&quot;memid&quot;)
			  var cMember = Server.getMemberByID(memid);
			  if(cMember == null){
// 檢核員工是否是有效的,若無效基本上會傳給administrator , 
				memid = &quot;MEMT1005230&quot;  // 先設給005230	
			    var cMember = Server.getMemberByID(memid);
			  }
//			  var jobtitle = member.getJobTile();			  
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  var row = new Packages.java.util.HashMap()		 
			  row.put(&quot;memid&quot;,memid);
			  row.put(&quot;cname&quot;,ht.get(&quot;username&quot;));
			  row.put(&quot;jobtitle&quot;,PARAMETER);
			  row.put(&quot;jobtitle&quot;,PARAMETER);
			  SignTable.add(SignTable.size(), row);			  
			 }
		  }//for
		}
	appDataMap.put(Sign_MemberTable, SignTable);
//	aInstance.setAppDataMap(appDataMap);	 
//	Server.updateArtInstance(aInstance);// 表單刷新	
//PLM角色
}	



function addAsignCustomer(companyID,PARAMETER,Sign_MemberTable,item_no,appDataMap){ 
//PLM PM CS角色
//	var aInstance = MyTask.getArtInstance();
//	var appDataMap = aInstance.getAppDataMap(); 
    var SignTable = appDataMap.get(Sign_MemberTable);
	var App_DepID = appDataMap.get(&quot;App_DepID&quot;); // 申請者部門代號
	var App_Dep_ID= appDataMap.get(&quot;App_Dep_ID&quot;); // 申請者部門代號 3碼
    //SignTable.clear();	
//------------	
//	var artid = aInstance.getArtifactID();
		var SQL =    &quot; select VALUE2 memid ,VALUE1 username  from A_PARAMETER_ITEM , A_PARAMETER_DATA &quot;;
		SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 in (&apos;&quot;+ companyID +&quot;&apos;) &quot;  ;	
		SQL = SQL +  &quot; and A_PARAMETER_DATA.VALUE3 LIKE &apos;%&quot;+ item_no +&quot;%&apos; &quot;  ;

    var vector = Server.SQLloadValue(SQL);		
    if ( vector != null ){
	   if (vector.size()&gt;0){
		  for(var i=0;i&lt;vector.size();i++)  {
			  var ht = vector.get(i);
			  var memid = ht.get(&quot;memid&quot;)
			  var cMember = Server.getMemberByID(memid);
			  if(cMember == null){
// 檢核員工是否是有效的,若無效基本上會傳給administrator , 
				memid = &quot;MEMT1014066&quot;  // 先設給014066	
			    var cMember = Server.getMemberByID(memid);
			  }
//			  var jobtitle = member.getJobTile();			  
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  var row = new Packages.java.util.HashMap()		 
			  row.put(&quot;memid&quot;,memid);
			  row.put(&quot;cname&quot;,ht.get(&quot;username&quot;));
			  row.put(&quot;jobtitle&quot;,PARAMETER);
			  SignTable.add(SignTable.size(), row);			  
			 }
		  }else{
			  //非 customer_id 給固定的人員 CS /PM
			  if(&quot;PLM_PM&quot;==PARAMETER){
				  memid = &quot;MEMT1014525&quot;  // 先設給014525    
				  var cMember = Server.getMemberByID(memid);
				  var row = new Packages.java.util.HashMap()		 
				  row.put(&quot;memid&quot;,memid);
				  row.put(&quot;cname&quot;,&quot;陳元鴻&quot;);
				  row.put(&quot;jobtitle&quot;,PARAMETER);				  
				  SignTable.add(SignTable.size(), row);	
			  }else{
				  memid = &quot;MEMT1012806&quot;  // 先設給012806	    
				  var cMember = Server.getMemberByID(memid);
				  var row = new Packages.java.util.HashMap()		 
				  row.put(&quot;memid&quot;,memid);
				  row.put(&quot;cname&quot;,&quot;鍾宜君&quot;);
				  row.put(&quot;jobtitle&quot;,PARAMETER);
				  SignTable.add(SignTable.size(), row);	
				  memid = &quot;MEMT1012896&quot;  // 先設給012896	    
				  var cMember = Server.getMemberByID(memid);
				  var row = new Packages.java.util.HashMap()		 
				  row.put(&quot;memid&quot;,memid);
				  row.put(&quot;cname&quot;,&quot;王建凱&quot;);
				  row.put(&quot;jobtitle&quot;,PARAMETER);				  
				  SignTable.add(SignTable.size(), row);					  
			  }		  
		  }
		}
	appDataMap.put(Sign_MemberTable, SignTable);
//	aInstance.setAppDataMap(appDataMap);	 
//	Server.updateArtInstance(aInstance);// 表單刷新	
//PLM角色
}





//=========================================
//清除兩張表格內memid相同的紀錄
//=========================================
function clearSameData(Master,Slave){
	var artIns = MyTask.getArtInstance();
	/*
		方法一:利用getAppDataMap()取得表單內所有dataMap資料後,再取得需比較的表格欄位
	*/
	var formDataMap = artIns.getAppDataMap();
	var master = formDataMap.get(Master);// 取得table Master的內容
	var slave = formDataMap.get(Slave);// 取得table Slave的內容
	/*
		方法二:利用資料庫查詢取得表格內容
	*/
	//var artID = artIns.getArtifactID();// 取得表單ID
	//var insID = artIns.getID();// 取得表單的instanceID,通常啟動一個流程會有一個insID
	//var sql = &amp;quot;SELECT * FROM &amp;quot;+artID+&amp;quot;ITEM2 Where INSID=&amp;apos;&amp;quot;+insID+&amp;quot;&amp;apos;&amp;quot;;// 取得table Master的內容
	//var master = Server.SQLloadValue(sql);// 取得table Master的內容
	//sql = &amp;quot;SELECT * FROM &amp;quot;+artID+&amp;quot;ITEM3 Where INSID=&amp;apos;&amp;quot;+insID+&amp;quot;&amp;apos;&amp;quot;;// 取得table Slave的內容
	//var slave = Server.SQLloadValue(sql);// 取得table Slave的內容
	if(master.size()&gt;0&amp;&amp;slave.size()&gt;0){// 只有在兩個table都有值才要做比對
		var newVector = new java.util.Vector();
		for(var i=0;i&lt;slave.size();i++){
			var slaveRowDate = slave.get(i);
			var isR = false;// 以此判斷是否要留Slave的內容
			for(var j=0;j&lt;master.size();j++){			
				var masterRowData = master.get(j);			
				var masterMemid = masterRowData.get(&quot;memid&quot;);
				var slaveMemid = slaveRowDate.get(&quot;memid&quot;);			
				if(masterMemid==slaveMemid||masterMemid.equals(slaveMemid)){// memid相等時,isR=true,代表重複
					//java.lang.System.out.println(&amp;quot;masterMemid=&amp;quot;+masterMemid);
					//java.lang.System.out.println(&amp;quot;slaveMemid=&amp;quot;+slaveMemid);
					isR=true;// 重複
					break;
				}		
			}
			if(!isR){// 不重複就是要留的
				var slaveMemid = slaveRowDate.get(&quot;memid&quot;);
				var slaveCname = slaveRowDate.get(&quot;cname&quot;);
				var newHashMap = new java.util.HashMap();
				newHashMap.put(&quot;memid&quot;,slaveMemid);
				newHashMap.put(&quot;cname&quot;,slaveCname);
				newVector.add(newHashMap);
			}
		}	
		artIns.setAppValue(Slave,newVector);// 設定值回表單上的Slave
		Server.updateArtInstance(artIns);// 表單刷新
	}
}







	


</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00091230018633669</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/05/07 09:29:13</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.Common.Server.SendMail</string> 
     </void> 
     <void property="id"> 
      <string>SCL00091230018633669</string> 
     </void> 
     <void property="name"> 
      <string>SendMail</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00251213176848084</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/**
 GoBack(拉回前一關)時發出的 mail
 發給被GoBackto的那一關(task.realexecutor)
 用於 Server
*/
function sendGoBackMail(MyTask){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
//		var from = Client.getMember(&quot;administrator&quot;).getEmail();  		
        //var to = getProcessMailAddressList(groupname); 
		//var to = Client.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail();
//		var realexecutor_mail = Client.getMember(MyTask.getRealExecutor()).getEmail();
		var realexecutor_mail = Server.getMember(MyTask.getRealExecutor()).getEmail();
		var to = realexecutor_mail;
        var cc = &quot;&quot;; //cc觀察用 
//        var subject = &quot;[撤簽通知]&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」已被撤回-[&quot;+ MyTask.getKeyWord() +&quot;]&quot;; // Mail Subject 
        var subject = &quot;[重簽通知]&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot;所申請-&quot; + roottaskname + &quot;已重新提出&quot;; // Mail Subject 
		var text = getGoBackMailContent(dataMap,MyTask);
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
//		Client.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
//-------------------
// 撤單通知內容
//-------------------
function getGoBackMailContent(dataMap,MyTask){
		//var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   [撤回通知]&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Client.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Client.getMember(Client.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Client.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Client.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		//text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;

		return text;
}

/**
 MECN審查完成時發出的 mail
 用於 Server
*/
function sendMECN_Mail_Tablelist(MyTask,tablelist){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        //var to = getProcessMailAddressList(groupname); //通知簽核過的人員		
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}		
		try{
			if (dataMap.get(&quot;FCheckBox_a12&quot;) == true || dataMap.get(&quot;FCheckBox_b3&quot;) == true || dataMap.get(&quot;FCheckBox_c27&quot;) == true ){
				to += &quot;;albert_wong@gce.com.tw&quot;
			}			
		}catch(e){}				
//		to += &quot;;&quot; +getMailAddressTableA(dataMap);			
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		
//		if( vFactory==&quot;(SGCE)&quot; ||vFactory==&quot;(CGCE)&quot;  ){
//			cc = &quot;jay.jiang@gcecn.com;peppers_chang@gce.com.tw&quot;; //cc觀察用 
//		}
        var subject = &quot;[審核完成通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		var text = getAcceptMailContent_MECN(dataMap);
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}

/**
 BAS
 審查完成時發出給HR的 mail 
 用於 Server
*/
function send_BAS_Mail(MyTask,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
//		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
//		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		var to = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail()+&quot;;&quot;;	
		var factory = dataMap.get(&quot;Factory&quot;);
		if(msg==&quot;&quot;){	
			if(factory==&quot;(TGCE)&quot;){
				to += Server.getMemberByID(&quot;MEMT1018023&quot;).getEmail()+&quot;;&quot;+Server.getMemberByID(&quot;MEMT1021017&quot;).getEmail()+&quot;;&quot;+Server.getMemberByID(&quot;MEMT1004424&quot;).getEmail()+&quot;;&quot;+Server.getMemberByID(&quot;MEMT1020526&quot;).getEmail()+&quot;;&quot;+Server.getMemberByID(&quot;MEMT1034226&quot;).getEmail()+&quot;;&quot;; //HR人員
//				to += &quot;james_dun@gce.com.tw;tony_chen@gce.com.tw;&quot;;	//QC人員
			//	to += &quot;vic_tsai@gce.com.tw;&quot;;	//廠長
				//to += Server.getMemberByID(&quot;MEMT1004670&quot;).getEmail()+&quot;;&quot;;	//李瑞彬
				
			}
				
			to += getDepMail(dataMap);//取得單位主管與書記email
		}else if(msg ==&quot;reject&quot;){
//			to += &quot;;&quot; +&quot;irene_chang@gce.com.tw;&quot;;
		 var tablelist = &quot;PM_Table&quot;;
		    var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		     //  to += &quot;danny_wang@gce.com.tw;&quot;;	//HR人員			
		}else if(msg ==&quot;cancel&quot; ||msg ==&quot;fail&quot;){
		  //抓取下崗申請單填單者	
		  var Source_Ins = Server.getArtInstance(dataMap.get(&quot;fail_insid&quot;));
		  var source_dataMap = Source_Ins.getAppDataMap();		
		      to += &quot;;&quot; + Server.getMember(source_dataMap.get(&quot;Creator_ID&quot;)).getEmail(); 		  		
		}	
        if(roottaskname.indexOf(&quot;下崗&quot;)&gt;=0 ){		
           var v_subject = dataMap.get(&quot;Sn&quot;) + dataMap.get(&quot;Subject&quot;);
		}else{
           var v_subject =&quot;[&quot;+ dataMap.get(&quot;BAS_level_t&quot;)+ &quot;-&quot; + dataMap.get(&quot;unit_no_t&quot;) + &quot;]&quot;  + dataMap.get(&quot;Sn&quot;) + dataMap.get(&quot;Subject&quot;);		
		}
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if(msg==&quot;&quot;){
		  var subject = &quot;【審核完成通知】&quot;+dataMap.get(&quot;App_Dep_ID&quot;)+&quot;-&quot; + dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+ v_subject +&quot;」已審核通過&quot;; // Mail Subject 
		}else if(msg ==&quot;print&quot;){
		 var subject = &quot;【列印通知】&quot;+dataMap.get(&quot;App_Dep_ID&quot;)+&quot;-&quot; + dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+ v_subject +&quot;」待PQE審核&quot;; // Mail Subject 
		}else if(msg ==&quot;reject&quot;){
		 var subject = &quot;【駁回通知】&quot;+dataMap.get(&quot;App_Dep_ID&quot;)+&quot;-&quot; + dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+ v_subject +&quot;」駁回審核&quot;; // Mail Subject 			
        }else if(msg ==&quot;fail&quot;){
		 var subject = &quot;【下崗通知】&quot;+dataMap.get(&quot;App_Dep_ID&quot;)+&quot;-&quot; + dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+ v_subject +&quot;」已下崗&quot;; // Mail Subject 			
        }else if(msg ==&quot;cancel&quot;){
		 var subject = &quot;【作廢通知】&quot;+dataMap.get(&quot;App_Dep_ID&quot;)+&quot;-&quot; + dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+ v_subject +&quot;」已作廢&quot;; // Mail Subject 			
		}	
		var text = getAcceptMailContent_PLM(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}

//取得部門書記及單位主管email
function getDepMail(dataMap){
	var v_factory=dataMap.get(&quot;Factory&quot;).substr(1,4);
	var App_Dep_ID= dataMap.get(&quot;App_Dep&quot;).substr(0,3);
	var memTitle = &quot;MEMT1&quot;;
	if(v_factory ==&quot;SGCE&quot;){
		memTitle = &quot;MEMS1&quot;;
	}else if(v_factory ==&quot;CGCE&quot;){
		memTitle = &quot;MEMC1&quot;;
	}else if(v_factory ==&quot;HGCE&quot;){
		memTitle = &quot;MEMH1&quot;;
	}else{
	}

	//抓取BPM 短期資料庫連線
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
  	var conn = Server.createSessionConnection(conn_name);	
	var sql = &quot;select clerk,chief from empm030 where dptno=&apos;&quot;+App_Dep_ID+&quot;&apos;; &quot;;
	try{
		var rs = conn.loadValue(sql);
		var email =&quot;&quot;;
		if(rs!=null &amp;&amp; rs.size()&gt;0){
			var clerk_member = Server.getMember((memTitle+rs.get(0).get(&quot;clerk&quot;)));
			if(clerk_member!=null){
				email = email + clerk_member.getEmail() + &quot;;&quot;;
			}
			var chief_member = Server.getMember((memTitle+rs.get(0).get(&quot;chief&quot;)));
			if(chief_member!=null){
				email = email + chief_member.getEmail() + &quot;;&quot;;
			}
		}
		return email;
	}catch(e){
		conn.close();
	}finally{
		conn.close();
	}
	
	
}
/**
 PLM_ECR
 審查完成時發出的 mail
 用於 Server
*/
function sendPLM_Mail_Tablelist(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot; != msg ){
			var subject = &quot;[審核完成通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[審核完成通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_PLM(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/**
 PLM_MECN
 審查時發出的 mail
 用於 Server
*/
function sendPLM_MECN_Mail_Tablelist(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		var cc = &quot;&quot;;
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
 
		if(&quot;&quot; != msg ){
			var subject = &quot;[MECN建立通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已送審&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[MECN建立通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已送審&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_PLM(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/**
 PLM_MECN
 作廢審查完成時發出的 mail
 給QC 人員
 用於 Server
*/
function sendPLM_MECN_QC_Mail_Tablelist(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		var cc = &quot;&quot;;
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
//		var cc = &quot;irene_chang@gce.com.tw&quot;; //cc觀察用 
		if(&quot;&quot; != msg ){
//			var subject = &quot;【&quot;+ vFactory +&quot;MECN作廢審核完成通知】&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
			var subject = &quot;【&quot;+ vFactory +&quot;MECN填寫批號完成通知】&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已審核通過&quot;; // Mail Subject 			
		}else{
		    var subject = &quot;【&quot;+ vFactory +&quot;MECN作廢審核完成通知】&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_PLM(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}


/**
 PLM_MECN
 審查完成時發出的 mail
 給它廠MFG 人員
 用於 Server
*/
function sendPLM_MECN_MFG_Mail_Tablelist(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		var cc = &quot;&quot;;
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
		
		if(&quot;&quot; != msg ){
			var subject = &quot;【&quot;+ vFactory +&quot;MECN審核完成通知】&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
//            var subject = &quot;【&quot;+ vFactory +&quot;MECN填寫批號完成通知】&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已審核通過&quot;; // Mail Subject 			
		}else{
		    var subject = &quot;【&quot;+ vFactory +&quot;MECN審核完成通知】&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_PLM(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}


/**
 PLM_Gerber
 審查時發出的 mail
 用於 Server
*/
function sendPLM_Gerber_Mail_Tablelist(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot; != msg ){
			var subject = &quot;[Gerber建立通知] 試算料號:&quot;+dataMap.get(&quot;Test_item_no&quot;)+&quot;-&quot;+ dataMap.get(&quot;Test_item_ver&quot;) + &quot;己下Gerber資料 ，金像料號為：&quot;+dataMap.get(&quot;ERP-GCE-item-no&quot;); // Mail Subject 
		}else{
		    var subject = &quot;[新料號成立通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已送審&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_PLM(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}

/**
 PLM_ECN
 審查時發出的 mail
 用於 Server
*/
function sendPLM_ECN_Mail_Tablelist(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  	
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 		
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
//				to +=getMailAddressTable(dataMap,fields[i])+ &quot;;&quot;;
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot; != msg ){
			var subject = &quot;[ECN簽收通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已送審&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[ECN簽收通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已送審&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_PLM(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/**
 PLM_ER_EQ 
 審查時發出的 mail
 用於 Server
 msg 用於識別是讀取表單TABLE OR　DB Table  &lt;-- by wangwei@2011/02/18
 注意: msg 有值 tablelist 則是要傳入流程參數a_parameter_data 中的 parameter
*/
function sendPLM_ER_EQ_Mail_Tablelist(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}		
		if(&quot;&quot; != msg ){ // 若有傳值不管是什麼(目前傳入固定字&apos;SQL&apos;), 就是讀取DB table   add by wangwei@2011/02/18
			to += &quot;;&quot; +getMialListBySQL(vFactory,tablelist);  // 
		}else{ // 原本的程式是讀取表單中的table
			if(&quot;&quot; != tablelist ){
			var fields = tablelist.split(&quot;,&quot;);
				for (var i=0; i&lt;fields.length; i++) {
					if( fields[i] != null){
					to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
					}
				}
			}			
		}			
		var cc = &quot;&quot;; 
		var subject = &quot;[工程問題執行通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Sn&quot;)+&quot;」已送審&quot;; // Mail Subject 
		var text = getAcceptMailContent_PLM(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/**
add by wangwei@2011/02/18
傳入流程參數的值讀取人員MAIL LIST
**/
function getMialListBySQL(factory,parameter){
	var vMAIL=&quot;&quot;;
	var SQL = &quot; select email  from A_PARAMETER_ITEM ITEM , A_PARAMETER_DATA DATA, MEM_GENINF MEM &quot;;
		SQL = SQL +  &quot; where ITEM.PARAMETER = DATA.PARAMETER &quot;;
		SQL = SQL +  &quot; and ITEM.ACTIVE = &apos;true&apos; &quot;;
		SQL = SQL +  &quot; and ITEM.PARAMETER = &apos;&quot;+parameter+&quot;&apos;&quot;;
		SQL = SQL +  &quot; and DATA.KEY1 = &apos;&quot;+factory+&quot;&apos;&quot;  ;	
		SQL = SQL +  &quot; and MEM .MEMID=DATA.VALUE2 and MEM.RESIGN = &apos;false&apos; &quot;;	
	try{
		var vector = Server.SQLloadValue(SQL);			
		if( vector != null){
			if (vector.size()&gt;0){
              for(var i=0;i&lt;vector.size();i++){
				 vMAIL = vMAIL +&quot;;&quot;+vector.get(i).get(&quot;email&quot;)
			  }
			}  
		}	       
	 }catch(e){
		vMail= &quot;wangwei@gce.com.tw;edison_wang@gce.com.tw&quot;;   // 有錯的話再MAIL 給自己
	}	
	return vMail;
}
/**
	For MECN
	TABLEA 內的 ID 會有 DEPID or MEMID
	DEPID 要取所有部門成員的 Email address
*/
function getMailAddressTable(dataMap,Table){
	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	try{
		var tablea = dataMap.get(Table);
		if( tablea != null &amp;&amp; tablea.size()&gt;0  ){
			for(var t=0;t&lt;tablea.size();t++){
//				var id = tablea.get(t).get(&quot;ITEM1&quot;);//DEPID or MEMID
//				if(id.startsWith(&quot;DEP&quot;) &amp;&amp; Server.getDepartment(id) != null){
//					var depname = Server.getDepartment(id).getName();
//					memset = addDepAllMemID(depname,memset);
//				}else{
					var id = tablea.get(t).get(&quot;ITEM1&quot;);//DEPID or MEMID			
					if(id.startsWith(&quot;MEM&quot;)&amp;&amp; Server.getMember(id) != null &amp;&amp; !Server.getMember(id).isResign()){
						memset.add(id);
//					}
				}				
			}
		}	
		// memset --&gt; email address
			var key = memset.iterator();
			while(key.hasNext()){
				var memid = key.next();
				if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
					emailaddress += Server.getMember(memid).getEmail() + &quot;;&quot; ;
				}
			}
	}catch(e){
		var emailaddress = Server.getMember(&quot;administrator&quot;).getEmail();  
	}
	return emailaddress;
}

 //-------------------
// 審核完成通知通知內容 For MECN
//-------------------
function getAcceptMailContent_MECN(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核通過通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容,但不能審核,若有執行上的問題與相關負責人聯絡。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何系統疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}


 //-------------------
// 審核完成通知通知內容 For PLM
//-------------------
function getAcceptMailContent_PLM(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核通過通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容,但不能審核,若有執行上的問題與相關負責人聯絡。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何系統疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}



//------------------------
// 發 mail 開啟連結用的 URL 
// n == 1 //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件 ( ie7 無法直接開 ) 
// n == 2 //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
// n == 3 //email開表單，需密碼
// n == 4 //email開表單，不需密碼
//------------------------
function getUrl(n){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           var aInstance = MyTask.getArtInstance(); 
           var dataMap = aInstance.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                     //var userName = member.getName();
                     var userName = member.getLoginID();
                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }
           return url;
}



function sendRPMail(){
	try{
	 loadLibrary(&quot;com.A.Common.Server.SendMail&quot;);
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var vURL= &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&quot;;
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var vApp_Name = dataMap.get(&quot;App_Name&quot;);
		var vSubject = dataMap.get(&quot;Subject&quot;);
		var vSubject = dataMap.get(&quot;Subject&quot;);
		var vVerify_Name = dataMap.get(&quot;Verify_Name&quot;);
		
		var vApp_ID = dataMap.get(&quot;App_ID_R&quot;);
		loadLibrary(&quot;com.gce.Common.Util&quot;);
        var ls_memt = get_ls_memt(vFactory.substr(1,4));
		var v_memid = ls_memt + vApp_ID;
		
		var vType=&quot;[通知]獎懲單內容異動&quot;+ vFactory + vApp_Name +&quot; - 獎懲單 : &quot;+ vSubject;

//		var from = Server.getMember(&quot;administrator&quot;).getEmail();  			
        var from = Server.getMember(dataMap.get(&quot;Verify_ID&quot;)).getEmail();  	
		var to = Server.getMember(v_memid).getEmail(); 	
//		var cc = &quot;irene_chang@gce.com.tw&quot;; //cc觀察用 
        var subject = vType;
		var text =  &quot;您好：&lt;br&gt;&quot;;
		text = text + &quot;&lt;p&gt;[獎懲單內容異動] &quot;+ vSubject +&quot;&lt;br&gt;&quot;;
		text = text + MyTask.name + &quot; : &quot; + vVerify_Name +&quot;&lt;br&gt;&quot;;
		text = text + &quot;HR修改了獎懲單條款或事件及証據描述詳細內容，您可直接點選以下連結察看&lt;br&gt;&quot;;
		text = text + &quot;&lt;p&gt;連結：&quot;+vURL+&quot;&lt;br&gt;&quot;;
		text = text + &quot;&lt;p&gt;此為系統自動發出！操作上有任何問題 請與資訊處-張瀚云(22714) 聯絡  &lt;br&gt;&quot;;

		var vector = new java.util.Vector();
     //taskID
	 var taskID = MyTask.getID();  
	 Server.sendHTMLMailExt(from,to,cc,subject,text,vector,taskID);  
	}catch(e){}
}
/**
 認證版號簽收單
 審查完成時發出的 mail
 用於 Server
*/
function send_Mail_Tablelist(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot; != msg ){
			var subject = &quot;[認證板完成通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[認證板完成通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_PLM(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/******************************
 認證板簽收單v2
 mail通知生管人員
 用於 Server
*******************************/
function send_Mail_AB_PC(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot; != msg ){
			var subject = &quot;[認證板簽收單v2-通知生管人員及QC]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[認證板簽收單v2-通知生管人員及QC]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_AB_MRB2(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
function send_Mail_AB_PC_(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot; != msg ){
			var subject = &quot;[認證板簽收單v2-QAE主管審核]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[認證板簽收單v2-QAE主管審核]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_AB_MRB2(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/******************************
 認證板簽收單v2
 排程比對QAE上傳檔案使用
 用於 Server
*******************************/
function send_Mail_AB_QaeUpload(MyTask,tablelist,Source_Ins,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var source_dataMap = Source_Ins.getAppDataMap();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();
		var cc = Server.getMember(&quot;MEMT1013166&quot;).getEmail(); //邱玉婷
        if(&quot;&quot; != msg){
			cc = Server.getMember(&quot;MEMT1000502&quot;).getEmail();//吳明源
        }			
		var to = &quot;&quot;; 
				
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += getMailAddressTable(dataMap,fields[i])+&quot;;&quot;;
				}
			}
		}		
		 
		if(&quot;&quot; != msg ){
			var subject = &quot;[認證板簽收單-檔案上傳逾期通知]&quot;+source_dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+source_dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[認證板簽收單-檔案上傳逾期通知]&quot;+source_dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+source_dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_AB_Upload(Source_Ins);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/******************************
 認證板簽收單v2
 排程比對新設工上傳檔案使用
 用於 Server
*******************************/
function send_Mail_AB_HdiUpload(MyTask,tablelist,Source_Ins,msg,temp){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var source_dataMap = Source_Ins.getAppDataMap();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();
		
		var to =&quot;&quot;;		
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += getMailAddressTable(dataMap,fields[i])+&quot;;&quot;;
				}
			}
		}		
		var cc= &quot;&quot;; 
		if(&quot;&quot; != msg ){
			var subject = &quot;[認證板簽收單-結案報告上傳逾期通知]&quot;+source_dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+source_dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[認證板簽收單-結案報告上傳逾期通知]&quot;+source_dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+source_dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_AB_HdiUpload(Source_Ins,temp);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/******************************
 認證板簽收單v2
 送lab測試時,mail通知mrb2長官
 用於 Server
*******************************/
function send_Mail_AB_MRB2(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot; != msg ){
			var subject = &quot;[認證板申請通知-需送lab測試]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已申請送出&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[認證板申請通知-需送lab測試]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已申請送出&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_AB_MRB2(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}

/***************************
 認證版號簽收單v2
 送lab測試時,mail通知mrb2長官
 用於 Server
***************************/
function getAcceptMailContent_AB_MRB2(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   Dear Sir: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   表單送出通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		var lab =&quot;&quot;;
		if(dataMap.get(&quot;lab_y&quot;).equals(&quot;true&quot;)){
			lab=&quot;是&quot;;
		}else{
			lab=&quot;否&quot;;
		}
		text += &quot;   需送Lab測試 : &quot;+lab +&quot;&lt;br&gt;&quot;;
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容,但不能審核,若有執行上的問題與相關負責人聯絡。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何系統疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

/***************************
 認證版號簽收單v2
 排程檢查檔案上傳用
 用於 Server
***************************/
function getAcceptMailContent_AB_Upload(Source_Ins){
	    var dataMap = Source_Ins.getAppDataMap();
		var arturl = getUrl_AB(2,Source_Ins) ;
		var text = &quot;   Dear Sir: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   檔案上傳逾期通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : 認證板簽收單檔案上傳檢查&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : 檔案未上傳檢查&lt;br&gt;&quot;;
		var lab =&quot;&quot;;
		if(dataMap.get(&quot;lab_y&quot;).equals(&quot;true&quot;)){
			lab=&quot;是&quot;;
		}else{
			lab=&quot;否&quot;;
		}
		text += &quot;   需送Lab測試 : &quot;+lab +&quot;&lt;br&gt;&quot;;
		text += &quot;   待辦收到日期 : &quot; + dataMap.get(&quot;receiveDate&quot;)  	+&quot;&lt;br&gt;&quot;;
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + dataMap.get(&quot;App_Name&quot;) 	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + dataMap.get(&quot;App_Dep&quot;)  		+&quot;&lt;br&gt;&quot;;
			//var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容,但不能審核,若有執行上的問題與相關負責人聯絡。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何系統疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}
function getAcceptMailContent_AB_HdiUpload(Source_Ins,temp){
	    var dataMap = Source_Ins.getAppDataMap();
		var arturl = getUrl_AB(2,Source_Ins) ;
		var text = &quot;   Dear Sir: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   結案報告上傳逾期通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : 認證板簽收單檔案上傳檢查&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : 檔案未上傳檢查&lt;br&gt;&quot;;
		var lab =&quot;&quot;;
		if(dataMap.get(&quot;lab_y&quot;).equals(&quot;true&quot;)){
			lab=&quot;是&quot;;
		}else{
			lab=&quot;否&quot;;
		}
		text += &quot;   需送Lab測試 : &quot;+lab +&quot;&lt;br&gt;&quot;;
		text += &quot;   待辦收到日期 : &quot; + dataMap.get(&quot;receiveDateHdi&quot;)  	+&quot;&lt;br&gt;&quot;;
		text += &quot;   認證類別 : &quot; + temp  	+&quot;&lt;br&gt;&quot;;
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + dataMap.get(&quot;App_Name&quot;) 	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + dataMap.get(&quot;App_Dep&quot;)  		+&quot;&lt;br&gt;&quot;;
			//var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容,但不能審核,若有執行上的問題與相關負責人聯絡。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何系統疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}
function getUrl_AB(n,Source_Ins){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           //var aInstance = MyTask.getArtInstance(); 
           var dataMap = Source_Ins.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ Source_Ins.getID() +&quot;&amp;readOnly=true&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                    // var userName = member.getName();
                     var userName = member.getLoginID();
					 //var userName = &quot;meiyu_lin&quot;;
                     //var temp = &quot;taskID=&quot; + &quot;Tsk000000053042&quot; + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var temp = &quot;taskID=&quot; + dataMap.get(&quot;TaskID_Wait&quot;) + &quot;&amp;userName=&quot; + dataMap.get(&quot;exeid&quot;) + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
 
					 var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }
           return url;
}

//抓取a_parameter_data參數檔人員寄發mail
function sendMailByPara_A(PARAMETER,VALUE3){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var companyID = dataMap.get(&quot;Factory&quot;).substr(1,4);
		var from = Server.getMember(&quot;administrator&quot;).getEmail(); 	
		var to = &quot;&quot;;
		var SQL =  &quot; select to_char(B.VALUE2) memid ,to_char(B.VALUE1) username ,to_char(C.RESIGN) resign&quot;;
	    	SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
			SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
			SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;				
			SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
			SQL += &quot; and B.KEY1 = &apos;&quot;+companyID+&quot;&apos;&quot;  ;	
			SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
			SQL += &quot; and C.MEMID=B.VALUE2&quot;;
			SQL += &quot; and B.VALUE3=&apos;&quot;+VALUE3+&quot;&apos;&quot;;
		try{
			var vec = Server.SQLloadValue(SQL);
			if(vec!=null &amp;&amp; vec.size()&gt;0){
				for(var i = 0; i&lt;vec.size(); i++){
					to +=Server.getMember(vec.get(i).get(&quot;memid&quot;)).getEmail()+&quot;;&quot;;
				}
			}
		}catch(e){
		}
		
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 

		var subject = &quot;[填寫批號-通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」工作已送達&quot;; // Mail Subject 

		
		var text = getAcceptMailContent_A(dataMap);
		//text +=&quot;/////&quot;+to;
		//to =&quot;edison_wang@gce.com.tw;&quot;;
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}

function getAcceptMailContent_A(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程已送達填寫批號關卡通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}
function sendMailByPara_(PARAMETER,FAC,VALUE3,subject,state){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();		 
		var from = Server.getMember(&quot;administrator&quot;).getEmail(); 	
		var to = &quot;&quot;;
		var SQL =  &quot; select to_char(B.VALUE2) memid ,to_char(B.VALUE1) username ,to_char(C.RESIGN) resign&quot;;
	    	SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
			SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
			SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;				
			SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
			SQL += &quot; and B.KEY1 = &apos;&quot;+FAC+&quot;&apos;&quot;  ;	
			SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
			SQL += &quot; and C.MEMID=B.VALUE2&quot;;
			if(VALUE3!=&quot;&quot;){
				SQL += &quot; and B.VALUE3=&apos;&quot;+VALUE3+&quot;&apos;&quot;;
			}
			
		try{
			var vec = Server.SQLloadValue(SQL);
			if(vec!=null &amp;&amp; vec.size()&gt;0){
				for(var i = 0; i&lt;vec.size(); i++){
					to +=Server.getMember(vec.get(i).get(&quot;memid&quot;)).getEmail()+&quot;;&quot;;
				}
			}
		}catch(e){
		}
		
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		var subject_txt = &quot;&quot;;
		if(state==&quot;1&quot;){
			subject_txt = subject+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject
		}
		if(state==&quot;2&quot;){
			subject_txt = subject+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」流程已結案&quot;; // Mail Subject
		}

		var text = getAcceptMailContent_(dataMap,state);
		//text +=&quot;/////&quot;+to;
		//to =&quot;edison_wang@gce.com.tw;&quot;;
        var fileList = new Packages.java.util.Vector(); 
		if(to!=&quot;&quot;){
			Server.sendHTMLMailExt(from,to,cc,subject_txt,text,fileList,MyTask);
		}
		 
	}catch(e){}
}

function getAcceptMailContent_(dataMap,state){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		if(state==&quot;1&quot;){
			text += &quot;   流程審核中通知!&lt;br&gt;&quot;;
		}
		if(state==&quot;2&quot;){
			text += &quot;   流程結案通知!&lt;br&gt;&quot;;
		}
		
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		if(state==&quot;1&quot;){
			text += &quot;   工作名稱 : &quot; + &quot;各部門主管審核&quot;  +&quot;&lt;br&gt;&quot;;
		}
		if(state==&quot;2&quot;){
			text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		}
		
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

function send_AB_Mail(dataMap){
	var class_a = dataMap.get(&quot;class_a&quot;);
	var class_b = dataMap.get(&quot;class_b&quot;);
	var type_a = dataMap.get(&quot;type_a&quot;);
	var type_b = dataMap.get(&quot;type_b&quot;);
	var type_c = dataMap.get(&quot;type_c&quot;);
	var from = Server.getMember(&quot;administrator&quot;).getEmail(); 
	var to = &quot;&quot;;
	var cc = &quot;&quot;;
	var sql = &quot;select to_char(value2) memid from a_parameter_data where parameter=&apos;AB_Mail_A&apos;&quot;;
	var vec = Server.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		for(var i =0;i&lt;vec.size();i++){
			cc += Server.getMemberByID(vec.get(i).get(&quot;memid&quot;)).getEmail()+&quot;;&quot;;
		}
	}
	cc += &quot;edison_wang@gce.com.tw;&quot;;
	
	if(class_a==&quot;true&quot;){//A級認證
		var sqla = &quot;select email from mem_geninf where resign=&apos;false&apos; and email is not null and email&lt;&gt;&apos;wtadmin&apos; and email &lt;&gt;&apos;wtadmin@gce.com.tw&apos; &quot;;
			sqla +=&quot;and (mainroleid like &apos;ROLT2G1%&apos; or mainroleid like &apos;ROLT2Q0%&apos; or mainroleid like &apos;ROLT3G2%&apos;)&quot;;
	}else{//B級認證
		var sqla = &quot;select email from mem_geninf where resign=&apos;false&apos; and email is not null and email&lt;&gt;&apos;wtadmin&apos; and email &lt;&gt;&apos;wtadmin@gce.com.tw&apos; &quot;;
			sqla +=&quot; and ( 1=2 &quot;;
		if(type_a==&quot;true&quot;){
			sqla +=&quot; or mainroleid like &apos;ROLT2G1%&apos; &quot;;
		}
		if(type_b==&quot;true&quot;){
			sqla +=&quot; or mainroleid like &apos;ROLT2Q0%&apos; &quot;;
		}
		if(type_c==&quot;true&quot;){
			sqla +=&quot; or mainroleid like &apos;ROLT3G2%&apos; &quot;;
		}
		sqla +=&quot;)&quot;;
	}
	var veca = Server.SQLloadValue(sqla);
	if(veca!=null &amp;&amp; veca.size()&gt;0){
		for(var j =0;j&lt;veca.size();j++){
			to += veca.get(j).get(&quot;email&quot;)+&quot;;&quot;;
		}
	}
	
	var roottaskname = MyTask.getRootName();	
	var subject = &quot;[通知] &quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已申請送出&quot;;
	var text = get_AB_Mail(dataMap);
	var fileList = new Packages.java.util.Vector(); 
	Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask);
}
function get_AB_Mail(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   Dear Sir: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   表單送出通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   申請人 : &quot; + dataMap.get(&quot;App_Name&quot;)  +&quot;&lt;br&gt;&quot;;
		text += &quot;   認證料號 : &quot; + dataMap.get(&quot;itemNo&quot;)  +&quot;&lt;br&gt;&quot;;		
		text += &quot;   版序 : &quot; + dataMap.get(&quot;NO&quot;)  +&quot;&lt;br&gt;&quot;;
		var type = &quot;&quot;;
		if(dataMap.get(&quot;type_n&quot;)==&quot;true&quot;){
			type +=&quot;新產品認證&amp;&quot;;
		}
		if(dataMap.get(&quot;type_t&quot;)==&quot;true&quot;){
			type +=&quot;技術認證&amp;&quot;;
		}
		if(dataMap.get(&quot;type_m&quot;)==&quot;true&quot;){
			type +=&quot;材料認證&amp;&quot;;
		}
		if(dataMap.get(&quot;type_e&quot;)==&quot;true&quot;){
			type +=&quot;電信認證&amp;&quot;;
		}
		
		text += &quot;   認證類別 : &quot; + type  +&quot;&lt;br&gt;&quot;;
		var class_ = &quot;&quot;;
		var item = &quot;&quot;;
		if(dataMap.get(&quot;class_a&quot;)==&quot;true&quot;){
			class_ +=&quot;A級認證(依一般出貨檢驗項目檢驗)&quot;;
			item = &quot;依一般出貨檢驗項目檢驗/&quot;;
		}
		if(dataMap.get(&quot;class_b&quot;)==&quot;true&quot;){
			class_ +=&quot;B級認證(僅依指定項目檢驗)&quot;;
		}
		text += &quot;   認證等級 : &quot; + class_  +&quot;&lt;br&gt;&quot;;
		
		var table2 = dataMap.get(&quot;Table2&quot;);
		if(table2!=null &amp;&amp; table2.size()&gt;0){
			for(var i = 0;i&lt;table2.size();i++){
				item += table2.get(i).get(&quot;ITEM2&quot;);
				if(table2.get(i).get(&quot;ITEM1&quot;)==&quot;chk_48&quot;){
					item += &quot;(&quot;+dataMap.get(&quot;chk_48_t&quot;)+&quot;)&quot;;
				}
				if(table2.get(i).get(&quot;ITEM1&quot;)==&quot;chk_49&quot;){
					item += &quot;(&quot;+dataMap.get(&quot;chk_49_t&quot;)+&quot;)&quot;;
				}
				if(table2.get(i).get(&quot;ITEM1&quot;)==&quot;chk_50&quot;){
					item += &quot;(&quot;+dataMap.get(&quot;chk_50_t&quot;)+&quot;)&quot;;
				}
				item +=&quot;/&quot;;
			}
		}
		
		text += &quot;   認證項目 : &quot; + item  +&quot;&lt;br&gt;&quot;;
		text += &quot;   認證期望完成日 : &quot; + dataMap.get(&quot;expecte_date&quot;)  +&quot;&lt;br&gt;&quot;;
		if(dataMap.get(&quot;report_y&quot;)==&quot;true&quot;){//出貨報告需求-是
			text += &quot;   出貨報告需求 : 是&lt;br&gt;&quot;;
		}else{
			text += &quot;   出貨報告需求 : 否&lt;br&gt;&quot;;
			text += &quot;   備註說明 : &quot; + dataMap.get(&quot;remark&quot;)  +&quot;&lt;br&gt;&quot;;
		}
			
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);			
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			
			var frontuser = Server.getMember(MyTask.getFrontUser());
					
		}catch(e){}
			text += &quot;   &lt;br&gt;&quot;;		
			text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容,但不能審核,若有執行上的問題與相關負責人聯絡。&lt;br&gt;&quot;;
			text += &quot;   &lt;br&gt;&quot;;	
			text += &quot;   &lt;br&gt;&quot;;		
			text += &quot;   若有任何系統疑問，請與資訊處連絡 &lt;br&gt;&quot;;
			text += &quot;   =================================================================== &lt;br&gt;&quot;;		
			return text;
}

function send_mecn_fmea_mail(){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
      
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
       	
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		
		
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 

        var subject = &quot;[審核完成通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過，請修改FMEA文件&quot;; // Mail Subject 
		var text = getAcceptMailContent_MECN(dataMap);
        
        var fileList = new Packages.java.util.Vector(); 
         
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}

function send_mecn_aps_epas_mail(){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var factory = dataMap.get(&quot;Factory&quot;).substr(1,4);
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
       	
		var to = &quot;&quot;; 
		
		var sql = &quot;select email from mem_geninf where mainroleid like &apos;%P5%&apos; and resign=&apos;false&apos; and areacode=&apos;&quot;+factory+&quot;&apos; and email is not null and email not like &apos;wtadmin%&apos;&quot;;
		try{
			var vec = Server.SQLloadValue(sql);
			if(vec!=null &amp;&amp; vec.size()&gt;0){
				for(var i = 0;i&lt;vec.size();i++){
					to  +=vec.get(i).get(&quot;email&quot;)+&quot;;&quot;;
				}
			}
		}catch(e){
		}
		
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;edison_wang@gce.com.tw&quot;; //cc觀察用 
		if(dataMap.get(&quot;a_e_1&quot;)==&quot;true&quot; &amp;&amp; dataMap.get(&quot;a_e_2&quot;)==&quot;true&quot;){
			var temp = &quot;勾選設備基本能力參數、線別限制&quot;;
		}else if(dataMap.get(&quot;a_e_1&quot;)==&quot;true&quot;){
			var temp = &quot;勾選設備基本能力參數&quot;;
		}else{
			var temp = &quot;勾選影響設備&quot;;		
		}
		

        var subject = &quot;[審核完成通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過(&quot;+temp+&quot;)&quot;; // Mail Subject 
		var text = getAcceptMailContent_MECN(dataMap);
        
        var fileList = new Packages.java.util.Vector(); 
         
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00091250755035097</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/09/16 15:59:15</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Client.APUtil</string> 
     </void> 
     <void property="id"> 
      <string>SCL00091250755035097</string> 
     </void> 
     <void property="name"> 
      <string>APUtil</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091250755035083</string> 
     </void> 
     <void property="scriptSource"> 
      <string>



//========================================================================================
// 取出從今天算起的日期
//========================================================================================
function getDateSinceNow(diff){
	var myDate = new Packages.pase.agenda.MyDate();
	var currDate = myDate.getCurrentDate();	
	var aDate = myDate.add(currDate,diff);
	return aDate;
}
//========================================================================================
// 取出本月月初的日期
//========================================================================================
function getBeginDateByThisMonth(){
	var myDate = new Packages.pase.agenda.MyDate();
	var currDate = myDate.getCurrentDate();
	var sDate = currDate.substring(0,8) + &quot;01&quot;;
	return sDate;
}
//========================================================================================
// 取出本月月底的日期
//========================================================================================
function getEndDateByThisMonth(){
	var cal = new Packages.java.util.Calendar.getInstance();
	var lastday = cal.getActualMaximum(Packages.java.util.Calendar.DATE);
	var myDate = new Packages.pase.agenda.MyDate();
	var currDate = myDate.getCurrentDate();
	var eDate = currDate.substring(0,8) + lastday;
	return eDate;
}
//========================================================================================
// 取出上月月底的日期
//========================================================================================
function getEndDateByLastMonth(){
	var myDate = new Packages.pase.agenda.MyDate();
	var currDate = myDate.getCurrentDate();	
	var diff    = myDate.getCurrentDay()*(-1);
	var eDate = myDate.add(currDate,diff);
	return eDate;
}
//========================================================================================
// 取出上月月初的日期
//========================================================================================
function getBeginDateByLastMonth(){
	var eDate = getEndDateByLastMonth();
	var sDate = eDate.substring(0,8) + &quot;01&quot;;
	return sDate;
}
//========================================================================================
// 設定畫面查詢條件
//========================================================================================
function setUIDateRange(sDate,eDate){
	Form.setValue(&quot;ckbSDate&quot;,true);
	Form.setValue(&quot;ckbEDate&quot;,true);
	Form.setValue(&quot;sDate&quot;,sDate);
	Form.setValue(&quot;eDate&quot;,eDate);
}





//========================================================================================
//  ISO文件生效查詢單
//========================================================================================
function setResultTableByISOArt() {
	
	try{
		
		var sql = &quot;SELECT * FROM ART00701190304871812_INS&quot; +
		&quot; WHERE ITEM16 != &apos;null&apos; &quot; + getQueryCondition() + &apos; ORDER BY ITEM16&apos;;
		var vec = Client.SQLloadValue(sql);
	}catch(e){
				
	}
			

	var table = Form.getComponent(&quot;ResultTable&quot;);	
	table.clear();
	if (vec.size()&gt;0) {
		for (var i = 0; i &lt; vec.size(); i++) {
			var hm = vec.get(i);
			table.newRow();
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				table.setValueAt(task.getProcessName(),   i, &quot;目前關卡&quot;);
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				table.setValueAt(memberRecord.getName(),  i, &quot;目前處理者&quot;);
				//table.setValueAt(getPriorityString(task), i, &quot;緊急程度&quot;);
			}
			table.setValueAt((i + 1) + &quot;&quot;, i, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ITEM16&quot;),     	i, &quot;表單編號&quot;);
			table.setValueAt(hm.get(&quot;ITEM186&quot;), 	i, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;ITEM24&quot;),  	i, &quot;申請人姓名&quot;);
			table.setValueAt(hm.get(&quot;ITEM141&quot;),   	i, &quot;填寫日期&quot;);			
			table.setValueAt(hm.get(&quot;ITEM106&quot;),   	i, &quot;文件標題&quot;);
			table.setValueAt(hm.get(&quot;ITEM39&quot;),  	i, &quot;文件類別&quot;);
			table.setValueAt(hm.get(&quot;INSID&quot;),   	i, &quot;InsID&quot;);
			
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}

}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00101108379793777</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/04/25 16:37:29</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.SystemFunction.NumberFormat</string> 
     </void> 
     <void property="id"> 
      <string>SCL00101108379793777</string> 
     </void> 
     <void property="name"> 
      <string>NumberFormat</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//將數字中的千分位去除
//以字串格式傳回
function removeNumberComma(orgNum){
	//var runDate = new Packages.pase.agenda.MyDate();
	//java.lang.System.out.println(&quot;Start [removeNumberComma] &quot;+ runDate.getCurrentDate(&quot;Y/M/D:H:m:S&quot;));
	
	var num = java.lang.String.valueOf(orgNum).trim();
	//去掉字串中的逗號部份
	var len = num.length();
	var sb = new java.lang.StringBuffer();
	for (var i = 0; i &lt; len; i++) {
		//var theChar = num.charAt(i);   //會變成數字
		var theChar = num.substring(i,i+1);
		if(theChar != &apos;,&apos;)
			sb.append(theChar);
	}
	
	//java.lang.System.out.println(&quot;End [removeNumberComma] &quot;+ runDate.getCurrentDate(&quot;Y/M/D:H:m:S&quot;));
	return sb.toString();
}

//將數字加入千分位符號
//以字串格式傳回
function restoreNumberComma(orgNum){
	//先去除可能已有的千分位符號
	//var runDate = new Packages.pase.agenda.MyDate();
	//java.lang.System.out.println(&quot;Start [restoreNumberComma] &quot;+ runDate.getCurrentDate(&quot;Y/M/D:H:m:S&quot;));

	
	var target = removeNumberComma(orgNum);
	var dotIndex = target.indexOf(&quot;.&quot;);
	var afterDot = &quot;&quot;; //小數點部份
	if(dotIndex != -1){
		afterDot = target.substring(dotIndex);
		target = target.substring(0, dotIndex);
	}
	
	//每隔三位加一千分位符號
	var count = 0;
	var len = target.length();
	var result = new java.lang.StringBuffer();
	for(var i = len-1; i &gt;= 0 ; i--){
		if(count == 3){
			result.insert(0,&quot;,&quot;);
			count = 0;
		}
		
		//result.append(target.charAt(i));   //使用 charAt() 會變成數字
		result.insert(0,target.substring(i,i+1));

		count++;
	}
	result.append(afterDot);
	
	//java.lang.System.out.println(&quot;End [restoreNumberComma] &quot;+ runDate.getCurrentDate(&quot;Y/M/D:H:m:S&quot;));

	return result.toString();
}

//將傳入的表單欄位值轉成數字 Integer
//小數部份四捨伍入
function StringToInteger(valueStr){
	
	//var runDate = new Packages.pase.agenda.MyDate();
	//java.lang.System.out.println(&quot;Start [StringToInteger] &quot;+ runDate.getCurrentDate(&quot;Y/M/D:H:m:S&quot;));
	
	var result = null;
	try{
		//先去除千分位符號
		valueStr = removeNumberComma(valueStr);
		//若有小數要四捨五入
		var dotIndex = valueStr.indexOf(&quot;.&quot;);
		if(dotIndex != -1){
			var floatValue = java.lang.Float.parseFloat(valueStr);
			var intValue = java.lang.Math.round(floatValue);
			result = new java.lang.Integer(intValue);
		}else{
			//沒有小數則直接產生 Integer 物件
			result = new java.lang.Integer(valueStr);
		}
	}catch(e){
		//有錯誤時一律傳回 null
		java.lang.System.out.println(e);
		result = null;
	}

	//java.lang.System.out.println(&quot;End [StringToInteger] &quot;+ runDate.getCurrentDate(&quot;Y/M/D:H:m:S&quot;));
	return result;
}

//傳入String，捨小數點後位數
function getInt(abc){
	var abcInt = &quot;&quot;;
	var st = new java.util.StringTokenizer(abc, &quot;.&quot;);
    if (st.hasMoreTokens()) {
		abcInt = st.nextToken();
    }
    return abcInt;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>有關數字格式的函數</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00101157982483921</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/09/11 21:48:03</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ECN.AddASAudit</string> 
     </void> 
     <void property="id"> 
      <string>SCL00101157982483921</string> 
     </void> 
     <void property="name"> 
      <string>AddASAudit</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031157709081640</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

//設定會簽人員 from table
function addAddASAudit(sign_table,itemid){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var vac = dataMap.get(sign_table);
	if(vac.size()&gt;0){
		MyTask.setExecuteAddAS(true);
		MyTask.setAddASType(MyTask.ADD_PARALLEL_ANNOUNCE);
		//MyTask.addAddASAudit(&quot;MEM01619&quot;,&quot;ROLH010ACF&quot;,&quot;DEPH010A&quot;);
                    for(var i = 0;i&lt; vac.size();i++){
                                try{
                                           var username = vac.get(i).get(itemid);
                                           var member = Server.getMember(username);
                                           if(member != null){
                                                     var roleid = member.getMainRoleID();
                                                     if(roleid == &apos;&apos;){
                                                                var rolelist = member.getRoleList()
					                        if(rolelist.size()&gt;0){
						                            var memberdr = rolelist.get(0);
						                            roleid = memberdr.getRoleID();
						                            var depid = memberdr. getDepartmentID();
                                                                           MyTask.addAddASAudit(member.getID(),roleid ,depid);

   						                     }

                                                     }

                                           }

                                }catch(e){}

                     }
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00101233886524113</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/03/01 18:03:32</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Client.addAsignTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00101233886524113</string> 
     </void> 
     <void property="name"> 
      <string>addAsignTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021229049977055</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/*
TGCE OP主管Sign_MemberTable_T_OPM
TGCE OP工程師Sign_MemberTable_T_OP
TGCE QAE(Local)Sign_MemberTable_T_QA
TGCE QAE(QA)Sign_MemberTable_T_QAE
TGCE QCSign_MemberTable_T_QC
TGCE PMSign_MemberTable_T_PM
TGCE CSSign_MemberTable_T_CS
PE處級主管Sign_MemberTable_PE_HEAD
ME 經副理Sign_MemberTable_T_ME
ME處級主管Sign_MemberTable_ME_HEAD
Parameters:companyID=公司代碼;PARAMETER=角色代碼;Sign_MemberTable=暫存表單;clear_Table=清除TABLE資料
com.gce.PLM.MAN.addAsignTable  &gt;&gt;server Script也有同樣Script,但資料會有Lose的情況~~
*/


// 設定會簽人員function
function addAsignList(companyID,PARAMETER,Sign_MemberTable){
	var SignTable = Form.getComponent(Sign_MemberTable);
	var SignTable_G = Form.getComponent(Sign_MemberTable + &quot;_G&quot;);
		var SQL =    &quot; select VALUE2 memid ,VALUE1 username ,RESIGN  from A_PARAMETER_ITEM , A_PARAMETER_DATA, MEM_GENINF &quot;;
		SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
		SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 = &apos;&quot;+companyID+&quot;&apos;&quot;  ;	
		SQL = SQL +  &quot; and MEM_GENINF .MEMID=A_PARAMETER_DATA.VALUE2&quot;;
	var vec = Client.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Client.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Client.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
			    //離職人員判斷，若離職則轉單至ADM
				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;
			    }else{
					 var Dauble_flag = memisDauble(SignTable,memid) ;	
					 var cmemid = &quot;PDM&quot; ;	 
				}//if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;)

				if(Dauble_flag != &quot;Y&quot;){
				   var row = SignTable.newRow()-1;
				   SignTable.setValueAt(cmemid,row,&quot;memid&quot;);
				   SignTable.setValueAt(cMember,row,&quot;cname&quot;);
			       SignTable.setValueAt(dptcname,row,&quot;dptno&quot;);	
			       SignTable.setValueAt(memDR,row,&quot;jobtitle&quot;);			 
			       SignTable.setValueAt(companyID+PARAMETER,row,&quot;groupid&quot;);
				   var new_record =&quot;Y&quot; ;
				}
			
			 }//for
			//寫入會簽群組Table，子流程使用
			if (new_record == &quot;Y&quot;){
			    if (SignTable_G != null){
	      	        var row1 = SignTable_G.newRow()-1;	
			        SignTable_G.setValueAt(companyID+PARAMETER,row1,&quot;groupid&quot;);
		        }	
		    }		
		}else{
		     Form.showMessageDialog(companyID+&quot;_&quot;+PARAMETER+&quot;沒有設定會簽人員!&quot;+memid);
		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Form.setComplete(false);
		Form.showMessageDialog(&quot;讀取參數檔失敗!請與系統負責聯絡!!\n&quot;+SQL+memid);
	}
}//function addAsignList

function addAsignList_temp(companyID,PARAMETER,Sign_MemberTable,temp){
	var SignTable = Form.getComponent(Sign_MemberTable);
	var SignTable_G = Form.getComponent(Sign_MemberTable + &quot;_G&quot;);
		var SQL =    &quot; select VALUE2 memid ,VALUE1 username ,RESIGN  from A_PARAMETER_ITEM , A_PARAMETER_DATA, MEM_GENINF &quot;;
		SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
		SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 = &apos;&quot;+companyID+&quot;&apos;&quot;  ;	
        SQL = SQL +  &quot; and VALUE3 like &apos;%&quot; + temp + &quot;%&apos; &quot;;		
		SQL = SQL +  &quot; and MEM_GENINF .MEMID=A_PARAMETER_DATA.VALUE2&quot;;
	var vec = Client.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Client.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Client.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
			    //離職人員判斷，若離職則轉單至ADM
				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;
			    }else{
					 var Dauble_flag = memisDauble(SignTable,memid) ;	
					 var cmemid = &quot;PDM&quot; ;	 
				}//if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;)

				if(Dauble_flag != &quot;Y&quot;){
				   var row = SignTable.newRow()-1;
				   SignTable.setValueAt(cmemid,row,&quot;memid&quot;);
				   SignTable.setValueAt(cMember,row,&quot;cname&quot;);
			       SignTable.setValueAt(dptcname,row,&quot;dptno&quot;);	
			       SignTable.setValueAt(memDR,row,&quot;jobtitle&quot;);			 
			       SignTable.setValueAt(companyID+PARAMETER,row,&quot;groupid&quot;);
				   var new_record =&quot;Y&quot; ;
				}
			
			 }//for
			//寫入會簽群組Table，子流程使用
			if (new_record == &quot;Y&quot;){
			    if (SignTable_G != null){
	      	        var row1 = SignTable_G.newRow()-1;	
			        SignTable_G.setValueAt(companyID+PARAMETER,row1,&quot;groupid&quot;);
		        }	
		    }		
		}else{
		     Form.showMessageDialog(companyID+&quot;_&quot;+PARAMETER+&quot;沒有設定會簽人員!&quot;+memid);
		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Form.setComplete(false);
		Form.showMessageDialog(&quot;讀取參數檔失敗!請與系統負責聯絡!!\n&quot;+SQL+memid);
	}
}//function addAsignList

function addAsignCustomer(companyID,PARAMETER,Sign_MemberTable,item_no){ 
//PLM PM CS角色
		var SignTable = Form.getComponent(Sign_MemberTable);	
		var SignTable_G = Form.getComponent(Sign_MemberTable + &quot;_G&quot;);
		var SQL =    &quot; select VALUE2 memid ,VALUE1 username ,RESIGN from A_PARAMETER_ITEM , A_PARAMETER_DATA , MEM_GENINF &quot;;
		SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 in (&apos;&quot;+ companyID +&quot;&apos;) &quot;  ;	
		SQL = SQL +  &quot; and A_PARAMETER_DATA.VALUE3 LIKE &apos;%&quot;+ item_no +&quot;%&apos; &quot;  ;
		SQL = SQL +  &quot; and MEM_GENINF .MEMID=A_PARAMETER_DATA.VALUE2&quot;;
		
  var vec = Client.SQLloadValue(SQL);
  try{			
    if ( vec != null ){
	   if (vec.size()&gt;0){
		   var new_record =&quot;&quot;;
		  for(var i=0;i&lt;vec.size();i++)  {
			  var ht = vec.get(i);
			  var memid = ht.get(&quot;memid&quot;)
			  var cMember = Client.getMemberByID(memid);			  
			  if(cMember == null){
              // 檢核員工是否是有效的,若無效基本上會傳給PDM , 
				memid = &quot;MEMPDM0001&quot;  	
				var cMember = Client.getMemberByID(memid);
			  }		  
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);		  
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  
			  //離職人員判斷，若離職則轉單至ADM
				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;
			    }else{
					 var Dauble_flag = memisDauble(SignTable,memid) ;	
					 var cmemid = &quot;PDM&quot; ;	 
				}//if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;)

				if(Dauble_flag != &quot;Y&quot;){
				   var row = SignTable.newRow()-1;
				   SignTable.setValueAt(cmemid,row,&quot;memid&quot;);
				   SignTable.setValueAt(cMember,row,&quot;cname&quot;);
			       SignTable.setValueAt(dptcname,row,&quot;dptno&quot;);	
			       SignTable.setValueAt(memDR,row,&quot;jobtitle&quot;);			 
			       SignTable.setValueAt(companyID+PARAMETER,row,&quot;groupid&quot;);				   
				   var new_record =&quot;Y&quot; ;
				}
			
			 }//for
			//寫入會簽群組Table，子流程使用
			if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble_G(SignTable_G,companyID+PARAMETER) ;
				
				if(Dauble_flag_G != &quot;Y&quot;){
			       if (SignTable_G != null){
	      	           var row1 = SignTable_G.newRow()-1;	
			           SignTable_G.setValueAt(companyID+PARAMETER,row1,&quot;groupid&quot;);
		           }
			    }
		    }		
			  
			  //離職人員判斷，若離職則轉單至ADM
//				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
//					SignTable.setValueAt(memid,row,&quot;memid&quot;);
//			    }else{SignTable.setValueAt(&quot;Administrator&quot;,row,&quot;memid&quot;);}
//				
//			 	SignTable.setValueAt(cMember,row,&quot;cname&quot;);
//			    SignTable.setValueAt(dptcname,row,&quot;dptno&quot;);	
//			    SignTable.setValueAt(memDR,row,&quot;jobtitle&quot;);					 
//			    SignTable.setValueAt(companyID+PARAMETER,row,&quot;groupid&quot;);
//			 }
//			if (SignTable_G != null){
//	      	var row1 = SignTable_G.newRow()-1;	
//			SignTable_G.setValueAt(companyID+PARAMETER,row1,&quot;groupid&quot;);
//		    }

			
			
			
		  }else{
                 var item_no=&quot;ALL&quot;;
		         var SQL_1  = &quot; select VALUE2 memid ,VALUE1 username ,RESIGN from A_PARAMETER_ITEM , A_PARAMETER_DATA , MEM_GENINF &quot;;
		             SQL_1 += &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
		             SQL_1 += &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
		             SQL_1 += &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		             SQL_1 += &quot; and A_PARAMETER_DATA.KEY1 in (&apos;&quot;+ companyID +&quot;&apos;) &quot;  ;	
		             SQL_1 += &quot; and A_PARAMETER_DATA.VALUE3 LIKE &apos;%&quot;+ item_no +&quot;%&apos; &quot;  ;
		             SQL_1 += &quot; and MEM_GENINF .MEMID=A_PARAMETER_DATA.VALUE2&quot;;
		
 	             var vec_1 = Client.SQLloadValue(SQL_1);
				 
				 if (vec_1.size()&gt;0){
		             for(var i=0;i&lt;vec_1.size();i++)  {			 
			             var ht = vec_1.get(i);
			             var memid = ht.get(&quot;memid&quot;)
			             var cMember = Client.getMemberByID(memid);			  
					 
			             if(cMember == null){
                            // 檢核員工是否是有效的,若無效基本上會傳給PDM , 
				            memid = &quot;MEMPDM0001&quot; 
				            var cMember = Client.getMemberByID(memid);
			             }
			               var roleID = cMember.getMainRoleID();
			               var memDR =  cMember.getMemberDR(roleID);		  
			               var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			               var row = SignTable.newRow()-1;
			  
			               //離職人員判斷，若離職則轉單至ADM
				           if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					           SignTable.setValueAt(memid,row,&quot;memid&quot;);
			               }else{
						       SignTable.setValueAt(&quot;MEMPDM0001&quot;,row,&quot;memid&quot;);
						   }
				
			 	           SignTable.setValueAt(cMember,row,&quot;cname&quot;);
			               SignTable.setValueAt(dptcname,row,&quot;dptno&quot;);	
			               SignTable.setValueAt(memDR,row,&quot;jobtitle&quot;);					 
	              	       SignTable.setValueAt(companyID+PARAMETER,row,&quot;groupid&quot;);
			         }			
			         if (SignTable_G != null){
	      	             var row1 = SignTable_G.newRow()-1;	
			             SignTable_G.setValueAt(companyID+PARAMETER,row1,&quot;groupid&quot;);
		             }
				}else{	
			          Form.showMessageDialog(companyID+&quot;_&quot;+PARAMETER+&quot;沒有設定會簽人員!&quot;);
		       } //if (vec_1.size()&gt;0)  
		  }//if (vec.size()&gt;0)	  
	}//if ( vec != null )
  }catch(e){
		Form.setComplete(false);
		Form.showMessageDialog(&quot;讀取參數檔失敗!請與系統負責聯絡!!\n&quot;+SQL);
 }		

}//function addAsignCustomer

// 設定會簽人員function
function addAsign_MECN_MFG(companyID,PARAMETER,Sign_MemberTable,select_factory){
	var SignTable = Form.getComponent(Sign_MemberTable);
	var SignTable_G = Form.getComponent(Sign_MemberTable + &quot;_G&quot;);
		var SQL =    &quot; select VALUE2 memid ,VALUE1 username ,RESIGN  from A_PARAMETER_ITEM , A_PARAMETER_DATA, MEM_GENINF &quot;;
		SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
		SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 not in (&quot;+ select_factory +&quot;)&quot;  ;	
		SQL = SQL +  &quot; and MEM_GENINF .MEMID=A_PARAMETER_DATA.VALUE2&quot;;
	var vec = Client.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Client.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Client.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
			    //離職人員判斷，若離職則轉單至ADM
				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;
			    }else{
					 var Dauble_flag = memisDauble(SignTable,memid) ;	
					 var cmemid = &quot;PDM&quot; ;	 
				}//if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;)

				if(Dauble_flag != &quot;Y&quot;){
				   var row = SignTable.newRow()-1;
				   SignTable.setValueAt(cmemid,row,&quot;memid&quot;);
				   SignTable.setValueAt(cMember,row,&quot;cname&quot;);
			       SignTable.setValueAt(dptcname,row,&quot;dptno&quot;);	
			       SignTable.setValueAt(memDR,row,&quot;jobtitle&quot;);			 
			       SignTable.setValueAt(companyID+cmemid,row,&quot;groupid&quot;);   
			    //寫入會簽群組Table，子流程使用
                if (SignTable_G != null){
	      	        var row1 = SignTable_G.newRow()-1;	
			        SignTable_G.setValueAt(companyID+cmemid,row1,&quot;groupid&quot;);
		        }	
			   }	
			 }//for

		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Form.setComplete(false);
		Form.showMessageDialog(&quot;讀取參數檔失敗!請與系統負責聯絡!!\n&quot;+SQL+memid);
	}
}//function addAsign_MECN_MFG
function addAsign_ECN(companyID,PARAMETER,Sign_MemberTable,item_no){ 
//PLM PM CS角色
		var SignTable = Form.getComponent(Sign_MemberTable);	
		var SignTable_G = Form.getComponent(Sign_MemberTable + &quot;_G&quot;);
		var SQL =    &quot; select VALUE2 memid ,VALUE1 username ,RESIGN from A_PARAMETER_ITEM , A_PARAMETER_DATA , MEM_GENINF &quot;;
		SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 in (&apos;&quot;+ companyID +&quot;&apos;) &quot;  ;	
		SQL = SQL +  &quot; and A_PARAMETER_DATA.VALUE3 LIKE &apos;&quot;+ item_no +&quot;%&apos; &quot;  ;
		SQL = SQL +  &quot; and MEM_GENINF .MEMID=A_PARAMETER_DATA.VALUE2&quot;;
		
  var vec = Client.SQLloadValue(SQL);
  try{			
    if ( vec != null ){
	   if (vec.size()&gt;0){
		   var new_record =&quot;&quot;;
		  for(var i=0;i&lt;vec.size();i++)  {
			  var ht = vec.get(i);
			  var memid = ht.get(&quot;memid&quot;)
			  var cMember = Client.getMemberByID(memid);			  
			  if(cMember == null){
              // 檢核員工是否是有效的,若無效基本上會傳給PDM , 
				memid = &quot;MEMPDM0001&quot; 	
				var cMember = Client.getMemberByID(memid);
			  }		  
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);		  
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  
			  //離職人員判斷，若離職則轉單至ADM
				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;
			    }else{
					 var Dauble_flag = memisDauble(SignTable,memid) ;	
					 var cmemid = &quot;PDM&quot; ;	 
				}//if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;)

				if(Dauble_flag != &quot;Y&quot;){
				   var row = SignTable.newRow()-1;
				   SignTable.setValueAt(cmemid,row,&quot;memid&quot;);
				   SignTable.setValueAt(cMember,row,&quot;cname&quot;);
			       SignTable.setValueAt(dptcname,row,&quot;dptno&quot;);	
			       SignTable.setValueAt(memDR,row,&quot;jobtitle&quot;);			 
			       SignTable.setValueAt(companyID+&quot;PLM&quot;+item_no,row,&quot;groupid&quot;);				   
				   var new_record =&quot;Y&quot; ;
				}
			
			 }//for
			//寫入會簽群組Table，子流程使用
	        if (SignTable_G != null){
			  if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble_G(SignTable_G,companyID+&quot;PLM&quot;+item_no) ;
				  if(Dauble_flag_G != &quot;Y&quot;){
	      	           var row1 = SignTable_G.newRow()-1;	
			           SignTable_G.setValueAt(companyID+&quot;PLM&quot;+item_no,row1,&quot;groupid&quot;);
		          }
			  }
		    }		
		  }
	}//if ( vec != null )
  }catch(e){
		Form.setComplete(false);
		Form.showMessageDialog(&quot;讀取參數檔失敗!請與系統負責聯絡!!\n&quot;+SQL);
 }		
}//function addAsign_ECN

function memisDauble(table,memid){
        var flag =&quot;&quot;;
		for(var j = 0;j&lt;table.getRowCount();j++){
			if(table.getValueAt(j,&quot;memid&quot;).equals(memid)){
		 		var flag =&quot;Y&quot;;
			}
		}
		return flag ;		
}//function memisDauble

function memisDauble_G(table,groupid){
        var flag =&quot;&quot;;
		for(var j = 0;j&lt;table.getRowCount();j++){
			if(table.getValueAt(j,&quot;groupid&quot;).equals(groupid)){
		 		var flag =&quot;Y&quot;;
			}
		}
		return flag ;		
}//function memisDauble

function addAsign_DEP_FC_MAX(companyID,PARAMETER,Sign_MemberTable){ 
//PLM角色  ME最高主管  ex:高國明 廠長
//		Form.showMessageDialog(&quot;addAsign_DEP_FC_MAX&quot;);
	var SignTable = Form.getComponent(Sign_MemberTable);	
	var SignTable_G = Form.getComponent(Sign_MemberTable + &quot;_G&quot;);
	if( Form.getValue(&quot;design-t&quot;) == &quot;true&quot;){	
			var Depart_ID = &quot;DEPT2P0&quot;
			var Department = Client.getDepartment(Depart_ID); // 取得部門物件
			var v_jobtitle = &quot;T_FC_MAX&quot;;
		}
	else if( Form.getValue(&quot;design-s&quot;) == &quot;true&quot;){
			var Depart_ID = &quot;DEPS6P0&quot;
			var Department = Client.getDepartment(Depart_ID); // 取得部門物件		
            var v_jobtitle = &quot;S_FC_MAX&quot;;			
			}
	else if( Form.getValue(&quot;design-c&quot;) == &quot;true&quot;){
			var Depart_ID = &quot;DEPC8P0&quot;
			var Department = Client.getDepartment(Depart_ID); // 取得部門物件	
            var v_jobtitle = &quot;C_FC_MAX&quot;;				
		}
	else if( Form.getValue(&quot;design-h&quot;) == &quot;true&quot;){
			var Depart_ID = &quot;DEPH5P0&quot;
			var Department = Client.getDepartment(Depart_ID); // 取得部門物件	
            var v_jobtitle = &quot;H_FC_MAX&quot;;				
	}
	
	  if(Department != null){
		 var memid = Department.getManagerID() ;

		 var SQL =    &quot; select RESIGN from mem_geninf where memid =&apos;&quot;+ memid +&quot;&apos;&quot;;
	     var vec = Client.SQLloadValue(SQL);			
		   if ( vec != null &amp;&amp; vec.size()&gt;0){
				 for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			       if(memid== null){
                       // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				       memid = &quot;MEMPDM0001&quot;  
			       }
				  var cMember = Client.getMemberByID(memid);
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
			    //離職人員判斷，若離職則轉單至ADM
				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var cmemid = memid ;
			    }else{
					 var cmemid = &quot;PDM&quot; ;	 
				}//if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;)
		      var Dauble_flag = memisDauble(SignTable,memid) ;	
	          if(Dauble_flag != &quot;Y&quot;){	
				   var row = SignTable.newRow()-1;
				   SignTable.setValueAt(cmemid,row,&quot;memid&quot;);
				   SignTable.setValueAt(cMember,row,&quot;cname&quot;);
			       SignTable.setValueAt(dptcname,row,&quot;dptno&quot;);	
			       SignTable.setValueAt(memDR,row,&quot;jobtitle&quot;);			 
			       SignTable.setValueAt(companyID+PARAMETER,row,&quot;groupid&quot;);			
			    if (SignTable_G != null){
	      	    var row1 = SignTable_G.newRow()-1;	
			       SignTable_G.setValueAt(companyID+PARAMETER,row1,&quot;groupid&quot;);
               }
			 }  
		   }	
		  }//for
		}

	}

function addAsign_DEP_VP_MAX(companyID,PARAMETER,Sign_MemberTable){ 
//VP
	var SignTable = Form.getComponent(Sign_MemberTable);	
	var SignTable_G = Form.getComponent(Sign_MemberTable + &quot;_G&quot;);
	
	if( Form.getValue(&quot;design-t&quot;) ==  &quot;true&quot; ){	
	}
    if( Form.getValue(&quot;design-s&quot;) ==  &quot;true&quot; ){
	  var memid = &quot;MEMS1025668&quot;  // 先設給    		
	  var Dauble_flag = memisDauble(SignTable,memid) ;			
	  if(Dauble_flag != &quot;Y&quot;){	
		var cMember = Client.getMemberByID(memid);				  
		var row = SignTable.newRow()-1;
			SignTable.setValueAt(&quot;林志濤&quot;,row,&quot;cname&quot;);
		    SignTable.setValueAt(memid,row,&quot;memid&quot;);	
			SignTable.setValueAt(&quot;S_VP_MAX&quot;,row,&quot;jobtitle&quot;);
			SignTable.setValueAt(companyID+PARAMETER,row,&quot;groupid&quot;);					
				
		if (SignTable_G != null){
	     	 var row1 = SignTable_G.newRow()-1;	
			 SignTable_G.setValueAt(companyID+PARAMETER,row1,&quot;groupid&quot;);
		}
	 }				
	}
	if( Form.getValue(&quot;design-c&quot;) == &quot;true&quot; ){
	 var memid = &quot;MEMC1043983&quot;  // 先設給 	
	 var Dauble_flag = memisDauble(SignTable,memid) ;	
	  if(Dauble_flag != &quot;Y&quot;){   
		 var cMember = Client.getMemberByID(memid);				  
		 var row = SignTable.newRow()-1;
			 SignTable.setValueAt(&quot;董憲卿&quot;,row,&quot;cname&quot;);
			 SignTable.setValueAt(memid,row,&quot;memid&quot;);	
			 SignTable.setValueAt(&quot;C_VP_MAX&quot;,row,&quot;jobtitle&quot;);
			 SignTable.setValueAt(companyID+PARAMETER,row,&quot;groupid&quot;);	
		 if (SignTable_G != null){
	      	 var row1 = SignTable_G.newRow()-1;	
			 SignTable_G.setValueAt(companyID+PARAMETER,row1,&quot;groupid&quot;);
		}
	  }		 
	}
	if( Form.getValue(&quot;design-h&quot;) == &quot;true&quot; ){
	  var memid = &quot;MEMT1019244&quot;  // 先設給  		
	  var Dauble_flag = memisDauble(SignTable,memid) ;		  
 	   if(Dauble_flag != &quot;Y&quot;){
		  var cMember = Client.getMemberByID(memid);				  
		  var row = SignTable.newRow()-1;
			  SignTable.setValueAt(&quot;邱三雄&quot;,row,&quot;cname&quot;);
			  SignTable.setValueAt(memid,row,&quot;memid&quot;);	
			  SignTable.setValueAt(&quot;H_VP_MAX&quot;,row,&quot;jobtitle&quot;);
			  SignTable.setValueAt(companyID+PARAMETER,row,&quot;groupid&quot;);	
		 if (SignTable_G != null){
	      	 var row1 = SignTable_G.newRow()-1;	
			 SignTable_G.setValueAt(companyID+PARAMETER,row1,&quot;groupid&quot;);
		 }
	  }	 
   }
}	


//PE/ME最高主管(ALL)   ex:湯智彬
function addAsign_DEP_PE_ME_MAX(companyID,PARAMETER,Sign_MemberTable){
//PLM角色
	var SignTable = Form.getComponent(Sign_MemberTable);	
	var SignTable_G = Form.getComponent(Sign_MemberTable + &quot;_G&quot;);	
//#DEPT2J0 #DEPT2J2 #DEPT2J5  yes都Run
	if( &quot;true&quot;==Form.getValue(&quot;design-t&quot;) ){	
		for(var i=0;i&lt;6;i++){	
				if( i == 1 || i == 3 || i == 4 ){				
					continue ;
				}
				var Depart_ID = &quot;DEPT2J&quot;+i							 
				var Department = Client.getDepartment(Depart_ID); // 取得部門物件				
				if(Department != null){
					var memid = Department.getManagerID() ;
					var Member = Client.getMemberByID(memid);					
					var username = Member.getName(); 				
					var row = SignTable.newRow()-1;
					SignTable.setValueAt(username,row,&quot;cname&quot;);
					SignTable.setValueAt(memid,row,&quot;memid&quot;);	
					SignTable.setValueAt(&quot;T_PE_MAX&quot;,row,&quot;jobtitle&quot;);	
				    SignTable.setValueAt(&quot;T_PE_MAX&quot;,row,&quot;groupid&quot;);		
		   }
		}
		 if (SignTable_G != null){
	      	 var row1 = SignTable_G.newRow()-1;	
			 SignTable_G.setValueAt(&quot;T_PE_MAX&quot;,row1,&quot;groupid&quot;);
		}	
	}
//	if( &quot;true&quot;==Form.getValue(&quot;design-t&quot;) ){
//		memid = &quot;MEMT1001852&quot;  // 先設給001852	    
//		var cMember = Client.getMemberByID(memid);			
//		var row = SignTable.newRow()-1;
//		SignTable.setValueAt(&quot;許朝政&quot;,row,&quot;cname&quot;);
//		SignTable.setValueAt(memid,row,&quot;memid&quot;);	
//		SignTable.setValueAt(&quot;T_PE_MAX&quot;,row,&quot;jobtitle&quot;);
//	}				
	//#DEPS6J0 #DEPS6J1 #DEPS6J2
	if( &quot;true&quot;==appDataMap.get(&quot;design-s&quot;)  ){
		for(var i=0;i&lt;3;i++){	
			var Depart_ID = &quot;DEPS6J&quot;+i
			var Department = Client.getDepartment(Depart_ID);			
			if(Department != null){
				var memid = Department.getManagerID() ;
				var Member = Client.getMemberByID(memid);				
				var username = Member.getName(); 
					var row = SignTable.newRow()-1;
					SignTable.setValueAt(username,row,&quot;cname&quot;);
					SignTable.setValueAt(memid,row,&quot;memid&quot;);	
					SignTable.setValueAt(&quot;S_PE_MAX&quot;,row,&quot;jobtitle&quot;);
				    SignTable.setValueAt(&quot;S_PE_MAX&quot;,row,&quot;groupid&quot;);							
			}	
		}
	if (SignTable_G != null){
	    var row1 = SignTable_G.newRow()-1;	
		SignTable_G.setValueAt(&quot;S_PE_MAX&quot;,row1,&quot;groupid&quot;);
	}	
		
	}
	//#DEPC8J1 #DEPC8J2							 
	if( &quot;true&quot;==appDataMap.get(&quot;design-c&quot;)  ){
		for(var i=1;i&lt;3;i++){	
			var Depart_ID = &quot;DEPC8J&quot;+i
			var Department = Client.getDepartment(Depart_ID); // 取得部門物件			
			if(Department != null){
				var memid = Department.getManagerID() ;
				var Member = Client.getMemberByID(memid);				
				var username = Member.getName(); 
				var row = SignTable.newRow()-1;
				SignTable.setValueAt(username,row,&quot;cname&quot;);
				SignTable.setValueAt(memid,row,&quot;memid&quot;);	
				SignTable.setValueAt(&quot;C_PE_MAX&quot;,row,&quot;jobtitle&quot;);	
				SignTable.setValueAt(&quot;C_PE_MAX&quot;,row,&quot;groupid&quot;);						
			}	
		}
	if (SignTable_G != null){
	    var row1 = SignTable_G.newRow()-1;	
		SignTable_G.setValueAt(&quot;C_PE_MAX&quot;,row1,&quot;groupid&quot;);
	}	
		
	}
	
  	//#DEPC8J1 #DEPC8J2							 
	if( &quot;true&quot;==appDataMap.get(&quot;design-h&quot;)  ){
		for(var i=1;i&lt;1;i++){	
			var Depart_ID = &quot;DEPH5J0&quot;+i
			var Department = Client.getDepartment(Depart_ID); // 取得部門物件			
			if(Department != null){
				var memid = Department.getManagerID() ;
				var Member = Client.getMemberByID(memid);				
				var username = Member.getName(); 
				var row = SignTable.newRow()-1;
				SignTable.setValueAt(username,row,&quot;cname&quot;);
				SignTable.setValueAt(memid,row,&quot;memid&quot;);	
				SignTable.setValueAt(&quot;H_PE_MAX&quot;,row,&quot;jobtitle&quot;);	
				SignTable.setValueAt(&quot;H_PE_MAX&quot;,row,&quot;groupid&quot;);						
			}	
		}	
	if (SignTable_G != null){
	     var row1 = SignTable_G.newRow()-1;	
		SignTable_G.setValueAt(&quot;H_PE_MAX&quot;,row1,&quot;groupid&quot;);
	}	
		
	}	
}	

//=====================================================
// ---- MECN 請發文者解釋的通知mail,用於 Client 
//=====================================================	
function sendMECN_App_Mem_Mail(){	
	try{
		var MyTask = Form.getCurrentTask();
		var FLOWTYPE=Form.getValue(&quot;FLOWTYPE&quot;).substring(0,2); 
            if(FLOWTYPE.equals(&quot;A類&quot;) || FLOWTYPE.equals(&quot;B類&quot;)){
               var FLOWTYPE = FLOWTYPE ;
	        }else{
	           var FLOWTYPE = FLOWTYPE + &quot;類&quot; ;
	        }
		
		//抓取關卡名稱
		var process_name =&quot;&quot;;
		var rootName=&quot;&quot;;
		var vApp_MemID=Form.getValue(&quot;App_MemID&quot;);
		var vMem = Client.getMemberByID(vApp_MemID);
		if(&quot;null&quot;!=MyTask){
			process_name = MyTask.getProcessName();	
			rootName= MyTask.getRootName();
			var rootID= MyTask.getRootID();
			var loginid=Client.getMember(vApp_MemID).getLoginID();
		}	
		//給 url 連結 可開啟表單且可下載附件，非流程參與者可用
        //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
//                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
//                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
//                     var taskID = MyTask.getID();
//                     var member = Client.getMember(MyTask.getMemberID());
//                     //var userName = member.getName();
//                     var userName = member.getLoginID();
//                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
//                     var key = Packages.util.SecurityURL.encode(temp);
//                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
		
		//------------------
  		  loadLibrary(&quot;com.eland.dms.Config&quot;);
		  var arturl = &quot;http://afs:8080/WebAgenda/view_ins_by_roottaskid.jsp?rootid=&quot;+ rootID +&quot;&amp;loginName=&quot;+loginid;
//		  http://bpmdev:8070/WebAgenda/view_ins_by_roottaskid.jsp?rootid=Tsk000001560982&amp;loginName=irene_chang
//		  var Index_CheckOut = &quot;&lt;a href=&quot;+ CheckOut +&quot; target=_new &gt;ISO文件檔案： &quot;+doc_no+&quot;&lt;/a&gt;&quot;;
		  var  url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&quot; ;
		//------------------
	 
		    var CurrMember = Client.getCurrentMember();
			var from = &quot;MyGce@gce.com.tw&quot;;     // Sender e-mail
            var to = Client.getMember(vApp_MemID).getEmail(); 
			var vMailSubject = &quot;[MECN 請發文者解釋通知]&quot;+Form.getValue(&quot;Factory&quot;)+Form.getValue(&quot;App_Name&quot;)+&quot;-&quot;+FLOWTYPE+&quot;-MECN：&quot;+Form.getValue(&quot;Sn&quot;);    // Mail Subject
			var vText  = &quot;您 好: &lt;br&gt;&quot;;    // Mail Content
                vText += &quot;   &lt;br&gt;&quot;;	
                vText += &quot;MECN 請發文者解釋通知!&lt;br&gt;&quot;;		
		        vText += &quot;申請者:&quot;+Form.getValue(&quot;Factory&quot;)+Form.getValue(&quot;App_DepID&quot;)+&quot;-&quot;+Form.getValue(&quot;App_Name&quot;)+&quot;&lt;br&gt;&quot;;	
			    vText += &quot;審核關卡:&quot;+rootName+process_name+&quot;&lt;br&gt;&quot;;	
			    vText += &quot;審核者:&quot;+CurrMember.getName()+&quot;&lt;br&gt;&quot;;	
//			    vText += &quot;KeyWord&quot;+ MyTask.getKeyWord()+&quot;&lt;br&gt;&quot;;	
		        vText += &quot;   您所開立MECN 單，會簽長官有疑慮，請您找長官解釋原由，謝謝您!!&quot;;	
		        vText += &quot;   &lt;br&gt;&quot;;		
		        vText += &quot;   點選右方進入網站&quot;+ url +&quot;直接察看表單內容,但不能審核。&lt;br&gt;&quot;;
		        vText += &quot;   &lt;br&gt;&quot;;	
			    vText += &quot;   若有任何疑問或執行上的問題，請與資訊處 22726 王仁宏 連絡，謝謝您!! &lt;br&gt;&quot;;	

				Client.sendHTMLMail(from,to,vMailSubject,vText);
				Form.showMessageDialog(&quot;MECN 請發文者解釋的通知mail成功送出，請按【暫停】，儲存此表單資訊，切勿【完成】送出此單，謝謝您!!&quot;);	
	}catch(e){}

}
  
function addAsignList_Tech_VP(companyID,PARAMETER,Sign_MemberTable){
	var SignTable = Form.getComponent(Sign_MemberTable);
	var SignTable_G = Form.getComponent(Sign_MemberTable + &quot;_G&quot;);
	if((companyID == &quot;TGCE&quot; &amp;&amp;  PARAMETER.substring(0,2)== &quot;2J&quot; ) ||
		(companyID == &quot;TGCE&quot; &amp;&amp;  PARAMETER.substring(0,3)== &quot;2R2&quot; ) ||
	    companyID == &quot;HGCE&quot;){
	  var Dauble_flag = memisDauble(SignTable,&quot;MEMT1019244&quot;) ;	
	   if(Dauble_flag != &quot;Y&quot;){	
	   var row = SignTable.newRow()-1;
			     SignTable.setValueAt(&quot;MEMT1019244&quot;,row,&quot;memid&quot;);
				 SignTable.setValueAt(&quot;邱三雄&quot;,row,&quot;cname&quot;);
			     SignTable.setValueAt(&quot;2J0-HDI工程技術處&quot;,row,&quot;dptno&quot;);	
			     SignTable.setValueAt(&quot;2J0-HDI工程技術處-副總經理&quot;,row,&quot;jobtitle&quot;);			 
			     SignTable.setValueAt(companyID+&quot;MEMT1019244&quot;,row,&quot;groupid&quot;);	
				 
	    //寫入會簽群組Table，子流程使用		 
		var row1 = SignTable_G.newRow()-1;	
		SignTable_G.setValueAt(companyID+&quot;MEMT1019244&quot;,row1,&quot;groupid&quot;);		
     } 		 
	}else{
	   var Dauble_flag = memisDauble(SignTable,&quot;MEMT1016470&quot;) ;	
	   if(Dauble_flag != &quot;Y&quot;){	
	    var row = SignTable.newRow()-1;
			     SignTable.setValueAt(&quot;MEMT1016470&quot;,row,&quot;memid&quot;);
				 SignTable.setValueAt(&quot;林夢榕&quot;,row,&quot;cname&quot;);
			     SignTable.setValueAt(&quot;2K0-工程技術處&quot;,row,&quot;dptno&quot;);	
			     SignTable.setValueAt(&quot;2K0-工程技術處-副總經理&quot;,row,&quot;jobtitle&quot;);			 
			     SignTable.setValueAt(companyID+&quot;MEMT1016470&quot;,row,&quot;groupid&quot;);	
				 
		//寫入會簽群組Table，子流程使用		 
		var row1 = SignTable_G.newRow()-1;	
		SignTable_G.setValueAt(companyID+&quot;MEMT1016470&quot;,row1,&quot;groupid&quot;);	
      }				 
   }
  }//function addAsignList_Tech_VP
  
function addAsignList_OPE(companyID,PARAMETER,Sign_MemberTable){
	var SignTable = Form.getComponent(Sign_MemberTable);
	var SignTable_G = Form.getComponent(Sign_MemberTable + &quot;_G&quot;);
	var SQL = &quot;select MEMID from mem_geninf  where username=&apos;&quot; + PARAMETER + &quot;&apos;&quot;;	
	var vec = Client.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				   var row = SignTable.newRow()-1;
				   var cmemid = vec.get(0).get(&quot;memid&quot;);
				   SignTable.setValueAt(cmemid,row,&quot;memid&quot;);
				   SignTable.setValueAt(PARAMETER,row,&quot;cname&quot;);
			       SignTable.setValueAt(&quot;&quot;,row,&quot;dptno&quot;);	
			       SignTable.setValueAt(&quot;&quot;,row,&quot;jobtitle&quot;);			 
			       SignTable.setValueAt(PARAMETER,row,&quot;groupid&quot;);

			    if (SignTable_G != null){
	      	        var row1 = SignTable_G.newRow()-1;	
			        SignTable_G.setValueAt(PARAMETER,row1,&quot;groupid&quot;);
		        }		
		    }else{
		      Form.showMessageDialog(PARAMETER+&quot;沒有設定會簽人員!&quot;+memid);
		    }//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Form.setComplete(false);
		Form.showMessageDialog(&quot;讀取參數檔失敗!請與系統負責聯絡!!\n&quot;+SQL+memid);
	}
}//function addAsignList_OPE
</string> 
     </void> 
     <void property="synopsis"> 
      <string>addAsignTable</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00101250755035099</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/03/06 11:21:47</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Client.Action</string> 
     </void> 
     <void property="id"> 
      <string>SCL00101250755035099</string> 
     </void> 
     <void property="name"> 
      <string>Action</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091250755035083</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/**
	統一共用的 openFormAction()
*/

function openFormAction(){
	MyDebug(&quot;Open&quot;);  // add by wangwei@2010/04/11
	Form.setValue(&quot;Agree&quot;,&quot;true&quot;);
	var table = Form.getComponent(&quot;Process_Table&quot;);
	var hideCols = [&quot;工號&quot;,&quot;TaskID&quot;];
		table.setColHiding(hideCols);
		setSelectProcess();  // 將本關卡的流程「離開狀態」list 有[退回]字眼加到下拉選單內
	loadLibrary(&quot;com.A.Common.Client.SignTable&quot;);
	setSignTableResult(&quot;Process_Table&quot;); //將會簽結果放入審核意見裡面		
	//設定簽核者姓名工號 20080505
	var member = Client.getCurrentMember();
	if(member != null){
		Form.setValue(&quot;Verify_Name&quot;,member.getName());
		Form.setValue(&quot;Verify_ID&quot;,member.getMyID());		
	}	
	table.sortByColumnName(&quot;審核日期&quot;,false); // add by wangwei@2009/03/18
	chkIsReAsign(); // 檢核簽核次數
}

/**
共用function
在openFormAction中使用
顯示子流程簽核人員清單及簽核進度
add by edison@20111205
**/
function showSubProcessList(){
	var MyTask = Form.getCurrentTask();
	var process_name = MyTask.getProcessName();
	var tskid = MyTask.getTaskID();
	var sql = &quot;select decode(a.state,&apos;complete&apos;,&apos;工作已完成&apos;,&apos;工作未完成&apos;) state,&quot;;
	    sql +=&quot;&apos;[&apos;||(case when a.MEMID=a.EXEID then (select username from mem_geninf where memid=a.MEMID)||&apos;]&apos;&quot;;
		sql +=&quot;else   &apos;[&apos;||(select username from mem_geninf where memid=a.EXEID)||&apos;代理&apos;||&quot;;
		sql +=&quot;&apos;(&apos;||(select username from mem_geninf where memid=a.MEMID)||&apos;)&apos;||&apos;]&apos; end) username from task a,&quot;;
		sql +=&quot;pro_geninf b where rootid in&quot;;
		sql +=&quot;(select cproottskid from task_createpro where tskid in&quot;;
		sql +=&quot;(select tskid from task_createpro where cproottskid=&quot;;
		sql +=&quot;(select rootid from task where tskid=&apos;&quot;+tskid+&quot;&apos;))) and type=&apos;single&apos;&quot;;
		sql +=&quot;and (memid&lt;&gt;&apos;MEMPDM0001&apos; and memid&lt;&gt;&apos;Administrator&apos;) and a.PROID = b.PROID and b.AUTOEXEC=&apos;false&apos;&quot;;		
		//Client.addDebugLog(&quot;顯示會簽子流程簽核名單====&quot;+sql);  // mark by wangwei@2016/03/07 09:10
	var rs = Client.SQLloadValue(sql);
	if(rs!=null &amp;&amp; rs.size()&gt;0){
		var msg = process_name+&quot;\n\n&quot;;
		for(var i=0;i&lt;rs.size();i++){
			msg +=&quot;執行者：&quot;+rs.get(i).get(&quot;username&quot;)+&quot;，&quot;+rs.get(i).get(&quot;state&quot;)+&quot;\n&quot;;
		}
		Form.showMessageDialog(msg);
	}
}
/**
	統一共用的 okAction()
*/
function okAction(){
	MyDebug(&quot;OK&quot;);  // add by wangwei@2010/04/11
	var msg = &quot;&quot;;
	if(&quot;true&quot; == Form.getValue(&quot;Reject&quot;) &amp;&amp; &quot;&quot; == Form.getValue(&quot;Verify_Note&quot;)){
		msg = &quot;請在簽核意見欄填寫退回原因!\n&quot;;
	}
	if(msg != &quot;&quot;){
		Form.setComplete(false);
		Form.showMessageDialog(msg);
	}	
	if(&quot;true&quot; == Form.getValue(&quot;Reject&quot;)&amp;&amp;chkIsRESIGN()){   			// 是駁回但申請者離職 add by wangwei@2009/12/16	
		Form.showMessageDialog(&quot;Sorry!!\n因申請者已離職,表單可能無法駁回!\n若簽核有問題請與系統負責人聯繫!&quot;);	
	}	
	chkAddASDept();  // 檢查動態加會簽是否選到部門,若有則不允許送出表單	
	chkIsAddAS(&quot;&quot;);  // 檢查是否會簽
	chkIsReject();   // 檢查是否為被駁回的表單,若是要再再送出則要寫原因
	if(&quot;true&quot; == Form.getValue(&quot;Reject&quot;)){
		RejectReminder(&quot;林清培&quot;,&quot;駁回&quot;) ;  //  總經理小黃管理 add by wangwei@2010/08/16
	}	
}
//=====================================================
// ---- 檢查申請者是否已離職,若是則mail給MyGCE做處理 add by wangwei@2009/12/03
//=====================================================	
function chkIsRESIGN(){	
	try{
		var MyTask = Form.getCurrentTask();
		//抓取關卡名稱
		var process_name =&quot;&quot;;
		var rootName=&quot;&quot;;
		var vApp_MemID=Form.getValue(&quot;App_MemID&quot;);
		var vMem = Client.getMemberByID(vApp_MemID);
		if(&quot;null&quot;!=MyTask){
			process_name = MyTask.getProcessName();	
			rootName= MyTask.getRootName();
		}	
		var CurrMember = Client.getCurrentMember();
		if(&quot;true&quot;.equals(vMem.isResign())){
			var from = &quot;MyGce@gce.com.tw&quot;;     // Sender e-mail
			var to = &quot;wangwei@gce.com.tw;edison_wang@gce.com.tw&quot;; // Receiver e-mail
			var vMailSubject = Form.getValue(&quot;Factory&quot;)+Form.getValue(&quot;App_Name&quot;)+&quot;已離職,尚有表單尚未簽核完畢!&quot;;    // Mail Subject
			var vText    = &quot;&quot;;    // Mail Content			
				vText += &quot;申請者:&quot;+Form.getValue(&quot;Factory&quot;)+Form.getValue(&quot;App_DepID&quot;)+&quot;-&quot;+Form.getValue(&quot;App_Name&quot;)+&quot;&lt;br&gt;&quot;;	
				vText += &quot;回報關卡:&quot;+rootName+process_name+&quot;&lt;br&gt;&quot;;	
				vText += &quot;審核者:&quot;+CurrMember.getName()+&quot;&lt;br&gt;&quot;;	
				vText += &quot;KeyWord&quot;+ MyTask.getKeyWord()+&quot;&lt;br&gt;&quot;;	
				vText += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;	
				Client.sendHTMLMail(from,to,vMailSubject,vText);
			return true;	
		}
	}catch(e){}
	return false;	
}
	
//=====================================================
// 判斷是否有加會簽 add by wangwei
//=====================================================	
function chkIsAddAS(SignTable){
	try{
	var Task = Form.getCurrentTask();
	var process_name = Task.getProcessName();	
	var mID  = Task.getMemberID();
	var vMEM = Client.getMemberByID(mID);
	var roleID = vMEM.getMainRoleID();
	var memDR = vMEM.getMemberDR(roleID);
	var department = memDR.getDepartmentName();	//使用者部門名稱		
	var l_name=vMEM.getName();	
	if(&quot;&quot;==SignTable){
		SignTable =&quot;Process_Table&quot;;
		}
	if(&quot;&quot;!=SignTable&amp;&amp;Task.isExecuteAddAS()){
		var process_table = Form.getComponent(SignTable);	
		var row = process_table.newRow() - 1;
		var l_id = vMEM.getMyID();         
			process_table.setValueAt(row+1+&quot;&quot;,row,&quot;序號&quot;);                   
			process_table.setValueAt(l_id, row, &quot;工號&quot;);//
			process_table.setValueAt(l_name, row, &quot;姓名&quot;);//
			process_table.setValueAt(department, row, &quot;部門&quot;);//			
			process_table.setValueAt(process_name, row, &quot;關卡名稱&quot;);//  modi by wangwei@2009/12/29 解決第一關就加會簽的問題
            process_table.setValueAt(Task.getAddASTitle(), row, &quot;審核意見&quot;);//ITEM5 審核意見
            process_table.setValueAt(&quot;加會簽&quot;, row,&quot;是否核准&quot;);//同意                
		var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
		var l_time = simpledateformat.format(date);
			process_table.setValueAt(l_time, row,&quot;審核日期&quot;);//日期 
// ==========若是總經理加會簽則要寫入A_GM_REMINDER
		AddsReminder(&quot;林清培&quot;,&quot;會簽&quot;) ;  //  總經理小黃管理	//  總經理小黃管理 add by wangwei@2010/08/16
			
	}
	}catch(e){}
}	
//=====================================================
//手動加會簽不允許使用部門 add by wnagwei@2010/06/24
//=====================================================
function chkAddASDept(){
	try{
		var task = Form.getCurrentTask(); 
		var taskmemberlist = task.getAddASAuditsString(); // 會簽物件
		while (taskmemberlist.indexOf(&quot;[&quot;) &gt;= 0){
			var vMEMID = taskmemberlist.substring(1,12);
			var vMEM = Client.getMemberByID(vMEMID);
			if (vMEM==null){
				Form.setComplete(false);	
				Form.showMessageDialog(&quot;!!注意!!會簽人員設定一定要指定人員!\n請重新設定會簽人員!!&quot;);
				taskmemberlist=&quot;&quot;;
			}else{
				taskmemberlist = taskmemberlist.substring(taskmemberlist.indexOf(&quot;]&quot;)+1 ) ;
			}
		}
	}catch(e){
	}
 }
//=====================================================
// 判斷表單狀態是否有退回字眼
//=====================================================
function chkIsReject(){
	try{
		var MyTask = Form.getCurrentTask();
		var vState = MyTask.getArtInstance().getArtState().toString() ;
		if(vState.indexOf(&quot;退回&quot;)&gt;= 0&amp;&amp;&quot;false&quot;==Form.getValue(&quot;Cancel&quot;)&amp;&amp;&quot;&quot; == Form.getValue(&quot;Verify_Note&quot;) ){
			Form.setComplete(false);
			Form.showMessageDialog(&quot;!!注意!!此表單是被退回!\n再送出前請在【簽核意見】欄輸入處理說明!!&quot;);
		}
	}catch(e){}		
}
//=====================================================
// 判斷是否有二次簽核
//=====================================================
function chkIsReAsign(){
	try{
	var vTimes=0;
	var process_table = Form.getComponent(&quot;Process_Table&quot;);
	var MyTask = Form.getCurrentTask();
	var process_name = MyTask.getProcessName();
	var l_name = Client.getMember(MyTask.getRealExecutor()).getName(); //執行者	
	for (var j=0;j&lt;process_table.getRowCount();j++){
		t_name = process_table.getValueAt(j,&quot;姓名&quot;);
		t_processname = process_table.getValueAt(j,&quot;關卡名稱&quot;);
		if (l_name.equals(t_name)&amp;&amp;process_name.equals(t_processname)){
			vTimes++;
		}
	}//for j
	if(vTimes &gt;= 1 ){	
		vTimes++
		Form.showMessageDialog(&quot;!注意!\n\n此表單被駁回過重送或者加會簽回到您手上!!\n\n這是您第【 &quot;+vTimes+&quot; 】次簽核\n\n可查閱簽核紀錄之歷程，包含駁回者、簽核意見及回覆者的說明&quot;);
	}	
	}catch(e){
		// Form.showMessageDialog(&quot;開啟表單出錯!\n請通知系統負責人!!&quot;);   // 因可能是在查詢表單時開啟FORM so 不要SHOW此訊息
	}	
}	
//=====================================================
// 將本關卡的流程「離開狀態」list 加到下拉選單內
//=====================================================
function setSelectProcess(){
	//決定流程選項的內容
	var selectprocess = Form.getComponent(&quot;Select_Process&quot;);
	selectprocess.removeAllItems();
	var task = Form.getCurrentTask();
	//如果是用應用程式開表單會沒有 CurrentTask()
	if(task == null){
		var ins = Form.getArtInstance();
		var insid = ins.getID();
		task = getTaskByInsID(insid);
	}
	var extCond = task.getExtCondList();	//取得離開狀態的物件
	//selectprocess.addItem(&quot;&quot;);
	for (var i1=0;i1&lt;extCond.size();i1++){
		var linkTerm = extCond.get(i1);	//取得第i1筆的物件資料
		var extStateList = linkTerm.getArtStateList();	//取得表單狀態的表列資料
		for (var i2=0;i2&lt;extStateList.size();i2++){
			var extState = extStateList.get(i2);	//取得第i2筆資料狀態名稱
			var stateName = extState.getName();
			//只放退回的選項
			if(stateName.startsWith(&quot;退回&quot;)){
					selectprocess.addItem(stateName);
			}
		}
	}
	Form.setValue(&quot;Select_Process&quot;,&quot;退回申請人&quot;);
	if(&quot;true&quot; == Form.getValue(&quot;Reject&quot;)){
		Form.getComponent(&quot;Select_Process&quot;).setVisible(true);
	}
}

//========================================================================================
// 取得應用程式之查詢共用條件的SQL
//========================================================================================
function getTaskByInsID(InsID){
	var task = null;
	var vecTask = Client.SQLloadValue(&quot;select max(tskid) taskid from task_artins where insid =&apos;&quot;+ InsID +&quot;&apos;&quot;);
	if(vecTask.get(0).get(&quot;taskid&quot;) != null ){
		task = Client.getTask(vecTask.get(0).get(&quot;taskid&quot;));
	}
	return task;
}
//========================================================================================
// Client debug 共用程式
//========================================================================================
function MyDebug(act){	
//	var vConnectInfo = Client.getDbConnectionCurrentState();    // show 此訊息暫無用處 mark by wangwei@2013/04/23
	var member = Client.getCurrentMember();
	var aID  = Form.getArtifactID();
	var Artifact = Client.getArtifact(aID);
	var ArtifactName = Artifact.getName();
	var vMEMID = member.getID();
	var vAddress = &quot;&quot;;
//	var myUserOnlineData = Packages.com.flowring.util.online.OnlineDataStore.getUserOnlineDataByID(vMEMID);
//	var vAddress = myUserOnlineData.getRemoteAddr();	
//	Form.setValue(&quot;IP&quot;,vAddress);   		// add by wangwei@2018/02/07
	if(member != null){	
//  加上client IP by wangwei@2013/04/23
		Client.addDebugLog(member.getAreaCode()+ member.getName()+&quot;-&quot;+act+&quot;:&quot;+ArtifactName+&quot;@&quot;+vAddress);
// 檢查 IP  by wangwei@2018/02/07	
		var vIP1_3 = vAddress.substr(0,3);
		if(&quot;Open&quot;==	act&amp;&amp;(vIP1_3 == &quot;172&quot;||vIP1_3 == &quot;10.&quot;||vIP1_3 == &quot;192&quot;)){  // 排除手機或VPN 連線 IP
			var vMemAddress = member.getAddress();
			if(vMemAddress==&quot;&quot;){
				member.setAddress(vAddress);
				Client.updateMemberRecord(member) ;
			}else{
				if(!vMemAddress.equals(vAddress)){
// mark by wangwei@2019/01/02					
//					var vMailSubject = &quot;(&quot;+member.getAreaCode()+&quot;)表單使用者在不同IP登入:&quot;+member.getName()+&quot;(&quot;+ member.getJobTitle()+&quot;)&quot;;
//					var vText = &quot;使用者 IP 異常&lt;br/&gt;&quot;;
//					vText += member.getName() +&quot;(&quot;+ member.getJobTitle()+&quot;)&quot;+&quot;&lt;br/&gt;&quot;;
//					vText += &quot;前次登入IP :&quot; +vMemAddress +&quot;&lt;br/&gt;&quot; ;
//					vText += &quot;此次登入IP :&quot; +vAddress +&quot;&lt;br/&gt;&quot; ;
//					vText += &quot;開啟 :&quot; +ArtifactName +&quot;&lt;p/&gt;&quot; ;					
//					vText += &quot;請確認是否帳號盜用!&lt;p/&gt;&quot;;
//					vText += &quot;-- com.A.Common.Client.Action.MyDebug --- &lt;br/&gt;&quot;;
//					var to = getSysManagerMail();
//					Client.sendHTMLMail(&quot;MyGCE@gce.com.tw&quot;,to,vMailSubject,vText);
					member.setAddress(vAddress);
					Client.updateMemberRecord(member) ;				
				}		
			
			}
		}		
	}	
}
//========================================================================================
// add by wangwei@2010/08/12
// 檢查主管退件時要通知的人
//========================================================================================
function RejectReminder(vManager,vAction){	
	var vMember = Client.getCurrentMember();
	var vUsername = vMember.getName() ;
	if(vUsername.equals(vManager) ){            // 簽核人是相同才會執行
		var vTask = Form.getCurrentTask();
		var vKeyWord = vTask.getKeyWord();		
		var vINSID = Form.getArtInstanceID();
		var vFactory = Form.getValue(&quot;Factory&quot;);  // 廠別
			vFactory = vFactory.substr(1,4)
		var vMailTo=&quot;wangwei@gce.com.tw&quot;;	
		//		try{  		// mark by wangwei@2013/02/22
//			if(&quot;TGCE&quot;==vFactory){
//				var vSec=Client.getMemberByName(&quot;joyun_liu&quot;);   // huiwen_liu@gce.com.tw 劉若芸 (舊名:劉惠雯)	
//			}
//			if(&quot;SGCE&quot;==vFactory){
//				var vSec=Client.getMemberByName(&quot;betty.zhang&quot;); // Betty.Zhang張媛接	 &lt;&lt;== Wendy.Zhang@gcecn.com  張京文	2010/12/23 
//			}			
//			if(&quot;CGCE&quot;==vFactory){
//				var vSec=Client.getMemberByName(&quot;tatia.wang&quot;);  	// Tatia.wang王鐳 &lt;&lt;=== Lisa.Hou候化梅 2012/10/31
//			}	
//			if(&quot;HGCE&quot;==vFactory){
//				var vSec=Client.getMemberByName(&quot;ammi.deng&quot;);  //   Ammi.Deng 鄧雪慧 5/14
//			}				
//			if(vSec != null){
//				vMailTo = vSec.getEmail();
//			}	
//		}catch(e){}			
		var aID  = Form.getArtifactID();
		var Artifact = Client.getArtifact(aID);
		var ArtifactName = Artifact.getName();	
		var vSelect_Process = Form.getValue(&quot;Select_Process&quot;);  // 退回的關卡
		var vREMARK = Form.getValue(&quot;Verify_Note&quot;);  //  簽核意見
		var vProcess_owner = Form.getValue(&quot;process_owner&quot;);   // 退回人員
		if (vProcess_owner==null||vProcess_owner==&quot;undefined&quot;){   // 加上　undefined　modi by wangwei@2011/09/21
			vProcess_owner = getProcessOwner(vSelect_Process);
		}
		vProcess_owner  = vSelect_Process + vProcess_owner;		
		sendMailToSecretary(vMailTo,ArtifactName,&quot;[小黃通知]&quot;+vMember.getJobTitle()+&quot;簽核【&quot;+ArtifactName+&quot;】退單通知&quot;,vProcess_owner,vKeyWord,vREMARK,vAction);
		insertReminder(vFactory,ArtifactName,vAction,vProcess_owner,vREMARK,&quot;&quot;,vINSID,vKeyWord);		
	}	
}
//===
//========================================================================================
// add by wangwei@2010/08/12
// 加會簽時要通知的人
//========================================================================================
function AddsReminder(vManager,vAction){	
	var vMember = Client.getCurrentMember();
	var vUsername = vMember.getName() ;
	if(vUsername.equals(vManager) ){            // 簽核人是相同才會執行
		var vTask = Form.getCurrentTask();
		var vKeyWord = vTask.getKeyWord();		
		var vINSID = Form.getArtInstanceID();
		var vFactory = Form.getValue(&quot;Factory&quot;);  // 廠別
			vFactory = vFactory.substr(1,4)
		var vMailTo=&quot;wangwei@gce.com.tw&quot;;	
//		try{    // mark by wangwei@2013/02/22
//			if(&quot;TGCE&quot;==vFactory){
//				var vSec=Client.getMemberByName(&quot;joyun_liu&quot;); // huiwen_liu@gce.com.tw 劉若芸 (舊名:劉惠雯)	
//			}
//			if(&quot;SGCE&quot;==vFactory){
//				var vSec=Client.getMemberByName(&quot;wendy.zhang&quot;); // Wendy.Zhang@gcecn.com  張京文		
//			}			
//			if(&quot;CGCE&quot;==vFactory){
//				var vSec=Client.getMemberByName(&quot;summer.shi&quot;);  // LF.Wang@gcecn.com  王利方 ==&gt;summer.shi石亞文的賬號 2011/05/20 
//			}	
//			if(&quot;HGCE&quot;==vFactory){
//				var vSec=Client.getMemberByName(&quot;ammi.deng&quot;);  //   Ammi.Deng鄧雪慧
//			}				
//			if(vSec != null){
//				vMailTo = vSec.getEmail();
//			}	
//		}catch(e){}	
		var aID  = Form.getArtifactID();
		var Artifact = Client.getArtifact(aID);
		var ArtifactName = Artifact.getName();	
		var vREMARK=vTask.getAddASTitle(); //  會簽意見
		var taskmemberlist = vTask.getAddASAuditsString();
		var vAddList =&quot;&quot;;
		while (taskmemberlist.indexOf(&quot;[&quot;) &gt;= 0){
			vSelect_Process = &quot;&quot;;
			var vMEMID = taskmemberlist.substring(1,12);
			var vMEM = Client.getMemberByID(vMEMID);
			var vProcess_owner = vMEM.getName();
			var vOwnerMail = vMEM.getEmail();
			    vMailTo = vMailTo +&quot;;&quot;+vOwnerMail 
				vAddList = vAddList + vProcess_owner +&quot;;&quot;
//			sendMailToSecretary(vMailTo,ArtifactName,&quot;[小黃通知]總經理簽核【&quot;+ArtifactName+&quot;】&quot;+vAction+&quot;通知&quot;,vProcess_owner,vKeyWord,vREMARK,vAction);
			insertReminder(vFactory,ArtifactName,vAction,vProcess_owner,vREMARK,&quot;&quot;,vINSID,vKeyWord);		
			taskmemberlist = taskmemberlist.substring(taskmemberlist.indexOf(&quot;]&quot;)+1 )
		}  
// 改為一起mail給所有被加簽的人		
		sendMailToSecretary(vMailTo,ArtifactName,&quot;[小黃通知]執行長簽核【&quot;+ArtifactName+&quot;】&quot;+vAction+&quot;通知&quot;,vAddList,vKeyWord,vREMARK,vAction);				
	}	
}

// 新增至table            廠別      表單名稱  動作(駁回或加會簽),收單者,簽核備註1,簽核備註1,表單單號
function insertReminder(vFACTORY,vARTFORM,vACTION,vFLOWTO,vREMARK1,vREMARK2,vINSID,vKeyWord){	
	try{
		var vReturnMAX = 1;
		var sql_sn = &quot; select max(SEQNO) MAXNO FROM A_GM_REMINDER &quot;;	   
		var vec_sn = Client.SQLloadValue(sql_sn);
		   if(vec_sn != null &amp;&amp; vec_sn.size()&gt;0 &amp;&amp; vec_sn.get(0).get(&quot;MAXNO&quot;) != &quot;&quot;){
			   var vMaxno = vec_sn.get(0).get(&quot;MAXNO&quot;);
			   vReturnMAX = java.lang.Integer.parseInt(vMaxno) + 1 ;
		   }		
		var sql = &quot; INSERT INTO A_GM_REMINDER &quot; ;
			sql = sql+&quot;(FACTORY,ARTFORM,ACTION,FLOWTO,REMARK1,REMARK2,INS_DTIME,END_DTIME,INSID,STATUS,KEYWORD,SEQNO )  &quot;;
			sql = sql+&quot; VALUES (&apos;&quot;+vFACTORY+&quot;&apos;,&apos;&quot;+vARTFORM+&quot;&apos;,&apos;&quot;+vACTION+&quot;&apos;,&apos;&quot;+vFLOWTO+&quot;&apos;,&apos;&quot;+vREMARK1+&quot;&apos;,&apos;&quot;+vREMARK2+&quot;&apos;,TO_CHAR(SYSDATE, &apos;YYYY/MM/DD HH24:MI:SS&apos;),&apos;&apos;,&apos;&quot;+vINSID+&quot;&apos;,&apos;新增&apos;,&apos;&quot;+vKeyWord+&quot;&apos;,&quot;+vReturnMAX+&quot;)&quot;;
			var Result = Client.SQLinsertValue(sql);	
	}catch(e){
		Client.addErrLog(&quot;call insertReminder :&quot;+ sql);
	}			
}
//(vMailTo,ArtifactName,&quot;[通知]總經理簽核【&quot;+ArtifactName+&quot;】退單通知&quot;,vProcess_owner,vKeyWord,vAction);	
function sendMailToSecretary(mailTo,ArtifactName,MailSubject,vProcess_owner,vKeyWord,vREMARK,vACTION){
	var CurrMember = Client.getCurrentMember();
	var from = CurrMember.getEmail();     // Sender e-mail
	var to = mailTo+&quot;;wangwei@gce.com.tw&quot;; // Receiver e-mail	
	var vMailSubject = MailSubject ;
	var vText    = &quot;&quot;;    // Mail Content
		vText += vProcess_owner +&quot; sir:&quot;+&quot;&lt;br&gt;&quot;;
		vText += &quot;此信件等同「總經理小黃」將被登記匯總表列管&quot;+&quot;&lt;br&gt;&quot;;
		vText +=&quot;&lt;br&gt;&quot;;
		vText += &quot;申請者:&quot;+Form.getValue(&quot;App_Name&quot;)+Form.getValue(&quot;Factory&quot;)+&quot;&lt;br&gt;&quot;;	
		vText += &quot;表單:&quot;+ArtifactName +&quot;&lt;br&gt;&quot;;	;
		vText += &quot;申請內容:&quot;+vKeyWord+&quot;&lt;br&gt;&quot;;	
		vText += vACTION+&quot;:&quot;+vProcess_owner+&quot;&lt;br&gt;&quot;;
		vText += &quot;原因:&quot;+vREMARK+&quot;&lt;br&gt;&quot;;					
		vText += &quot;&lt;br&gt;&quot;;	
		vText += &quot;收件者一個人以上時候處理方式：&quot;+&quot;&lt;br&gt;&quot;;	
		vText += &quot;&lt;font color=RED&gt;1. 請務必先協調並取得共識後得到總經理同意後，請都回覆【同意】避免造成總經理的困擾&lt;/font&gt;&lt;br&gt;&quot;;
		vText += &quot;&lt;font color=RED&gt;2. 協調後如決定修改、取消請與填單人(採購人員)聯繫，由填單人(採購人員)抽單處理， 無需回覆【不同意】避免造成總經理的困擾&lt;/font&gt;&lt;br&gt;&quot;;
		vText += &quot;   &lt;br&gt;&quot;;		
		vText += &quot; 可進入MyGCE系統  &lt;br&gt;&quot;;		
		vText += &quot;【個人簽核管理】→【表單查詢】→【常用工具程式】→【總經理小黃管理】&quot;+&quot; (此程式僅供查詢)&lt;br&gt;&quot;;
		vText += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;	
		Client.sendHTMLMail(from,to,vMailSubject,vText);		
}

// 取得退回關卡負責的名字
function getProcessOwner(Select_Process){
	var	vSelect_Process = Select_Process.substring(2);
	var tableA = Form.getComponent(&quot;Process_Table&quot;);
		if(Form.getValue(&quot;Select_Process&quot;)==&quot;退前一簽核人員&quot;){
			var vMemID = Form.getValue(&quot;From_User_ID_A&quot;);
			return Client.getMember(vMemID).getName();// 將姓名show出
		}else{
			for(var i = 0;i&lt;tableA.getRowCount();i++){
				var vProcessName = tableA.getValueAt(i,&quot;關卡名稱&quot;)  ;
				if( vProcessName.indexOf(vSelect_Process)&gt;=0 ){
					var vProcessOwner = tableA.getValueAt(i,&quot;姓名&quot;) 	;
						return vProcessOwner ;
					}
				}
			}
	return &quot;&quot;;		
}


	// 這個函數是要自己客製化的比較函數, 例如說要比較 ITEM3 (是整數比較)
	function hashcompare1(e1,e2) {   
	var x = parseInt(e1.get(&quot;ITEM7&quot;));  
	var y = parseInt(e2.get(&quot;ITEM7&quot;));  
	if ( x == y ) return 0;   
	else if ( x &lt; y ) return 1;  
	else return -1;}
	// 這個函數是要自己客製化的比較函數, 例如說要比較 ITEM3 (是字串比較)
	function hashcompare2(e1,e2) {   
	var x = (e1.get(&quot;ITEM7&quot;)); 
	var y = (e2.get(&quot;ITEM7&quot;));  
	if ( x == y ) return 0;   
	else if ( x &gt; y ) return 1;  
	else return -1;}
	// 這個地方可以不用改
	function sortVector(vec, compFunc){   
	var auxFunc = { compare: compFunc };   
	var compObj = new JavaAdapter( Packages.java.util.Comparator, auxFunc );  
	Packages.java.util.Collections.sort( vec, compObj );  
	}
	
	
function comp(){
	// 這裡是單元測試範例，從 table 取出資料，排序後再塞回去的範例
	var comp = Form.getComponent(&quot;Process_Table&quot;);
	var rlist = comp.getRowList();
	sortVector(rlist, hashcompare1);
	comp.setRowList( rlist );

}	

// 流程工作說明，若以@@開頭則自動show出 add by wangwei@2012/05/31
function showSynopsis(){
	var MyTask = Form.getCurrentTask();
	if(MyTask!=null){
		var processSynopsis = MyTask.getSynopsis();
		var process_name = MyTask.getProcessName();
		if(processSynopsis.indexOf(&quot;@@&quot;)&gt;=0){	
			Form.showMessageDialog(&quot;您負責的關卡名稱:&quot;+process_name+&quot;\n&quot;+processSynopsis);	
		}
	}
}
// add by wangwei@2013/03/27
// 為避免開啟表單開啟後沒有送出　
// vCreatorCol: 填單者欄位 ; 
// vKeyCol: 不允許null值欄位 , 若是null 表示尚未送出
// vThreshold: 超過此數量則回傳true
function isArtOverLimit(vCancelCol,vCreatorCol,vKeyCol,vThreshold){
	var vArtTable = Form.getArtifactID()+&quot;_INS&quot;;
	var vCurrentUserMEMID = Client.getCurrentMember().getID();   // MEMID
	var vSQL = &quot;Select * from &quot; + vArtTable +&quot; where &quot; + vCreatorCol +&quot;=&apos;&quot;+vCurrentUserMEMID+&quot;&apos; &quot;;
		vSQL += &quot; and &quot;+vCancelCol +&quot;= &apos;false&apos;  and &quot;+vKeyCol +&quot; is null&quot; ;	
	try{			
		var vec = Client.SQLloadValue(vSQL);
		vThreshold = vThreshold + 1 ; 
		if(vec.size() &gt; vThreshold){
			var vSize = vec.size() - 1 ;
			 Client.addDebugLog(&quot;無法送單:&quot;+vSQL);
			Form.showMessageDialog(&quot;您的待辦事項清單中尚有 [&quot;+vSize +&quot;] 筆相同表單未送出!\n請先處理完畢再開新單!&quot;);	
			return true;		
		}
		return false;	
	}catch(e){
		Client.addErrLog(&quot;call isArtOverLimit():&quot; + vSQL);			
	}
	return false;
}
// 檢查直屬主管是否離職  add by wangwei@2016/03/16
function isPagerResign(vMEMID){	
	var vSQL = &quot;Select resign from mem_geninf where  resign = &apos;true&apos; and  memid = (Select pager from mem_geninf where memid = &apos;&quot;+vMEMID+&quot;&apos;)&quot;;
	try{			
		var vec = Client.SQLloadValue(vSQL);
		if(vec.size() &gt; 0 ){
			return true;		
		}else{
			return false;	
		}
	}catch(e){
		Client.addErrLog(&quot;call isPagerResign():&quot; + vSQL);			
	}
	return false;		
}
// add by wangwei@2016/05/24
// vFileAtt : 禁止的副檔名ex : bpm  也可以是多種副檔名  bpm;xls;doc
function chkAttachFile( vAttObjet , vFileAtt){
	var attachFileCmp = Form.getComponent(vAttObjet); 			//AttachedFile0 為表單夾檔元件名稱
	var fileList = attachFileCmp.getFileList(); 
	var vFANList = vFileAtt.toLowerCase();  		// 附檔名黑名單
	if(fileList.size() &gt; 0){
		for(var i = 0; i &lt; fileList.size(); i++) {
			var fileInfo = fileList.get(i);
			var fileName = fileInfo.getFileName(); //抓取上傳檔案名稱
			var vStr = fileName.toString();
			var vAFN = vStr.substring(vStr.length() - 3,vStr.length())
			vAFN = vAFN.toLowerCase();
			if(vFANList.indexOf(vAFN)&gt;=0){
				return false;                   // 上傳的檔案附檔名在黑名單中	
			}
		}
	}
	return true;		
}

// 檢查是否有相同IP 且不且簽核者 by wangwei@2018/02/06
// 2018/02/23 mail to USER
function chkIP(vUserName){　　　// 傳入的是　mem obj
	var vIP = Form.getValue(&quot;IP&quot;);
	var vMemName = vUserName.getName();   // 簽核者
	var to = vUserName.getEmail();		  // 簽核者email	
	if(&quot;wtadmin@gce.com.tw&quot;.equals(to) || &quot;edison_wang@gce.com.tw&quot;.equals(to)){   	  // add by wangwei@2018/10/15 
		return;
	}
	var vTitle = vUserName.getJobTitle();
	var table = Form.getComponent(&quot;Process_Table&quot;);
	var vFactory = Form.getValue(&quot;Factory&quot;);	
	var vSYS = &quot;&quot;;  			// ---------------add by wangwei@2018/010/02 for 稽核要求	
	if(vFactory==&quot;(TGCE)&quot;){ 
		vSYS = &quot;Tzong_Liang@gce.com.tw&quot;;			
	}else if(vFactory==&quot;(SGCE)&quot;){
		vSYS = &quot;ann.shen@gcecn.com&quot;;						
	}else if(vFactory==&quot;(CGCE)&quot;){ 
		vSYS = &quot;Ben.Zhang@gcecn.com&quot;;				   
	}else if(vFactory==&quot;(HGCE)&quot;){		 
		vSYS = &quot;Thomas.Zong@gcecn.com&quot;;	
	}	//-------------------------------------------------------------------------------
	for(var j = 0;j&lt;table.getRowCount();j++){
		if(table.getValueAt(j,&quot;IP&quot;).equals(vIP)){
			var vName = table.getValueAt(j,&quot;姓名&quot;);
			var vTitlex = table.getValueAt(j,&quot;職稱&quot;);
			if(!vName.equals(vMemName)&amp;&amp; vName.indexOf(&quot;(代理:&quot;)&lt; 0){
				var MyTask = Form.getCurrentTask();				
				var process_name =&quot;&quot;;
				var rootName=&quot;&quot;;
				var vApp_MemID=Form.getValue(&quot;App_MemID&quot;);
				if(&quot;null&quot;!=MyTask){
					process_name = MyTask.getProcessName();	
					rootName= MyTask.getRootName();
				}				
				var vSubject =&quot;簽核異常:&quot;+vMemName+&quot;(&quot;+vTitle+&quot;)-&quot;+vName+&quot;(&quot;+vTitlex+&quot;)-表單:&quot;+rootName;
				Client.addDebugLog(vFactory+&quot;-ERROR-表單&quot;+vSubject+&quot;@&quot;+vIP);
				var from = &quot;MyGCE@gce.com.tw&quot;;      		// Sender e-mail
				var cc = getSysManagerMail() +&quot;;&quot;+vSYS; 	// Receiver e-mail 2018/10/02 加上給各廠系統課人員				
				var vMailSubject = vFactory+vSubject;       // Mail Subject
				var vText    = &quot;&quot;;    // Mail Content			
				vText +=&quot;Dear &quot; +vUserName+&quot; 您好,&lt;br&gt;&lt;br&gt;&quot;;
				vText +=&quot;&lt;font color=&apos;red&apos;&gt;系統檢查到您的帳號疑似被盜用，請您確認以下表單是否為您本人簽核&lt;br&gt;&lt;/font&gt;&quot;	;
				vText +=&quot;***若帳密被盜用請即刻修改密碼並通知資訊處***&lt;br&gt;&quot;	;	
				vText +=&quot;***若您是與別人共用電腦請忽略此mail***&lt;br&gt;&quot;	;				
				vText += &quot;&lt;hr&gt;&quot;;				
				vText += &quot;申請者:&quot;+Form.getValue(&quot;Factory&quot;)+Form.getValue(&quot;App_DepID&quot;)+&quot;-&quot;+Form.getValue(&quot;App_Name&quot;)+&quot;&lt;br&gt;&quot;;	
				vText += &quot;回報關卡:&quot;+rootName+&quot;-&quot;+process_name+&quot;&lt;br&gt;&quot;;	
				vText += &quot;審核者:&quot;+vMemName+&quot;-&quot;+vUserName.getID()+&quot;&lt;br&gt;&quot;;
				vText += &quot;KeyWord&quot;+ MyTask.getKeyWord()+&quot;&lt;br&gt;&quot;;													
				vText += &quot;&lt;hr&gt;&quot;;
				vText += &quot;&lt;font color=&apos;blue&apos;&gt;提醒您:&lt;br&gt;&quot;
				vText += &quot;* 不可將帳/密告知他人,由他人代為簽單&lt;br&gt;&quot;;
				vText += &quot;* 經查證為盜用他人帳號/密碼,或提供帳號及密碼給他人代簽表單,將呈報人事單位懲處&lt;br&gt;&quot;;
				vText += &quot;* 若請假無法簽表單,請自行設定表單代理人&lt;br&gt;&quot;;
				vText += &quot;* 表單提供手機簽核功能,不在廠內也可簽核表單&lt;br&gt;&lt;/font&gt;&quot;;
				vText += &quot;&lt;hr&gt;&lt;br&gt;&quot;;				
				vText += &quot;請IT系統課人員確認是否為共用電腦!!有任何問題請與資訊處(王維勳-22707)聯絡&lt;br&gt;&quot;;				
				vText += &quot;--com.A.Common.Client.Action.chkIP -@&quot;+vIP;	
				if(vIP==&quot;10.10.1.50&quot;||vIP==&quot;203.73.142.253&quot;){  				// add by wangwei@2018/07/12 因有client PC 設定Proxy server , 會迼成誤判
					vText +=&quot;&lt;P&gt;  ----------------- Proxy Server -----------------&lt;/p&gt;&quot;
					Client.sendHTMLMail(from,&quot;wangwei@gce.com.tw&quot;,&quot;&quot;,vMailSubject,vText);					
				}else{
					Client.sendHTMLMail(from,to,cc,vMailSubject,vText);
//					if(&quot;(TGCE)&quot;!=Form.getValue(&quot;Factory&quot;)){ 					// add by wangwei@2018/08/14 非TGCE 加寄給稽核
//						Client.sendHTMLMail(from,&quot;Yc.Teng@gcecn.com&quot;,&quot;&quot;,vMailSubject,vText);	
//					}
					Form.showMessageDialog(&quot;簽核異常已紀錄\n請勿代人簽核表單!!&quot;);
				}
				return &quot;Y&quot;;
			}
		}
	}
	return &quot;N&quot; ;
}


// 取管理者mail address
function getSysManagerMail(){
	return &quot;wangwei@gce.com.tw;yingchieh_wang@gce.com.tw;edison_wang@gce.com.tw&quot;;
}

//
function clearIP(){　
	var table = Form.getComponent(&quot;Process_Table&quot;);
	for(var j = 0;j&lt;table.getRowCount();j++){
		table.setValueAt(&quot;&quot;,j,&quot;IP&quot;);		
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>統一共用的 Form Action()</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00101357892989589</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2017/12/20 09:46:12</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Server.addAsignTableV1</string> 
     </void> 
     <void property="id"> 
      <string>SCL00101357892989589</string> 
     </void> 
     <void property="name"> 
      <string>addAsignTableV1</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00281213180209899</string> 
     </void> 
     <void property="scriptSource"> 
      <string>// 設定會簽人員function
function addAsignList(MyTask,companyID,PARAMETER,Sign_MemberTable){
	Server.addDebugLog(&quot;CAll addAsignList ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
		SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;				
		SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
		SQL += &quot; and B.KEY1 = &apos;&quot;+companyID+&quot;&apos;&quot;  ;	
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
		SQL += &quot; and C.MEMID=B.VALUE2&quot;;
		
	  try{
	  	var vec = Server.SQLloadValue(SQL);			
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;);				 
			      var cMember = Server.getMemberByID(memid);					  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);			  
		           }		  				  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  

					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;
					

				if(Dauble_flag != &quot;Y&quot;){
				   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, companyID+PARAMETER);				    
					      SignTable.add(row,hm);
				   var new_record =&quot;Y&quot; ;
				  
				}
			 }//for
			//寫入會簽群組Table，子流程使用
		    if (SignTable_G != null){			
			  if (new_record == &quot;Y&quot;){				 
				var Dauble_flag_G = memisDauble(SignTable_G,companyID+PARAMETER) ;
			     if(Dauble_flag_G != &quot;Y&quot;){
					var hm1 = new java.util.HashMap();
                    var row1 = SignTable_G.size();//SignTable裡資料筆數		
						hm1.put(&quot;ITEM1&quot;, companyID+PARAMETER);	
						SignTable_G.add(row1,hm1);
		        }
			  }	
		    }		
		}else{			
			Server.addInfoLog(companyID+&quot;_&quot;+PARAMETER+&quot;沒有設定會簽人員!&quot;+memid);
		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignList !!!\n&quot;+SQL+memid);
	}
	Server.addDebugLog(&quot;CAll addAsignList ===&gt;&gt; End &quot;);
}//function addAsignList

function mecn_local_qae(MyTask){	
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();		
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
	// 清空設定相關單位會簽人員 table 
	//設定 OP 會簽群組 
	var sign_table =&quot;Assign_Table&quot;;
	var sign_table_G =sign_table + &quot;_G&quot;;
	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();	

	// 設定相關單位會簽人員
	addAsignList(MyTask,v_factory,&quot;PLM_QAE&quot;,sign_table);       //QA Local			
}//function mecn_local_qae

function mecn_qc(MyTask){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();		
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);
	var sign_table =&quot;Assign_Table&quot;;	
	var sign_table_G =sign_table + &quot;_G&quot;; 	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();
	addAsignList(MyTask,v_factory,&quot;PLM_QC&quot;,sign_table);       //QC 單位主管
//	if(v_factory==&quot;TGCE&quot;){
//		addAsignList(MyTask,v_factory,&quot;PLM_QC_1&quot;,sign_table);       //QC 單位主管(TGCE詹錢富也要簽)
//	}			
}

function mecn_dep(MyTask){
	Server.addDebugLog(&quot;CAll mecn_dep ===&gt;&gt; Start&quot;);
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();		
	var	FLOWTYPE=dataMap.get(&quot;FLOWTYPE&quot;).substring(0,2); 
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
	// 清空設定相關單位會簽人員 table 
	//設定 OP 會簽群組 
	var sign_table =&quot;Assign_Table&quot;;	
	var sign_table_G =sign_table + &quot;_G&quot;; 	
	dataMap.get(sign_table).clear();	
    dataMap.get(sign_table_G).clear();	
	var customer_id = &quot;ALL&quot;;
    try{
		customer_id = dataMap.get(&quot;item_no&quot;).substr(0,3); 
	}catch(e){
		var customer_id = &quot;ALL&quot;;
		java.lang.System.out.println(&quot;MECN_error=&quot;+e);
	}
    var dep_id = dataMap.get(&quot;App_Dep_ID&quot;); 		
		    
	loadLibrary(&quot;com.gce.Common.Server.SendMail&quot;);

	var process_type = MyTask.artInstance.name;
	if( process_type.indexOf(&quot;MECN申請單&quot;)&gt;=0 ){
//		if(dep_id == &quot;2R2&quot;){
//			addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;MFG_M&quot;,dep_id);   //2R2特殊會簽人員 -江世豐經理
//		}			  
		addAsign_MECN_MFG(MyTask,v_factory,&quot;MFG_AddAs_Table&quot;,sign_table);    //MFG主管
		
		//Local QAE 若填寫&quot;不符合客規&quot;, 則流程需簽到PM
	    if(dataMap.get(&quot;FRadioButton_w33&quot;)== &quot;true&quot;){
		    addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,sign_table,customer_id);	 //PM by Account	
        }
		
		if( dataMap.get(&quot;ab_1&quot;) == &quot;true&quot; || dataMap.get(&quot;ab_2&quot;) == &quot;true&quot;){
			addAsignList(MyTask,v_factory,&quot;PLM_Purchasing_M&quot;,sign_table);   //Purchasing Department經理(all)			
		}
		if(dataMap.get(&quot;k_3&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_1&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_2&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_3&quot;)==&quot;true&quot;
			|| dataMap.get(&quot;ab_6&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_7&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_9&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_9&quot;)==&quot;true&quot;
			|| dataMap.get(&quot;c2_1&quot;)==&quot;true&quot; || dataMap.get(&quot;c2_3&quot;)==&quot;true&quot; || dataMap.get(&quot;c2_6&quot;)==&quot;true&quot; || dataMap.get(&quot;d_1&quot;)==&quot;true&quot; || dataMap.get(&quot;d_2&quot;)==&quot;true&quot;){
			addAsignList(MyTask,v_factory,&quot;PLM_MECN_EHS&quot;,sign_table);   //會簽環工主管		
		}
		//mail通知物管主管
		if(dataMap.get(&quot;k_8&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_1&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_2&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_3&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_4&quot;)==&quot;true&quot;){							
			sendMailByPara_(&quot;PLM_MECN_Process&quot;,v_factory,&quot;物管主管&quot;,&quot;【通知物管主管】&quot;,&quot;1&quot;);
		}
		
	}else if(process_type.indexOf(&quot;MECN實驗結果&quot;)&gt;=0){
//		if(dep_id == &quot;2R2&quot;){
//			addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;MFG_M&quot;,dep_id);   //2R2特殊會簽人員 -江世豐經理
//		}			  
		addAsign_MECN_MFG(MyTask,v_factory,&quot;MFG_AddAs_Table&quot;,sign_table);    //MFG主管
		//mail通知物管主管
		if(dataMap.get(&quot;k_8&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_1&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_2&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_3&quot;)==&quot;true&quot; || dataMap.get(&quot;ab_4&quot;)==&quot;true&quot;){
			sendMailByPara_(&quot;PLM_MECN_Process&quot;,v_factory,&quot;物管主管&quot;,&quot;【通知物管主管】&quot;,&quot;1&quot;);
		}
	}else{
		//modify by edison@20170123 (王立中提出不簽)
//		addAsignCustomer(MyTask,v_factory,&quot;PLM_CS&quot;,sign_table,customer_id);     //CS by Account  
		if( dataMap.get(&quot;ab_1&quot;) == &quot;true&quot; || dataMap.get(&quot;ab_2&quot;) == &quot;true&quot;){			
			sendMailByPara_(&quot;PLM_Purchasing_M&quot;,v_factory,&quot;&quot;,&quot;【通知採購主管】&quot;,&quot;1&quot;);
			sendMailByPara_(&quot;PLM_IE_M&quot;,v_factory,&quot;&quot;,&quot;【通知IE主管】&quot;,&quot;1&quot;);
		}
		
		//mail通知它廠物管主管及它廠工程人員
		var table3 = dataMap.get(&quot;Table3&quot;);
		if(table3.size()&gt;0){
			var to = &quot;&quot;;
			for(var i = 0;i&lt;table3.size();i++){
				var member = Server.getMember(table3.get(i).get(&quot;ITEM1&quot;));
				var areacode = member.getAreaCode();
				sendMailByPara_(&quot;PLM_MECN_Process&quot;,areacode,&quot;物管主管&quot;,&quot;【通知物管主管】&quot;,&quot;1&quot;);
				to +=Server.getMember(table3.get(i).get(&quot;ITEM1&quot;)).getEmail()+&quot;;&quot;;
			}
			sendMail(to,&quot;【通知它廠工程人員】&quot;,&quot;1&quot;);
		}
		
		//mail通知通知MFG主管
		var mfg = dataMap.get(&quot;MFG_AddAs_Table&quot;);
		if(mfg.size()&gt;0){
			var to = &quot;&quot;;
			for(var i = 0;i&lt;mfg.size();i++){				
				to +=Server.getMember(mfg.get(i).get(&quot;ITEM2&quot;)).getEmail()+&quot;;&quot;;
			}
			sendMail(to,&quot;【通知MFG主管】&quot;,&quot;1&quot;);
		}
		
		//Local QAE 若填寫&quot;不符合客規&quot;, 則mail通知PM
	    if(dataMap.get(&quot;FRadioButton_w33&quot;)== &quot;true&quot;){		    
			var to = getAsignCustMail(MyTask,v_factory,&quot;PLM_PM&quot;,customer_id);
			sendMail(to,&quot;【通知PM人員】&quot;,&quot;1&quot;);
        }
	}	
	//當勾選 四、在製品處理方式 - 【需要清線不可跟前板混用】
	//三階段都要簽
	if( dataMap.get(&quot;ab_1&quot;) == &quot;true&quot; || dataMap.get(&quot;ab_2&quot;) == &quot;true&quot; || dataMap.get(&quot;FRadioButton_w44&quot;) == &quot;true&quot;){			
		addAsignList(MyTask,v_factory,&quot;PLM_MA_M&quot;,sign_table);            //物管
	}
	
	addAsignList(MyTask,v_factory,&quot;PLM_QA_SC&quot;,sign_table);       //QAE 單位主管
	if(v_factory==&quot;HGCE&quot;){
		addAsignList(MyTask,v_factory,&quot;PLM_QA_SC_A&quot;,sign_table);       //靖新平說他要簽 add by edison@20170421
	}
//	if(v_factory==&quot;SGCE&quot;){
//		addAsignList(MyTask,v_factory,&quot;PLM_QA_SC_S&quot;,sign_table);       //S廠朱昌輝也要簽 add by edison@20120903
//	}
	if(dataMap.get(&quot;isCar&quot;) == &quot;true&quot;){//add by edison@20171219 汽車板會簽                   
		addAsignList_apqp(MyTask,v_factory,&quot;PLM_MECN_APQP&quot;,sign_table);            //APQP小組
		                                                                                     
	}          
	
	
	Server.addDebugLog(&quot;CAll mecn_dep ===&gt;&gt; End&quot;);
}//function mecn_dep()

function mecn_de(MyTask){
	Server.addDebugLog(&quot;CAll mecn_de ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);  
	var sign_table =&quot;Assign_Table&quot;;
	var sign_table_G =sign_table + &quot;_G&quot;;
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table+&quot;_G&quot;).clear();	
	// 設定相關單位會簽人員	 
	if(dataMap.get(&quot;MemTable_DE&quot;).size()&lt;=0 ){
		addAsignList(MyTask,v_factory,&quot;PLM_OP&quot;,&quot;MemTable_DE&quot;);         //DE執行 會簽人員		   
    }
    addAsign_MECN_TEMP(MyTask,v_factory,&quot;MemTable_DE&quot;,sign_table)    //DE執行 會簽人員	   
    	 
	Server.addDebugLog(&quot;CAll mecn_de ===&gt;&gt; End&quot;);	 
}//function mecn_de

function mecn_de_m(MyTask){
	Server.addDebugLog(&quot;CAll mecn_de_m ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance(); 
	var dataMap = aInstance.getAppDataMap();	 
	var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);  
	var FLOWTYPE = dataMap.get(&quot;FLOWTYPE&quot;).substr(0,2);  
	
	var sign_table =&quot;Assign_Table&quot;;	
	var sign_table_G =sign_table + &quot;_G&quot;;	   	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();	
	 
	// 設定相關單位會簽人員
	if(FLOWTYPE.equals(&quot;A類&quot;) ||FLOWTYPE.equals(&quot;B類&quot;)){
	    addAsignList(MyTask,v_factory,&quot;PLM_OPM_A_TYPE&quot;,sign_table);  //DE  單位主管 - DE審核、作廢會簽
	}else{
		addAsignList(MyTask,v_factory,&quot;PLM_OPM&quot;,sign_table);         //DE  單位主管 - DE審核、作廢會簽
	}	
	Server.addDebugLog(&quot;CAll mecn_de_m ===&gt;&gt; End&quot;);
}//function mecn_de_m

function addAsignList_VP(MyTask,companyID,PARAMETER,Sign_MemberTable,temp1,temp2){
	Server.addDebugLog(&quot;CAll addAsignList_VP ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
		SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;			
		SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
		SQL += &quot; and B.KEY1 = &apos;&quot;+companyID+&quot;&apos;&quot;  ;	
        SQL += &quot; and B.VALUE3 like &apos;%&quot; + temp1 + &quot;%&apos; &quot;;	
		if( temp1 == &quot;PE_MAX&quot;){
        SQL += &quot; and B.VALUE2 &lt;&gt;&apos;&quot; + dataMap.get(&quot;director_memid&quot;) + &quot;&apos; &quot;;				
        }		
		if(temp2!=&quot;&quot;){
	      if((companyID == &quot;TGCE&quot; &amp;&amp;  temp2.substr(0,2)== &quot;2J&quot; ) ||
		     (companyID == &quot;TGCE&quot; &amp;&amp;  temp2.substr(0,3)== &quot;2R2&quot; ) ||
	          companyID == &quot;HGCE&quot;){			
           SQL += &quot; and B.description like &apos;%&quot; + temp2.substr(0,2) + &quot;%&apos; &quot;;			
		  }else{
		   SQL += &quot; and B.description is null&quot;;		   
		  } 
		}
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
		SQL += &quot; and C.MEMID=B.VALUE2&quot;;
	var vec = Server.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Server.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
				  var Dauble_flag = memisDauble(SignTable,memid) ;
				  var cmemid = memid ;
				  
				if(Dauble_flag != &quot;Y&quot;){
                   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, companyID+temp1);				    
					      SignTable.add(row,hm);
				   var new_record =&quot;Y&quot; ;
				}
			 }//for
			//寫入會簽群組Table，子流程使用
  	        if (SignTable_G != null){
			 if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble(SignTable_G,companyID+temp1);
			     if(Dauble_flag_G != &quot;Y&quot;){
					var hm1 = new java.util.HashMap();
                    var row1 = SignTable_G.size();//SignTable裡資料筆數		
						hm1.put(&quot;ITEM1&quot;, companyID+temp1);	
						SignTable_G.add(row1,hm1);
		         }	
		      }
		   }	
		}else{
			Server.addInfoLog(companyID+&quot;_&quot;+temp1+&quot;沒有設定會簽人員!&quot;+memid);			
		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignList_temp !!!\n&quot;+SQL+memid);
	}
	Server.addDebugLog(&quot;CAll addAsignList_VP ===&gt;&gt; End&quot;);
}//function addAsignList_VP

function addAsign_MECN_MFG(MyTask,companyID,table,Sign_MemberTable){
	Server.addDebugLog(&quot;CAll addAsign_MECN_MFG ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var table = dataMap.get(table);
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);

	try{	
	 if (table.size()&gt;0){		
	 for(var i =0;i&lt;table.size();i++){
		 var cmemid = table.get(i).get(&quot;ITEM2&quot;);
		 var cMember = table.get(i).get(&quot;ITEM4&quot;);
		 var dptcname = table.get(i).get(&quot;ITEM1&quot;);
		 var memDR = table.get(i).get(&quot;ITEM9&quot;);
		 var groupid = &quot;MFG_&quot;+table.get(i).get(&quot;ITEM1&quot;);	
		 
	   var Dauble_flag = memisDauble(SignTable,cmemid);	
	   
	   if(Dauble_flag != &quot;Y&quot;){	 
		 var hm = new java.util.HashMap();
		 var row = SignTable.size();//SignTable裡資料筆數
		     hm.put(&quot;ITEM1&quot;, cmemid);
			 hm.put(&quot;ITEM3&quot;, cMember);
			 hm.put(&quot;ITEM4&quot;, dptcname);
			 hm.put(&quot;ITEM2&quot;, memDR);
			 hm.put(&quot;ITEM5&quot;, groupid);				    
			 SignTable.add(row,hm);
		 var new_record =&quot;Y&quot; ;  
		}
	    //寫入會簽群組Table，子流程使用
		if (SignTable_G != null){
		    if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble(SignTable_G,groupid) ;
				    if(Dauble_flag_G != &quot;Y&quot;){
				   	   var hm1 = new java.util.HashMap();
                       var row1 = SignTable_G.size();//SignTable裡資料筆數		
						   hm1.put(&quot;ITEM1&quot;, groupid);	
						   SignTable_G.add(row1,hm1);
		            }
			 }
		 }	
	 }//for
	}// if (table.size()&gt;0)
   }catch(e){
	Server.addInfoLog(&quot;讀取參數檔失敗 addAsign_MECN_MFG !!!\n&quot;+SQL+memid);
   }
   	Server.addDebugLog(&quot;CAll addAsign_MECN_MFG ===&gt;&gt; End&quot;);
}//function addAsign_MECN_MFG

function addAsignCustomer(MyTask,companyID,PARAMETER,Sign_MemberTable,item_no){ 
//PLM PM CS角色
	Server.addDebugLog(&quot;CAll addAsignCustomer ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
		SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;			
		SQL += &quot; and A.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		SQL += &quot; and B.KEY1 in (&apos;&quot;+ companyID +&quot;&apos;) &quot;  ;	
		SQL += &quot; and B.VALUE3 LIKE &apos;%&quot;+ item_no +&quot;%&apos; &quot;  ;
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
		SQL += &quot; and C.MEMID=B.VALUE2&quot;;
		
  var vec = Server.SQLloadValue(SQL);
  try{			
    if ( vec != null ){
	   if (vec.size()&gt;0){
		   var new_record =&quot;&quot;;
		  for(var i=0;i&lt;vec.size();i++)  {
			  var ht = vec.get(i);
			  var memid = ht.get(&quot;memid&quot;)
			  var cMember = Server.getMemberByID(memid);			  
			  if(cMember == null){
              // 檢核員工是否是有效的,若無效基本上會傳給PDM , 
				memid = &quot;MEMPDM0001&quot;  	
				var cMember = Server.getMemberByID(memid);
			  }		  
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);		  
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  
//			  //離職人員判斷，若離職則轉單至ADM
//				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;
//			    }else{
//					 var Dauble_flag = memisDauble(SignTable,memid) ;	
//					 var cmemid = &quot;PDM&quot; ;	 
//				}//if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;)
//
				if(Dauble_flag != &quot;Y&quot;){
                   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, companyID+PARAMETER);				    
					      SignTable.add(row,hm);		   
				   var new_record =&quot;Y&quot; ;
				}
			 }//for
			//寫入會簽群組Table，子流程使用
 	        if (SignTable_G != null){
			  if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble(SignTable_G,companyID+PARAMETER) ;
				 if(Dauble_flag_G != &quot;Y&quot;){
					var hm1 = new java.util.HashMap();
                    var row1 = SignTable_G.size();//SignTable裡資料筆數		
						hm1.put(&quot;ITEM1&quot;, companyID+PARAMETER);	
						SignTable_G.add(row1,hm1);
		          }
			  }
		    }		
			  
		  }else{
                 var item_no=&quot;ALL&quot;;
		         var SQL_1  = &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
				     SQL_1 += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		             SQL_1 += &quot; where  A.ACTIVE = &apos;true&apos; &quot;;
               		 SQL_1 += &quot; and C.RESIGN = &apos;false&apos;&quot; ;							 
		             SQL_1 += &quot; and A.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		             SQL_1 += &quot; and B.KEY1 in (&apos;&quot;+ companyID +&quot;&apos;) &quot;  ;	
		             SQL_1 += &quot; and B.VALUE3 LIKE &apos;%&quot;+ item_no +&quot;%&apos; &quot;  ;
                     SQL_1 += &quot; and A.PARAMETER = B.PARAMETER &quot;;					 
		             SQL_1 += &quot; and C.MEMID=B.VALUE2&quot;;
		
 	             var vec_1 = Server.SQLloadValue(SQL_1);
				 
				 if (vec_1.size()&gt;0){
		             for(var i=0;i&lt;vec_1.size();i++)  {			 
			             var ht = vec_1.get(i);
			             var memid = ht.get(&quot;memid&quot;)
			             var cMember = Server.getMemberByID(memid);	
					 
//			             if(cMember == null){
//                            // 檢核員工是否是有效的,若無效基本上會傳給PDM , 
//				            memid = &quot;MEMPDM0001&quot; 
//				            var cMember = Server.getMemberByID(memid);	
//			             }
			               var roleID = cMember.getMainRoleID();
			               var memDR =  cMember.getMemberDR(roleID);		  
			               var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  
//			               //離職人員判斷，若離職則轉單至ADM
//				           if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
//					           SignTable.setValueAt(memid,row,&quot;memid&quot;);
					       var Dauble_flag = memisDauble(SignTable,memid) ;
					       var cmemid = memid ;
//			               }else{
//						       SignTable.setValueAt(&quot;MEMPDM0001&quot;,row,&quot;memid&quot;);
//						   }
				    if(Dauble_flag != &quot;Y&quot;){
                      var hm = new java.util.HashMap();
				      var row = SignTable.size();//SignTable裡資料筆數
					      hm.put(&quot;ITEM1&quot;, cmemid);
					      hm.put(&quot;ITEM3&quot;, cMember);
					      hm.put(&quot;ITEM4&quot;, dptcname);
					      hm.put(&quot;ITEM2&quot;, memDR);
					      hm.put(&quot;ITEM5&quot;, companyID+PARAMETER);				    
					         SignTable.add(row,hm);		   
				      var new_record =&quot;Y&quot; ;
				    }
			       }//for			
			     if (SignTable_G != null){
			       if (new_record == &quot;Y&quot;){
			           var Dauble_flag_G = memisDauble(SignTable_G,companyID+PARAMETER) ;
				        if(Dauble_flag_G != &quot;Y&quot;){
				   	       var hm1 = new java.util.HashMap();
                           var row1 = SignTable_G.size();//SignTable裡資料筆數		
						       hm1.put(&quot;ITEM1&quot;, companyID+PARAMETER);	
						       SignTable_G.add(row1,hm1);
		                }
			       }
		         }
				}else{	
			       Server.addInfoLog(companyID+&quot;_&quot;+PARAMETER+&quot;沒有設定會簽人員!&quot;+memid);		
		       } //if (vec_1.size()&gt;0)  
		  }//if (vec.size()&gt;0)	  
	}//if ( vec != null )
  }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignCustomer !!!\n&quot;+SQL+memid);
 }		
 	Server.addDebugLog(&quot;CAll addAsignCustomer ===&gt;&gt; End&quot;);
}//function addAsignCustomer

function getAsignCustMail(MyTask,companyID,PARAMETER,item_no){ 

	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
		SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;			
		SQL += &quot; and A.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		SQL += &quot; and B.KEY1 in (&apos;&quot;+ companyID +&quot;&apos;) &quot;  ;	
		SQL += &quot; and B.VALUE3 LIKE &apos;%&quot;+ item_no +&quot;%&apos; &quot;  ;
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
		SQL += &quot; and C.MEMID=B.VALUE2&quot;;
		
	var vec = Server.SQLloadValue(SQL);
	try{			
		if ( vec != null ){
			var email = &quot;&quot;
			if (vec.size()&gt;0){		   
				for(var i=0;i&lt;vec.size();i++)  {
					var ht = vec.get(i);
					var memid = ht.get(&quot;memid&quot;);
					var mail = Server.getMemberByID(memid).getEmail();
					if(email.indexOf(mail)==-1){
						email += mail+&quot;;&quot;;
					}			  
				}//for			  
			}else{
                 var item_no=&quot;ALL&quot;;
		         var SQL_1  = &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
				     SQL_1 += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		             SQL_1 += &quot; where  A.ACTIVE = &apos;true&apos; &quot;;
               		 SQL_1 += &quot; and C.RESIGN = &apos;false&apos;&quot; ;							 
		             SQL_1 += &quot; and A.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		             SQL_1 += &quot; and B.KEY1 in (&apos;&quot;+ companyID +&quot;&apos;) &quot;  ;	
		             SQL_1 += &quot; and B.VALUE3 LIKE &apos;%&quot;+ item_no +&quot;%&apos; &quot;  ;
                     SQL_1 += &quot; and A.PARAMETER = B.PARAMETER &quot;;					 
		             SQL_1 += &quot; and C.MEMID=B.VALUE2&quot;;
		
 	             var vec_1 = Server.SQLloadValue(SQL_1);
				 
				 if (vec_1.size()&gt;0){
		             for(var i=0;i&lt;vec_1.size();i++)  {			 
			             var ht = vec_1.get(i);
			             var memid = ht.get(&quot;memid&quot;)
			             var mail = Server.getMemberByID(memid).getEmail();
						 if(email.indexOf(mail)==-1){
							 email += mail+&quot;;&quot;;
						 }
					 }//for			

				}  
		  }//if (vec.size()&gt;0)
		  return email;
	}//if ( vec != null )
  }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignCustomer !!!\n&quot;+SQL+memid);
 }		
 	
}

function mecn_qa_m(MyTask){//QA 部門主管
	Server.addDebugLog(&quot;CAll mecn_qa_m ===&gt;&gt; Start&quot;);
   var aInstance = MyTask.getArtInstance(); 
   var dataMap = aInstance.getAppDataMap();
   var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
   var sign_table =&quot;Assign_Table&quot;;	   	
   var sign_table_G =sign_table + &quot;_G&quot;;	   	
   dataMap.get(sign_table).clear();	
   dataMap.get(sign_table_G).clear();			 
   // 設定相關單位會簽人員
   addAsignList(MyTask,v_factory,&quot;PLM_QA_M&quot;,sign_table);           //QA M經理(all)    
	
   Server.addDebugLog(&quot;CAll mecn_qa_m ===&gt;&gt; End&quot;);
}// function mecn_qa_m

function mecn_qa_dep(MyTask){//QA 處級主管
	Server.addDebugLog(&quot;CAll mecn_qa_m ===&gt;&gt; Start&quot;);
   var aInstance = MyTask.getArtInstance(); 
   var dataMap = aInstance.getAppDataMap();
   var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
   var sign_table =&quot;Assign_Table&quot;;	   	
   var sign_table_G =sign_table + &quot;_G&quot;;	   	
   dataMap.get(sign_table).clear();	
   dataMap.get(sign_table_G).clear();			 
   // 設定相關單位會簽人員
   addAsignList(MyTask,v_factory,&quot;PLM_QA_M_A&quot;,sign_table);           //QA 處級主管    
	
   Server.addDebugLog(&quot;CAll mecn_qa_m ===&gt;&gt; End&quot;);
}// function mecn_qa_m

function mecn_qa_top(MyTask){
	Server.addDebugLog(&quot;CAll mecn_qa_top ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);	
	var sign_table =&quot;Assign_Table&quot;;		
	var sign_table_G =sign_table + &quot;_G&quot;;
	   	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();			 
	// 設定相關單位會簽人員
	addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;QA_TOP&quot;,&quot;&quot;);          //QA_協理	
	Server.addDebugLog(&quot;CAll mecn_qa_top ===&gt;&gt; End&quot;);	  
}//  function mecn_qa_top

function mecn_qa_dpt(MyTask){
	Server.addDebugLog(&quot;CAll mecn_qa_top ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);	
	var sign_table =&quot;Assign_Table&quot;;		
	var sign_table_G =sign_table + &quot;_G&quot;;
	   	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();			 
	// 設定相關單位會簽人員
	addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;QA_DEP&quot;,&quot;&quot;);        //QA	//吳明源	
	Server.addDebugLog(&quot;CAll mecn_qa_top ===&gt;&gt; End&quot;);	  
}//  function mecn_qa_top

function memisDauble(table,temp){
        var flag =&quot;&quot;;
		for(var j = 0;j&lt;table.size();j++){
			if(table.get(j).get(&quot;ITEM1&quot;).equals(temp)){
		 		var flag =&quot;Y&quot;;
			}
		}
		return flag ;		
}//function memisDauble

function mecn_dep_m(MyTask){
	Server.addDebugLog(&quot;CAll mecn_dep_m ===&gt;&gt; Start&quot;);
	var artIns = MyTask.getArtInstance(); 
	var dataMap = artIns.getAppDataMap();	
	var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);  
	var FLOWTYPE = dataMap.get(&quot;FLOWTYPE&quot;).substring(0,2);  
	// 清空設定相關單位會簽人員 table	
	var sign_table =&quot;Assign_Table&quot;;	
	var sign_table_G =sign_table + &quot;_G&quot;;	   
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();	
	   
	// 設定相關單位會簽人員
    var dep_id = dataMap.get(&quot;App_Dep_ID&quot;);
    var app_dep= dataMap.get(&quot;App_Dep&quot;);		
	
   	if((dep_id.indexOf(&quot;2J&quot;)&gt;=0 &amp;&amp; app_dep.indexOf(&quot;HDI&quot;)&gt;=0)||(dep_id.indexOf(&quot;2R&quot;)&gt;=0 &amp;&amp; app_dep.indexOf(&quot;HDI&quot;)&gt;=0)){
		addAsignList(MyTask,&quot;HGCE&quot;,&quot;PLM_OP&quot;,&quot;Mail_Group&quot;);     //2J0:HDI工程技術處” 開出來的MECN ，DE OP 執行的同時，需發MAIL 通知 HGCE DE群組(5901DE工程問題).      
	}
    
	addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;VP_MAX&quot;,&quot;&quot;);        //VP
		
	
	addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;PE_MAX&quot;,&quot;&quot;);        //各工程單位最高主管		
		  
	addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;Tech_VP&quot;,dep_id);   //Tech_VP 會簽人員	
	
	//modify by edison@20160711 改陳佩
	//addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;DE_TOP&quot;,&quot;&quot;);  //20160721 孫冰芳說陳佩不簽，所以取消
	
	//add by edison@20160714 孫冰芳也要簽，故另加一個參數檔	
	addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;DETOP&quot;,&quot;&quot;);
	
	//SGCE吳明源副處不簽 add by edison@20140109
	if(v_factory!=&quot;SGCE&quot;){
		addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;QA_DEP&quot;,&quot;&quot;);        //QA	//吳明源
	}
	
	Server.addDebugLog(&quot;CAll mecn_dep_m ===&gt;&gt; End&quot;);		
}//function mecn_dep_m(MyTask)

function dp_manager(MyTask,temp,level){
	Server.addDebugLog(&quot;CAll dp_manager ===&gt;&gt; Start&quot;);
	 var aInstance = MyTask.getArtInstance();
	 var dataMap = aInstance.getAppDataMap()		
	 var dep_id = dataMap.get(&quot;App_Dep_ID&quot;);
	 var app_memid = dataMap.get(&quot;App_MemID&quot;);
     var v_memid =&quot;&quot;;	 
	 try{
		//Select 部門單位主管 SQL	 
		var SQL_a  = &quot;SELECT distinct(e.MEMID) as empcode, e.USERNAME,e.JOBTITLE,e.PAGER,substr(e.MAINROLEID,8,3)ROLEID &quot;;
            SQL_a += &quot;from mem_geninf e &quot;;
            SQL_a += &quot;where e.memid =&apos;&quot;+app_memid+&quot;&apos;&quot;;
 	     var vec = Server.SQLloadValue(SQL_a);
         if (vec.size()&gt;0){
			var memid = vec.get(0).get(&quot;empcode&quot;);
			var managerid = vec.get(0).get(&quot;PAGER&quot;);
			var roleid = java.lang.Integer.parseInt(vec.get(0).get(&quot;ROLEID&quot;));
			
            if (roleid &lt; temp){
                 v_memid = check_roleid(managerid,temp);
			}else{
				 v_memid = memid;
			}
		 }
	 }catch(e){	  
	 }
	Server.addDebugLog(&quot;CAll dp_manager ===&gt;&gt; End&quot;);	 
	 return v_memid ;
 }//function dp_manager()
 
 function check_roleid(managerid,temp){ 
	Server.addDebugLog(&quot;CAll  check_roleid ===&gt;&gt; Start&quot;);
	var SQL_b  = &quot;SELECT distinct(e.MEMID) as empcode, e.USERNAME,e.JOBTITLE,e.PAGER,substr(e.MAINROLEID,8,3)ROLEID &quot;;
        SQL_b += &quot;from  mem_geninf e  &quot;;
        SQL_b += &quot;where e.memid =&apos;&quot;+managerid+&quot;&apos; &quot;;
        SQL_b += &quot;and e.DENIEDLOGIN = &apos;false&apos; &quot;;
	var vec1 = Server.SQLloadValue(SQL_b);
	
	if (vec1.size()&gt;0){
  	    var memid = vec1.get(0).get(&quot;empcode&quot;);
		var managerid = vec1.get(0).get(&quot;PAGER&quot;);
	    var roleid = java.lang.Integer.parseInt(vec1.get(0).get(&quot;ROLEID&quot;));
		
		if (roleid &lt; temp){
            v_memid = check_roleid(managerid,temp);
		}else{
            v_memid = memid;
		}
	}//if (vec1.size()&gt;0)
	Server.addDebugLog(&quot;CAll  check_roleid ===&gt;&gt; End&quot;);
	 return v_memid ;	
}//function check_roleid() 

function sendMail(to,subject,state){
	var InsID = MyTask.getArtInstance();
	var dataMap = InsID.getAppDataMap();	
	var roottaskname = MyTask.getRootName();
	var from= Server.getMember(&quot;Administrator&quot;).getEmail();//系統管理員為寄件者
	var cc = &quot;&quot;;
	var subject_txt = &quot;&quot;;
	if(state==&quot;1&quot;){
		subject_txt = subject+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject
	}
	if(state==&quot;2&quot;){
		subject_txt = subject+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」流程已結案&quot;; // Mail Subject
	}

	var text = getAcceptMailContent_(dataMap,state);
	var fileList = new Packages.java.util.Vector(); 
	if(to!=&quot;&quot;){
		Server.sendHTMLMailExt(from,to,cc,subject_txt,text,fileList,MyTask);
	}  
 }

 function addAsign_MECN_TEMP(MyTask,companyID,table,Sign_MemberTable){
	Server.addDebugLog(&quot;CAll addAsign_MECN_TEMP ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var table = dataMap.get(table);
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);

	try{	
	 if (table.size()&gt;0){		
	 for(var i =0;i&lt;table.size();i++){
	   var cmemid = table.get(i).get(&quot;ITEM1&quot;);
	   var groupid = table.get(i).get(&quot;ITEM5&quot;);	   
	   var Dauble_flag = memisDauble(SignTable,cmemid);	
	   
	   if(Dauble_flag != &quot;Y&quot; &amp;&amp; table!=Sign_MemberTable){	 
		 var hm = new java.util.HashMap();
		 var row = SignTable.size();//SignTable裡資料筆數
		     hm.put(&quot;ITEM1&quot;, table.get(i).get(&quot;ITEM1&quot;));
			 hm.put(&quot;ITEM3&quot;, table.get(i).get(&quot;ITEM3&quot;));
			 hm.put(&quot;ITEM4&quot;, table.get(i).get(&quot;ITEM4&quot;));
			 hm.put(&quot;ITEM2&quot;, table.get(i).get(&quot;ITEM2&quot;));
			 hm.put(&quot;ITEM5&quot;, table.get(i).get(&quot;ITEM5&quot;));				    
			 SignTable.add(row,hm);
		 var new_record =&quot;Y&quot; ;  
		}
	    //寫入會簽群組Table，子流程使用
		if (SignTable_G != null){
		    if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble(SignTable_G,groupid) ;
				    if(Dauble_flag_G != &quot;Y&quot;){
				   	   var hm1 = new java.util.HashMap();
                       var row1 = SignTable_G.size();//SignTable裡資料筆數		
						   hm1.put(&quot;ITEM1&quot;, groupid);	
						   SignTable_G.add(row1,hm1);
		            }
			 }
		 }	
	 }//for
	}// if (table.size()&gt;0)
   }catch(e){
	Server.addInfoLog(&quot;讀取參數檔失敗 addAsign_MECN_TEMP !!!\n&quot;+SQL+memid);
   }
   	Server.addDebugLog(&quot;CAll addAsign_MECN_TEMP ===&gt;&gt; End&quot;);
}//function addAsign_MECN_TEMP

function addAsignList_kd(MyTask,Sign_MemberTable){
	Server.addDebugLog(&quot;CAll addAsignList ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	dataMap.get(Sign_MemberTable).clear();	
	dataMap.get(Sign_MemberTable + &quot;_G&quot;).clear();
	var SQL =  &quot; select managerid from dep_geninf where id in (&apos;6J0&apos;,&apos;6B2&apos;,&apos;6P2&apos;,&apos;6P3&apos;,&apos;6G0&apos;) &quot;;
		SQL += &quot;union all &quot;;
		SQL += &quot;select memid  as managerid from mem_geninf where username in (&apos;宋文淦&apos;,&apos;甘能勝&apos;,&apos;鐘國全&apos;,&apos;董進華&apos;) &quot;;//因為這些人不是掛部門主管
	   
		
	  try{
	  	var vec = Server.SQLloadValue(SQL);			
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;managerid&quot;);				 
			      var cMember = Server.getMemberByID(memid);					  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);			  
		           }		  				  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  

					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;
					

				if(Dauble_flag != &quot;Y&quot;){
				   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, memid);				    
					      SignTable.add(row,hm);
				   var new_record =&quot;Y&quot; ;
				   
				   //寫入會簽群組Table，子流程使用
				   if (SignTable_G != null){			
					   if (new_record == &quot;Y&quot;){				 
						   var Dauble_flag_G = memisDauble(SignTable_G,memid) ;
						   if(Dauble_flag_G != &quot;Y&quot;){
							   var hm1 = new java.util.HashMap();
							   var row1 = SignTable_G.size();//SignTable裡資料筆數		
							   hm1.put(&quot;ITEM1&quot;,memid);	
							   SignTable_G.add(row1,hm1);
						   }
					   }	
				   }
				  
				}
			 }//for
					
		}else{			
			Server.addInfoLog(&quot;addAsignList_kd 沒有設定會簽人員!&quot;+memid);
		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignList !!!\n&quot;+SQL+memid);
	}
	Server.addDebugLog(&quot;CAll addAsignList ===&gt;&gt; End &quot;);
}//function addAsignList

function addAsignList_apqp(MyTask,companyID,PARAMETER,Sign_MemberTable){            
	                                                                                  
	var aInstance = MyTask.getArtInstance();                                          
	var dataMap = aInstance.getAppDataMap();	                                        
	var SignTable = dataMap.get(Sign_MemberTable);                                    
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);                           
	                                                                                  
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;                
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;          
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;                                             
		SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;				                                      
		SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;                                    
		SQL += &quot; and B.KEY1 = &apos;&quot;+companyID+&quot;&apos;&quot;  ;	                                      
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		                                
		SQL += &quot; and C.MEMID=B.VALUE2&quot;;                                                 
		                                                                                
	  try{                                                                            
	  	var vec = Server.SQLloadValue(SQL);			                                      
		if ( vec != null ){                                                             
			if (vec.size()&gt;0){                                                            
				var new_record =&quot;&quot; ;                                                        
              for(var i=0;i&lt;vec.size();i++){                                        
			      var ht = vec.get(i);                                                    
			      var memid = ht.get(&quot;memid&quot;);				                                    
			      var cMember = Server.getMemberByID(memid);					                    
			       if(cMember == null){                                                   
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm ,                  
				   memid = &quot;MEMPDM0001&quot;                                                     
				   var cMember = Server.getMemberByID(memid);			                          
		           }		  				                                                      
			      var roleID = cMember.getMainRoleID();                                   
			      var memDR =  cMember.getMemberDR(roleID);		                            
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	                                                                          
                                                                                    
					var Dauble_flag = memisDauble(SignTable,memid) ;                          
					var cmemid = memid ;                                                      
					                                                                          
                                                                                    
				if(Dauble_flag != &quot;Y&quot;){                                                     
				   var hm = new java.util.HashMap();                                        
				   var row = SignTable.size();//SignTable裡資料筆數                         
					   hm.put(&quot;ITEM1&quot;, cmemid);                                               
					   hm.put(&quot;ITEM3&quot;, cMember);                                              
					   hm.put(&quot;ITEM4&quot;, dptcname);                                             
					   hm.put(&quot;ITEM2&quot;, memDR);                                                
					   hm.put(&quot;ITEM5&quot;, PARAMETER+cmemid);				                              
					      SignTable.add(row,hm);                                              
				   var new_record =&quot;Y&quot; ;                                                    
				                                                                            
				}                                                                           
				//寫入會簽群組Table，子流程使用                                             
				if (SignTable_G != null){			                                              
					if (new_record == &quot;Y&quot;){				                                            
						var Dauble_flag_G = memisDauble(SignTable_G,(PARAMETER+cmemid)) ;       
						if(Dauble_flag_G != &quot;Y&quot;){                                               
							var hm1 = new java.util.HashMap();                                    
							var row1 = SignTable_G.size();//SignTable裡資料筆數		                
							hm1.put(&quot;ITEM1&quot;, PARAMETER+cmemid);	                                  
							SignTable_G.add(row1,hm1);                                            
						}                                                                       
					}	                                                                        
				}                                                                           
			 }//for                                                                       
					                                                                          
		}else{			                                                                    
			Server.addInfoLog(companyID+&quot;_&quot;+PARAMETER+&quot;沒有設定會簽人員!&quot;+memid);         
		}//if (vec.size()&gt;0)                                                            
	   }//if ( vec != null )                                                          
	 }catch(e){                                                                       
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignList_apqp !!!\n&quot;+SQL+memid);          
	}                                                                                 
	                                                                                  
}                                                                                   
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00111102067208799</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/12/03 17:46:48</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.SystemFunction.MailForDepartment</string> 
     </void> 
     <void property="id"> 
      <string>SCL00111102067208799</string> 
     </void> 
     <void property="name"> 
      <string>MailForDepartment</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//取得文管中心所有成員的 Mail List, 以作為副件名單
function getDocumentCenterMailList(){
	var depName = &quot;資料中心&quot;;
	var result = &quot;&quot;;
	var department = Client.getOneDepartmentByName(depName);
	if(department!=null){
		var roleList = department.getRoleList();
		var i = roleList.iterator();
		while(i.hasNext()){
			var roleId = i.next();
			var role = Client.getRole(roleId);
			var memberList = role.getMemberList();
			var j = memberList.iterator();
			while(j.hasNext()){
				var memberId = j.next();
				var member = Client.getMemberByID(memberId);
				if(member != null){
					//避免重複寄送
					var index = mailList.indexOf(member.getEmail());
					if(index == -1)
						result += member.getEmail() + &quot;;&quot;;
				}
			}
		}	
	}
	return result;	
}
</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00111155897650750</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/08/18 18:40:50</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common</string> 
     </void> 
     <void property="id"> 
      <string>SCL00111155897650750</string> 
     </void> 
     <void property="name"> 
      <string>Common</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011152000677625</string> 
     </void> 
     <void property="scriptSource"> 
      <string>


 function del(tablename,ID){
	 var flg = false;
	 var sql_del = &quot; delete from &quot;+ tablename +&quot; where ID = &quot;+ ID + &quot; &quot;;
	 flg = Client.SQLupdateValue(sql_del);
	 return flg;
 }

function getNewID(tablename,id){
	var newid = 1;
	var sql_ver = &quot; select max(&quot; + id + &quot;) MAX_ID from &quot;+ tablename +&quot; where id is not null &quot; ;
	var vector_ver = Client.SQLloadValue(sql_ver);
	if(vector_ver.size()&gt;0 &amp;&amp; vector_ver.get(0).get(&quot;MAX_ID&quot;) != &quot;&quot; ){
		newid = java.lang.Integer.parseInt(vector_ver.get(0).get(&quot;MAX_ID&quot;)) + 1;
	}
	
	return newid;
}



 function setModifyValue(tablename){
	 var sql = &quot; select * from &quot;+ tablename + &quot; where ID = &quot;+ Form.getValue(&quot;ID&quot;)  ;
	 var dataVec = Client.SQLloadValue(sql);
	 if(dataVec.size() &gt; 0){
		 Form.setValue(&quot;Modify_ID&quot;,dataVec.get(0).get(&quot;Modify_ID&quot;));
		 Form.setValue(&quot;Modify_Date&quot;,dataVec.get(0).get(&quot;Modify_date&quot;));//.toString().substring(0,16));		
	 }
 }
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00111215581833819</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2017/07/17 09:31:49</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.RMA.RMASEARCH</string> 
     </void> 
     <void property="id"> 
      <string>SCL00111215581833819</string> 
     </void> 
     <void property="name"> 
      <string>RMASEARCH</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00061211339110866</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	if(vec.size()&gt;1000){  //  add by wangwei@2017/07/17
		Form.showMessageDialog(&quot;查詢結果超過1000筆\n請下條件查詢!!&quot;);
		return ;		
	}
	if (vec.size()&gt;0){
		try{
			for (var i = (P-1)*N ; i &lt; E; i++){
				var hm = vec.get(i);
				var row = table.newRow()-1;
				var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
				if (task != null){
					var processname = task.getProcessName();
					if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
						processname = &quot;作廢&quot;;		
						table.setValueAt(processname,   row, &quot;目前關卡&quot;);
						table.setValueAt(&quot;---&quot;,  row, &quot;目前處理者&quot;);													
					}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
						processname = &quot;已結案&quot;;
						table.setValueAt(processname,   row, &quot;目前關卡&quot;);
						table.setValueAt(&quot;---&quot;,  row, &quot;目前處理者&quot;);							
					}else{
						table.setValueAt(processname,   row, &quot;目前關卡&quot;);
						var realExecutorMemID = task.getRealExecutor();
						var memberRecord = Client.getMemberByID(realExecutorMemID);
						table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);						
					}
					loadLibrary(&quot;com.A.Common.Client.Util&quot;);
					//  再去讀取是否有子流程 ---------------------------------------------
					try{
						var vTskID=task.getID(); // 取task ID
						var sql_t = &quot; select *from Task_CreatePro  where tskid = &apos;&quot;+vTskID+&quot;&apos; and iscomplete = &apos;false&apos;  &quot;;
						var vec_t = Client.SQLloadValue(sql_t);
						if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
							var vName = &quot;&quot;;
							for(var r = 0;r&lt;vec_t.size();r++){
								var r_task = Client.getTask(vec_t.get(r).get(&quot;CPROOTTSKID&quot;));
								var vMid = r_task.getRealExecutor();
								var vExec = Client.getMemberByID(vMid).getName();
								vName = vName+vExec;
							}
							table.setValueAt(vName,  row, &quot;目前處理者&quot;);
						}
					}catch(e){
					}					
					var vMemList = getUnsignMemName(task); // 加會簽
					if(&quot;&quot;==vMemList){
						vMemList = getUnsignMemNameExt(task);
					}
					if(&quot;&quot;!=vMemList){
						table.setValueAt(vMemList,  row, &quot;目前處理者&quot;);
					}		
				}
				table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
				table.setValueAt(hm.get(&quot;ITEM12&quot;).substring(0,10),    	row, &quot;開單日期&quot;);
				if(hm.get(&quot;ITEM115&quot;).length()&gt;1){
					var fm_closedate = hm.get(&quot;ITEM115&quot;).substring(0,10);
				}else{
					var fm_closedate = &quot;--&quot;;
				}
				table.setValueAt(fm_closedate,    	row, &quot;結案日期&quot;);			
				table.setValueAt(hm.get(&quot;ITEM177&quot;),    	row, &quot;RMANO&quot;);			
				table.setValueAt(hm.get(&quot;ITEM192&quot;),    	row, &quot;帳務編號&quot;);
				table.setValueAt(hm.get(&quot;ITEM24&quot;), 	row, &quot;作者&quot;);
				table.setValueAt(hm.get(&quot;ITEM116&quot;),  	row, &quot;RMA日期&quot;);
				table.setValueAt(hm.get(&quot;ITEM138&quot;),   	row, &quot;客戶名稱&quot;);			
				table.setValueAt(hm.get(&quot;ITEM38&quot;),   	row, &quot;倍數15&quot;);
				table.setValueAt(hm.get(&quot;ITEM126&quot;),  	row, &quot;金額百萬&quot;);
				table.setValueAt(hm.get(&quot;ITEM39&quot;),  	row, &quot;美金&quot;);
				table.setValueAt(hm.get(&quot;ITEM105&quot;),  	row, &quot;台幣&quot;);
				table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			
			}
		}catch(e){
			Form.showMessageDialog(&quot;呈現查詢結果有誤:\n&quot;+e);		
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}

//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	var vConditions=&quot;&quot;;   // 避免USER不下條件即進行查詢@2017/07/17
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
				sSQL += &quot; AND ITEM115 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
			}else{
				sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
			}
			vConditions=&quot;YES&quot;;
		}
	}	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {			
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
				sSQL += &quot; AND ITEM115 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
			}else{
				sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
			}
			vConditions=&quot;YES&quot;;			
		}
	}		
	// 作者姓名
	//	chkOGCE
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)){
		var query_sql = &quot; select * from A_PARAMETER_DATA where PARAMETER = &apos;RMA_QUERY_PRV1&apos; AND VALUE1 =&apos;&quot;+ MemName +&quot;&apos;&quot;;
		var vec_query = Client.SQLloadValue(query_sql);
		if (vec_query != null &amp;&amp; vec_query.size()&gt;0 ) {
//			Form.setValue(&quot;Status&quot;,&quot;已結案&quot;);  
			//梁妏朱提出申請查全部  add by edison@20161128
		}else{
			sSQL += &quot; AND ITEM24 = &apos;&quot; + MemName + &quot;&apos;&quot;;
			vConditions=&quot;YES&quot;;
		}
	}	
	// RMA編號
	var sn= Form.getValue(&quot;Sn&quot;);
	var sn2= Form.getValue(&quot;Sn2&quot;);
	if(!&quot;&quot;.equals(sn)&amp;&amp;!&quot;&quot;.equals(sn2)){
		sSQL += &quot; AND ITEM4 between &apos;&quot; + sn + &quot;&apos; and &apos;&quot; + sn2 + &quot;&apos; &quot;;
		vConditions=&quot;YES&quot;;
	}else{
		if (!&quot;&quot;.equals(sn)) {
			//sSQL += &quot; AND ITEM4 like &apos;%&quot; + sn + &quot;%&apos;&quot;;    // mark by wangwei@2012/11/22 for 效能issue
			sSQL += &quot; AND ITEM4 like &apos;&quot; + sn + &quot;%&apos;&quot;;
			vConditions=&quot;YES&quot;;
		}
	}
	// 客戶名稱
	var DocName = Form.getValue(&quot;Subject&quot;);	 
	if (!&quot;&quot;.equals(DocName)) {
		sSQL += &quot; AND ITEM138 like &apos;%&quot; + DocName + &quot;%&apos;&quot;;
		vConditions=&quot;YES&quot;;
	}	
	var Status = Form.getValue(&quot;Status&quot;);	 
	if (!&quot;全部&quot;.equals(Status)) {
		if (&quot;已結案&quot;.equals(Status)){
			sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM202 = &apos;已結案&apos; &quot;;
		}else if (&quot;未結案&quot;.equals(Status)){
			sSQL += &quot; AND ITEM155 = &apos;false&apos;  AND (ITEM202 is null or ITEM202=&apos;&apos;)&quot;;
			vConditions=&quot;YES&quot;;
		}				
	}
	if(vConditions==&quot;&quot;){
		Form.showMessageDialog(&quot;請下條件查詢!&quot;);		
	}
	return sSQL;
}

//========================================================================================
// 折讓處理單(非品質)之查詢共用條件的SQL
//========================================================================================
function getQueryCondition_a(){
	var sSQL=&quot;&quot;;
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM20 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}else{
					sSQL += &quot; AND ITEM43 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
		}
	}	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {			
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM20 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}else{
					sSQL += &quot; AND ITEM43 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}			
		}
	}		
	// 作者姓名
	//	chkOGCE
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
// 
//		var query_sql = &quot; select * from A_PARAMETER_DATA where PARAMETER = &apos;RMA_QUERY_PRV1&apos; AND VALUE1 =&apos;&quot;+ MemName +&quot;&apos;&quot;;
//		var vec_query = Client.SQLloadValue(query_sql);
//		if (vec_query != null &amp;&amp; vec_query.size()&gt;0 ) {
//			Form.setValue(&quot;Status&quot;,&quot;已結案&quot;);  
//		}else{
			sSQL += &quot; AND ITEM60 = &apos;&quot; + MemName + &quot;&apos;&quot;;
//		}
	}	
	// 折讓單編號
	var sn= Form.getValue(&quot;Sn&quot;);
	var sn2= Form.getValue(&quot;Sn2&quot;);
	if(!&quot;&quot;.equals(sn)&amp;&amp;!&quot;&quot;.equals(sn2)){
		sSQL += &quot; AND ITEM85 between &apos;&quot; + sn + &quot;&apos; and &apos;&quot; + sn2 + &quot;&apos; &quot;;
	}
	else{
		if (!&quot;&quot;.equals(sn)) {
			sSQL += &quot; AND ITEM85 like &apos;%&quot; + sn + &quot;%&apos;&quot;;
		}
	}
	// 客戶名稱
	var DocName = Form.getValue(&quot;Subject&quot;);	 
	if (!&quot;&quot;.equals(DocName)) {
		sSQL += &quot; AND ITEM130 like &apos;%&quot; + DocName + &quot;%&apos;&quot;;
	}
	
	//文件狀態
	var Status = Form.getValue(&quot;Status&quot;);	 
	if (!&quot;全部&quot;.equals(Status)) {
			if (&quot;已結案&quot;.equals(Status)) {
				sSQL += &quot; AND ITEM20 is not null &quot;;
//				sSQL += &quot; AND    EXISTS  ( &quot;
//				sSQL += &quot; SELECT DISTINCT INSID  FROM  TASK_ARTINS TKM , TASK        TKDA,  TASK        TKDB  WHERE TKM.INSID = A.INSID  AND   TKM.TSKID=TKDA.TSKID  AND   TKDA.ROOTID = TKDB.TSKID  &quot;
//                sSQL += &quot; AND   TKDB.STATE = &apos;complete&apos; aND TKDB.TYPE = &apos;root&apos; )     &quot; ;
//				
			}else if (&quot;未結案&quot;.equals(Status)){
				sSQL += &quot; AND ITEM20 is null&quot;;
//			    sSQL += &quot; AND    EXISTS  ( &quot;
//				sSQL += &quot; SELECT DISTINCT INSID  FROM  TASK_ARTINS TKM , TASK        TKDA,  TASK        TKDB  WHERE TKM.INSID = A.INSID  AND   TKM.TSKID=TKDA.TSKID  AND   TKDA.ROOTID = TKDB.TSKID  &quot;
//                sSQL += &quot; AND   TKDB.STATE &lt;&gt; &apos;complete&apos; aND TKDB.TYPE = &apos;root&apos; )     &quot; ;
			}				
	}
	
	return sSQL;
}

function showTable_a(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM45&quot;)){
					processname = &quot;作廢&quot;;
					table.setValueAt(processname,   row, &quot;目前關卡&quot;);
					table.setValueAt(&quot;&quot;,  row, &quot;目前處理者&quot;);
//				}else if(&quot;complete&quot; == task.getTaskState()){
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
					table.setValueAt(processname,   row, &quot;目前關卡&quot;);
					table.setValueAt(&quot;&quot;,  row, &quot;目前處理者&quot;);
				}else{
					table.setValueAt(processname,   row, &quot;目前關卡&quot;);
					var realExecutorMemID = task.getRealExecutor();
					var memberRecord = Client.getMemberByID(realExecutorMemID);
					table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
				}
				
				loadLibrary(&quot;com.A.Common.Client.Util&quot;);
				
				var vMemList = getUnsignMemName(task); // 加會簽
				if(&quot;&quot;==vMemList){
					vMemList = getUnsignMemNameExt(task);
				}
				if(&quot;&quot;!=vMemList){
					table.setValueAt(vMemList,  row, &quot;目前處理者&quot;);
				}
				
//  再去讀取是否有子流程 ---------------------------------------------
				try{
					var vTskID=task.getFrontID(); // 取task ID
					var sql_t = &quot; select *from Task_CreatePro  where tskid = &apos;&quot;+vTskID+&quot;&apos; and iscomplete = &apos;false&apos;  &quot;;
					var vec_t = Client.SQLloadValue(sql_t);
					if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
						var vName = &quot;&quot;;
						for(var r = 0;r&lt;vec_t.size();r++){
							var r_task = Client.getTask(vec_t.get(r).get(&quot;CPROOTTSKID&quot;));
							var vMid = r_task.getRealExecutor();
							var vExec = Client.getMemberByID(vMid).getName();
								vName = vName+vExec+&quot;;&quot;;
						}
						table.setValueAt(vName,  row, &quot;目前處理者&quot;);
					}
				}catch(e){
				}
				
//-----------------------------------------------------------------------------------------	
// ------------------------------------------		
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ITEM60&quot;), 	row, &quot;作者&quot;);
			table.setValueAt(hm.get(&quot;ITEM43&quot;),    	row, &quot;開單日期&quot;);
			
			if(hm.get(&quot;ITEM20&quot;).length()&gt;1){
				var fm_closedate = hm.get(&quot;ITEM20&quot;);
			}else{
				var fm_closedate = &quot;--&quot;;
			}
			table.setValueAt(fm_closedate,    	row, &quot;結案日期&quot;);			
			table.setValueAt(hm.get(&quot;ITEM85&quot;),    	row, &quot;折讓單單號&quot;);			
			table.setValueAt(hm.get(&quot;ITEM92&quot;),    	row, &quot;製單日期&quot;);
			
			table.setValueAt(hm.get(&quot;ITEM97&quot;),  	row, &quot;製單人員&quot;);
			
			table.setValueAt(hm.get(&quot;ITEM130&quot;),   	row, &quot;客戶名稱&quot;);			
			table.setValueAt(hm.get(&quot;ITEM126&quot;),   	row, &quot;轉換匯率&quot;);
			
			table.setValueAt(hm.get(&quot;ITEM95&quot;),  	row, &quot;總額(USD)&quot;);
			table.setValueAt(hm.get(&quot;ITEM125&quot;),  	row, &quot;總額(TWD)&quot;);
			
			table.setValueAt(hm.get(&quot;ITEM93&quot;),  	row, &quot;折讓內容&quot;);
			table.setValueAt(hm.get(&quot;ITEM185&quot;),  	row, &quot;備註&quot;);
			table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00111235028720052</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/11/16 11:29:13</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Server.ProcessTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00111235028720052</string> 
     </void> 
     <void property="name"> 
      <string>ProcessTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00281213180209899</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

//=========================================
//
//=========================================
    function getFormatedCurrentTime(){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
        return simpledateformat.format(date);
    }

//---------
// 用於動態加會簽時寫回簽核紀錄 For 客戶資料專用~
function setProcessTableEx(){
//	var department = Server.getDepartment(MyTask.getDepartmentID()).getName();
	var depid = MyTask.getDepartmentID();
	var dep = Server.getDepartment(depid);
	var rMember = Server.getMember(MyTask.getRealExecutor()); //執行者
	var roleTitle = rMember.getJobTitle();
	var department = &quot;x&quot;;
	if(dep != null){
		department = dep.getName();
	}else{
		//抓不到部門(可能是專案職務)，就抓主要職務的部門
		var roleID = rMember.getMainRoleID();
		var memDR = rMember.getMemberDR(roleID);
		var department = memDR.getDepartmentName();	//使用者部門名稱
	}
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
		//Set 流程控制
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
	var roleid = Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
		dataMap.put(&quot;From_User_Role_ID&quot;, roleid);	
	var name = aInstance.getAppValue(&quot;Verify_Name&quot;);
		if(!rMember.getName().equals(name)){
			return ;
			}
	var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
	var isAgree = true;
	if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))|| &quot;true&quot;.equals(aInstance.getAppValue(&quot;Design_no&quot;))   ) {
		isAgree = false;
	}
	appendProcessTableEx(department, roleTitle, name, isAgree, reason);
}
//=========================================
//簽核歷程表格加入一筆   For 客戶資料專用~
//=========================================
function appendProcessTableEx(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數
	var member = Server.getMemberByCName(name);
	var id = member.getMyID();
	var Design_no = aInstance.getAppValue(&quot;Design_no&quot;);	
	//加入代理人資訊 20070625
	if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
		name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
	}
	var hm = java.util.HashMap();
	var proName = MyTask.getProcessName();//關卡名稱  
	if( proName.indexOf(&quot;]&quot;) &gt; 0 ){
		proName=proName.substring(proName.indexOf(&quot;]&quot;)+1,proName.length());  // 若有[關卡名稱]則只取真正的關卡名稱
	}
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
	hm.put(&quot;ITEM6&quot;, department);//Department 部門
	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
	hm.put(&quot;ITEM2&quot;, id);//ID 工號	
	hm.put(&quot;ITEM4&quot;, name);//Name 姓名
	if (isAgree == true &amp;&amp; Design_no!=&quot;true&quot; ) {
		hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		if(rowCount == 0){
			hm.put(&quot;ITEM3&quot;,&quot;提出&quot;);//同意
		}
	} else if(isAgree == false &amp;&amp; Design_no==&quot;true&quot; ){
		hm.put(&quot;ITEM3&quot;,&quot;不設計&quot;);
	}else {
		hm.put(&quot;ITEM3&quot;,&quot;不同意&quot;);
	}
	hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
	hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
	vecTableData.add(rowCount,hm);
	aInstance.setAppValue(&quot;Process_Table&quot;,vecTableData);
//	formDataMap.put(&quot;Agree&quot;,&quot;true&quot;);
//	formDataMap.put(&quot;Reject&quot;,&quot;false&quot;);
//	formDataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
}


//=========================================
//系統自動簽核關卡 【Gerber】
//=========================================
function auto_process_add_Process_Table(proName,artIns) {

  var formDataMap = artIns.getAppDataMap();
  if(proName == &quot;DE主管審核&quot; || proName ==&quot;OP簽收執行&quot; || proName ==&quot;DE審核&quot;){
	// 設定DE自動會簽人員
    // TGCE
	if( formDataMap.get(&quot;design-t&quot;) == &quot;true&quot; ){
		var GETORG = &quot;TGCE&quot;;
		var id =&quot;011140&quot;;
        var member =&quot;莊耀松&quot;;
        var department=&quot;2M1-工程資料設計&quot;;
        var roleTitle=&quot;主任&quot;;		
		var signTime = getFormatedCurrentTime();
        add_Process_Table(artIns,proName,GETORG,id,member,department,roleTitle,signTime);		
		var id_m =&quot;000167&quot;;
        var member_m =&quot;孫冰芳&quot;;
        var department_m=&quot;2M0-設計工程處&quot;;
        var roleTitle_m=&quot;副處長&quot;;		
		var signTime_m = getFormatedCurrentTime();
        add_Process_Table(artIns,proName,GETORG,id_m,member_m,department_m,roleTitle_m,signTime_m);		
	}	
	// SGCE
    if( formDataMap.get(&quot;design-s&quot;) == &quot;true&quot; ){
		var GETORG = &quot;SGCE&quot;;
//	  	var id =&quot;006175&quot;;
//        var member =&quot;楊文珠&quot;;
//        var department=&quot;6M1-制前設計部&quot;;
//        var roleTitle=&quot;課級工程師&quot;
//		var signTime = getFormatedCurrentTime();
//        add_Process_Table(artIns,proName,GETORG,id,member,department,roleTitle,signTime);
		var id_m =&quot;004586&quot;;
        var member_m =&quot;宋文淦&quot;;
        var department_m=&quot;6M0-設計工程處&quot;;
        var roleTitle_m=&quot;經理&quot;;		
		var signTime_m = getFormatedCurrentTime();
        add_Process_Table(artIns,proName,GETORG,id_m,member_m,department_m,roleTitle_m,signTime_m);		
	}
	// CGCE
	if( formDataMap.get(&quot;design-c&quot;) == &quot;true&quot; ){
	    var GETORG = &quot;CGCE&quot;;
	    var id =&quot;005886&quot;;
        var member =&quot;李武&quot;;
        var department=&quot;8M1-工程資料設計課&quot;;
        var roleTitle=&quot;副理&quot;
		var signTime = getFormatedCurrentTime();
        add_Process_Table(artIns,proName,GETORG,id,member,department,roleTitle,signTime);	
//		var id_m =&quot;002162&quot;;
//        var member_m =&quot;陳君世&quot;;
//        var department_m=&quot;8M0-設計工程部&quot;;
//        var roleTitle_m=&quot;經理&quot;;		
//		var signTime_m = getFormatedCurrentTime();
//        add_Process_Table(artIns,proName,GETORG,id_m,member_m,department_m,roleTitle_m,signTime_m);			
	 }
	// HGCE
	if( formDataMap.get(&quot;design-h&quot;) == &quot;true&quot; ){
	    var GETORG = &quot;HGCE&quot;;
//	    var id =&quot;001708&quot;;
//        var member =&quot;薛露&quot;;
//        var department=&quot;5M1-工程資料設計課&quot;;
//        var roleTitle=&quot;資深課長&quot;
//		var signTime = getFormatedCurrentTime();
//        add_Process_Table(artIns,proName,GETORG,id,member,department,roleTitle,signTime);	
		var id_m =&quot;000191&quot;;
        var member_m =&quot;鐘奇偉&quot;;
        var department_m=&quot;5M0-設計工程部&quot;;
        var roleTitle_m=&quot;副理&quot;;		
		var signTime_m = getFormatedCurrentTime();
        add_Process_Table(artIns,proName,GETORG,id_m,member_m,department_m,roleTitle_m,signTime_m);				
	 }
   }else if(proName ==&quot;ECN簽收&quot;){
       // TGCE
	if( formDataMap.get(&quot;design-t&quot;) == &quot;true&quot; ){
		var GETORG = &quot;TGCE&quot;;
		var id =&quot;007663&quot;;
        var member =&quot;劉若芸&quot;;
        var department=&quot;2P0-廠務室&quot;;
        var roleTitle=&quot;高級事務員&quot;;		
		var signTime = getFormatedCurrentTime();
        add_Process_Table(artIns,proName,GETORG,id,member,department,roleTitle,signTime);	
	}	
	// SGCE
//    if( formDataMap.get(&quot;design-s&quot;) == &quot;true&quot; ){
//		var GETORG = &quot;SGCE&quot;;
//	  	var id =&quot;003142&quot;;
//        var member =&quot;陳勇&quot;;
//        var department=&quot;6P3-制三部&quot;;
//        var roleTitle=&quot;主任級工程師/主任&quot;
//		var signTime = getFormatedCurrentTime();
//        add_Process_Table(artIns,proName,GETORG,id,member,department,roleTitle,signTime);
//	}
	// CGCE
	if( formDataMap.get(&quot;design-c&quot;) == &quot;true&quot; ){
	    var GETORG = &quot;CGCE&quot;;
	    var id =&quot;000207&quot;;
        var member =&quot;解展&quot;;
        var department=&quot;8P0-廠務室&quot;;
        var roleTitle=&quot;副處長&quot;
		var signTime = getFormatedCurrentTime();
        add_Process_Table(artIns,proName,GETORG,id,member,department,roleTitle,signTime);
	 }
	// HGCE
	if( formDataMap.get(&quot;design-h&quot;) == &quot;true&quot; ){
//	    var GETORG = &quot;HGCE&quot;;
//	    var id =&quot;000034&quot;;
//        var member =&quot;杜紹敏&quot;;
//        var department=&quot;5P0-廠務室&quot;;
//        var roleTitle=&quot;經理級工程師&quot;
//		var signTime = getFormatedCurrentTime();
//        add_Process_Table(artIns,proName,GETORG,id,member,department,roleTitle,signTime);		
	 }

   }else if(proName ==&quot;DE主管簽核&quot;){
	   if( formDataMap.get(&quot;design-t&quot;) == &quot;true&quot; ){
		   var GETORG = &quot;TGCE&quot;;
		   var id =&quot;011140&quot;;
		   var member =&quot;莊耀松&quot;;
		   var department=&quot;2M1-工程資料設計&quot;;
		   var roleTitle=&quot;主任&quot;;		
		   var signTime = getFormatedCurrentTime();
		   add_Process_Table(artIns,proName,GETORG,id,member,department,roleTitle,signTime);		
			
	   }
   } 
}	

function add_Process_Table(artIns,proName,GETORG,id,member,department,roleTitle,signTime){
  
	var formDataMap = artIns.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數

//	var proName = &quot;DE主管審核&quot;;//關卡名稱  
	var hm = java.util.HashMap();
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, signTime);//簽核時間
	hm.put(&quot;ITEM6&quot;, department);//Department 部門
	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
	hm.put(&quot;ITEM2&quot;, id);//ID 工號	
	hm.put(&quot;ITEM4&quot;, member);//Name 姓名
	hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
	hm.put(&quot;ITEM1&quot;,&quot;&quot;);//Opinion 意見
	hm.put(&quot;ITEM10&quot;,&quot;&quot;);	//TaskID	
	vecTableData.add(rowCount,hm);
	artIns.setAppValue(&quot;Process_Table&quot;,vecTableData);

}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00111250755035102</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2012/12/18 09:36:06</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Client.SignTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00111250755035102</string> 
     </void> 
     <void property="name"> 
      <string>SignTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091250755035083</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

function loadSignTable_e(SignTable,groupname){
         var table = Form.getComponent(SignTable);
           //如果是空的才抓
         if(table.getRowCount()==0){
           var sql = &quot; select A_Group.ID 工號,MEM_GENINF.USERNAME 姓名,loginid from A_Group,MEM_GENINF where  A_Group.GROUPNAME = &apos;&quot;+ groupname +&quot;&apos; and A_Group.ID = MEM_GENINF.ID &quot; ;
           var vector = Client.SQLloadValue(sql);
           table.clear();
           if ( vector != null ){
               Form.setValue(&quot;Count&quot;,vector.size());
			   if (vector.size()&gt;0){
				   for(var i=0;i&lt;vector.size();i++)  {
					   var ht = vector.get(i);
					   var row = table.newRow()-1;
					   var cMember = Client.getMember(ht.get(&quot;loginid&quot;));
					   var roleID = cMember.getMainRoleID();
					   var memDR = cMember.getMemberDR(roleID);
					   var sDepName = &quot;未定&quot;;
            	           if(memDR != null){
							   sDepName = memDR.getDepartmentName(); //使用者部門名稱
						   }
                       table.setValueAt(sDepName,row,&quot;會簽單位&quot;);
                       table.setValueAt(ht.get(&quot;工號&quot;),row,&quot;工號&quot;);
                       table.setValueAt(ht.get(&quot;姓名&quot;),row,&quot;姓名&quot;);          
                   }//for
			   }
           }
         }         
}
//=========================================
//抓取加會簽資訊 add by edison_wang@20110921
//=========================================	
function setSignTableResult(process_table){	
	var task = Form.getCurrentTask();
	if(task == null){
		return ;
    }
	getAddTask(process_table);
}
//=============================================================
//從加會簽table取出會簽資訊 add_task add by edison_wang@20110921
//=============================================================
function getAddTask(s5){	
	//var tskid = MyTask.getID();
    var task = Form.getCurrentTask();	
	var tskid = task.getID();
	var sql = &quot;select tskid,addsignresult,announcecontent,&quot;;
	    sql +=&quot;to_char( (to_date(&apos;01-01-1970&apos;,&apos;DD-MM-YYYY&apos; ) + (signtime+(8*60*60*1000)) / 86400000),&apos;yyyy/mm/dd hh24:mi&apos;) as signtime &quot;;
		sql +=&quot;from add_task where signtskid=&apos;&quot;+tskid+&quot;&apos; and signtskid&lt;&gt;tskid order by signtime&quot;;
	var rs = Client.SQLloadValue(sql);
	if(rs!=null &amp;&amp; rs.size()&gt;0){
		for(var i=0;i&lt;rs.size();i++){
			insertResultTable(rs.get(i).get(&quot;tskid&quot;),rs.get(i).get(&quot;addsignresult&quot;),rs.get(i).get(&quot;announcecontent&quot;),rs.get(i).get(&quot;signtime&quot;),s5);
		}	
		//Form.refresh();
	}

}
//==================================================
//加會簽資訊寫入簽核table add by edison_wang@20110921
//===================================================	
function insertResultTable(s1,s2,s3,s4,s5){
	var task = Form.getCurrentTask();
	var aInstance = task.getArtInstance();
	var sql =&quot;select exeid,memid from task where tskid=&apos;&quot;+s1+&quot;&apos;&quot;;
	var vec = Client.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		var exeid = vec.get(0).get(&quot;exeid&quot;);
		var memid = vec.get(0).get(&quot;memid&quot;);
		var member = Client.getMember(exeid);
		
		var cname = member.getName();
		if(!exeid.equals(memid)){
			var omember = Client.getMember(memid);
			cname = member.getName()+&quot;(代理:&quot;+omember.getName()+&quot;)&quot;;
		}
		var id = member.getMyID();
		var memid = member.getID();
		var jobtitle = member.getJobTitle();
		var roleID = member.getMainRoleID();
		var memDR = member.getMemberDR(roleID);
		var sDepName = memDR.getDepartmentName();	   		//使用者部門名稱
		var sDepID = Client.getDepartment(memDR.getDepartmentID()).getMyID();
		var appDataMap = aInstance.getAppDataMap();
		var records = appDataMap.get(s5);
		var row = new Packages.java.util.HashMap();
		if(s2.equals(&quot;Disagree&quot;)||s2.equals(&quot;reject&quot;)){ 	// 加上reject
			s2 =&quot;不同意&quot;;
		}else if(s2.equals(&quot;Agree&quot;)||s2.equals(&quot;ok&quot;)){  	// 加上 ok
			s2 =&quot;同意&quot;;
		}else{
			s2 =&quot;沒意見&quot;;
		}
		var flag = true;
		var process_table = Form.getComponent(s5);
		var t_name =&quot;&quot;;
		var t_yes =&quot;&quot;;
		var t_time =&quot;&quot;;
		for (var j=0;j&lt;process_table.getActualRowCount();j++){
			//check 會簽人的工號+簽核時間有無在 SingTable 內，有的話就 update table 內的簽核及審核意見
			//如果不在 table 內就加到最後
			t_name = process_table.getValueAt(j,&quot;姓名&quot;);
			t_yes = process_table.getValueAt(j,&quot;是否核准&quot;);
			t_time =process_table.getValueAt(j,&quot;審核日期&quot;);
			if (cname.equals(t_name)&amp;&amp; s4.equals(t_time)){
				//process_table.setValueAt(vTitle+l_msg,j,&quot;審核意見&quot;);//ITEM5 審核意見
				process_table.setValueAt(s3,j,&quot;審核意見&quot;);//ITEM5 審核意見
				process_table.setValueAt(s2,j,&quot;是否核准&quot;);//同意
				//j = process_table.getRowCount();//跳出 for j
				flag = false;
			}
		}
		if(flag){
			var row = process_table.newRow() - 1;
			process_table.setValueAt(id, row, &quot;工號&quot;);//
            process_table.setValueAt(cname, row, &quot;姓名&quot;);//
            process_table.setValueAt(s3, row, &quot;審核意見&quot;);//ITEM5 審核意見
            process_table.setValueAt(s2, row,&quot;是否核准&quot;);//同意                
            process_table.setValueAt(s4, row,&quot;審核日期&quot;);//日期
			process_table.setValueAt(row+1+&quot;&quot;,row,&quot;序號&quot;);
            process_table.setValueAt(sDepName,row,&quot;部門&quot;);
            process_table.setValueAt(&quot;*動態加會簽*&quot;,row,&quot;關卡名稱&quot;);
			process_table.setValueAt(jobtitle,row,&quot;職稱&quot;);
            process_table.setValueAt(s1,row,&quot;TaskID&quot;);
			Form.saveAppData(true);
		}		
	}	
}
//============================================================== 
// Client 將CurrentTask 會簽結果放入審核意見裡面
//============================================================== 
function setSignTableResult_v1(process_table){
          //將會簽結果放入審核意見裡面
          var process_table = Form.getComponent(process_table);		  
		  var member = Client.getCurrentMember();
          var task = Form.getCurrentTask(); 
               if(task == null){
                   return ;
                 };
          var taskmemberlist = task.getAddASAuditList() ; 
		  var vTitle=task.getAddASTitle(); //會簽主旨
		      if(&quot;&quot;!=vTitle){
//		      vTitle = &quot;會簽主旨:&quot;+vTitle.trim();
			  }
          var TotalResult =task.getAddASResultString(); //取得加會簽結果的字串                  
                  //------------------------------------------------------------------------------------------
                  // 20080107 cc
                  //因 aCSResultData.getMsg(); //簽核意見的api會有切割不完整的問題，改 function 來抓會簽意見
          var tag = &quot;========================================================&quot;;
          var msg = SplitString(TotalResult,tag);	
                   //------------------------------------------------------------------------------------------
          var detailresult =Client.parseAddASResultString(TotalResult);   //將加會簽結果的字串解析成個別的物件形式 
          var flg_reject = false;                 
                  //--------------------------------------------------------------------------------------------
                  //20090212 cc
                  //以會簽關卡(雙人ICON)再進行動態加會簽也要取得到會簽資訊
                  //--------------------------------------------------------------------------------------------
           if(detailresult.size()&gt;0){
              for(var i = 0; i&lt; detailresult.size(); i++){
                 try{
                      var flg = true;        
                //process_table.clear();//有資料才清 table
                       var aCSResultData = detailresult.get(i);
					   var l_time = aCSResultData.getTime(&quot;yyyy/MM/dd HH:mm&quot;);
					   var l_name = aCSResultData.getName(); //只能拿到姓名，沒有工號可用
					   var l_role = aCSResultData.getRole(); //職稱
					   var l_dep = aCSResultData.getDep();
					    	l_name = l_name.substring(0,l_name.indexOf(&quot;(&quot;));
//------------------------取得職稱---modi by wangwei@2009/03/19 解決同名同姓讀取職稱的問題------							
						var vDep = &quot;%&quot;+l_dep.substring(0,3);
						var vSQL = &quot;select jobtitle from mem_geninf where username =&apos;&quot;+l_name+&quot;&apos; and workplace like &apos;&quot;+vDep+&quot;&apos;&quot;;
						var vec = Client.SQLloadValue(vSQL);
						var vJobTitle=&quot;&quot;;
						if(vec.get(0).get(&quot;jobtitle&quot;) != null ){
							vJobTitle =vec.get(0).get(&quot;jobtitle&quot;);
						}
//--------------------------------------											
			            var l_msg = msg[i]; //簽核意見
						l_msg = l_msg.replaceAll(&quot;\r\n&quot;,&quot; &quot;);
						if(l_msg.length()&gt;300){
							l_msg=l_msg.substring(0,300)+&quot;(...詳請看會簽區塊)&quot;;				
						}	
						var l_result = &quot;未表示&quot;;
						if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Agree&quot;)){
							l_result = &quot;同意&quot;;
						}else if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Disagree&quot;)||aCSResultData.getSignResult().equalsIgnoreCase(&quot;reject&quot;)){
                                l_result = &quot;不同意&quot;;
                                flg_reject = true ;
                        }
						
                        for (var j=0;j&lt;process_table.getRowCount();j++){
                                //check 會簽人的工號+簽核時間有無在 SingTable 內，有的話就 update table 內的簽核及審核意見
                                //如果不在 table 內就加到最後
                                t_name = process_table.getValueAt(j,&quot;姓名&quot;);
                                t_yes = process_table.getValueAt(j,&quot;是否核准&quot;);
                                t_time =process_table.getValueAt(j,&quot;審核日期&quot;);
                                if (l_name.equals(t_name)&amp;&amp; l_time.equals(t_time)){
//                                        process_table.setValueAt(vTitle+l_msg,j,&quot;審核意見&quot;);//ITEM5 審核意見
										process_table.setValueAt(l_msg,j,&quot;審核意見&quot;);//ITEM5 審核意見
                                        process_table.setValueAt(l_result,j,&quot;是否核准&quot;);//同意
                                        //j = process_table.getRowCount();//跳出 for j
                                        flg = false;
                                }
                        }//for j
                        if(flg == true){
                                //不在 table 內就加到最後
                                var row = process_table.newRow() - 1;
                                var l_member = Client.getMemberByCName(l_name);
                                var l_id = l_member.getMyID();                            
                                process_table.setValueAt(l_id, row, &quot;工號&quot;);//
                                process_table.setValueAt(l_name, row, &quot;姓名&quot;);//
                                process_table.setValueAt(l_msg, row, &quot;審核意見&quot;);//ITEM5 審核意見
                                process_table.setValueAt(l_result, row,&quot;是否核准&quot;);//同意                
                                process_table.setValueAt(l_time, row,&quot;審核日期&quot;);//日期  
                                //加簽的要補工號、部門及分機
                                var sMember = Client.getMemberByCName(l_name);
                                if(sMember != null){
                                        var roleID = sMember.getMainRoleID();
                                        var rolename = Client.getRole(roleID).getName();
                                        var memDR = sMember.getMemberDR(roleID);
                                        var sDepName = memDR.getDepartmentName();        //使用者部門名稱
                                        process_table.setValueAt(row+1+&quot;&quot;,row,&quot;序號&quot;);
                                        process_table.setValueAt(l_dep,row,&quot;部門&quot;);
                                        process_table.setValueAt(&quot;*動態加會簽&quot;,row,&quot;關卡名稱&quot;);
                                        //process_table.setValueAt(l_role,row,&quot;職稱&quot;);
// ---------------------add by wangwei@2009/3/19 解決同名同姓的問題										
										if(&quot;&quot;==vJobTitle){
											vJobTitle = sMember.getJobTitle();//GCE Member.getJobTitle();
											}										
                                        process_table.setValueAt(vJobTitle,row,&quot;職稱&quot;);
                                        process_table.setValueAt(task.getID(),row,&quot;TaskID&quot;);                                   
                                        }                                        
                                }
                     }catch(e){
						 
					 }                               
                }//for i
             }else{                              
                try{
				    if( &quot;ART01081221466085083&quot; != Form.getCurrentTask().getArtInstance().getArtifactID() &amp;&amp; &quot;ART01001231233951714&quot; != Form.getCurrentTask().getArtInstance().getArtifactID() ){
					   var rootid = task.getRootID();
					   var sql_note = &quot; select note from signins where note is not null and note like &apos;[%========================================================%&apos; and tskid in (select tskid from task where rootid = &apos;&quot;+ rootid +&quot;&apos;)&quot;;
				   		      Client.addDebugLog(&quot;call setSignTableResult SQL:&quot;+ sql_note);
					   var vec_note = Client.SQLloadValue(sql_note);
					   if(vec_note != null &amp;&amp; vec_note.size()&gt;0){
						   for(var k=0; k&lt;vec_note.size();k++){
							   detailresult = Client.parseAddASResultString(vec_note.get(k).get(&quot;Note&quot;));   //將加會簽結果的字串解析成個別的物件形式
							   msg = SplitString(vec_note.get(k).get(&quot;Note&quot;),tag);
							   flg_reject = addCSProcess_table(process_table,detailresult,msg,flg_reject,task);
							  }
						  }														  
					  }					   
                   }catch(e){}
                  }
        }
 
function addCSProcess_table(process_table,detailresult,msg,flg_reject,task){
          var task = Form.getCurrentTask(); 
               if(task == null){
				   var vTitle=&quot;&quot;;
                 };
		  var vTitle=task.getAddASTitle(); //會簽主旨
	
        for(var i = 0; i&lt; detailresult.size(); i++){
            try{
                var flg = true;        
                //process_table.clear();//有資料才清 table
                var aCSResultData = detailresult.get(i);
				var l_time = aCSResultData.getTime(&quot;yyyy/MM/dd HH:mm&quot;);
				var l_name = aCSResultData.getName(); //只能拿到姓名，沒有工號可用
                var l_role = aCSResultData.getRole(); //職稱
                var l_dep = aCSResultData.getDep();
                     l_name = l_name.substring(0,l_name.indexOf(&quot;(&quot;));
//------------------------取得職稱---modi by wangwei@2009/03/19 解決同名同姓讀取職稱的問題------							
				var vDep = &quot;%&quot;+l_dep.substring(0,3);
				var vSQL = &quot;select jobtitle from mem_geninf where username =&apos;&quot;+l_name+&quot;&apos; and workplace like &apos;&quot;+vDep+&quot;&apos;&quot;;
				var vec = Client.SQLloadValue(vSQL);
				var vJobTitle=&quot;&quot;;
					if(vec.get(0).get(&quot;jobtitle&quot;) != null ){
						vJobTitle =vec.get(0).get(&quot;jobtitle&quot;);
					}
//--------------------------------------																 

                var l_msg = msg[i]; //簽核意見
				l_msg = l_msg.replaceAll(&quot;\r\n&quot;,&quot; &quot;);
				if(l_msg.length()&gt;300){
					l_msg=l_msg.substring(0,300)+&quot;(...詳請看會簽區塊)&quot;;				
				}					
				var l_result = &quot;未表示&quot;;
				if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Agree&quot;)){
					l_result = &quot;同意&quot;;
				}else if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Disagree&quot;)||aCSResultData.getSignResult().equalsIgnoreCase(&quot;reject&quot;)){
                     l_result = &quot;不同意&quot;;
                     flg_reject = true ;
                 }
                for (var j=0;j&lt;process_table.getRowCount();j++){
                                //check 會簽人的工號+簽核時間有無在 SingTable 內，有的話就 update table 內的簽核及審核意見
                                //如果不在 table 內就加到最後
                     t_name = process_table.getValueAt(j,&quot;姓名&quot;);
                     t_yes = process_table.getValueAt(j,&quot;是否核准&quot;);
                     t_time =process_table.getValueAt(j,&quot;審核日期&quot;);
                     if (l_name.equals(t_name)&amp;&amp; l_time.equals(t_time)){
                         process_table.setValueAt(l_msg,j,&quot;審核意見&quot;);//ITEM5 審核意見
                         process_table.setValueAt(l_result,j,&quot;是否核准&quot;);//同意
                         flg = false;
                        }
                 }//for j
                 if(flg == true){
                             //不在 table 內就加到最後
                     var row = process_table.newRow() - 1;
                     var l_member = Client.getMemberByCName(l_name);
                     var l_id = l_member.getMyID();                            
                          process_table.setValueAt(l_id, row, &quot;工號&quot;);//
                          process_table.setValueAt(l_name, row, &quot;姓名&quot;);//
                          process_table.setValueAt(l_msg, row, &quot;審核意見&quot;);//ITEM5 審核意見
                          process_table.setValueAt(l_result, row,&quot;是否核准&quot;);//同意                
                          process_table.setValueAt(l_time, row,&quot;審核日期&quot;);//日期  
                                //加簽的要補工號、部門及分機
                     var sMember = Client.getMemberByCName(l_name);
                         if(sMember != null){
                             var roleID = sMember.getMainRoleID();
                             var rolename = Client.getRole(roleID).getName();
                             var memDR = sMember.getMemberDR(roleID);
                             var sDepName = memDR.getDepartmentName();        //使用者部門名稱
                                  process_table.setValueAt(row+1+&quot;&quot;,row,&quot;序號&quot;);
                                  process_table.setValueAt(l_dep,row,&quot;部門&quot;);
                                  process_table.setValueAt(&quot;*動態加會簽&quot;,row,&quot;關卡名稱&quot;);
                                       //process_table.setValueAt(l_role,row,&quot;職稱&quot;);
// ---------------------add by wangwei@2009/3/19 解決同名同姓的問題										
									if(&quot;&quot;==vJobTitle){
										vJobTitle = sMember.getJobTitle();//GCE Member.getJobTitle();
										}																			   
                                  process_table.setValueAt(vJobTitle,row,&quot;職稱&quot;);//GCE Member.getJobTitle();
                                  process_table.setValueAt(task.getID(),row,&quot;TaskID&quot;);                                   
       
                                        }                                        
                                }
                                }catch(e){}                               
                        }//for i
                return flg_reject;
        }




//==============================================================	
// Client 將CurrentTask 會簽結果放入審核意見裡面  20090216 更新如上的部份,因動態加會簽不能使用 For Peppers
//==============================================================	
	function setSignTableResult_OLD(process_table){
          //將會簽結果放入審核意見裡面
          var process_table = Form.getComponent(process_table);
          //process_table.clear();
          var task = Form.getCurrentTask(); 
		  if(task == null){
			  return ;
			};
          var taskmemberlist = task.getAddASAuditList() ; 
          var TotalResult =task.getAddASResultString(); //取得加會簽結果的字串		  
		  //------------------------------------------------------------------------------------------
		  // 20080107 cc
		  //因 aCSResultData.getMsg(); //簽核意見的api會有切割不完整的問題，改 function 來抓會簽意見
		  var tag = &quot;========================================================&quot;;
		  var msg = SplitString(TotalResult,tag);
		  //------------------------------------------------------------------------------------------
          var detailresult =Client.parseAddASResultString(TotalResult);   //將加會簽結果的字串解析成個別的物件形式 
		  var flg_reject = false;
		  for(var i = 0; i&lt; detailresult.size(); i++){
			try{
			var flg = true;	      
           	//process_table.clear();//有資料才清 table
			var aCSResultData = detailresult.get(i);
            var l_time = aCSResultData.getTime(&quot;yyyy/MM/dd HH:mm&quot;);
            var l_name = aCSResultData.getName(); //只能拿到姓名，沒有工號可用
			var l_role = aCSResultData.getRole(); //職稱
			var l_dep = aCSResultData.getDep();
			l_name = l_name.substring(0,l_name.indexOf(&quot;(&quot;));
			var l_msg = msg[i]; //簽核意見
			l_msg = l_msg.replaceAll(&quot;\r\n&quot;,&quot; &quot;);
			if(l_msg.length()&gt;300){
				l_msg=l_msg.substring(0,300)+&quot;(...詳請看會簽區塊)&quot;;				
			}				
            var l_result = &quot;未表示&quot;;
            if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Agree&quot;)){
                l_result = &quot;同意&quot;;
            }else if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Disagree&quot;)||aCSResultData.getSignResult().equalsIgnoreCase(&quot;reject&quot;)){
  				l_result = &quot;不同意&quot;;
				flg_reject = true ;
			}
			for (var j=0;j&lt;process_table.getRowCount();j++){
				//check 會簽人的工號+簽核時間有無在 SingTable 內，有的話就 update table 內的簽核及審核意見
				//如果不在 table 內就加到最後
				t_name = process_table.getValueAt(j,&quot;姓名&quot;);
				t_yes = process_table.getValueAt(j,&quot;是否核准&quot;);
				t_time =process_table.getValueAt(j,&quot;審核日期&quot;);
				if (l_name.equals(t_name)&amp;&amp; l_time.equals(t_time)){
					process_table.setValueAt(l_msg,j,&quot;審核意見&quot;);//ITEM5 審核意見
					process_table.setValueAt(l_result,j,&quot;是否核准&quot;);//同意
					//j = process_table.getRowCount();//跳出 for j
					flg = false;
				}
			}//for j

			if(flg == true){
				//不在 table 內就加到最後
				var row = process_table.newRow() - 1;
				var l_member = Client.getMemberByCName(l_name);
				var l_id = l_member.getMyID();				
				process_table.setValueAt(l_id, row, &quot;工號&quot;);//
				process_table.setValueAt(l_name, row, &quot;姓名&quot;);//
				process_table.setValueAt(l_msg, row, &quot;審核意見&quot;);//ITEM5 審核意見
				process_table.setValueAt(l_result, row,&quot;是否核准&quot;);//同意		
				process_table.setValueAt(l_time, row,&quot;審核日期&quot;);//日期	
				//加簽的要補工號、部門及分機
				var sMember = Client.getMemberByCName(l_name);
				if(sMember != null){
					var roleID = sMember.getMainRoleID();
					var rolename = Client.getRole(roleID).getName();
					var memDR = sMember.getMemberDR(roleID);
					var sDepName = memDR.getDepartmentName();	//使用者部門名稱
					process_table.setValueAt(row+1+&quot;&quot;,row,&quot;序號&quot;);
					process_table.setValueAt(l_dep,row,&quot;部門&quot;);
					process_table.setValueAt(&quot;*動態加會簽&quot;,row,&quot;關卡名稱&quot;);
					//process_table.setValueAt(l_role,row,&quot;職稱&quot;);
					process_table.setValueAt(sMember.getJobTitle(),row,&quot;職稱&quot;);//GCE Member.getJobTitle();
					process_table.setValueAt(task.getID(),row,&quot;TaskID&quot;);					
					//process_table.setValueAt(sMember.getMyID(),row,&quot;工號&quot;);
					//process_table.setValueAt(sMember.getOfficePhone(),row,&quot;電話&quot;);
					}
					
				}
				}catch(e){}
			}//for i
			/*
			//這一段用來判斷會簽的意見內有沒有人不同意的
			if (flg_reject == true){
				Form.setValue(&quot;Add_Sign_Reject&quot;,true);
			}else{
				Form.setValue(&quot;Add_Sign_Reject&quot;,&quot;false&quot;);
			}
			*/
	}

	

/**
 * 拆分字串到陣列，分割符可使用多個字符或者中文
 * 建立日期：(2001-7-10 14:50:31)
 * @param fieldsru java.lang.String 輸入參數：待拆分字符串
 * @param tag java.lang.String      輸入參數：分割符
 * @exception java.lang.Exception 異常說明。
 * @exception java.io.IOException 異常說明。
 */
function SplitString(fieldsru,tag){
	try{
	var returnarray = fieldsru.split(tag);
	// 加會意見： [Mon Jan 07 11:18:21 CST 2008] [徐正芳(徐正芳),廠/處長,人力資源處] :不同意 駁回測試 
	for(var t=0;t&lt;returnarray.length-1;t++){
		var temp_index = returnarray[t].indexOf(&quot;] :&quot;);
		if(temp_index&gt;0){
			returnarray[t] = returnarray[t].substring(temp_index);
			var n = 1 + returnarray[t].indexOf(&quot;\n&quot;);
			if(n&gt;0){
				returnarray[t] = returnarray[t].substring(n);
			}
		}
	}
	return returnarray;
	}catch (e)	{
		//java.lang.System.out.println(e.getMessage());
	}
	return null;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00121102067255033</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/12/03 17:47:35</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.SystemFunction.MailForRole</string> 
     </void> 
     <void property="id"> 
      <string>SCL00121102067255033</string> 
     </void> 
     <void property="name"> 
      <string>MailForRole</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//取得指定職務的人員的 mail
function getRoleMemberMail(roleID, orgMailList){
	var iRole = Client.getRole(roleID);
	var iMemberList = iRole.getMemberList();
	for(j = 0; j &lt; iMemberList.size(); j ++){
		var jMember = Client.getMember(iMemberList.get(j));
		if(jMember != null){
			//避免重複
			var indexStr = orgMailList.indexOf(jMember.getEmail());
			if(indexStr == -1){
				orgMailList += jMember.getEmail() + &quot;;&quot;;
			}
		}
	}
	
	return orgMailList;
}
</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00121110621764421</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/03/12 18:02:44</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.AccountTitle</string> 
     </void> 
     <void property="id"> 
      <string>SCL00121110621764421</string> 
     </void> 
     <void property="name"> 
      <string>AccountTitle</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//取得所有貸方科目
function getAccountTitles(){

	//var querySQL = &quot;Select FACTID,FDSP40 from FGP040 Where FCD = &apos;C&apos; Order By FACTID &quot;;
	//var dataSet = Client.SQLloadValue(querySQL);

        var objFFARTP = new Packages.hct.dataaccess.data.FFARTP();
        var AccountTitlesList = objFFARTP.getMainItemList();
	var titleMap = new java.util.TreeMap();

	for(var i = 0; i &lt; AccountTitlesList.size(); i++){
		var aRow = AccountTitlesList.get(i);
	        
		//先放名稱再放 ID, 以便存檔時可以由User的選項找到 ID
		titleMap.put(aRow.get(1),aRow.get(0));
	}

	return titleMap;
}

//取得對應某一貸方科目的所有分類
function getAccountClasses(accountTitle){
java.lang.System.out.println(&quot;Check 1&quot;);
	//var querySQL = &quot;Select a.FTYPE,a.FTYPDS from FGP041 a,FGP040 b Where a.FACTID = b.FACTID and b.FDSP40 = &apos;&quot;+accountTitle+&quot;&apos; &quot;;
	//var dataSet = Client.SQLloadValue(querySQL);

        var objFFARTP = new Packages.hct.dataaccess.data.FFARTP();
        var AccountClassesList = objFFARTP.getSecondaryItemsListbyMainItem(accountTitle);
java.lang.System.out.println(&quot;Check 2&quot;);
	var titleMap = new java.util.TreeMap();
	for(var i = 0; i &lt; AccountClassesList.size(); i++){
		var aRow = AccountClassesList.get(i);
	
		//先放名稱再放 ID, 以便存檔時可以由User的選項找到 ID
		titleMap.put(aRow.get(1),aRow.get(0));
	}

	return titleMap;
}

//由 User 選取的科目,分類名稱,取得借貸方的科目代號及分類代號
//依序傳回  [借方科目代號,借方分類代號,貸方科目代號,貸方分類代號]
function getIDs_BothCD(accountTitle, accountClass){

	

        //var querySQL = &quot;Select FACTID_D,FTYPE_D,FACTID_C,FTYPE_C from ACCOUNTTITLE Where FDSP40_D = &apos;&quot;+accountTitle+&quot;&apos; and FTYPDS_D = &apos;&quot;+accountClass+&quot;&apos; &quot;;
	//var dataSet = Client.SQLloadValue(querySQL);

        var objFFARTP = new Packages.hct.dataaccess.data.FFARTP();
        var AccountBothCD = objFFARTP.getFFARTPRowbyAllItemName(accountTitle,accountClass);

   
	if(AccountBothCD  == null || AccountBothCD .size() == 0){
		return null;
	}else{		
		var aRow = AccountBothCD .get(0);
		var idList = [aRow.get(0),aRow.get(1),aRow.get(2),aRow.get(3)];
		
		return idList
	}
}

function getACT12(DEPT){
var AccountID = &quot;XX&quot;;
try{
        var objFPA020 = new Packages.hct.dataaccess.data.FPA020();
        AccountID = objFPA020.getACT12byDEPT(DEPT);

}catch(e){
	java.lang.System.out.println(&quot;getACT12() Error:&quot;+e);
}	

	return AccountID;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>取得相關的會計科目</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00121159178539171</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/09/25 18:02:19</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Client.Table</string> 
     </void> 
     <void property="id"> 
      <string>SCL00121159178539171</string> 
     </void> 
     <void property="name"> 
      <string>Table</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011156610928578</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

function setSingTableUser(tablename){
	//function 寫在 table 的 save script
	// input 部份姓名 output 全部姓名及工號、部門名稱
	var table = Form.getComponent(tablename);
	var id = table.getValueAt(table.getLastAccessIndex(),&quot;工號&quot;);
	var username = table.getValueAt(table.getLastAccessIndex(),&quot;姓名&quot;);
	table.setValueAt(table.getLastAccessIndex()+1+&quot;&quot;,table.getLastAccessIndex(),&quot;序&quot;);
	if (!((id == null)||(id == &quot;&quot;))){
		//用工號來抓姓名及部門名稱
        var s_sql =  &quot;SELECT loginid FROM mem_geninf  WHERE id = &apos;&quot;+ id +&quot;&apos; and resign = &apos;false&apos;&quot;;
		var dataVector = Client.SQLloadValue(s_sql);
		if (dataVector != null &amp;&amp; dataVector.size()&gt;0){
     		var cMember = Client.getMemberByName(dataVector.get(0).get(&quot;loginid&quot;));
			table.setValueAt(cMember.getName(),table.getLastAccessIndex(),&quot;姓名&quot;);
			var memDR = cMember.getMemberDR(cMember.getMainRoleID());
			var sDepName = memDR.getDepartmentName();	//使用者部門名稱
			table.setValueAt(sDepName,table.getLastAccessIndex(),&quot;部門&quot;);

		}else{
			Form.showMessageDialog(&quot;所填的工號不存在!&quot;);		
		}


	}else 	if (!((username == null)||(username == &quot;&quot;))){
		//用姓名來抓工號及部門名稱
        var s_sql =  &quot;SELECT COUNT(*) COUNT FROM mem_geninf  WHERE username like &apos;%&quot;+ username +&quot;%&apos; and resign = &apos;false&apos;&quot;;
		var dataVector = Client.SQLloadValue(s_sql);
		var count = 0;
		if (dataVector != null &amp;&amp; dataVector.size()&gt;0){
			 count = dataVector.get(0).get(&quot;COUNT&quot;);
		}
		if (count == 0 || count ==0.0)
		{
			Form.showMessageDialog(&quot;所填的姓名不存在!&quot;);		
		}else if(count == 1 || count ==1.0) {
	        var s_sql =  &quot;SELECT username FROM mem_geninf  WHERE username like &apos;%&quot;+ username +&quot;%&apos; and resign = &apos;false&apos;&quot;;
			var dataVector = Client.SQLloadValue(s_sql);
			username = dataVector.get(0).get(&quot;username&quot;);
			var cMember = Client.getMemberByCName(username);
			table.setValueAt(username,table.getLastAccessIndex(),&quot;姓名&quot;);
			table.setValueAt(cMember.getMyID(),table.getLastAccessIndex(),&quot;工號&quot;);
			var memDR = cMember.getMemberDR(cMember.getMainRoleID());
			var sDepName = memDR.getDepartmentName();	//使用者部門名稱
			table.setValueAt(sDepName,table.getLastAccessIndex(),&quot;部門&quot;);
		}else if (count &gt;1){
			//有同名的人員

			//寫在母表單的按鈕上
			//開啟唯一一張表單,沒有就新產生一張//ART00121158238730359(選人子單)
			var ArtID = &quot;ART00121158238730359&quot;;
	      	var sSQL = &quot;SELECT InsID FROM &quot;+ ArtID +&quot;_Ins&quot;;
			var vec = Client.SQLloadValue(sSQL);
     	  	if (vec.size() == 0){  
		    	  var artIns = Client.createArtInstance(ArtID);
			      var artInsID = artIns.getID();
			}else{
	    	 	 var artInsID = vec.get(0).get(&quot;InsID&quot;);
	    	}

			//var panel = Client.createForm(artInsID,&quot;CreateForm&quot;,true);
			var panel = Client.createForm(artInsID,&quot;CreateForm&quot;,true,false,true,0,10,10, 550,400) ; 
 		}


	}
	
	
}//function SingTableUser
// add by wangwei   factory 是維護者的廠別
function setSingTableUserExt(tablename,factory){
	//function 寫在 table 的 save script
	// input 部份姓名 output 全部姓名及工號、部門名稱
	var table = Form.getComponent(tablename);
	var id = table.getValueAt(table.getLastAccessIndex(),&quot;工號&quot;);
	var username = table.getValueAt(table.getLastAccessIndex(),&quot;姓名&quot;);
	table.setValueAt(table.getLastAccessIndex()+1+&quot;&quot;,table.getLastAccessIndex(),&quot;序&quot;);
	if (!((id == null)||(id == &quot;&quot;))){
		//用工號來抓姓名及部門名稱
        var s_sql =  &quot;SELECT loginid,memid FROM mem_geninf  WHERE id = &apos;&quot;+ id+&quot;&apos; and areacode = &apos;&quot;+factory+&quot;&apos; and resign = &apos;false&apos;&quot;;
		var dataVector = Client.SQLloadValue(s_sql);
		if (dataVector != null &amp;&amp; dataVector.size()&gt;0){
     		var cMember = Client.getMemberByName(dataVector.get(0).get(&quot;loginid&quot;));
			table.setValueAt(cMember.getName(),table.getLastAccessIndex(),&quot;姓名&quot;);
			table.setValueAt(dataVector.get(0).get(&quot;memid&quot;),table.getLastAccessIndex(),&quot;MEMID&quot;);			
			var memDR = cMember.getMemberDR(cMember.getMainRoleID());
			var sDepName = memDR.getDepartmentName();	//使用者部門名稱
			table.setValueAt(sDepName,table.getLastAccessIndex(),&quot;部門&quot;);

		}else{
			Form.showMessageDialog(&quot;所填的工號不存在!&quot;);		
		}


	}else 	if (!((username == null)||(username == &quot;&quot;))){
		//用姓名來抓工號及部門名稱
        var s_sql =  &quot;SELECT COUNT(*) COUNT FROM mem_geninf  WHERE username like &apos;%&quot;+ username +&quot;%&apos; and resign = &apos;false&apos;&quot;+&quot; and areacode = &apos;&quot;+factory+&quot;&apos;&quot;;
		var dataVector = Client.SQLloadValue(s_sql);
		var count = 0;
		if (dataVector != null &amp;&amp; dataVector.size()&gt;0){
			 count = dataVector.get(0).get(&quot;COUNT&quot;);
		}
		if (count == 0 || count ==0.0)
		{
			Form.showMessageDialog(&quot;所填的姓名不存在!&quot;);		
		}else if(count == 1 || count ==1.0) {
	        var s_sql =  &quot;SELECT username,memid FROM mem_geninf  WHERE username like &apos;%&quot;+ username +&quot;%&apos; and resign = &apos;false&apos;&quot;+&quot; and areacode = &apos;&quot;+factory+&quot;&apos;&quot;;
			var dataVector = Client.SQLloadValue(s_sql);
			username = dataVector.get(0).get(&quot;username&quot;);
			var cMember = Client.getMemberByCName(username);
			table.setValueAt(username,table.getLastAccessIndex(),&quot;姓名&quot;);
			table.setValueAt(dataVector.get(0).get(&quot;memid&quot;),table.getLastAccessIndex(),&quot;MEMID&quot;);
			table.setValueAt(cMember.getMyID(),table.getLastAccessIndex(),&quot;工號&quot;);
			var memDR = cMember.getMemberDR(cMember.getMainRoleID());
			var sDepName = memDR.getDepartmentName();	//使用者部門名稱
			table.setValueAt(sDepName,table.getLastAccessIndex(),&quot;部門&quot;);
		}else if (count &gt;1){
			//有同名的人員

			//寫在母表單的按鈕上
			//開啟唯一一張表單,沒有就新產生一張//ART00121158238730359(選人子單)
			var ArtID = &quot;ART00121158238730359&quot;;
	      	var sSQL = &quot;SELECT InsID FROM &quot;+ ArtID +&quot;_Ins&quot;;
			var vec = Client.SQLloadValue(sSQL);
     	  	if (vec.size() == 0){  
		    	  var artIns = Client.createArtInstance(ArtID);
			      var artInsID = artIns.getID();
			}else{
	    	 	 var artInsID = vec.get(0).get(&quot;InsID&quot;);
	    	}

			//var panel = Client.createForm(artInsID,&quot;CreateForm&quot;,true);
			var panel = Client.createForm(artInsID,&quot;CreateForm&quot;,true,false,true,0,10,10, 550,400) ; 
 		}


	}
	
	
}//function SingTableUser
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00121216878888116</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/03/14 09:35:51</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PH.FILTER_CATEGORY</string> 
     </void> 
     <void property="id"> 
      <string>SCL00121216878888116</string> 
     </void> 
     <void property="name"> 
      <string>FILTER_CATEGORY</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00321216878882287</string> 
     </void> 
     <void property="scriptSource"> 
      <string>	
//===================================================================
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;
//				}else if(&quot;complete&quot; == task.getTaskState()){
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
				//table.setValueAt(getPriorityString(task), i, &quot;緊急程度&quot;);
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);

			if(&quot;Y&quot;.equals(hm.get(&quot;ITEM131&quot;))){
				var prstatus = &quot;已轉檔&quot;;
			}else if(&quot;W&quot;.equals(hm.get(&quot;ITEM131&quot;))){
				var prstatus = &quot;已收件&quot;;
			}
			else{
				var prstatus = &quot;未收件&quot;;
			}
			
			table.setValueAt(prstatus,    	row, &quot;PR狀態&quot;);			
			table.setValueAt(hm.get(&quot;ITEM12&quot;).substring(0,10),    	row, &quot;開單日期&quot;);
			
			if(hm.get(&quot;ITEM115&quot;).length()&gt;1){
				var fm_closedate = hm.get(&quot;ITEM115&quot;).substring(0,10);
			}else{
				var fm_closedate = &quot;--&quot;;
			}
			table.setValueAt(hm.get(&quot;ITEM173&quot;),    	row, &quot;收件人&quot;);
			table.setValueAt(hm.get(&quot;ITEM147&quot;),    	row, &quot;收件日&quot;);
			table.setValueAt(fm_closedate,    	row, &quot;結案日期&quot;);	
			table.setValueAt(hm.get(&quot;ITEM138&quot;),    	row, &quot;PR No.&quot;);
						//------20100218 ADD BY PERI: 增加PO_NO
		    var epono = &quot;未取得&quot;;
			
			var getorg = hm.get(&quot;ITEM2&quot;);   //(TGCE)
				if(&quot;(TGCE)&quot;.equals(getorg)){
					var ORG_ID = &quot;30&quot;;
				}
				else if(&quot;(SGCE)&quot;.equals(getorg)){
					var ORG_ID = &quot;174&quot;;
				}
				else if(&quot;(CGCE)&quot;.equals(getorg)){
					var ORG_ID = &quot;114&quot;;
				}
				else if(&quot;(HGCE)&quot;.equals(getorg)){
					var ORG_ID = &quot;274&quot;;
				}				
				else{
					var ORG_ID = &quot;30&quot;;
				}	
 		    var sqls = &quot;SELECT TGC_UPI_PO_PKG.TG_OA_GET_EPO_NO(&quot;+ORG_ID+&quot;,&apos;&quot;+hm.get(&quot;ITEM138&quot;)+&quot;&apos;) EPO_NO FROM DUAL &quot;
			try{
				var rs = Client.SQLloadValue(sqls);		
				if(!&quot;&quot;.equals(rs.get(0).get(&quot;EPO_NO&quot;))){
					epono = &quot;PO_NO=&quot;+rs.get(0).get(&quot;EPO_NO&quot;);
					epono.replace(&quot;PO_NO=&quot;,&quot;No:&quot;);
					epono.replace(&quot;#&quot;,&quot;\n&quot;);
					}
			}
			catch(e){
				
			}			
			table.setValueAt(epono,    	row, &quot;PO No.&quot;);					
			//------20100218 ADD BY PERI: 增加PO_NO
			table.setValueAt(hm.get(&quot;ITEM144&quot;),    	row, &quot;填單人&quot;);
			table.setValueAt(hm.get(&quot;ITEM24&quot;), 	row, &quot;申請人&quot;);
			table.setValueAt(hm.get(&quot;ITEM186&quot;), 	row, &quot;開單部門&quot;);
			table.setValueAt(hm.get(&quot;ITEM15&quot;),   	row, &quot;用途說明&quot;);
			table.setValueAt(hm.get(&quot;ITEM165&quot;),  	row, &quot;品名/規格&quot;);
			table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}
//========================================================================================
// 文件變更單之查詢共用條件的SQL
//========================================================================================
function getQueryCondition(){
	var sSQL=&quot;&quot;;
	// 起始日期
if(!&quot;不限定&quot;.equals(Form.getValue(&quot;date_filters&quot;))||&quot;全部&quot;.equals(PHSTATUS)){
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
			else if(&quot;依採購收件日&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM147||&apos; 00:00&apos; &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;				
				}
			else{
					sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
				}
		}
	}
	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			
			if(&quot;依結案日期&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM115 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;					
				}
			else if(&quot;依採購收件日&quot;.equals(Form.getValue(&quot;date_filters&quot;))){
					sSQL += &quot; AND ITEM147||&apos; 00:00&apos; &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;			
			}
				else{
					sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
				}			
		}
	}
}
	// 文件編號
	var Doc_Sn = Form.getValue(&quot;Sn&quot;).toUpperCase();

	if (!&quot;&quot;.equals(Doc_Sn)) {
		sSQL += &quot; AND ITEM138 like &apos;%&quot; + Doc_Sn + &quot;%&apos;&quot;;
	}	
	
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM144 like &apos;%&quot; + MemName + &quot;%&apos;&quot;;
	}	
	var appname = Form.getValue(&quot;appname&quot;);	
	if (!&quot;&quot;.equals(appname)) {
		sSQL += &quot; AND ITEM27 like &apos;%&quot; + appname + &quot;%&apos;&quot;;
	}	

	// byappdept	
	var byappdept = Form.getValue(&quot;byappdept&quot;);	
	if (!&quot;&quot;.equals(byappdept)) {
		sSQL += &quot; AND ITEM186 like &apos;%&quot; + byappdept + &quot;%&apos;&quot;;
	}	

	var PHSTATUS = Form.getValue(&quot;FComboBox0&quot;);

	if (!&quot;全部&quot;.equals(PHSTATUS)) {
		if(&quot;採購已收件&quot;.equals(PHSTATUS)){
						var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
						if (&quot;true&quot;.equals(ckbSDate)){	
							var sDate = Form.getValue(&quot;sDate&quot;);	
							if (!&quot;&quot;.equals(sDate)) {
								sSQL += &quot; AND ITEM147 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
							}
						}
						var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
						if (&quot;true&quot;.equals(ckbEDate)){	
							var eDate = Form.getValue(&quot;eDate&quot;);	
							if (!&quot;&quot;.equals(eDate)) {
										sSQL += &quot; AND ITEM147 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
							}
						}
			sSQL += &quot; AND ITEM131 = &apos;W&apos;&quot;;			
		}
		else if(&quot;已轉入ERP&quot;.equals(PHSTATUS)){
						var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
						if (&quot;true&quot;.equals(ckbSDate)){	
							var sDate = Form.getValue(&quot;sDate&quot;);	
							if (!&quot;&quot;.equals(sDate)) {
								sSQL += &quot; AND ITEM149 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
							}
						}
						var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
						if (&quot;true&quot;.equals(ckbEDate)){	
							var eDate = Form.getValue(&quot;eDate&quot;);	
							if (!&quot;&quot;.equals(eDate)) {
										sSQL += &quot; AND ITEM149 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
							}
						}			
			sSQL += &quot; AND ITEM131 = &apos;Y&apos;&quot;;
		}
		else{
			sSQL += &quot; AND (ITEM131 &lt;&gt; &apos;W&apos; and  ITEM131 &lt;&gt; &apos;Y&apos;) &quot;;
		}
		}
//		else		{
//				var Status = Form.getValue(&quot;Status&quot;);	 
//				if (!&quot;全部&quot;.equals(Status)) {
//						if (&quot;已結案&quot;.equals(Status)) {
//							sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM115 is not null &quot;;
//						}else if (&quot;未結案&quot;.equals(Status)){
//							sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
//						}				
//				}
//		}
	//文件狀態

				var Status = Form.getValue(&quot;Status&quot;);	 
				if (!&quot;全部&quot;.equals(Status)) {
						if (&quot;已結案&quot;.equals(Status)) {
							sSQL += &quot; AND ITEM155 = &apos;false&apos; AND ITEM115 is not null &quot;;
						}else if (&quot;未結案&quot;.equals(Status)){
							sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;
						}				
				}	

	//採購類別
	var PRTYPE = Form.getValue(&quot;PRTYPE&quot;);
	if (!&quot;全部&quot;.equals(PRTYPE)) {
		sSQL += &quot; AND ITEM66 = &apos;&quot;+PRTYPE+&quot;&apos; &quot;;
	}				
				
	// 用途說明
	var spec = Form.getValue(&quot;spec&quot;);	
	if (!&quot;&quot;.equals(spec)) {
		sSQL += &quot; AND ITEM15 like &apos;%&quot; + spec + &quot;%&apos;&quot;;
	}		
	// 品名規格
	var Subject = Form.getValue(&quot;Subject&quot;);	
	if (!&quot;&quot;.equals(Subject)) {
		sSQL += &quot; AND ITEM165 like &apos;%&quot; + Subject + &quot;%&apos;&quot;;
	}		
	return sSQL;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00121250755035105</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/09/25 18:02:19</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Client.Table</string> 
     </void> 
     <void property="id"> 
      <string>SCL00121250755035105</string> 
     </void> 
     <void property="name"> 
      <string>Table</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091250755035083</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

function setSingTableUser(tablename){
	//function 寫在 table 的 save script
	// input 部份姓名 output 全部姓名及工號、部門名稱
	var table = Form.getComponent(tablename);
	var id = table.getValueAt(table.getLastAccessIndex(),&quot;工號&quot;);
	var username = table.getValueAt(table.getLastAccessIndex(),&quot;姓名&quot;);
	table.setValueAt(table.getLastAccessIndex()+1+&quot;&quot;,table.getLastAccessIndex(),&quot;序&quot;);
	if (!((id == null)||(id == &quot;&quot;))){
		//用工號來抓姓名及部門名稱
        var s_sql =  &quot;SELECT loginid FROM mem_geninf  WHERE id = &apos;&quot;+ id +&quot;&apos; and resign = &apos;false&apos;&quot;;
		var dataVector = Client.SQLloadValue(s_sql);
		if (dataVector != null &amp;&amp; dataVector.size()&gt;0){
     		var cMember = Client.getMemberByName(dataVector.get(0).get(&quot;loginid&quot;));
			table.setValueAt(cMember.getName(),table.getLastAccessIndex(),&quot;姓名&quot;);
			var memDR = cMember.getMemberDR(cMember.getMainRoleID());
			var sDepName = memDR.getDepartmentName();	//使用者部門名稱
			table.setValueAt(sDepName,table.getLastAccessIndex(),&quot;部門&quot;);

		}else{
			Form.showMessageDialog(&quot;所填的工號不存在!&quot;);		
		}


	}else 	if (!((username == null)||(username == &quot;&quot;))){
		//用姓名來抓工號及部門名稱
        var s_sql =  &quot;SELECT COUNT(*) COUNT FROM mem_geninf  WHERE username like &apos;%&quot;+ username +&quot;%&apos; and resign = &apos;false&apos;&quot;;
		var dataVector = Client.SQLloadValue(s_sql);
		var count = 0;
		if (dataVector != null &amp;&amp; dataVector.size()&gt;0){
			 count = dataVector.get(0).get(&quot;COUNT&quot;);
		}
		if (count == 0 || count ==0.0)
		{
			Form.showMessageDialog(&quot;所填的姓名不存在!&quot;);		
		}else if(count == 1 || count ==1.0) {
	        var s_sql =  &quot;SELECT username FROM mem_geninf  WHERE username like &apos;%&quot;+ username +&quot;%&apos; and resign = &apos;false&apos;&quot;;
			var dataVector = Client.SQLloadValue(s_sql);
			username = dataVector.get(0).get(&quot;username&quot;);
			var cMember = Client.getMemberByCName(username);
			table.setValueAt(username,table.getLastAccessIndex(),&quot;姓名&quot;);
			table.setValueAt(cMember.getMyID(),table.getLastAccessIndex(),&quot;工號&quot;);
			var memDR = cMember.getMemberDR(cMember.getMainRoleID());
			var sDepName = memDR.getDepartmentName();	//使用者部門名稱
			table.setValueAt(sDepName,table.getLastAccessIndex(),&quot;部門&quot;);
		}else if (count &gt;1){
			//有同名的人員

			//寫在母表單的按鈕上
			//開啟唯一一張表單,沒有就新產生一張//ART00121158238730359(選人子單)
			var ArtID = &quot;ART00121158238730359&quot;;
	      	var sSQL = &quot;SELECT InsID FROM &quot;+ ArtID +&quot;_Ins&quot;;
			var vec = Client.SQLloadValue(sSQL);
     	  	if (vec.size() == 0){  
		    	  var artIns = Client.createArtInstance(ArtID);
			      var artInsID = artIns.getID();
			}else{
	    	 	 var artInsID = vec.get(0).get(&quot;InsID&quot;);
	    	}

			//var panel = Client.createForm(artInsID,&quot;CreateForm&quot;,true);
			var panel = Client.createForm(artInsID,&quot;CreateForm&quot;,true,false,true,0,10,10, 550,400) ; 
 		}


	}
	
	
}//function SingTableUser
// add by wangwei   factory 是維護者的廠別
function setSingTableUserExt(tablename,factory){
	//function 寫在 table 的 save script
	// input 部份姓名 output 全部姓名及工號、部門名稱
	var table = Form.getComponent(tablename);
	var id = table.getValueAt(table.getLastAccessIndex(),&quot;工號&quot;);
	var username = table.getValueAt(table.getLastAccessIndex(),&quot;姓名&quot;);
	table.setValueAt(table.getLastAccessIndex()+1+&quot;&quot;,table.getLastAccessIndex(),&quot;序&quot;);
	if (!((id == null)||(id == &quot;&quot;))){
		//用工號來抓姓名及部門名稱
        var s_sql =  &quot;SELECT loginid,memid FROM mem_geninf  WHERE id = &apos;&quot;+ id+&quot;&apos; and areacode = &apos;&quot;+factory+&quot;&apos; and resign = &apos;false&apos;&quot;;
		var dataVector = Client.SQLloadValue(s_sql);
		if (dataVector != null &amp;&amp; dataVector.size()&gt;0){
     		var cMember = Client.getMemberByName(dataVector.get(0).get(&quot;loginid&quot;));
			table.setValueAt(cMember.getName(),table.getLastAccessIndex(),&quot;姓名&quot;);
			table.setValueAt(dataVector.get(0).get(&quot;memid&quot;),table.getLastAccessIndex(),&quot;MEMID&quot;);			
			var memDR = cMember.getMemberDR(cMember.getMainRoleID());
			var sDepName = memDR.getDepartmentName();	//使用者部門名稱
			table.setValueAt(sDepName,table.getLastAccessIndex(),&quot;部門&quot;);

		}else{
			Form.showMessageDialog(&quot;所填的工號不存在!&quot;);		
		}


	}else 	if (!((username == null)||(username == &quot;&quot;))){
		//用姓名來抓工號及部門名稱
        var s_sql =  &quot;SELECT COUNT(*) COUNT FROM mem_geninf  WHERE username like &apos;%&quot;+ username +&quot;%&apos; and resign = &apos;false&apos;&quot;+&quot; and areacode = &apos;&quot;+factory+&quot;&apos;&quot;;
		var dataVector = Client.SQLloadValue(s_sql);
		var count = 0;
		if (dataVector != null &amp;&amp; dataVector.size()&gt;0){
			 count = dataVector.get(0).get(&quot;COUNT&quot;);
		}
		if (count == 0 || count ==0.0)
		{
			Form.showMessageDialog(&quot;所填的姓名不存在!&quot;);		
		}else if(count == 1 || count ==1.0) {
	        var s_sql =  &quot;SELECT username,memid FROM mem_geninf  WHERE username like &apos;%&quot;+ username +&quot;%&apos; and resign = &apos;false&apos;&quot;+&quot; and areacode = &apos;&quot;+factory+&quot;&apos;&quot;;
			var dataVector = Client.SQLloadValue(s_sql);
			username = dataVector.get(0).get(&quot;username&quot;);
			var cMember = Client.getMemberByCName(username);
			table.setValueAt(username,table.getLastAccessIndex(),&quot;姓名&quot;);
			table.setValueAt(dataVector.get(0).get(&quot;memid&quot;),table.getLastAccessIndex(),&quot;MEMID&quot;);
			table.setValueAt(cMember.getMyID(),table.getLastAccessIndex(),&quot;工號&quot;);
			var memDR = cMember.getMemberDR(cMember.getMainRoleID());
			var sDepName = memDR.getDepartmentName();	//使用者部門名稱
			table.setValueAt(sDepName,table.getLastAccessIndex(),&quot;部門&quot;);
		}else if (count &gt;1){
			//有同名的人員

			//寫在母表單的按鈕上
			//開啟唯一一張表單,沒有就新產生一張//ART00121158238730359(選人子單)
			var ArtID = &quot;ART00121158238730359&quot;;
	      	var sSQL = &quot;SELECT InsID FROM &quot;+ ArtID +&quot;_Ins&quot;;
			var vec = Client.SQLloadValue(sSQL);
     	  	if (vec.size() == 0){  
		    	  var artIns = Client.createArtInstance(ArtID);
			      var artInsID = artIns.getID();
			}else{
	    	 	 var artInsID = vec.get(0).get(&quot;InsID&quot;);
	    	}

			//var panel = Client.createForm(artInsID,&quot;CreateForm&quot;,true);
			var panel = Client.createForm(artInsID,&quot;CreateForm&quot;,true,false,true,0,10,10, 550,400) ; 
 		}


	}
	
	
}//function SingTableUser
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00131102067302190</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.MemberFunction.MemberFunction</string> 
     </void> 
     <void property="id"> 
      <string>SCL00131102067302190</string> 
     </void> 
     <void property="name"> 
      <string>MemberFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031102066129487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//傳入人員的名稱
//傳回該名稱對應的 member 物件(會濾掉同名的未指派人員)
function getMemberObjByName(memberName){
	var memVector = Client.getAllMemberByCName(memberName);
	var member = Client.getMember(memberName);
	//人員會有重複,但只要選出有指派職務的第一個即可(只要濾掉未指派成員即可)
	for(var i = 0; i &lt; memVector.size(); i++){
		var tempMember = memVector.get(i);
		if(!tempMember.getMainRoleID().equals(&quot;&quot;)){
			member = tempMember;
			break;
		}
	}

	return member;
}
//傳入部門集合物件,取出部門集合底下的所有員工 Member 物件 Vector
function getMutiDepartmentMemberList(departmentList){
	
	var memList = new java.util.Vector();
	if(departmentList == null) 
		return memList;
    
	for(var i = 0; i &lt; departmentList.size(); i++){
		var aDepMemList= getDepartmentMemberList(departmentList.get(i));
		memList.addAll(aDepMemList);
	}
	
	return memList;
}
//傳入部門物件,取出該部門底下的所有員工 Member 物件 Vector
function getDepartmentMemberList(department){
	var memList = new java.util.Vector();
	if(department == null) 
		return memList;
	
	//先取該部門直屬職位的成員
	var roleIDList = department.getRoleList();
	for(var i = 0; i &lt; roleIDList.size(); i++){
		var roleObj = Client.getRole(roleIDList.get(i));
		var subList = getRoleMemberList(roleObj);
		memList.addAll(subList);
	}
		
	//再取子部門的成員
	var subDepList = department.getSubDepartmentList();
	for(var i = 0; i &lt; subDepList.size(); i++){
		var subDep = Client.getDepartment(subDepList.get(i));
		var subList = getDepartmentMemberList(subDep);
		
		memList.addAll(subList);
	}
	
	return memList;
}
//傳入部門物件,取出該部門底下的所有員工 Member 物件 Vector 但不含子部門
function getDepartmentMemberListNoSub(department){
	var memList = new java.util.Vector();
	if(department == null) 
		return memList;
		
	//先取該部門直屬職位的成員
	var roleIDList = department.getRoleList();
	for(var i = 0; i &lt; roleIDList.size(); i++){
		var roleObj = Client.getRole(roleIDList.get(i));
		var subList = getRoleMemberList(roleObj);
		
		memList.addAll(subList);
	}

	return memList;
}
//傳入部門物件,取出該部門底下相同會計科目所有員工 Member 物件 Vector
function getAccDepMemberList(runSide,depIDList,department){
	var memList = new java.util.Vector();
	if(department == null) 
		return memList;
		
	//先取該部門直屬職位的成員
	var roleIDList = department.getRoleList();
	for(var i = 0; i &lt; roleIDList.size(); i++){
		var roleObj = Client.getRole(roleIDList.get(i));
		var subList = getRoleMemberList(roleObj);
		
		memList.addAll(subList);
	}
	//再取子部門的成員(會計科目相同)
	loadLibrary(&quot;ScriptLibary.MemberFunction.DepartmentFunction&quot;);
	accDepObj = getAccDepartmentResByDep(runSide,depIDList,department);
	
	java.lang.System.out.println(&quot;AccDep:&quot; +accDepObj.getName());
	
    var subDepList = department.getSubDepartmentList();
    for(var i = 0; i &lt; subDepList.size(); i++){
	    var subDep = Client.getDepartment(subDepList.get(i));
		
		java.lang.System.out.println(&quot;SubAccDep:&quot; +getAccDepartmentResByDep(runSide,depIDList,subDep).getName());
		
		if (getAccDepartmentResByDep(runSide,depIDList,subDep).getMyID().equals(accDepObj.getMyID())){
			var subList = getDepartmentMemberListNoSub(subDep);
			memList.addAll(subList);
		}
		
	}
	
	return memList;
}
//傳入Role 物件, 取出該 Role 底下的所有員工 Member 物件 Vector
function getRoleMemberList(role){
	var memList = new java.util.Vector();
	if(role == null) 
		return memList;
	
	//先取該直屬職務底下的員工	
	var memIDList = role.getMemberList();
	for(var i = 0; i &lt; memIDList.size(); i++){
		var member = Client.getMember(memIDList.get(i));
		if(member != null)
			memList.add(member);
	}
	
	//再取該直屬職務的子職務的成員		
	var subRoleIDList = role.getSubRoleList();
	for (var i = 0; i &lt; subRoleIDList.size(); i++)	{	
		var subRole = Client.getRole(subRoleIDList.get(i));
		var subList = getRoleMemberList(subRole);
	
		memList.addAll(subList);
	}	
	
	return memList;
}
//傳入Role 物件, 取出該 Role 底下員工 Member 物件 Vector
function getRoleMemberListNoSub(role){
	var memList = new java.util.Vector();
	if(role == null) 
		return memList;
	
	//取該 Role 底下的員工	
	var memIDList = role.getMemberList();
	for(var i = 0; i &lt; memIDList.size(); i++){
		var member = Client.getMember(memIDList.get(i));
		if(member != null)
			memList.add(member);
	}
	
	return memList;
}


</string> 
     </void> 
     <void property="synopsis"> 
      <string>取得 Member 的相關資訊</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00131237179798492</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/03/16 13:54:02</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Server.EDI_MES</string> 
     </void> 
     <void property="id"> 
      <string>SCL00131237179798492</string> 
     </void> 
     <void property="name"> 
      <string>EDI_MES</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00281213180209899</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

function INS_MES_MAN(){
		var aInstance = MyTask.getArtInstance();
		var dataMap = aInstance.getAppDataMap();	
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		var App_ID = dataMap.get(&quot;App_ID&quot;);
		var Sn = dataMap.get(&quot;Sn&quot;);	
		var vGCE_DOC_SN = dataMap.get(&quot;GCE_Doc_Sn&quot;);
		var Factory_ID = dataMap.get(&quot;Factory&quot;).substring(1,5);					
			if (Sn.trim().length() &gt;= 13 ){
				var Factory = dataMap.get(&quot;Factory&quot;);
				gce_ver = Sn.trim().substring( Sn.trim().indexOf(&apos;-&apos;) + 1 , Sn.trim().indexOf(&apos;-&apos;) + 3 ) ;
				dataMap.put(&quot;item_no_a&quot;,Sn.substring(0,9));
				dataMap.put(&quot;gce_ver_a&quot;,gce_ver);			
				try{		
					var sql = &quot;INSERT INTO MQT_FILM120_TEMP &quot;+  
					   &quot;(item_no,&quot;+
					   &quot;mecn_no,&quot;+
					   &quot;tran_yn,&quot;+
					   &quot;ins_empno,&quot;+
					   &quot;doc_id,&quot;+
					   &quot;ver_id,&quot;+
					   &quot;ins_dtime,gce_ver,MQ_STATUS,MQ_FLAG,factory,MAN_STATUS )&quot;+
					   &quot;VALUES ( &apos;&quot;+ Sn.substring(0,9) +&quot;&apos;,&quot;+
					   &quot;&apos;&quot; + Sn + &quot;&apos;,&quot;+
					   &quot;&apos;N&apos;,&quot;+
					   &quot;&apos;&quot; + App_ID + &quot;&apos;,&quot;+
					   &quot;&apos;&quot; + doc_id + &quot;&apos;,&quot;+
   					   &quot;&apos;&quot; + ver_id + &quot;&apos;,&quot;+
					   &quot;sysdate,&apos;&quot;+gce_ver+&quot;&apos;,&apos;I&apos;,&apos;O&apos;, &apos;&quot;+Factory_ID+&quot;&apos;,&apos;N&apos;) &quot;;	
					   Server.SQLupdateValue(sql);	
				}catch(e){
				}
				finally {       
				}
			}
}


function INS_MES_ER_EQ(){
		var aInstance = MyTask.getArtInstance();
		var dataMap = aInstance.getAppDataMap();	
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		var App_ID = dataMap.get(&quot;App_ID&quot;);
		var Sn = dataMap.get(&quot;Sn&quot;);	
		var vGCE_DOC_SN = dataMap.get(&quot;GCE_Doc_Sn&quot;);
		var Factory_ID = dataMap.get(&quot;Factory&quot;).substring(1,5);	
		
		//若為TGCE幫SGCE代填單，則寫入的工號第1碼改T  add by edison@20140527
		if(Factory_ID==&quot;SGCE&quot; &amp;&amp; App_ID.length()&gt;=6){
			var memid = dataMap.get(&quot;Creator_ID&quot;);
			var member = Server.getMemberByID(memid);
			var areacode = member.getAreaCode();
			if(areacode==&quot;TGCE&quot;){
				App_ID = &quot;T&quot;+App_ID.substr(1,5);
			}
				
		}				
			if (Sn.trim().length() &gt;= 13 ){
				var Factory = dataMap.get(&quot;Factory&quot;);
				gce_ver = Sn.trim().substring( Sn.trim().indexOf(&apos;-&apos;) + 1 , Sn.trim().indexOf(&apos;-&apos;) + 3 ) ;
				dataMap.put(&quot;item_no_a&quot;,Sn.substring(0,9));
				dataMap.put(&quot;gce_ver_a&quot;,gce_ver);			
				try{		
					var sql = &quot;INSERT INTO MQT_FILM120_TEMP &quot;+  
					   &quot;(item_no,&quot;+
					   &quot;mecn_no,&quot;+
					   &quot;tran_yn,&quot;+
					   &quot;ins_empno,&quot;+
					   &quot;doc_id,&quot;+
					   &quot;ver_id,&quot;+					   
					   &quot;ins_dtime,gce_ver,MQ_STATUS,MQ_FLAG,factory,MAN_STATUS )&quot;+
					   &quot;VALUES ( &apos;&quot;+ Sn.substring(0,9) +&quot;&apos;,&quot;+
					   &quot;&apos;&quot; + Sn + &quot;&apos;,&quot;+
					   &quot;&apos;N&apos;,&quot;+
					   &quot;&apos;&quot; + App_ID + &quot;&apos;,&quot;+
					   &quot;&apos;&quot; + doc_id + &quot;&apos;,&quot;+
   					   &quot;&apos;&quot; + ver_id + &quot;&apos;,&quot;+
					   &quot;sysdate,&apos;&quot;+gce_ver+&quot;&apos;,&apos;I&apos;,&apos;N&apos;, &apos;&quot;+Factory_ID+&quot;&apos;,&apos;O&apos; )  &quot;;		
					   Server.SQLupdateValue(sql);	
				}catch(e){
				}
				finally {       
				}
			}
}



function INS_MES_CUS(PDM_TYPE){
//		Server.addDebugLog(&quot;INS_MES_CUS_sqlbeg&quot;); //mark by wangwei@2016/04/22
		var aInstance = MyTask.getArtInstance();
		var dataMap = aInstance.getAppDataMap();	
		var vApp_ID = dataMap.get(&quot;App_ID&quot;);
		var Sn = dataMap.get(&quot;Sn&quot;);
		var vGCE_DOC_SN = dataMap.get(&quot;GCE_Doc_Sn&quot;);
		var Factory_ID = dataMap.get(&quot;Factory&quot;).substring(1,5);	
		var vItem_no= &quot;&quot;;
		var vGCE_VER = &quot;&quot; ;	
		var vPCB_LAYER = &quot;&quot; ;	
		var vPCB_LAYERN = &quot;0&quot; ;
	    if (Sn.trim().length() &gt;= 9 ) {
			vItem_no= Sn.substring(0,9);
			vPCB_LAYER = Sn.substring(4,5).toUpperCase();
			if(vPCB_LAYER.toString().equals(&quot;A&quot;)){vPCB_LAYERN=&quot;10&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;B&quot;)){vPCB_LAYERN=&quot;12&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;C&quot;)){vPCB_LAYERN=&quot;14&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;D&quot;)){vPCB_LAYERN=&quot;16&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;E&quot;)){vPCB_LAYERN=&quot;18&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;F&quot;)){vPCB_LAYERN=&quot;20&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;G&quot;)){vPCB_LAYERN=&quot;22&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;H&quot;)){vPCB_LAYERN=&quot;24&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;I&quot;)){vPCB_LAYERN=&quot;26&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;J&quot;)){vPCB_LAYERN=&quot;28&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;K&quot;)){vPCB_LAYERN=&quot;30&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;L&quot;)){vPCB_LAYERN=&quot;32&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;M&quot;)){vPCB_LAYERN=&quot;34&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;N&quot;)){vPCB_LAYERN=&quot;36&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;O&quot;)){vPCB_LAYERN=&quot;38&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;P&quot;)){vPCB_LAYERN=&quot;40&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;Q&quot;)){vPCB_LAYERN=&quot;42&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;R&quot;)){vPCB_LAYERN=&quot;44&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;S&quot;)){vPCB_LAYERN=&quot;46&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;T&quot;)){vPCB_LAYERN=&quot;48&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;U&quot;)){vPCB_LAYERN=&quot;50&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;V&quot;)){vPCB_LAYERN=&quot;52&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;W&quot;)){vPCB_LAYERN=&quot;54&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;X&quot;)){vPCB_LAYERN=&quot;56&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;Y&quot;)){vPCB_LAYERN=&quot;58&quot;;}
			if(vPCB_LAYER.toString().equals(&quot;Z&quot;)){vPCB_LAYERN=&quot;60&quot;;}
			
	    }
//	    if (Sn.trim().length() &gt;= 9 ) {
//			vGCE_VER = Sn.trim().substring( Sn.trim().indexOf(&apos;-&apos;) + 1 , Sn.trim().indexOf(&apos;-&apos;) + 3 ) ;	
//	    }				
		try{			
			var SQL = &quot;   INSERT INTO MQT_CUSTOMER_TEMP  &quot;;
			SQL = SQL +  &quot; ( ITEM_NO, &quot;;
			SQL = SQL +  &quot; ACTIVENAME, &quot;;  //活動名稱
			SQL = SQL +  &quot; STATUS, &quot;;
			SQL = SQL +  &quot; SOURCE, &quot;;  //W
			SQL = SQL +  &quot; INS_DTIME, &quot;;
			SQL = SQL +  &quot; PCB_LAYER, &quot;;
			SQL = SQL +  &quot; GCE_VER, &quot;;
			SQL = SQL +  &quot; AUTHOR, &quot;;
			SQL = SQL +  &quot; FACTORY, &quot;;
			SQL = SQL +  &quot; MQ_FLAG, &quot;;
			SQL = SQL +  &quot; MQ_STATUS, &quot;;
			SQL = SQL +  &quot; GCE_DOC_SN )&quot;;
			SQL = SQL +  &quot;   VALUES ( &apos;&quot;+ vItem_no +&quot;&apos;,   &quot;;
			SQL = SQL +  &quot;            &apos;&quot;+PDM_TYPE+&quot;&apos;,   &quot;;
			SQL = SQL +  &quot;            &apos;NEW&apos;,   &quot;; //審核
			SQL = SQL +  &quot;            &apos;W&apos;,   &quot;;  //&apos;PDM&apos;  -&gt; MES一碼  W
			SQL = SQL +  &quot;            sysdate,   &quot;;
			SQL = SQL +  &quot;            &apos;&quot;+vPCB_LAYERN+&quot;&apos;,   &quot;;
			SQL = SQL +  &quot;            &apos;00&apos;,   &quot;;
			SQL = SQL +  &quot;            &apos;&quot;+vApp_ID+&quot;&apos;,   &quot;;
			SQL = SQL +  &quot;            &apos;&quot;+Factory_ID+&quot;&apos;,   &quot;;
			SQL = SQL +  &quot;            &apos;N&apos;,   &quot;;
			SQL = SQL +  &quot;            &apos;I&apos;,   &quot;;
			SQL = SQL +  &quot;            &apos;&quot;+vGCE_DOC_SN+&quot;&apos; ) &quot;;
			java.lang.System.out.println(&quot;Customer_sql=&quot;+SQL);
			Server.addDebugLog(&quot;INS_MES_CUS_sql==&quot;+SQL);
			Server.SQLupdateValue(SQL);		   	
		}catch(e){
			Server.addErrLog(&quot;INS_MES_CUS_sqle==&quot;+SQL);
		}finally {       
		}
}



function INS_MES_Manm179_ER(){
		var aInstance = MyTask.getArtInstance();
		var dataMap = aInstance.getAppDataMap();	
		var vApp_ID = dataMap.get(&quot;App_ID&quot;);
		var Sn = dataMap.get(&quot;Sn&quot;);
		var vGCE_DOC_SN = dataMap.get(&quot;GCE_Doc_Sn&quot;);
		var Factory_ID = dataMap.get(&quot;Factory&quot;).substring(1,5);	
		var vItem_no= Sn.substr(0,3)+Sn.substr(6,3);
		var vGCE_VER = Sn.trim().substring( Sn.trim().indexOf(&apos;-&apos;) + 1 , Sn.trim().indexOf(&apos;-&apos;) + 3 ) ;				
		try{
			if( &quot;(TGCE)&quot;== dataMap.get(&quot;Factory&quot;) || &quot;GCE&quot;== dataMap.get(&quot;Factory&quot;)  ){
				var conn = Server.createSessionConnection(&quot;T-MES&quot;);
				var Sql = &quot;select item_no from manm179 where er_no = &apos;&quot; + vGCE_DOC_SN +&quot;&apos;&quot;;
				var vec = conn.loadValue(Sql);
				if( vec.size()==0){	
					var sql_i = &quot;INSERT INTO manm179 &quot;+&quot;(item_no,&quot;+&quot;er_no,&quot;+&quot;wt_user,&quot;+&quot;wt_dtime,&quot;+&quot;gce_ver )&quot;+
					&quot;VALUES ( &apos;&quot;+ vItem_no +&quot;&apos;,&quot;+&quot;&apos;&quot; + vGCE_DOC_SN + &quot;&apos;,&quot;+&quot;&apos;&quot; + vApp_ID + &quot;&apos;,&quot;+&quot;current,&quot;+&quot;&apos;&quot;+ vGCE_VER + &quot;&apos;) ;&quot;;									
					var vResult=conn.updateValue(sql_i);
				}
			}
		}catch(e){
		}finally { 
			conn.close();  // move here by wangwei@2011/06/27
		}
//		conn.close();
}
// add by wangwei@2009/03/17
// 發料單提出時即新增
function INS_MES_Material_Issue(vMQ_Status){
		var aInstance = MyTask.getArtInstance();
		var dataMap = aInstance.getAppDataMap();	
		var vApp_ID = dataMap.get(&quot;App_ID&quot;);
		var Sn = dataMap.get(&quot;Sn&quot;);
		var vGCE_DOC_SN = dataMap.get(&quot;GCE_Doc_Sn&quot;);
		var Factory_ID = dataMap.get(&quot;Factory&quot;).substring(1,5);	
		var vItem_no= Sn.substring(0,9);
		var vGCE_VER = Sn.trim().substring( Sn.trim().indexOf(&apos;-&apos;) + 1 , Sn.trim().indexOf(&apos;-&apos;) + 3 ) ;	
		//若為TGCE幫SGCE代填單，則寫入的工號第1碼改T  add by edison@20140527
		if(Factory_ID!=&quot;TGCE&quot; &amp;&amp; vApp_ID.length()&gt;=6){
			var memid = dataMap.get(&quot;Creator_ID&quot;);
			var member = Server.getMemberByID(memid);
			var areacode = member.getAreaCode();
			if(areacode==&quot;TGCE&quot;){
				vApp_ID = &quot;T&quot;+vApp_ID.substr(1,5);
			}
				
		}			
		try{		
			var Sql = &quot;select *from MQT_WINDCHILLM010_TEMP where gce_doc_sn = &apos;&quot;+vGCE_DOC_SN +&quot;&apos;&quot;;
			var vec = Server.SQLloadValue(Sql);
			if( vec.size()==0){
				var Sql = &quot;   INSERT INTO MQT_WINDCHILLM010_TEMP( item_no,gce_ver,ins_user,gce_doc_sn,ins_date,factory,mq_flag,status,mq_status ) &quot;;
					Sql = Sql + &quot;   VALUES ( &apos;&quot;+ vItem_no +&quot;&apos;,&apos;&quot;+vGCE_VER+&quot;&apos;,&apos;&quot;+vApp_ID+&quot;&apos;,&apos;&quot;+vGCE_DOC_SN+&quot;&apos;, sysdate ,&apos;&quot;+Factory_ID+&quot;&apos;,&apos;N&apos;,&apos;審核中&apos;,&apos;&quot;+vMQ_Status+&quot;&apos;)&quot;;		
					var vResult=Server.SQLinsertValue(Sql);
				}
		}catch(e){
		}
		finally {       
		}
}
// add by wangwei@2009/03/17
// 發料單發行時update
function UPD_MES_Material_Issue(vStatus,vFlag,vMq_Status){
		var aInstance = MyTask.getArtInstance();
		var dataMap = aInstance.getAppDataMap();	
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		var vGCE_DOC_SN = dataMap.get(&quot;GCE_Doc_Sn&quot;);
		var vApp_ID = dataMap.get(&quot;App_ID&quot;);
		var Sn = dataMap.get(&quot;Sn&quot;);
		var Factory = dataMap.get(&quot;Factory&quot;);
		var Factory_ID = dataMap.get(&quot;Factory&quot;).substring(1,5);	
		//若為TGCE幫SGCE、CGCE代填單，則寫入的工號第1碼改T  add by edison@20140527
		if(Factory_ID!=&quot;TGCE&quot; &amp;&amp; vApp_ID.length()&gt;=6){
			var memid = dataMap.get(&quot;Creator_ID&quot;);
			var member = Server.getMemberByID(memid);
			var areacode = member.getAreaCode();
			if(areacode==&quot;TGCE&quot;){
				vApp_ID = &quot;T&quot;+vApp_ID.substr(1,5);
			}
				
		}
		if(Sn.trim().length() &gt;= 9){         // add by wangwei@2010/10/04 作廢時可能找不到編號
			var vGCE_VER = Sn.trim().substring( Sn.trim().indexOf(&apos;-&apos;) + 1 , Sn.trim().indexOf(&apos;-&apos;) + 3 ) ;					
			try{				
			var Sql = &quot;   UPDATE MQT_WINDCHILLM010_TEMP &quot;
				Sql = Sql + &quot;  SET status = &apos;&quot;+vStatus+&quot;&apos;,upd_date=sysdate ,mq_flag =&apos;&quot;+vFlag+&quot;&apos;,mq_status =&apos;&quot;+vMq_Status+&quot;&apos;, upd_user=&apos;&quot;+vApp_ID+&quot;&apos; &quot;;
				Sql = Sql + &quot;    where  gce_doc_sn=&apos;&quot;+vGCE_DOC_SN+&quot;&apos;&quot;;
			var vResult=Server.SQLupdateValue(Sql);	
			}catch(e){
			}
			finally {       
			}
		}
}
//------------------------------------------------------------------------------------------------------------------------
function INS_MES_TEST(){
		//
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		var App_ID = dataMap.get(&quot;App_ID&quot;);
		var Sn = dataMap.get(&quot;Sn&quot;);
		var Factory = dataMap.get(&quot;Factory&quot;);
		var Factory_ID = &quot;&quot;;			
		var gce_ver = &quot;&quot;;				
		if( &quot;(GCE)&quot;== dataMap.get(&quot;Factory&quot;) )  {
			Factory_ID = &quot;30&quot;;
		}	
		if( &quot;(TGCE)&quot;== dataMap.get(&quot;Factory&quot;) )  {
			Factory_ID = &quot;30&quot;;
		}		
		if( &quot;(SGCE)&quot;== dataMap.get(&quot;Factory&quot;) )  {
			Factory_ID = &quot;174&quot;;
		}	
		if( &quot;(CGCE)&quot;== dataMap.get(&quot;Factory&quot;) )  {
			Factory_ID = &quot;114&quot;;
		}	
	   gce_ver = Sn.trim().substring( Sn.trim().indexOf(&apos;-&apos;) + 1 , Sn.trim().indexOf(&apos;-&apos;) + 3 ) ;
		dataMap.put(&quot;item_no_a&quot;,Sn.substring(0,9));
		dataMap.put(&quot;gce_ver_a&quot;,gce_ver);			
		try{
            var sql = &quot;INSERT INTO MQT_FILM120_TEMP &quot;+  
               &quot;(item_no,&quot;+
               &quot;mecn_no,&quot;+
               &quot;tran_yn,&quot;+
               &quot;ins_empno,&quot;+
               &quot;ins_dtime,gce_ver,MQ_STATUS,MQ_FLAG,ORG_ID )&quot;+
               &quot;VALUES ( &apos;&quot;+ Sn.substring(0,9) +&quot;&apos;,&quot;+
               &quot;&apos;&quot; + Sn + &quot;&apos;,&quot;+
               &quot;&apos;N&apos;,&quot;+
               &quot;&apos;&quot; + App_ID + &quot;&apos;,&quot;+
               &quot;sysdate,&apos;&quot;+gce_ver+&quot;&apos;,&apos;I&apos;,&apos;N&apos;, &quot;+Factory_ID+&quot; )  &quot;;		
			   Server.SQLupdateValue(sql);

		}catch(e){

		}
		finally {       

		}

}		

//寫入 MES ECN連結 //201011011 irene_chang 目前無使用
function insert_MES_ECN_Link(){
	
 	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	
	var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);
    //抓取BPM 短期資料庫連線
    loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
    var conn = Server.createSessionConnection(conn_name);	
	
	var Sn = dataMap.get(&quot;Sn&quot;);
	var Subject = dataMap.get(&quot;ITEM200&quot;);
	var doc_id = dataMap.get(&quot;ITEM248&quot;);
	
	if(dataMap.get(&quot;ITEM266&quot;) == &quot;true&quot;){
	   var v_status =&quot;個別&quot;;
	}else if(dataMap.get(&quot;ITEM267&quot;) == &quot;true&quot;){
		var v_status =&quot;系別&quot;;
	}else{
	   var v_status =&quot;&quot;;
	}
	
	var sql_ekm =&quot;select max(ver_id) ver_id from ekm.techdoc_version where type_id=&apos;PDM&apos; and doc_id=&apos;&quot;+ doc_id +&quot;&apos;&quot;;
	var vec_ekm = Server.SQLloadValue(sql_ekm);
	if( vec_ekm.size()&gt;0){
		var ver_id= vec_ekm.get(0).get(&quot;ver_id&quot;);
	    var ecn_link =	&quot;http://bpmdev/eip/techdoc/Tech_pdm_read.jsp?doc_id=&quot; + doc_id + &quot;&amp;ver_id =&quot;+ ver_id +&quot;&amp;pdm=pdm&quot;;
    }
	try{
	       var Sql = &quot;INSERT INTO mis.MANQ010C_ECN(ECN_No,Subject,Factory,Create_Date,BPM_Link,Status)VALUES ( &apos;&quot;+ Sn +&quot;&apos;,&apos;&quot;+ Subject +&quot;&apos;,&apos;&quot;+ v_factory +&quot;&apos;,current,&apos;&quot;+ ecn_link +&quot;&apos;,&apos;&quot; + v_status +&quot;&apos;);&quot;;		
		   var vResult=conn.updateValue(Sql);

		if(vResult==&quot;true&quot;){
		   conn.commit();
		   Server.addInfoLog(&quot;Connection insert successful.&quot;);//確認有執行connection關閉動作
		}else{
		   conn.rollback();  
		   Server.addInfoLog(&quot;Connection insert fail.&quot;);//確認有執行connection關閉動作
		}   
		
	}catch(e){
		conn.rollback();  
	}
	finally { 
		conn.close();  // move here by wangwei@2011/06/27
	}   
  				 

}

//寫入 Gerber 寫入對應的金像料號
function Gerber_Item_no(){

 	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	
	var v_test_item_no = dataMap.get(&quot;Test_item_no&quot;);
	var v_test_item_ver = dataMap.get(&quot;Test_item_ver&quot;);	
	var v_erp_item_no = dataMap.get(&quot;ERP-GCE-item-no&quot;);	
	
	var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);
	var fileList = new Packages.java.util.Vector(); 
	
    try{	
        //抓取BPM 短期資料庫連線
        loadLibrary(&quot;com.gce.Common.Util&quot;);
	    var conn_name = conn_db(v_factory,&quot;MES&quot;);	
        var conn = Server.createSessionConnection(conn_name);

	    var sql =&quot;select item_no,gce_ver from mis.manm010_plan where item_no =&apos;&quot;+ v_test_item_no +&quot;&apos; and gce_ver=&apos;&quot;+ v_test_item_ver +&quot;&apos;;&quot;;
        var rs1 = conn.loadValue(sql);

        if (rs1.size()&gt;0){
	        var sql =&quot;update mis.manm010_plan set ref_item_no =&apos;&quot;+ v_erp_item_no +&quot;&apos; where item_no =&apos;&quot;+ v_test_item_no +&quot;&apos; and gce_ver=&apos;&quot;+ v_test_item_ver +&quot;&apos;;&quot;;
	        var vec1 = conn.updateValue(sql);
            if(vec1!=true){
	           conn.rollback();  
			   var subject =&quot;update gerber error :&quot;+ dataMap.get(&quot;Sn&quot;) +&quot; mis.manm010_plan fail&quot;;
			   var text = sql;
			   Server.sendHTMLMailExt(&quot;MyGCE@gce.com.tw&quot;,&quot;edison_wang@gce.com.tw&quot;,&quot;&quot;,subject,text,fileList,MyTask); 
           }else{
			   conn.commit();  
			   }
	   }
	   
	   var sql = &quot;select item_no,gce_ver from mis.mpsm250 where item_no =&apos;&quot;+ v_test_item_no +&quot;&apos; and gce_ver=&apos;&quot;+ v_test_item_ver +&quot;&apos; and status not in(&apos;E&apos;,&apos;X&apos;,&apos;D&apos;);&quot;;
        var rs = conn.loadValue(sql);
	    if (rs.size()&gt;0){
	        var sql =&quot;update mis.mpsm250 set cdr_item_no =&apos;&quot;+ v_erp_item_no +&quot;&apos; where item_no =&apos;&quot;+ v_test_item_no +&quot;&apos; and gce_ver=&apos;&quot;+ v_test_item_ver +&quot;&apos; and status not in(&apos;E&apos;,&apos;X&apos;,&apos;D&apos;);&quot;;
	        var vec = conn.updateValue(sql);		  
		    if(vec!=true){
	           conn.rollback();  
			   var subject =&quot;update gerber error :&quot;+ dataMap.get(&quot;Sn&quot;) +&quot; mis.mpsm250 fail&quot;;
			   var text = sql;
			   Server.sendHTMLMailExt(&quot;MyGCE@gce.com.tw&quot;,&quot;edison_wang@gce.com.tw&quot;,&quot;&quot;,subject,text,fileList,MyTask); 			 
           }else{
			   conn.commit();  
		   }
	   }
	   
     }catch(e){
		conn.rollback(); 
		java.lang.System.out.println(&quot;expection in informixDB e=&quot;+e);
		var subject =&quot;Gerber_Item_no error:&quot;+ e + &quot;gerber_no:&quot;+ dataMap.get(&quot;Sn&quot;);
		var text = sql;
		Server.sendHTMLMailExt(&quot;MyGCE@gce.com.tw&quot;,&quot;edison_wang@gce.com.tw&quot;,&quot;&quot;,subject,text,fileList,MyTask); 
	}finally {
		conn.close(); 
  	} 
}//function Gerber_Item_no()
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00131250755035107</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2016/03/07 09:15:01</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Client.Util</string> 
     </void> 
     <void property="id"> 
      <string>SCL00131250755035107</string> 
     </void> 
     <void property="name"> 
      <string>Util</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00091250755035083</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//重載申請人
function updateApp(){
	var mID = Form.getValue(&quot;App_MemID&quot;);
	if(&quot;&quot;==mID){
		Client.addDebugLog(&quot;Call com.A.Common.Client.Util.updateApp() :App_MemID 空白&quot;);
		return ;		
	}
	var cMember = Client.getMember(mID);	
	//抓取使用者相關資料
	var sUserName = cMember.getName();
	var roleID = cMember.getMainRoleID();
	var memDR = cMember.getMemberDR(roleID);
	var sDepName = memDR.getDepartmentName();	//使用者部門名稱
	var sDepID = Client.getDepartment(memDR.getDepartmentID()).getMyID();	
	var sRoleName = memDR.getRoleName();	//使用者職務名稱
		//設定申請人姓名、員工編號
		Form.setValue(&quot;App_ID&quot;,cMember.getMyID());
		Form.setValue(&quot;App_Tel&quot;,cMember.getOfficePhone());
		//Form.setValue(&quot;From_User_ID&quot;,cMember.getID());
		//Form.setValue(&quot;From_User_RoleID&quot;,roleID);

		//設定申請部門及申請人職稱					
		Form.setValue(&quot;App_Dep&quot;,sDepName);
		Form.setValue(&quot;App_Dep_ID&quot;,sDepID);	
		Form.setValue(&quot;App_DepID&quot;,memDR.getDepartmentID());
		//Form.setValue(&quot;App_Title&quot;,sRoleName);
		Form.setValue(&quot;App_Title&quot;,cMember.getJobTitle());
		//Form.setValue(&quot;App_Email&quot;,cMember.getEmail());
}
	
	
function checkValueIsDouble(tablename,keyname,ID){
		var flg = false;
		var sql_check = &quot;select &quot;+ keyname +&quot; from &quot;+ tablename +&quot; where &quot;+ keyname +&quot;=&quot;+ ID ;
		var vec_check = Client.SQLloadValue(sql_check);
		if(vec_check.size()&gt;0){
			flg = true;			
		}
		return flg;
	}
	

//用在查詢表單
function createAPForm(artid,h,w){
		//寫在母表單的按鈕上
		//用舊的 ins 會開不起來 20061013 cc
   		if (!&quot;&quot;.equals(artid)){
  
		      var artIns = Client.createArtInstance(artid);
		      var artInsID = artIns.getID();

		//createForm(java.lang.String artInsID, java.lang.String stateName, boolean bRunScript, boolean bSave, boolean print, int close, int x, int y, int width, int height) 
		var panel = Client.createForm(artInsID.toString(),&quot;CreateForm&quot;,true,false,true,0,10,10, h,w) ; 
		//createFormExt(java.lang.String artInsID, java.lang.String stateName, boolean isRunScript, boolean canSave, boolean canPrint, boolean canReviewProcess) 
		//	Client.createFormExt(artInsID.toString(),&quot;CreateForm&quot;,true,false,true,true);
		}
}

//用在表單上開子視窗
function createAPFormExt(artid,h,w,forprint){
		//寫在母表單的按鈕上
		//開啟唯一一張表單,沒有就新產生一張//ART00051102931547837
		//用舊的 ins 會開不起來 20061013 cc
   		if (!&quot;&quot;.equals(artid)){	    
		      var artIns = Client.createArtInstance(artid);	
			  var artInsID = artIns.getID();
		//	  Client.createFormExt(artInsID.toString(),&quot;CreateForm&quot;,true,false,true,true);
		//createForm(java.lang.String artInsID, java.lang.String stateName, boolean bRunScript, boolean bSave, boolean print, int close, int x, int y, int width, int height) 
		var panel = Client.createForm(artInsID.toString(),&quot;CreateForm&quot;,true,false,forprint,0,10,10, h,w) ; 
		}
}
//取得 keyValue
function getKeyValue(table_name,key_name,key_item_name,key_value,key2_item_name,key2_value){
	var keyvalue =&quot;&quot;;
	var sql_key = &quot; select &quot; + key_name  + &quot; from &quot;+ table_name +&quot; where &quot;+ key_item_name +&quot;=&apos;&quot;+ key_value +&quot;&apos; and &quot; + key2_item_name +&quot;=&apos;&quot;+ key2_value +&quot;&apos;&quot;;
	var vector_ver = Client.SQLloadValue(sql_key);
	if(vector_ver.size()&gt;0 &amp;&amp; vector_ver.get(0).get(key_name) != &quot;&quot; ){
		keyvalue = vector_ver.get(0).get(key_name);
	}
	return keyvalue;
}

//取得部門名稱 by 員工姓名或員工ID	20060815
function getDepName(id){
	var sDepName = &quot;&quot;;
	var cMember = Client.getMemberByName(id);	
	var sUserName = cMember.getName();	//使用者姓名
	var roleID = cMember.getMainRoleID();
	var memDR = cMember.getMemberDR(roleID);
	var sDepName = memDR.getDepartmentName();	//使用者部門名稱
	return sDepName;
}		

function getYN(s1){
	if(&quot;true&quot;.equals(s1)){
		return &quot;Y&quot;;
	}
	return &quot;N&quot;;
}

function getTrueFalse(s1){
	if(&quot;Y&quot;.equals(s1)){
		return true;
	}
	return false;
}

function getFormatedCurrentTime(format){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(format);
        return simpledateformat.format(date);
}

function setCombox(component_name,sql){
		var comboxitem = Form.getComponent(component_name);
		var c_value = Form.getValue(component_name);
		var dataVector = Client.SQLloadValue(sql);
		comboxitem.removeAllItems();
//		comboxitem.addItem(&quot;--請選擇--&quot;);
		for(var i=0;i&lt;dataVector.size();i++) {
			var item = dataVector.get(i).get(component_name);
			comboxitem.addItem(item);
		}
		if(&quot;&quot; != c_value){
			Form.setValue(component_name,c_value);
		}else if(dataVector.size()&gt;0){
			Form.setValue(component_name,dataVector.get(0).get(component_name));	
		}

	}//function
	
	
/**
	20080423
	修改保留預設值的寫法
*/
function setCombox_2(component_name,sql){
		var comboxitem = Form.getComponent(component_name);
		var c_value = Form.getValue(component_name);
		var dataVector = Client.SQLloadValue(sql);
		//addItemVectorWithPls(comboxitem,component_name,dataVector);
		comboxitem.removeAllItems();
//		comboxitem.addItem(&quot;--請選擇--&quot;);
		for(var i=0;i&lt;dataVector.size();i++) {
			var item = dataVector.get(i).get(component_name);
			comboxitem.addItem(item);
		}
		if(&quot;&quot; != c_value){
			Form.setValue(component_name,c_value);
		}else if(dataVector.size()&gt;0){
			Form.setValue(component_name,dataVector.get(0).get(component_name));	
		}

	}//function
	
	
 function addItemVector(comp,itemName,dataVector) {
  comp.removeAllItems();
  //comp.addItem(&quot;--請選擇--&quot;);
  for(var i=0;i&lt;dataVector.size();i++) {
	  var dataRow = dataVector.elementAt(i);
	  var item = dataRow.get(itemName);
	  comp.addItem(item);
  }
  if(dataVector.size()&gt;0){Form.setValue(comp.getName(),dataVector.get(0).get(itemName))};
 }//function

 
 
function getSubString(str,s){
	if(str.length()&gt;1){
		if(&quot;b&quot;.equals(s)){
			str = str.substring(str.lastIndexOf(&apos;-&apos;)+1); //後
		}else{
			str = str.substring(0,str.lastIndexOf(&apos;_&apos;)); //前
		}
	}
	return str;
}

//========================================================================================
// 應用程式之查詢共用 取得流程的狀態
//========================================================================================
function getEipStatus(insid){
		var EIPstatus =&quot;&quot;;
		instance = Client.getArtInstance(insid) ;
		if (instance != null){
			EIPstatus = instance.getArtState().getName();

			if (EIPstatus.equals(&quot;初始化&quot;)){
				EIPstatus = &quot;填寫中&quot;;
			}else if(EIPstatus.equals(&quot;填寫完畢&quot;)){
				EIPstatus = &quot;主管審核中&quot;;
			}
			var task = getTaskByInsID(insid);
			var parentTask = Client.getTask(task.getParentID());
			if (&quot;signing&quot;.equals(parentTask.getTaskState())){   	// 會簽
				//var type = parentTask.getAddASType();
				//if (type.equals(&quot;AddParallelAnnounce&quot;)){			// 分會
					EIPstatus = &quot;會簽中&quot;;
				//}
			}
			var memNameString = getUnsignMemName(task);
			if (&quot;&quot;.equals(memNameString)){
				var l_member = Client.getMemberByID(task.getRealExecutor());
				memNameString = l_member.getName();
			}
		}
		EIPstatus = &quot;[&quot; + memNameString + &quot;]&quot; + EIPstatus;
		return EIPstatus;
}		



//========================================================================================
// 取得應用程式之查詢共用條件的SQL
//========================================================================================
function getTaskByInsID(InsID){
	var task = null;
	var vecTask = Client.SQLloadValue(&quot;select max(tskid) taskid from task_artins where insid =&apos;&quot;+ InsID +&quot;&apos;&quot;);
	if(vecTask.get(0).get(&quot;taskid&quot;) != null ){
		task = Client.getTask(vecTask.get(0).get(&quot;taskid&quot;));
	}
	return task;
}

//========================================================================================
//  取得動態加會簽節點Task物件的尚未簽核的姓名
//========================================================================================
function getUnsignMemName(task){
	var memNames = &quot;&quot;;
	var parentTask = Client.getTask(task.getParentID());
	if (&quot;signing&quot;.equals(parentTask.getTaskState())){   	// 會簽
		var type = parentTask.getAddASType();
		if (type.equals(&quot;AddParallelAnnounce&quot;)){			// 分會
			//取得所有分會出去的Task list
			var taskList = Client.getSubTaskList(parentTask.getID());
			//判斷分會Task完成數目
			for (var i = 0; i &lt; taskList.size(); i++) {
				var task = taskList.get(i);
				if(task.getTaskState().equals(&quot;complete&quot;) || task.getTaskState().equals(&quot;running&quot;) || task.getTaskState().equals(&quot;retrieved&quot;) ) {
					continue;
				} else {
					var memID = task.getRealExecutor();
					var memberRecord = Client.getMemberByID(memID);
					memNames = memNames + memberRecord.getName() + &quot;,&quot;; 
				}
			}
		}
	}
	var memNameString  = new java.lang.String(memNames);
	var len = memNameString.length();
	if (len&gt;0){
		memNameString = memNameString.substring(0,len-1);
	}	
	return memNameString;
}

//========================================================================================
//  取得動態加會簽節點Task物件的尚未簽核的姓名 
// add by wangwei@2007/04/07 copy from getUnsignMemName
// 會簽關卡未簽核人員
//========================================================================================
function getUnsignMemNameExt(task){
	var memNames = &quot;&quot;;
	var vTaskID = task.getID(); // 取得ID
	var parentTask = Client.getTask(task.getParentID());
	var vProID =	task.getProcessID();  // SNGXXXXXXXXX
	var taskList = Client.getSubTaskList(parentTask.getID());
			if(&quot;SGN&quot;==vProID.substring(0,3) || &quot;PRO&quot;==vProID.substring(0,3) ){
				for(var i=0;i&lt;taskList.size();i++){
				  var subtask = taskList.get(i);  
				  var subproid =subtask.getProcessID();	
							if(vProID.equals(subproid)){
								 if( !subtask.getTaskState().equals(&quot;complete&quot;) &amp;&amp; !subtask.getTaskState().equals(&quot;retrieved&quot;)){
								 		var vExeMemID = subtask.getRealExecutor();							
										var memberRecord = Client.getMemberByID(vExeMemID);								 		
								 				memNames = memNames + memberRecord.getName() + &quot;,&quot;; 
								}
							}				  
				} // end for
			}
	var memNameString  = new java.lang.String(memNames);
	var len = memNameString.length();
	if (len&gt;0){
		memNameString = memNameString.substring(0,len-1);
	}	
	return memNameString;
}
//========================================================================================
// 取得直屬主管並將值放入下拉的物件中 
// memidObj: 表單上要檔做查詢的欄位
// combObj: 下拉物件名稱
// Add by wangwei@2010/11/19
//========================================================================================
function setReportTo(memidObj,combObj){
	var comboBox = Form.getComponent(combObj);
		comboBox.removeAllItems();
	var vApp_MemID = Form.getValue(memidObj); // 申請人		
	var vMEM = Client.getMember(vApp_MemID);
	var roleID = vMEM.getMainRoleID();	
	var memDR = vMEM.getMemberDR(roleID);
	var vApp_DepID = memDR.getDepartmentID() ;// .getMyID();
	var mbrLv = Client.getRole(vMEM.getMainRoleID()).getMyID();//申請者職等
	while ( mbrLv &lt; &apos;180&apos;  ){
		 var vManager = getManagerExt(vApp_MemID,vApp_DepID) ;
			 mbrLv = Client.getRole(vManager.getMainRoleID()).getMyID();
		 var vItem = mbrLv + &quot;-&quot;+ vManager.getName();
			 comboBox.addItem(vItem);
			 vApp_MemID = vManager.getID();
	 }	
	comboBox.setVisible(true);
}

// 有主管下屬有兩個單位,且直屬主管也有兩位	add by wangwei@2009/02/25
// 這function 是用在Client Script
function getManagerExt(memid,vDept){
		var mem = Client.getMember(memid);
		var managerMemID = &quot;Administrator&quot;;
		if(mem != null){
			managerMemID = mem.getPager();
		}			
// 再select  設定檔		
	    var sql = &quot; select trim(value1) as pager from a_parameter_data where parameter = &apos;MUTIL_DEPARTMENT&apos; and key1 = &apos;&quot;+memid+&quot;&apos; and  value2 = &apos;&quot;+vDept+&quot;&apos;&quot;  ;
		var vector = Client.SQLloadValue(sql);				
			if ( vector != null ){
				if (vector.size()&gt;0){
					managerMemID = vector.get(0).get(&quot;pager&quot;);
				}
			}	
		var manager = Client.getMember(managerMemID);
		return manager;
	}

//=========================================
//簽核歷程表格加入一筆
//Pulls out the list
//=========================================	
function appendProcessTable_POL(ProcessName,rootid,realExecutorMemID){
	//取得 rootid 最後一個Task
	var sql_task = &quot;  select max(tskid) tskid from task where tskid != rootid and rootid =&apos;&quot;+ rootid +&quot;&apos; and state != &apos;complete&apos;  &quot;;
	var vec_task = Client.SQLloadValue(sql_task);
	if(vec_task != null &amp;&amp; vec_task.size()&gt;0 &amp;&amp; vec_task.get(0).get(&quot;tskid&quot;)!= &quot;&quot;){
		var  finil_tsk= Client.getTask(vec_task.get(0).get(&quot;tskid&quot;));
	}
		var instance = finil_tsk.getArtInstance();
		if(instance != null){
			var formDataMap = instance.getAppDataMap();
			var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
			var rowCount = vecTableData.size();//vecTableData裡資料筆數	
			var name = instance.getAppValue(&quot;Verify_Name&quot;);
			var member = Client.getMemberByCName(name);
			var id = member.getMyID();
			var vApp_Name = instance.getAppValue(&quot;App_Name&quot;);  // add by wangwei 2008/05/27 
			var depid = finil_tsk.getDepartmentID();
			var dep = Client.getDepartment(depid);
			var department = &quot;x&quot;;
			if(dep != null){
				department = dep.getName();		
			}
			var rMember = Client.getMember(realExecutorMemID); //執行者
			var roleTitle = rMember.getJobTitle();
			var hm = java.util.HashMap();   
				hm.put(&quot;ITEM8&quot;,ProcessName);//Process Name 關卡名稱
				hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
				hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;));//簽核時間
				hm.put(&quot;ITEM6&quot;, department);//Department 部門
				hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
				hm.put(&quot;ITEM2&quot;, id);//ID 工號	
				hm.put(&quot;ITEM4&quot;, name);//Name 姓名
			    hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
				hm.put(&quot;ITEM1&quot;, ProcessName);//Opinion 意見
				hm.put(&quot;ITEM10&quot;, finil_tsk.getID());	//TaskID	
				vecTableData.add(rowCount,hm);
				instance.setAppValue(&quot;Process_Table&quot;,vecTableData);
				Client.updateArtInstance(instance);
		}
						
}	

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00141102067408862</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/12/03 17:50:08</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.SystemFunction.WriteStatusList</string> 
     </void> 
     <void property="id"> 
      <string>SCL00141102067408862</string> 
     </void> 
     <void property="name"> 
      <string>WriteStatusList</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//寫入 StatusList 資料庫
function writeStatusList(content){
	var updater = new Packages.com.bcom.util.StatusList(Client,Form);
	updater.updateData(&quot;ECR&quot;,Form.getValue(&quot;cbProductName&quot;),Form.getValue(&quot;txtIssueNo&quot;), Form.getValue(&quot;taTopic&quot;), content);
}</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00141217475919273</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2013/03/22 16:40:39</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.dms.Server</string> 
     </void> 
     <void property="id"> 
      <string>SCL00141217475919273</string> 
     </void> 
     <void property="name"> 
      <string>Server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00351217475842115</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

loadLibrary(&quot;com.eland.dms.Config&quot;);
/**
 public class WorkflowFunctionConst {
    public static final String K_TC_STATUS_D  = &quot;D&quot;;  // Draft 草稿
	public static final String K_TC_STATUS_CI = &quot;CI&quot;; // Certifying 審核中
	public static final String K_TC_STATUS_C  = &quot;C&quot;;  // Certified 已發行
	public static final String K_TC_STATUS_A  = &quot;A&quot;;   //abolish 已廢止
	public static final String K_TC_STATUS_AI  = &quot;AI&quot;;   //abolish in progress 申請廢止中
	public static final String K_TC_STATUS_II  = &quot;II&quot;;   //set ideal doc in progress 申請為點範文件中
    // 以下為金像客製的文件狀態
    public static final String K_TC_STATUS_MA = &quot;MA&quot;;  //變更申請
    public static final String K_TC_STATUS_MW = &quot;MW&quot;;  //變更確認 
    public static final String K_TC_STATUS_MC = &quot;MC&quot;;  //變更取消
    public static final String K_TC_STATUS_AA = &quot;AA&quot;;  //作廢申請
    public static final String K_TC_STATUS_NC = &quot;NC&quot;;  //駁回
}
*/



	//PDM
	function DocStatus_pdm(status){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		// 不知何還要一段這個  -----------------------------------------------------------------------------------------------------------
		var conn = Server.createSessionConnection(&quot;EKM&quot;);		
		try{
			var sql = &quot;  select doc_id,max(ver_id) ver_id from ekm.TECHDOC_VERSION  where doc_id = &apos;&quot;+ doc_id +&quot;&apos; group by  doc_id &quot;;
			var vec = conn.loadValue(sql);
			if(vec != null &amp;&amp; vec.size()&gt;0){
				ver_id = vec.get(0).get(&quot;ver_id&quot;).trim() ;
				dataMap.put(&quot;Ver_ID&quot;,ver_id); 		
			}					
				
		}catch(e){
			Server.addErrLog(&quot;DocStatus_pdm Error:&quot;+sql ) ;
//			conn.rollback();                                         // mark by wangwei@2011/04/05 沒有 update 就不要rollback
		}finally{
			conn.close();	
		}
		if(conn != null){
			conn.close();
		}
		//------------------------------------------------------------------------------------------------------------------------------
		var ver_id = ver_id * 1 ;	
		var category_id = dataMap.get(&quot;Category_ID&quot;);
		var RealExecutorID = MyTask.getRealExecutor();
		var RealExecutor = Server.getMember(RealExecutorID);
		var account = &quot;eipadmin&quot;;
		if(RealExecutor != null){
			account = RealExecutor.getLoginID();
		}
		try{
			  var wfapi = new Packages.com.eland.ekm.api.workflow.WorkflowFunctionAPI(hostname);
			  var success = wfapi.setDocStatus(category_id,doc_id,ver_id,account,status); // public void setDocStatus(String categoryId, String docId, int verId, String account, String docStatus)
//			  java.lang.System.out.println(&quot;WorkflowFunctionAPI.hostname=[&quot;+ hostname + &quot;] set DccStatus [&quot;+ status +&quot;] success:[&quot; + success + &quot;]&quot;);
			//Server.addDebugLog(&quot;IT執行作廢status=&quot;+success);
		}catch(e){
			Server.addErrLog(&quot;Call WorkflowFunctionAPI Error&quot; );
		}
		chkState(doc_id,ver_id,status)      // ==add by wangwei@2012/04/09=====================
	}
	
	function updateDoc_pdm_cancel_status(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		try{
			var conn_ekm = Server.createSessionConnection(&quot;EKM&quot;);
			//所有版本狀態皆update
			var sql_ekm = &quot; update TECHDOC_VERSION set ver_delete =&apos;Y&apos; where doc_id= &apos;&quot;+ doc_id +&quot;&apos; &quot; ;
			var result = conn_ekm.updateValue(sql_ekm);	
				conn_ekm.commit();
		}catch(e){
			conn_ekm.rollback();
		}finally{
			conn_ekm.close();			
		}
	}	
	
	//PDM	
	function setTechDoc(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var rootTaskID = MyTask.getRootID();
		var ht = Server.getGlobals(rootTaskID); //{doc_id=1203563399578, category_id=1203513331265, ver_id=1}
		var doc_id = ht.get(&quot;doc_id&quot;).trim();
		var ver_id = ht.get(&quot;ver_id&quot;).trim();
		var category_id = ht.get(&quot;category_id&quot;).trim();
		dataMap.put(&quot;Doc_ID&quot;,doc_id);
		dataMap.put(&quot;Ver_ID&quot;,ver_id);
		dataMap.put(&quot;Category_ID&quot;,category_id);		
		dataMap.put(&quot;OVer_ID&quot;,ht.get(&quot;OVer_ID&quot;)); // 舊版 ver
		dataMap.put(&quot;Type&quot;,ht.get(&quot;ISO_depth3&quot;).trim()); // 型態
		dataMap.put(&quot;Category&quot;,ht.get(&quot;ISO_depth5&quot;).trim()); // 文件類別
		// 改用 api
		var conn = Server.createSessionConnection(&quot;EKM&quot;);		
		try{
			if(&quot;&quot; == ver_id){
				ver_id = ht.get(&quot;OVer_ID&quot;);
			}
			var sql = &quot; select c.Name,t.Name Type,v.*,g.G_name from TECHDOC_VERSION v,ELAND_CATEGORY c ,TECHDOC_TYPE t,EIP_GROUP g where v.CATEGORY_ID = c.CATEGORY_ID(+) and v.Type_ID = t.Type_ID(+) and v.reserve_dept = g.g_id(+) and doc_id = &apos;&quot; + doc_id + &quot;&apos; and ver_id = &apos;&quot;+ ver_id +&quot;&apos;&quot;;
			var vec = conn.loadValue(sql);
			if(vec != null &amp;&amp; vec.size()&gt;0){
				dataMap.put(&quot;Subject&quot;,vec.get(0).get(&quot;subject&quot;).trim());
				dataMap.put(&quot;Sub_Subject&quot;,vec.get(0).get(&quot;sub_subject&quot;).trim());				
				var creator_id = vec.get(0).get(&quot;Creator&quot;);
				dataMap.put(&quot;Doc_Creator_ID&quot;,creator_id);
				var doc_creator = Server.getMember(creator_id);
				if(doc_creator != null){
					dataMap.put(&quot;Doc_Creator&quot;,doc_creator.getName());
				}				
				dataMap.put(&quot;Type_ID&quot;,vec.get(0).get(&quot;Type_ID&quot;).trim());
				dataMap.put(&quot;Type&quot;,vec.get(0).get(&quot;Type&quot;).trim());
				//dataMap.put(&quot;Type&quot;,vec.get(0).get(&quot;Type&quot;)); 改由 Global 取 20080317
				var dept_id = vec.get(0).get(&quot;Dept&quot;);
				dataMap.put(&quot;Dept_ID&quot;,dept_id);
				var dept = Server.getDepartment(dept_id);
				if(dept != null){
					dataMap.put(&quot;Dept&quot;,dept.getName());
				}
				// dataMap.put(&quot;Category&quot;,vec.get(0).get(&quot;Name&quot;)); 改由 Global 取 20080317				
				dataMap.put(&quot;Description&quot;,vec.get(0).get(&quot;Description&quot;).trim());
				dataMap.put(&quot;Reserve_Year&quot;,vec.get(0).get(&quot;Reserve_Year&quot;).trim());	
				dataMap.put(&quot;Reserve_Dept&quot;,vec.get(0).get(&quot;G_name&quot;).trim());
				//PDM無最後更新日?
				dataMap.put(&quot;Doc_Create_Date&quot;,vec.get(0).get(&quot;Create_Date&quot;).trim());
				dataMap.put(&quot;GCE_Doc_Sn&quot;,vec.get(0).get(&quot;GCE_Doc_Sn&quot;).trim());
				dataMap.put(&quot;Sn&quot;,vec.get(0).get(&quot;GCE_Doc_Sn&quot;).trim());
				//PDM無版本?
				dataMap.put(&quot;GCE_Ver_Sn&quot;,vec.get(0).get(&quot;ver_id&quot;).trim());
			}			
			var url = &quot;http://&quot;+  hostname +   &quot;/eip/techdoc/Tech_pdm_read.jsp?doc_id=&quot;+ doc_id +&quot;&amp;codex=codex&quot;;
			var Index_URL = &quot;&lt;a href=&quot;+ url +&quot; target=_new &gt;文件檔案(請點選參閱附件)&lt;/a&gt;&quot;;
			//window.open(url, &quot;view&quot;,&quot;toolbar=no ,menubar=no, resizable=yes, scrollbars=yes, left=200, top=100, width=700, height=800, status=no&quot;);
			//var Index_URL = &quot;&lt;a href=&apos;javascript:openElandIndexCard(&quot;+ url +&quot;)&apos; &gt;開啟索引卡2&lt;/a&gt;&quot;; //隱藏URL
			dataMap.put(&quot;Index_URL&quot;,Index_URL); //設定索引卡 URL			
		}catch(e){
//			conn.rollback();                  // 沒有update eKM 不要rollback
			Server.addDebugLog(&quot;setTechDoc Fail:&quot; + sql);
		}finally{
			conn.close();
		}
		if(conn != null){
			conn.close();
		}
	}
	function updateDoc_af_status(status){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		var conn_ekm = Server.createSessionConnection(&quot;EKM&quot;);		
		try{
			var sql_ekm = &quot; update FIELD_DATA set COL_06 = &apos;&quot;+ status +&quot;&apos; where REF_ID_01= &apos;&quot;+ doc_id +&quot;&apos; &quot; ;  			//所有版本狀態皆update
//			Server.addDebugLog(&quot;更新文件狀態:&quot; + sql_ekm);
			var result = conn_ekm.updateValue(sql_ekm);	
			Server.addDebugLog(&quot;更新文件狀態(是否成功):&quot; + result + &quot;SQL:&quot;+sql_ekm);
			
			//檢查紀錄會簽子流程名單table,若無資料則代表不正常,mail通知系統負責人  
			//add by edison@20130322
			var process_name = MyTask.getProcessName();
			if( process_name.indexOf(&quot;等待&quot;)&gt;=0 ){
				var Assign_Table = dataMap.get(&quot;Assign_Table&quot;);
				var Assign_Table_G = dataMap.get(&quot;Assign_Table_G&quot;);
				if(Assign_Table!=null &amp;&amp; Assign_Table_G!=null &amp;&amp; (Assign_Table.size()==0 || Assign_Table_G.size()==0)){
				//if(true){	
					try{
						var aInstance = MyTask.getArtInstance(); 
						var dataMap = aInstance.getAppDataMap(); 
						var roottaskname = MyTask.getRootName();
						var from = Server.getMember(&quot;administrator&quot;).getEmail(); 					
						var to = &quot;edison_wang@gce.com.tw&quot;;
						var cc = &quot;&quot;;
						var subject = &quot;[PDM異常通知]&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot; 所申請-&quot; + roottaskname+&quot;(&quot;+process_name+&quot;)&quot; +&quot; 單號:&quot;+dataMap.get(&quot;Sn&quot;); // Mail Subject 
						var text = &quot;Assign_Table 沒資料!!&quot;;
						var fileList = new Packages.java.util.Vector(); 
						Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
					}catch(e){}
				}
			}
			
		}catch(e){
			conn_ekm.rollback();
		}finally{
			conn_ekm.commit();
			conn_ekm.close();			
		}
		if(conn_ekm != null){
			conn_ekm.close();
		}		
	}	
//-- 不使用短期資料庫,直接update  add by wangwei@2012/04/07
	function updateDoc_af_status_ext(status){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		var sql_ekm = &quot; update ekm.FIELD_DATA set COL_06 = &apos;&quot;+ status +&quot;&apos; where REF_ID_01= &apos;&quot;+ doc_id +&quot;&apos; &quot; ;
		try{
			var result = Server.SQLupdateValue(sql_ekm);		// 
			Server.addDebugLog(&quot;updateDoc_af_status_ext():&quot;+sql_ekm);
		}catch(e){
			Server.addDebugLog(&quot;更新文件狀態Fail:&quot; + sql_ekm);
		}finally{
		}
	}	

// 文件變更確認單核准之後要  update ezflow ISO文件 add by wangwei 2008/07/09
function setDSC(){
	return ;													// add by wangwei@2012/04/07 ezflow system no more use
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var GCE_Doc_Sn = dataMap.get(&quot;GCE_Doc_Sn&quot;); // 文件編號
	var mydate = new Packages.pase.agenda.MyDate();
	var todate = mydate.getCurrentDate(); 	
	try{		
		var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);
    	 loadLibrary(&quot;com.gce.Common.Util&quot;);
		 var conn_name = conn_db(v_factory,&quot;EZFlow&quot;);	   				    //抓取BPM 短期資料庫連線
		 var conn = Server.createSessionConnection(conn_name);				
		 var sql_iso = &quot;update isoeba set isoeba097=&apos;3&apos;,isoeba098=&apos;5&apos;,isoeba099=&apos;3&apos;,isoeba012= &apos;&quot;+ todate +&quot;&apos; where isoeba001 = &apos;&quot;+ GCE_Doc_Sn +&quot;&apos; and isoeba012=&apos;&apos;  &quot;;  // 004 是文件版本
		 var result = conn.updateValue(sql_iso);	
		 if(&quot;true&quot;==result){
			conn.commit();
		 }else{
			conn.rollback();				
		 }
	}catch(e){ 					
		
	}finally{
		conn.close();
	}
}


	//PDM
function setTechDocReject(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var rootTaskID = MyTask.getRootID();
		var doc_id = dataMap.get(&quot;Doc_ID&quot;);
		var ver_id = dataMap.get(&quot;Ver_ID&quot;);
		var STATUS = &quot;&quot; ;
		// 改用 sql		
		var sql = &quot;  select c.Name,t.Name Type,v.*,g.G_name  from TECHDOC_VERSION v,ELAND_CATEGORY c ,TECHDOC_TYPE t,EIP_GROUP g where v.CATEGORY_ID = c.CATEGORY_ID(+) and v.Type_ID = t.Type_ID(+) and v.reserve_dept = g.g_id(+) and ( doc_id,ver_id ) in ( select doc_id,max(ver_id) from ekm.TECHDOC_VERSION  where doc_id like &apos;&quot; + doc_id + &quot;&apos; group by  doc_id )&quot;;		
		var conn = Server.createSessionConnection(&quot;EKM&quot;);		
		try{			
			var vec = conn.loadValue(sql);
			if(vec != null &amp;&amp; vec.size()&gt;0){
				STATUS = vec.get(0).get(&quot;status&quot;).trim() ;
				ver_id = vec.get(0).get(&quot;ver_id&quot;).trim() ;
				var creator_id = vec.get(0).get(&quot;Creator&quot;);
				var SUB_SUBJECT = vec.get(0).get(&quot;sub_subject&quot;).trim() ;
				var SUBJECT = vec.get(0).get(&quot;subject&quot;).trim() ;
				dataMap.put(&quot;Ver_ID&quot;,ver_id); 
				dataMap.put(&quot;Sub_Subject&quot;,SUB_SUBJECT); 
				dataMap.put(&quot;Subject&quot;,SUBJECT); 
			}				
			loadLibrary(&quot;com.eland.dms.Config&quot;);
			var CheckOut = &quot;http://&quot;+  hostname +   &quot;/eip/techdoc/Tech_pdm_check.jsp?doc_id=&quot;+ doc_id +&quot;&amp;status=R&amp;codex=codex&quot;;
			var Index_CheckOut = &quot;&lt;a href=&quot;+ CheckOut +&quot; target=_new &gt;文件檔案(請點選修訂後入庫)&lt;/a&gt;&quot;;
			dataMap.put(&quot;Index_CheckOut&quot;,Index_CheckOut); //設定索引卡 URL
			conn.close();		
		}catch(e){
			Server.addErrLog(&quot;setTechDocReject Error:&quot;+sql );
		}finally{
			conn.close();
		}
		if(conn != null){
			conn.close();
		}
}

//=========================================
//清除兩張表格內memid相同的紀錄
//=========================================
function clearSameData(){
	var artIns = MyTask.getArtInstance();
	/*
		方法一:利用getAppDataMap()取得表單內所有dataMap資料後,再取得需比較的表格欄位
	*/
	var formDataMap = artIns.getAppDataMap();
	var master = formDataMap.get(&quot;Master&quot;);// 取得table Master的內容
	var slave = formDataMap.get(&quot;Slave&quot;);// 取得table Slave的內容
	/*
		方法二:利用資料庫查詢取得表格內容
	*/
	//var artID = artIns.getArtifactID();// 取得表單ID
	//var insID = artIns.getID();// 取得表單的instanceID,通常啟動一個流程會有一個insID
	//var sql = &amp;quot;SELECT * FROM &amp;quot;+artID+&amp;quot;ITEM2 Where INSID=&amp;apos;&amp;quot;+insID+&amp;quot;&amp;apos;&amp;quot;;// 取得table Master的內容
	//var master = Server.SQLloadValue(sql);// 取得table Master的內容
	//sql = &amp;quot;SELECT * FROM &amp;quot;+artID+&amp;quot;ITEM3 Where INSID=&amp;apos;&amp;quot;+insID+&amp;quot;&amp;apos;&amp;quot;;// 取得table Slave的內容
	//var slave = Server.SQLloadValue(sql);// 取得table Slave的內容
	if(master.size()&gt;0&amp;&amp;slave.size()&gt;0){// 只有在兩個table都有值才要做比對
		var newVector = new java.util.Vector();
		for(var i=0;i&lt;slave.size();i++){
			var slaveRowDate = slave.get(i);
			var isR = false;// 以此判斷是否要留Slave的內容
			for(var j=0;j&lt;master.size();j++){			
				var masterRowData = master.get(j);			
				var masterMemid = masterRowData.get(&quot;ITEM1&quot;);
				var slaveMemid = slaveRowDate.get(&quot;ITEM1&quot;);			
				if(masterMemid==slaveMemid||masterMemid.equals(slaveMemid)){// memid相等時,isR=true,代表重複
					//java.lang.System.out.println(&amp;quot;masterMemid=&amp;quot;+masterMemid);
					//java.lang.System.out.println(&amp;quot;slaveMemid=&amp;quot;+slaveMemid);
					isR=true;// 重複
					break;
				}		
			}
			if(!isR){// 不重複就是要留的
				var slaveMemid = slaveRowDate.get(&quot;ITEM1&quot;);
				var slaveCname = slaveRowDate.get(&quot;ITEM2&quot;);
				var newHashMap = new java.util.HashMap();
				newHashMap.put(&quot;ITEM1&quot;,slaveMemid);
				newHashMap.put(&quot;ITEM2&quot;,slaveCname);
				newVector.add(newHashMap);
			}
		}	
		artIns.setAppValue(&quot;Slave&quot;,newVector);// 設定值回表單上的Slave
		Server.updateArtInstance(artIns);// 表單刷新
	}
}

//=========================================
//更新AF的相關表單的狀態()
//=========================================	
	function updateDoc_pdm_af(){	
		try{
			var artIns = MyTask.getArtInstance();
			var dataMap = artIns.getAppDataMap();
			var Sn = dataMap.get(&quot;Sn&quot;);
			var Ins_ID = dataMap.get(&quot;Ins_ID&quot;);		
			var ECR_Ins_ID = dataMap.get(&quot;ECR_Ins_ID&quot;);			
			var vIns  = Server.getArtInstance(ECR_Ins_ID); // ECR
			var dataMapApply = vIns.getAppDataMap(); 
			var temp1 = dataMapApply.get(&quot;cus_data_ins_id&quot;); 
			var temp2 = dataMapApply.get(&quot;item_no_a&quot;); 
			dataMapApply.put(&quot;gerber_no&quot;,Sn);	
			dataMapApply.put(&quot;cus_data_ins_id&quot;,Ins_ID);		
			Server.updateArtInstance(vIns); 
			if(Sn !=&quot;&quot; &amp;&amp; Ins_ID !=&quot;&quot;){
			dataMap.put(&quot;ECR_Up_Flag&quot;,&quot;true&quot; + Sn + Ins_ID);
			}else{dataMap.put(&quot;ECR_Up_Flag&quot;,&quot;flase1&quot;);}
		}catch(e){
			Server.addDebugLog(&quot;由客戶資料簽收單Update ECR失敗!&quot;);
			dataMap.put(&quot;ECR_Up_Flag&quot;,&quot;flase&quot;);
		}		

	}
	
//=========================================
//更新AF的相關表單的狀態()
//=========================================	
function check_FLOWTYPE(temp){	
   var artIns = MyTask.getArtInstance();
   var dataMap = artIns.getAppDataMap();	
   var FLOWTYPE=dataMap.get(&quot;FLOWTYPE&quot;).substring(0,2); 

       if(FLOWTYPE.equals(&quot;A類&quot;) || FLOWTYPE.equals(&quot;B類&quot;) || FLOWTYPE.equals(&quot;D類&quot;)){
          var FLOWTYPE = FLOWTYPE ;
	   }else{
	      var FLOWTYPE = FLOWTYPE + &quot;類&quot; ;
	   }
	   if (temp == &quot;Y&quot;){
	   	   loadLibrary(&quot;com.A.Common.Server.Process&quot;);
           initPostAction_Detail(&quot;App_Name&quot;,&quot;-&quot;+FLOWTYPE+&quot;-&quot;,&quot;Subject&quot;,&quot;Sn&quot;);	
	   }else{
	   	  return  FLOWTYPE ;
	   }
}
// 檢查文件狀態是否一致  add by wangwei@2012/04/09
// 因call eKM API 可能有錯
function chkState(vDocID,vVerId,vStatus){
	try{
		var vSQL = &quot;select status from ekm.techdoc_version where DOC_ID = &apos;&quot;+vDocID+&quot;&apos; and VER_ID = &apos;&quot;+ vVerId +&quot;&apos;&quot;;		
		var vec = Server.SQLloadValue(vSQL);
		if(vec != null &amp;&amp; vec.size()&gt;0){
			var vOrgStatus = vec.get(0).get(&quot;status&quot;).trim() ;
			if(vStatus!=vOrgStatus){
				var vSQL = &quot; update ekm.techdoc_version set status = &apos;&quot;+ vStatus +&quot;&apos; where DOC_ID = &apos;&quot;+vDocID+&quot;&apos; and VER_ID = &apos;&quot;+ vVerId +&quot;&apos;&quot;;
				var result = Server.SQLupdateValue(vSQL);		// 
				Server.addDebugLog(&quot; call com.gce.PLM.Common.dms.Server.chkState原status:&quot;+vOrgStatus +&quot;update :&quot;+vStatus +vSQL );
			}
		}
	}catch(e){
		Server.addDebugLog(&quot;call chkState() fail &quot; );
	}
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>帶ekm文件資料及回寫ekm文件狀態等 For PLM</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00141250755035110</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/11/17 11:41:34</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Server.AddASAudit</string> 
     </void> 
     <void property="id"> 
      <string>SCL00141250755035110</string> 
     </void> 
     <void property="name"> 
      <string>AddASAudit</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00101250755035086</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

//設定會簽人員 from table
function addAddASAudit(sign_table,itemid){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var vac = dataMap.get(sign_table);
	if(vac.size()&gt;0){
		MyTask.setExecuteAddAS(true);
		MyTask.setAddASType(MyTask.ADD_PARALLEL_ANNOUNCE);
		//MyTask.addAddASAudit(&quot;MEM01619&quot;,&quot;ROLH010ACF&quot;,&quot;DEPH010A&quot;);
        for(var i = 0;i&lt; vac.size();i++){
           try{
			   var username = vac.get(i).get(itemid);
               var member = Server.getMember(username);
               if(member != null){
				   var roleid = member.getMainRoleID();
                   if(roleid == &apos;&apos;){
					   var rolelist = member.getRoleList()
					   if(rolelist.size()&gt;0){
						   roleid = rolelist.get(0);
					   }
                    }
				  var memberdr = member.getMemberDR(roleid);
				  var depid = memberdr.getDepartmentID();
                  MyTask.addAddASAudit(member.getID(),roleid ,depid);
                  }
		    }catch(e){}
		}
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00151102067455440</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ComponentFunction.TableFunction</string> 
     </void> 
     <void property="id"> 
      <string>SCL00151102067455440</string> 
     </void> 
     <void property="name"> 
      <string>TableFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041102066155330</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//傳入表格, 第幾欄, 欄位值
//傳回該值所在的 row,若有重複會傳回第一列
function indexOfTableRow(table, col, value){
	for(var i = 0; i &lt; table.getRowCount();i++){
		var cellValue = table.getValueAt(i , col);
		if(cellValue.equals(value))
			return i;
	}
	
	return -1;
}
//傳入表格, 第幾欄, 欄位值
//傳回該值所在的 row,若有重複會傳回最後一列
function lastIndexOfTableRow(table, col, value){
	for(var i = table.getRowCount() - 1; i &gt;= 0 ;i--){
		var cellValue = table.getValueAt(i , col);
		if(cellValue.equals(value))
			return i;
	}
	
	return -1;
}
//插入表格列
function insertTableRow(table, row, dataVector){
/*
	var dataList = table.getRowList();
	if(row &lt; dataList.size()-1)
		dataList.insertElementAt(dataVector, row);
	else
		dataList.add(dataVector);
*/
	var columnCount = table.getColumnNodeVector().size();
	//先抓最後一列的 Index (不含空白列)
	var lastRow = table.getRowCount() - 1 - 1;		
	//將所有資料往下移
	for(var i = lastRow; i &gt;= row; i--){
		for(var j = 0; j &lt; columnCount; j++){
			var value = table.getValueAt(i, j);
			table.setValueAt(value, i+1, j);
		}
	}
	//插入指定列的資料
	for(var col = 0; col &lt; dataVector.size(); col++)
		table.setValueAt(dataVector.get(col), row, col);


}
//刪除表格列
function deleteTableRow(objTableName){
	var tableList = Form.getComponent(objTableName.toString());
	var theRow = tableList.getSelectedRow();

	if(theRow &gt;= 0){
		var rowList = tableList.getRowList();
		if(theRow &lt; rowList.size())
			rowList.remove(theRow);
		
		tableList.setRowList(rowList);
		reBuildTableSN(tableList);
		//tableList.removeSelection();
	}	
}
//刪除表格列並將金額還原
function deleteTableRowRollBack(objTableName,objComponentName,objTableColName){
	var tableList = Form.getComponent(objTableName.toString());
	var theRow = tableList.getSelectedRow();

	 java.lang.System.out.println(&quot;theRow index &quot;+theRow.toString());
	
	if(theRow &gt;= 0){
		var rowList = tableList.getRowList();
		if(theRow &lt; rowList.size()){
			var rollbackAmount = tableList.getValueAt(theRow,objTableColName.toString());
			var totalAmount = java.lang.Integer.parseInt(Form.getValue(objComponentName.toString())) - java.lang.Integer.parseInt(rollbackAmount.toString());
			Form.setValue(objComponentName.toString(),new java.lang.Integer(totalAmount)); 			
			rowList.remove(theRow);
		}	
		tableList.setRowList(rowList);
		reBuildTableSN(tableList);
		//tableList.removeSelection();
	}	
}
function deleteTableRowRollBackByCurrency(objTableName,objComponentName,objTableColName,Currency){
	var tableList = Form.getComponent(objTableName.toString());
	var theRow = tableList.getSelectedRow();
	var totalAmount = 0;
	
	 java.lang.System.out.println(&quot;theRow index &quot;+theRow.toString());
	
	if(theRow &gt;= 0){
		var rowList = tableList.getRowList();
		if(theRow &lt; rowList.size()){
			var rollbackAmount = tableList.getValueAt(theRow,objTableColName.toString());
			if(tableList.getValueAt(theRow,&quot;幣別&quot;).equals(&quot;台幣&quot;))
				totalAmount = java.lang.Integer.parseInt(Form.getValue(objComponentName.toString())) - java.lang.Integer.parseInt(rollbackAmount.toString());
			else if (tableList.getValueAt(theRow,&quot;幣別&quot;).equals(&quot;美金&quot;))
				totalAmount = java.lang.Integer.parseInt(Form.getValue(objComponentName.toString())) - java.lang.Integer.parseInt(rollbackAmount.toString())*33;
			else {
				
			}	
			
			Form.setValue(objComponentName.toString(),new java.lang.Integer(totalAmount)); 			
			rowList.remove(theRow);
		}	
		tableList.setRowList(rowList);
		reBuildTableSN(tableList);
		//tableList.removeSelection();
	}	
}
//表格序號重編
function reBuildTableSN(objTable){
	for(var i =0;i &lt; objTable.getRowCount();i++)
		objTable.setValueAt(new java.lang.Integer(i+1),i,0);
		
}	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>table元件的相關函數</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00151156083789093</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/08/20 22:23:09</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Server.VerifyLevel</string> 
     </void> 
     <void property="id"> 
      <string>SCL00151156083789093</string> 
     </void> 
     <void property="name"> 
      <string>VerifyLevel</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021156610951562</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
function setVerify_Level(amount){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	
	var rootid = MyTask.getRootID();
	var roottask =Server.getTask(rootid);
	var af_process_id = roottask.getProcessID();
	var verify_level = getVerifyLevel(af_process_id,dataMap.get(&quot;Process_Type_ID&quot;),amount);
	dataMap.put(&quot;Verify_Level&quot;,verify_level);
}



	function getVerifyLevel(af_process_id,process_type_id,amount){
		var verify_level = &quot;50&quot;;
		var sql_verify_level = &quot;select job_level from a_sign_rule_for_Boss where active =&apos;Y&apos; and af_process_id =&apos;&quot; + af_process_id +&quot;&apos; and process_type_id =&apos;&quot;+ process_type_id +&quot;&apos; and low_limit_amount &lt;= &quot;+ amount +&quot; order by low_limit_amount desc&quot;;
			var vec_verify_level = Server.SQLloadValue(sql_verify_level);
			if(vec_verify_level.size()&gt;0){
				verify_level = vec_verify_level.get(0).get(&quot;job_level&quot;);			
			}
		return verify_level;
	}
	


	
	
	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>200704 請採購專案之後新增使用</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00151222251230193</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/09/24 18:13:50</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Server.ProcessControl</string> 
     </void> 
     <void property="id"> 
      <string>SCL00151222251230193</string> 
     </void> 
     <void property="name"> 
      <string>ProcessControl</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021156610951562</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
</string> 
     </void> 
     <void property="synopsis"> 
      <string>For PLM </string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00151250755035112</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/06/27 13:34:02</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Server.Process</string> 
     </void> 
     <void property="id"> 
      <string>SCL00151250755035112</string> 
     </void> 
     <void property="name"> 
      <string>Process</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00101250755035086</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//===================================================
 //表單編碼方式為【E0743099】 
 //&quot;07&quot;年份 , &quot;43&quot; 週 , &quot;099&quot;流水號。 
 // a= &quot;E&quot;
 // artid = ART00101173841772296_Ins
 // itemid = ITEM143 (Sn)
 //===================================================
function setSn(a,itemid){
	try{
	   var artIns = MyTask.getArtInstance(); 
	   var dataMap = artIns.getAppDataMap();
	   var cancel = dataMap.get(&quot;Cancel&quot;);
	   var artid = artIns.getArtifactID();
	   if(&quot;false&quot;.equals(cancel) &amp;&amp; dataMap.get(&quot;Sn&quot;) == &quot;&quot;){
		   var sn = &quot;&quot;;
		   try{
		   	   var year = new java.text.SimpleDateFormat(&quot;y&quot;).format(new java.util.Date()); // 07
		   	   var week = new java.text.SimpleDateFormat(&quot;w&quot;).format(new java.util.Date()); // 49
				   //補0
			   if(week.length() == 1){
				   week = &quot;0&quot; + week;
			   }			   
			   if(week==&quot;01&quot;){
				   var mydate = new Packages.pase.agenda.MyDate();
				   var ls_mon = mydate.getCurrentMonth();
				   if(ls_mon==12){
					   year = java.lang.Integer.parseInt(year)+1;
				   }
			   }
					 
			   var sn5 = a + year + week ; //E0749
			   var sn_n = &quot;001&quot;;			   
			   // var sql_sn = &quot; select Right(max(&quot;+ itemid +&quot;),3) MAXNO from &quot;+ artid +&quot;_Ins where &quot;+ itemid + &quot; LIKE &apos;&quot;+ sn5 +&quot;%&apos;&quot;; // MS-SQL :
			   var sql_sn = &quot; select substr(max(&quot;+ itemid +&quot;),-3,3) MAXNO from &quot;+ artid +&quot;_Ins where &quot;+ itemid + &quot; LIKE &apos;&quot;+ sn5 +&quot;%&apos;&quot;; // oracel
			   var vec_sn = Server.SQLloadValue(sql_sn);
			   if(vec_sn != null &amp;&amp; vec_sn.size()&gt;0 &amp;&amp; vec_sn.get(0).get(&quot;MAXNO&quot;) != &quot;&quot;){
				   var maxno_str = vec_sn.get(0).get(&quot;MAXNO&quot;);
				   var maxno_int = java.lang.Integer.parseInt(maxno_str) + 1;
				   var sn_n = java.lang.Integer.toString(maxno_int);
				   //補0
				   if(sn_n.length() == 1){
					   sn_n = &quot;00&quot; + sn_n;
				   }else if(sn_n.length() == 2){
					   sn_n = &quot;0&quot; + sn_n;
				   }
			   }
			   var sn = sn5 + sn_n; //E0749001
			   dataMap.put(&quot;Sn&quot;,sn);
		   }catch(e){}
	   }
	  }catch(e){}
}


//===============================================
//用在第一關的 post action
// copy from initPostAction
// 再加一個參數用於工作主題前面ex:檢核.. 駁回....
// 原來程式只有三個參數,不影響 call 此function 的程式
//===============================================
function initPostAction(key1,key2,key3){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var artState = MyTask.getArtInstance().getArtState().getName();
	setTaskKeyWord(dataMap,key1,key2,key3);	
	if(dataMap.get(&quot;Start_Time&quot;)== &quot;&quot; ){
		dataMap.put(&quot;Start_Time&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
	}
}

//===============================================
//用在第一關的 post action
// copy from initPostAction
// 再加一個參數用於工作主題前面ex:檢核.. 駁回....
// 原來程式只有三個參數,不影響 call 此function 的程式
//===============================================
function initPostActionExt(key1,key2,key3,key4){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var artState = MyTask.getArtInstance().getArtState().getName();
	setTaskKeyWordExt(dataMap,key1,key2,key3,key4);	
	if(dataMap.get(&quot;Start_Time&quot;)== &quot;&quot; ){
		dataMap.put(&quot;Start_Time&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
	}
}

//===============================================
//用在第一關的 post action
// copy from initPostAction
// 再加一個參數用於表單欄位傳入工作主題後面 ex:Sn +Sugjec ....
// 原來程式只有三個參數,不影響 call 此function 的程式
//===============================================
function initPostAction_Detail(key1,key2,key3,key4){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var artState = MyTask.getArtInstance().getArtState().getName();
	setTaskKeyWord_Detail(dataMap,key1,key2,key3,key4);	
	if(dataMap.get(&quot;Start_Time&quot;)== &quot;&quot; ){
		dataMap.put(&quot;Start_Time&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
	}
}


//===============================================
// 用在最後一關的 post action
//===============================================
function closeProcess(){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	dataMap.put(&quot;Close_Time&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
}	

// 
function setTaskKeyWord(dataMap,key1,key2,key3){
	var rootTask = Server.getTask(MyTask.getRootID());
	var keyWord = &quot;[簽核&quot; + dataMap.get(&quot;Factory&quot;) + &quot;]&quot; + dataMap.get(key1) +key2+ getSubString(dataMap.get(key3),50) ;
	rootTask.setKeyWord(keyWord);
	Server.updateTask(rootTask);
	MyTask.setKeyWord(keyWord);
}
// 再加一個參數用於表單欄位傳入工作主題後面 ex:Sn +Sugjec ....
function setTaskKeyWord_Detail(dataMap,key1,key2,key3,key4){
	var rootTask = Server.getTask(MyTask.getRootID());
	var keyWord = &quot;[簽核&quot; + dataMap.get(&quot;Factory&quot;) + &quot;]&quot; + dataMap.get(key1) +key2+ getSubString(dataMap.get(key3),30) + &quot;:&quot; + getSubString(dataMap.get(key4),20) ;
	rootTask.setKeyWord(keyWord);
	Server.updateTask(rootTask);
	MyTask.setKeyWord(keyWord);
}
// 再加一個參數用於工作主題前面ex:檢核.. 駁回....
function setTaskKeyWordExt(dataMap,key1,key2,key3,key4){
	var rootTask = Server.getTask(MyTask.getRootID());
	var keyWord = &quot;[&quot;+ key4+ dataMap.get(&quot;Factory&quot;) + &quot;]&quot; + dataMap.get(key1) +key2+ getSubString(dataMap.get(key3),50) ;
	rootTask.setKeyWord(keyWord);
	Server.updateTask(rootTask);
	MyTask.setKeyWord(keyWord);
}

function getSubString(s1,n){
	if(s1 != null &amp;&amp; s1.length()&gt;n){
		s1 = s1.substring(0,n) + &quot;...&quot;;
	}
	return s1;
}

function setPriority(dataMap){
	var rootkey = MyTask.getRootID();
    var roottask = Server.getTask(rootkey);
    var Priority= dataMap.get(&quot;Speed&quot;); 
	if(Priority==&quot;特急件&quot;){
		var	Prioritykey=0;
		}
	if(Priority==&quot;急件&quot;){
		var	Prioritykey=1;
		}
	if(Priority==&quot;一般件&quot;){
		var	Prioritykey=2;
		}	
	//roottask.setPriority(0);  //設定啟動主流程關卡緊急程度 (如：0 = 緊急)
    MyTask.setPriority(Prioritykey); // 設定目前填寫關卡 緊急程度(如：1 = 普通)
    //var result=Server.updateTask(roottask);
}


function setVerifyLevel(verify_level){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
		dataMap.put(&quot;Verify_Level&quot;,verify_level);	
}


function initialProcess(){	
	//抓取文件狀態
	var artState = MyTask.getArtInstance().getArtState().getName();
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	//使用者姓名
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	if(artState == &quot;初始化&quot; ){
		initialForm(dataMap);
	}
		//判斷下一關主管用，被駁回時也要 update
		var roleID = MyTask.getRoleID();
		dataMap.put(&quot;From_User_ID&quot;,cMember.getID());
		dataMap.put(&quot;From_User_Role_ID&quot;,roleID);
		dataMap.put(&quot;Next_Member_Role&quot;,&quot;&quot;); 
		dataMap.put(&quot;Next_Member_ID&quot;,&quot;&quot;); 	
}
	
function initialForm(dataMap){
	//抓取使用者相關資料
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	//使用者姓名
//	var roleID = MyTask.getRoleID();
	var roleID = cMember.getMainRoleID();	
	var memDR = cMember.getMemberDR(roleID);
	var sDepName = memDR.getDepartmentName();	//使用者部門名稱
	var sDepID = Server.getDepartment(memDR.getDepartmentID()).getMyID();
	var sRoleName = memDR.getRoleName();	//使用者職務名稱
	var sCompanyID = cMember.getAreaCode(); //使用者公司代碼
	
		
		//設定填表人姓名、員工編號...
		//dataMap.put(&quot;Sn&quot;,MyTask.getArtInstance().getMyID());
		dataMap.put(&quot;Creator&quot;,sUserName+&quot;(&quot;+cMember.getMyID()+&quot;)&quot;);
		//dataMap.put(&quot;Creator_ID&quot;,cMember.getMyID());
		dataMap.put(&quot;Creator_ID&quot;,cMember.getID());		
		dataMap.put(&quot;App_Name&quot;,sUserName);
		dataMap.put(&quot;App_MemID&quot;,mID);
		dataMap.put(&quot;App_ID&quot;,cMember.getMyID());
		//dataMap.put(&quot;App_Title&quot;,sRoleName);
		dataMap.put(&quot;App_Title&quot;,cMember.getJobTitle());
		dataMap.put(&quot;App_Tel&quot;,cMember.getOfficePhone());
		dataMap.put(&quot;App_Dep&quot;,sDepName);
		dataMap.put(&quot;App_Dep_ID&quot;,sDepID);		
		dataMap.put(&quot;App_DepID&quot;,memDR.getDepartmentID());		//&quot;DEPxxx&quot;	
		dataMap.put(&quot;Factory&quot;,&quot;(&quot; + sCompanyID + &quot;)&quot;);//廠別
		//loadLibrary(&quot;com.A.Common.Server.Util&quot;);
		var vCreateDate = dataMap.get(&quot;Create_Date&quot;);
		if(vCreateDate.equals(&quot;&quot;)){
			dataMap.put(&quot;Create_Date&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
		}
		
}//fun initForm


//--------------------------------------------------------------	
	function managerPostAction(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		//Set 流程控制
		//dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor()); //以代理人的level來簽
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getMemberID()); //以 task owner level 來簽
		dataMap.put(&quot;From_User_Role_ID&quot;, MyTask.getRoleID());
		
		//Set 簽核意見

		setTotalNote();
	}
	
function setTotalNote(){
		
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		//Set 簽核意見
		var mID = MyTask.getMemberID();
		var cMember = Server.getMemberByID(mID);
		var cMemberName = Server.getMemberByID(MyTask.getMemberID()).getName();
		var rolName = Server.getRole(MyTask.getRoleID()).getName();
		var roleID = MyTask.getRoleID();
		var memDR = cMember.getMemberDR(roleID);
		var sDepName = memDR.getDepartmentName();	//使用者部門名稱
		
		var rMember = Server.getMemberByID(MyTask.getRealExecutor()); //代理人
		var rMemberName = rMember.getName();
		if(cMember != rMember){
			cMemberName = rMemberName + &quot;( Agent &quot;+ cMemberName + &quot;)&quot; ;
		}
		var verify_record = dataMap.get(&quot;Verify_Record&quot;);
		var verify_note = dataMap.get(&quot;Verify_Note&quot;);
		var isagree = &quot;Agree&quot;;
		var agree = dataMap.get(&quot;Agree&quot;);
		if(agree != &quot;true&quot;){
		     isagree = &quot;Reject&quot;;
		}
		var processname = MyTask.getProcessName();
		//[ PM Sign吳至中_Stephen(Agent 鐘春城_CC), SBU1 , 2006/0711 10:45] Agree Good Job!
		verify_record = verify_record + &quot;[&quot; + processname+ &quot;,&quot; + cMemberName + &quot;,&quot; + sDepName + &quot;,&quot; + getFormatedCurrentTime() + &quot;]  &quot;  + isagree +&quot; &quot;+verify_note +&quot;\n&quot;;    
		dataMap.put(&quot;Verify_Record&quot;,verify_record);

}

    function getFormatedCurrentTime(){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
        return simpledateformat.format(date);
    }
//--------------------------------------------------------------

	function managerPreAction(){
		//設定主管簽核姓名
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		dataMap.put(&quot;Verify_ID&quot;,Server.getMemberByID(MyTask.getRealExecutor()).getLoginID() );	  // 2012/10/03 改為by ID	
		dataMap.put(&quot;Verify_Name&quot;,Server.getMemberByID(MyTask.getRealExecutor()).getName() );
		//清簽核欄
		dataMap.put(&quot;Agree&quot;,&quot;true&quot;);
		dataMap.put(&quot;Reject&quot;,&quot;false&quot;);
		dataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
	}



//-------------------------------------
//有多少職務
//-------------------------------------
function checkMulti_Role_Size(mID){
	//var vec_role = cMember.getAllRoleList(); //這個有含 prj role
	var sql_rol = &quot;SELECT d.Name + &apos;_&apos; + rg.Name + &apos;_&apos; + rg.RolID AS role,rg.RolID roleid,d.id depid,d.name depname &quot;
		+ &quot;  FROM Rol_Mem rm  INNER JOIN Rol_GenInf rg ON rm.RolID = rg.RolID INNER JOIN &quot; 
        + &quot; Dep_GenInf d ON rg.DepID = d.DepID &quot;
		+ &quot; WHERE   (rm.MemID = &apos;&quot;+ mID +&quot;&apos;) &quot;;
	var vec_role = Server.SQLloadValue(sql_rol);
	return vec_role.size();
}


//===============================================================================
// Server.SQLloadValue 抓一個值回來
//===============================================================================
function getKeyValue(sql){
	var keyvalue = &quot;&quot;;
	var data = Server.SQLloadValue(sql);
	if(data != null &amp;&amp; data.size()&gt;0){
		keyvalue = data.get(0).get(&quot;keyvalue&quot;);
	}
	return keyvalue;
}

//===============================================================================
// DBConn.loadValue 抓一個值回來
//===============================================================================
function getKeyValueByDBConn(sql,conn_erp){
		var keyvalue = &quot;&quot;;
		var data = conn_erp.loadValue(sql);
		if(data.size() &gt; 0 ){
				keyvalue = data.get(0).get(&quot;keyvalue&quot;);
		}
		return keyvalue;
}

//===============================================================================
// 丟 Y 或 N 進去換 true / false
//===============================================================================
function changeBoolean(YN){
	var flg = true;
	if(&quot;N&quot;.equals(YN)){
		flg = false;		
	}
	return flg;
}

//===============================================================================
// 用來切字串，如去掉小數點 str = &quot;.&quot;
//===============================================================================
function subStringB(s,str){
	try{
	if(s != null &amp;&amp; s.length() &gt; 1 ){
		//s = s.substring(s.lastIndexOf(str)+1); //後
		s = s.substring(0,s.lastIndexOf(str)); //前
	}
	}catch(e){}
	return s;
}

//===============================================================================
// 用來切字串，如去掉小數點 str = &quot;.&quot; s 為 java string
//===============================================================================
function subStringA(s,str){
	try{
	if(s != null &amp;&amp; s.length &gt; 1 ){
		//s = s.substring(s.lastIndexOf(str)+1); //後
		s = s.substring(0,s.lastIndexOf(str)); //前
	}
	}catch(e){}
	return s;
}

		
	function setManager(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var App_MemID = dataMap.get(&quot;App_MemID&quot;);
		var App_mem = Server.getMemberByID(App_MemID);  		// 2012/10/03 改為getMemberByID
		var Manager_ID = &quot;Administrator&quot;;
		if(App_mem != null){
			Manager_ID = App_mem.getPager();
		}
		dataMap.put(&quot;Next_Member_ID&quot;,Manager_ID);
		dataMap.put(&quot;Manager_ID&quot;,Manager_ID);
		
	}

	
	
	function initialProcess_wolf(){	
	//抓取文件狀態
	var artState = MyTask.getArtInstance().getArtState().getName();
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	//使用者姓名
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	if(artState == &quot;初始化&quot; ){
		initialForm_wolf(dataMap);
	}else if (artState != &quot;主管駁回&quot;){
		//dataMap.put(&quot;VerifyName&quot;,sUserName);
	}
		//判斷下一關主管用，被駁回時也要 update
		var roleID = MyTask.getRoleID();
		dataMap.put(&quot;From_User_ID&quot;,cMember.getID());
		dataMap.put(&quot;From_User_Role_ID&quot;,roleID);
		dataMap.put(&quot;Next_Member_Role&quot;,&quot;&quot;); 
		dataMap.put(&quot;Next_Member_ID&quot;,&quot;&quot;);
	
}


function initialForm_wolf(dataMap){
	//抓取使用者相關資料
	var mID = MyTask.getRealExecutor();
	var cMember = Server.getMemberByID(mID);	
	var sUserName = cMember.getName();	//使用者姓名
	var roleID = MyTask.getRoleID();
	var memDR = cMember.getMemberDR(roleID);
	var sDepName = memDR.getDepartmentName();	//使用者部門名稱
	var sDepID = Server.getDepartment(memDR.getDepartmentID()).getMyID();
	var sRoleName = memDR.getRoleName();	//使用者職務名稱
	var sCompanyID = cMember.getAreaCode(); //使用者公司代碼
		dataMap.put(&quot;Creator&quot;,sUserName+&quot;(&quot;+cMember.getMyID()+&quot;)&quot;);
		dataMap.put(&quot;Creator_ID&quot;,cMember.getMyID());
		dataMap.put(&quot;App_MemID&quot;,mID);
		dataMap.put(&quot;App_DepID&quot;,memDR.getDepartmentID());		//&quot;DEPxxx&quot;	
		dataMap.put(&quot;Factory&quot;,&quot;(&quot; + sCompanyID + &quot;)&quot;);//廠別
		dataMap.put(&quot;Create_Date&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;)); //yyyy/mm/dd hh:mm
}	

function setManager_wolf(){ 				// 這個應該沒有用	
        Server.addErrLog(&quot;Call com.A.Common.Server.Process.setManager_wolf() 請立刻修改,不要call 這個function&quot;);	// add by wangwei@2012/10/03	
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();		
		var mID = MyTask.getRealExecutor();	   
	    var roleID = MyTask.getRoleID();
		dataMap.put(&quot;App_MemID&quot;,&quot;&quot;);
		dataMap.put(&quot;App_MemID&quot;,mID);
		var App_mem = Server.getMemberByID(mID);
		var Manager_ID = &quot;Administrator&quot;;
		if(App_mem != null){
			Manager_ID = App_mem.getPager();
		}
		dataMap.put(&quot;Next_Member_ID&quot;,Manager_ID);
		
		var nextmember = Server.getMemberByID(Manager_ID) ;
  	    nextmember = Server.getMemberByID(Manager_ID) ;
	    var nextroleID = nextmember.getMainRoleID();

		dataMap.put(&quot;Next_Member_Role&quot;,nextroleID)
		
	}
//=========================================
// 觸發子流程... write by CC 
//將會簽單簽核區資訊放入簽核歷程表格
//=========================================
function setProcessTable_ext(){
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
				var depid = MyTask.getDepartmentID();
				var dep = Server.getDepartment(depid);
				var rMember = Server.getMemberByID(MyTask.getRealExecutor()); //執行者
				var roleTitle = rMember.getJobTitle();
				var department = &quot;x&quot;;
				if(dep != null){
					department = dep.getName();
				}else{
					//抓不到部門(可能是專案職務)，就抓主要職務的部門
					var roleID = rMember.getMainRoleID();
					var memDR = rMember.getMemberDR(roleID);
					var department = memDR.getDepartmentName();	//使用者部門名稱
				}
				var aInstance = MyTask.getArtInstance();
				var dataMap = aInstance.getAppDataMap();
					//Set 流程控制
					dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
					var roleid = Server.getMemberByID(MyTask.getRealExecutor()).getMainRoleID();
					dataMap.put(&quot;From_User_Role_ID&quot;, roleid);	
				var name = aInstance.getAppValue(&quot;Verify_Name&quot;);
				var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
				var isAgree = true;
				if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))) {
					isAgree = false;
				}else if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Cancel&quot;))){
				    isAgree =&quot;Y&quot;;
				}
				appendProcessTable_ext(department, roleTitle, name, isAgree, reason);
}
//=========================================
//簽核歷程表格加入一筆
//=========================================
function appendProcessTable_ext(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var Source_Ins_ID = formDataMap.get(&quot;Source_Ins_ID&quot;);
	var Source_Ins = Server.getArtInstance(Source_Ins_ID);

	if(Source_Ins != null){	
		var source_dataMap = Source_Ins.getAppDataMap();		
		var vecTableData = source_dataMap.get(&quot;Process_Table&quot;);
		var rowCount = vecTableData.size();//vecTableData裡資料筆數
		var member = Server.getMemberByCName(name);
		var id = member.getMyID();
		//加入代理人資訊 20070625
//		if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
//			name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
//		}
		//因自動關卡exeid=memid,故改抓前一關傳來之真實簽核人員姓名比對原本簽核人員姓名 add by edison@20120723
		if(! name.equals(Server.getMemberByID(MyTask.getMemberID()).getName())){
			name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
		}
	
		var hm = java.util.HashMap();
		var proName = MyTask.getProcessName();//關卡名稱
//		var proName = &quot;會簽(觸發)&quot;;//關卡名稱
		hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
		hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
		hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
		hm.put(&quot;ITEM6&quot;, department);//Department 部門
		hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
		hm.put(&quot;ITEM2&quot;, id);//ID 工號	
		hm.put(&quot;ITEM4&quot;, name);//Name 姓名
		if (isAgree == true) {
			if(proName ==&quot;它廠製工會簽審核(會簽子流程)&quot; || proName ==&quot;工程最高主管審核(會簽子流程)&quot;){
			hm.put(&quot;ITEM3&quot;,&quot;傳承&quot;);
			}else{
			hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);	
			}
			
			//hm.put(&quot;ITEM2&quot;,&quot;false&quot;);
			if(rowCount == 0){
				hm.put(&quot;ITEM3&quot;,&quot;提出&quot;);//同意
			}
		}else if (isAgree ==&quot;Y&quot;){	
			hm.put(&quot;ITEM3&quot;,&quot;作廢&quot;);

		} else {
			if(proName ==&quot;它廠製工會簽審核(會簽子流程)&quot; || proName ==&quot;工程最高主管審核(會簽子流程)&quot;){
			hm.put(&quot;ITEM3&quot;,&quot;不傳承&quot;);
			}else{
			hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);	
			}	
			//hm.put(&quot;ITEM2&quot;,&quot;true&quot;);
		}
		hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
		hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
		vecTableData.add(rowCount,hm);
		Source_Ins.setAppValue(&quot;Process_Table&quot;,vecTableData);
	}
}
	
// 更新排程檢查點　add by wangwei@2016/08/10
// vDB: 短期資料庫連線
// vQueueName: 排程名稱--&gt; 要對應到mischeck.queueName
// vColName: last_exec: 執行時間 ;last_check: 檢核時間
// vHR: 以小時計
function updateMisCheck(vDB,vQueueName,vColName, vHR){
	try{
	////Update mischeck set last_check = current + 3 units hour Where queue_name=&apos;MISD130&apos;;
		var conn = Server.createSessionConnection(vDB); // 
		var vSQL=&quot;Update mischeck set &quot;+vColName+&quot; = current + &quot;+ vHR +&quot; units hour Where queue_name=&apos;&quot;+vQueueName+&quot;&apos;;&quot;;
		var result = conn.updateValue(vSQL);
		if(true==result){
			conn.commit();
		}else{
			conn.rollback();
			Server.addErrLog(&quot;updateMisCheck Fail:&quot;+upsql);
		}		
	 }catch(e){
		Server.addErrLog(&quot;update mischeck fail vSQL:&quot;+vSQL)	 
	 }finally{
		conn.close();
	 }
}	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>流程中共用Function</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00161102067493565</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ComponentFunction.TableSort</string> 
     </void> 
     <void property="id"> 
      <string>SCL00161102067493565</string> 
     </void> 
     <void property="name"> 
      <string>TableSort</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041102066155330</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//將Table中的資料依指定的欄位予以排序
//sortOrder 為 &quot;ACC&quot;/&quot;DESC&quot;
function sortTable(table, sortColumn, sortOrder){
	var order = sortOrder.equals(&quot;ACC&quot;)? true:false;
	
	//將第一個元素視為已排序的
	var numSorted = 1;
	var index = 0;
	var size = table.getRowCount();
	var columnHeaderVector = table.getColumnNodeVector();
	var columnCount = columnHeaderVector.size();
	var temp = null;
	var compareResult = false;
	
	while (numSorted &lt; size) {
		//取出未排序部份的第一個作為 pivot
		temp = getTableRowDataArray(table,numSorted);

		//往前比較
		for (index = numSorted; index &gt; 0; index--) {
			if(order)
				compareResult = temp[sortColumn].compareTo(table.getValueAt(index - 1, sortColumn)) &lt; 0;
			else
				compareResult = temp[sortColumn].compareTo(table.getValueAt(index - 1, sortColumn)) &gt; 0;
			
			if (compareResult){
				for(var i = 0; i &lt; columnCount; i++){
					var newValue = table.getValueAt(index-1,i);
					table.setValueAt(newValue,index, i);
				}
			}else
				break;
		}

		//把 pivot 插入適當位置
		for(var i = 0; i &lt; columnCount; i++){
			table.setValueAt(temp[i],index, i);
		}

		numSorted++;
	}
}
//供 sortTable() 使用,將該 Table 指定Row的資料以 String[] 格式傳回
function getTableRowDataArray(table, row){
	if(row &gt;= table.getRowCount())
		return null;
		
	var columnHeaderVector = table.getColumnNodeVector();
	var columnCount = columnHeaderVector.size();
	var result = [];
	for(var i = 0; i &lt; columnCount; i++){
		result[i] = table.getValueAt(row, i);
	}
	
	return result;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>將Table中的資料依指定的方式予以排序</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00161222251459724</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/09/24 18:17:39</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.Common.Server.ProcessControl</string> 
     </void> 
     <void property="id"> 
      <string>SCL00161222251459724</string> 
     </void> 
     <void property="name"> 
      <string>ProcessControl</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00251213176848084</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

	function setReject_first_tsk(){	
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var rootid = MyTask.getRootID();
		//var vec = Server.getSubTaskList(rootid);
		//for (var i=0;i&lt;vec.size();i++) {
		//var Task=vec.get(i);
		//}
		//取得 rootid 後第一關
		var sql_task = &quot;  select min(tskid) tskid from task where tskid != rootid and rootid =&apos;&quot;+ rootid +&quot;&apos;  &quot;;
		var vec_task = Server.SQLloadValue(sql_task);										
		//var task = Form.getCurrentTask();
		//if (Client.checkTaskComplete(task)) {}
		if(vec_task != null &amp;&amp; vec_task.size()&gt;0 &amp;&amp; vec_task.get(0).get(&quot;tskid&quot;)!= &quot;&quot;){
		var first_tskid = vec_task.get(0).get(&quot;tskid&quot;);
		var first_tsk = Server.getTask(first_tskid);
		if( first_tsk != null){
					//重送到提出者手上
					//var realExecutorMemID = first_tsk.getRealExecutor();
					//var memberRecord = Client.getMemberByID(realExecutorMemID);
					//var current_member = Client.getCurrentMember();				
					var first_processid = first_tsk.getProcessID();
					//first_processid = &quot;SGN00791220930848976&quot; ;  
					flg = Server.goBackTo(MyTask.getID(),first_processid,true);	
				}
		}		
	}		
		

		
	function setReject_second_tsk_mecn(){	
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var rootid = MyTask.getRootID();
		//取得 rootid 後第一關
		var sql_task = &quot;  select max(tskid) tskid from task where tskid != rootid and rootid =&apos;&quot;+ rootid +&quot;&apos;  &quot;;
		var vec_task = Server.SQLloadValue(sql_task);										
		//var task = Form.getCurrentTask();
		//if (Client.checkTaskComplete(task)) {}
		if(vec_task != null &amp;&amp; vec_task.size()&gt;0 &amp;&amp; vec_task.get(0).get(&quot;tskid&quot;)!= &quot;&quot;){
		var first_tskid = vec_task.get(0).get(&quot;tskid&quot;);
		var first_tsk = Server.getTask(first_tskid);
		if( first_tsk != null){
					//重送到提出者手上
					//var realExecutorMemID = first_tsk.getRealExecutor();
					//var memberRecord = Client.getMemberByID(realExecutorMemID);
					//var current_member = Client.getCurrentMember();				
					var first_processid = first_tsk.getProcessID();
					//first_processid = &quot;SGN00791220930848976&quot; ;  
					flg = Server.goBackTo(MyTask.getID(),&quot;PRO00011222681652418&quot;,true);	
				}
		}			
	}	

	
	function setReject_second_tsk(PRO_ID){	
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var rootid = MyTask.getRootID();
		//取得 rootid 後第一關
		var sql_task = &quot;  select max(tskid) tskid from task where tskid != rootid and rootid =&apos;&quot;+ rootid +&quot;&apos;  &quot;;
		var vec_task = Server.SQLloadValue(sql_task);										
		//var task = Form.getCurrentTask();
		//if (Client.checkTaskComplete(task)) {}
		if(vec_task != null &amp;&amp; vec_task.size()&gt;0 &amp;&amp; vec_task.get(0).get(&quot;tskid&quot;)!= &quot;&quot;){
		var first_tskid = vec_task.get(0).get(&quot;tskid&quot;);
		var first_tsk = Server.getTask(first_tskid);
		if( first_tsk != null){
					//重送到提出者手上
					//var realExecutorMemID = first_tsk.getRealExecutor();
					//var memberRecord = Client.getMemberByID(realExecutorMemID);
					//var current_member = Client.getCurrentMember();				
					var first_processid = first_tsk.getProcessID();
					//first_processid = &quot;SGN00791220930848976&quot; ;  
					flg = Server.goBackTo(MyTask.getID(),PRO_ID,true);	
				}
		}			
	}



	
		
	//=========================================
	//Autocomplete_role
	//=========================================
	function getrole(Sign_MemberTable,PMemID){
		var SignTable = dataMap.get(Sign_MemberTable);
		var Masrole = &quot;NO&quot;;
		if( SignTable != null || SignTable.size() &gt; 0 ){
			for(var j=0;j&lt;SignTable.size();j++){			
				if(SignTable.elementAt(j).values().toString().indexOf(PMemID)&gt;=0){				
						Masrole = SignTable.elementAt(j).get(&quot;ITEM4&quot;);
				}			
			}	
		}	
		return Masrole;
	}			
		
		
	//=========================================
	//Autocomplete_role
	//=========================================
	function Autocomplete_same(Sign_MemberTable,role,subMemID){
		var SignTable = dataMap.get(Sign_MemberTable);
		SignTable.trimToSize();
		var flg = false;
		if( !SignTable.isEmpty() || SignTable.size() &gt; 0 ){
			for(var j=0;j&lt;SignTable.size();j++){			
				if( SignTable.elementAt(j).values().toString().indexOf(subMemID)&gt;=0 &amp;&amp; SignTable.get(j).get(&quot;ITEM4&quot;).equals(role) ){
					flg = true;				
				}			
			}	
		}	
		return flg;		
	}
	

	//=========================================
	//Autocomplete_role_map
	//=========================================
	function getrole_map(Sign_MemberTable,PMemID){
		var SignTable = dataMap.get(Sign_MemberTable);
		SignTable.trimToSize();
		var Masrole = &quot;N&quot;;
		var row = new Packages.java.util.HashMap();
		if( SignTable != null || SignTable.size() &gt; 0 ){
			for(var j=0;j&lt;SignTable.size();j++){
				if(SignTable.elementAt(j).values().toString().indexOf(PMemID)&gt;=0){
					Masrole = SignTable.elementAt(j).get(&quot;ITEM4&quot;);
				}
				var MemID_temp = SignTable.elementAt(j).get(&quot;ITEM1&quot;)+&quot;;&quot; ;
				if(row.containsKey(SignTable.get(j).get(&quot;ITEM4&quot;))){		
					row.put(SignTable.get(j).get(&quot;ITEM4&quot;), row.get(SignTable.get(j).get(&quot;ITEM4&quot;)) + MemID_temp );					
				}else{
					row.put(SignTable.get(j).get(&quot;ITEM4&quot;),MemID_temp);
				}		
			}	
		}
		if( row.containsKey(Masrole)) {
			return  row.get(Masrole);
		}else{
			return  &quot;&quot;;
		}
	}	
	
		
</string> 
     </void> 
     <void property="synopsis"> 
      <string>For PLM
</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00161241831936682</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2016/12/22 17:31:53</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Client.CHK_EKM</string> 
     </void> 
     <void property="id"> 
      <string>SCL00161241831936682</string> 
     </void> 
     <void property="name"> 
      <string>CHK_EKM</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021229049977055</string> 
     </void> 
     <void property="scriptSource"> 
      <string>

//===================================================================
// 檢查索引卡是否出庫未簽入
// D=草稿
//===================================================================	
function check_doc_type(){
		        var STATUS = &quot;&quot;;
				var msg = &quot;&quot;;
		        var MyTask = Form.getCurrentTask();
                var rootid = MyTask.getRootID();
                var vec = Client.getSubTaskList(rootid);
				var doc_id= Form.getValue(&quot;Doc_ID&quot;);
				var ver_id= Form.getValue(&quot;Ver_ID&quot;);
				var conn = Client.createSessionConnection(&quot;EKM&quot;);			
				var vec =  conn.loadValue(&quot; select c.Name,t.Name Type,v.*,g.G_name  from ekm.TECHDOC_VERSION v,ekm.ELAND_CATEGORY c ,ekm.TECHDOC_TYPE t,ekm.EIP_GROUP g  where  v.CATEGORY_ID = c.CATEGORY_ID(+)  and v.Type_ID = t.Type_ID(+)  and v.reserve_dept = g.g_id(+)  and ( doc_id,ver_id ) in  (  select doc_id,max(ver_id) from ekm.TECHDOC_VERSION  where doc_id like &apos;&quot; + doc_id + &quot;&apos; group by  doc_id )&quot; );
				if(vec != null &amp;&amp; vec.size()&gt;0){	
					STATUS = vec.get(0).get(&quot;status&quot;).trim() ;
					ver_id = vec.get(0).get(&quot;ver_id&quot;).trim() ;
					var creator_id = vec.get(0).get(&quot;Creator&quot;);
					var SUB_SUBJECT = vec.get(0).get(&quot;sub_subject&quot;).trim() ;
					var SUBJECT = vec.get(0).get(&quot;subject&quot;).trim() ;
					Form.setValue(&quot;Ver_ID&quot;,ver_id); 
					Form.setValue(&quot;Sub_Subject&quot;,SUB_SUBJECT); 
					Form.setValue(&quot;SUBJECT&quot;,SUBJECT); 
				}
				conn.close();
				if(STATUS.equals(&quot;D&quot;)){
					msg += &quot;文件已被重工,請檢查文件檔案是否已重工入庫!\n&quot;;
				}else{
				}
				if(msg != &quot;&quot;){
					Form.setComplete(false);
					Form.showMessageDialog(msg);
				}
}
	
loadLibrary(&quot;com.eland.dms.Config&quot;);

function update_rma_(sn){
	var v_arry = sn.split(&quot;@&quot;);
	var rma_no = v_arry[0];
	var return_no = v_arry[1];
	//var sql = &quot;select item85,insid from ART01911339827184801_ins where item85 is not null and item45=&apos;false&apos; and item160=&apos;Y&apos; and item43&gt;&apos;2016/12/20 00:00&apos;&quot;;
	var sql = &quot;select insid from ART01911339827184801_ins where item85 is not null and item45=&apos;false&apos; and item160=&apos;Y&apos; and item85=&apos;&quot;+rma_no+&quot;&apos;&quot;;

	var vec = Client.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		for(var i = 0;i&lt;vec.size();i++){
			
			var insid = vec.get(i).get(&quot;insid&quot;);	
			
			if(return_no!=&quot;&quot;){
				var latestTskID = Client.getArtTskID(insid);
				var nowTaskObj = Client.getTask(latestTskID);
				var thisPASEartInstance = Client.getArtInstance(insid);
				thisPASEartInstance.setAppValue(&quot;return_no&quot;,&quot;退貨:YES，退貨號碼:&quot;+return_no);				
				//把原本的updateArtInstance改成底下這兩行
				nowTaskObj.setArtInstance(thisPASEartInstance) ;
				Client.updateTask(nowTaskObj);
			}
		}
	}
}
function get_return_no(){
	
	try{
			
		var conn_mis = Client.createSessionConnection(&quot;PROD&quot;);	
		var sql = &quot;select credit_no||&apos;@&apos;||return_no as sn from tg_rma_ar_credit_ctrl_fl_v where return_no is not null &quot;;			
		var vec = conn_mis.loadValue(sql);
		if(vec!=null &amp;&amp; vec.size()&gt;0){
			for(var i = 0;i&lt;vec.size();i++){
				var sn = vec.get(i).get(&quot;sn&quot;);
				update_rma_(sn);
			}
			
		}
				
	}catch(e){
				
	}finally{			
		conn_mis.close();
				
	}
	
}

function update_mecn_data(){
	var sql = &quot;select insid,item4,item3,item1 from ART01681328499249788item28 where item8=&apos;工程最高主管審核(會簽子流程)&apos; and (item3=&apos;傳承&apos; or item3=&apos;不傳承&apos;) and (item4 like &apos;%蔡錦松%&apos; or item4 like &apos;%許俊賢%&apos; or item4 like &apos;%高祥%&apos;) &quot;;
//	sql += &quot; and insid=&apos;Ans000028909912&apos; &quot;;
	
	var vec = Client.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		for(var i = 0;i&lt;vec.size();i++){
			var insid = vec.get(i).get(&quot;insid&quot;);
			var username = vec.get(i).get(&quot;item4&quot;);
			var agree = vec.get(i).get(&quot;item3&quot;);
			var notes = vec.get(i).get(&quot;item1&quot;);
			set_mecn_value(insid,username,agree,notes);
		}
	}
}
function set_mecn_value(insid,username,agree,notes){
	var latestTskID = Client.getArtTskID(insid);
	var nowTaskObj = Client.getTask(latestTskID);
	var thisPASEartInstance = Client.getArtInstance(insid); 
	if(username.indexOf(&quot;蔡錦松&quot;)!=-1){
		thisPASEartInstance.setAppValue(&quot;hlc_1&quot;,agree); 
		thisPASEartInstance.setAppValue(&quot;hlc_2&quot;,notes); 		
	}else if(username.indexOf(&quot;高祥&quot;)!=-1){
		thisPASEartInstance.setAppValue(&quot;sgce_1&quot;,agree); 
		thisPASEartInstance.setAppValue(&quot;sgce_2&quot;,notes);
	}else if(username.indexOf(&quot;許俊賢&quot;)!=-1){
		thisPASEartInstance.setAppValue(&quot;cgce_1&quot;,agree); 
		thisPASEartInstance.setAppValue(&quot;cgce_2&quot;,notes);
	}else if(username.indexOf(&quot;游文哲&quot;)!=-1){
		thisPASEartInstance.setAppValue(&quot;hgce_1&quot;,agree); 
		thisPASEartInstance.setAppValue(&quot;hgce_2&quot;,notes);
	}
	//把原本的updateArtInstance改成底下這兩行
	nowTaskObj.setArtInstance(thisPASEartInstance) ;
	Client.updateTask(nowTaskObj);
}

function chk_edison_test(){

//Client.clearServerCache();
	
//	var sql = &quot;SELECT TskID  FROM Task, Pro_GenInf, Project WHERE     Task.ProID = Pro_GenInf.ProID       AND Pro_GenInf.PrjID = Project.PrjID &quot;;
//       sql += &quot; AND (   Task.ProID = &apos;PRO00181289986062672&apos;) &quot;;
//       sql += &quot; AND (Task.State = &apos;running&apos;) &quot;;
//       sql += &quot; AND (Task.TYPE = &apos;root&apos;)&quot;;
//	   
//	var vec = Client.SQLloadValue(sql);  
//	if(vec!=null &amp;&amp; vec.size()&gt;0){
//		for(var i =0;i&lt;vec.size();i++){
//			var rootid = vec.get(i).get(&quot;TskID&quot;);
//			var tskid = getMaxTaskID(rootid);
//			if(tskid!=&quot;&quot;){
//				var r_task = Client.getTask(tskid);
//				var insid = r_task.getArtInstance().getID(); 
//				var thisPASEartInstance = Client.getArtInstance(insid); 
//				thisPASEartInstance.setAppValue(&quot;Close_Time&quot;,&quot;&quot;);
//				r_task.setArtInstance(thisPASEartInstance) ;
//				Client.updateTask(r_task);	   
//			}
//		}
//	}

	var insid = &quot;Ans000027398833&quot;;
	var Source_Ins = Client.getArtInstance(insid);
	var source_dataMap = Source_Ins.getAppDataMap();
	var file = source_dataMap.get(&quot;AttachedFile0&quot;);
	Form.showMessageDialog(file.getProperty(&quot;FileCount&quot;));

}
function getMaxTaskID(rootid){
	var tskid = &quot;&quot;;
	var sql = &quot;select max(tskid) as tskid from task where rootid=&apos;&quot;+rootid+&quot;&apos;&quot;;
	var vec = Client.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		tskid = vec.get(0).get(&quot;tskid&quot;);
	}
	return tskid;
}

function mecn2(doc_sn){
	var sql =&quot;SELECT rootid  FROM task WHERE tskid = (SELECT MAX (tskid) FROM task_artins WHERE insid IN (SELECT INSID FROM ART01231303473435492_INS A  WHERE ITEM62 != &apos;null&apos;  AND A.ITEM231=&apos;Y&apos; AND ITEM62 like &apos;&quot;+doc_sn+&quot;%&apos; union all SELECT INSID FROM ART01471295923593984_INS A  WHERE ITEM62 != &apos;null&apos;  AND A.ITEM231=&apos;Y&apos; AND ITEM62 like &apos;&quot;+doc_sn+&quot;%&apos; union all SELECT INSID FROM ART03501267714880085_INS A  WHERE ITEM62 != &apos;null&apos;  AND A.ITEM231=&apos;Y&apos; AND ITEM62 like &apos;&quot;+doc_sn+&quot;%&apos; union all SELECT INSID FROM ART01001231233951714_INS A WHERE ITEM62 != &apos;null&apos;  AND ITEM62 like &apos;&quot;+doc_sn+&quot;%&apos;))&quot;;
	var rs = Client.SQLloadValue(sql);
	if(rs!=null &amp;&amp; rs.size()&gt;0){
		for(var i=0;i&lt;rs.size();i++){
			completeTask(rs.get(i).get(&quot;rootid&quot;));
		}
		
	} 
}

function mecn3(doc_sn){
	var sql =&quot;SELECT rootid  FROM task WHERE tskid = (SELECT MAX (tskid) FROM task_artins WHERE insid IN (SELECT INSID FROM ART01241303473455789_INS A  WHERE ITEM62 != &apos;null&apos;  AND A.ITEM231=&apos;Y&apos; AND ITEM62 like &apos;&quot;+doc_sn+&quot;%&apos; union all SELECT INSID FROM ART01481295923638827_INS A  WHERE ITEM62 != &apos;null&apos;  AND A.ITEM231=&apos;Y&apos; AND ITEM62 like &apos;&quot;+doc_sn+&quot;%&apos; union all SELECT INSID FROM ART03511267714991115_INS A  WHERE ITEM62 != &apos;null&apos;  AND A.ITEM231=&apos;Y&apos; AND ITEM62 like &apos;&quot;+doc_sn+&quot;%&apos;))&quot;;
	var rs = Client.SQLloadValue(sql);
	if(rs!=null &amp;&amp; rs.size()&gt;0){
		for(var i=0;i&lt;rs.size();i++){
			completeTask(rs.get(i).get(&quot;rootid&quot;));
		}
		
	} 
}
function completeMecnNo(sn){
//	var sql = &quot;select * from edison_test &quot;;
//	var rs = Client.SQLloadValue(sql);
	try{
		
		var conn = Client.createSessionConnection(&quot;EKM&quot;);
		var sql = &quot;select a.category_id,a.agentflow_task_id,b.doc_id,b.ver_id from ekm.doc_agentflow_mapping a,&quot;;
		    sql +=&quot;(select doc_id,max(ver_id) ver_id from ekm.TECHDOC_VERSION  where gce_doc_sn = &apos;&quot;+sn+&quot;&apos; group by  doc_id ) b &quot;;
			sql +=&quot;where a.DOC_ID=b.doc_id order by a.agentflow_task_id desc&quot;;
			var vec = conn.loadValue(sql);
		if(vec != null &amp;&amp; vec.size()&gt;0){
			var roottskid = vec.get(0).get(&quot;agentflow_task_id&quot;).trim();		
			var doc_id = vec.get(0).get(&quot;doc_id&quot;).trim();	
			var ver_id = vec.get(0).get(&quot;ver_id&quot;).trim();	
			var category_id = vec.get(0).get(&quot;category_id&quot;).trim();
			//complete task
			completeTask(roottskid);
			//update ekm techdoc_version
			var wfapi = new Packages.com.eland.ekm.api.workflow.WorkflowFunctionAPI(hostname);
			var success = wfapi.setDocStatus(category_id,doc_id,ver_id,&quot;eipadmin&quot;,&quot;C&quot;);
			//update ekm 最後狀態顯示
			updateDoc_af_status(&quot;MECN發行&quot;,doc_id);
//			var roottskid = vec.get(0).get(&quot;agentflow_task_id&quot;).trim();
//			completeTask1(roottskid);
		}
	}catch(e){
		conn.close();
	}finally{
		conn.close();
	}
	
}


function updateDoc_af_status(status,doc_id){
		try{
			var conn_ekm = Client.createSessionConnection(&quot;EKM&quot;);
			//所有版本狀態皆update
			var sql_ekm = &quot; update FIELD_DATA set COL_06 = &apos;&quot;+ status +&quot;&apos; where REF_ID_01= &apos;&quot;+ doc_id +&quot;&apos; &quot; ;
			var result = conn_ekm.updateValue(sql_ekm);	
		}catch(e){
			conn_ekm.rollback();
		}finally{
			conn_ekm.commit();
			conn_ekm.close();			
		}
	}
function completeTask1(roottskid){
	var sql =&quot;select max(tskid) tskid from task where rootid=&apos;&quot;+roottskid+&quot;&apos; &quot;;
	var vec = Client.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		for(var i=0;i&lt;vec.size();i++){
			
				//寫入結案時間,作廢=false
				updateInstance(vec.get(i).get(&quot;tskid&quot;));
			

		}
		//updateRootTaskComplete(roottskid);
	}
	
}
function completeTask(roottskid){
	var sql =&quot;select tskid,type from task where rootid=&apos;&quot;+roottskid+&quot;&apos; and state&lt;&gt;&apos;complete&apos; order by tskid desc&quot;;
	var vec = Client.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		for(var i=0;i&lt;vec.size();i++){
			if(i==0){
				//寫入結案時間,作廢=false
				updateInstance(vec.get(i).get(&quot;tskid&quot;));
			}
			completeCreatePro(vec.get(i).get(&quot;tskid&quot;));//檢查是否有觸發子流程,若有則全部complete
			 updateTaskComplete(vec.get(i).get(&quot;tskid&quot;));//update task 
		}
	}
	
}
function completeCreatePro(tskid){
	var ftaskid = Client.getTask(tskid).getFrontID();
	if(ftaskid!=null){
		var sql =&quot;select cproottskid from task_createpro where tskid=&apos;&quot;+ftaskid+&quot;&apos; and iscomplete=&apos;false&apos;&quot;;
		var vec = Client.SQLloadValue(sql);
		if(vec!=null &amp;&amp; vec.size()&gt;0){
			for(var i=0;i&lt;vec.size();i++){
				updateRootTaskComplete(vec.get(i).get(&quot;cproottskid&quot;));
			}
			updateTask_createPro(tskid);
		
		}
		
	}
	
	
}
function updateTask_createPro(tskid){	
	var sql =&quot;update task_createpro set iscomplete=&apos;true&apos; where tskid=&apos;&quot;+tskid+&quot;&apos;&quot;;
	var uResult = Client.SQLupdateValue(sql); 
}

function updateRootTaskComplete(tskid){
	var time = Client.getServerTime();
	var sql =&quot;update task set state=&apos;complete&apos;,endtime=&apos;&quot;+time+&quot;&apos; where rootid=&apos;&quot;+tskid+&quot;&apos;&quot;;
	var uResult = Client.SQLupdateValue(sql); 
}
function updateTaskComplete(tskid){
	var time = Client.getServerTime();
	var sql =&quot;update task set state=&apos;complete&apos;,endtime=&apos;&quot;+time+&quot;&apos; where tskid=&apos;&quot;+tskid+&quot;&apos;&quot;;
	var uResult = Client.SQLupdateValue(sql); 
}
function updateInstance(tskid){
	
	try{
		var task = Client.getTask(tskid);
		if(task!=null){
			var artIns = task.getArtInstance();
//			var dataMap = artIns.getAppDataMap();
//			dataMap.put(&quot;ITEM155&quot;,&quot;false&quot;);
//			dataMap.put(&quot;ITEM115&quot;,&quot;2011/12/22 18:00&quot;);
			artIns.setAppValue(&quot;Cancel&quot;,&quot;false&quot;);
			artIns.setAppValue(&quot;Close_Time&quot;,getFormatedCurrentTime(&quot;yyyy/MM/dd HH:mm&quot;));
			Client.updateArtInstance(artIns);
		}
	}catch(e){
	}
	
}

 function getFormatedCurrentTime(){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
        return simpledateformat.format(date);
    }
			
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00171102067568377</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2004/12/03 17:52:48</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.SystemFunction.AppendAudit</string> 
     </void> 
     <void property="id"> 
      <string>SCL00171102067568377</string> 
     </void> 
     <void property="name"> 
      <string>AppendAudit</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//將會簽結果放入審核意見裡面 SQL命令 for SQL Server 
function AppendAuditForSQLServer(){
		//將會簽結果放入審核意見裡面
		var tableApprovalHistory = Form.getComponent(&quot;tableApprovalHistory&quot;);
		var task = Form.getCurrentTask(); 
		//由 Table 中取出此關卡相關的加會簽資料
		var querySQL = &quot;Select a.TskID,a.AddSignResult,a.AnnounceContent,a.TaskType,b.ExeID,b.RolID,b.DepID,b.EndTime  from Add_Task as a &quot;+
				&quot;join (Select TskID, ParentID, ExeID,RolID,DepID,EndTime from Task where ParentID = &apos;&quot;+task.getID()+&quot;&apos;) as b &quot;+
				&quot;on a.TskID = b.TskID &quot;;
		var dataSet = Client.SQLloadValue(querySQL);
		for(var i = 0; i&lt; dataSet.size(); i++){
			var aRow = dataSet.get(i);

			//以會簽時間為檢查Key, 避免重複登錄
			var signTime = new Packages.pase.agenda.MyDate(java.lang.Long.parseLong(aRow.get(&quot;EndTime&quot;)));					
			var time = signTime.getCurrentDate(&quot;y/M/d H:m s&quot;);
			var registed = indexOfTableRow(tableApprovalHistory,&quot;日期&quot;,time);
			if(registed != -1)
				continue;

			var row = tableApprovalHistory.newRow() - 1;
			var type = aRow.get(&quot;TaskType&quot;);
			if(type.equals(&quot;AddSequentialSign&quot;))
				type = &quot;串簽&quot;;
			else if(type.equals(&quot;AddParallelAnnounce&quot;))
				type = &quot;分會&quot;;
			else if(type.equals(&quot;AddSequentialAnnounce&quot;))
				type = &quot;串會&quot;;

			var itemCount = new java.lang.String(row + 1);
			if(itemCount.length() == 1)  //補成兩位數
				itemCount = &quot;0&quot; + itemCount;
			tableApprovalHistory.setValueAt(itemCount, row, &quot;序號&quot;);
			tableApprovalHistory.setValueAt(time, row, &quot;日期&quot;);
			tableApprovalHistory.setValueAt(task.getProcessName() + &quot;--&quot; + type, row, &quot;關卡名稱&quot;);
			tableApprovalHistory.setValueAt(Client.getRole(aRow.get(&quot;RolID&quot;)), row, &quot;職稱&quot;);
			tableApprovalHistory.setValueAt(Client.getMember(aRow.get(&quot;ExeID&quot;)).getName(), row, &quot;姓名&quot;);
			tableApprovalHistory.setValueAt(aRow.get(&quot;AnnounceContent&quot;), row, &quot;意見&quot;);
			if(aRow.get(&quot;AnnounceContent&quot;).equalsIgnoreCase(&quot;No&quot;))
				tableApprovalHistory.setValueAt(new java.lang.Boolean(true), row, &quot;駁回&quot;);
			else
				tableApprovalHistory.setValueAt(new java.lang.Boolean(true), row, &quot;同意&quot;);
		}

		//傳入表格, 第幾欄, 欄位值
		//傳回該值所在的 row
		function indexOfTableRow(table, col, value){
			for(var i = 0; i &lt; table.getRowCount();i++){
				var cellValue = table.getValueAt(i , col);
				if(cellValue.equals(value))
					return i;
			}		
	
			return -1;
		}
}
//將會簽結果放入審核意見裡面 SQL命令 for Oracle
function AppendAuditForOracle(){
		//將會簽結果放入審核意見裡面
		var tableApprovalHistory = Form.getComponent(&quot;tableApprovalHistory&quot;);
		var task = Form.getCurrentTask(); 
		//由 Table 中取出此關卡相關的加會簽資料
		var querySQL = &quot;Select a.TskID,a.AddSignResult,a.AnnounceContent,a.TaskType,b.ExeID,b.RolID,b.DepID,b.EndTime  &quot;+
				&quot;from Add_Task a , Task b &quot;+
				&quot;where b.ParentID = &apos;&quot;+task.getID()+&quot;&apos; and a.TskID = b.TskID &quot;;
		var dataSet = Client.SQLloadValue(querySQL);
		for(var i = 0; i&lt; dataSet.size(); i++){
			var aRow = dataSet.get(i);

			//以會簽時間為檢查Key, 避免重複登錄
			var signTime = new Packages.pase.agenda.MyDate(java.lang.Long.parseLong(aRow.get(&quot;EndTime&quot;)));					
			var time = signTime.getCurrentDate(&quot;y/M/d H:m s&quot;);
			var registed = indexOfTableRow(tableApprovalHistory,&quot;日期&quot;,time);
			if(registed != -1)
				continue;

			var row = tableApprovalHistory.newRow() - 1;
			var type = aRow.get(&quot;TaskType&quot;);
			if(type.equals(&quot;AddSequentialSign&quot;))
				type = &quot;串簽&quot;;
			else if(type.equals(&quot;AddParallelAnnounce&quot;))
				type = &quot;分會&quot;;
			else if(type.equals(&quot;AddSequentialAnnounce&quot;))
				type = &quot;串會&quot;;

			var itemCount = new java.lang.String(row + 1);
			if(itemCount.length() == 1)  //補成兩位數
				itemCount = &quot;0&quot; + itemCount;
			tableApprovalHistory.setValueAt(itemCount, row, &quot;序號&quot;);
			tableApprovalHistory.setValueAt(time, row, &quot;日期&quot;);
			tableApprovalHistory.setValueAt(task.getProcessName() + &quot;--&quot; + type, row, &quot;關卡名稱&quot;);
			tableApprovalHistory.setValueAt(Client.getRole(aRow.get(&quot;RolID&quot;)), row, &quot;職稱&quot;);
			tableApprovalHistory.setValueAt(Client.getMember(aRow.get(&quot;ExeID&quot;)).getName(), row, &quot;姓名&quot;);
			tableApprovalHistory.setValueAt(aRow.get(&quot;AnnounceContent&quot;), row, &quot;意見&quot;);
			if(aRow.get(&quot;AnnounceContent&quot;).equalsIgnoreCase(&quot;No&quot;))
				tableApprovalHistory.setValueAt(new java.lang.Boolean(true), row, &quot;駁回&quot;);
			else
				tableApprovalHistory.setValueAt(new java.lang.Boolean(true), row, &quot;同意&quot;);
		}

		//傳入表格, 第幾欄, 欄位值
		//傳回該值所在的 row
		function indexOfTableRow(table, col, value){
			for(var i = 0; i &lt; table.getRowCount();i++){
				var cellValue = table.getValueAt(i , col);
				if(cellValue.equals(value))
					return i;
			}		
	
			return -1;
		}
	
}	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>將會簽結果放入審核意見裡面</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00171244444421608</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2010/10/11 17:33:56</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Client.CHK_AF</string> 
     </void> 
     <void property="id"> 
      <string>SCL00171244444421608</string> 
     </void> 
     <void property="name"> 
      <string>CHK_AF</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021229049977055</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//*****************************************************************************************//
//CECHK PDM ECN
//1.MECN。
//2.ECR。
//3.ER。
//*****************************************************************************************//	
function check_PDM_Status(pdm_type,no){
	var msg = &quot;&quot;;
	
	var mecn_artid = &quot;ART01811259303288096&quot;;
	var ecr_artid  = &quot;ART02141262697497713&quot;;
	var er_artid   = &quot;ART01621284974838760&quot;;

	if(pdm_type.equals(&quot;ME&quot;)){
			var sql_flag = &quot; select INSID,ITEM62,ITEM66,ITEM2,ITEM115,ITEM155 &quot;;
			    sql_flag +=&quot; from &quot; + mecn_artid +&quot;_INS&quot;; 
			    sql_flag +=&quot; where ITEM62 like &apos;%&quot;+ no +&quot;%&apos; &quot;; 
				sql_flag +=&quot; AND ITEM231=&apos;Y&apos;&quot;;
			    sql_flag +=&quot; AND ITEM155 = &apos;false&apos; &quot; ;
			
			var vector_ver = Client.SQLloadValue(sql_flag);
			if(vector_ver.size()&gt;0  ){	
				var vIns  = Client.getArtInstance(vector_ver.get(0).get(&quot;INSID&quot;));     // 以INSID取得資料
                var dataMap = vIns.getAppDataMap(); 
				var	FLOWTYPE=dataMap.get(&quot;FLOWTYPE&quot;).substring(0,2);
				if(FLOWTYPE.equals(&quot;A類&quot;) ||FLOWTYPE.equals(&quot;B類&quot;) ){
					
				}else if(FLOWTYPE.indexOf(&quot;C&quot;)&gt;=0){
					msg = msg + check_Instance(vector_ver.get(0).get(&quot;INSID&quot;));			
				}				
			}else{				
				msg += &quot;無此MECN編號&quot;+ no +&quot;,不能提出ECN!\n&quot;;
			}
	}
	else if(pdm_type.equals(&quot;EC&quot;)){
			var sql_flag = &quot; select INSID &quot;;
			    sql_flag +=&quot; from &quot; + ecr_artid +&quot;_INS &quot;;
                sql_flag +=&quot; where ITEM62 like &apos;%&quot;+ no +&quot;%&apos; &quot;;
				sql_flag +=&quot; AND ITEM105 = &apos;Y&apos; &quot;;
 			    sql_flag +=&quot; AND ITEM155 = &apos;false&apos; &quot; ;

			var vector_ver = Client.SQLloadValue(sql_flag);
			if(vector_ver.size()&gt;0  ){	
				msg = msg + check_Instance(vector_ver.get(0).get(&quot;INSID&quot;));				
			}else{				
				msg += &quot;無此ECR編號&quot;+ no +&quot;,不能提出ECN!\n&quot;;
			}
	}
	else if(pdm_type.equals(&quot;ER&quot;)){
		var sql_flag = &quot; select INSID &quot;;
			    sql_flag +=&quot; from &quot; + er_artid +&quot;_INS &quot;;
                sql_flag +=&quot; where ITEM62 like &apos;%&quot;+ no +&quot;%&apos; &quot;;
				sql_flag +=&quot; AND ITEM9 = &apos;Y&apos; &quot;;
 			    sql_flag +=&quot; AND ITEM155 = &apos;false&apos; &quot; ;

			var vector_ver = Client.SQLloadValue(sql_flag);
			if(vector_ver.size()&gt;0  ){	
//				msg = msg + check_Instance(vector_ver.get(0).get(&quot;INSID&quot;));				
			}else{				
//				msg += &quot;無此ER編號&quot;+ no +&quot;,不能提出ECN!\n&quot;;
			}
	}
	if(msg != &quot;&quot;){
			Form.setComplete(false);
			Form.showMessageDialog(msg);
	}	
	
}

function check_Instance(insid){
						var msg = &quot;&quot;;
                        var vIns  = Client.getArtInstance(insid);     // 以之INSID取得資料
                        var dataMap = vIns.getAppDataMap(); 
                        var vClose_time = dataMap.get(&quot;Close_Time&quot;);              
                        if(null==vClose_time || vClose_time == &quot;&quot;){
                                msg = msg +&quot;文件未經主管核准!不可申請\n&quot;;            
                                }	
						return msg;
}

//*****************************************************************************************//
//CECHK PDM DOC
//1.DRILL孔徑圖資料表。
//2.CAM文件。
//3.LAM壓合結構參數表。
//*****************************************************************************************//
function check_PDM_DOC(pdm_type,no){
		var msg = &quot;&quot;;
	    var drill_artid =  &quot;ART02161244196748043&quot;;
		var cam_artid   =  &quot;ART02201244442914033&quot;;
	    var lam_artid   =  &quot;ART02171244440433073&quot;;
		
		if(pdm_type.equals(&quot;DRILL&quot;)){
			var sql_flag = &quot; select INSID from &quot;+ drill_artid +&quot;_INS where ITEM62 like &apos;%&quot;+ no +&quot;%&apos; AND ITEM155 = &apos;false&apos; &quot; ;
			var vector_ver = Client.SQLloadValue(sql_flag);
			if(vector_ver.size()&gt;0  ){					
			}else{				
				msg += &quot;無孔徑圖資料表,料號:&quot;+ no +&quot;,不能提出資料袋N!\n&quot;;
			}
		}
		if(pdm_type.equals(&quot;CAM&quot;)){
			var sql_flag = &quot; select INSID from &quot;+ cam_artid +&quot;_INS where ITEM62 like &apos;%&quot;+ no +&quot;%&apos; AND ITEM155 = &apos;false&apos; &quot; ;
			var vector_ver = Client.SQLloadValue(sql_flag);
			if(vector_ver.size()&gt;0  ){					
			}else{				
				msg += &quot;無CAM文件,料號:&quot;+ no +&quot;,不能提出資料袋N!\n&quot;;
			}
		}
		if(pdm_type.equals(&quot;LAM&quot;)){
			var sql_flag = &quot; select INSID from &quot;+ lam_artid +&quot;_INS where ITEM62 like &apos;%&quot;+ no +&quot;%&apos; AND ITEM155 = &apos;false&apos; &quot; ;
			var vector_ver = Client.SQLloadValue(sql_flag);
			if(vector_ver.size()&gt;0  ){					
			}else{				
				msg += &quot;無壓合結構參數表,料號:&quot;+ no +&quot;,不能提出資料袋N!\n&quot;;
			}
		}		
		if(msg != &quot;&quot;){
			Form.setComplete(false);
			Form.showMessageDialog(msg);
		}	
}


//===================================================================
// 檢查索引卡是否出庫未簽入
// D=草稿
//===================================================================	
function check_temp(){
		        var STATUS = &quot;&quot;;
				var msg = &quot;&quot;;
		        var MyTask = Form.getCurrentTask();
                var rootid = MyTask.getRootID();
                var vec = Client.getSubTaskList(rootid);
				var doc_id= Form.getValue(&quot;Doc_ID&quot;);
				var ver_id= Form.getValue(&quot;Ver_ID&quot;);
				var conn = Client.createSessionConnection(&quot;EKM&quot;);			
				var vec =  conn.loadValue(&quot; select c.Name,t.Name Type,v.*,g.G_name  from ekm.TECHDOC_VERSION v,ekm.ELAND_CATEGORY c ,ekm.TECHDOC_TYPE t,ekm.EIP_GROUP g  where  v.CATEGORY_ID = c.CATEGORY_ID(+)  and v.Type_ID = t.Type_ID(+)  and v.reserve_dept = g.g_id(+)  and ( doc_id,ver_id ) in  (  select doc_id,max(ver_id) from ekm.TECHDOC_VERSION  where doc_id like &apos;&quot; + doc_id + &quot;&apos; group by  doc_id )&quot; );
				if(vec != null &amp;&amp; vec.size()&gt;0){	
					STATUS = vec.get(0).get(&quot;status&quot;).trim() ;
					ver_id = vec.get(0).get(&quot;ver_id&quot;).trim() ;
					var creator_id = vec.get(0).get(&quot;Creator&quot;);
					var SUB_SUBJECT = vec.get(0).get(&quot;sub_subject&quot;).trim() ;
					var SUBJECT = vec.get(0).get(&quot;subject&quot;).trim() ;
					Form.setValue(&quot;Ver_ID&quot;,ver_id); 
					Form.setValue(&quot;Sub_Subject&quot;,SUB_SUBJECT); 
					Form.setValue(&quot;SUBJECT&quot;,SUBJECT); 
				}
				conn.close();
				if(STATUS.equals(&quot;D&quot;)){
					msg += &quot;文件已被重工,請檢查文件檔案是否已重工入庫!\n&quot;;
				}else{
				}
				if(msg != &quot;&quot;){
					Form.setComplete(false);
					Form.showMessageDialog(msg);
				}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00171250755035117</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/05/22 16:42:38</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Server.ProcessTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00171250755035117</string> 
     </void> 
     <void property="name"> 
      <string>ProcessTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00101250755035086</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//com.A.Common.Server.ProcessTable
//========================================================================================
//	取出彙整的會簽內容
//========================================================================================
function mergeAddAsInfo() {
	 Server.addDebugLog(&quot;call com.A.Common.Server.ProcessTable.mergeAddAsInfo 取出彙整的會簽內容&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	//將會簽結果放入審核意見裡面
	var taskmemberlist  = MyTask.getAddASAuditList() ; 
	var totalResult 	= MyTask.getAddASResultString();  				//取得加會簽結果的字串 
	var detailResult    = Server.parseAddASResultString(totalResult);   //將加會簽結果的字串解析成個別的物件形式 
	var flg_rejcet = false;
	Server.addDebugLog(&quot;作廢申請單取得加會簽人員筆數---&gt;&quot;+detailResult.size());
	  //------------------------------------------------------------------------------------------
	  // 20080107 cc
	  //因 aCSResultData.getMsg(); //簽核意見的api會有切割不完整的問題，改 function 來抓會簽意見
		  var tag = &quot;========================================================&quot;;
		  var msgarray = SplitString(totalResult,tag);
		  var resultarray = SplitResultString(totalResult,tag);
	  //------------------------------------------------------------------------------------------	
	for(var i = 0; i&lt; detailResult.size(); i++){
		var aCSResultData = detailResult.get(i);
		var aresult = resultarray[i];
		if(aresult.startsWith(&quot;] :&quot;)){
			//沒意見的情況下
			aresult = &quot;沒意見&quot;;
		}
		insertTableByAddAs(aCSResultData,aresult,msgarray[i],&quot;Process_Table&quot;);
		//insertTableByAddAs(aCSResultData,resultarray[i],msgarray[i],&quot;Process_Table&quot;);
		if(&quot;不同意&quot; == resultarray[i]){
			flg_rejcet = true; 
		}
	}
	if(flg_rejcet){
		//會簽中只要有一人駁回就是要駁回
		dataMap.put(&quot;Add_Sign_Reject&quot;,&quot;true&quot;);
	}
}

//========================================================================================
// 把簽核結果加至簽核紀錄表格中
//========================================================================================
function insertTableByAddAs(aCSResultData,addasResult,msg,tableName) {
	var aInstance = MyTask.getArtInstance();
	// 整理會簽資料
	var addasDep    = aCSResultData.getDep();
	var addasRole   = aCSResultData.getRole();
	var tmpName 	= aCSResultData.getName();
	var addasTime	= aCSResultData.getTime(&quot;yyyy/MM/dd HH:mm&quot;);
	var addasName   = tmpName.substring(0,tmpName.indexOf(&quot;(&quot;)); //只能拿到姓名，沒有工號可用
	//var addasMsg    = aCSResultData.getMsg(); //簽核意見
	var addasMsg    = msg; //簽核意見

	// 將會簽結果放入審核意見裡面
	var appDataMap = aInstance.getAppDataMap();
	var records = appDataMap.get(tableName);
	var row = new Packages.java.util.HashMap();
	row.put(&quot;ITEM7&quot;, records.size() + 1 + &quot;&quot;);
	row.put(&quot;ITEM5&quot;, addasTime);
	row.put(&quot;ITEM8&quot;, &quot;會簽單位&quot;);
	row.put(&quot;ITEM6&quot;, addasDep);
	row.put(&quot;ITEM9&quot;, addasRole);
	row.put(&quot;ITEM4&quot;, addasName);
	var l_member = Server.getMemberByCName(addasName);
	var l_id = l_member.getMyID();				
	row.put(&quot;ITEM2&quot;, l_id); //工號
	row.put(&quot;ITEM3&quot;, addasResult);
	row.put(&quot;ITEM1&quot;, addasMsg);
	row.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID
	records.add(records.size(), row);
	appDataMap.put(tableName, records);
	aInstance.setAppDataMap(appDataMap);
	Server.updateArtInstance(aInstance);
}	
//==============================
//下 SQL 語法可能遇到的特殊字元
//==============================

function replaceString(s){
	var s1 = java.lang.String(s);
	s1.replaceAll(&quot;&apos;&quot;,&quot;&apos;&apos;&quot;);
	return s1;
}

/**
 * 拆分字串到陣列，分割符可使用多個字符或者中文
 * 建立日期：(2001-7-10 14:50:31)
 * @param fieldsru java.lang.String 輸入參數：待拆分字符串
 * @param tag java.lang.String      輸入參數：分割符
 * @exception java.lang.Exception 異常說明。
 * @exception java.io.IOException 異常說明。
 */
function SplitString(fieldsru,tag){
	try{
	var returnarray = fieldsru.split(tag);
	// 加會意見： [Mon Jan 07 11:18:21 CST 2008] [徐正芳(徐正芳),廠/處長,人力資源處] :不同意 駁回測試 
	for(var t=0;t&lt;returnarray.length-1;t++){
		var temp_index = returnarray[t].indexOf(&quot;] :&quot;);
		if(temp_index&gt;0){
			returnarray[t] = returnarray[t].substring(temp_index);
			var n = 1 + returnarray[t].indexOf(&quot;\n&quot;);
			if(n&gt;0){
				returnarray[t] = returnarray[t].substring(n);
			}
		}
	}
	return returnarray;
	}catch (e)	{
		//java.lang.System.out.println(e.getMessage());
	}
	return null;
}

function SplitResultString(fieldsru,tag){
	try{
	var returnarray = fieldsru.split(tag);
	// 加會意見： [Mon Jan 07 11:18:21 CST 2008] [徐正芳(徐正芳),廠/處長,人力資源處] :不同意 駁回測試 
	for(var t=0;t&lt;returnarray.length-1;t++){
		var temp_index = returnarray[t].indexOf(&quot;] :&quot;);
		if(temp_index&gt;0){
			returnarray[t] = returnarray[t].substring(temp_index);
			var n = returnarray[t].indexOf(&quot;\n&quot;);
			if(n&gt;4){
				returnarray[t] = returnarray[t].substring(3,n);
			}
		}
	}
	return returnarray;
	}catch (e)	{
		//java.lang.System.out.println(e.getMessage());
	}
	return null;
}

//=========================================
//將簽核區資訊放入簽核歷程表格
//=========================================
function setProcessTable(){
	var depid = MyTask.getDepartmentID();
	var dep = Server.getDepartment(depid);
//	var rMember = Server.getMember(MyTask.getRealExecutor());   	//執行者
	var rMember = Server.getMemberByID(MyTask.getRealExecutor());   	//執行者 modi by wangwei@2012/10/11
	var roleTitle = rMember.getJobTitle();
	var department = &quot;x&quot;;
	if(dep != null){
		department = dep.getName();
	}else{  														//抓不到部門(可能是專案職務)，就抓主要職務的部門
		var roleID = rMember.getMainRoleID();
		var memDR = rMember.getMemberDR(roleID);
		var department = memDR.getDepartmentName();	 				//使用者部門名稱
	}
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
	var roleid = Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
	dataMap.put(&quot;From_User_Role_ID&quot;, roleid);	
	//var name = aInstance.getAppValue(&quot;Verify_Name&quot;);
	//20130515 modify by edison
	var name = rMember.getName();
	var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
	var isAgree = true;
	if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))) {
		isAgree = false;
	}
	roleTitle = getTitle(dataMap,name,roleTitle)			// add by wangwei@2015/09/24
	appendProcessTable(department, roleTitle, name, isAgree, reason);
//	appendProcessTableIP(department, roleTitle, name, isAgree, reason);	 // 2018/02/08
}
//=========================================
//簽核歷程表格加入一筆
//=========================================
function appendProcessTable(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數	
	var member = Server.getMemberByCName(name);
	var id = member.getMyID();
	var vApp_Name = aInstance.getAppValue(&quot;App_Name&quot;);  // add by wangwei 2008/05/27 
	//加入代理人資訊 20070625
	if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
		name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
// --------若是代理且被代理的人的職等比代理人的職等高則以被代理人的職等帶入 modi by wangwei@2009/11/23		
		var vMemRoleID=Server.getMember(MyTask.getMemberID()).getMainRoleID() ;
		var vExeRoleID=Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
		Server.addDebugLog(name + &quot;MemRoleID:&quot;+vMemRoleID + &quot;ExeRoleID:&quot;+vExeRoleID);
		if( vMemRoleID.substring(7,10)  &gt;= vExeRoleID.substring(7,10)|| vExeRoleID.substring(7,10)&lt;= formDataMap.get(&quot;Verify_Level&quot;)){	// 原簽核者的職級&gt;實際簽核者					
			formDataMap.put(&quot;From_User_Role_ID&quot;,Server.getMember(MyTask.getMemberID()).getMainRoleID()) ;
			formDataMap.put(&quot;From_User_ID&quot;,MyTask.getMemberID()) ;  		// add by wangwei@2012/04/03
			Server.addDebugLog(name+ &quot;且重設From_User_Role_ID:&quot;+ Server.getMember(MyTask.getMemberID()).getMainRoleID() +&quot; From_User_ID:&quot;+MyTask.getMemberID());
		}
// ------------		
	}		
	var hm = java.util.HashMap();
	var proName = MyTask.getProcessName();//關卡名稱
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
	hm.put(&quot;ITEM6&quot;, department);//Department 部門
	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
	hm.put(&quot;ITEM2&quot;, id);//ID 工號	
	hm.put(&quot;ITEM4&quot;, name);//Name 姓名
	if (isAgree == true) {
		hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		//hm.put(&quot;ITEM2&quot;,&quot;false&quot;);
		if(rowCount == 0){
			hm.put(&quot;ITEM3&quot;,&quot;提出&quot;);//同意
		}else{			
			// 找出Process_Table序號為1的關卡名稱與目前關卡名稱比較是否為再提出 970929 	
			for(var i=0;i&lt;rowCount;i++){
				var rowData = vecTableData.get(i);
				var rowProcessNo = rowData.get(&quot;ITEM7&quot;);	
				if(rowProcessNo.equals(&quot;1&quot;)||rowProcessNo==&quot;1&quot;){
					var rowProcessName = rowData.get(&quot;ITEM8&quot;);
					if(proName.indexOf(rowProcessName) &gt;= 0){
						hm.put(&quot;ITEM3&quot;,&quot;再提出&quot;);//同意	
						break;
					}
				}
			}
		}
	} else {	
		  hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);
		//hm.put(&quot;ITEM2&quot;,&quot;true&quot;);
	}
	
	hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
	hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
// --- add by wangwei@2018/02/05	增加記錄簽核者IP位置
	var vAddress = 	formDataMap.get(&quot;IP&quot;);
	if(null!=vAddress&amp;&amp; !vAddress.equals(&quot;&quot;) ){
		hm.put(&quot;ITEM11&quot;, vAddress);		//-------------------------		
	}
	formDataMap.put(&quot;IP&quot;,&quot;&quot;);   		// 清空,避免有時間控制的關卡取到上一關的 add by wangwei @2018/02/08
	vecTableData.add(rowCount,hm);
	aInstance.setAppValue(&quot;Process_Table&quot;,vecTableData);
//		formDataMap.put(&quot;Agree&quot;,&quot;true&quot;);
//		formDataMap.put(&quot;Reject&quot;,&quot;false&quot;);
//因加入此段會造成判斷流程線錯誤(永遠為Agree==true),故改寫在loadLibrary(&quot;com.A.Common.Server.VerifyNote&quot;);	setVerifyName();
//mody by edison@20120605
		formDataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
}

//=========================================
//審核關卡若是代理人代審時在表單上fieldName欄位註記,原欄位內容向下推一行
//=========================================
function checkDeputySign(fieldName) {
	var mID = MyTask.getMemberID(); //會抓到真正task owner
	var realID = MyTask.getRealExecutor();//目前Task 的執行者member id
	if (!mID.equals(realID)) {
		var realMember = Client.getMemberByID(realID);
		Form.setValue(fieldName, &quot;本工作為由代理人 &quot; + realMember.getName() + &quot; 處理\n&quot; +  Form.getValue(fieldName));
	}
}

//=========================================
//
//=========================================
    function getFormatedCurrentTime(){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
        return simpledateformat.format(date);
    }

//---------
// 用於動態加會簽時寫回簽核紀錄
function setProcessTableEx(){
//	var department = Server.getDepartment(MyTask.getDepartmentID()).getName();
	var depid = MyTask.getDepartmentID();
	var dep = Server.getDepartment(depid);
	var rMember = Server.getMember(MyTask.getRealExecutor()); //執行者
	var roleTitle = rMember.getJobTitle();
	var department = &quot;x&quot;;
	if(dep != null){
		department = dep.getName();
	}else{
		//抓不到部門(可能是專案職務)，就抓主要職務的部門
		var roleID = rMember.getMainRoleID();
		var memDR = rMember.getMemberDR(roleID);
		var department = memDR.getDepartmentName();	//使用者部門名稱
	}
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
		//Set 流程控制
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
	var roleid = Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
		dataMap.put(&quot;From_User_Role_ID&quot;, roleid);	
	var name = aInstance.getAppValue(&quot;Verify_Name&quot;);
		if(!rMember.getName().equals(name)){
			return ;
			}
	var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
	var isAgree = true;
	if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))|| &quot;true&quot;.equals(aInstance.getAppValue(&quot;con_Reject&quot;))   ) {
		isAgree = false;
	}
	roleTitle = getTitle(dataMap,name,roleTitle)			// add by wangwei@2015/09/24
	appendProcessTableEx(department, roleTitle, name, isAgree, reason);
}
//=========================================
//簽核歷程表格加入一筆  add by wangwei 2008/12/09
//=========================================
function appendProcessTableEx(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數
	var member = Server.getMemberByCName(name);
	var id = member.getMyID();
	//加入代理人資訊 20070625
	if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
		name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
// --------若是代理且被代理的人的職等比代理人的職等高則以被代理人的職等帶入 modi by wangwei@2009/11/23		
		var vMemRoleID=Server.getMember(MyTask.getMemberID()).getMainRoleID() ;
		var vExeRoleID=Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
		if( vMemRoleID.substring(7,10)  &gt;= vExeRoleID.substring(7,10) ){
			formDataMap.put(&quot;From_User_Role_ID&quot;,Server.getMember(MyTask.getMemberID()).getMainRoleID()) ;
		}
// ------------			
	}
	var hm = java.util.HashMap();
	var proName = MyTask.getProcessName();//關卡名稱  
	if( proName.indexOf(&quot;]&quot;) &gt; 0 ){
		proName=proName.substring(proName.indexOf(&quot;]&quot;)+1,proName.length());  // 若有[關卡名稱]則只取真正的關卡名稱
	}
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
	hm.put(&quot;ITEM6&quot;, department);//Department 部門
	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
	hm.put(&quot;ITEM2&quot;, id);//ID 工號	
	hm.put(&quot;ITEM4&quot;, name);//Name 姓名
	if (isAgree == true) {
		hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		if(rowCount == 0){
			hm.put(&quot;ITEM3&quot;,&quot;提出&quot;);//同意
		}
	} else {
		hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);
	}
	hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
	hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
	vecTableData.add(rowCount,hm);
	aInstance.setAppValue(&quot;Process_Table&quot;,vecTableData);

}
	


//---------
// 用於動態加會簽時寫回簽核紀錄 For 子流程始用 20090507
function setProcessTableEx_A(){
//	var department = Server.getDepartment(MyTask.getDepartmentID()).getName();
	var depid = MyTask.getDepartmentID();
	var dep = Server.getDepartment(depid);
	var rMember = Server.getMember(MyTask.getRealExecutor()); //執行者
	var roleTitle = rMember.getJobTitle();
	var department = &quot;x&quot;;
	if(dep != null){
		department = dep.getName();
	}else{
		//抓不到部門(可能是專案職務)，就抓主要職務的部門
		var roleID = rMember.getMainRoleID();
		var memDR = rMember.getMemberDR(roleID);
		var department = memDR.getDepartmentName();	//使用者部門名稱
	}
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
		//Set 流程控制
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
	var roleid = Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
		dataMap.put(&quot;From_User_Role_ID&quot;, roleid);	
	var name = aInstance.getAppValue(&quot;Verify_Name&quot;);
		if(!rMember.getName().equals(name)){
			return ;
			}
	var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
	var isAgree = true;
	if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))|| &quot;true&quot;.equals(aInstance.getAppValue(&quot;con_Reject&quot;))   ) {
		isAgree = false;
	}
	roleTitle = getTitle(dataMap,name,roleTitle)			// add by wangwei@2015/09/24
	appendProcessTableEx_A(department, roleTitle, name, isAgree, reason);
}
//=========================================
//簽核歷程表格加入一筆  For 子流程始用 20090507
//=========================================
function appendProcessTableEx_A(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;Process_Table_A&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數
	var member = Server.getMemberByCName(name);
	var id = member.getMyID();
	//加入代理人資訊 20070625
	if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
		name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
	}
	var hm = java.util.HashMap();
	var proName = MyTask.getProcessName();//關卡名稱  
	if( proName.indexOf(&quot;]&quot;) &gt; 0 ){
		proName=proName.substring(proName.indexOf(&quot;]&quot;)+1,proName.length());  // 若有[關卡名稱]則只取真正的關卡名稱
	}
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
	hm.put(&quot;ITEM6&quot;, department);//Department 部門
	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
	hm.put(&quot;ITEM2&quot;, id);//ID 工號	
	hm.put(&quot;ITEM4&quot;, name);//Name 姓名
	if (isAgree == true) {
		hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		if(rowCount == 0){
			hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		}
	} else {
		hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);
	}
	hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
	hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
	vecTableData.add(rowCount,hm);
	aInstance.setAppValue(&quot;Process_Table_A&quot;,vecTableData);
//	formDataMap.put(&quot;Agree&quot;,&quot;true&quot;);
//	formDataMap.put(&quot;Reject&quot;,&quot;false&quot;);
//	formDataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
}
	
//==============================================================	
// Server 將CurrentTask 會簽結果放入審核意見裡面
// 20090220-1 cc
//==============================================================	
	function setSignTableResult(){
			var aInstance = MyTask.getArtInstance();
			var dataMap = aInstance.getAppDataMap();
			var vecTableData = dataMap.get(&quot;Process_Table&quot;);
			var rowCount = vecTableData.size();//vecTableData裡資料筆數	
          //將會簽結果放入審核意見裡面
          var taskmemberlist = MyTask.getAddASAuditList() ; 
          var TotalResult =MyTask.getAddASResultString(); //取得加會簽結果的字串
		  
		  //------------------------------------------------------------------------------------------
		  // 20080107 cc
		  //因 aCSResultData.getMsg(); //簽核意見的api會有切割不完整的問題，改 function 來抓會簽意見
		  var tag = &quot;========================================================&quot;;
		  var msg = SplitString(TotalResult,tag);
		  //------------------------------------------------------------------------------------------
          var detailresult =Server.parseAddASResultString(TotalResult);   //將加會簽結果的字串解析成個別的物件形式 
		  var flg_reject = false;
		  if(detailresult.size()&gt;0){
			  for(var i = 0; i&lt; detailresult.size(); i++){
				try{
					var flg = true;	      
					var aCSResultData = detailresult.get(i);
					var l_time = aCSResultData.getTime(&quot;yyyy/MM/dd HH:mm&quot;);
					var l_name = aCSResultData.getName(); //只能拿到姓名，沒有工號可用
					var l_role = aCSResultData.getRole(); //職稱
					var l_dep = aCSResultData.getDep();
					l_name = l_name.substring(0,l_name.indexOf(&quot;(&quot;));
					//var l_msg = aCSResultData.getMsg(); //簽核意見
					var l_msg = msg[i]; //簽核意見
					var l_result = &quot;未表示&quot;;
					if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Agree&quot;)){
						l_result = &quot;同意&quot;;
					}else if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Disagree&quot;)||aCSResultData.getSignResult().equalsIgnoreCase(&quot;reject&quot;)){
						l_result = &quot;不同意&quot;;
						flg_reject = true ;
					}
					for (var j=0;j&lt;vecTableData.size() ;j++){
						//check 會簽人的工號+簽核時間有無在 SingTable 內，有的話就 update table 內的簽核及審核意見
						//如果不在 table 內就加到最後
						t_name = vecTableData.get(j).get(&quot;ITEM4&quot;) ;//process_table.getValueAt(j,&quot;姓名&quot;);
						t_yes =  vecTableData.get(j).get(&quot;ITEM3&quot;); // process_table.getValueAt(j,&quot;是否核准&quot;);
						t_time = vecTableData.get(j).get(&quot;ITEM5&quot;); //process_table.getValueAt(j,&quot;審核日期&quot;);
						if (l_name.equals(t_name)&amp;&amp; l_time.equals(t_time)){
							vecTableData.get(j).put(&quot;ITEM5&quot;,l_msg);//ITEM5 審核意見
							vecTableData.get(j).put(&quot;ITEM3&quot;,l_result);//(l_result,j,&quot;是否核准&quot;);//同意
							//j = process_table.getRowCount();//跳出 for j
							flg = false;
						}
					}//for j
		
					if(flg == true){
						//不在 table 內就加到最後
									var hm = java.util.HashMap();
									var l_member = Server.getMemberByCName(l_name);
									var l_id = l_member.getMyID();	
									var proName = &quot;*動態加會簽&quot;;//關卡名稱
									hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
									hm.put(&quot;ITEM7&quot;,(vecTableData.size()+1)+&quot;&quot;);//Serial Number 序號
									hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
									hm.put(&quot;ITEM6&quot;, l_dep);//Department 部門
									hm.put(&quot;ITEM9&quot;, l_role);//Title 職稱
									hm.put(&quot;ITEM2&quot;, l_id);//ID 工號	
									hm.put(&quot;ITEM4&quot;, l_name);//Name 姓名
									if (&quot;同意&quot; == l_result) {
										hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
										//hm.put(&quot;ITEM2&quot;,&quot;false&quot;);
										if(rowCount == 0){
											hm.put(&quot;ITEM3&quot;,&quot;提出&quot;);//同意
										}else{			
											// 找出Process_Table序號為1的關卡名稱與目前關卡名稱比較是否為再提出 970929 	
											for(var i=0;i&lt;rowCount;i++){
												var rowData = vecTableData.get(i);
												var rowProcessNo = rowData.get(&quot;ITEM7&quot;);	
												java.lang.System.out.println(&quot;rowProcessNo:&quot;+rowProcessNo);
												if(rowProcessNo.equals(&quot;1&quot;)||rowProcessNo==&quot;1&quot;){
													var rowProcessName = rowData.get(&quot;ITEM8&quot;);
													if(proName.indexOf(rowProcessName) &gt;= 0){
														hm.put(&quot;ITEM3&quot;,&quot;再提出&quot;);//同意	
														break;
													}
												}
											}
										}
									} else {	
										  hm.put(&quot;ITEM3&quot;,l_result);
									}
									
									hm.put(&quot;ITEM1&quot;, l_msg);//Opinion 意見
									hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
									vecTableData.add(vecTableData.size(),hm);
									aInstance.setAppValue(&quot;Process_Table&quot;,vecTableData);
//										formDataMap.put(&quot;Agree&quot;,&quot;true&quot;);
//										formDataMap.put(&quot;Reject&quot;,&quot;false&quot;);
//										formDataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
						}
					}catch(e){}
					
				}//for i
			}
	}
//=========================================
// 觸發子流程... write by CC 
//將會簽單簽核區資訊放入簽核歷程表格
//=========================================
function setProcessTable_ext(){
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap();
		var depid = MyTask.getDepartmentID();
		var dep = Server.getDepartment(depid);
		var rMember = Server.getMember(MyTask.getRealExecutor()); //執行者
		var roleTitle = rMember.getJobTitle();
		var department = &quot;x&quot;;
		if(dep != null){
			department = dep.getName();
		}else{
			//抓不到部門(可能是專案職務)，就抓主要職務的部門
			var roleID = rMember.getMainRoleID();
			var memDR = rMember.getMemberDR(roleID);
			var department = memDR.getDepartmentName();	//使用者部門名稱
		}
		var aInstance = MyTask.getArtInstance();
		var dataMap = aInstance.getAppDataMap();
			//Set 流程控制
			dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
		var roleid = Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
			dataMap.put(&quot;From_User_Role_ID&quot;, roleid);	
		var name = aInstance.getAppValue(&quot;Verify_Name&quot;);
		var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
		var isAgree = true;
		if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))) {
			isAgree = false;
		}
		roleTitle = getTitle(dataMap,name,roleTitle)			// add by wangwei@2015/09/24
		appendProcessTable_ext(department, roleTitle, name, isAgree, reason);
}
//=========================================
//簽核歷程表格加入一筆
//=========================================
function appendProcessTable_ext(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var Source_Ins_ID = formDataMap.get(&quot;Source_Ins_ID&quot;);
	var Source_Ins = Server.getArtInstance(Source_Ins_ID);
	if(Source_Ins != null){	
		var source_dataMap = Source_Ins.getAppDataMap();		
		var vecTableData = source_dataMap.get(&quot;Process_Table&quot;);
		var rowCount = vecTableData.size();//vecTableData裡資料筆數
		var member = Server.getMemberByCName(name);
		var id = member.getMyID();
		//因自動關卡exeid=memid,故改抓前一關傳來之真實簽核人員姓名比對原本簽核人員姓名 add by edison@20120723
		if(! name.equals(Server.getMemberByID(MyTask.getMemberID()).getName())){
			name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
		}	
		var hm = java.util.HashMap();
		var proName = MyTask.getProcessName();//關卡名稱
		hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
		hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
		hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
		hm.put(&quot;ITEM6&quot;, department);//Department 部門
		hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
		hm.put(&quot;ITEM2&quot;, id);//ID 工號	
		hm.put(&quot;ITEM4&quot;, name);//Name 姓名
		if (isAgree == true) {
			hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
			//hm.put(&quot;ITEM2&quot;,&quot;false&quot;);
			if(rowCount == 0){
				hm.put(&quot;ITEM3&quot;,&quot;提出&quot;);//同意
			}
		} else {
			hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);
			//hm.put(&quot;ITEM2&quot;,&quot;true&quot;);
		}
		hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
		hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
		vecTableData.add(rowCount,hm);
		Source_Ins.setAppValue(&quot;Process_Table&quot;,vecTableData);
		Server.updateArtInstance(Source_Ins);
	}
}
	
//=========================================
//從加會簽table取出會簽資訊
//=========================================	
function insertTableBy_AddTask(content){	
	var tskid = MyTask.getID();
	
	var sql = &quot;select tskid,addsignresult,announcecontent,&quot;;
	    sql +=&quot;to_char( (to_date(&apos;01-01-1970&apos;,&apos;DD-MM-YYYY&apos; ) + (signtime+(8*60*60*1000)) / 86400000),&apos;yyyy/mm/dd hh24:mi&apos;) as signtime &quot;;
		sql +=&quot;from add_task where signtskid=&apos;&quot;+tskid+&quot;&apos; and signtskid&lt;&gt;tskid order by signtime&quot;;
	var rs = Server.SQLloadValue(sql);
	if(rs!=null &amp;&amp; rs.size()&gt;0){
		for(var i=0;i&lt;rs.size();i++){
			insertResultTable(rs.get(i).get(&quot;tskid&quot;),rs.get(i).get(&quot;addsignresult&quot;),rs.get(i).get(&quot;announcecontent&quot;),rs.get(i).get(&quot;signtime&quot;),content);
		}		
	}

}	
//=========================================
//寫入簽核紀錄table
//=========================================	
function insertResultTable(s1,s2,s3,s4,s5){
	var aInstance = MyTask.getArtInstance();
	var sql =&quot;select exeid from task where tskid=&apos;&quot;+s1+&quot;&apos;&quot;;
	var vec = Server.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		var exeid = vec.get(0).get(&quot;exeid&quot;);
		var member = Server.getMember(exeid);
		var cname = member.getName();
		var id = member.getMyID();
		var memid = member.getID();
		var jobtitle = member.getJobTitle();
		var roleID = member.getMainRoleID();
		var memDR = member.getMemberDR(roleID);
		var sDepName = memDR.getDepartmentName();	//使用者部門名稱
		var sDepID = Server.getDepartment(memDR.getDepartmentID()).getMyID();
		var appDataMap = aInstance.getAppDataMap();
		var records = appDataMap.get(&quot;Process_Table&quot;);
		var row = new Packages.java.util.HashMap();
		if(s2.equals(&quot;Disagree&quot;)){
			s2 =&quot;不同意&quot;;
		}else{
			s2 =&quot;同意&quot;;
		}
		var Verify_Name = appDataMap.get(&quot;Verify_Name&quot;);	
	    var dcc_id =Server.getMemberByCName(Verify_Name).getID();
		if(memid!=dcc_id){//是加會簽的三廠文管人員才寫入簽核紀錄
			row.put(&quot;ITEM7&quot;, records.size() + 1 + &quot;&quot;);
			row.put(&quot;ITEM5&quot;, s4);
			row.put(&quot;ITEM8&quot;, s5);
			row.put(&quot;ITEM6&quot;, sDepName);
			row.put(&quot;ITEM9&quot;, jobtitle);
			row.put(&quot;ITEM4&quot;, cname);		
			row.put(&quot;ITEM2&quot;, id); //工號
			row.put(&quot;ITEM3&quot;, s2);
			row.put(&quot;ITEM1&quot;, s3);
			row.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID
			records.add(records.size(), row);
			appDataMap.put(&quot;Process_Table&quot;, records);
			aInstance.setAppDataMap(appDataMap);
			Server.updateArtInstance(aInstance);
		}		
	}	
}
	
//取得簽核記錄(含排序)
function getProcessTable(){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	var ProcTable = dataMap.get(&quot;Process_Table&quot;);
	var col = &quot;ITEM7&quot;;
	//以下處理排序，解決順序會亂跑的問題。(source by flowring forum)
	var vec = java.util.Vector();
	 for(var l = 0, p = ProcTable.size(); l &lt; p; l++){
		 var rowData = ProcTable.get(l);
		 var ID = rowData.get(col);
		 rowData.put(col, ID);
		 vec.add(rowData);
	 }
    var LList = new java.util.LinkedList();
	 for(var a = 0, b = vec.size(); a &lt; b; a++){
		 insertNum = vec.get( a ).get(col);  
		 if(LList.size() == 0){
			 LList.add(0, vec.get( a ));
			 continue;
		 }	  
		 for(var i = 0, j = LList.size(); i &lt; j; i ++){
			  if(insertNum &lt; LList.get( i ).get(col)){
				  LList.add(0, vec.get( a ));
				  break;
			}else if(i+1 &lt; j){ 
				if(insertNum &gt;= LList.get( i ).get(col) &amp;&amp; insertNum &lt; LList.get(i+1).get(col)){
					LList.add(i+1, vec.get( a ));
					break;
				}
			}else if(i+1 &gt;= j){
				LList.addLast(vec.get( a ));
				break;
			}
		}
	 }
    var newSignTable = java.util.Vector();
	 for(var r = 0, s = LList.size(); r &lt; s; r++){
	  newSignTable.add(LList.get(r));
	  var signTime = LList.get(r).get(col).toString();
	  LList.get(r).put(col, signTime);
	}
	return newSignTable;	
}

// 因有主管在海外職稱不一樣目前只能暫時 add by wangwei@2015/09/24
function getTitle(dataMap,vName,vTitle){
	var vReturn = vTitle ;

	return vReturn;	
}

//=========================================
// 將簽核區資訊放入簽核歷程表格 2018/02/08
// copy from setProcessTable()
// then call appendProcessTableIP
//=========================================
function setProcessTableIP(){
	var depid = MyTask.getDepartmentID();
	var dep = Server.getDepartment(depid);
	var rMember = Server.getMemberByID(MyTask.getRealExecutor());   	//執行者 modi by wangwei@2012/10/11
	var roleTitle = rMember.getJobTitle();
	var department = &quot;x&quot;;
	if(dep != null){
		department = dep.getName();
	}else{  														//抓不到部門(可能是專案職務)，就抓主要職務的部門
		var roleID = rMember.getMainRoleID();
		var memDR = rMember.getMemberDR(roleID);
		var department = memDR.getDepartmentName();	 				//使用者部門名稱
	}
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
	var roleid = Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
	dataMap.put(&quot;From_User_Role_ID&quot;, roleid);	
	var name = rMember.getName();
	var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
	var isAgree = true;
	if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))) {
		isAgree = false;
	}
	roleTitle = getTitle(dataMap,name,roleTitle)			// add by wangwei@2015/09/24
	appendProcessTableIP(department, roleTitle, name, isAgree, reason);
}

//=========================================
//簽核歷程表格加入一筆
// 增加IP欄位
//=========================================
function appendProcessTableIP(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數	
	var member = Server.getMemberByCName(name);
	var id = member.getMyID();
	var vApp_Name = aInstance.getAppValue(&quot;App_Name&quot;);  // add by wangwei 2008/05/27 
	//加入代理人資訊 20070625
	if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
		name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
// --------若是代理且被代理的人的職等比代理人的職等高則以被代理人的職等帶入 modi by wangwei@2009/11/23		
		var vMemRoleID=Server.getMember(MyTask.getMemberID()).getMainRoleID() ;
		var vExeRoleID=Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
		Server.addDebugLog(name + &quot;MemRoleID:&quot;+vMemRoleID + &quot;ExeRoleID:&quot;+vExeRoleID);
		if( vMemRoleID.substring(7,10)  &gt;= vExeRoleID.substring(7,10)|| vExeRoleID.substring(7,10)&lt;= formDataMap.get(&quot;Verify_Level&quot;)){	// 原簽核者的職級&gt;實際簽核者					
			formDataMap.put(&quot;From_User_Role_ID&quot;,Server.getMember(MyTask.getMemberID()).getMainRoleID()) ;
			formDataMap.put(&quot;From_User_ID&quot;,MyTask.getMemberID()) ;  		// add by wangwei@2012/04/03
			Server.addDebugLog(name+ &quot;且重設From_User_Role_ID:&quot;+ Server.getMember(MyTask.getMemberID()).getMainRoleID() +&quot; From_User_ID:&quot;+MyTask.getMemberID());
		}
// ------------		
	}		
	var hm = java.util.HashMap();
	var proName = MyTask.getProcessName();//關卡名稱
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
	hm.put(&quot;ITEM6&quot;, department);//Department 部門
	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
	hm.put(&quot;ITEM2&quot;, id);//ID 工號	
	hm.put(&quot;ITEM4&quot;, name);//Name 姓名
	if (isAgree == true) {
		hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		if(rowCount == 0){
			hm.put(&quot;ITEM3&quot;,&quot;提出&quot;);//同意
		}else{			
			// 找出Process_Table序號為1的關卡名稱與目前關卡名稱比較是否為再提出 970929 	
			for(var i=0;i&lt;rowCount;i++){
				var rowData = vecTableData.get(i);
				var rowProcessNo = rowData.get(&quot;ITEM7&quot;);	
				if(rowProcessNo.equals(&quot;1&quot;)||rowProcessNo==&quot;1&quot;){
					var rowProcessName = rowData.get(&quot;ITEM8&quot;);
					if(proName.indexOf(rowProcessName) &gt;= 0){
						hm.put(&quot;ITEM3&quot;,&quot;再提出&quot;);//同意	
						break;
					}
				}
			}
		}
	} else {	
		  hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);
	}
	
	hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
	hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
// --- add by wangwei@2018/02/05	增加記錄簽核者IP位置
	var vAddress = 	formDataMap.get(&quot;IP&quot;);
	hm.put(&quot;ITEM11&quot;, vAddress);		//-------------------------	
	vecTableData.add(rowCount,hm);
	aInstance.setAppValue(&quot;Process_Table&quot;,vecTableData);

//因加入此段會造成判斷流程線錯誤(永遠為Agree==true),故改寫在loadLibrary(&quot;com.A.Common.Server.VerifyNote&quot;);	setVerifyName();
//mody by edison@20120605
		formDataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
}
//=========================================
//將簽核過人員存入清單中，作為判斷重複簽核使用 add by edison@20181213
//=========================================
function setAssignMemberList(flag){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	var memid = MyTask.getRealExecutor();
	if(dataMap.get(&quot;Reject&quot;)==&quot;true&quot;){
		if(flag==&quot;Y&quot;){//需將欄位清空
			dataMap.put(&quot;assignMemberList&quot;,&quot;&quot;);
		}else if(flag==&quot;N&quot;){//不需將欄位清空	
		}else{//
		}
	}else{
		var assignMemberList = dataMap.get(&quot;assignMemberList&quot;);
		if(assignMemberList.indexOf(memid)==-1){
			assignMemberList += memid +&quot;,&quot;;
			dataMap.put(&quot;assignMemberList&quot;,assignMemberList);
		}
	}
	
}
function setAutoProcessTable(artIns,memid,proName){
	var dataMap = artIns.getAppDataMap();
	var member = Server.getMemberByID(memid);
	var roleID = member.getMainRoleID();
	var memDR = member.getMemberDR(roleID);
	var sDepName = memDR.getDepartmentName();
	var date = new java.util.Date(java.lang.System.currentTimeMillis());
    var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
    var signTime = simpledateformat.format(date);		  
	var vecTableData = dataMap.get(&quot;Process_Table&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數
	var hm = java.util.HashMap();
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, signTime);//簽核時間
	hm.put(&quot;ITEM6&quot;, sDepName);//Department 部門
	hm.put(&quot;ITEM9&quot;, member.getJobTitle());//Title 職稱
	hm.put(&quot;ITEM2&quot;, member.getMyID());//ID 工號	
	hm.put(&quot;ITEM4&quot;, member.getName());//Name 姓名
	hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
	hm.put(&quot;ITEM1&quot;,&quot;(前面已簽核)&quot;);//Opinion 意見
	hm.put(&quot;ITEM10&quot;,&quot;&quot;);	//TaskID	
	vecTableData.add(rowCount,hm);
	artIns.setAppValue(&quot;Process_Table&quot;,vecTableData);

}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>簽核記錄
20070625 加入代理人資訊 
20071228 加入簽核記錄[處理時間][TaskID]</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00181250755035120</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/07/06 11:31:04</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Server.SendMail</string> 
     </void> 
     <void property="id"> 
      <string>SCL00181250755035120</string> 
     </void> 
     <void property="name"> 
      <string>SendMail</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00101250755035086</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
/**
 撤單(拉回前一關)時發出的 mail
 發給被撤的那一關(task.realexecutor)
 用於 Client
*/
function sendGoBackMail(MyTask){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Client.getMemberByID(&quot;Administrator&quot;).getEmail();  		
		var realexecutor_mail = Client.getMemberByID(MyTask.getRealExecutor()).getEmail();
		var to = realexecutor_mail;
		var cc=&quot;&quot;;
        var subject = &quot;[撤簽通知]&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot;所申請-&quot; + roottaskname + &quot;已被撤回&quot;; // Mail Subject 
		var text = getGoBackMailContent(dataMap,MyTask);
        var fileList = new Packages.java.util.Vector(); 
		if(to.indexOf(&quot;wtadmin&quot;) &lt; 0 &amp;&amp; to.indexOf(&quot;@gce&quot;) &gt;= 0){
			Client.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
		}
	}catch(e){
		Server.addErrLog(&quot;call sendGoBackMail Send mail Fail:&quot;+e);
	}
}
//-------------------
// 撤單通知內容
//-------------------
function getGoBackMailContent(dataMap,MyTask){
		//var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   [撤回通知]&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Client.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Client.getMemberByID(Client.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Client.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Client.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){
			Server.addErrLog(&quot;call getGoBackMailContent Send mail Fail:&quot;+e);
		}
		text += &quot;   &lt;br&gt;&quot;;		
		//text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;

		return text;
}

/**
 會簽時發出的 mail
*/
function sendCSMail(){
	var InsID = MyTask.getArtInstance();
	var dataMap = InsID.getAppDataMap();
	var cMember = Server.getMemberByID(MyTask.getMemberID());  // getMember modi by wangwei@2015/04/13
	var fromMail= Server.getMemberByID(&quot;Administrator&quot;).getEmail();//系統管理員為寄件者
	var toEMail = cMember.getEmail();
	var totalccMail = &quot;&quot;;
	var title = &quot;請會簽&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單&quot;;
	var urlData = &quot;&lt;a href=\&quot;$webAgendaURL$mailOpenFormCheckpass\&quot;&gt;會簽單&lt;/a&gt;&quot;;
	var data = &quot; 您好：&quot;+&quot;\n&quot;+&quot;\n&quot;;
	data = data + &quot;這是系統自動發出的一封通知信，請至 MyGCE 上進行會簽簽核，\n&quot;;
	data = data +&quot;表單內容為：&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單 \n&quot;;
	data = data +&quot;會簽簽核時請點選「加會意見」及請務必填寫「同意」或「不同意」\n&quot;;
   data = data + &quot; 您可以開啟 &quot;+urlData+&quot;，來查看該表單。&quot;+&quot;\n  \n \n   MIS &quot;;
   data = &quot;&lt;pre&gt;&quot;+data+&quot;&lt;/pre&gt;&quot;;
    var vector = new java.util.Vector();
     //taskID
    var taskID = MyTask.getID();  
    Server.sendHTMLMailExt(fromMail,toEMail,totalccMail,title,data,vector,taskID);  
 }

/**
 審核通過時發出的 mail
 通知申請者&amp;填單者
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
 20080502 mail to 名單加入 TableA 上的人員
*/
function sendAcceptMail(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMemberByID(&quot;Administrator&quot;).getEmail();  		
		var to = Server.getMemberByID(dataMap.get(&quot;App_MemID&quot;)).getEmail();        
		if( to.indexOf(&quot;wtadmin&quot;)&gt;= 0){
			to=&quot;&quot;;
		}
		var creator_mail = Server.getMemberByID(dataMap.get(&quot;Creator_ID&quot;)).getEmail();  //		
		if( to != creator_mail &amp;&amp;creator_mail.indexOf(&quot;wtadmin&quot;)&lt; 0){
			to += &quot;;&quot; + creator_mail;
		}
		to += &quot;;&quot; +getMailAddressTableA(dataMap);		
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 

		if ( dataMap.get(&quot;Cancel&quot;)== &quot;true&quot;){
               var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已作廢審核通過&quot;; // Mail Subject 
		}else{
		      var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 

		}
		var text = getAcceptMailContent(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		if(to.indexOf(&quot;@gce&quot;) &gt;= 0){ 			// 有可能是空的,當有值時再 send mail add by wangwei@2014/12/29
			Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
		}
	}catch(e){
		Server.addErrLog(&quot;call sendAcceptMail Error---------&quot;+e);
	}
}

/**
 審核通過時發出的 mail
 通知申請者&amp;填單者
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
 20080502 mail to 名單加入 TableA 上的人員
 copy from sendAcceptMail , 加上簽核流程中的人
*/
function sendAcceptMailExt(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMemberByID(&quot;Administrator&quot;).getEmail();  		
		var to = Server.getMemberByID(dataMap.get(&quot;App_MemID&quot;)).getEmail();
		if( to.indexOf(&quot;wtadmin&quot;) &gt;= 0){
			to=&quot;&quot;;
		}
		var creator_mail = Server.getMemberByID(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail &amp;&amp; creator_mail.indexOf(&quot;wtadmin&quot;) &lt; 0 ){
			to += &quot;;&quot; + creator_mail;
		}
		to += &quot;;&quot; +getMailAddressTableA(dataMap);	
		to += &quot;;&quot; + getProcessMailAddressList(groupname); //通知簽核過的人員
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
        var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		var text = getAcceptMailContent(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		if(to.indexOf(&quot;@gce&quot;) &gt;= 0){ 			// 有可能是空的,當有值時再 send mail add by wangwei@2014/12/29
			Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
		}
	}catch(e){
		Server.addErrLog(&quot;call sendAcceptMailExt Error---------&quot;+e);
	}
}
/**
	TABLEA 內的 ID 會有 DEPID or MEMID
	DEPID 要取所有部門成員的 Email address
*/

function getMailAddressTableA(dataMap){
	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	try{
		var tablea = dataMap.get(&quot;TableA&quot;);
		if( tablea != null &amp;&amp; tablea.size()&gt;0  ){
			for(var t=0;t&lt;tablea.size();t++){
				var id = tablea.get(t).get(&quot;ITEM2&quot;);//DEPID or MEMID
				if(id.startsWith(&quot;DEP&quot;) &amp;&amp; Server.getDepartment(id) != null){
					var depname = Server.getDepartment(id).getName();
					memset = addDepAllMemID(depname,memset);
				}else{
					var id = tablea.get(t).get(&quot;ITEM3&quot;);//DEPID or MEMID			
					if(id.startsWith(&quot;MEM&quot;)&amp;&amp; Server.getMemberByID(id) != null &amp;&amp; !Server.getMemberByID(id).isResign()){
						memset.add(id);
					}
				}				
			}
		}
		
		// memset --&gt; email address
			var key = memset.iterator();
			while(key.hasNext()){
				var memid = key.next();
				if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMemberByID(memid) != null){
					var vMail = Server.getMemberByID(memid).getEmail();
						vMail = vMail.toLowerCase();       
					if( vMail.indexOf(&quot;wtadmin&quot;) &lt; 0 &amp;&amp;vMail!=&quot;&quot;){  //  add by wangwei@2009/04/20因沒有 mail address 的會給wtadmin so 再過濾此關鍵字,2012/03/13再加上&quot;&quot;
						emailaddress +=  vMail + &quot;;&quot; ;
					}
				}
			}

	}catch(e){
		var emailaddress = Server.getMemberByID(&quot;Administrator&quot;).getEmail();    // getMember
	}
	return emailaddress;
}
/**
	20080503
	將 DEP 內的所有人員加入 memset 內(含子部門)
*/
function addDepAllMemID(depname,memset){
	var DepartmentList = Server.getAllDepartmentByName(depname);
	for(var i=0;i&lt;DepartmentList.size();i++){
			var depObj =DepartmentList.get(i);
			var depID = depObj.getID();
			var memList = Server.getSubMemberIDOfDR(depID,true);
			for(var j = 0; j&lt; memList.size();j++){
				var memid = memList.get(j);				
				if(memid != null &amp;&amp; memid != &quot;&quot;){
					var mem = Server.getMemberByID(memid);
					if(mem != null &amp;&amp; !mem.isResign()){
						memset.add(memid);
					}
				}
			}
	}
	return memset;
}

 //-------------------
// 審核通過通知
//-------------------
function getAcceptMailContent(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核通過通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		try{
			var creator = Server.getMemberByID(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMemberByCName(MyTask.getFrontUser());  //getMember modi by wnagwei@2015/04/13
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){
			Server.addErrLog(&quot;call getAcceptMailContent send mail fail:&quot;+e);
		}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

/**
 駁回時發出的 mail
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
*/
function sendRejectMail(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var vMem = Server.getMemberByCName(MyTask.getFrontUser());  // getMember modi by wangwei@2015/04/13
		if (vMem != null){ 
			var from = vMem.getEmail();  // 2010/01/14 改為讀取前一關人員為寄件者
		}else{
			var from = &quot;MyGCE@gce.com.tw&quot;	;
		}
        var to = getProcessMailAddressList(groupname); 
        var cc = &quot;&quot;; //cc觀察用 
        var subject = &quot;[駁回通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」已退回申請人&quot;; // Mail Subject 
		var text = getMailContent(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		if(to.indexOf(&quot;@gce&quot;)&gt;=0){
			Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
		}
	}catch(e){
		Server.addErrLog(&quot;call sendRejectMail send mail fail:&quot;+e);
	}
}

/**	
 add by wangwei@2009/04/24	
 表單不同意退回,不是退回到申請者時發出的 mail
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
 若要自行定義主旨, 請傳入subject
 此mail只會 mali to 填單者,and 特定群組中的人
*/
function sendRejectMailExt(groupname,subject){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMemberByCName(MyTask.getFrontUser()).getEmail();  // modi by wangwei@2015/04/13  getMember
		var creator_mail = Server.getMemberByID(dataMap.get(&quot;Creator_ID&quot;)).getEmail();		
        var to = creator_mail +&quot;;&quot;;//getProcessMailAddressList(groupname); 
		if( to.indexOf(&quot;wtadmin&quot;) &gt;= 0){
			to = &quot;&quot;;
		}
		var emailaddress = &quot;&quot;;
		var memset = java.util.TreeSet();
		if(groupname != &quot;&quot;){
			var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
			var vec = Server.SQLloadValue(sql); 
			if(vec != null &amp;&amp; vec.size() &gt; 0){
				for(var i=0;i&lt;vec.size();i++){
					if(Server.getMemberByID(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMemberByID(vec.get(i).get(&quot;memid&quot;)).isResign()){
						memset.add(vec.get(i).get(&quot;memid&quot;));
					}
				}
				memset.remove(&quot;Administrator&quot;);
			}
		}
		var key = memset.iterator();
		while(key.hasNext()){
			var memid = key.next();
			if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMemberByID(memid) != null){
				var vEmail = Server.getMemberByID(memid).getEmail();
				if( vEmail.indexOf(&quot;wtadmin&quot;) &lt; 0){
					emailaddress += vEmail + &quot;;&quot; ;
				}
			}
		}
		to+=emailaddress;
        var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot;==subject){
			var subject = &quot;[通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」-主管不同意&quot;; // Mail Subject 
		}
		var text = getMailContentExt(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		if(to.indexOf(&quot;@gce&quot;) &gt;= 0 ){
			Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
		}
	}catch(e){
		Server.addErrLog(&quot;call sendRejectMailExt send mail fail:&quot;+e);
	}
}
//-------------------
// 駁回通知內容
//-------------------
function getMailContentExt(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核駁回通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   關卡名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;		
		text += &quot;      表單 : &quot; + dataMap.get(&quot;Select_Process&quot;);+&quot;&lt;br&gt;&quot;;			
		text += &quot;   退回原因 : &quot; + dataMap.get(&quot;Verify_Note&quot;);	+&quot;&lt;br&gt;&quot;;		
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		return text;
}


//-------------------
// 駁回通知內容
//-------------------
function getMailContent(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核駁回通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;	
		text += &quot;   退回原因 : &quot; + dataMap.get(&quot;Verify_Note&quot;);	+&quot;&lt;br&gt;&quot;;
		try{
			var creator = Server.getMemberByID(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;  // getMember modi by wangwei@2015/04/13
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMemberByCName(MyTask.getFrontUser());  // getMember modi by wangwei@2015/04/13
			if (frontuser != null){
				text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
			}
		}catch(e){
		 Server.addErrLog(&quot;call getMailContent send mail fail:&quot;+e);
		
		}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		return text;
}


/**
	取得Root Task 流程所經過的人+ 特定 table 抓出來的 email address 字串
*/
function getProcessMailAddressList(groupname){

	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	//流程上的成員
		var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMemberByID(vec.get(i).get(&quot;exeid&quot;)) != null &amp;&amp; !Server.getMemberByID(vec.get(i).get(&quot;exeid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;); //排除 Administrator
	}
	//Table 上的成員
	if(groupname != &quot;&quot;){
		var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
		var vec = Server.SQLloadValue(sql); 
		if(vec != null &amp;&amp; vec.size() &gt; 0){
			for(var i=0;i&lt;vec.size();i++){
				if(Server.getMemberByID(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMemberByID(vec.get(i).get(&quot;memid&quot;)).isResign()){
						memset.add(vec.get(i).get(&quot;memid&quot;));
				}
			}
				memset.remove(&quot;Administrator&quot;);
				memset.remove(&quot;MEMAUTO0001&quot;);//add by edison@20130520
		}
	}
	
	//子流程上的成員
	var sqla = &quot; select distinct exeid from task where rootid in(select cproottskid from task_createPro where tskid in(select tskid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid)) and exeid&lt;&gt;&apos;Administrator&apos; &quot;; 
	var rs = Server.SQLloadValue(sqla); 
	if(rs != null &amp;&amp; rs.size() &gt; 0){
		for(var i=0;i&lt;rs.size();i++){
			if(Server.getMemberByID(rs.get(i).get(&quot;exeid&quot;)) != null &amp;&amp; !Server.getMemberByID(rs.get(i).get(&quot;exeid&quot;)).isResign()){
					memset.add(rs.get(i).get(&quot;exeid&quot;));
			}
		}		
	}

	var key = memset.iterator();
	while(key.hasNext()){
		var memid = key.next();
		if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMemberByID(memid) != null &amp;&amp; Server.getMemberByID(memid).getEmail().indexOf(&quot;wtadmin&quot;) &lt; 0){
			var vMail=Server.getMemberByID(memid).getEmail();
			emailaddress += Server.getMemberByID(memid).getEmail() + &quot;;&quot; ;
		}
	}
	return emailaddress;	
}

 
 

//---------------------------------------------------------
//取得Root Task 流程所經過的人+ 特定 table 抓出來的 memid set
//扣掉上一關的人
function getProcessMemberList(groupname){
	var emailaddress = &quot;&quot;;
	var fronttaskid = MyTask.getFrontID();
	var frontmemid = Server.getTask(fronttaskid).getRealExecutor();
	var memset = java.util.TreeSet();
	//流程上的成員
	var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid and exeid !=&apos;&quot;+ frontmemid + &quot;&apos; &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			//去除已離職的人
			if(Server.getMemberByID(vec.get(i).get(&quot;exeid&quot;)) != null &amp;&amp; !Server.getMemberByID(vec.get(i).get(&quot;exeid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;);
	}
	//Table 上的成員
	var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMemberByID(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMemberByID(vec.get(i).get(&quot;memid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;memid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;);
	}
	return memset;	
}
//---------------------------------------------------------- 


//------------------------
// 發 mail 開啟連結用的 URL 
// n == 1 //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件 ( ie7 無法直接開 ) 
// n == 2 //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
// n == 3 //email開表單，需密碼
// n == 4 //email開表單，不需密碼
//------------------------
function getUrl(n){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           var aInstance = MyTask.getArtInstance(); 
           var dataMap = aInstance.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){                      	//給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMemberByID(MyTask.getMemberID());  // getMember modi by wangwei@2015/04/13
                     var userName = member.getLoginID();
                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }
           return url;
}

/**
 主管按不同意或駁回時發出 mail
 發給填單者及特定群群組內的人
 用於 Client
 vSubject : mail的主旨
 vGroup : 要mail給特定的群組人員
*/
function sendRejectMailClient(Task,vSubject,groupname){
	try{
		var arturl = &quot;&quot;//getUrl(2) ;		
		var aInstance = Task.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = Task.getRootName();
		var from = Client.getMemberByID(Task.getRealExecutor()).getEmail();// getMember modi by wangwie@2015/04/13 Client.getMember(&quot;administrator&quot;).getEmail();  		
		var creator_mail = Client.getMemberByID(dataMap.get(&quot;Creator_ID&quot;)).getEmail();  //getMember modi by wangwei@2015/04/13
		var to = creator_mail;
//        var cc = &quot;wangwei@gce.com.tw&quot;; //cc觀察用 
		if(&quot;&quot;==vSubject){
			vSubject = &quot;(通知)&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot;所申請-&quot; + roottaskname + &quot;--簽核者不同意&quot;; // Mail Subject 
		}
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程名稱: &quot; + Client.getTask(Task.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot; 不同意原因: &quot; + dataMap.get(&quot;Verify_Note&quot;);	+&quot;&lt;br&gt;&quot;;			
		text += &quot;   退回關卡: &quot; + dataMap.get(&quot;Select_Process&quot;);+&quot;&lt;br&gt;&quot;;				
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
//-----------------------
		var emailaddress = &quot;&quot;;
		var memset = java.util.TreeSet();
		//Group成員
		if(groupname != &quot;&quot;){
			var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
			var vec = Client.SQLloadValue(sql); 
			if(vec != null &amp;&amp; vec.size() &gt; 0){
				for(var i=0;i&lt;vec.size();i++){
					//Client.getMember(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Client.getMember(vec.get(i).get(&quot;memid&quot;)).isResign()  modi by wangwei@2015/04/13
					if(Client.getMemberByID(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Client.getMemberByID(vec.get(i).get(&quot;memid&quot;)).isResign()){
						memset.add(vec.get(i).get(&quot;memid&quot;));
					}
				}
				memset.remove(&quot;Administrator&quot;);
			}
		}
		var key = memset.iterator();
		while(key.hasNext()){
			var memid = key.next();
			if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Client.getMemberByID(memid) != null){  // getMember modi by wangwei@21015/04/13
				emailaddress += Client.getMemberByID(memid).getEmail() + &quot;;&quot; ;
			}
		}
		cc = cc +&quot;;&quot;+emailaddress ;
//--------------------		
        var fileList = new Packages.java.util.Vector(); 
			Client.sendHTMLMailExt(from,to,cc,vSubject,text,fileList,Task); 
	}catch(e){
		Client.addErrLog(&quot;call sendRejectMailClient send mail fail:&quot;+e.message);//檢視失敗訊息	
	}
}
//抓取a_parameter_data參數檔人員寄發mail
function sendMailByPara(PARAMETER,VALUE3){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMemberByID(&quot;Administrator&quot;).getEmail(); 	  // getMember modi by wangwei@2015/04/13
		var to = &quot;&quot;;
		var SQL =  &quot; select to_char(B.VALUE2) memid ,to_char(B.VALUE1) username ,to_char(C.RESIGN) resign&quot;;
	    	SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
			SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
			SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;				
			SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
			SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
			SQL += &quot; and C.MEMID=B.VALUE2&quot;;
			SQL += &quot; and B.VALUE3=&apos;&quot;+VALUE3+&quot;&apos;&quot;;
		try{
			var vec = Server.SQLloadValue(SQL);
			if(vec!=null &amp;&amp; vec.size()&gt;0){
				for(var i = 0; i&lt;vec.size(); i++){
					to +=Server.getMemberByID(vec.get(i).get(&quot;memid&quot;)).getEmail()+&quot;;&quot;;
				}
			}
		}catch(e){
			
		}
		
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 

		if ( dataMap.get(&quot;Cancel&quot;)== &quot;true&quot;){
               var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已作廢審核通過&quot;; // Mail Subject 
		}else{
		      var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 

		}
		var text = getAcceptMailContent(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		if(to != &quot;&quot;||cc != &quot;&quot;){ 			// add by wangwei@2016/02/03 有可能參數內設定的人都離職
			Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
		}
	}catch(e){
		Server.addErrLog(&quot;call sendMailByPara send mail fail:&quot;+e);//檢視失敗訊息
	}
}

function sendMailByPara_Area(PARAMETER,VALUE3){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var area = dataMap.get(&quot;Factory&quot;).substr(1,4);
		var from = Server.getMemberByID(&quot;Administrator&quot;).getEmail(); 	  // getMember modi by wangwei@2015/04/13
		var to = &quot;&quot;;
		var SQL =  &quot; select to_char(B.VALUE2) memid ,to_char(B.VALUE1) username ,to_char(C.RESIGN) resign&quot;;
	    	SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
			SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
			SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;				
			SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
			SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
			SQL += &quot; and C.MEMID=B.VALUE2&quot;;
			SQL += &quot; and B.VALUE3=&apos;&quot;+VALUE3+&quot;&apos;&quot;;
			SQL += &quot; and B.key1=&apos;&quot;+area+&quot;&apos;&quot;;
		try{
			var vec = Server.SQLloadValue(SQL);
			if(vec!=null &amp;&amp; vec.size()&gt;0){
				for(var i = 0; i&lt;vec.size(); i++){
					to +=Server.getMemberByID(vec.get(i).get(&quot;memid&quot;)).getEmail()+&quot;;&quot;;
				}
			}
		}catch(e){			
		}		
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if ( dataMap.get(&quot;Cancel&quot;)== &quot;true&quot;){
               var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已作廢審核通過&quot;; // Mail Subject 
		}else{
		      var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 

		}
		if(&quot;&quot;!=to){ 		// 有接收者再　send mail add by wangwei@2018/01/05
			var text = getAcceptMailContent(dataMap);
			var fileList = new Packages.java.util.Vector(); 
			Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
		}
	}catch(e){
		Server.addErrLog(&quot;call sendMailByPara send mail fail:&quot;+e);//檢視失敗訊息
	}
}
// add by wangwei@2016/12/12
// 將簽核紀錄組成html table 傳回, 可以在 mail 中show 出 ; 
// 適合用在退件時通知信,因表單內容有部份是機密性,不宜直接開啟表單
// 傳入 table 名稱及 insid
function getProcessTable(vTableName,vINSID ){
	var vReturn = &quot;&quot;
	vReturn = &quot;&lt;table  border=&apos;1&apos; cellpadding=&apos;2&apos; cellspacing=&apos;0&apos; bordercolordark&apos;#FFFFFF&apos; id=&apos;table1&apos; style=&apos;font-size: 11pt; font-family: Arial; border: 1px solid #FFFFFF&apos;&gt;&quot;	
	vReturn +=&quot;&lt;tr&gt;&quot;
	vReturn +=&quot;&lt;td&gt;序號&lt;/td&gt;&lt;td&gt;審核日期&lt;/td&gt;&lt;td&gt;關卡名稱&lt;/td&gt;&lt;td&gt;姓名&lt;/td&gt;&lt;td&gt;是否核准&lt;/td&gt;&lt;td&gt;審核意見&lt;/td&gt;&quot;	
	vReturn +=&quot;&lt;/tr&gt;&quot;
	var vSQL = &quot;select ITEM7,ITEM5,ITEM8,ITEM4,ITEM3,ITEM1  from &quot;+vTableName+&quot;&quot;;
		vSQL +=&quot; where insid=&apos;&quot;+vINSID+&quot;&apos; order by item5	&quot;;
	var DataSet = Server.SQLloadValue(vSQL);
    if (DataSet.size()&gt;0) {
		for (var i=0; i&lt;DataSet.size(); i++){
			vReturn +=&quot;&lt;tr&gt;&quot;
			var Record = DataSet.get(i);
            var UserID = Record.get(&quot;ID&quot;);
            var UserName = Record.get(&quot;UserName&quot;);
			vReturn +=&quot;&lt;td&gt;&quot;+Record.get(&quot;ITEM7&quot;)+&quot;&lt;/td&gt;&quot;;
			vReturn +=&quot;&lt;td&gt;&quot;+Record.get(&quot;ITEM5&quot;)+&quot;&lt;/td&gt;&quot;;
			vReturn +=&quot;&lt;td&gt;&quot;+Record.get(&quot;ITEM8&quot;)+&quot;&lt;/td&gt;&quot;;
			vReturn +=&quot;&lt;td&gt;&quot;+Record.get(&quot;ITEM4&quot;)+&quot;&lt;/td&gt;&quot;;			
			vReturn +=&quot;&lt;td&gt;&quot;+Record.get(&quot;ITEM3&quot;)+&quot;&lt;/td&gt;&quot;;			
			vReturn +=&quot;&lt;td&gt;&quot;+Record.get(&quot;ITEM1&quot;)+&quot;&lt;/td&gt;&quot;;						
            vReturn +=&quot;&lt;/tr&gt;&quot;
        }
    }	
	vReturn +=&quot;&lt;/table&gt;&quot;;	
	return vReturn;
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>流程中統一使用發送的 mail</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00191102067678580</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.SystemFunction.DateFunction</string> 
     </void> 
     <void property="id"> 
      <string>SCL00191102067678580</string> 
     </void> 
     <void property="name"> 
      <string>DateFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051102066163487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//傳入當年月份, 如:2004/03
//傳回該月份的總天數
function getMonthDay(month){
    var prob = 35;
    var testDate = new Packages.pase.agenda.MyDate(month + &quot;/&quot; + prob);
    var extraDay = testDate.getCurrentDay();
    return (prob - extraDay);
}
//傳入某一日期,如 &quot;2004/03/01&quot;
//傳回上一週週一的日期
function getLastMondayDate(theDate){
	var result = &quot;&quot;;
	var workDate = new Packages.pase.agenda.MyDate(theDate);
	var year = workDate.getCurrentYear();
	var month = workDate.getCurrentMonth();
	var day = workDate.getCurrentDay();
	var weekDay = workDate.getDayOfWeek();

	//上週一與該日相差的天數
	var substract = 7 + (weekDay - 1);
	//若目前的 DayOf Month 大於相差天數,則直接減去即可,否則要算到上個月去
	if(day &gt; substract){
		result = year + &quot;/&quot; + month +&quot;/&quot; + (day - substract);
	}else{
		//計算扣除本月後還差幾天
		substract = substract - day;
		//計算上個月的總天數
		var lastM = &quot;&quot;;
		if(month == 1)  //要算到去年
			lastM = (year - 1) + &quot;/12&quot;;
		else
			lastM = year + &quot;/&quot; + (month - 1);

                var lastMonthTotal = getMonthDay(lastM);
                //再取出上個月的日期
		result = lastM + &quot;/&quot; + (lastMonthTotal - substract);
	}

	//要轉成標準的格式(月,日要補成二位)
	var resultDate = new Packages.pase.agenda.MyDate(result);
	return resultDate.getCurrentDate();
}

	
	//傳入由 MyDate() 取得的 DayOfWeek
	//傳回中文的星期幾
	//ex: getWeekDaySymbol(7) --&gt; &quot;日&quot;
	function getWeekDaySymbol(weekDay){
		switch(weekDay){
			case 1:
				return &quot;一&quot;;
			case 2:
				return &quot;二&quot;;
			case 3:
				return &quot;三&quot;;
			case 4:
				return &quot;四&quot;;
			case 5:
				return &quot;五&quot;;
			case 6:
				return &quot;六&quot;;
			case 0:
				return &quot;日&quot;;
			default:
				return &quot;--&quot;;
		}
	}

//將日期字串中的&quot;/&quot;去除(如此才符合 AS400 中的格式)
function trimDate(orgDate){
	var newDate = &quot;&quot;;
	try{
		var date = new Packages.pase.agenda.MyDate(orgDate);
		newDate = date.getCurrentDate(&quot;YMD&quot;);
	}catch(e){
		java.lang.System.out.println(&quot;DateFunction.trimDate() Error!! [orgDate = &quot; + orgDate + &quot; ]:&quot;+e);
	}
	return newDate;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>有關日期格式的函數</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00191250755035123</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/05/22 16:40:11</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Server.SystemAutoAssign</string> 
     </void> 
     <void property="id"> 
      <string>SCL00191250755035123</string> 
     </void> 
     <void property="name"> 
      <string>SystemAutoAssign</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00101250755035086</string> 
     </void> 
     <void property="scriptSource"> 
      <string>/**
com.A.Common.Server.SystemAutoAssign
  only for GCE  
  member.getPager() 為主管的 MEMID  
*/		
// 2013/07/29 11:00 update
function getManager(memid){
	var mem = Server.getMember(memid);
	var managerMemID = &quot;Administrator&quot;;
	if(mem != null){
		managerMemID = mem.getPager();
	}
	var manager = Server.getMember(managerMemID);
	return manager;
}
// 有主管下屬有兩個單位,且直屬主管也有兩位	add by wangwei@2009/02/25
function getManagerExt(memid,vDept){
	var mem = Server.getMember(memid);
	var managerMemID = &quot;Administrator&quot;;
	if(mem != null){
		managerMemID = mem.getPager();
	}			
	// 再select  設定檔		
	// 改善速度,暫不考慮表單 modi by wangwei@2014/10/14
	// var vFormName = MyTask.getArtInstance().getName();   // 取得表單名稱  add by wangwei@2012/03/06
	var vDeptSub = vDept.substring(0,4)+&quot;%&quot;;
	var sql = &quot; select trim(value1) as pager from a_parameter_data where parameter = &apos;MUTIL_DEPARTMENT&apos; and &quot;;
		sql+= &quot; key1 = &apos;&quot;+memid+&quot;&apos; and  value2 = &apos;&quot;+vDept+&quot;&apos;&quot;; // 不可以用廠別，因楊大焜2D6 ...
//		sql+= &quot; key1 = &apos;&quot;+memid+&quot;&apos; and ( value2 = &apos;&quot;+vDept+&quot;&apos; or value2 like &apos;&quot;+vDeptSub+&quot;&apos;)&quot;; //  and (remarks is null or remarks =&apos;&apos; or remarks=&apos;&quot;+vFormName+&quot;&apos;)&quot; ;
	try{
		var vector = Server.SQLloadValue(sql);				
		if ( vector != null&amp;&amp;vector.size()&gt;0 ){
			if (vector.size()&gt;0){
				managerMemID = vector.get(0).get(&quot;pager&quot;);
			}
		}	
	}catch(e){
		Server.addErrLog(&quot;Call getManager:&quot;+sql)
	}
	var manager = Server.getMember(managerMemID);
	return manager;
}
// 判斷簽核層級
function autoAssignManager(toManager,toAgree){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var mbrLv = &quot;010&quot;;
	var vApp_DepID= dataMap.get(&quot;App_DepID&quot;);
	var mbrLv = Server.getRole(dataMap.get(&quot;From_User_Role_ID&quot;)).getMyID();
	if(mbrLv == null){
		mbrLv = &quot;010&quot;;
	}
// 特殊人物	add by wangwei@2012/12/14
    var from_user_id = dataMap.get(&quot;From_User_ID&quot;);
	if(from_user_id==&quot;MEMS1033866&quot;){			// 杜秀美ROLS6P0140 , 但她的直屬主管是廠長董憲卿ROLS6A0124
		mbrLv = &quot;084&quot;;  						// 改為經理 
	}
	//沒有核決權限就簽到 104 部門處級主管
	var verLv = dataMap.get(&quot;Verify_Level&quot;);
	if(verLv == &quot;&quot; || verLv == null){
		verLv = &quot;104&quot;;
	}
	if (mbrLv &lt; verLv ){						// 簽核者等級 &lt; 核決權限   ==&gt; 不足需再簽核	
		if (dataMap.get(&quot;Assign_Manager&quot;).equals(&quot;true&quot;) &amp;&amp; dataMap.get(&quot;Manager_ID&quot;) != &quot;&quot;){	//增加指定主管
			dataMap.put(&quot;Next_Member_ID&quot;,dataMap.get(&quot;Manager_ID&quot;));		
			dataMap.put(&quot;Manager_ID&quot;,&quot;&quot;);														//清掉指定的主管
			dataMap.put(&quot;Manager_Name&quot;,&quot;&quot;);
			dataMap.put(&quot;Assign_Manager&quot;,&quot;false&quot;);
		}else{																					//抓 Org 主管
			var from_user_id = dataMap.get(&quot;From_User_ID&quot;); 									
			var manager = getManagerExt(from_user_id,vApp_DepID);
			var mgrRoleid = manager.getMainRoleID();
			if(mgrRoleid != null){
				dataMap.put(&quot;Next_Member_Role&quot;,mgrRoleid);
			}
			var next_member_id = manager.getID();
			var next_member = Server.getMember(next_member_id);
			dataMap.put(&quot;Next_Member_ID&quot;,next_member_id);
		}
		Server.flowTo(MyTask,toManager);// 主管簽核
	}else{
		Server.flowTo(MyTask,toAgree);
	}
}

// Add by wangwei@2011/090/01
// 避免表單的簽核層級設太高, 追直屬主管時會呈簽太高層
// ex: 某表單設核決層級為 104 (處長) , 但該單位無處長(104), 只有副處長(102)
// 因此在層簽時會由副處長再往上一階層簽
// ==&gt;&gt;&gt; 若該表單能確定最高的簽核層級為某一層級,ex:104 , 則將此值傳入
// 程式在追直屬主管時,若直屬主管的層級大於此值則不再往上層簽  
function autoAssignManagerExt(toManager,toAgree,maxLevel){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var mbrLv = &quot;010&quot;;
	var vApp_DepID= dataMap.get(&quot;App_DepID&quot;);
	var mbrLv = Server.getRole(dataMap.get(&quot;From_User_Role_ID&quot;)).getMyID();
	if (mbrLv == null){
		mbrLv = &quot;010&quot;;
	}	
// 特殊人物	add by wangwei@2012/12/14
    var from_user_id = dataMap.get(&quot;From_User_ID&quot;);
	if(from_user_id==&quot;MEMS1033866&quot;){				// 杜秀美ROLS6P0140 , 但她的直屬主管是廠長董憲卿ROLS6A0124
		mbrLv = &quot;084&quot;;  							// 改為經理 
	}	
	var verLv = dataMap.get(&quot;Verify_Level&quot;);
	if(verLv == &quot;&quot; || verLv == null){
		verLv = &quot;104&quot;;								//沒有核決權限就簽到 104 部門處級主管
		Server.addErrLog(&quot;表單簽核者:&quot;+from_user_id+&quot;未設定表單簽核權限!&quot;);
	}
	if(mbrLv &lt; verLv){								//核決權限不足需再簽核	
		if (dataMap.get(&quot;Assign_Manager&quot;).equals(&quot;true&quot;) &amp;&amp; dataMap.get(&quot;Manager_ID&quot;) != &quot;&quot;){//增加指定主管
			dataMap.put(&quot;Next_Member_ID&quot;,dataMap.get(&quot;Manager_ID&quot;));			
			dataMap.put(&quot;Manager_ID&quot;,&quot;&quot;);			//清掉指定的主管
			dataMap.put(&quot;Manager_Name&quot;,&quot;&quot;);
			dataMap.put(&quot;Assign_Manager&quot;,&quot;false&quot;);
		}else{										//抓 Org 主管
			var from_user_id = dataMap.get(&quot;From_User_ID&quot;);
			var manager = getManagerExt(from_user_id,vApp_DepID);
			var mgrRoleid = manager.getMainRoleID();
			if(mgrRoleid != null){
				dataMap.put(&quot;Next_Member_Role&quot;,mgrRoleid);
			}
			var next_member_id = manager.getID();
			var next_member = Server.getMember(next_member_id);
			var mgrRoleid = next_member.getMainRoleID();
			var mgrLv =  Server.getRole(mgrRoleid).getMyID();								
			if(mgrLv &gt; maxLevel){				   	// modi by wagnwei@2012/08/13 mgrLv &gt; verLv||mgrLv &gt; maxLevel	
				Server.flowTo(MyTask,toAgree);
				return;
			}else{
				dataMap.put(&quot;Next_Member_ID&quot;,next_member_id);
			}
		}
		Server.flowTo(MyTask,toManager);			// 主管簽核
	}else{
		Server.flowTo(MyTask,toAgree);
	}
}

//add by edison
//當簽核層級已到達，但下一關主管職等相同時，則需繼續簽核
function autoAssignManager_v1(toManager,toAgree){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var mbrLv = &quot;010&quot;;
	var vApp_DepID= dataMap.get(&quot;App_DepID&quot;);
	var mbrLv = Server.getRole(dataMap.get(&quot;From_User_Role_ID&quot;)).getMyID();
	if(mbrLv == null){
		mbrLv = &quot;010&quot;;
	}

	//沒有核決權限就簽到 104 部門處級主管
	var verLv = dataMap.get(&quot;Verify_Level&quot;);
	if(verLv == &quot;&quot; || verLv == null){
		verLv = &quot;104&quot;;
	}
	if (mbrLv &lt; verLv ){						// 簽核者等級 &lt; 核決權限   ==&gt; 不足需再簽核	
		if (dataMap.get(&quot;Assign_Manager&quot;).equals(&quot;true&quot;) &amp;&amp; dataMap.get(&quot;Manager_ID&quot;) != &quot;&quot;){	//增加指定主管
			dataMap.put(&quot;Next_Member_ID&quot;,dataMap.get(&quot;Manager_ID&quot;));		
			dataMap.put(&quot;Manager_ID&quot;,&quot;&quot;);														//清掉指定的主管
			dataMap.put(&quot;Manager_Name&quot;,&quot;&quot;);
			dataMap.put(&quot;Assign_Manager&quot;,&quot;false&quot;);
		}else{																					//抓 Org 主管
			var from_user_id = dataMap.get(&quot;From_User_ID&quot;); 									
			var manager = getManagerExt(from_user_id,vApp_DepID);
			var mgrRoleid = manager.getMainRoleID();
			if(mgrRoleid != null){
				dataMap.put(&quot;Next_Member_Role&quot;,mgrRoleid);
			}
			var next_member_id = manager.getID();
			var next_member = Server.getMember(next_member_id);
			// 當主管啟動代理人，則要再 check 代理人是否和上一關同一人(from_user_id) 同一人的話就再往上找 20070121
			if(next_member.getDeputyState() &amp;&amp; !next_member.isByDeputyRule() &amp;&amp; Server.getMember(next_member.getDeputyID())!= null ){
				var deputy_member_id = next_member.getDeputyID(); //取代理人當下一個人
				if(from_user_id.equals(deputy_member_id)){
					//為同一人，再向上找一層，要再 check 是否超核
					mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
					next_member_id = getManagerExt(next_member_id,vApp_DepID).getID();
					mgrLv =  Server.getRole(mgrRoleid).getMyID();
					if(mgrLv &gt; verLv){
						Server.flowTo(MyTask,toAgree);
						return;
					}									
				}
			}else{
			//沒有代理人的情況
				if(from_user_id.equals(next_member_id)){
					//為同一人，要再 check 是否超核
					//還是抓到同一個人 : Server.getManagerRole(mgrRole.getID()) 不能用
					next_member_id = getManagerExt(next_member_id,vApp_DepID).getID();
					mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
					mgrLv =  Server.getRole(mgrRoleid).getMyID();								
					if(mgrLv.substring(0,2) &gt; verLv.substring(0,2)){
						Server.flowTo(MyTask,toAgree);
						return;
					}
				}
			}
			dataMap.put(&quot;Next_Member_ID&quot;,next_member_id);
		}
		Server.flowTo(MyTask,toManager);// 主管簽核
	}else{
		var from_user_id = dataMap.get(&quot;From_User_ID&quot;); 									
		var manager = getManagerExt(from_user_id,vApp_DepID);
		var next_member_id = manager.getID(); //下一關主管memid
		var next_mgrRoleid = manager.getMainRoleID();//下一關主管rolid
		var next_mgrLv =  Server.getRole(next_mgrRoleid).getMyID();//下一關主管職等
		if(mbrLv==next_mgrLv){//當簽核層級已到達，但下一關主管職等相同時，則需繼續簽核
			if(manager.getDeputyState() &amp;&amp; !manager.isByDeputyRule() &amp;&amp; Server.getMember(manager.getDeputyID())!= null ){
				var deputy_member_id = manager.getDeputyID(); //取代理人當下一個人
				if(from_user_id.equals(deputy_member_id)){
					//為同一人，再向上找一層，要再 check 是否超核
					mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
					next_member_id = getManagerExt(next_member_id,vApp_DepID).getID();
					mgrLv =  Server.getRole(mgrRoleid).getMyID();
					if(mgrLv &gt; verLv){
						Server.flowTo(MyTask,toAgree);
						return;
					}									
				}
			}else{
			//沒有代理人的情況
				if(from_user_id.equals(next_member_id)){
					//為同一人，要再 check 是否超核
					//還是抓到同一個人 : Server.getManagerRole(mgrRole.getID()) 不能用
					next_member_id = getManagerExt(next_member_id,vApp_DepID).getID();
					mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
					mgrLv =  Server.getRole(mgrRoleid).getMyID();								
					if(mgrLv.substring(0,2) &gt; verLv.substring(0,2)){
						Server.flowTo(MyTask,toAgree);
						return;
					}
				}
			}
			dataMap.put(&quot;Next_Member_ID&quot;,next_member_id);
			Server.flowTo(MyTask,toManager);// 主管簽核
		}else{
			Server.flowTo(MyTask,toAgree);
		}
		
		
	}
}

//add by edison
//當簽核層級已到達，但下一關主管職等相同時，則需繼續簽核
function autoAssignManagerExt_v1(toManager,toAgree,maxLevel){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var mbrLv = &quot;010&quot;;
	var vApp_DepID= dataMap.get(&quot;App_DepID&quot;);
	var mbrLv = Server.getRole(dataMap.get(&quot;From_User_Role_ID&quot;)).getMyID();
	if (mbrLv == null){
		mbrLv = &quot;010&quot;;
	}	

    var from_user_id = dataMap.get(&quot;From_User_ID&quot;);
	
	var verLv = dataMap.get(&quot;Verify_Level&quot;);
	if(verLv == &quot;&quot; || verLv == null){
		verLv = &quot;104&quot;;								//沒有核決權限就簽到 104 部門處級主管
		Server.addErrLog(&quot;表單簽核者:&quot;+from_user_id+&quot;未設定表單簽核權限!&quot;);
	}
	if(mbrLv &lt; verLv){								//核決權限不足需再簽核	
		if (dataMap.get(&quot;Assign_Manager&quot;).equals(&quot;true&quot;) &amp;&amp; dataMap.get(&quot;Manager_ID&quot;) != &quot;&quot;){//增加指定主管
			dataMap.put(&quot;Next_Member_ID&quot;,dataMap.get(&quot;Manager_ID&quot;));			
			dataMap.put(&quot;Manager_ID&quot;,&quot;&quot;);			//清掉指定的主管
			dataMap.put(&quot;Manager_Name&quot;,&quot;&quot;);
			dataMap.put(&quot;Assign_Manager&quot;,&quot;false&quot;);
		}else{										//抓 Org 主管
			var from_user_id = dataMap.get(&quot;From_User_ID&quot;);
			var manager = getManagerExt(from_user_id,vApp_DepID);
			var mgrRoleid = manager.getMainRoleID();
			if(mgrRoleid != null){
				dataMap.put(&quot;Next_Member_Role&quot;,mgrRoleid);
			}
			var next_member_id = manager.getID();
			var next_member = Server.getMember(next_member_id);
			var mgrRoleid = next_member.getMainRoleID();
			var mgrLv =  Server.getRole(mgrRoleid).getMyID();								
			if(mgrLv &gt; maxLevel){				   	// modi by wagnwei@2012/08/13 mgrLv &gt; verLv||mgrLv &gt; maxLevel	
				Server.flowTo(MyTask,toAgree);
				return;
			}else{
				// 當主管啟動代理人，則要再 check 代理人是否和上一關同一人(from_user_id) 同一人的話就再往上找 20070121
				if(next_member.getDeputyState() &amp;&amp; !next_member.isByDeputyRule() &amp;&amp; Server.getMember(next_member.getDeputyID())!= null ){
					var deputy_member_id = next_member.getDeputyID(); //取代理人當下一個人
					var deputy_member = Server.getMember(deputy_member_id);
					var dmgrRoleid = deputy_member.getMainRoleID();
					var dmgrLv =  Server.getRole(dmgrRoleid).getMyID();								
					if(dmgrLv &gt; maxLevel){				   	
						Server.flowTo(MyTask,toAgree);
						return;
					}
					if(from_user_id.equals(deputy_member_id)){
						//為同一人，再向上找一層，要再 check 是否超核
						mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
						next_member_id = getManagerExt(next_member_id,vApp_DepID).getID();
						mgrLv =  Server.getRole(mgrRoleid).getMyID();
						if(mgrLv &gt; verLv){
							Server.flowTo(MyTask,toAgree);
							return;
						}									
					}
				}else{
					//沒有代理人的情況
					if(from_user_id.equals(next_member_id)){
						//為同一人，要再 check 是否超核
						//還是抓到同一個人 : Server.getManagerRole(mgrRole.getID()) 不能用
						next_member_id = getManagerExt(next_member_id,vApp_DepID).getID();
						mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
						mgrLv =  Server.getRole(mgrRoleid).getMyID();								
						if(mgrLv.substring(0,2) &gt; verLv.substring(0,2)){
							Server.flowTo(MyTask,toAgree);
							return;
						}
					}
				}
				dataMap.put(&quot;Next_Member_ID&quot;,next_member_id);
			}
		}
		Server.flowTo(MyTask,toManager);			// 主管簽核
	}else{
		var from_user_id = dataMap.get(&quot;From_User_ID&quot;); 									
		var manager = getManagerExt(from_user_id,vApp_DepID);
		var next_member_id = manager.getID(); //下一關主管memid
		var next_mgrRoleid = manager.getMainRoleID();//下一關主管rolid
		var next_mgrLv =  Server.getRole(next_mgrRoleid).getMyID();//下一關主管職等
		if(mbrLv==next_mgrLv){//當簽核層級已到達，但下一關主管職等相同時，則需繼續簽核
			if(manager.getDeputyState() &amp;&amp; !manager.isByDeputyRule() &amp;&amp; Server.getMember(manager.getDeputyID())!= null ){
				var deputy_member_id = manager.getDeputyID(); //取代理人當下一個人
				var deputy_member = Server.getMember(deputy_member_id);
				var dmgrRoleid = deputy_member.getMainRoleID();
				var dmgrLv =  Server.getRole(dmgrRoleid).getMyID();								
				if(dmgrLv &gt; maxLevel){				   	
					Server.flowTo(MyTask,toAgree);
					return;
				}
				if(from_user_id.equals(deputy_member_id)){
					//為同一人，再向上找一層，要再 check 是否超核
					mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
					next_member_id = getManagerExt(next_member_id,vApp_DepID).getID();
					mgrLv =  Server.getRole(mgrRoleid).getMyID();
					if(mgrLv &gt; verLv){
						Server.flowTo(MyTask,toAgree);
						return;
					}									
				}
			}else{
				//沒有代理人的情況
				if(from_user_id.equals(next_member_id)){
					//為同一人，要再 check 是否超核
					//還是抓到同一個人 : Server.getManagerRole(mgrRole.getID()) 不能用
					next_member_id = getManagerExt(next_member_id,vApp_DepID).getID();
					mgrRoleid = getManagerExt(next_member_id,vApp_DepID).getMainRoleID();
					mgrLv =  Server.getRole(mgrRoleid).getMyID();								
					if(mgrLv.substring(0,2) &gt; verLv.substring(0,2)){
						Server.flowTo(MyTask,toAgree);
						return;
					}
				}
			}
			dataMap.put(&quot;Next_Member_ID&quot;,next_member_id);
			Server.flowTo(MyTask,toManager);// 主管簽核
		}else{
			Server.flowTo(MyTask,toAgree);
		}
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>逐級簽核</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00201250755035126</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/08/14 21:34:07</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Server.TotalNote</string> 
     </void> 
     <void property="id"> 
      <string>SCL00201250755035126</string> 
     </void> 
     <void property="name"> 
      <string>TotalNote</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00101250755035086</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
function setTotalNote(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		//Set 流程控制
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
		dataMap.put(&quot;From_User_Role_ID&quot;, MyTask.getRoleID());
		
		//Set 簽核意見
		//		var mbrName = Server.getMemberByID(MyTask.getMemberID()).getName();
		var mbrName = Server.getMemberByID(MyTask.getRealExecutor()).getName();		
		var rolName = Server.getRole(MyTask.getRoleID()).getName();
		var totalNote = dataMap.get(&quot;Total_Note&quot;);
		var note = dataMap.get(&quot;Note&quot;);
		var yesno = &quot;駁回&quot;;
		var yes = dataMap.get(&quot;Agree&quot;);
		if(yes.equals(&quot;true&quot;)){
		     yesno = &quot;同意&quot;;
		}
		java.lang.System.out.println(&quot;yesno=&quot;+yesno);
		if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
			totalNote = totalNote + &quot;[&quot; + mbrName + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;),&quot; + rolName + &quot;,&quot; + getFormatedCurrentTime() + &quot;]  &quot;  + yesno +&quot; &quot;+ note +&quot;\n&quot;;
		}else{
			totalNote = totalNote + &quot;[&quot; + mbrName + &quot;,&quot; + rolName + &quot;,&quot; + getFormatedCurrentTime() + &quot;]  &quot;  + yesno +&quot; &quot;+note +&quot;\n&quot;;    
		}
		
		dataMap.put(&quot;Total_Note&quot;,totalNote);
		dataMap.put(&quot;Agree&quot;,&quot;true&quot;);
		dataMap.put(&quot;Reject&quot;,&quot;false&quot;);
		dataMap.put(&quot;Note&quot;,&quot;&quot;);
}

    function getFormatedCurrentTime(){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
        return simpledateformat.format(date);
    }

function setVerifyName(){
		//設定主管簽核姓名
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		dataMap.put(&quot;Verify_ID&quot;,Server.getMember(MyTask.getRealExecutor()).getMyID() );		
		dataMap.put(&quot;Verify_Name&quot;,Server.getMember(MyTask.getRealExecutor()).getName() );
		dataMap.put(&quot;Agree&quot;,&quot;true&quot;);
}

//DCC 關卡用
function setDCCTotalNote(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		//Set 流程控制
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
		dataMap.put(&quot;From_User_Role_ID&quot;, MyTask.getRoleID());
		
		//Set 簽核意見
		//		var mbrName = Server.getMemberByID(MyTask.getMemberID()).getName();
		var mbrName = Server.getMemberByID(MyTask.getRealExecutor()).getName();		
		var rolName = Server.getRole(MyTask.getRoleID()).getName();
		var totalNote = dataMap.get(&quot;Total_Note&quot;);
		var note = dataMap.get(&quot;Note&quot;);
		var yesno = &quot;駁回&quot;;
		var yes = dataMap.get(&quot;Agree&quot;);
		if(yes.equals(&quot;true&quot;)){
		     yesno = &quot;同意&quot;;
		}
		java.lang.System.out.println(&quot;yesno=&quot;+yesno);
		if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
			totalNote = totalNote + &quot;[&quot; + mbrName + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;),&quot; + rolName +
			&quot;,&quot; + getFormatedCurrentTime() + &quot;]  &quot;  + yesno + &quot; &quot;+ dataMap.get(&quot;Next_Process&quot;) +&quot; &quot;+ note +&quot;\n&quot;;
		}else{
			totalNote = totalNote + &quot;[&quot; + mbrName + &quot;,&quot; + rolName + &quot;,&quot; + getFormatedCurrentTime() + &quot;]  &quot;  + yesno +&quot; &quot;+note +&quot;\n&quot;;    
		}
		
		dataMap.put(&quot;Total_Note&quot;,totalNote);
		dataMap.put(&quot;Agree&quot;,&quot;true&quot;);
		dataMap.put(&quot;Reject&quot;,&quot;false&quot;);
		dataMap.put(&quot;Note&quot;,&quot;&quot;);
}

function setTaskRole(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		if(&quot;&quot; != dataMap.get(&quot;Next_Member_Role&quot;)){
			MyTask.setRoleID(dataMap.get(&quot;Next_Member_Role&quot;)); //設定Task 所屬的職務 
		}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00211110982479406</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.Supplier</string> 
     </void> 
     <void property="id"> 
      <string>SCL00211110982479406</string> 
     </void> 
     <void property="name"> 
      <string>Supplier</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//取得廠商名稱,先至 AS400 的廠商檔找,若無再到憑證廠商商檔找
function getSupplierName(supplierID,checkAs400){
	
	//Modifed by Johann Hsu   2006/06/19     廠商名稱不須由AS400取得(以 checkAs400 控制) 
	var supplierName =&quot;&quot;; 
	
	if (checkAs400 != null) { 
		supplierName = getSupplierName_AS400(supplierID);
	} 
	
	if(supplierName.equals(&quot;&quot;)){
		//若 AS400 找不到,則到憑證廠商檔中尋找
		supplierName = getSupplierName_Invoice(supplierID);
	}
	//若憑證廠商檔也沒有,則為新增,但也有可能新增站所或員工,先過濾這二者
	if(supplierName.equals(&quot;&quot;)){
		if(supplierID.length() == 4){
			//站所
			loadLibrary(&quot;ScriptLibary.MemberFunction.DepartmentFunction&quot;);
			var depList = getDepartmentByMyID(supplierID);
			if(depList != null &amp;&amp; depList.size() &gt; 0){
				supplierName = depList.get(0).getName();
			}
		}else if(supplierID.length() == 5){
			//員工
			var member = Client.getMember(supplierID);
			if(member != null)
				supplierName = member.getName();
		}
	}
	
	return supplierName;
}

//由AS400廠商檔取得廠商名稱
//傳入廠商統編, 傳回廠商名稱
//若找不到則傳回空字串
function getSupplierName_AS400(supplierID){
	var Vendors= new Packages.hct.dataaccess.data.FFAHMP();
	var VendorName = Vendors.getVendorNamebyID(supplierID);
	return VendorName.trim();

	//return  &quot;AAA&quot;;
}

//由憑證廠商檔取得廠商名稱
//傳入廠商統編, 傳回廠商名稱
//若找不到則傳回空字串
function getSupplierName_Invoice(supplierID){
	supplierName = &quot;&quot;;
	var querySQL = &quot;Select SupplierName from FFSUPPLIER Where SupplierID = &apos;&quot;+supplierID+&quot;&apos; &quot;;
	var dataSet = Client.SQLloadValue(querySQL);
	for(var i = 0; i &lt; dataSet.size(); i++){
		var aRow = dataSet.get(i);
		supplierName = aRow.get(&quot;SupplierName&quot;);
	}
	
	return supplierName;
}

//將新建的廠商資料存入 憑證廠商檔
//傳入廠商統編,廠商名稱,新增資料者
//若已存在則將舊資料覆蓋
function saveSupplier_Invoice(supplierID, supplierName, creator){
	//先刪去舊資料
	Client.SQLdeleteValue(&quot;Delete FFSUPPLIER Where SupplierID = &apos;&quot;+supplierID+&quot;&apos; &quot;);
	//將新資料寫入
	var mydate = new Packages.pase.agenda.MyDate();
	var createDate = mydate.getCurrentDate(&quot;YMD&quot;);
	var createTime = mydate.getCurrentDate(&quot;HmS&quot;);
	var insertSQL = &quot;Insert Into FFSUPPLIER (SupplierID,SupplierName,Creator,CreateDate,CreateTIme) &quot;+
			&quot; values(&apos;&quot;+supplierID+&quot;&apos;,&apos;&quot;+supplierName+&quot;&apos;,&apos;&quot;+creator+&quot;&apos;,&apos;&quot;+createDate+&quot;&apos;,&apos;&quot;+createTime+&quot;&apos;) &quot;;
	java.lang.System.out.println(&quot;insertSQL: &quot; + insertSQL);		
	return Client.SQLinsertValue(insertSQL);
}

//依廠商統編資料取出廠商名稱
//傳入廠商統編及廠商名稱對應的欄位名稱
//系統自動取統編去找對應名稱,並填入表單欄位
function checkSupplierName(field_supplierID,field_supplierName){
	var msg = &quot;&quot;;
	
	var supplierID = Form.getValue(field_supplierID);
	var supplierName = getSupplierName(supplierID);
	if(supplierName.equals(&quot;&quot;)){
		//在表單中提示有新廠商資料
		Form.setValue(&quot;cbHasNewSupplier&quot;,&quot;true&quot;);
		//若廠商名稱 也找不到,則提示使用者要新建此筆資料(但若使用者已有自行輸入則提示一下確認)
		//但也應先檢查統編規則是否正確
		var ruleCheck = checkID(supplierID);
		if(!ruleCheck)
			msg = &quot;\n輸入的廠商統編不正確!&quot;;
		else if(Form.getValue(field_supplierName).equals(&quot;&quot;))
			msg = &quot;\n該廠商資料不存在,請輸入廠商名稱.\n待財會人員審核後會自動將此筆資料寫入憑證廠商檔&quot;;
		else
			msg = &quot;\n偵測到新廠商資料: &quot;+supplierID + &quot;  &quot; + Form.getValue(field_supplierName);
	}else{
		//若有找到 SupplierName, 則應無條件覆蓋欄位值,即使User已有輸入...
		Form.setValue(field_supplierName,supplierName);
	}
	
	return msg;
}

//檢查輸入的受款人代號是否正確
function checkID(supplierID){
	var len = supplierID.length();
	if(len == 8){
		//廠商統編
		return checkSupplierID(supplierID);
	}else if(len == 10){
		//個人身份證
		return checkPersonalID(supplierID);
	}else{
		return false;
	}
}
//檢查廠商統編規則
/*
公司統一編號檢查規則
例一：99280806
八個數字各乘以1．2．1．2．1．2．4．1
9*1=09
9*2=18
2*1=02
8*2=16
0*1=00
8*2=16
0*4=00
6*1=06
結果十位數的和=3
結果個位數的和=37
兩個數字相加3+37=40
．如果可以被10整除則合乎檢查。

如果不能整除，同時第七個數字是7
例二：000000079
0*1=00
0*2=00
0*1=00
0*2=00
0*1=00
0*2=00
7*4=28(10)
9*1=09

2+17=19不能整除，但第七個數字是7
則將作第二個判斷，將第七個結果數字
改成10，再到第一個判斷規則：
結果是1+9=10
可以被10 整除，則還是合乎規則。
*/
function checkSupplierID(supplierID){
	var result = false;
	supplierID = new java.lang.String(supplierID);
	if(supplierID.length() != 8)
		return false;
		
	try{
		var deciSum_1 = 0;	//十位數之和
		var deciSum_2 = 0;	//個位數之和
		for(var i = 0; i &lt; 8; i++){
			var digit = java.lang.Integer.parseInt(supplierID.substring(i, i+1));
			var value = 0;
			if(i == 0)
				value = digit * 1;
			else if(i == 1)
				value = digit * 2;
			else if(i == 2)
				value = digit * 1;
			else if(i == 3)
				value = digit * 2;
			else if(i == 4)
				value = digit * 1;
			else if(i == 5)
				value = digit * 2;
			else if(i == 6)
				value = digit * 4;
			else if(i == 7)
				value = digit * 1;
				
			//計算十位及個位之和
			deciSum_1 += java.lang.Math.floor(value / 10);
			deciSum_2 += value % 10;
java.lang.System.out.println(i+&quot;:&quot;+value+&quot;/&quot;+deciSum_1+&quot;/&quot;+deciSum_2);
		}
java.lang.System.out.println(&quot;result:&quot;+(deciSum_1 + deciSum_2) % 10);
		
		if((deciSum_1 + deciSum_2) % 10 == 0){
			result = true;
		}else if(supplierID.substring(6, 7).equals(&quot;7&quot;)){
			deciSum_1 = 0;
			deciSum_2 = 0;
			for(var i = 0; i &lt; 8; i++){
				var digit = java.lang.Integer.parseInt(supplierID.substring(i, i+1));
				var value = 0;
				if(i == 0)
					value = digit * 1;
				else if(i == 1)
					value = digit * 2;
				else if(i == 2)
					value = digit * 1;
				else if(i == 3)
					value = digit * 2;
				else if(i == 4)
					value = digit * 1;
				else if(i == 5)
					value = digit * 2;
				else if(i == 6)
					value = 10;
				else if(i == 7)
					value = digit * 1;
					
				//計算十位及個位之和
				deciSum_1 += java.lang.Math.floor(value / 10);
				deciSum_2 += value % 10;
java.lang.System.out.println(&quot;again--&gt;&quot;+i+&quot;:&quot;+value+&quot;/&quot;+deciSum_1+&quot;/&quot;+deciSum_2);
			}
java.lang.System.out.println(&quot;result:&quot;+(deciSum_1 + deciSum_2) % 10);

			if((deciSum_1 + deciSum_2) % 10 == 0)
				result = true;
		}
	}catch(e){
		//若有 NumberFormatException 則必然為錯誤
		result = false;
	}
	
	return result;
}
//檢查個人身份證字號是否正確
function checkPersonalID(perID){
	var result = false;
	
	perID = perID.toUpperCase();
	var value = new java.lang.String(perID.substring(0,1));
	var digitValue = value.compareTo(&quot;A&quot;);
	if(value.equals(&quot;I&quot;))
		digitValue = 34;
	else if(value.equals(&quot;O&quot;))
		digitValue = 35;
	else if(digitValue &lt;= 7)
		digitValue += 10;
	else if(digitValue &lt;= 12)
		digitValue += 9;
	else 
		digitValue += 8;
		
	var x1 = java.lang.Math.floor(digitValue / 10);
	var x2 = digitValue % 10;
	var totalValue = x1 + 9 * x2;
	try{
		var multiFactor = 8;
		for(var i = 1; i &lt; 9; i++){
			var numValue = java.lang.Integer.parseInt(perID.substring(i,i+1));
			totalValue += numValue * multiFactor;
			multiFactor--;
		}
		totalValue += java.lang.Integer.parseInt(perID.substring(9));
		if(totalValue % 10 == 0)
			result = true;
	}catch(e){
		//若有 NumberFormatException 則必然為錯誤
		result = false;
	}
	
	return result;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>取得廠商的相關資訊</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00211250755035128</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2015/02/11 15:00:48</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Server.VerifyLevel</string> 
     </void> 
     <void property="id"> 
      <string>SCL00211250755035128</string> 
     </void> 
     <void property="name"> 
      <string>VerifyLevel</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00101250755035086</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
function setVerify_Level(amount){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	
	var rootid = MyTask.getRootID();
	var roottask =Server.getTask(rootid);
	var af_process_id = roottask.getProcessID();
	var verify_level = getVerifyLevel(af_process_id,dataMap.get(&quot;Process_Type_ID&quot;),amount);
	dataMap.put(&quot;Verify_Level&quot;,verify_level);
}



	function getVerifyLevel(af_process_id,process_type_id,amount){
		var verify_level = &quot;50&quot;;
		var sql_verify_level = &quot;select job_level from a_sign_rule_for_Boss where active =&apos;Y&apos; and af_process_id =&apos;&quot; + af_process_id +&quot;&apos; and process_type_id =&apos;&quot;+ process_type_id +&quot;&apos; and low_limit_amount &lt;= &quot;+ amount +&quot; order by low_limit_amount desc&quot;;
			var vec_verify_level = Server.SQLloadValue(sql_verify_level);
			if(vec_verify_level.size()&gt;0){
				verify_level = vec_verify_level.get(0).get(&quot;job_level&quot;);			
			}
		return verify_level;
	}
	


	
	
	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>200704 請採購專案之後新增使用</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00221111120231968</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.CheckInvoice</string> 
     </void> 
     <void property="id"> 
      <string>SCL00221111120231968</string> 
     </void> 
     <void property="name"> 
      <string>CheckInvoice</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//檢查憑證號碼是否已存在於憑證主檔中
//傳入 invoice 號碼
function checkInvoice(invoiceNo){
	//1.檢查AS400憑證檔
	var querySQL = &quot;Select * from FFAETPI Where IEINVN = &apos;&quot;+invoiceNo+&quot;&apos;&quot;;
	var dataSet = Client.SQLloadValue(querySQL);
	if(dataSet.size() &gt; 0){
		return &quot;憑證號碼已存在 : &quot;+ invoiceNo;
	}
	
	return &quot;&quot;;
}
//
function checkTripInvoice(invoiceNo){
	//1.檢查AS400憑證檔
	var querySQL = &quot;Select * from TBA036 Where INVOICENO = &apos;&quot;+invoiceNo+&quot;&apos;&quot;;
	var dataSet = Client.SQLloadValue(querySQL);
	if(dataSet.size() &gt; 0){
		return &quot;憑證號碼已存在 : &quot;+ invoiceNo;
	}
	
	return &quot;&quot;;
}


//選取發票種類
function getInvoiceType(){
	var querySQL = &quot;Select AJGTP,AJGNM,AJTXAM FROM FFAJMP &quot;;
	var invoiceTypeSet = Client.SQLloadValue(querySQL);
	
	var titleMap = new java.util.TreeMap();
	for(var i = 0; i &lt; invoiceTypeSet.size(); i++){
		var aRow = invoiceTypeSet.get(i);
	
		//以憑證名稱為 Key, 再放 [ID,TXAM] 為 Value
		titleMap.put(aRow.get(&quot;AJGNM&quot;),[aRow.get(&quot;AJGTP&quot;),aRow.get(&quot;AJTXAM&quot;)]);
	}
	
	return titleMap;
}
//檢核發票的英文及數字
function checkInvoiceByLetter(invoiceNo){
	if(invoiceNo == null || invoiceNo.equals(&quot;&quot;))
		return false;
		
	invoiceNo = new java.lang.String(invoiceNo);
	if(invoiceNo.length() &lt; 10)
		return false;
		
	//檢查前兩碼是否為英文
	var L1 = new java.lang.String(invoiceNo.substring(0,1).toUpperCase());
	var L2 = new java.lang.String(invoiceNo.substring(1,2).toUpperCase());
	var compare_1 = L1.compareTo(&quot;A&quot;);
	var compare_2 = L2.compareTo(&quot;A&quot;);
	if(compare_1 &lt; 0 || compare_1 &gt; 25 || compare_2 &lt; 0 || compare_2 &gt; 25){
		return false;
	}
	
	//檢查其餘是否為數字
	try{
		var num = java.lang.Integer.parseInt(invoiceNo.substring(2));
	}catch(e){
		return false;
	}
	
	return true;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>檢查憑證號碼相關格式</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00221160739242421</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2006/10/13 19:34:02</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ECN.SendECMail</string> 
     </void> 
     <void property="id"> 
      <string>SCL00221160739242421</string> 
     </void> 
     <void property="name"> 
      <string>SendECMail</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031157709081640</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
function saveArtGif(filekey){
    var artIns = MyTask.getArtInstance(); 
	var dataMap = artIns.getAppDataMap();
    var vec_ins = new Packages.java.util.Vector(); 
    vec_ins.add(artIns.getID()); 
    // For pdf 檔案轉換範例 
    //var fileName = &quot;C:\\歷史單據\\請購單\\&quot; + MyTask.getKeyWord().trim() + &quot;.pdf&quot;; 
    //PS.上述檔案存放目錄路徑，敬請手動在 FlowEngine 主機端 新增,如 C:\\歷史單據\請購單 //Server.saveArtifactListToPDF(v,&quot;FullPage&quot;,fileName,&quot;&quot;,true,8,0,8,8,1); 
    // For JPG 轉換範例 
    var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() + &quot;.jpg&quot;; 
	var vec_file = new Packages.java.util.Vector(); 
	vec_file.add(fileName); 
	Server.saveArtifactListToJPG(vec_ins,vec_file,&quot;FullPage&quot;,false,8,0,8,8,1) 
}
	
// ------------------------------------------------------ 
function sendECMail(groupname,filekey){
//2.於Boss簽核關卡之PostAction產生SendMail動作 
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        var to = getProcessMailAddressList(groupname); 
        var cc = &quot;&quot;; //cc觀察用 
        var subject = dataMap.get(filekey).trim() + &quot;-&quot; + dataMap.get(&quot;DCC_Name&quot;); // Mail Subject 
		var text = dataMap.get(filekey).trim() + &quot; 如附件 &quot;; 
        var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        fileList.add(fileName); 
        Server.sendMail(from,to,cc,subject,text,fileList); 
}
//---------------------------------------------------------
//取得Root Task 流程所經過的人+ 特定 table 抓出來的 email address 字串

function getProcessMailAddressList(groupname){

	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	//流程上的成員
	var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;exeid&quot;)) != null){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
	}
	//Table 上的成員
	var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;memid&quot;)) != null){
					memset.add(vec.get(i).get(&quot;memid&quot;));
			}
		}
	}
	
	var key = memset.iterator();
	while(key.hasNext()){
		var memid = key.next();
		if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
			emailaddress += Server.getMember(memid).getEmail() + &quot;;&quot; ;
		}
	}
	return emailaddress;	
}
//---------------------------------------------------------- 
function sendPCRMail(toid,filekey,toid1,a2){
//2.於Boss簽核關卡之PostAction產生SendMail動作 
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Server.getMember(&quot;administrator&quot;).getEmail();
        //var to = getProcessMailAddressList(groupname); 
		if (dataMap.get(toid)!=null){
			var tomember = Server.getMember(dataMap.get(toid));
			var to1 = tomember.getEmail();
			}
			else{
				var to1 =&quot;&quot;;
			}
		var tomember2 = Server.getMember(dataMap.get(toid1));
		//var to2 = tomember2.getEmail();
		//var to=to1+ &quot;;&quot; + to2;
		var to = getProcessMailAddressList(&quot;空&quot;);
        var cc = &quot;&quot;; //cc觀察用 
        var subject = dataMap.get(filekey).trim()+&quot;_裁決:&quot; + a2; // Mail Subject 
		//var text = dataMap.get(filekey).trim() + &quot; 如附件 &quot;; 
		var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
		var text = &quot;請點取網路連結 &lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;&quot; + dataMap.get(filekey).trim()+ &quot;&lt;/a&gt;&quot; ; 
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
        Server.sendMail(from,to,cc,subject,text,fileList); 
}

function sendECNCSMail(){
	var InsID = MyTask.getArtInstance();
	var dataMap = InsID.getAppDataMap();
	var cMember = Server.getMember(MyTask.getMemberID());
	var fromMail= Server.getMember(&quot;Administrator&quot;).getEmail();//系統管理員為寄件者
	var toEMail = cMember.getEmail();
	var totalccMail = &quot;&quot;;
	var title = &quot;請會簽&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單&quot;;
	var urlData = &quot;&lt;a href=\&quot;$webAgendaURL$mailOpenFormCheckpass\&quot;&gt;會簽單&lt;/a&gt;&quot;;
	var data = &quot; 您好：&quot;+&quot;\n&quot;+&quot;\n&quot;;
	data = data + &quot;這是系統自動發出的一封通知信，請至 EIP 上進行會簽簽核，\n&quot;;
	data = data +&quot;表單內容為：&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單 \n&quot;;
	data = data +&quot;會簽簽核時請點選「加會意見」及請務必填寫「同意」或「不同意」；\n&quot;;
	data = data +&quot;並寫下您對這份ECN的建議處理等級；\n&quot;;	
	data = data +&quot;BC:追溯至客戶\n&quot;;
	data = data +&quot;FG:追溯至成品\n&quot;;
	data = data +&quot;SG:追溯至半成品\n&quot;;
	data = data +&quot;MC:立即生效但不追溯\n&quot;;
	data = data +&quot;RC:舊料用完生效\n&quot;;
	data = data +&quot;DC:只變更文件\n&quot;;
	data = data +&quot;OT:其他\n&quot;;	
	
   data = data + &quot; 您可以開啟 &quot;+urlData+&quot;，來查看該表單。&quot;+&quot;\n  \n \n   MIS &quot;;
   data = &quot;&lt;pre&gt;&quot;+data+&quot;&lt;/pre&gt;&quot;;
    var vector = new java.util.Vector();
     //taskID
    var taskID = MyTask.getID();  
    Server.sendHTMLMailExt(fromMail,toEMail,totalccMail,title,data,vector,taskID);  
 }
 
 
 
//設定會簽人員 from table
function addAddASAudit(groupname){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var memset = getProcessMemberList(groupname);
	if(memset != null &amp;&amp; memset.size()&gt;0){
		MyTask.setExecuteAddAS(true);
		MyTask.setAddASType(MyTask.ADD_PARALLEL_ANNOUNCE);
		var key = memset.iterator();
		while(key.hasNext()){
			var memid = key.next();
			if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
				var member = Server.getMember(memid);
				if(member.getMainRoleID() != null &amp;&amp; member.getMainRoleID() != &quot;&quot;){
					MyTask.addAddASAudit(member.getID(),member.getMainRoleID(),member.getMemberDR(member.getMainRoleID()).getDepartmentID());
				}else if (member.getRoleList().size()&gt;0){
					MyTask.addAddASAudit(member.getID(),member.getRoleList().get(0),member.getMemberDR(member.getMainRoleID()).getDepartmentID());					
				}
			}
		} //while
	}
}

/*
	var vac = dataMap.get(sign_table);
	if(vac.size()&gt;0){
		MyTask.setExecuteAddAS(true);
		MyTask.setAddASType(MyTask.ADD_PARALLEL_ANNOUNCE);
		//MyTask.addAddASAudit(&quot;MEM01619&quot;,&quot;ROLH010ACF&quot;,&quot;DEPH010A&quot;);
		for(var i = 0;i&lt; vac.size();i++){
			var username = vac.get(i).get(itemid);
			var member = Server.getMember(username);
			MyTask.addAddASAudit(member.getID(),member.getMainRoleID(),member.getMemberDR(member.getMainRoleID()).getDepartmentID());
		}
	}
*/	
	function sendECMail4(groupname,filekey){
//給 url 連結 可開啟表單且可下載附件
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
 		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        var to = getProcessMailAddressList(groupname); 
        var cc = &quot;&quot;; //cc觀察用 
        var subject = dataMap.get(filekey).trim() + &quot;-&quot; + dataMap.get(&quot;DCC_Name&quot;) + &quot;-&quot; + dataMap.get(&quot;Mail_Subject&quot;); // Mail Subject 
		//var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
		var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置
		var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
		var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
		var taskID = MyTask.getID();
		var member = Server.getMember(MyTask.getMemberID());
		//var userName = member.getName();
		var userName = member.getLoginID();
		var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
		var key = Packages.util.SecurityURL.encode(temp);
		var url = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
		var text = &quot;&lt;html&gt;&lt;body&gt;&quot;+ &quot;請點取網路連結 &lt;a href=&quot;+ url +&quot;&gt;&quot; + dataMap.get(filekey).trim()+ &quot;&lt;/a&gt;&lt;br&gt;主旨：&quot;+ dataMap.get(&quot;Mail_Subject&quot;) +&quot;&lt;/body&gt;&lt;/html&gt;&quot; ; 
        var fileList = new Packages.java.util.Vector(); 
		//fileList = addAttachFile(fileList);
        Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
}
	
	function sendECMail3(groupname,filekey){
//給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        var to = getProcessMailAddressList(groupname); 
        var cc = &quot;&quot;; //cc觀察用 
        var subject = dataMap.get(filekey).trim() + &quot;-&quot; + dataMap.get(&quot;DCC_Name&quot;) + &quot;-&quot; + dataMap.get(&quot;Mail_Subject&quot;); // Mail Subject 
		var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
		var text = &quot;請點取網路連結 &lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;&quot; + dataMap.get(filekey).trim()+ &quot;&lt;/a&gt;&quot; ; 
        var fileList = new Packages.java.util.Vector(); 
		//fileList = addAttachFile(fileList);
        Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
}
	
	function sendECMail2(groupname,filekey){
// mail 圖檔 
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        var to = getProcessMailAddressList(groupname); 
        var cc = &quot;&quot;; //cc觀察用 
        var subject = dataMap.get(filekey).trim() + &quot;-&quot; + dataMap.get(&quot;DCC_Name&quot;) + &quot;-&quot; + dataMap.get(&quot;Mail_Subject&quot;); // Mail Subject 
		var text = dataMap.get(filekey).trim() + &quot; 如附件 &quot;; 
        var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        fileList.add(fileName); 
		//fileList = addAttachFile(fileList);
        Server.sendMail(from,to,cc,subject,text,fileList); 
}

function addAttachFile(fileList){
	var taskID = MyTask.getID();
    var artID = artInstance.getArtifactID();
    var InsID = artInstance.getID();
    var sql = &quot;select  FileName from AttachFile where  ArtInsID = &apos;&quot;+InsID+&quot;&apos;&quot;;
    var vc = Server.SQLloadValue(sql);
    if (vc.size()&gt;0){
       for (var j=0;j&lt;vc.size();j++){
           var fileInfo = vc.get(j);
           var fileName = fileInfo.get(&quot;FileName&quot;);//檔名
           var fileUploadPath = &quot;.\\FileUpload\\&quot;+artID+&quot;\\&quot;+InsID+&quot;ITEM210&quot;+&quot;\\&quot;+fileName;;
		   // 完整路徑路徑 ITEM55 為該夾檔元件eform 元件於資料庫中所存在 欄位ITEM，敬請透過文件設定中 for 文件屬性設定查詢得知。
           vector.addElement(fileUploadPath);
       }
    }
	return fileList;
}

//---------------------------------------------------------
//取得Root Task 流程所經過的人+ 特定 table 抓出來的 memid set
//扣掉上一關的人
function getProcessMemberList(groupname){
	var emailaddress = &quot;&quot;;
	var fronttaskid = MyTask.getFrontID();
	var frontmemid = Server.getTask(fronttaskid).getRealExecutor();
	var memset = java.util.TreeSet();
	//流程上的成員
	var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid and exeid !=&apos;&quot;+ frontmemid + &quot;&apos; &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			//去除已離職的人
			if(Server.getMember(vec.get(i).get(&quot;exeid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;exeid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
	}
	//Table 上的成員
	var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;memid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;memid&quot;));
			}
		}
	}
	return memset;	
}
//---------------------------------------------------------- 


function haveAttachFile(){
	var str = &quot;否&quot;;
	var taskID = MyTask.getID();
	var artInstance = MyTask.getArtInstance(); 
    var artID = artInstance.getArtifactID();
    var InsID = artInstance.getID();
    var sql = &quot;select  FileName from AttachFile where  ArtInsID = &apos;&quot;+InsID+&quot;&apos;&quot;;
    var vc = Server.SQLloadValue(sql);
    if (vc.size()&gt;0){
		str = &quot;是&quot;;
    }
	return str;
}


//------------------------
// 發 mail 開啟連結用的 URL 
// n == 1 //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件 ( ie7 無法直接開 ) 
// n == 2 //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
// n == 3 //email開表單，需密碼
// n == 4 //email開表單，不需密碼
//------------------------
function getUrl(n){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
           var aInstance = MyTask.getArtInstance(); 
           var dataMap = aInstance.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                     //var userName = member.getName();
                     var userName = member.getLoginID();
                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
           }
           return url;
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00221250755035131</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/05/22 15:17:27</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Server.VerifyNote</string> 
     </void> 
     <void property="id"> 
      <string>SCL00221250755035131</string> 
     </void> 
     <void property="name"> 
      <string>VerifyNote</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00101250755035086</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//com.A.Common.Server.VerifyNote
function setVerifyName(){
		//設定主管簽核姓名
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		vMEM = Server.getMemberByID(MyTask.getRealExecutor());
		dataMap.put(&quot;Verify_ID&quot;,vMEM.getMyID() );		//getMember modi by wangwei@2013/04/11
		dataMap.put(&quot;Verify_Name&quot;,vMEM.getName() );     //getMember modi by wangwei@2013/04/11
		dataMap.put(&quot;Agree&quot;,&quot;true&quot;);
		dataMap.put(&quot;Reject&quot;,&quot;false&quot;);
}


function setTaskRole(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		if(&quot;&quot; != dataMap.get(&quot;Next_Member_Role&quot;)){
			MyTask.setRoleID(dataMap.get(&quot;Next_Member_Role&quot;)); //設定Task 所屬的職務 
		}
}

// add by wangwei@2009/03/09
// 目的: 將現在時間放入表單上的欄位@col_name 
function setDateTime(col_name){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var Ob_date = new Packages.pase.agenda.MyDate();
		var ls_date = Ob_date.getCurrentDate(&quot;Y/M/D H:m&quot;); 
		dataMap.put(col_name,ls_date);	
	}
//add by edison@20190430
//發送teamplus情報訊息，通知關人員簽核
function callTeamPlusSendSuperHubMsg(msg_content){
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var ch_sn = &quot;124&quot;;//14
	var api_key = &quot;c048b58eb2354159886bd2fe0936dcf3&quot;;//a8c639f752364ca99a70eae727da953a
	var content_type = &quot;1&quot;;//固定1
	var text_content = msg_content;//發送情報內容
	var media_content = &quot;&quot;;//固定空值
	var file_show_name = &quot;&quot;;//固定空值
	var msg_push = &quot;&quot;;//固定空值
	var memid = MyTask.getRealExecutor();//接收人員  格式: &apos;edison_wang&apos;,&apos;wangwei&apos;,&apos;yingchieh_wang&apos;
	var loginid = Server.getMemberByID(memid).getLoginID();
	Server.addDebugLog(&quot;loginid===&quot;+loginid);
//	var account_list = &quot;&apos;&quot;+loginid+&quot;&apos;&quot;;
	var account_list = &quot;&apos;edison_wang&apos;&quot;;
	
	if(ch_sn!=&quot;&quot; &amp;&amp; api_key!=&quot;&quot; &amp;&amp; content_type!=&quot;&quot; &amp;&amp; text_content!=&quot;&quot; &amp;&amp; account_list!=&quot;&quot;){
		var UrlPostTest = new Packages.ext.UrlPostTest();
		var text = &quot;   您 好: \n&quot;;
		text += &quot;   \n&quot;;
		text += &quot;   有一張&quot;+Server.getTask(MyTask.getParentID()).getProcessName()+&quot;已送達，請撥冗簽核處理。\n&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;\n&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;\n&quot;;
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;\n&quot;;
		text += &quot;   申請人 : &quot; + dataMap.get(&quot;App_Name&quot;)  	+&quot;\n&quot;;
		text += &quot;   單號 : &quot; + dataMap.get(&quot;Sn&quot;)  	+&quot;\n&quot;;
		text += &quot;   填單日期 : &quot; + dataMap.get(&quot;Create_Date&quot;)  	+&quot;\n&quot;;
		
		var response_msg = UrlPostTest.sendSuperHubMsg(ch_sn, api_key,content_type,text+text_content,media_content,file_show_name,msg_push,account_list);
		Server.addDebugLog(&quot;Team+情報發送:&quot;+artIns.getID()+&quot;__&quot;+response_msg)	;
	}
}
</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00231111149037203</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.MemberFunction.DepartmentFunction</string> 
     </void> 
     <void property="id"> 
      <string>SCL00231111149037203</string> 
     </void> 
     <void property="name"> 
      <string>DepartmentFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031102066129487</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//輸入部門代號(MyID),取得部門物件
//由於 API 只提供由 DepID 取部門的功能,因此自行實作一個
//MyID 可能會重複,故傳回為 Vector
function getDepartmentByMyID(myID){
//	var querySQL = &quot;Select DEPID from DEP_GENINF Where ID = &apos;&quot;+myID+&quot;&apos; Order By RESPON&quot;;
	var querySQL = &quot;Select DEPID from DEP_GENINF Where ID = &apos;&quot;+myID+&quot;&apos; &quot;;
	var depSet = Client.SQLloadValue(querySQL);
	var result = new java.util.Vector();
	for(var i = 0; i &lt; depSet.size(); i++){
		var aRow = depSet.get(i);
		var depID = aRow.get(&quot;DEPID&quot;);
		result.add(Client.getDepartment(depID));
	}
	
	return result;
}
//輸入部門代號(MyID),取得部門物件 (可使用於Server side)
//由於 API 只提供由 DepID 取部門的功能,因此自行實作一個
//MyID 可能會重複,故傳回為 Vector
function getDepartmentByMyID_new(runSide,myID){
//	var querySQL = &quot;Select DEPID from DEP_GENINF Where ID = &apos;&quot;+myID+&quot;&apos; Order By RESPON&quot;;
	var querySQL = &quot;Select DEPID from DEP_GENINF Where ID = &apos;&quot;+myID+&quot;&apos; &quot;;
	var depSet = runSide.SQLloadValue(querySQL);
	var result = new java.util.Vector();
	for(var i = 0; i &lt; depSet.size(); i++){
		var aRow = depSet.get(i);
		var depID = aRow.get(&quot;DEPID&quot;);
		result.add(runSide.getDepartment(depID));
	}
	
	return result;
}
//取出權責在 5 以上(1~5)的部門代號,以作為科目的部門
function getResponDep(responLevel){
	if(responLevel == null)
		responLevel = new java.lang.Integer(5);
	else
		responLevel = new java.lang.Integer(responLevel);

/*
		var task = Form.getCurrentTask();
		var mID = task.getRealExecutor();
      
		var cMember = Client.getMemberByID(mID);
		var memRoleID = cMember.getMainRoleID();
		var memDR = cMember.getMemberDR(memRoleID);
		var depID = memDR.getDepartmentID();
*/

	var cMember = Client.getCurrentMember();
	var memRoleID = cMember.getMainRoleID();
	var memDR = cMember.getMemberDR(memRoleID);
	var depID = memDR.getDepartmentID();
	

   var department = Client.getDepartment(depID);

   var respon = java.lang.Float.parseFloat(department.getResopnsibility().trim());
   while(respon &gt; responLevel.intValue()){
   	var parentDepID = department.getParentID();
   	var department = Client.getDepartment(parentDepID);
   	respon = java.lang.Float.parseFloat(department.getResopnsibility().trim());
   }
   
   return department;
}
//取出表單執行者的 department 物件 2005/11/22 Modified by Johann Hsu
function getStartFlowDep(){

	var cMember = Client.getCurrentMember();
	var memRoleID = cMember.getMainRoleID();
	var memDR = cMember.getMemberDR(memRoleID);
	var depID = memDR.getDepartmentID();

    var department = Client.getDepartment(depID);
   
    return department;
}
//取出該人員主要職務的所屬部門(其主管權責為40或40以上的部門) 可用 Server 及 Client Script  
//2005/12/8 Modified by Johann Hsu  
function getMainDepartment(runSide,theMember){
	//先取得該人員的部門
	var memRoleID = theMember.getMainRoleID();
	var memDR = theMember.getMemberDR(memRoleID);
	var department = runSide.getDepartment(memDR.getDepartmentID());
	var managerRoleID = department.getManagerID();
	var managerRole = runSide.getRole(managerRoleID);
		

	//若該部門的主管權責小於40,或是沒有主管,則再找上一層組織的主管
	while (department == null || managerRole == null || managerRole.getSynopsis() &lt; 40 ) {
		var parentID=&quot;&quot;;
		if (department != null) 
			parentID = department.getParentID();  //上層部門ID (可能是RoleID)
		else
			parentID = managerRole.getParentID();  //上層部門ID (可能是RoleID)
			
		java.lang.System.out.println(&quot;parentID : &quot;+parentID);	
		
		department = runSide.getDepartment(parentID);
		if ( department != null){
			managerRoleID = department.getManagerID();  //上層主管RoleID
			managerRole = runSide.getRole(managerRoleID);
		} else {
			managerRoleID = parentID;  //上層主管RoleID
			managerRole = runSide.getRole(managerRoleID);
		}
	}

	return department;
}
//取出該人員主要職務的所屬部門(其主管權責為 X 或 X 以上的部門) 可用 Server 及 Client Script  
//2005/12/8 Modified by Johann Hsu  
function getMainDepartmentRes(runSide,theRespon,theMember){
	//先取得該人員的部門
	var memRoleID = theMember.getMainRoleID();
	var memDR = theMember.getMemberDR(memRoleID);
	var department = runSide.getDepartment(memDR.getDepartmentID());
	var managerRoleID = department.getManagerID();
	var managerRole = runSide.getRole(managerRoleID);
		

	//若該部門的主管權責小於 X ,或是沒有主管,則再找上一層組織的主管
	while (department == null || managerRole == null || managerRole.getSynopsis() &lt; new java.lang.Integer(theRespon) ) {
		var parentID=&quot;&quot;;
		if (department != null) 
			parentID = department.getParentID();  //上層部門ID (可能是RoleID)
		else
			parentID = managerRole.getParentID();  //上層部門ID (可能是RoleID)
			
		department = runSide.getDepartment(parentID);
		if ( department != null){
			managerRoleID = department.getManagerID();  //上層主管RoleID
			managerRole = runSide.getRole(managerRoleID);
		} else {
			managerRoleID = parentID;  //上層主管RoleID
			managerRole = runSide.getRole(managerRoleID);
		}
	}

	return department;
}
//取出該人員主要職務的所屬會計部門(其部門為快速分攤表之部門) 可用 Server 及 Client Script  
//2005/2/10 Modified by Johann Hsu  upDownFlag : &quot;U&quot; 往上找, &quot;D&quot; Hard code
function getAccDepartmentRes(runSide,depIDList,theMember){
	//先取得該人員的部門
	var memRoleID = theMember.getMainRoleID();
	var memDR = theMember.getMemberDR(memRoleID);
	var department = runSide.getDepartment(memDR.getDepartmentID());
	var upDownFlag = department.getSynopsis().toString().split(&quot;;&quot;)[0];
	var managerRoleID = department.getManagerID();
	var managerRole = runSide.getRole(managerRoleID);
   	var company = null;
	
	var aDepID = new java.util.HashMap();
    aDepID.put(&quot;DEPID&quot;,department.getMyID());
	
	
		
	if (upDownFlag.equals(&quot;U&quot;)){
		//若該部門不為快速分攤表之部門 ,再找上一層組織
		while (company == null &amp;&amp; (department == null || managerRole == null || depIDList.indexOf(aDepID)==-1)) {
			var parentID=&quot;&quot;;
			if (department != null) 
				parentID = department.getParentID();  //上層部門ID (可能是RoleID)
			else
				parentID = managerRole.getParentID();  //上層部門ID (可能是RoleID)
			
			department = runSide.getDepartment(parentID);
			managerRole = runSide.getRole(parentID);
			
			if ( department != null){
				managerRoleID = department.getManagerID();  //上層主管RoleID
				managerRole = runSide.getRole(managerRoleID);
				aDepID.clear();
				aDepID.put(&quot;DEPID&quot;,department.getMyID());
			} else if(managerRole != null) {
				managerRoleID = parentID;  //上層主管RoleID
				managerRole = runSide.getRole(managerRoleID);
			} else {
				company = runSide.getCompany();
				var showDep = getShowDepartmentRes(runSide,theMember);
				department = getAccDepartmentResByDep(runSide,depIDList,showDep);
			}
		}
	} else if(upDownFlag.equals(&quot;D&quot;)) {
		// Hard code 部門
		if (department.getName().equals(&quot;營業總處&quot;)){ //如果是營業總處 其會計科目歸屬為營業本部 
			var department = runSide.getDepartment(&quot;DEP02011126745721562&quot;); //營業本部 DEPDID為DEP02011126745721562 
		} else if (department.getName().equals(&quot;業務處&quot;)){//如果是業務處 其會計科目歸屬為業務部
			var department = runSide.getDepartment(&quot;DEP02001125457261718&quot;); //業務部 DEPDID為DEP02001125457261718 
		} else if (department.getName().equals(&quot;檢驗課&quot;)){//如果是檢驗課 其會計科目歸屬為檢驗課
			var department = runSide.getDepartment(&quot;DEP01971119944452078&quot;); //檢驗課 DEPDID為DEP01971119944452078
		} else if (department.getName().equals(&quot;維修中心&quot;)){//如果是維修中心 其會計科目歸屬為維修中心
			var department = runSide.getDepartment(&quot;DEP01961119944414093&quot;); //維修中心 DEPDID為DEP01961119944414093
		} else { //正常狀況
			
		}	
	
	
	} else {
		
		
	}
	
	return department;
}
//取出該人員主要職務的所屬會計部門(其部門為快速分攤表之部門) 可用 Server 及 Client Script  
//2005/2/10 Modified by Johann Hsu  upDownFlag : &quot;U&quot; 往上找, &quot;D&quot; 不處理 
function getAccDepartmentRes_old(runSide,depIDList,theMember){
	//先取得該人員的部門
	var memRoleID = theMember.getMainRoleID();
	var memDR = theMember.getMemberDR(memRoleID);
	var department = runSide.getDepartment(memDR.getDepartmentID());
	var upDownFlag = department.getSynopsis().toString().split(&quot;;&quot;)[0];
	var managerRoleID = department.getManagerID();
	var managerRole = runSide.getRole(managerRoleID);
   	var company = null;
	
	var aDepID = new java.util.HashMap();
    aDepID.put(&quot;DEPID&quot;,department.getMyID());
	
	
		
	if (upDownFlag.equals(&quot;U&quot;)){
		//若該部門不為快速分攤表之部門 ,再找上一層組織
		while (company == null &amp;&amp; (department == null || managerRole == null || depIDList.indexOf(aDepID)==-1)) {
			var parentID=&quot;&quot;;
			if (department != null) 
				parentID = department.getParentID();  //上層部門ID (可能是RoleID)
			else
				parentID = managerRole.getParentID();  //上層部門ID (可能是RoleID)
			
			department = runSide.getDepartment(parentID);
			managerRole = runSide.getRole(parentID);
			
			if ( department != null){
				managerRoleID = department.getManagerID();  //上層主管RoleID
				managerRole = runSide.getRole(managerRoleID);
				aDepID.clear();
				aDepID.put(&quot;DEPID&quot;,department.getMyID());
			} else if(managerRole != null) {
				managerRoleID = parentID;  //上層主管RoleID
				managerRole = runSide.getRole(managerRoleID);
			} else {
				company = runSide.getCompany();
				var showDep = getShowDepartmentRes(runSide,theMember);
				department = showDep;
				
			}
		}
	} else if(upDownFlag.equals(&quot;D&quot;)) {
		//不處理,直接回傳該人員部門物件	
	
	} else {
		
		
	}
	
	return department;
}
//取出部門所屬會計部門(其部門為快速分攤表之部門) 可用 Server 及 Client Script  
//2005/3/14 Modified by Johann Hsu  upDownFlag : &quot;U&quot; 往上找, &quot;D&quot; Hard code 
function getAccDepartmentResByDep(runSide,depIDList,depObj){
	
	var department = depObj
	var upDownFlag = department.getSynopsis().toString().split(&quot;;&quot;)[0];
	var managerRoleID = department.getManagerID();
	var managerRole = runSide.getRole(managerRoleID);
	var company = null;
	
   	var aDepID = new java.util.HashMap();
    aDepID.put(&quot;DEPID&quot;,department.getMyID()); 
		
	if (upDownFlag.equals(&quot;U&quot;)){
		//若該部門不為快速分攤表之部門 ,再找上一層組織
		while (company == null &amp;&amp; (department == null || managerRole == null || depIDList.indexOf(aDepID)==-1)) {
			var parentID=&quot;&quot;;
			if (department != null) 
				parentID = department.getParentID();  //上層部門ID (可能是RoleID)
			else
				parentID = managerRole.getParentID();  //上層部門ID (可能是RoleID)
				
			department = runSide.getDepartment(parentID);
			managerRole = runSide.getRole(parentID);

			if ( department != null){
				managerRoleID = department.getManagerID();  //上層主管RoleID
				managerRole = runSide.getRole(managerRoleID);
				aDepID.clear();
				aDepID.put(&quot;DEPID&quot;,department.getMyID());
			} else if(managerRole != null){
				managerRoleID = parentID;  //上層主管RoleID
				managerRole = runSide.getRole(managerRoleID);
			} else {
				company = runSide.getCompany();
				var showDep = getShowDepartmentResByDep(runSide,depObj);
				department = getAccDepartmentResByDep(runSide,depIDList,showDep);
				
			}	
		}
	} else if(upDownFlag.equals(&quot;D&quot;)) {
		// Hard code 部門
			
		if (department.getName().equals(&quot;營業總處&quot;)){ //如果是營業總處 其會計科目歸屬為營業本部 
			var department = runSide.getDepartment(&quot;DEP02011126745721562&quot;); //營業本部 DEPDID為DEP02011126745721562 
		} else if (department.getName().equals(&quot;業務處&quot;)){//如果是業務處 其會計科目歸屬為業務部
			var department = runSide.getDepartment(&quot;DEP02001125457261718&quot;); //業務部 DEPDID為DEP02001125457261718 
		} else if (department.getName().equals(&quot;檢驗課&quot;)){//如果是檢驗課 其會計科目歸屬為檢驗課
			var department = runSide.getDepartment(&quot;DEP01971119944452078&quot;); //檢驗課 DEPDID為DEP01971119944452078
		} else if (department.getName().equals(&quot;維修中心&quot;)){//如果是維修中心 其會計科目歸屬為維修中心
			var department = runSide.getDepartment(&quot;DEP01961119944414093&quot;); //維修中心 DEPDID為DEP01961119944414093
		} else { //正常狀況
			
		}	
	} else {
		
		
	}	
 	
	return department;
}
//取出部門所屬會計部門(其部門為快速分攤表之部門) 可用 Server 及 Client Script  
//2005/2/10 Modified by Johann Hsu  upDownFlag : &quot;U&quot; 往上找, &quot;D&quot; 不處理 
function getAccDepartmentResByDep_old(runSide,depIDList,depObj){
	
	var department = depObj
	var upDownFlag = department.getSynopsis().toString().split(&quot;;&quot;)[0];
	var managerRoleID = department.getManagerID();
	var managerRole = runSide.getRole(managerRoleID);
	var company = null;
	
   	var aDepID = new java.util.HashMap();
    aDepID.put(&quot;DEPID&quot;,department.getMyID()); 
		
	if (upDownFlag.equals(&quot;U&quot;)){
		//若該部門不為快速分攤表之部門 ,再找上一層組織
		while (company == null &amp;&amp; (department == null || managerRole == null || depIDList.indexOf(aDepID)==-1)) {
			var parentID=&quot;&quot;;
			if (department != null) 
				parentID = department.getParentID();  //上層部門ID (可能是RoleID)
			else
				parentID = managerRole.getParentID();  //上層部門ID (可能是RoleID)
				
			department = runSide.getDepartment(parentID);
			managerRole = runSide.getRole(parentID);

			if ( department != null){
				managerRoleID = department.getManagerID();  //上層主管RoleID
				managerRole = runSide.getRole(managerRoleID);
				aDepID.clear();
				aDepID.put(&quot;DEPID&quot;,department.getMyID());
			} else if(managerRole != null){
				managerRoleID = parentID;  //上層主管RoleID
				managerRole = runSide.getRole(managerRoleID);
			} else {
				company = runSide.getCompany();
				var showDep = getShowDepartmentResByDep(runSide,depObj);
				department = showDep;				
			}	
		}
	} else if(upDownFlag.equals(&quot;D&quot;)) {
		//不處理,直接回傳該人員部門物件	
	
	} else {
		
		
	}	
 	
	return department;
}
//取出該人員主要職務的所能代填部門(由填寫人員部門往上找 Level) 可用 Server 及 Client Script  
//2005/2/10 Modified by Johann Hsu  
function getShowDepartmentRes(runSide,theMember){
	//先取得該人員的部門
	var memRoleID = theMember.getMainRoleID();
	var memDR = theMember.getMemberDR(memRoleID);
	var department = runSide.getDepartment(memDR.getDepartmentID());
	var showUpLevelFlag = department.getSynopsis().toString().split(&quot;;&quot;)[1];
	var managerRoleID = department.getManagerID();
	var managerRole = runSide.getRole(managerRoleID);
   	var aDepID = new java.util.Vector();
	aDepID.add(department.getMyID()); 
	
	
	//若該部門的主管權責小於 X ,或是沒有主管,則再找上一層組織的主管
	while (department == null || managerRole == null || aDepID.size() -1 &lt; new java.lang.Integer(showUpLevelFlag).intValue()) {
		var parentID=&quot;&quot;;
		if (department != null) 
			parentID = department.getParentID();  //上層部門ID (可能是RoleID)
		else
			parentID = managerRole.getParentID();  //上層部門ID (可能是RoleID)
			
		department = runSide.getDepartment(parentID);
		if ( department != null){
			managerRoleID = department.getManagerID();  //上層主管RoleID
			managerRole = runSide.getRole(managerRoleID);
			aDepID.add(department.getMyID()); 
		} else {
			managerRoleID = parentID;  //上層主管RoleID
			managerRole = runSide.getRole(managerRoleID);
		}
	}

	return department;
}
//取出該部門的所能代填部門(由填寫人員部門往上找 Level) 可用 Server 及 Client Script  
//2005/2/10 Modified by Johann Hsu  
function getShowDepartmentResByDep(runSide,depObj){
	
	var department =depObj
	var showUpLevelFlag = department.getSynopsis().toString().split(&quot;;&quot;)[1];
	var managerRoleID = department.getManagerID();
	var managerRole = runSide.getRole(managerRoleID);
   	var aDepID = new java.util.Vector();
	aDepID.add(department.getMyID()); 
	
	
	//若該部門的主管權責小於 X ,或是沒有主管,則再找上一層組織的主管
	while (department == null || managerRole == null || aDepID.size() -1 &lt; new java.lang.Integer(showUpLevelFlag).intValue()) {
		var parentID=&quot;&quot;;
		if (department != null) 
			parentID = department.getParentID();  //上層部門ID (可能是RoleID)
		else
			parentID = managerRole.getParentID();  //上層部門ID (可能是RoleID)
			
		department = runSide.getDepartment(parentID);
		if ( department != null){
			managerRoleID = department.getManagerID();  //上層主管RoleID
			managerRole = runSide.getRole(managerRoleID);
			aDepID.add(department.getMyID()); 
		} else {
			managerRoleID = parentID;  //上層主管RoleID
			managerRole = runSide.getRole(managerRoleID);
		}
	}

	return department;
}
//判斷該人員與所選人員陣列是否為同一會計科目,將不同的挑出來 可用 Server 及 Client Script  
//2005/2/10 Modified by Johann Hsu  
function getNotTheSameAccDep(runSide,theMember,memList){
	
	var notTheSameAccMemList = new java.util.Vector();
	var accDep = getAccDepartmentRes(runSide,getAccDepartmentList(runSide),theMember);
	var accDepID = accDep.getMyID(); 
	for (var i = 0; i &lt; memList.size(); i++){
		aMem = memList.get(i);
		aAccDep = getAccDepartmentRes(runSide,getAccDepartmentList(runSide),aMem);
		aDepID = aAccDep.getMyID();
		if (!accDepID.equals(aDepID)){
			notTheSameAccMemList.add(aMem);
		}	
	}

	return notTheSameAccMemList;
}
//判斷該人員與所選人員陣列是否為同一會計科目 可用 Server 及 Client Script  
//2005/2/10 Modified by Johann Hsu  
function isTheSameAccDep(runSide,theMember,memList){
	
	var istheSameFlag = true;
	var accDep = getAccDepartmentRes(runSide,getAccDepartmentList(runSide),theMember);
	var accDepID = accDep.getMyID(); 
	for (var i = 0; i &lt; memList.size(); i++){
		aMem = memList.get(i);
		aAccDep = getAccDepartmentRes(runSide,getAccDepartmentList(runSide),aMem);
		aDepID = aAccDep.getMyID();
		if (!accDepID.equals(aDepID)){
			istheSameFlag = false;
			break;
		}	
	}

	return istheSameFlag;
}
//判斷該部門與所選部門陣列是否為同一會計科目,將不同的挑出來 可用 Server 及 Client Script  
//2005/2/10 Modified by Johann Hsu  
function getNotTheSameAccDepByDep(runSide,depObj,depObjList){
	
	var notTheSameAccDep = new java.util.Vector();
	var department =depObj
	var accDep = getAccDepartmentResByDep(runSide,getAccDepartmentList(runSide),department);
	var accDepID = accDep.getMyID(); 
	for (var i = 0; i &lt; depObjList.size(); i++){
		aDep = depObjList.get(i);
		aDepID = aDep.getMyID();
		if (!accDepID.equals(aDepID)){
			notTheSameAccDep.add(aDep);
		}	
	}

	return notTheSameAccDep;
}
//判斷該部門與所選部門陣列是否為同一會計科目 可用 Server 及 Client Script  
//2005/2/10 Modified by Johann Hsu  
function isTheSameAccDepByDep(runSide,depObj,depObjList){
	
	var istheSameFlag = true;
	var department =depObj
	var accDep = getAccDepartmentResByDep(runSide,getAccDepartmentList(runSide),department);
	var accDepID = accDep.getMyID(); 
	for (var i = 0; i &lt; depObjList.size(); i++){
		aDep = depObjList.get(i);
		aDepID = aDep.getMyID();
		if (!accDepID.equals(aDepID)){
			istheSameFlag = false;
			break;
		}	
	}

	return istheSameFlag;
}
//取得 ffsharedep 部門代號 Vector
function getAccDepartmentList(runSide){
	
	var DepSet = runSide.SQLloadValue(&quot;select DEPID from ffsharedep&quot;);
	return DepSet;
}
//取得 ffsharedep 部門物件 Vector
function getAccDepartmentObjList(runSide){
	
	var accDepIDSet = runSide.SQLloadValue(&quot;select DEPID from ffsharedep&quot;);
	var accDepList = new java.util.Vector();
	for(var i = 0; i &lt; accDepIDSet.size(); i++){
		var aAccDepID = accDepIDSet.get(i).get(&quot;DEPID&quot;);
		var aAccDepTemp = getDepartmentByMyID_new(Client,aAccDepID);
		if (aAccDepTemp !=null &amp;&amp; aAccDepTemp.size() &gt;0) {		 
			//假設部門代號不重複
			java.lang.System.out.println(&quot;aAccDepTemp&quot; +aAccDepTemp);
			
			accDepList.add(aAccDepTemp.get(0));
		}
	}	
	
	return accDepList;
}
//載入所有的站所, 傳回一包含所有站所 Department Object 的 Vector
function getStations(stationDep){
	
	var allAgency = new java.util.Vector();
	for(var i = 0; i &lt; stationDep.length; i++){
		var subList = stationDep[i].getSubDepartmentList();
		for(var j = 0; j &lt; subList.size(); j++){
			var subDepID = subList.get(j);
			var subDep = Client.getDepartment(subDepID);
			if(subDep.getName().endsWith(&quot;所&quot;)){
				allAgency.add(subDep);
			}
		}
	}
	
	return allAgency;
}
//20060524:tz_yue:新增四區以外的部門
function addStations(runSide,stationDep,addStationDep){
	for(var i = 0; i &lt; addStationDep.length; i++){
		var querySQL = &quot;Select DEPID from DEP_GENINF Where ID = &apos;&quot;+addStationDep[i]+&quot;&apos; &quot;;
		var depSet = runSide.SQLloadValue(querySQL);
		for(var j = 0; j &lt; depSet.size(); j++){
			var aRow = depSet.get(j);
			var depID = aRow.get(&quot;DEPID&quot;);
			stationDep.add(runSide.getDepartment(depID));
		}
	}
	return stationDep;
}
//20060524:tz_yue:部門排序
//載入所有的站所, 傳回一包含所有站所 Department Object 的 Vector
function quickSortByMyDepID(stationDep,left,right){
    var lo=left;
	var hi=right;
	var Temp;
    var pv=stationDep.get((left+right)/2).getMyID();
	
	if (lo &gt;= hi) {
		return stationDep;
    }
    //  partition
    do
    {    
        while (stationDep.get(lo).getMyID() &lt; pv) lo++; 
        while (stationDep.get(hi).getMyID() &gt; pv) hi--;
        if (lo &lt;= hi)
        {
            Temp=stationDep.get(lo);
			stationDep.set(lo,stationDep.get(hi)); 
			stationDep.set(hi,Temp);
            lo++;
			hi--;
        }
    } while (lo &lt;= hi);

    //  recursion
    if (left &lt; hi) quickSortByMyDepID(stationDep, left, hi);
    if (lo &lt; right) quickSortByMyDepID(stationDep, lo, right);
	return stationDep;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>部門的相關功能</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00231160885095703</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/09/02 11:25:00</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Server.SendMail</string> 
     </void> 
     <void property="id"> 
      <string>SCL00231160885095703</string> 
     </void> 
     <void property="name"> 
      <string>SendMail</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021156610951562</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
/**
 撤單(拉回前一關)時發出的 mail
 發給被撤的那一關(task.realexecutor)
 用於 Client
*/
function sendGoBackMail(MyTask){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Client.getMember(&quot;administrator&quot;).getEmail();  		
        //var to = getProcessMailAddressList(groupname); 
		//var to = Client.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail();
		var realexecutor_mail = Client.getMember(MyTask.getRealExecutor()).getEmail();
		var to = realexecutor_mail;
//        var cc = &quot;wangwei@gce.com.tw&quot;; //cc觀察用 
//        var subject = &quot;[撤簽通知]&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」已被撤回-[&quot;+ MyTask.getKeyWord() +&quot;]&quot;; // Mail Subject 
        var subject = &quot;[撤簽通知]&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot;所申請-&quot; + roottaskname + &quot;已被撤回&quot;; // Mail Subject 
		var text = getGoBackMailContent(dataMap,MyTask);
        //var fileName = &quot;.\\temp\\&quot; + dataMap.get(filekey).trim() +&quot;.jpg&quot;; // Mail Content 
        var fileList = new Packages.java.util.Vector(); 
          //fileList = new java.lang.Vector(); 
        //fileList.add(fileName); 
		Client.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
//-------------------
// 撤單通知內容
//-------------------
function getGoBackMailContent(dataMap,MyTask){
		//var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   [撤回通知]&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Client.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Client.getMember(Client.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Client.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Client.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		//text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;

		return text;
}

/**
 會簽時發出的 mail
*/
function sendCSMail(){
	var InsID = MyTask.getArtInstance();
	var dataMap = InsID.getAppDataMap();
	var cMember = Server.getMember(MyTask.getMemberID());
	var fromMail= Server.getMember(&quot;Administrator&quot;).getEmail();//系統管理員為寄件者
	var toEMail = cMember.getEmail();
	var totalccMail = &quot;&quot;;
	var title = &quot;請會簽&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單&quot;;
	var urlData = &quot;&lt;a href=\&quot;$webAgendaURL$mailOpenFormCheckpass\&quot;&gt;會簽單&lt;/a&gt;&quot;;
	var data = &quot; 您好：&quot;+&quot;\n&quot;+&quot;\n&quot;;
	data = data + &quot;這是系統自動發出的一封通知信，請至 EIP 上進行會簽簽核，\n&quot;;
	data = data +&quot;表單內容為：&quot; + dataMap.get(&quot;App_Dep&quot;) + dataMap.get(&quot;App_ID&quot;) + dataMap.get(&quot;App_Name&quot;) +&quot; 所發出的會簽單 \n&quot;;
	data = data +&quot;會簽簽核時請點選「加會意見」及請務必填寫「同意」或「不同意」\n&quot;;
   data = data + &quot; 您可以開啟 &quot;+urlData+&quot;，來查看該表單。&quot;+&quot;\n  \n \n   MIS &quot;;
   data = &quot;&lt;pre&gt;&quot;+data+&quot;&lt;/pre&gt;&quot;;
    var vector = new java.util.Vector();
     //taskID
    var taskID = MyTask.getID();  
    Server.sendHTMLMailExt(fromMail,toEMail,totalccMail,title,data,vector,taskID);  
 }

/**
 審核通過時發出的 mail
 通知申請者&amp;填單者
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
 20080502 mail to 名單加入 TableA 上的人員
*/
function sendAcceptMail(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
        //var FrontMember= Server.getMember(MyTask.getFrontUser()); 
        //var from = FrontMember.getEmail(); // Sender e-mail 
		//var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        //var to = getProcessMailAddressList(groupname); //通知簽核過的人員		
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}
		to += &quot;;&quot; +getMailAddressTableA(dataMap);		
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 

        var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		var text = getAcceptMailContent(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}

/**
 審核通過時發出的 mail
 通知申請者&amp;填單者
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
 20080502 mail to 名單加入 TableA 上的人員
 copy from sendAcceptMail , 加上簽核流程中的人
*/
function sendAcceptMailExt(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        var to = getProcessMailAddressList(groupname); //通知簽核過的人員		
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}
		to += &quot;;&quot; +getMailAddressTableA(dataMap);		
		var vFactory = dataMap.get(&quot;Factory&quot;);
//		var cc = &quot;wangwei@gce.com.tw&quot;; //cc觀察用 
        var subject = &quot;[結案通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		var text = getAcceptMailContent(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/**
	TABLEA 內的 ID 會有 DEPID or MEMID
	DEPID 要取所有部門成員的 Email address
*/

function getMailAddressTableA(dataMap){
	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	try{
		var tablea = dataMap.get(&quot;TableA&quot;);
		if( tablea != null &amp;&amp; tablea.size()&gt;0  ){
			for(var t=0;t&lt;tablea.size();t++){
				var id = tablea.get(t).get(&quot;ITEM2&quot;);//DEPID or MEMID
				if(id.startsWith(&quot;DEP&quot;) &amp;&amp; Server.getDepartment(id) != null){
					var depname = Server.getDepartment(id).getName();
					memset = addDepAllMemID(depname,memset);
				}else{
					var id = tablea.get(t).get(&quot;ITEM3&quot;);//DEPID or MEMID			
					if(id.startsWith(&quot;MEM&quot;)&amp;&amp; Server.getMember(id) != null &amp;&amp; !Server.getMember(id).isResign()){
						memset.add(id);
					}
				}				
			}
		}
		
		// memset --&gt; email address
			var key = memset.iterator();
			while(key.hasNext()){
				var memid = key.next();
				if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
					var vMail = Server.getMember(memid).getEmail();
						vMail = vMail.toLowerCase();       
					if( vMail.indexOf(&quot;wtadmin&quot;) &lt; 0 ){  //  add by wangwei@2009/04/20因沒有 mail address 的會給wtadmin so 再過濾此關鍵字
						emailaddress +=  vMail + &quot;;&quot; ;
					}
				}
			}

	}catch(e){
		var emailaddress = Server.getMember(&quot;administrator&quot;).getEmail();  
	}
	return emailaddress;
}
/**
	20080503
	將 DEP 內的所有人員加入 memset 內(含子部門)
*/
function addDepAllMemID(depname,memset){
	var DepartmentList = Server.getAllDepartmentByName(depname);
	//var memberNameList  = new java.util.Vector();
	for(var i=0;i&lt;DepartmentList.size();i++){
			var depObj =DepartmentList.get(i);
			var depID = depObj.getID();
			var memList = Server.getSubMemberIDOfDR(depID,true);
			for(var j = 0; j&lt; memList.size();j++){
				var memid = memList.get(j);				
				if(memid != null &amp;&amp; memid != &quot;&quot;){
					var mem = Server.getMember(memid);
//					var vEmail=mem.getEmail();
					if(mem != null &amp;&amp; !mem.isResign()){
						memset.add(memid);
					}
				}
			}
	}
	return memset;
}

 //-------------------
// 駁回通知內容
//-------------------
function getAcceptMailContent(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核通過通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

/**
 駁回時發出的 mail
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
*/
function sendRejectMail(groupname){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
        var to = getProcessMailAddressList(groupname); 
        var cc = &quot;&quot;; //cc觀察用 
        var subject = &quot;[駁回通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」已退回申請人&quot;; // Mail Subject 
		var text = getMailContent(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}

/**	
 add by wangwei@2009/04/24	
 表單不同意退回,不是退回到申請者時發出的 mail
 沒有要多傳給特定人 groupname 傳 &quot;&quot;
 若要自行定義主旨, 請傳入subject
 此mail只會 mali to 填單者,and 特定群組中的人
*/
function sendRejectMailExt(groupname,subject){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(MyTask.getRealExecutor()).getEmail();  
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();		
        var to = creator_mail +&quot;;&quot;;//getProcessMailAddressList(groupname); 	
		var emailaddress = &quot;&quot;;
		var memset = java.util.TreeSet();
		if(groupname != &quot;&quot;){
			var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
			var vec = Server.SQLloadValue(sql); 
			if(vec != null &amp;&amp; vec.size() &gt; 0){
				for(var i=0;i&lt;vec.size();i++){
					if(Server.getMember(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;memid&quot;)).isResign()){
						memset.add(vec.get(i).get(&quot;memid&quot;));
					}
				}
				memset.remove(&quot;Administrator&quot;);
			}
		}
		var key = memset.iterator();
		while(key.hasNext()){
			var memid = key.next();
			if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
				emailaddress += Server.getMember(memid).getEmail() + &quot;;&quot; ;
			}
		}
		to+=emailaddress;
        var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot;==subject){
			var subject = &quot;[通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;」-主管不同意&quot;; // Mail Subject 
		}
		var text = getMailContentExt(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
//-------------------
// 駁回通知內容
//-------------------
function getMailContentExt(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核駁回通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   關卡名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;		
		text += &quot;      表單 : &quot; + dataMap.get(&quot;Select_Process&quot;);+&quot;&lt;br&gt;&quot;;			
		text += &quot;   退回原因 : &quot; + dataMap.get(&quot;Verify_Note&quot;);	+&quot;&lt;br&gt;&quot;;		
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		return text;
}


//-------------------
// 駁回通知內容
//-------------------
function getMailContent(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程審核駁回通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		return text;
}


/**
	取得Root Task 流程所經過的人+ 特定 table 抓出來的 email address 字串
*/
function getProcessMailAddressList(groupname){

	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	//流程上的成員
		var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;exeid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;exeid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;); //排除 Administrator
	}
	//Table 上的成員
	if(groupname != &quot;&quot;){
		var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
		var vec = Server.SQLloadValue(sql); 
		if(vec != null &amp;&amp; vec.size() &gt; 0){
			for(var i=0;i&lt;vec.size();i++){
				if(Server.getMember(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;memid&quot;)).isResign()){
						memset.add(vec.get(i).get(&quot;memid&quot;));
				}
			}
				memset.remove(&quot;Administrator&quot;);
		}
	}

	var key = memset.iterator();
	while(key.hasNext()){
		var memid = key.next();
		if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
			emailaddress += Server.getMember(memid).getEmail() + &quot;;&quot; ;
		}
	}
	return emailaddress;	
}

 
 

//---------------------------------------------------------
//取得Root Task 流程所經過的人+ 特定 table 抓出來的 memid set
//扣掉上一關的人
function getProcessMemberList(groupname){
	var emailaddress = &quot;&quot;;
	var fronttaskid = MyTask.getFrontID();
	var frontmemid = Server.getTask(fronttaskid).getRealExecutor();
	var memset = java.util.TreeSet();
	//流程上的成員
	var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid and exeid !=&apos;&quot;+ frontmemid + &quot;&apos; &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			//去除已離職的人
			if(Server.getMember(vec.get(i).get(&quot;exeid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;exeid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;);
	}
	//Table 上的成員
	var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Server.getMember(vec.get(i).get(&quot;memid&quot;)).isResign()){
					memset.add(vec.get(i).get(&quot;memid&quot;));
			}
		}
		memset.remove(&quot;Administrator&quot;);
	}
	return memset;	
}
//---------------------------------------------------------- 


//------------------------
// 發 mail 開啟連結用的 URL 
// n == 1 //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件 ( ie7 無法直接開 ) 
// n == 2 //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
// n == 3 //email開表單，需密碼
// n == 4 //email開表單，不需密碼
//------------------------
function getUrl(n){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           var aInstance = MyTask.getArtInstance(); 
           var dataMap = aInstance.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                     //var userName = member.getName();
                     var userName = member.getLoginID();
                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }
           return url;
}

/**
 主管按不同意或駁回時發出 mail
 發給填單者及特定群群組內的人
 用於 Client
 vSubject : mail的主旨
 vGroup : 要mail給特定的群組人員
*/
function sendRejectMailClient(Task,vSubject,groupname){
	try{
		var arturl = &quot;&quot;//getUrl(2) ;		
		var aInstance = Task.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = Task.getRootName();
		var from = Client.getMember(Task.getRealExecutor()).getEmail();// Client.getMember(&quot;administrator&quot;).getEmail();  		
		var creator_mail = Client.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		var to = creator_mail;
//        var cc = &quot;wangwei@gce.com.tw&quot;; //cc觀察用 
		if(&quot;&quot;==vSubject){
			vSubject = &quot;(通知)&quot;+dataMap.get(&quot;Factory&quot;)+dataMap.get(&quot;App_Name&quot;) + &quot;所申請-&quot; + roottaskname + &quot;--簽核者不同意&quot;; // Mail Subject 
		}
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程名稱: &quot; + Client.getTask(Task.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot; 不同意原因: &quot; + dataMap.get(&quot;Verify_Note&quot;);	+&quot;&lt;br&gt;&quot;;			
		text += &quot;   退回關卡: &quot; + dataMap.get(&quot;Select_Process&quot;);+&quot;&lt;br&gt;&quot;;				
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊處連絡 &lt;br&gt;&quot;;
//-----------------------
		var emailaddress = &quot;&quot;;
		var memset = java.util.TreeSet();
		//Group成員
		if(groupname != &quot;&quot;){
			var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
			var vec = Client.SQLloadValue(sql); 
			if(vec != null &amp;&amp; vec.size() &gt; 0){
				for(var i=0;i&lt;vec.size();i++){
					if(Client.getMember(vec.get(i).get(&quot;memid&quot;)) != null &amp;&amp; !Client.getMember(vec.get(i).get(&quot;memid&quot;)).isResign()){
						memset.add(vec.get(i).get(&quot;memid&quot;));
					}
				}
				memset.remove(&quot;Administrator&quot;);
			}
		}
		var key = memset.iterator();
		while(key.hasNext()){
			var memid = key.next();
			if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Client.getMember(memid) != null){
				emailaddress += Client.getMember(memid).getEmail() + &quot;;&quot; ;
			}
		}
		cc = cc +&quot;;&quot;+emailaddress ;
//--------------------		
        var fileList = new Packages.java.util.Vector(); 
			Client.sendHTMLMailExt(from,to,cc,vSubject,text,fileList,Task); 
	}catch(e){
		java.lang.System.out.println(e.message);
		Client.addErrLog(e.message);//檢視失敗訊息	
	}
}

/**
 認證版號簽收單
 審查完成時發出的 mail
 用於 Server
*/
function send_Mail_Tablelist(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot; != msg ){
			var subject = &quot;[認證板完成通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[認證板完成通知]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已審核通過&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_PLM(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/******************************
 認證板簽收單v2
 mail通知生管人員
 用於 Server
*******************************/
function send_Mail_AB_PC(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot; != msg ){
			var subject = &quot;[認證板簽收單v2-通知生管人員及QC]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[認證板簽收單v2-通知生管人員及QC]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_AB_MRB2(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/******************************
 認證板簽收單v2
 排程比對QAE上傳檔案使用
 用於 Server
*******************************/
function send_Mail_AB_QaeUpload(MyTask,tablelist,Source_Ins,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var source_dataMap = Source_Ins.getAppDataMap();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();
		var cc = Server.getMember(&quot;MEMT1013166&quot;).getEmail(); //邱玉婷
        if(&quot;&quot; != msg){
			cc = Server.getMember(&quot;MEMT1000502&quot;).getEmail();//吳明源
        }			
		var to = &quot;&quot;; 
				
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += getMailAddressTable(dataMap,fields[i])+&quot;;&quot;;
				}
			}
		}		
		 
		if(&quot;&quot; != msg ){
			var subject = &quot;[認證板簽收單-檔案上傳逾期通知]&quot;+source_dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+source_dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[認證板簽收單-檔案上傳逾期通知]&quot;+source_dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+source_dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_AB_Upload(Source_Ins);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/******************************
 認證板簽收單v2
 排程比對新設工上傳檔案使用
 用於 Server
*******************************/
function send_Mail_AB_HdiUpload(MyTask,tablelist,Source_Ins,msg,temp){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var source_dataMap = Source_Ins.getAppDataMap();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();
		
		var to =&quot;&quot;;		
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += getMailAddressTable(dataMap,fields[i])+&quot;;&quot;;
				}
			}
		}		
		var cc= &quot;&quot;; 
		if(&quot;&quot; != msg ){
			var subject = &quot;[認證板簽收單-結案報告上傳逾期通知]&quot;+source_dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+source_dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[認證板簽收單-結案報告上傳逾期通知]&quot;+source_dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+source_dataMap.get(&quot;Subject&quot;)+&quot;」流程審核中&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_AB_HdiUpload(Source_Ins,temp);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}
/******************************
 認證板簽收單v2
 送lab測試時,mail通知mrb2長官
 用於 Server
*******************************/
function send_Mail_AB_MRB2(MyTask,tablelist,msg){
	try{
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var roottaskname = MyTask.getRootName();
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  				
		var to = Server.getMember(dataMap.get(&quot;App_MemID&quot;)).getEmail(); 
		var creator_mail = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		if( to != creator_mail ){
			to += &quot;;&quot; + creator_mail;
		}			
		if(&quot;&quot; != tablelist ){
		var fields = tablelist.split(&quot;,&quot;);
			for (var i=0; i&lt;fields.length; i++) {
				if( fields[i] != null){
				to += &quot;;&quot; +getMailAddressTable(dataMap,fields[i]);
				}
			}
		}					
		var vFactory = dataMap.get(&quot;Factory&quot;);
		var cc = &quot;&quot;; //cc觀察用 
		if(&quot;&quot; != msg ){
			var subject = &quot;[認證板申請通知-需送lab測試]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已申請送出&quot;; // Mail Subject 
		}else{
		    var subject = &quot;[認證板申請通知-需送lab測試]&quot;+dataMap.get(&quot;App_Name&quot;) + &quot;所申請「&quot; + roottaskname + &quot;:&quot;+dataMap.get(&quot;Subject&quot;)+&quot;」已申請送出&quot;; // Mail Subject 
		}	
		var text = getAcceptMailContent_AB_MRB2(dataMap);
        var fileList = new Packages.java.util.Vector(); 
		Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
	}catch(e){}
}

/***************************
 認證版號簽收單v2
 送lab測試時,mail通知mrb2長官
 用於 Server
***************************/
function getAcceptMailContent_AB_MRB2(dataMap){
		var arturl = getUrl(2) ;
		var text = &quot;   Dear Sir: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   表單送出通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		var lab =&quot;&quot;;
		if(dataMap.get(&quot;lab_y&quot;).equals(&quot;true&quot;)){
			lab=&quot;是&quot;;
		}else{
			lab=&quot;否&quot;;
		}
		text += &quot;   需送Lab測試 : &quot;+lab +&quot;&lt;br&gt;&quot;;
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + roottask.getRootUser()	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
			var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容,但不能審核,若有執行上的問題與相關負責人聯絡。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何系統疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

/***************************
 認證版號簽收單v2
 排程檢查檔案上傳用
 用於 Server
***************************/
function getAcceptMailContent_AB_Upload(Source_Ins){
	    var dataMap = Source_Ins.getAppDataMap();
		var arturl = getUrl_AB(2,Source_Ins) ;
		var text = &quot;   Dear Sir: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   檔案上傳逾期通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : 認證板簽收單檔案上傳檢查&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : 檔案未上傳檢查&lt;br&gt;&quot;;
		var lab =&quot;&quot;;
		if(dataMap.get(&quot;lab_y&quot;).equals(&quot;true&quot;)){
			lab=&quot;是&quot;;
		}else{
			lab=&quot;否&quot;;
		}
		text += &quot;   需送Lab測試 : &quot;+lab +&quot;&lt;br&gt;&quot;;
		text += &quot;   待辦收到日期 : &quot; + dataMap.get(&quot;receiveDate&quot;)  	+&quot;&lt;br&gt;&quot;;
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + dataMap.get(&quot;App_Name&quot;) 	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + dataMap.get(&quot;App_Dep&quot;)  		+&quot;&lt;br&gt;&quot;;
			//var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容,但不能審核,若有執行上的問題與相關負責人聯絡。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何系統疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}
function getAcceptMailContent_AB_HdiUpload(Source_Ins,temp){
	    var dataMap = Source_Ins.getAppDataMap();
		var arturl = getUrl_AB(2,Source_Ins) ;
		var text = &quot;   Dear Sir: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   結案報告上傳逾期通知!&lt;br&gt;&quot;;
		text += &quot;   流程名稱 : 認證板簽收單檔案上傳檢查&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : 檔案未上傳檢查&lt;br&gt;&quot;;
		var lab =&quot;&quot;;
		if(dataMap.get(&quot;lab_y&quot;).equals(&quot;true&quot;)){
			lab=&quot;是&quot;;
		}else{
			lab=&quot;否&quot;;
		}
		text += &quot;   需送Lab測試 : &quot;+lab +&quot;&lt;br&gt;&quot;;
		text += &quot;   待辦收到日期 : &quot; + dataMap.get(&quot;receiveDateHdi&quot;)  	+&quot;&lt;br&gt;&quot;;
		text += &quot;   認證類別 : &quot; + temp  	+&quot;&lt;br&gt;&quot;;
//		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  	+&quot;&lt;br&gt;&quot;;		
		try{
			var creator = Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
			var roottask = Server.getTask(MyTask.getRootID());
			var roleID = MyTask.getRoleID();
			var mainroleid = creator.getMainRoleID();
			var depname = &quot;&quot;;
			if(mainroleid != &quot;&quot;){
				 var memDR = creator.getMemberDR(mainroleid);
			//		var memDR = creator.getMemberDR(roleID);
				 if(memDR != null){
					depname = memDR.getDepartmentName();	//部門名稱
				 }
			}
			text += &quot;   流程的啟動者 : &quot; + dataMap.get(&quot;App_Name&quot;) 	+&quot;&lt;br&gt;&quot;;				
			text += &quot;   流程的啟動部門 : &quot; + dataMap.get(&quot;App_Dep&quot;)  		+&quot;&lt;br&gt;&quot;;
			//var frontuser = Server.getMember(MyTask.getFrontUser());
			//text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容,但不能審核,若有執行上的問題與相關負責人聯絡。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;	
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何系統疑問，請與資訊處連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}
function getUrl_AB(n,Source_Ins){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           //var aInstance = MyTask.getArtInstance(); 
           var dataMap = Source_Ins.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ Source_Ins.getID() +&quot;&amp;readOnly=true&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                    // var userName = member.getName();
                     var userName = member.getLoginID();
					 //var userName = &quot;meiyu_lin&quot;;
                     //var temp = &quot;taskID=&quot; + &quot;Tsk000000053042&quot; + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var temp = &quot;taskID=&quot; + dataMap.get(&quot;TaskID_Wait&quot;) + &quot;&amp;userName=&quot; + dataMap.get(&quot;exeid&quot;) + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
 
					 var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&quot;;
           }
           return url;
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>流程中統一使用發送的 mail</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00231208421992871</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2013/01/28 09:35:49</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Parameter_Item_Maintain</string> 
     </void> 
     <void property="id"> 
      <string>SCL00231208421992871</string> 
     </void> 
     <void property="name"> 
      <string>Parameter_Item_Maintain</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011152000677625</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
function reloadParameter_Item_Maintain(){
	//function 功能:抓取 table A_Process_Type 的 資料到表單上的 TableA 元件
		reloadTable(&quot;TableA&quot;);		
}

//===================================================================================
function reloadTable(tableA){
			if(tableA != null){
				var sql = &quot; select * from A_Parameter_Item  order by Parameter &quot; + getOrder() ;
				var vecData = Client.SQLloadValue(sql);
				var table = Form.getComponent(tableA);					
				table.clear();
				
				if(vecData.size()&gt;0){
					Form.setValue(&quot;Modify_Date&quot;,(vecData.get(0).get(&quot;Modify_date&quot;)));//.toString().substring(0,16));
					Form.setValue(&quot;Modify_ID&quot;,vecData.get(0).get(&quot;modify_id&quot;));	
					for(var j= 0; j &lt; vecData.size(); j++){
						var row = table.newRow()-1 ;
						table.setValueAt(vecData.get(j).get(&quot;ID&quot;),row,&quot;ID&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Parameter&quot;),row,&quot;Parameter&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Description&quot;),row,&quot;Description&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Remarks&quot;),row,&quot;Remarks&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;Active&quot;),row,&quot;Active&quot;); //
					}//for
				}
			}
}//function

//清維護畫面
function clearParameter_Item(){
	Form.setValue(&quot;Parameter&quot;,&quot;&quot;);
	Form.setValue(&quot;Remarks&quot;,&quot;&quot;);	
	Form.setValue(&quot;Description&quot;,&quot;&quot;);
	Form.setValue(&quot;Active&quot;,&quot;true&quot;);	
}

function clearParameter_Data(){	
	Form.setValue(&quot;Remarks&quot;,&quot;&quot;);	
	Form.setValue(&quot;Description&quot;,&quot;&quot;);
	Form.setValue(&quot;Key1&quot;,&quot;&quot;);
	Form.setValue(&quot;Value1&quot;,&quot;&quot;);	
	Form.setValue(&quot;Value2&quot;,&quot;&quot;);	
	Form.setValue(&quot;Value3&quot;,&quot;&quot;);		
}

function clearParameter_ACL(){
	Form.setValue(&quot;MemID&quot;,&quot;&quot;);
	Form.setValue(&quot;MemName&quot;,&quot;&quot;);	
}

//ACL
function reloadTableB(parameter,tableB){
			if(parameter != null &amp;&amp; tableB != null){
				var sql = &quot; select * from A_Parameter_ACL where Parameter =&apos;&quot;+ parameter +&quot;&apos; order by MemName  &quot;   ;
				var vecData = Client.SQLloadValue(sql);
				var table = Form.getComponent(tableB);
				table.clear();
				if(vecData.size()&gt;0){
					Form.setValue(&quot;Modify_Date&quot;,(vecData.get(0).get(&quot;Modify_date&quot;)));//.toString().substring(0,16));
					Form.setValue(&quot;Modify_ID&quot;,vecData.get(0).get(&quot;modify_id&quot;));	
					for(var j= 0; j &lt; vecData.size(); j++){
						var row = table.newRow()-1 ;
						table.setValueAt(vecData.get(j).get(&quot;ID&quot;),row,&quot;ID&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;MemID&quot;),row,&quot;MemID&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;MemName&quot;),row,&quot;MemName&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;ACL_Read&quot;),row,&quot;Read&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;ACL_New&quot;),row,&quot;New&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;ACL_Update&quot;),row,&quot;Update&quot;); //
						table.setValueAt(vecData.get(j).get(&quot;ACL_Del&quot;),row,&quot;Del&quot;); //
					}//for
				}
			}
}


function reloadParameter_Data(tableA){
	if(tableA != null){
					var sql = &quot; select * from A_PARAMETER_DATA  where Parameter =&apos;&quot; +Form.getValue(&quot;Parameter&quot;) + &quot;&apos;&quot;+getOrder();   //&quot;&apos;  order by Key1,ID,value3 &quot;   ;
					var vecData = Client.SQLloadValue(sql);
					var table = Form.getComponent(tableA);					
					table.clear();
					Client.addDebugLog(&quot;reloadParameter_Data:&quot;+sql);
					if(vecData.size()&gt;0){
						Form.setValue(&quot;Modify_Date&quot;,(vecData.get(0).get(&quot;Modify_date&quot;)));//.toString().substring(0,16));
						Form.setValue(&quot;Modify_ID&quot;,vecData.get(0).get(&quot;modify_id&quot;));	
						var vLeave=&quot;&quot;;
						for(var j= 0; j &lt; vecData.size(); j++){
							var row = table.newRow()-1 ;
							table.setValueAt(vecData.get(j).get(&quot;ID&quot;),row,&quot;ID&quot;); //
							table.setValueAt(vecData.get(j).get(&quot;Parameter&quot;),row,&quot;Parameter&quot;); //
							table.setValueAt(vecData.get(j).get(&quot;Description&quot;),row,&quot;Description&quot;); //
							table.setValueAt(vecData.get(j).get(&quot;Remarks&quot;),row,&quot;Remarks&quot;); //
							table.setValueAt(vecData.get(j).get(&quot;Key1&quot;),row,&quot;Key1&quot;); //
							table.setValueAt(vecData.get(j).get(&quot;Value1&quot;),row,&quot;Value1&quot;); //
							var vMEMID = vecData.get(j).get(&quot;Value2&quot;);
							table.setValueAt(vMEMID,row,&quot;Value2&quot;); //
							table.setValueAt(vecData.get(j).get(&quot;Value3&quot;),row,&quot;Value3&quot;); //							
							if(vMEMID.indexOf(&quot;MEM&quot;)&gt;=0){
								vMEM = Client.getMemberByID(vMEMID);
								if(vMEM.isResign()&amp;&amp;vecData.get(j).get(&quot;Key1&quot;)!=&quot;xGCE&quot;){
									vLeave+=vMEMID+vMEM.getName()+&quot;\n&quot;
									//Form.showMessageDialog(vMEMID+vMEM.getName()+&quot;已離職!!&quot;);									
								}
							}
						}//for
						if(vLeave!=&quot;&quot;){
							Form.showMessageDialog(&quot;已離職人員清單:\n&quot;+vLeave);	
						}
					}
				}


}
// add by wangwei@2012/06/08 排序
	function getOrder(){
		var orderBy = &quot;&quot;;
		var spilt = &quot;&quot;;
		var key1 = Form.getValue(&quot;key1&quot;);
		var value2 = Form.getValue(&quot;value2&quot;);
		var value3 = Form.getValue(&quot;value3&quot;);
		var description = Form.getValue(&quot;description&quot;);
		var remarks = Form.getValue(&quot;remarks&quot;);
		if (&quot;true&quot;.equals(key1)){
			if(orderBy != &quot;&quot;){spilt=&quot;,&quot;;}
			orderBy　=　orderBy + spilt +&quot;key1&quot; ;
		}
		if (&quot;true&quot;.equals(value2)){
			if(orderBy != &quot;&quot;){spilt=&quot;,&quot;;}
			orderBy　=　orderBy +spilt+ &quot;value2&quot;;
		}
		if (&quot;true&quot;.equals(value3)){
			if(orderBy != &quot;&quot;){spilt=&quot;,&quot;;}
			orderBy　=　orderBy +spilt+ &quot;value3&quot;;
		}
		if (&quot;true&quot;.equals(description)){
			if(orderBy != &quot;&quot;){spilt=&quot;,&quot;;}
			orderBy　=　orderBy +spilt+ &quot;description&quot;;
		}		
		if (&quot;true&quot;.equals(remarks)){
			if(orderBy != &quot;&quot;){spilt=&quot;,&quot;;}
			orderBy　=　orderBy +spilt+ &quot;remarks&quot;;
		}				
		if(orderBy!=&quot;&quot;){
			orderBy = &quot; order by &quot; + orderBy
		}
		return orderBy;
	}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>流程表單參數維護</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00231250755035133</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/12/03 01:29:31</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Common.Util.Date</string> 
     </void> 
     <void property="id"> 
      <string>SCL00231250755035133</string> 
     </void> 
     <void property="name"> 
      <string>Date</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00111250755035089</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
/**
	test case.
*/
function testCase() {
	var cal = new java.util.GregorianCalendar();
	cal.set(2007, 6, 5, 0, 0, 0);
	var start = cal.getTime();
	cal.set(2007, 6, 6, 0, 0, 0);
	var end = cal.getTimeInMillis();
	var duration = getProcessTimeByRange(start, end);
	var timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;01:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 8, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 9, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;00:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 5, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 7, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;02:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 5, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 11, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;04:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 5, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 14, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;07:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 5, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 17, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;08:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 7, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 8, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;00:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 7, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 11, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;02:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 7, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 14, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;05:00:00:00 = &quot; + timeStr);
	
	cal.set(2007, 6, 7, 0, 0, 0);
	start = cal.getTime();
	cal.set(2007, 6, 17, 0, 0, 0);
	end = cal.getTimeInMillis();
	duration = getProcessTimeByRange(start, end);
	timeStr = countDuration(duration);
	java.lang.System.out.println(&quot;06:00:00:00 = &quot; + timeStr);
}
//傳入時間差(毫秒)，轉成幾天幾小時幾分
function countDuration(dif){
  var timeString = &quot;00:00:00:00&quot;;
  if((dif-0) &gt; 0){
	var day = (dif/(1000*60*60*24)).toString();
	var dayInt = getInt(day);
	var hourse = getInt(dif/1000/60/60 - 24*dayInt);
	var minutes = getInt(dif/1000/60 - dayInt*24*60 - hourse*60);
	var seconds = getInt(dif/1000 - dayInt*24*60*60 - hourse*60*60 - minutes*60);
	//timeString = dayInt+&quot;天&quot;+hourse+&quot;小時&quot;+minutes+&quot;分&quot;;
	if(minutes &lt; 10){
		minutes = &quot;0&quot; + minutes;
	}
	if(dayInt &lt; 10){
		dayInt = &quot;0&quot; + dayInt;
	}
	if(hourse &lt; 10){
		hourse = &quot;0&quot; + hourse;
	}
	if(seconds &lt; 10){
		seconds = &quot;0&quot; + seconds;
	}
	//timeString = (dayInt*24 + hourse) + &quot;:&quot; + minutes + &quot;:&quot; + seconds;
	timeString = dayInt + &quot;:&quot; + hourse + &quot;:&quot; + minutes + &quot;:&quot; + seconds;
  }
  return timeString;
}
/**
	計算經過時間，扣除Agentflow內所設定的假日
	@param (long, String, Date) 傳入參數必須是long時間或Date物件或是taskID
	@return long
*/
function getProcessTime(start) {
	var DATE_FORMAT = &quot;yyyy/MM/dd&quot;;
	/**
		將傳入參數轉為毫秒
	*/
	var taskStartTime = null;
	if ((typeof(start)).equals(&quot;number&quot;)) { //傳入毫秒
		taskStartTime = start;
	} else if ((typeof(start)).equals(&quot;string&quot;)) { //傳入taskID
		taskStartTime = Server.getTask(start).getStartTime();
	} else if ((typeof(start)).equals(&quot;object&quot;)) { //傳入Date物件
		taskStartTime = start.getTime();
	}
	/**
		計算啟動時間至現在時間扣掉假日的總天數
	*/
	var myDateObj = new Packages.pase.agenda.MyDate();
	var startDate = new java.util.Date(taskStartTime);
	var currDate = new java.util.Date();
	var currTime = Server.getServerTime();
	var dateFormat = new Packages.java.text.SimpleDateFormat(DATE_FORMAT);
	var startTime = dateFormat.format(startDate); //啟動時間
	currTime = dateFormat.format(currDate); //現在時間
	var durationDays = myDateObj.getSubtractDay(startTime, currTime); //啟動時間至現在時間的天數，從當天開始算起，不包含最後一天
	var holidaySum = 0; 
	for (var j = 0; j &lt;= durationDays; j++) {
		var addDate = myDateObj.add(startTime, j);
		if (Server.isHoliday(addDate)) {
			holidaySum = holidaySum + 1;
		}
	}
	var totalPassTime = ((durationDays + 1) - holidaySum) * 24 * 60 * 60 * 1000;
	/**
		檢查開始時間是否為假日
	*/
	if (!Server.isHoliday(myDateObj.add(startTime, 0))) {
		var cal = new java.util.GregorianCalendar();
		cal.setTime(startDate);
		var thisYear = cal.get(java.util.Calendar.YEAR);
		var thisMonth = cal.get(java.util.Calendar.MONTH);
		var thisDay = cal.get(java.util.Calendar.DATE);
		var cal2 = new java.util.GregorianCalendar(thisYear, thisMonth, thisDay);
		var dif = cal.getTimeInMillis() - cal2.getTimeInMillis();
		dif = java.lang.Math.abs(dif);
		totalPassTime -= dif;
	}
	/**
		檢查送出時間是否為假日
	*/
	if (!Server.isHoliday(myDateObj.add(startTime, durationDays))) {
		var cal = new java.util.GregorianCalendar();
		cal.setTime(currDate);
		var thisYear = cal.get(java.util.Calendar.YEAR);
		var thisMonth = cal.get(java.util.Calendar.MONTH);
		var thisDay = cal.get(java.util.Calendar.DATE);
		var cal2 = new java.util.GregorianCalendar(thisYear, thisMonth, thisDay);
		var dif = cal.getTimeInMillis() - cal2.getTimeInMillis();
		dif = (1000 * 3600 * 24) - dif;
		dif = java.lang.Math.abs(dif);
		totalPassTime -= dif;
	}
	return totalPassTime;
}
/**
	計算經過時間，扣除Agentflow內所設定的假日
	@param (long, String, Date) 傳入參數必須是long時間或Date物件或是taskID
	@param end 結束時間
	@return long
*/
function getProcessTimeByRange(start, end) {
	var DATE_FORMAT = &quot;yyyy/MM/dd&quot;;
	/**
		將傳入參數轉為毫秒
	*/
	var taskStartTime = null;
	if ((typeof(start)).equals(&quot;number&quot;)) { //傳入毫秒
		taskStartTime = start;
	} else if ((typeof(start)).equals(&quot;string&quot;)) { //傳入taskID
		taskStartTime = Server.getTask(start).getStartTime();
	} else if ((typeof(start)).equals(&quot;object&quot;)) { //傳入Date物件
		taskStartTime = start.getTime();
	}
	/**
		計算啟動時間至現在時間扣掉假日的總天數
	*/
	var myDateObj = new Packages.pase.agenda.MyDate();
	var startDate = new java.util.Date(taskStartTime);
	var currDate = new java.util.Date(new java.lang.Long(end).longValue()); //現在時刻
	var dateFormat = new Packages.java.text.SimpleDateFormat(DATE_FORMAT);
	var startTime = dateFormat.format(startDate); //啟動時間
	var currTime = dateFormat.format(currDate); //現在時間
	var durationDays = myDateObj.getSubtractDay(startTime, currTime); //啟動時間至現在時間的天數，從當天開始算起，不包含最後一天
	var holidaySum = 0;
	for (var j = 0; j &lt;= durationDays; j++) {
		var addDate = myDateObj.add(startTime, j);
		if (Server.isHoliday(addDate)) {
			holidaySum += 1;
		}
	}
	var totalPassTime = ((durationDays + 1) - holidaySum) * 24 * 60 * 60 * 1000;
	/**
		檢查開始時間是否為假日
	*/
	if (!Server.isHoliday(myDateObj.add(startTime, 0))) {
		var cal = new java.util.GregorianCalendar();
		cal.setTime(startDate);
		var thisYear = cal.get(java.util.Calendar.YEAR);
		var thisMonth = cal.get(java.util.Calendar.MONTH);
		var thisDay = cal.get(java.util.Calendar.DATE);
		var cal2 = new java.util.GregorianCalendar(thisYear, thisMonth, thisDay);
		var dif = cal.getTimeInMillis() - cal2.getTimeInMillis();
		dif = java.lang.Math.abs(dif);
		totalPassTime -= dif;
	}
	/**
		檢查送出時間是否為假日
	*/
	if (!Server.isHoliday(myDateObj.add(startTime, durationDays))) {
		var cal = new java.util.GregorianCalendar();
		cal.setTime(currDate);
		var thisYear = cal.get(java.util.Calendar.YEAR);
		var thisMonth = cal.get(java.util.Calendar.MONTH);
		var thisDay = cal.get(java.util.Calendar.DATE);
		var cal2 = new java.util.GregorianCalendar(thisYear, thisMonth, thisDay);
		var dif = cal.getTimeInMillis() - cal2.getTimeInMillis();
		dif = (1000 * 3600 * 24) - dif;
		dif = java.lang.Math.abs(dif);
		totalPassTime -= dif;
	}
	return totalPassTime;
}
/**
	因為處理的狀況不完整，所以重新設計演算法
*/
//傳入起始時間(Date or 毫秒)or taskID，扣除假日(六日)，傳出時間差(毫秒)
//此taskID若放rootID則，若流程完成則可算出全流程時間,若尚未完成則算到現在時間
//若是傳入時間必須是 number or Date 型態
//若是傳入taskID必須是string型態
//function getProcessTime(startTime){
//	var cTime = new java.util.Date();//現在時刻
//	var msecCTime = cTime.getTime();
//	var processTime = startTime;
//	var msecProcessTime;
//	if ((typeof(startTime)).equals(&quot;number&quot;)) {//傳入毫秒
//		msecProcessTime = startTime;
//		processTime = new java.util.Date(startTime);
//	}else if ((typeof(startTime)).equals(&quot;string&quot;)) {//傳入taskID
//	//}else if (startTime.toString()).startsWith(&quot;Tsk&quot;)) {//傳入taskID
//		var aTask = Server.getTask(startTime);
//		var taskState = aTask.getTaskState();
//		processTime = new java.util.Date(aTask.getStartTime());
//		msecProcessTime = processTime.getTime();
//		if(taskState.equals(aTask.TASK_STATE_COMPLETE)){
//			cTime = new java.util.Date(aTask.getEndTime());
//			msecCTime = cTime.getTime();
//		}
//	}else if ((typeof(startTime)).equals(&quot;object&quot;)) {//傳入Date物件
//		msecProcessTime = startTime.getTime();
//	}
//	var dif = cTime.getTime() - msecProcessTime;
//	if(cTime.toString().startsWith(&quot;Sat&quot;)){//如果現在時間是星期六，把現在時間設到上星期五的23:59:59
//		var clock = cTime.toString().substring(11,19);
//		var hour = clock.substring(0,2);
//		var minute = clock.substring(3,5);
//		var sec = clock.substring(6,8);
//		msecCTime = msecCTime - (hour*1000*60*60 + minute*1000*60 + sec*1000)-1000;
//		cTime = new java.util.Date(msecCTime);
//	}
//	if(cTime.toString().startsWith(&quot;Sun&quot;)){//如果現在時間是星期日，把現在時間設到上星期五的23:59:59
//		var clock = cTime.toString().substring(11,19);
//		var hour = clock.substring(0,2);
//		var minute = clock.substring(3,5);
//		var sec = clock.substring(6,8);
//		msecCTime = msecCTime - (hour*1000*60*60 + minute*1000*60 + sec*1000) - (1000*60*60*24)-1000;
//		cTime = new java.util.Date(msecCTime);
//	}
//	if(!cTime.toString().startsWith(&quot;Sat&quot;) &amp;&amp; !cTime.toString().startsWith(&quot;Sun&quot;)){
//	    while(msecCTime &gt; msecProcessTime){	
//			if(processTime.toString().startsWith(&quot;Sat&quot;) || processTime.toString().startsWith(&quot;Sun&quot;)){
//				dif = dif - 1000*60*60*24 ;
//				msecProcessTime += 1000*60*60*24;
//				processTime = new java.util.Date(msecProcessTime);
//			}else{
//				msecProcessTime += 1000*60*60*24;
//				processTime = new java.util.Date(msecProcessTime);
//			}
//	    }
//	}
//	return dif;
//}
/**
	因為處理的狀況不完整，所以重新設計演算法
*/
//傳入起始時間(Date or 毫秒)or taskID，扣除假日(六日)，傳出時間差(毫秒)
//此taskID若放rootID則，若流程完成則可算出全流程時間,若尚未完成則算到現在時間
//若是傳入時間必須是 number or Date 型態
//若是傳入taskID必須是string型態
//function getProcessTimeByRange(startTime, endTime){
//	var cTime = new java.util.Date(new java.lang.Long(endTime).longValue());//現在時刻
//	var msecCTime = cTime.getTime();
//	var processTime = startTime;
//	var msecProcessTime;
//	if ((typeof(startTime)).equals(&quot;number&quot;)) {//傳入毫秒
//		msecProcessTime = startTime;
//		processTime = new java.util.Date(startTime);
//	}else if ((typeof(startTime)).equals(&quot;string&quot;)) {//傳入taskID
//	//}else if (startTime.toString()).startsWith(&quot;Tsk&quot;)) {//傳入taskID
//		var aTask = Server.getTask(startTime);
//		var taskState = aTask.getTaskState();
//		processTime = new java.util.Date(aTask.getStartTime())
//		msecProcessTime = processTime.getTime();
//		if(taskState.equals(aTask.TASK_STATE_COMPLETE)){
//			cTime = new java.util.Date(aTask.getEndTime());
//			msecCTime = cTime.getTime();
//		}
//	}else if ((typeof(startTime)).equals(&quot;object&quot;)) {//傳入Date物件
//		msecProcessTime = startTime.getTime();
//	}
//	var dif = cTime.getTime() - msecProcessTime;
//	if(cTime.toString().startsWith(&quot;Sat&quot;)){//如果現在時間是星期六，把現在時間設到上星期五的23:59:59
//		var clock = cTime.toString().substring(11,19);
//		var hour = clock.substring(0,2);
//		var minute = clock.substring(3,5);
//		var sec = clock.substring(6,8);
//		msecCTime = msecCTime - (hour*1000*60*60 + minute*1000*60 + sec*1000)-1000;
//		cTime = new java.util.Date(msecCTime);
//	}
//	if(cTime.toString().startsWith(&quot;Sun&quot;)){//如果現在時間是星期日，把現在時間設到上星期五的23:59:59
//		var clock = cTime.toString().substring(11,19);
//		var hour = clock.substring(0,2);
//		var minute = clock.substring(3,5);
//		var sec = clock.substring(6,8);
//		msecCTime = msecCTime - (hour*1000*60*60 + minute*1000*60 + sec*1000) - (1000*60*60*24)-1000;
//		cTime = new java.util.Date(msecCTime);
//	}
//	if(!cTime.toString().startsWith(&quot;Sat&quot;) &amp;&amp; !cTime.toString().startsWith(&quot;Sun&quot;)){
//	    while(msecCTime &gt; msecProcessTime){	
//		if(processTime.toString().startsWith(&quot;Sat&quot;) || processTime.toString().startsWith(&quot;Sun&quot;)){
//			dif = dif - 1000*60*60*24 ;
//			msecProcessTime += 1000*60*60*24;
//			processTime = new java.util.Date(msecProcessTime);
//		}else{
//			msecProcessTime += 1000*60*60*24;
//			processTime = new java.util.Date(msecProcessTime);
//		}
//	    }
//	}
//	return dif;
//}

//傳入String，捨小數點後位數
function getInt(abc){
	var abcInt = &quot;&quot;;
	var st = new java.util.StringTokenizer(abc, &quot;.&quot;);
    if (st.hasMoreTokens()) {
		abcInt = st.nextToken();
    }
    return abcInt;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>日期的運算</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00241111202929406</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.FormFunction.GenIssueNo</string> 
     </void> 
     <void property="id"> 
      <string>SCL00241111202929406</string> 
     </void> 
     <void property="name"> 
      <string>GenIssueNo</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011105352183360</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//產生單號
function genIssueNo(docCode){
		//填入文件編號
		//var aInstance = task.getArtInstance();
		//var formID = aInstance.getMyID();
		//Form.setValue(&quot;txtDocNo&quot;,formID);
		/*組出文件編號
		  其原則為:
		  1.字串 keyStr
		  2.日期,但年份部份要去掉前二碼
		  3.流水號(以1+2為區分,若不同就重新由 01 開始)		
		*/
		//由外部傳入文件的代碼
		//var keyStr = &quot;S&quot;;
		if(docCode == null)
			docCode = &quot;X&quot;;
		var keyStr = docCode; 
		//取得部門代號
		/*
		var member = Client.getCurrentMember();
		var mainRoleId = member.getMainRoleID();
		var mDR = member.getMemberDR(mainRoleId);
		var department = Client.getDepartment(mDR.getDepartmentID());
		var depID = department.getMyID();
		*/
		var depID = Form.getValue(&quot;txtDepID&quot;);
		keyStr += depID;

		//取得送出表單的日期(去掉年份的前兩碼)
		var date = new Packages.pase.agenda.MyDate();
		var today = date.getCurrentDate();		
		var yearAD = today.substring(0,4);
		var year = &quot;0&quot; + (java.lang.Integer.parseInt(yearAD) - 1911);
		//將年份裁成三位數
		if(java.lang.String.valueOf(year).length() &gt; 3)
			year = year.substring(1);

		dateStr = year + today.substring(5,7) + today.substring(8,10);
		keyStr += dateStr;

   		//組成文件編號
		var reportNo = keyStr + getSerialNo(keyStr,3); //流水號為三碼
		
		Form.setValue(&quot;txtIssueNo&quot;,reportNo);
		// 修改提出日期
		Form.setValue(&quot;txtApplyDate&quot;,date.getCurrentDate());
		return reportNo;
}

//產生收據流水號
function genReceiptNo(docCode){
		//填入文件編號
		//var aInstance = task.getArtInstance();
		//var formID = aInstance.getMyID();
		//Form.setValue(&quot;txtDocNo&quot;,formID);
		/*組出文件編號
		  其原則為:
		  1.字串 keyStr
		  2.日期,但年份部份要去掉前二碼(西元後二碼)
		  3.流水號(以1+2為區分,若不同就重新由 01 開始)		
		*/
		//由外部傳入文件的代碼
		if(docCode == null)
			docCode = &quot;E&quot;;
		var keyStr = docCode; 

		//取得送出表單的日期(去掉年份的前兩碼)
		var date = new Packages.pase.agenda.MyDate();
		var today = date.getCurrentDate();		

		dateStr = today.substring(2,4) + today.substring(5,7) + today.substring(8,10);
		keyStr += dateStr;
		//取得序號
		var reportNo = keyStr + getSerialNo(keyStr,3); //流水號為三碼
		
		return reportNo;
}
//以 KeyStr 取得流水號
//傳入 KeyStr 及流水號位數
function getSerialNo(keyStr, maxDigit){
		var date = new Packages.pase.agenda.MyDate();
		var today = date.getCurrentDate();		

		dateStr = today.substring(2,4) + today.substring(5,7) + today.substring(8,10);
	//取得序號
	var artID = Form.getArtifactID();
	var serialNo = &quot;&quot;;
	//砍掉今日以前(不含)的資料,因為不需再維護了
	Client.SQLdeleteValue(&quot;Delete from TBL_SERIALNUMBER where SerialDate &lt; &apos;&quot;+dateStr+&quot;&apos;&quot;);
	//試著查詢今日的序號
	//var dataSet = Client.SQLloadValue(&quot;Select * from TBL_SERIALNUMBER where ArtID = &apos;&quot;+artID+&quot;&apos; and Seedkey = &apos;&quot;+keyStr+&quot;&apos;&quot;);
	var dataSet = Client.SQLloadValue(&quot;Select * from TBL_SERIALNUMBER where Seedkey = &apos;&quot;+keyStr+&quot;&apos;&quot;);
	
	//若無則 insert,若有則 update 新序號
	if(dataSet.size() == 0){     
		//產生一組 1 的流水號
		for(var i = 0; i &lt; maxDigit - 1; i++){
			serialNo += &quot;0&quot;;
		}
		serialNo += &quot;1&quot;;
		Client.SQLinsertValue(&quot;Insert Into TBL_SERIALNUMBER (ArtID,SeedKey,SerialDate,SerialNo) values (&apos;&quot;+artID+&quot;&apos;,&apos;&quot;+keyStr+&quot;&apos;,&apos;&quot;+dateStr+&quot;&apos;,&apos;&quot;+serialNo+&quot;&apos;)&quot;);
	}else{
		var record = dataSet.get(0);
		var serial = record.get(&quot;SerialNo&quot;);
		var nextSerial = java.lang.Integer.parseInt(serial) + 1;
		var len = new java.lang.Integer(nextSerial).toString().length();
		//計算新序號的位數
		for(var i = 0; i &lt; maxDigit - len; i++){
			serialNo += &quot;0&quot;;
		}
		
		serialNo += nextSerial;
		
		//寫回資料庫				
		Client.SQLupdateValue(&quot;Update TBL_SERIALNUMBER set SerialNo = &apos;&quot;+serialNo+&quot;&apos; where SeedKey = &apos;&quot;+keyStr+&quot;&apos;&quot;);
	}

	return serialNo;
}
//取得AS400的決裁單號
function getAS400SerialNo(keyStr, maxDigit,issueNo,thedate,State,Cause){
	var date = new Packages.pase.agenda.MyDate();
	//取得民國日期
	var SerialNoDate = date.getROCDate(thedate);		
	var dateStr = SerialNoDate.substring(0,2).toString() + SerialNoDate.substring(3,5).toString();
	
	java.lang.System.out.println(&quot;dateStr:&quot; + dateStr);
	
	var as400NoHead = keyStr + &quot;0&quot; + dateStr;
	
	java.lang.System.out.println(&quot;as400NoHead:&quot; + as400NoHead);
	//取得序號
	var serialNo = &quot;&quot;;
	var as400No = &quot;&quot;;
	//試著查詢本月的序號
	var sqlQuery = &quot;Select MAX(SERIALNO) AS MAXSNO from TBLISSUENOLOG where AS400NOHEAD  = &apos;&quot;+as400NoHead+&quot;&apos;&quot;;
	java.lang.System.out.println(&quot;sqlQuery:&quot; + sqlQuery);
	
	var dataSet = Client.SQLloadValue(sqlQuery);
	java.lang.System.out.println(&quot;dataSet Size:&quot; + dataSet.size());
	
	var record = dataSet.get(0);
	var serial = record.get(&quot;MAXSNO&quot;);
	
	//若無則 insert,若有則 update 新序號
	if(serial.equals(&quot;&quot;)){     
		//產生一組 1 的流水號
		for(var i = 0; i &lt; maxDigit - 1; i++){
			serialNo += &quot;0&quot;;
		}
		serialNo += &quot;1&quot;;
					
		java.lang.System.out.println(&quot;as400NoHead:&quot; + as400NoHead);
		java.lang.System.out.println(&quot;serialNo:&quot; + serialNo);
	}else{
		
		var nextSerial = java.lang.Integer.parseInt(serial) + 1;
		var len = new java.lang.Integer(nextSerial).toString().length();
		//計算新序號的位數
		for(var i = 0; i &lt; maxDigit - len; i++){
			serialNo += &quot;0&quot;;
		}
		
		serialNo += nextSerial;
		
		java.lang.System.out.println(&quot;as400NoHead:&quot; + as400NoHead);
		java.lang.System.out.println(&quot;serialNo:&quot; + serialNo);
	}
	//寫回資料庫
	Client.SQLinsertValue(&quot;Insert Into TBLISSUENOLOG (AS400NOHEAD,SERIALNO,ISSUENO,STATE,CAUSE) values (&apos;&quot;+as400NoHead+&quot;&apos;,&apos;&quot;+serialNo+&quot;&apos;,&apos;&quot;+issueNo+&quot;&apos;,&apos;&quot;+State+&quot;&apos;,&apos;&quot;+Cause+&quot;&apos;)&quot;);				
	
	as400No = as400NoHead + serialNo;
	return as400No;
}
//更新AS400的決裁單狀態
function updateAS400Status(runSize,maxDigit,DecisionNo,State,Cause){
    var msg =&quot;&quot;;
	//試著查詢本月的序號
	var sqlQuery = &quot;Select * from TBLISSUENOLOG where AS400NOHEAD||SERIALNO  = &apos;&quot;+DecisionNo+&quot;&apos;&quot;;
	java.lang.System.out.println(&quot;sqlQuery:&quot; + sqlQuery);
	var dataSet = runSize.SQLloadValue(sqlQuery);
	java.lang.System.out.println(&quot;dataSet:&quot; + dataSet);
	if (dataSet.size()&gt;0){
		//試著更新原有決裁單號
		var aData = dataSet.get(0);
		var as400NoHead = aData.get(&quot;AS400NOHEAD&quot;);
		var serialNo = aData.get(&quot;SERIALNO&quot;)
		var sqlUpdate = &quot;Update TBLISSUENOLOG SET STATE=&apos;&quot;+ State +&quot;&apos;, CAUSE =&apos;&quot;+Cause +&quot;&apos; where AS400NOHEAD=&apos;&quot;+as400NoHead+&quot;&apos; and SERIALNO=&apos;&quot;+serialNo+&quot;&apos;&quot;;
		java.lang.System.out.println(&quot;sqlUpdate:&quot; + sqlUpdate);
		sqlResult = runSize.SQLupdateValue(sqlUpdate);
		java.lang.System.out.println(&quot;sqlResult:&quot; + sqlResult);
	}	
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>產生單號的相關函數</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00241169693876062</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/01/25 10:57:56</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ECN.SendCSMail</string> 
     </void> 
     <void property="id"> 
      <string>SCL00241169693876062</string> 
     </void> 
     <void property="name"> 
      <string>SendCSMail</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00031157709081640</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//loadLibrary(&quot;com.A.ECN.SendCSMail&quot;);
//sendCSECNMail();

function sendCSECNMail(){
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        var to = Server.getMember(MyTask.getRealExecutor()).getEmail(); 
        var cc = &quot;&quot;; 
        var subject = &quot;主旨 : &quot; + dataMap.get(&quot;ECN_No&quot;).trim() + &quot;_已經會簽完成。&quot; ; // Mail Subject 
        var text = &quot; &lt;br&gt; 主旨 : &quot; + dataMap.get(&quot;ECN_No&quot;).trim() + &quot;_已經會簽完成。&lt;br&gt;&quot;; // Mail Subject 
		//var arturl = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
		//text += &quot;&lt;br&gt;此ECN已發行，相關資料如下所示，或是點選&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&lt;br&gt;&quot;;
        text += &quot;   說明 : &quot; + dataMap.get(&quot;Mail_Subject&quot;) +&quot;&lt;br&gt;&quot;;
        text += &quot;   ECN單號 :&quot; + dataMap.get(&quot;ECN_No&quot;) + &quot; &lt;br&gt; &quot;;
        text += &quot;   申請人 : &quot;+ dataMap.get(&quot;App_ID&quot;) + &quot;_&quot; + dataMap.get(&quot;App_Name&quot;) +&quot; &lt;br&gt;&quot;;
        text += &quot;   產品型號 : &quot;+ dataMap.get(&quot;Item_Type_No&quot;) +&quot; &lt;br&gt;&quot;;
        text += &quot;   來源ECR/PCR : &quot; + dataMap.get(&quot;ECR_No&quot;) + &quot; &lt;br&gt;&quot;;
        text += &quot;   原PCR申請人： &quot; + dataMap.get(&quot;PCR_ID&quot;) + &quot;_&quot; +  dataMap.get(&quot;PCR_Name&quot;) + &quot; &lt;br&gt;&quot;;
        text += &quot;   變更原因 : &quot;+ getECNReason(dataMap) + &quot; &lt;br&gt;&quot;;
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
        //text += &quot;   裁決處理等級 : &quot; + dataMap.get(&quot;Boss_Progress_Level&quot;) + &quot; &lt;br&gt;&quot;;
        //text += &quot;   ps.ECN須RD最高主管裁決同意才會發行 &lt;br&gt; &quot;;
		
		
        var fileList = new Packages.java.util.Vector(); 
        Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
}

function getECNReason(dataMap){
	var reason =&quot;&quot;;
	if(&quot;true&quot;.equals(dataMap.get(&quot;C1&quot;))){
		reason += &quot;[初次發行]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C2&quot;))){
		reason += &quot;[包裝變更]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C3&quot;))){
		reason += &quot;[客戶要求]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C4&quot;))){
		reason += &quot;[設計改善]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C5&quot;))){
		reason += &quot;[降低成本]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C6&quot;))){
		reason += &quot;[改正BOM表]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C7&quot;))){
		reason += &quot;[料號規格修改]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C8&quot;))){
		reason += &quot;[替代用料]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C9&quot;))){
		reason += &quot;[品質改善]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C10&quot;))){
		reason += &quot;[製程改善]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C11&quot;))){
		reason += &quot;[法規需求]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C12&quot;))){
		reason += &quot;[量產通知]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C13&quot;))){
		reason += &quot;[其他]&quot;;
	}
	
	return reason;
}


function haveAttachFile(){
	var str = &quot;否&quot;;
	var taskID = MyTask.getID();
	var artInstance = MyTask.getArtInstance(); 
    var artID = artInstance.getArtifactID();
    var InsID = artInstance.getID();
    var sql = &quot;select  FileName from AttachFile where  ArtInsID = &apos;&quot;+InsID+&quot;&apos;&quot;;
    var vc = Server.SQLloadValue(sql);
    if (vc.size()&gt;0){
		str = &quot;是&quot;;
    }
	return str;
}

//會簽結束通知
//loadLibrary(&quot;com.A.ECN.SendCSMail&quot;);
//sendCSECRMail();

function sendCSECRMail(){
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        var to = Server.getMember(MyTask.getRealExecutor()).getEmail(); 
        var cc = &quot;&quot;; 
        var subject = &quot;主旨 : &quot; + dataMap.get(&quot;ECR_No&quot;).trim() + &quot;_已經會簽完成。&quot;  ; // Mail Subject 
        var text = &quot; &lt;br&gt;主旨 : &quot; + dataMap.get(&quot;ECR_No&quot;).trim() + &quot;_已經會簽完成。&lt;br&gt;&quot;; // Mail Subject 
		//var arturl = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
		//text += &quot;&lt;br&gt;此ECR已發行，相關資訊如下所示，或是點選&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&lt;br&gt;&quot;;
        //text += &quot;   裁決為 : &quot; + agree +&quot;&lt;br&gt;&quot;;
        text += &quot;   ECR單號 : &quot; + dataMap.get(&quot;ECR_No&quot;) + &quot; &lt;br&gt; &quot;;
        text += &quot;   申請人 : &quot;+ dataMap.get(&quot;App_ID&quot;) + &quot;_&quot; + dataMap.get(&quot;App_Name&quot;) +&quot; &lt;br&gt;&quot;;
        text += &quot;   產品型號 : &quot;+ dataMap.get(&quot;Item_Type_No&quot;) +&quot; &lt;br&gt;&quot;;
        text += &quot;   變更原因 : &quot;+ getECRReason(dataMap) + &quot; &lt;br&gt;&quot;;
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
	
		
        var fileList = new Packages.java.util.Vector(); 
        Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
}

function getECRReason(dataMap){
	var reason =&quot;&quot;;
	if(&quot;true&quot;.equals(dataMap.get(&quot;C1&quot;))){
		reason += &quot;[初次發行]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C2&quot;))){
		reason += &quot;[包裝變更]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C3&quot;))){
		reason += &quot;[客戶要求]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C4&quot;))){
		reason += &quot;[設計改善]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C5&quot;))){
		reason += &quot;[降低成本]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C6&quot;))){
		reason += &quot;[改正BOM表]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C7&quot;))){
		reason += &quot;[料號規格修改]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C8&quot;))){
		reason += &quot;[替代用料]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C9&quot;))){
		reason += &quot;[品質改善]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C10&quot;))){
		reason += &quot;[製程改善]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C11&quot;))){
		reason += &quot;[法規需求]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C12&quot;))){
		reason += &quot;[量產通知]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C13&quot;))){
		reason += &quot;[其他]&quot;;
	}
	
	return reason;
}

//會簽結束通知
//loadLibrary(&quot;com.A.ECN.SendCSMail&quot;);
//sendCSPCRMail();

function sendCSPCRMail(){
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
        var to = Server.getMember(MyTask.getRealExecutor()).getEmail(); 
        var cc = &quot;&quot;; 

        var subject = &quot;主旨 : &quot; + dataMap.get(&quot;PCR_No&quot;).trim() + &quot;_已經會簽完成。&quot; ; // Mail Subject 
        var text = &quot; &lt;br&gt;主旨 : &quot; + dataMap.get(&quot;PCR_No&quot;).trim() + &quot;_已經會簽完成。&lt;br&gt;&quot;; // Mail Subject 
		//text += Server.getMember(MyTask.getRealExecutor()).getName()+  &quot; 您好 !&quot;;
		//var arturl = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
		//text += &quot;&lt;br&gt;此PCR已經會簽完成，相關資訊如下所示，或是點選&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&lt;br&gt;&quot;;
        text += &quot;   PCR單號 : &quot; + dataMap.get(&quot;PCR_No&quot;) + &quot; &lt;br&gt; &quot;;
        text += &quot;   申請人 : &quot;+ dataMap.get(&quot;App_ID&quot;) + &quot;_&quot; + dataMap.get(&quot;App_Name&quot;) +&quot; &lt;br&gt;&quot;;
		text += &quot;   客戶名稱 : &quot;+ dataMap.get(&quot;Customer_ID&quot;)+ dataMap.get(&quot;Customer_Name&quot;) +&quot; &lt;br&gt;&quot;;
        text += &quot;   產品型號 : &quot;+ dataMap.get(&quot;Item_Type_No&quot;) +&quot; &lt;br&gt;&quot;;
        text += &quot;   Ver&amp;Rev : &quot; + dataMap.get(&quot;Ver&quot;) + &quot; &lt;br&gt;&quot;;
        text += &quot;   變更原因 : &quot;+ getPCRReason(dataMap) + &quot; &lt;br&gt;&quot;;
        text += &quot;   ECN處理人 : &quot; + dataMap.get(&quot;ECN_Handle_ID&quot;) + &quot;_&quot; +  dataMap.get(&quot;ECN_Handle_Name&quot;) + &quot; &lt;br&gt;&quot;;
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
        //text += &quot;   裁決處理等級 : &quot; + dataMap.get(&quot;Progress_Level&quot;) + &quot; &lt;br&gt;&quot;;
		
		
        var fileList = new Packages.java.util.Vector(); 
        Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
}

function getPCRReason(dataMap){
	var reason =&quot;&quot;;
	if(&quot;true&quot;.equals(dataMap.get(&quot;C1&quot;))){
		reason += &quot;[新增客戶或機種]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C2&quot;))){
		reason += &quot;[客戶要求修改]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C3&quot;))){
		reason += &quot;[成本考量]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C4&quot;))){
		reason += &quot;[產品改版]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C5&quot;))){
		reason += &quot;[出貨地變更]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C6&quot;))){
		reason += &quot;[BOM 表修改]&quot;;
	}
	if(&quot;true&quot;.equals(dataMap.get(&quot;C7&quot;))){
		reason += &quot;[其他]&quot; + dataMap.get(&quot;C7_Note&quot;);
	}
	
	return reason;
}



/*
主旨 : PCR單號_裁決 : &lt;是否接受PCR&gt;
內文 : 
         此PCR已發行，相關資訊如下所示，或是點選開啟表單直接察看表單內容。
        
        裁決為 : &lt;是否接受PCR&gt;
        PCR單號 : &lt;單號&gt;
        申請人 :  &lt;工號&gt; + &lt;申請人姓名&gt;
        客戶名稱 : &lt;客戶編號&gt;+&lt;名稱&gt;
      產品型號 : &lt;產品型號&gt;
        Ver&amp;Rev :  &lt;Ver&amp;Rev&gt;
        變更原因 : &lt;例如：新增客戶機種，成本考量等．．&gt;
        ECN處理人 :  &lt;工號&gt; + &lt;姓名&gt;
        表單中是否有相關電子檔 : &lt;是否有相關電子檔&gt;
        裁決處理等級 : &lt;例如:MC:變更但不接受&gt;

*/
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00251177170718515</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/04/21 23:51:58</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Server.ProcessTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00251177170718515</string> 
     </void> 
     <void property="name"> 
      <string>ProcessTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021156610951562</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//com.A.Common.Server.ProcessTable
//========================================================================================
//	取出彙整的會簽內容
//========================================================================================
function mergeAddAsInfo() {
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
	//將會簽結果放入審核意見裡面
	var taskmemberlist  = MyTask.getAddASAuditList() ; 
	var totalResult 	= MyTask.getAddASResultString();  				//取得加會簽結果的字串 
	var detailResult    = Server.parseAddASResultString(totalResult);   //將加會簽結果的字串解析成個別的物件形式 
	var flg_rejcet = false;
	  //------------------------------------------------------------------------------------------
	  // 20080107 cc
	  //因 aCSResultData.getMsg(); //簽核意見的api會有切割不完整的問題，改 function 來抓會簽意見
		  var tag = &quot;========================================================&quot;;
		  var msgarray = SplitString(totalResult,tag);
		  var resultarray = SplitResultString(totalResult,tag);
	  //------------------------------------------------------------------------------------------	
	for(var i = 0; i&lt; detailResult.size(); i++){
		var aCSResultData = detailResult.get(i);
		var aresult = resultarray[i];
		if(aresult.startsWith(&quot;] :&quot;)){
			//沒意見的情況下
			aresult = &quot;沒意見&quot;;
		}
		insertTableByAddAs(aCSResultData,aresult,msgarray[i],&quot;Process_Table&quot;);
		//insertTableByAddAs(aCSResultData,resultarray[i],msgarray[i],&quot;Process_Table&quot;);
		if(&quot;不同意&quot; == resultarray[i]){
			flg_rejcet = true; 
		}
	}
	if(flg_rejcet){
		//會簽中只要有一人駁回就是要駁回
		dataMap.put(&quot;Add_Sign_Reject&quot;,&quot;true&quot;);
	}
}

//========================================================================================
// 把簽核結果加至簽核紀錄表格中
//========================================================================================
function insertTableByAddAs(aCSResultData,addasResult,msg,tableName) {
	var aInstance = MyTask.getArtInstance();
	// 整理會簽資料
	var addasDep    = aCSResultData.getDep();
	var addasRole   = aCSResultData.getRole();
	var tmpName 	= aCSResultData.getName();
	var addasTime	= aCSResultData.getTime(&quot;yyyy/MM/dd HH:mm&quot;);
	var addasName   = tmpName.substring(0,tmpName.indexOf(&quot;(&quot;)); //只能拿到姓名，沒有工號可用
	//var addasMsg    = aCSResultData.getMsg(); //簽核意見
	var addasMsg    = msg; //簽核意見

	// 將會簽結果放入審核意見裡面
	var appDataMap = aInstance.getAppDataMap();
	var records = appDataMap.get(tableName);
	var row = new Packages.java.util.HashMap();
	row.put(&quot;ITEM7&quot;, records.size() + 1 + &quot;&quot;);
	row.put(&quot;ITEM5&quot;, addasTime);
	row.put(&quot;ITEM8&quot;, &quot;會簽單位&quot;);
	row.put(&quot;ITEM6&quot;, addasDep);
	row.put(&quot;ITEM9&quot;, addasRole);
	row.put(&quot;ITEM4&quot;, addasName);
	var l_member = Server.getMemberByCName(addasName);
	var l_id = l_member.getMyID();				
	row.put(&quot;ITEM2&quot;, l_id); //工號
	row.put(&quot;ITEM3&quot;, addasResult);
	row.put(&quot;ITEM1&quot;, addasMsg);
	row.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID
	records.add(records.size(), row);
	appDataMap.put(tableName, records);
	aInstance.setAppDataMap(appDataMap);
}	
//==============================
//下 SQL 語法可能遇到的特殊字元
//==============================

function replaceString(s){
	var s1 = java.lang.String(s);
	s1.replaceAll(&quot;&apos;&quot;,&quot;&apos;&apos;&quot;);
	return s1;
}

/**
 * 拆分字串到陣列，分割符可使用多個字符或者中文
 * 建立日期：(2001-7-10 14:50:31)
 * @param fieldsru java.lang.String 輸入參數：待拆分字符串
 * @param tag java.lang.String      輸入參數：分割符
 * @exception java.lang.Exception 異常說明。
 * @exception java.io.IOException 異常說明。
 */
function SplitString(fieldsru,tag){
	try{
	var returnarray = fieldsru.split(tag);
	// 加會意見： [Mon Jan 07 11:18:21 CST 2008] [徐正芳(徐正芳),廠/處長,人力資源處] :不同意 駁回測試 
	for(var t=0;t&lt;returnarray.length-1;t++){
		var temp_index = returnarray[t].indexOf(&quot;] :&quot;);
		if(temp_index&gt;0){
			returnarray[t] = returnarray[t].substring(temp_index);
			var n = 1 + returnarray[t].indexOf(&quot;\n&quot;);
			if(n&gt;0){
				returnarray[t] = returnarray[t].substring(n);
			}
		}
	}
	return returnarray;
	}catch (e)	{
		//java.lang.System.out.println(e.getMessage());
	}
	return null;
}

function SplitResultString(fieldsru,tag){
	try{
	var returnarray = fieldsru.split(tag);
	// 加會意見： [Mon Jan 07 11:18:21 CST 2008] [徐正芳(徐正芳),廠/處長,人力資源處] :不同意 駁回測試 
	for(var t=0;t&lt;returnarray.length-1;t++){
		var temp_index = returnarray[t].indexOf(&quot;] :&quot;);
		if(temp_index&gt;0){
			returnarray[t] = returnarray[t].substring(temp_index);
			var n = returnarray[t].indexOf(&quot;\n&quot;);
			if(n&gt;4){
				returnarray[t] = returnarray[t].substring(3,n);
			}
		}
	}
	return returnarray;
	}catch (e)	{
		//java.lang.System.out.println(e.getMessage());
	}
	return null;
}

//=========================================
//將簽核區資訊放入簽核歷程表格
//=========================================
function setProcessTable(){
//	var department = Server.getDepartment(MyTask.getDepartmentID()).getName();
	var depid = MyTask.getDepartmentID();
	var dep = Server.getDepartment(depid);
	var rMember = Server.getMember(MyTask.getRealExecutor()); //執行者
//	var roleTitle = Server.getRole(rMember.getMainRoleID()).getName();	
//	var roleTitle = Server.getRole(MyTask.getRoleID()).getName();	
	var roleTitle = rMember.getJobTitle();
	
	var department = &quot;x&quot;;
	if(dep != null){
		department = dep.getName();
	}else{
		//抓不到部門(可能是專案職務)，就抓主要職務的部門
		var roleID = rMember.getMainRoleID();
		var memDR = rMember.getMemberDR(roleID);
		var department = memDR.getDepartmentName();	//使用者部門名稱
	}
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
		//Set 流程控制
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
		var roleid = Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
		dataMap.put(&quot;From_User_Role_ID&quot;, roleid);	
		//dataMap.put(&quot;From_User_Role_ID&quot;, MyTask.getRoleID());	 // 很奇怪會一直往上抓
	//var roleTitle = aInstance.getAppValue(&quot;verifyTitle&quot;);
	var name = aInstance.getAppValue(&quot;Verify_Name&quot;);
	var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
	var isAgree = true;
	if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))) {
		isAgree = false;
		//主管退回時mail通知之前簽核過的主管
		//rejectMail(mID, aInstance.getAppValue(&quot;verifyName&quot;));
	}
	appendProcessTable(department, roleTitle, name, isAgree, reason);

}


//=========================================
//簽核歷程表格加入一筆
//=========================================
function appendProcessTable(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數	
	var member = Server.getMemberByCName(name);
	var id = member.getMyID();
	var vApp_Name = aInstance.getAppValue(&quot;App_Name&quot;);  // add by wangwei 2008/05/27 
	//加入代理人資訊 20070625
	if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
		name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
	}		
	var hm = java.util.HashMap();
	var proName = MyTask.getProcessName();//關卡名稱
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
	hm.put(&quot;ITEM6&quot;, department);//Department 部門
	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
	hm.put(&quot;ITEM2&quot;, id);//ID 工號	
	hm.put(&quot;ITEM4&quot;, name);//Name 姓名
	if (isAgree == true) {
		hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		//hm.put(&quot;ITEM2&quot;,&quot;false&quot;);
		if(rowCount == 0){
			hm.put(&quot;ITEM3&quot;,&quot;提出&quot;);//同意
		}else{			
			// 找出Process_Table序號為1的關卡名稱與目前關卡名稱比較是否為再提出 970929 	
			for(var i=0;i&lt;rowCount;i++){
				var rowData = vecTableData.get(i);
				var rowProcessNo = rowData.get(&quot;ITEM7&quot;);	
				java.lang.System.out.println(&quot;rowProcessNo:&quot;+rowProcessNo);
				if(rowProcessNo.equals(&quot;1&quot;)||rowProcessNo==&quot;1&quot;){
					var rowProcessName = rowData.get(&quot;ITEM8&quot;);
//					if(proName.equals(rowProcessName)){
					if(proName.indexOf(rowProcessName) &gt;= 0){
//					if(rowProcessName.indexOf(proName) &gt;= 0){	
						hm.put(&quot;ITEM3&quot;,&quot;再提出&quot;);//同意	
						break;
					}
				}
			}
//			if(name.equals(vApp_Name)){ 
//			if(proName.equals(row1ProcessName)){//970923
//				hm.put(&quot;ITEM3&quot;,&quot;再提出&quot;);//同意				
//			}
		}
	} else {	
		  hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);
		//hm.put(&quot;ITEM2&quot;,&quot;true&quot;);
	}
	
	hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
	hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
	vecTableData.add(rowCount,hm);
	aInstance.setAppValue(&quot;Process_Table&quot;,vecTableData);
		formDataMap.put(&quot;Agree&quot;,&quot;true&quot;);
		formDataMap.put(&quot;Reject&quot;,&quot;false&quot;);
		formDataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
}

//=========================================
//審核關卡若是代理人代審時在表單上fieldName欄位註記,原欄位內容向下推一行
//=========================================
function checkDeputySign(fieldName) {
	var mID = MyTask.getMemberID(); //會抓到真正task owner
	var realID = MyTask.getRealExecutor();//目前Task 的執行者member id
	if (!mID.equals(realID)) {
		var realMember = Client.getMemberByID(realID);
		Form.setValue(fieldName, &quot;本工作為由代理人 &quot; + realMember.getName() + &quot; 處理\n&quot; +  Form.getValue(fieldName));
	}
}

//=========================================
//
//=========================================
    function getFormatedCurrentTime(){
        var date = new java.util.Date(java.lang.System.currentTimeMillis());
        var simpledateformat = new java.text.SimpleDateFormat(&quot;yyyy/MM/dd HH:mm&quot;);
        return simpledateformat.format(date);
    }

//---------
// 用於動態加會簽時寫回簽核紀錄
function setProcessTableEx(){
//	var department = Server.getDepartment(MyTask.getDepartmentID()).getName();
	var depid = MyTask.getDepartmentID();
	var dep = Server.getDepartment(depid);
	var rMember = Server.getMember(MyTask.getRealExecutor()); //執行者
	var roleTitle = rMember.getJobTitle();
	var department = &quot;x&quot;;
	if(dep != null){
		department = dep.getName();
	}else{
		//抓不到部門(可能是專案職務)，就抓主要職務的部門
		var roleID = rMember.getMainRoleID();
		var memDR = rMember.getMemberDR(roleID);
		var department = memDR.getDepartmentName();	//使用者部門名稱
	}
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
		//Set 流程控制
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
	var roleid = Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
		dataMap.put(&quot;From_User_Role_ID&quot;, roleid);	
	var name = aInstance.getAppValue(&quot;Verify_Name&quot;);
		if(!rMember.getName().equals(name)){
			return ;
			}
	var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
	var isAgree = true;
	if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))|| &quot;true&quot;.equals(aInstance.getAppValue(&quot;con_Reject&quot;))   ) {
		isAgree = false;
	}
	appendProcessTableEx(department, roleTitle, name, isAgree, reason);
}
//=========================================
//簽核歷程表格加入一筆  add by wangwei 2008/12/09
//=========================================
function appendProcessTableEx(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數
	var member = Server.getMemberByCName(name);
	var id = member.getMyID();
	//加入代理人資訊 20070625
	if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
		name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
	}
	var hm = java.util.HashMap();
	var proName = MyTask.getProcessName();//關卡名稱  
	if( proName.indexOf(&quot;]&quot;) &gt; 0 ){
		proName=proName.substring(proName.indexOf(&quot;]&quot;)+1,proName.length());  // 若有[關卡名稱]則只取真正的關卡名稱
	}
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
	hm.put(&quot;ITEM6&quot;, department);//Department 部門
	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
	hm.put(&quot;ITEM2&quot;, id);//ID 工號	
	hm.put(&quot;ITEM4&quot;, name);//Name 姓名
	if (isAgree == true) {
		hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		if(rowCount == 0){
			hm.put(&quot;ITEM3&quot;,&quot;提出&quot;);//同意
		}
	} else {
		hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);
	}
	hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
	hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
	vecTableData.add(rowCount,hm);
	aInstance.setAppValue(&quot;Process_Table&quot;,vecTableData);
//	formDataMap.put(&quot;Agree&quot;,&quot;true&quot;);
//	formDataMap.put(&quot;Reject&quot;,&quot;false&quot;);
//	formDataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
}
	


//---------
// 用於動態加會簽時寫回簽核紀錄 For 子流程始用 20090507
function setProcessTableEx_A(){
//	var department = Server.getDepartment(MyTask.getDepartmentID()).getName();
	var depid = MyTask.getDepartmentID();
	var dep = Server.getDepartment(depid);
	var rMember = Server.getMember(MyTask.getRealExecutor()); //執行者
	var roleTitle = rMember.getJobTitle();
	var department = &quot;x&quot;;
	if(dep != null){
		department = dep.getName();
	}else{
		//抓不到部門(可能是專案職務)，就抓主要職務的部門
		var roleID = rMember.getMainRoleID();
		var memDR = rMember.getMemberDR(roleID);
		var department = memDR.getDepartmentName();	//使用者部門名稱
	}
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
		//Set 流程控制
		dataMap.put(&quot;From_User_ID&quot;, MyTask.getRealExecutor());
	var roleid = Server.getMember(MyTask.getRealExecutor()).getMainRoleID();
		dataMap.put(&quot;From_User_Role_ID&quot;, roleid);	
	var name = aInstance.getAppValue(&quot;Verify_Name&quot;);
		if(!rMember.getName().equals(name)){
			return ;
			}
	var reason = aInstance.getAppValue(&quot;Verify_Note&quot;);
	var isAgree = true;
	if (&quot;true&quot;.equals(aInstance.getAppValue(&quot;Reject&quot;))|| &quot;true&quot;.equals(aInstance.getAppValue(&quot;con_Reject&quot;))   ) {
		isAgree = false;
	}
	appendProcessTableEx_A(department, roleTitle, name, isAgree, reason);
}
//=========================================
//簽核歷程表格加入一筆  For 子流程始用 20090507
//=========================================
function appendProcessTableEx_A(department, roleTitle, name, isAgree, reason) {
	var aInstance = MyTask.getArtInstance();
	var formDataMap = aInstance.getAppDataMap();
	var vecTableData = formDataMap.get(&quot;Process_Table_A&quot;);
	var rowCount = vecTableData.size();//vecTableData裡資料筆數
	var member = Server.getMemberByCName(name);
	var id = member.getMyID();
	//加入代理人資訊 20070625
	if(! MyTask.getRealExecutor().equals(MyTask.getMemberID())){
		name =  name + &quot;(代理:&quot; + Server.getMemberByID(MyTask.getMemberID()).getName() + &quot;)&quot;;
	}
	var hm = java.util.HashMap();
	var proName = MyTask.getProcessName();//關卡名稱  
	if( proName.indexOf(&quot;]&quot;) &gt; 0 ){
		proName=proName.substring(proName.indexOf(&quot;]&quot;)+1,proName.length());  // 若有[關卡名稱]則只取真正的關卡名稱
	}
	hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
	hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
	hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
	hm.put(&quot;ITEM6&quot;, department);//Department 部門
	hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
	hm.put(&quot;ITEM2&quot;, id);//ID 工號	
	hm.put(&quot;ITEM4&quot;, name);//Name 姓名
	if (isAgree == true) {
		hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		if(rowCount == 0){
			hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
		}
	} else {
		hm.put(&quot;ITEM3&quot;,&quot;駁回&quot;);
	}
	hm.put(&quot;ITEM1&quot;, reason);//Opinion 意見
	hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
	vecTableData.add(rowCount,hm);
	aInstance.setAppValue(&quot;Process_Table_A&quot;,vecTableData);
//	formDataMap.put(&quot;Agree&quot;,&quot;true&quot;);
//	formDataMap.put(&quot;Reject&quot;,&quot;false&quot;);
//	formDataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
}
	
	
	
	
	

//==============================================================	
// Server 將CurrentTask 會簽結果放入審核意見裡面
// 20090220-1 cc
//==============================================================	
	function setSignTableResult(){
			var aInstance = MyTask.getArtInstance();
			var dataMap = aInstance.getAppDataMap();
			var vecTableData = dataMap.get(&quot;Process_Table&quot;);
			var rowCount = vecTableData.size();//vecTableData裡資料筆數	
          //將會簽結果放入審核意見裡面
          var taskmemberlist = MyTask.getAddASAuditList() ; 
          var TotalResult =MyTask.getAddASResultString(); //取得加會簽結果的字串
		  
		  //------------------------------------------------------------------------------------------
		  // 20080107 cc
		  //因 aCSResultData.getMsg(); //簽核意見的api會有切割不完整的問題，改 function 來抓會簽意見
		  var tag = &quot;========================================================&quot;;
		  var msg = SplitString(TotalResult,tag);
		  //------------------------------------------------------------------------------------------
          var detailresult =Server.parseAddASResultString(TotalResult);   //將加會簽結果的字串解析成個別的物件形式 
		  var flg_reject = false;
		  if(detailresult.size()&gt;0){
			  for(var i = 0; i&lt; detailresult.size(); i++){
				try{
					var flg = true;	      
					var aCSResultData = detailresult.get(i);
					var l_time = aCSResultData.getTime(&quot;yyyy/MM/dd HH:mm&quot;);
					var l_name = aCSResultData.getName(); //只能拿到姓名，沒有工號可用
					var l_role = aCSResultData.getRole(); //職稱
					var l_dep = aCSResultData.getDep();
					l_name = l_name.substring(0,l_name.indexOf(&quot;(&quot;));
					//var l_msg = aCSResultData.getMsg(); //簽核意見
					var l_msg = msg[i]; //簽核意見
					var l_result = &quot;未表示&quot;;
					if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Agree&quot;)){
						l_result = &quot;同意&quot;;
					}else if(aCSResultData.getSignResult().equalsIgnoreCase(&quot;Disagree&quot;)||aCSResultData.getSignResult().equalsIgnoreCase(&quot;reject&quot;)){
						l_result = &quot;不同意&quot;;
						flg_reject = true ;
					}
					for (var j=0;j&lt;vecTableData.size() ;j++){
						//check 會簽人的工號+簽核時間有無在 SingTable 內，有的話就 update table 內的簽核及審核意見
						//如果不在 table 內就加到最後
						t_name = vecTableData.get(j).get(&quot;ITEM4&quot;) ;//process_table.getValueAt(j,&quot;姓名&quot;);
						t_yes =  vecTableData.get(j).get(&quot;ITEM3&quot;); // process_table.getValueAt(j,&quot;是否核准&quot;);
						t_time = vecTableData.get(j).get(&quot;ITEM5&quot;); //process_table.getValueAt(j,&quot;審核日期&quot;);
						if (l_name.equals(t_name)&amp;&amp; l_time.equals(t_time)){
							vecTableData.get(j).put(&quot;ITEM5&quot;,l_msg);//ITEM5 審核意見
							vecTableData.get(j).put(&quot;ITEM3&quot;,l_result);//(l_result,j,&quot;是否核准&quot;);//同意
							//j = process_table.getRowCount();//跳出 for j
							flg = false;
						}
					}//for j
		
					if(flg == true){
						//不在 table 內就加到最後
									var hm = java.util.HashMap();
									var l_member = Server.getMemberByCName(l_name);
									var l_id = l_member.getMyID();	
									var proName = &quot;*動態加會簽&quot;;//關卡名稱
									hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
									hm.put(&quot;ITEM7&quot;,(vecTableData.size()+1)+&quot;&quot;);//Serial Number 序號
									hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
									hm.put(&quot;ITEM6&quot;, l_dep);//Department 部門
									hm.put(&quot;ITEM9&quot;, l_role);//Title 職稱
									hm.put(&quot;ITEM2&quot;, l_id);//ID 工號	
									hm.put(&quot;ITEM4&quot;, l_name);//Name 姓名
									if (&quot;同意&quot; == l_result) {
										hm.put(&quot;ITEM3&quot;,&quot;同意&quot;);//同意
										//hm.put(&quot;ITEM2&quot;,&quot;false&quot;);
										if(rowCount == 0){
											hm.put(&quot;ITEM3&quot;,&quot;提出&quot;);//同意
										}else{			
											// 找出Process_Table序號為1的關卡名稱與目前關卡名稱比較是否為再提出 970929 	
											for(var i=0;i&lt;rowCount;i++){
												var rowData = vecTableData.get(i);
												var rowProcessNo = rowData.get(&quot;ITEM7&quot;);	
												java.lang.System.out.println(&quot;rowProcessNo:&quot;+rowProcessNo);
												if(rowProcessNo.equals(&quot;1&quot;)||rowProcessNo==&quot;1&quot;){
													var rowProcessName = rowData.get(&quot;ITEM8&quot;);
													if(proName.indexOf(rowProcessName) &gt;= 0){
														hm.put(&quot;ITEM3&quot;,&quot;再提出&quot;);//同意	
														break;
													}
												}
											}
										}
									} else {	
										  hm.put(&quot;ITEM3&quot;,l_result);
									}
									
									hm.put(&quot;ITEM1&quot;, l_msg);//Opinion 意見
									hm.put(&quot;ITEM10&quot;, MyTask.getID());	//TaskID	
									vecTableData.add(vecTableData.size(),hm);
									aInstance.setAppValue(&quot;Process_Table&quot;,vecTableData);
//										formDataMap.put(&quot;Agree&quot;,&quot;true&quot;);
//										formDataMap.put(&quot;Reject&quot;,&quot;false&quot;);
//										formDataMap.put(&quot;Verify_Note&quot;,&quot;&quot;);
						}
					}catch(e){}
					
				}//for i
			}
	}

	
	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>20070625 加入代理人資訊 
20071228 加入簽核記錄[處理時間][TaskID]</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00251280397834700</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/12/10 16:05:45</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.TRN_SJ_QF_Rule</string> 
     </void> 
     <void property="id"> 
      <string>SCL00251280397834700</string> 
     </void> 
     <void property="name"> 
      <string>TRN_SJ_QF_Rule</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//loadLibrary(&quot;com.flowring.orgClient&quot;);
//將選到人員的memID放到dptnoID
//考慮同名情形
//考慮到人員的memID放到dptnoID //考慮同名情形
//com.gce.HR.Client.TRN_SJ_QF_Rule
function getChief(){							// ----------------------------------------------------
	var ls_dptno = Form.getValue(&quot;dptno&quot;);
	if (&quot;&quot;.equals(ls_dptno)) {	
		Form.setValue(&quot;dptnoID&quot;, &quot;&quot;);
		Form.showMessageDialog(&quot;請先選擇部門&quot;);		
	}	
	Form.setValue(&quot;dptnoID&quot;,ls_dptno);
	// ---(S) 取得所選取的單位主管 -by Heather 20081021
	var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);
    //抓取BPM 短期資料庫連線
    loadLibrary(&quot;com.gce.Common.Util&quot;);
	var ls_memt = get_ls_memt(v_factory);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
  	var conn = Client.createSessionConnection(conn_name);
	var vSQL = &quot;select chief from empm030 where ( flag= &apos;N&apos; or flag is null) and  trim(dptno)||&apos;-&apos;||trim(dptcname) = &apos;&quot; + ls_dptno + &quot;&apos;&quot;;	
	try{
		var prjList = conn.loadValue(vSQL);
		if (prjList.size() &gt; 0){	
			for(var i=0;i&lt;prjList.size();i++){
				var ls_empm030 = prjList.get(i);			
				var ls_chief = ls_memt+ls_empm030.get(&quot;chief&quot;);
			    var cMember = Client.getMember(ls_chief);		
			}		
			//抓取使用者相關資料
			var sUserName = cMember.getName();
			var roleID = cMember.getMainRoleID();
			var memDR = cMember.getMemberDR(roleID);
			var sDepName = memDR.getDepartmentName();	//使用者部門名稱
			var sDepID = Client.getDepartment(memDR.getDepartmentID()).getMyID();	
			var sRoleName = memDR.getRoleName();	//使用者職務名稱
			Form.setValue(&quot;Manager_ID&quot;,ls_chief); //指定主管ID
			Form.setValue(&quot;Manager_Name&quot;,cMember);//指定主管姓名	
			Form.setValue(&quot;App_MemID&quot;,ls_chief)	;			
 		    Form.setValue(&quot;Assign_Manager&quot;,&quot;true&quot;);				
		}	
	}catch(e){
		Form.showMessageDialog(&quot;com.gce.HR.Client.TRN_SJ_QF_Rule.getChief\n讀取部門檔失敗!\n&quot;+vSQL);	
	}finally{
		conn.close();
	}	
}   												//--------------------------------------------------------------

function getChief_1(){
	var ls_dptno = Form.getValue(&quot;dptno&quot;);  						// 取得申請部門ID
	var ls_dptno_ID = Form.getValue(&quot;dptno&quot;).substr(0,3);
	Form.setValue(&quot;dptno_ID&quot;,ls_dptno_ID);				
	/* 取得申請部門的單位管
	   依申請部門代入EMPD030取得該部門的單位主管	
	*/	
    var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var ls_memt = get_ls_memt(v_factory);	
    //抓取BPM 短期資料庫連線
    loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
  	var conn = Client.createSessionConnection(conn_name);		
	var sql = &quot; select chief from empm030 where ( flag= &apos;N&apos; or flag is null) and  trim(dptno)||&apos;-&apos;||trim(dptcname) = &apos;&quot; + ls_dptno + &quot;&apos;&quot;  ;
	try{
		var dptList = conn.loadValue(sql);
		for(var i=0;i&lt;dptList.size();i++){
			var ls_empm030 = dptList.get(i);
			var ls_chief = ls_memt+ls_empm030.get(&quot;chief&quot;);
			var ls_chief_name = Client.getMember(ls_chief);			
			Form.setValue(&quot;Manager_ID&quot;,ls_chief); //指定主管ID
			Form.setValue(&quot;Manager_Name&quot;,ls_chief_name);//指定主管姓名			
	    } 
		Form.setValue(&quot;Assign_Manager&quot;,&quot;true&quot;);	
    }catch(e){
		Form.showMessageDialog(&quot;com.gce.HR.Client.TRN_SJ_QF_Rule.getChief_1\n讀取部門檔失敗!\n&quot;+sql);
	}	
   if (&quot;TGCE&quot;.equals(v_factory)) {
	   /* 取得申請部門的教育訓練最高主管
	      依申請部門代入EMPD032取得該部門的教育訓高最高主管	
	   */	
	   var sql_A = &quot;select distinct trn_chief from empm032 where trim(dptno) = &apos;&quot;+ls_dptno_ID+&quot;&apos;&quot;; 	
	   try{
		   var dptList_A = conn.loadValue(sql_A);
		   for(var j=0;j&lt;dptList_A.size();j++){
			   var ls_empm032 = dptList_A.get(j);
			   var ls_trn_chief = &quot;MEMT1&quot;+ls_empm032.get(&quot;trn_chief&quot;);
			   Form.setValue(&quot;trn_chief&quot;,ls_trn_chief);
		   }
	   }catch(e){
		   Form.showMessageDialog(&quot;com.gce.HR.Client.TRN_SJ_QF_Rule.getChief_1\n讀取部門檔失敗!\n&quot;+sql_A);	
	   }	
  }
  if(conn != null){
	  conn.close();
  }
  
  // 取得年份
  var Ob_date = new Packages.pase.agenda.MyDate();
  var ls_year = Ob_date.getCurrentYear();   
  var ls_dptno = Form.getValue(&quot;dptno&quot;).substr(0,3);    	// 取得部門ID
  try{  													// 取得課程資訊
//	  var ls_sql  = &quot; select INSID,ITEM6,ITEM1,ITEM2,ITEM3,ITEM4,ITEM5,ITEM7,ITEM8,ITEM9,ITEM10,ITEM11,ITEM12,ITEM13 &quot;;
//          ls_sql += &quot; from ART00751258293039449item14 where substr(item12,0,3)=&apos;&quot;+ls_dptno+&quot;&apos;and insid in &quot;;
//		  ls_sql += &quot; (select max(insid) from  ART00751258293039449_ins where substr(item15,0,3)=&apos;&quot;+ls_dptno+&quot;&apos; and item155=&apos;false&apos; )&quot;;
//		  ls_sql += &quot; union select INSID,ITEM6,ITEM1,ITEM2,ITEM3,ITEM4,ITEM5,ITEM7,ITEM8,ITEM9,ITEM10,ITEM11,ITEM12,ITEM13 &quot;;
//          ls_sql += &quot; from ART00971274146898338item14 where substr(item12,0,3)=&apos;&quot;+ls_dptno+&quot;&apos;and insid in &quot;;
//		  ls_sql += &quot; (select max(insid) from  ART00971274146898338_ins where  substr(item15,0,3)=&apos;&quot;+ls_dptno+&quot;&apos; and item155=&apos;false&apos; ) ORDER BY ITEM4 &quot;;	

    var ls_sql  = &quot;  select INSID,ITEM6,ITEM1,ITEM2,ITEM3,ITEM4,ITEM5,ITEM7,ITEM8,ITEM9,ITEM10,ITEM11,ITEM12,ITEM13 &quot;;
          ls_sql += &quot; from ART00971274146898338item14 where substr(item12,0,3)=&apos;&quot;+ls_dptno+&quot;&apos;and insid in &quot;;
		  ls_sql += &quot; (select max(insid) from  ART00971274146898338_ins where  substr(item15,0,3)=&apos;&quot;+ls_dptno+&quot;&apos; and item155=&apos;false&apos; ) ORDER BY ITEM4 &quot;;  		  
         
	  
	  
	  Client.addDebugLog(&quot;操作人員工安訓練規定--&gt;&quot;+ls_sql);
	  var vec = Client.SQLloadValue(ls_sql);		
	  var WORK_LIST = Form.getComponent(&quot;WORK_LIST&quot;);
	  WORK_LIST.clear() ;
	  var comboBox = Form.getComponent(&quot;CLASS_NAME&quot;);
		  comboBox.removeAllItems();
		  comboBox.addItem(&quot;  &quot;);
		  var temp = &quot;;&quot;;
		  if ( vec.size() &gt; 0 ){		
				  for(var i=0;i&lt;vec.size();i++){
					  var ls_trn = vec.get(i);
					  var row = WORK_LIST.newRow(); // 在table中新增一筆空白記錄
					  row = row - 1; // 由於行數是從0開始，所以在處理
					  WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM1&quot;),row,&quot;文件編號&quot;);			
					  WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM2&quot;),row,&quot;設備名稱&quot;);
					  WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM3&quot;),row,&quot;課程名稱&quot;);
					  WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM4&quot;),row,&quot;時數&quot;);
					  WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM5&quot;),row,&quot;筆試&quot;);
					  WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM7&quot;),row,&quot;實作&quot;);
					  WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM8&quot;),row,&quot;審查權責&quot;);
					  WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM13&quot;),row,&quot;課程編碼&quot;);
					  if(temp.indexOf((&quot;;&quot;+ls_trn.get(&quot;ITEM3&quot;)+&quot;;&quot;))==-1){
						  temp +=ls_trn.get(&quot;ITEM3&quot;)+&quot;;&quot;;
						  comboBox.addItem(ls_trn.get(&quot;ITEM3&quot;));
					  }
					  
				  }
			}
			if(vec.size() == 0){
				 var ls_sql_  = &quot; select INSID,ITEM6,ITEM1,ITEM2,ITEM3,ITEM4,ITEM5,ITEM7,ITEM8,ITEM9,ITEM10,ITEM11,ITEM12,ITEM13 &quot;;
				    ls_sql_ += &quot; from ART00751258293039449item14 where substr(item12,0,3)=&apos;&quot;+ls_dptno+&quot;&apos;and insid in &quot;;
					ls_sql_ += &quot; (select max(insid) from  ART00751258293039449_ins where substr(item15,0,3)=&apos;&quot;+ls_dptno+&quot;&apos; and item155=&apos;false&apos; )&quot;;
					var vec1 = Client.SQLloadValue(ls_sql_);
					comboBox.removeAllItems();
					if ( vec1.size() &gt; 0 ){		
						for(var i=0;i&lt;vec1.size();i++){
							var ls_trn = vec1.get(i);
							var row = WORK_LIST.newRow(); // 在table中新增一筆空白記錄
							row = row - 1; // 由於行數是從0開始，所以在處理
							WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM1&quot;),row,&quot;文件編號&quot;);			
							WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM2&quot;),row,&quot;設備名稱&quot;);
							WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM3&quot;),row,&quot;課程名稱&quot;);
							WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM4&quot;),row,&quot;時數&quot;);
							WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM5&quot;),row,&quot;筆試&quot;);
							WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM7&quot;),row,&quot;實作&quot;);
							WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM8&quot;),row,&quot;審查權責&quot;);
							WORK_LIST.setValueAt(ls_trn.get(&quot;ITEM13&quot;),row,&quot;課程編碼&quot;);
							if(temp.indexOf((&quot;;&quot;+ls_trn.get(&quot;ITEM3&quot;)+&quot;;&quot;))==-1){
								temp +=ls_trn.get(&quot;ITEM3&quot;)+&quot;;&quot;;
								comboBox.addItem(ls_trn.get(&quot;ITEM3&quot;));
							}
					  
						}
					}
			}
			  
        
  }catch(e){
  }finally{
	
  }
}

function getQCEMP(v_factory){
	if (&quot;SGCE&quot;.equals(v_factory)){
		//jolin 要求  update by irene_chang@20100831
//		var ls_filter = &quot;(&apos;6G0&apos;,&apos;6G2&apos;,&apos;6G4&apos;,&apos;6G7&apos;,&apos;6G3&apos;,&apos;7G3&apos;,&apos;6G6&apos;)&quot;;
		var ls_filter = &quot;(&apos;&apos;)&quot;;
//		var ls_filter1 = &quot;(&apos;MEMS1000399&apos;,&apos;MEMS1017788&apos;,&apos;MEMS1020872&apos;,&apos;MEMS1019885&apos;,&apos;MEMS1021415&apos;,&apos;MEMS1019752&apos;,&apos;MEMS1020367&apos;,&apos;MEMS1021294&apos;,&apos;MEMS1020869&apos;,&apos;MEMS1019304&apos;,&apos;MEMS1014588&apos;,&apos;MEMS1018209&apos;,&apos;MEMS1022123&apos;,&apos;MEMS1016328&apos;,&apos;MEMS1019303&apos;)&quot;;
        //jolin 要求  update by irene_chang@20100831
 	    var ls_filter1 = &quot;(&apos;MEMS1027032&apos;)&quot;; // modify by edison@20121029
	}else if (&quot;CGCE&quot;.equals(v_factory)){
		// CGCE取以下部門所有人員,不需分主管職
		var ls_filter = &quot;(&apos;8G0&apos;,&apos;8G2&apos;,&apos;8G3&apos;,&apos;8G4&apos;,&apos;8Q0&apos;,&apos;8G7&apos;)&quot;;
		var ls_filter1 = &quot;(&apos;MEMC1018544&apos;,&apos;MEMC1008827&apos;,&apos;MEMH1015707&apos;,&apos;MEMC1010238&apos;,&apos;MEMC1000709&apos;,&apos;MEMC1022199&apos;,&apos;MEMC1021072&apos;,&apos;MEMC1019658&apos;,&apos;MEMC1025497&apos;,&apos;MEMC1026211&apos;,&apos;MEMC1027454&apos;,&apos;MEMC1038112&apos;)&quot;;
	}else if (&quot;HGCE&quot;.equals(v_factory)){
		// HGCE取以下部門所有人員,不需分主管職
		var ls_filter = &quot;(&apos;&apos;)&quot;;
		var ls_filter1 = &quot;(&apos;MEMH1000201&apos;,&apos;MEMH1002569&apos;,&apos;MEMH1016858&apos;,&apos;MEMH1007577&apos;,&apos;MEMH1009038&apos;,&apos;MEMH1006214&apos;,&apos;MEMH1005820&apos;,&apos;MEMH1010887&apos;,&apos;MEMH1014995&apos;,&apos;MEMH1023072&apos;,&apos;MEMH1003177&apos;,&apos;MEMH1015772&apos;,&apos;MEMH1002080&apos;,&apos;MEMH1000198&apos;,&apos;MEMH1022297&apos;,&apos;MEMH1022197&apos;,&apos;MEMH1023693&apos;,&apos;MEMH1023802&apos;)&quot;;//modi by edison@20120216 (新增-龐進,孫艷萍-韓玲艷提出); 20130422 add  姜光春 //20160929;鄒磊;李嘉斌//20181106楚朋、張志
	}
	// 取得品保單位人員 from mem_geninf
	try{			
		var sql = &quot;select TRIM(ID)||&apos;:&apos;||TRIM(USERNAME) as empno,WORKPLACE,ID from mem_geninf where SUBSTR(WORKPLACE,5,3) IN &quot;+ls_filter+&quot; AND SUBSTR(JOBLEVEL,1,1)=&apos;M&apos; &quot;
			sql = sql + &quot; AND DENIEDLOGIN = &apos;false&apos; and RESIGN=&apos;false&apos; and email is not null and email&lt;&gt;&apos;wtadmin@gcecn.com&apos; and email&lt;&gt;&apos;wtadmin@gce.com.tw&apos;&quot; ;
			sql = sql + &quot; UNION select TRIM(ID)||&apos;:&apos;||TRIM(USERNAME) as empno,WORKPLACE,ID from mem_geninf where MEMID IN &quot;+ls_filter1+&quot;  &quot;
			sql = sql + &quot; AND DENIEDLOGIN = &apos;false&apos; and RESIGN=&apos;false&apos; and email is not null and email&lt;&gt;&apos;wtadmin@gcecn.com&apos; and email&lt;&gt;&apos;wtadmin@gce.com.tw&apos; ORDER BY WORKPLACE,ID &quot; ;
			Client.addDebugLog(&quot;特定工作及驗證人員訓練記錄-會簽相關單位人員sql = &quot;+sql);
		var prjList = Client.SQLloadValue(sql);
		var QC_EMP = Form.getComponent(&quot;QC_EMP&quot;);
			QC_EMP.removeAllItems();
			if (prjList.size() &gt; 0) {
				QC_EMP.addItem(&quot;  &quot;);
				for(var i=0;i&lt;prjList.size();i++){				
					QC_EMP.addItem(prjList.get(i).get(&quot;empno&quot;));
				}
			}
	}catch(e){
	}
}


function getQCEMP_1(v_factory){
	var ls_QC_EMP = Form.getValue(&quot;QC_EMP&quot;).substr(0,6);
	if (!&quot;&quot;.equals(ls_QC_EMP)){
      loadLibrary(&quot;com.gce.Common.Util&quot;);
	  var ls_memt = get_ls_memt(v_factory);
	  // 設定品保簽核人員
	  Form.setValue(&quot;QC_EMP1&quot;,ls_memt+ls_QC_EMP);
	}	
}	

function Assign_Table(v_factory,temp,table1){
	// 取得人事主辦 from BPM 參數檔
	var sql = &quot;select to_char(value1) value1,to_char(value2) value2 from A_PARAMETER_DATA where PARAMETER =&apos;TRN_PROCESS&apos;  and TRIM(KEY1)=&apos;&quot;+v_factory+&quot;&apos; and to_char(description)=&apos;&quot; + temp + &quot;&apos; order by value2&quot;;
	var vec = Client.SQLloadValue(sql);
	var table = Form.getComponent(table1);
	    table.clear();
	for( var i=0;i&lt;vec.size();i++) {
		var row = table.newRow()-1; // 在table中新增一筆空白記錄
		table.setValueAt(vec.get(i).get(&quot;VALUE2&quot;).trim(),row,&quot;EMPNO&quot;);
		table.setValueAt(vec.get(i).get(&quot;VALUE1&quot;).trim(),row,&quot;CNAME&quot;);		  
	}	
}//function Assign_Table(v_factory,temp,tabe)

function get_App_User(){
     if(Form.getValue(&quot;App_ID&quot;) !=&quot;&quot;){
		   var sApp_ID = Form.getValue(&quot;App_ID&quot;);
	       var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);		   
		   loadLibrary(&quot;com.gce.Common.Util&quot;);
	       var ls_memt = get_ls_memt(v_factory);		   
		   var member = Client.getMemberByID(ls_memt+sApp_ID) ;
		   var member_no= ls_memt + sApp_ID;	
		Form.setValue(&quot;App_MemID&quot;, member_no);		
		if(member!=null){   				//當按ENTER時，離職不員不能申請,resign&lt;&gt;true,表示在職
			var SQL_things = &quot;select * from mem_geninf where MEMID=&apos;&quot; + member_no + &quot;&apos; and upper(RESIGN) &lt;&gt; &apos;TRUE&apos;&quot;;
			var rs_things = Client.SQLloadValue(SQL_things);
			if(rs_things.size()&gt;0){
				Form.setValue(&quot;App_Name&quot;,member.getName());
				Form.setValue(&quot;App_Title&quot;,member.getJobTitle());
				var roleID = member.getMainRoleID();
				var memDR = member.getMemberDR(roleID);
				var sDepName = memDR.getDepartmentName();					
				Form.setValue(&quot;App_Dep&quot;,sDepName);
				var sDepID = Client.getDepartment(memDR.getDepartmentID()).getMyID();	
				Form.setValue(&quot;App_Dep_ID&quot;,sDepID);	
				Form.setValue(&quot;Manager_ID&quot;,member.getPager()); // 直屬主管
				Form.setValue(&quot;JobLevel&quot;,member.getJobLevel()) ;				
				Form.setValue(&quot;App_Tel&quot;,member.getOfficePhone()); // 分機	
				var flag=&quot;true&quot;;
			}else{
				Form.setValue(&quot;App_Name&quot;,&quot;&quot;);
				Form.setValue(&quot;App_Title&quot;,&quot;&quot;);
				Form.setValue(&quot;App_Tel&quot;,&quot;&quot;);				  
				Form.setValue(&quot;App_Dep&quot;,&quot;&quot;);
				Form.setValue(&quot;App_Dep_ID&quot;,&quot;&quot;);
				var flag=&quot;false&quot;;
			}			
		}else{
			Form.setValue(&quot;App_Name&quot;,&quot;&quot;);
			Form.setValue(&quot;App_Title&quot;,&quot;&quot;);
			Form.setValue(&quot;App_Tel&quot;,&quot;&quot;);						
			Form.setValue(&quot;App_Dep&quot;,&quot;&quot;);
			Form.setValue(&quot;App_Dep_ID&quot;,&quot;&quot;);
			var flag=&quot;null&quot;;				
		}		
	}else{
		Form.setValue(&quot;App_Name&quot;,&quot;&quot;);
		Form.setValue(&quot;App_Title&quot;,&quot;&quot;);
		Form.setValue(&quot;App_Tel&quot;,&quot;&quot;);				
		Form.setValue(&quot;App_Dep&quot;,&quot;&quot;);
		Form.setValue(&quot;App_Dep_ID&quot;,&quot;&quot;);
		var flag=&quot;false&quot;;		
	}
   return flag;
}	
// 這個function 有效能issue
function check_rule(value,type,WORK_LIST,ll_rowcount,v_factory){
	try{	
		
		//抓取BPM 短期資料庫連線
		loadLibrary(&quot;com.gce.Common.Util&quot;);
		var conn_name = conn_db(v_factory,&quot;MES&quot;);	
		var conn = Client.createSessionConnection(conn_name);		 
		var msg=&quot;&quot;;
		var ls_QC_EMP = Form.getValue(&quot;QC_EMP&quot;).trim();
		var ls_verify = Form.getValue(&quot;verifyID&quot;).trim();
		for( var i=0;i&lt;ll_rowcount;i++){
			var ls_class_name = WORK_LIST.getValueAt(i,&quot;課程名稱&quot;);	
			var ls_class_no = WORK_LIST.getValueAt(i,&quot;課程編碼&quot;);
			var ls_term = WORK_LIST.getValueAt(i,&quot;條件&quot;);
			var ls_experience = WORK_LIST.getValueAt(i,&quot;經歷&quot;);
			var ls_mode_written = WORK_LIST.getValueAt(i,&quot;筆試&quot;);
			var ls_mode_oral = WORK_LIST.getValueAt(i,&quot;口試&quot;);		
			var ls_mode_operate = WORK_LIST.getValueAt(i,&quot;實作&quot;);
			var ls_examin_right = WORK_LIST.getValueAt(i,&quot;審查權責&quot;);
			var ls_item = WORK_LIST.getValueAt(i,&quot;審查項目&quot;);						  
			var ls_void_flag = WORK_LIST.getValueAt(i,&quot;作廢&quot;);
			var ls_mode_other = WORK_LIST.getValueAt(i,&quot;其他&quot;);
			var ls_remark = WORK_LIST.getValueAt(i,&quot;備註&quot;);
			
			if (&quot;審查規定申請&quot;.equals(process_name)){
				if (&quot;true&quot;.equals(ls_void_flag)){
					if (&quot;&quot;.equals(ls_remark)){
						msg += ls_class_name +&quot;【備註】不可為空值!新增/修改規定項目，請填寫異動原因!\n&quot;;				   
					}
				}else{
					if ( &quot;&quot;.equals(ls_item)){
						msg += ls_class_name +&quot;【審查項目】不可為空值!!\n&quot;;
					}	  
					if ( &quot;&quot;.equals(ls_term)){
						msg += ls_class_name +&quot;【條件】不可為空值!!\n&quot;;
					}	
					if ( &quot;&quot;.equals(ls_experience)){
						msg += ls_class_name +&quot;【經歷】不可為空值!!\n&quot;;
					}	
//					if ( &quot;&quot;.equals(ls_mode_written) ){
//						msg += ls_class_name +&quot;【筆試】不得為空值!!\n&quot;;
//					}else{
						
						if ( !&quot;&quot;.equals(ls_mode_written) &amp;&amp; !&quot;0&quot;.equals(ls_mode_written)){			// 檢查審核成績								   
							ls_return = chkValue(ls_mode_written.toString(),&apos;H&apos;);
							
							if ( ls_return != &quot;&quot; ){						  
								msg += ls_class_name +ls_return+&quot;!!\n&quot;;						   
							}
						}
//					}		  
					if ( &quot;&quot;.equals(ls_examin_right)){
						msg += ls_class_name +&quot;【審查權責】不可為空值!!\n&quot;;
					}					  
					if ( &quot;&quot;.equals(ls_class_no) &amp;&amp; &quot;&quot;.equals(ls_remark)){		//課程編碼為空值,代表為新課程,必需填寫備註
						msg +=  ls_class_name +&quot;【備註】不可為空值!新增/修改規定項目，請填寫異動原因!\n&quot;;
					}				    
				}
				
				if (&quot;SGCE&quot;.equals(v_factory)){									//規定別若為特定工作或驗證人員,會簽相關人員需維護				
					if (!&quot;C&quot;.equals(ls_verify) &amp;&amp;　&quot;&quot;.equals(ls_QC_EMP)){
						msg += ls_class_name +&quot;【會簽相關單位人員】不可為空值!特定工作及驗證人員需送簽第三方!\n&quot;;
													
						getQCEMP(v_factory);									// 取得品保單位人員 from mem_geninf
					} 
				}else if (&quot;CGCE&quot;.equals(v_factory)||&quot;HGCE&quot;.equals(v_factory)){	//CGCE 三種規定都要會簽相關人員需維護			
					if (&quot;&quot;.equals(ls_QC_EMP)){
						msg +=  ls_class_name +&quot;【會簽相關單位人員】不可為空值!特定工作及驗證人員需送簽第三方!\n&quot;;	
						getQCEMP(v_factory);									// 取得品保單位人員 from mem_geninf
					}

				}
			}else if (&quot;人事確認&quot;.equals(process_name)){
				var ls_dptno = Form.getValue(&quot;dptno&quot;).substr(1,2); 
				if ( &quot;&quot;.equals(ls_class_no)){						  	 					   	
					try{
						var ls_sql = &quot; select class_type_no,trn_type_no,class_seq from trnm002 where class_type_no=&apos;D&apos; and trn_type_no like &apos;%&quot;+ls_dptno+&quot;%&apos; and class_name = &apos;&quot;+ls_classname+&quot;&apos;;&quot;;					
						var vec = conn.loadValue(ls_sql);						   					   
						if ( vec.size()&gt;0){
							var ls_class_type_no = vec.get(0).get(&quot;class_type_no&quot;).trim();
							var ls_trn_type_no = vec.get(0).get(&quot;trn_type_no&quot;).trim();
							var ls_class_seq = vec.get(0).get(&quot;class_seq&quot;).trim();
							var ls_class_no = ls_class_type_no+ls_trn_type_no+ls_class_seq;
							WORK_LIST.setValueAt(ls_class_no,i,&quot;課程編碼&quot;);												
						}else{									
							Form.setComplete(false);				
							msg += ls_classname+&quot; 未建立【課程編碼】請至TRND020建立資料!!\n&quot;;						
						}						   						   
					}catch(e){
					}
				}			
			}else if (&quot;總經理審核&quot;.equals(process_name)){
				/*將資料寫回教育訓練table trnm080*/									
				var ls_empno=Form.getValue(&quot;Creator_ID&quot;).substr(5);	  // 申請人工號
				var ls_dptno=Form.getValue(&quot;dptno&quot;).substr(0,3);   // 申請部門
				var ls_year =Form.getValue(&quot;YEAR&quot;);       // 申請年度
				var ls_sn = Form.getValue(&quot;Sn&quot;);         // 表單編號
				var ls_oral =&quot;&quot;;
				var ls_operate =&quot;&quot;;
				var ls_other =&quot;&quot;;
				var ll_written = 0;
				var ls_flag = &quot;&quot;;	
				if (&quot;true&quot;.equals(ls_mode_oral)){
					ls_oral=&apos;1&apos;;
				}else{
					ls_oral=&apos;0&apos;;
				}
				if (&quot;true&quot;.equals(ls_mode_operate)){
					ls_operate=&apos;1&apos;;
				}else{
					ls_operate=&apos;0&apos;;
				}
				if (&quot;true&quot;.equals(ls_mode_other)){
					ls_other=&apos;1&apos;;
				}else{
					ls_other=&apos;0&apos;;
				}
				if (&quot;&quot;.equals(ls_mode_written)){
					ll_written = 0;						  
				}else{
					ll_written = ls_mode_written;
				}			  
				if (&quot;true&quot;.equals(ls_void_flag)){
					ls_flag=&apos;1&apos;;
				}else{
					ls_flag=&apos;0&apos;;
				}
				if(&quot;基本訓練&quot;.equals(ls_class_name)){
					ls_verify = &quot;C&quot;;
				}else{
					var ls_verify = Form.getValue(&quot;verify&quot;); // 規定別
					if (&quot;特定工作&quot;.equals(ls_verify)){
						ls_verify = &quot;A&quot;;
					}else if (&quot;驗證人員&quot;.equals(ls_verify)){
						ls_verify = &quot;B&quot;;
					}
				}
				/*為避免欄位異動未更新,所以先將資料刪除後再新增*/
				try{
					var delsql = &quot;Delete from trnm080 where dptno = &apos;&quot;+ls_dptno+&quot;&apos; and class_no = &apos;&quot;+ls_class_no+&quot;&apos;;&quot;;
					Client.addDebugLog(upsql);
					var result = conn.updateValue(delsql);
					if( true==result){
						conn.commit();
						var upsql = &quot;Insert Into trnm080(verify,dptno,item,term,experience,class_name,mode_oral,mode_written,mode_operate,mode_other,examin_right,remark,upd_user,upd_dtime,void_flag,af,class_no) Values (&quot;;
						upsql += &quot;&apos;&quot;+ls_verify+&quot;&apos;,&apos;&quot;+ls_dptno+&quot;&apos;,&apos;&quot;+ls_item+&quot;&apos;,&apos;&quot;+ls_term+&quot;&apos;,&apos;&quot;+ls_experience+&quot;&apos;,&apos;&quot;+ls_class_name+&quot;&apos;,&apos;&quot;+ls_oral+&quot;&apos;,&apos;&quot;+ll_written+&quot;&apos;,&apos;&quot;+ls_operate+&quot;&apos;,&apos;&quot;+ls_other+&quot;&apos;,&apos;&quot;+ls_examin_right+&quot;&apos;,&apos;&quot;+ls_remark+&quot;&apos;,&apos;&quot;+ls_empno+&quot;&apos;,current,&apos;&quot;+ls_flag+&quot;&apos;,&apos;&quot;+ls_sn+&quot;&apos;,&apos;&quot;+ls_class_no+&quot;&apos;);&quot;;
						Client.addDebugLog(upsql);
						var resultA = conn.updateValue(upsql);
						if( true==resultA){
							conn.commit();				 				
						}else{
							conn.rollback();
							Form.setComplete(false);				
							Form.showMessageDialog(&quot;新增至教育訓練系統(trnm040)失敗!\n&quot;+upsql);
						}					 				
					}else{
						conn.rollback();
						Form.setComplete(false);				
						Form.showMessageDialog(&quot;教育訓練系統刪除(trnm040)資料失敗!\n&quot;+upsql);
					}	
				}catch(e){			 
				}
				if (&quot;true&quot;.equals(ls_void_flag)){
				// 將作廢欄位寫回trnm002編碼檔
					try{
						var ls_upd = &quot;update trnm002 set void_flag=&apos;Y&apos; ,upd_user=&apos;&quot;+ls_empno+&quot;&apos;,upd_dtime =current where trim(class_type_no)||trim(trn_type_no)||trim(class_seq)=&apos;&quot;+ls_class_no+&quot;&apos;;&quot;
						Client.addDebugLog(ls_upd);
						var resulta = conn.updateValue(ls_upd);
						if( true==resulta){
							conn.commit();				 				
						}else{
							conn.rollback();
							Form.setComplete(false);				
							Form.showMessageDialog(&quot;新增至教育訓練系統(trnm002)失敗!\n&quot;+ls_upd);
						}
					}catch(e){}
				}
			}
		}// -------------------------------------------------END for		
	 }catch(e){	
		 Form.setComplete(false);	
		 Form.showMessageDialog(&quot;教育訓練系統錯誤!\n&quot;+process_name+msg);
	 }finally{
	   conn.close();
	}	
	return msg;
}//function check_rule(value,type,WORK_LIST,ll_rowcount)	

function chkValue(value,type){

	var ll_length = value.length(); 		
	var ls_char=&quot;&quot;;
	for ( var i=0;i&lt;ll_length;i++){
		var lb_flag = &quot;false&quot;;
		for ( var j=0;j&lt;10;j++){
			var ls_str = value.trim().substr(i,1);	
			if ( ls_str == j.toString() || ls_str == &quot;.&quot;){				
				lb_flag = &quot;true&quot;;								
			}
		}
		if (&quot;false&quot;.equals(lb_flag)){
			ls_char = ls_char + ls_str;	
		}
	}
	if (ls_char==&quot;&quot;){
		ll_writen = java.lang.Integer.parseInt(value);
		if ( ll_writen&lt;=0 || ll_writen&gt;100){
			return &quot;【&quot;+value+&quot;】只能介在1~100之間!&quot;;
		}else{
			return &quot;&quot;;
		}
	}else{
		return &quot;【&quot;+value+&quot;】不可輸入文字!&quot;;					   			
	}
	
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00261177170806203</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2015/02/23 11:32:54</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.Config.Client.Common.Server.VerifyNote</string> 
     </void> 
     <void property="id"> 
      <string>SCL00261177170806203</string> 
     </void> 
     <void property="name"> 
      <string>VerifyNote</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021156610951562</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//com.A.Common.Server.VerifyNote
function setVerifyName(){
		//設定主管簽核姓名
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		dataMap.put(&quot;Verify_ID&quot;,Server.getMember(MyTask.getRealExecutor()).getMyID() );		
		dataMap.put(&quot;Verify_Name&quot;,Server.getMember(MyTask.getRealExecutor()).getName() );
		dataMap.put(&quot;Agree&quot;,&quot;true&quot;);
}


function setTaskRole(){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		if(&quot;&quot; != dataMap.get(&quot;Next_Member_Role&quot;)){
			MyTask.setRoleID(dataMap.get(&quot;Next_Member_Role&quot;)); //設定Task 所屬的職務 
		}
}

// add by wangwei@2009/03/09
// 目的: 將現在時間放入表單上的欄位@col_name 
function setDateTime(col_name){
		var artIns = MyTask.getArtInstance();
		var dataMap = artIns.getAppDataMap();
		var Ob_date = new Packages.pase.agenda.MyDate();
		var ls_date = Ob_date.getCurrentDate(&quot;Y/M/D H:m&quot;); 
		dataMap.put(col_name,ls_date);	
	}
</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00261280397889824</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2014/07/25 08:55:35</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.TRN_SJ_Tran_Record</string> 
     </void> 
     <void property="id"> 
      <string>SCL00261280397889824</string> 
     </void> 
     <void property="name"> 
      <string>TRN_SJ_Tran_Record</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//考慮到人員的memID放到dptnoID //考慮同名情形
function getChief(){
	var ls_dptno = Form.getValue(&quot;dptno&quot;);
	if (&quot;&quot;.equals(ls_dptno)) {	
		Form.setValue(&quot;dptnoID&quot;, &quot;&quot;);
		Form.showMessageDialog(&quot;請先選擇部門&quot;);	
	}
	// 當選取部門不同時則將驗證別,訓練日期,課程名稱清空
	if (ls_dptno != Form.getValue(&quot;dptnoID&quot;)){
		Form.setValue(&quot;verify&quot;,&quot;&quot;)
		Form.setValue(&quot;trn_date&quot;,&quot;&quot;)
		Form.setValue(&quot;class_name&quot;,&quot;&quot;)
		Form.setValue(&quot;trn_date_c&quot;,&quot;&quot;)	   
	}
	Form.setValue(&quot;dptnoID&quot;,ls_dptno);	
	// ---(S) 取得所選取的單位主管 -by Heather 20081021
	var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);
	if (&quot;TGCE&quot;.equals(v_factory)) {
		var ls_memt = &quot;MEMT1&quot;
	}else if (&quot;SGCE&quot;.equals(v_factory)){
		var ls_memt = &quot;MEMS1&quot;
	}else if (&quot;CGCE&quot;.equals(v_factory)){
		var ls_memt = &quot;MEMC1&quot;
	}else if (&quot;HGCE&quot;.equals(v_factory)){
		var ls_memt = &quot;MEMH1&quot;
	}	
	//抓取BPM 短期資料庫連線
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
	var conn = Client.createSessionConnection(conn_name);	
	try{
		var vSQL=&quot;select chief as empno from empm030 where ( flag= &apos;N&apos; or flag is null) and  trim(dptno)||&apos;-&apos;||trim(dptcname) = &apos;&quot; + ls_dptno + &quot;&apos;&quot;;
		var prjList = conn.loadValue(vSQL);
		Form.setValue(&quot;sql&quot;,vSQL);
		if (prjList.size() &gt; 0) {	
			for(var i=0;i&lt;prjList.size();i++){
				var ls_empm020 = prjList.get(i);
				Form.setValue(&quot;Manager_ID&quot;,ls_memt+ls_empm020.get(&quot;empno&quot;)); //設定指定主管
			}
			Form.setValue(&quot;Assign_Manager&quot;,&quot;true&quot;);		
		}
	}catch(e){	
	}finally{
		conn.close();
	}		
}

function getQCEMP(v_factory){	
	if (&quot;(SGCE)&quot;.equals(v_factory)){
		//jolin 要求  update by irene_chang@20100831
		//		var ls_filter = &quot;(&apos;6G0&apos;,&apos;6G2&apos;,&apos;6G4&apos;,&apos;6G7&apos;,&apos;6G3&apos;,&apos;7G3&apos;,&apos;6G6&apos;)&quot;;
		var ls_filter = &quot;(&apos;&apos;)&quot;;
		//		var ls_filter1 = &quot;(&apos;MEMS1000399&apos;,&apos;MEMS1017788&apos;,&apos;MEMS1020872&apos;,&apos;MEMS1019885&apos;,&apos;MEMS1021415&apos;,&apos;MEMS1019752&apos;,&apos;MEMS1020367&apos;,&apos;MEMS1021294&apos;,&apos;MEMS1020869&apos;,&apos;MEMS1019304&apos;,&apos;MEMS1014588&apos;,&apos;MEMS1018209&apos;,&apos;MEMS1022123&apos;,&apos;MEMS1016328&apos;,&apos;MEMS1019303&apos;)&quot;;
		//jolin 要求  update by irene_chang@20100831
		var ls_filter1 = &quot;(&apos;MEMS1015655&apos;)&quot;;		
	}else if (&quot;(CGCE)&quot;.equals(v_factory)){
		// CGCE取以下部門所有人員,不需分主管職
		var ls_filter = &quot;(&apos;8G0&apos;,&apos;8G2&apos;,&apos;8G3&apos;,&apos;8G4&apos;,&apos;8Q0&apos;)&quot;;
		var ls_filter1 = &quot;(&apos;MEMC1018544&apos;,&apos;MEMC1018946&apos;)&quot;; //add by edison@20121128 陳少琴提出
	}else if (&quot;(HGCE)&quot;.equals(v_factory)){
		// HGCE取以下部門所有人員,不需分主管職
		var ls_filter = &quot;(&apos;&apos;)&quot;;
		var ls_filter1 = &quot;(&apos;MEMH1000020&apos;,&apos;MEMH1000201&apos;)&quot;;
	}
	// 取得品保單位人員 from mem_geninf
	try{
		var sql = &quot;select TRIM(ID)||&apos;:&apos;||TRIM(USERNAME) as empno,WORKPLACE,ID from mem_geninf where SUBSTR(WORKPLACE,5,3) IN &quot;+ls_filter+&quot; AND SUBSTR(JOBLEVEL,1,1)=&apos;M&apos; &quot;
		sql = sql + &quot; AND DENIEDLOGIN = &apos;false&apos; and RESIGN=&apos;false&apos; &quot; ;
		sql = sql + &quot; UNION select TRIM(ID)||&apos;:&apos;||TRIM(USERNAME) as empno,WORKPLACE,ID from mem_geninf where MEMID IN &quot;+ls_filter1+&quot;  &quot;
		sql = sql + &quot; AND DENIEDLOGIN = &apos;false&apos; and RESIGN=&apos;false&apos; ORDER BY WORKPLACE,ID &quot; ;
		var prjList = Client.SQLloadValue(sql);
		Client.addDebugLog(&quot;取得品保單位人員sql=&quot;+sql);
		var QC_EMP = Form.getComponent(&quot;QC_EMP&quot;);
		QC_EMP.removeAllItems();
		if (prjList.size() &gt; 0) {
			QC_EMP.addItem(&quot;  &quot;);
			for(var i=0;i&lt;prjList.size();i++){				
				QC_EMP.addItem(prjList.get(i).get(&quot;empno&quot;));
			}
		}
	}catch(e){
	}
}

function InsertMES(){
	var msg=&quot;&quot;;
	/*將資料寫回教育訓練履歷卡table trnm010*/	
	var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);
	//抓取BPM 短期資料庫連線
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
	var conn = Client.createSessionConnection(conn_name);
	try{														
		var ls_empno=Form.getValue(&quot;App_ID&quot;);	  // 申請人工號
		var ls_dptno=Form.getValue(&quot;dptno_t&quot;).substr(0,3);   // 申請部門		原本為dptno  dptno = &apos;==請&apos; modi by wangwei@2012/04/11
		var ls_class_name = Form.getValue(&quot;class_name_n&quot;); //課程名稱
		var ls_sn = Form.getValue(&quot;Sn&quot;);         // 表單編號						
		var ls_verify = Form.getValue(&quot;verify_ID&quot;); //規定別
		if (&quot;A&quot;.equals(ls_verify)){
			ls_class_type = &apos;C&apos; //特定人員
		}else if (&quot;B&quot;.equals(ls_verify)){
			ls_class_type = &apos;D&apos; //驗證人員
		}else if (&quot;C&quot;.equals(ls_verify)){
			ls_class_type = &apos;B&apos; //基本訓練
		}
		var ls_operate =&quot;&quot;;
		var ls_flag = &quot;&quot;;	
		var CLASS_LIST = Form.getComponent(&quot;trnm090_Table&quot;);
		var ll_rowcount = CLASS_LIST.getRowCount();
		for ( var i=0;i&lt;ll_rowcount;i++ ){	
			
			var ls_class_empno = CLASS_LIST.getValueAt(i,&quot;工號&quot;);
			if (&quot;TGCE&quot;.equals(v_factory)){
				var ls_MemberID=&quot;MEMT1&quot;+ls_class_empno;
			}else if (&quot;SGCE&quot;.equals(v_factory)){
				var ls_MemberID=&quot;MEMS1&quot;+ls_class_empno;
			}else if (&quot;CGCE&quot;.equals(v_factory)){
				var ls_MemberID=&quot;MEMC1&quot;+ls_class_empno;
			}else if (&quot;HGCE&quot;.equals(v_factory)){
				var ls_MemberID=&quot;MEMH1&quot;+ls_class_empno;
			}
			var cMember = Client.getMember(ls_MemberID); 
			var ls_Joblevel = cMember.getJobLevel(); //職等
			if ( ls_Joblevel.length()&gt;3){
				var ls_wkgreat = getWkgreat(ls_Joblevel);
			}else{
				var ls_wkgreat = ls_Joblevel;
			}
			// 訓練日期 將日期轉為 yyyy-mm-dd
			var ld_date = CLASS_LIST.getValueAt(i,&quot;日期起&quot;);
			var ld_date_end = CLASS_LIST.getValueAt(i,&quot;日期迄&quot;);
			var ls_trn_date = ld_date.substring(0,4)+&quot;-&quot;+ld_date.substring(5,7)+&apos;-&apos;+ ld_date.substring(8);			
			var ls_trn_date_end = ld_date_end.substring(0,4)+&quot;-&quot;+ld_date_end.substring(5,7)+&apos;-&apos;+ ld_date_end.substring(8);			
			var ls_trn_time_beg = CLASS_LIST.getValueAt(i,&quot;時間起&quot;).substring(0,5);	
			var ls_trn_time_end = CLASS_LIST.getValueAt(i,&quot;時間迄&quot;).substring(0,5);
			var ls_trn_time_b = CLASS_LIST.getValueAt(i,&quot;時間起&quot;)+&quot;:00&quot;;
			var ls_trn_time_e = CLASS_LIST.getValueAt(i,&quot;時間迄&quot;)+&quot;:00&quot;;
			var ll_timecnt = java.lang.Double.parseDouble(CLASS_LIST.getValueAt(i,&quot;總時數&quot;));
			var ls_teacher = CLASS_LIST.getValueAt(i,&quot;講師&quot;);
			var ls_teacher_id = CLASS_LIST.getValueAt(i,&quot;講師編碼&quot;);						  
			var ls_trn_where = CLASS_LIST.getValueAt(i,&quot;訓練地點&quot;);	
			var ls_written = CLASS_LIST.getValueAt(i,&quot;審查成績筆試&quot;);
			if (&quot;&quot;.equals(ls_written)){
				ls_written = &quot;null&quot;;
			}				 					 			  
			var ls_oral =  getValueA(CLASS_LIST.getValueAt(i,&quot;審查成績口試&quot;));	
			var ls_operate =  getValueA(CLASS_LIST.getValueAt(i,&quot;審查成績實作&quot;));
			var ls_class_no  =  CLASS_LIST.getValueAt(i,&quot;課程編碼&quot;);
			var delsql  =  &quot;delete from trnm090 where dptno = &apos;&quot;+ls_dptno+&quot;&apos;  and empno =&apos;&quot;+ls_class_empno+&quot;&apos; and class_no =&apos;&quot;+ls_class_no+&quot;&apos; and trn_date =&apos;&quot;+ls_trn_date+&quot;&apos; and trn_date_end =&apos;&quot;+ls_trn_date_end+&quot;&apos;;&quot;; 
			Client.addDebugLog(delsql);
			
			Form.setValue(&quot;trnm090_delete_sql&quot;,(Form.getValue(&quot;trnm090_delete_sql&quot;)+delsql+&quot;@@&quot;));
			var result = conn.updateValue(delsql);			
			if( true==result){
			   conn.commit();	 				
			}else{
			   conn.rollback();
			   Form.setComplete(false);				
			   Form.showMessageDialog(&quot;刪除教育訓練系統(trnm090)失敗!\n&quot;+delsql);
			}	
			var upsql = &quot;INSERT INTO trnm090 ( verify ,dptno,class_name,trn_date,trn_date_end,trn_time_beg,trn_time_end,timecnt,&quot;
			upsql = upsql + &quot; teacher,trn_where,empno,remark,trn_flag,verify_date,upd_user,upd_dtime,oral,operate,written,pass_flag,af,class_no,teacher_id) values (&quot;
			upsql = upsql + &quot;&apos;&quot;+ls_verify+&quot;&apos;,&apos;&quot;+ls_dptno+&quot;&apos;,&apos;&quot;+ls_class_name+&quot;&apos;,&apos;&quot;+ls_trn_date+&quot;&apos;,&apos;&quot;+ls_trn_date_end+&quot;&apos;,&apos;&quot;+ls_trn_time_beg+&quot;&apos;,&quot;
			upsql = upsql + &quot;&apos;&quot;+ls_trn_time_end+&quot;&apos;,&apos;&quot;+ll_timecnt+&quot;&apos;,&apos;&quot;+ls_teacher+&quot;&apos;,&apos;&quot;+ls_trn_where+&quot;&apos;,&apos;&quot;+ls_class_empno+&quot;&apos;,&apos;&apos;,&apos;Y&apos;,&quot;
			upsql = upsql + &quot;&apos;&quot;+ls_trn_date+&quot;&apos;,&apos;&quot;+ls_empno+&quot;&apos;,current,&apos;&quot;+ls_oral+&quot;&apos;,&apos;&quot;+ls_operate+&quot;&apos;,&quot;+ls_written+&quot;,&apos;Y&apos;,&apos;&quot;+ls_sn+&quot;&apos;,&quot;
			upsql = upsql + &quot;&apos;&quot;+ls_class_no+&quot;&apos;,&apos;&quot;+ls_teacher_id+&quot;&apos;);&quot;;
			
			Form.setValue(&quot;trnm090_insert_sql&quot;,(Form.getValue(&quot;trnm090_insert_sql&quot;)+upsql+&quot;@@&quot;));
			var result = conn.updateValue(upsql);
			if( true==result){
				conn.commit();				 				
			}else{
				conn.rollback();
				Form.setComplete(false);				
				msg +=&quot;新增至教育訓練系統(trnm090)失敗!\n&quot;+upsql;				   
			}
			var delsql  =  &quot;delete from trnm010 where dptno = &apos;&quot;+ls_dptno+&quot;&apos;  and empno =&apos;&quot;+ls_class_empno+&quot;&apos; and class_no =&apos;&quot;+ls_class_no+&quot;&apos; and trn_date_beg =&apos;&quot;+ls_trn_date+&quot;&apos; and trn_date_end =&apos;&quot;+ls_trn_date_end+&quot;&apos;;&quot;; 
			
			Form.setValue(&quot;trnm010_delete_sql&quot;,(Form.getValue(&quot;trnm010_delete_sql&quot;)+delsql+&quot;@@&quot;));
			var result = conn.updateValue(delsql);			
			if( true==result){
//				//				   conn.commit();	
			}else{
								   conn.rollback();
				Form.setComplete(false);				
				Form.showMessageDialog(&quot;刪除教育訓練系統(trnm010)失敗!\n&quot;+delsql);
			}
			var upsqla = &quot;Insert Into trnm010(empno,dptno,wkgreat,class_inout,class_type,trn_where,class_name,trn_date_beg,trn_date_end,trn_hours,teacher,upd_user,upd_dtime,trn_time_beg,trn_time_end,class_no,teacher_id ) Values (&quot;;
			upsqla = upsqla +&quot;&apos;&quot;+ls_class_empno+&quot;&apos;,&apos;&quot;+ls_dptno+&quot;&apos;,&apos;&quot;+ls_wkgreat+&quot;&apos;,&apos;I&apos;,&apos;&quot;+ls_class_type+&quot;&apos;,&apos;&quot;+ls_trn_where+&quot;&apos;,&apos;&quot;+ls_class_name+&quot;&apos;,&apos;&quot;+ls_trn_date+&quot;&apos;,&apos;&quot;+ls_trn_date_end+&quot;&apos;,&quot;+ll_timecnt+&quot;,&apos;&quot;+ls_teacher+&quot;&apos;,&apos;&quot;+ls_empno+&quot;&apos;,current,&apos;&quot;+ls_trn_time_b+&quot;&apos;,&apos;&quot;+ls_trn_time_e+&quot;&apos;,&apos;&quot;+ls_class_no+&quot;&apos;,&apos;&quot;+ls_teacher_id+&quot;&apos;);&quot;;
			
			Form.setValue(&quot;trnm010_insert_sql&quot;,(Form.getValue(&quot;trnm010_insert_sql&quot;)+upsqla+&quot;@@&quot;));
			var resulta = conn.updateValue(upsqla);
			
			if( true==resulta){
				conn.commit();	
				
			}else{
				
				conn.rollback();
				Form.setComplete(false);		
				msg +=&quot;新增至教育訓練系統(trnm010)失敗!\n&quot;+upsqla;
				
			}		
			
		}		
	}catch(e){	
		Form.showMessageDialog(&quot;6-InsertMES&quot;+msg+&quot; --&quot;+e);
	}finally{
		conn.close();
	}
	return msg;	
}

// 取得職等
function getWkgreat(value){
	var ls_return = value.substr(0,1);
	for ( var j=1;j&lt;3;j++){
		var ls_str = value.substr(j,1);
		for ( var k=0;k&lt;10;k++){
			if ( ls_str == k.toString()){
				ls_return = ls_return + ls_str;
			}
		}  
	}	  
	return ls_return;
}

function getValueA(achievement){
	if (achievement.indexOf(&quot;優&quot;)&gt;=0){
		return &quot;1&quot;
	}else if(achievement.indexOf(&quot;佳&quot;)&gt;=0){
		return &quot;2&quot;
	}else if(achievement.indexOf(&quot;可&quot;)&gt;=0){
		return &quot;3&quot;
	}else if(achievement.indexOf(&quot;差&quot;)&gt;=0){
		return &quot;4&quot;
	}else {
		return &quot;&quot;
	}
}	

function chk_teacher(){ 
	var ls_teacher = Form.getValue(&quot;TEACHER&quot;).trim();
	if ( &quot;&quot;.equals(ls_teacher)){
		Form.setValue(&quot;TEACHER&quot;,&quot;&quot;);	 
		return &quot;【講師】不可為空值,請確認!&quot;;	 
	}else{
		// 連結教育訓練講師檔,判斷維護的講師是否存在講師檔
		var ls_return = chkValue(ls_teacher);
		return ls_return;
	}
	function chkValue(value){　　　//---------------------------- function 中又有function ?????
		var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);			
		//抓取BPM 短期資料庫連線
		loadLibrary(&quot;com.gce.Common.Util&quot;);
		var conn_name = conn_db(v_factory,&quot;MES&quot;);	
		var conn = Client.createSessionConnection(conn_name);
		var ll_length = value.length(); 
		var ls_intFlag = &quot;true&quot;;
		for ( var i=0;i&lt;ll_length;i++){
			var ls_parm = value.substr(i,1)
			var cbxType = &quot;0123456789&quot;;
			var index = cbxType.indexOf(ls_parm.toString());
			if ( index == -1 ){
				ls_intFlag = &quot;false&quot;;
			}
		}
		if (&quot;true&quot;.equals(ls_intFlag)){
			var ls_empno = java.lang.Integer.parseInt(value);
			try{
				var selsql = conn.loadValue(&quot;select cname from trnm110 where teacher_type in (&apos;I&apos;,&apos;P&apos;) and empno=&apos;&quot;+value+&quot;&apos;;&quot;);	
				if (selsql.size() == 0 ) {				  					
					return &quot;【&quot;+value+&quot;】不存在講師記錄檔,請確認!&quot;;				  
				}else{
					Form.setValue(&quot;TEACHER&quot;,selsql.get(0).get(&quot;cname&quot;));	
					Form.setValue(&quot;teacher_id&quot;,value);
					return &quot;&quot;;
				}
			}catch(e){
			}
		}else{
			try{
				var selsql = conn.loadValue(&quot;select count(cname) as count from trnm110 where teacher_type in (&apos;I&apos;,&apos;P&apos;) and cname=&apos;&quot;+value+&quot;&apos;;&quot;);	
				if (selsql.size() &gt; 0){
					var ll_count = java.lang.Integer.parseInt(selsql.get(0).get(&quot;count&quot;));
					if ( ll_count&lt;1){						
						return &quot;【&quot;+value+&quot;】不存在講師記錄檔,請確認!&quot;;					   
					}else{
						var cMember = Client.getMember(value);
						var ls_teacher_id = cMember.getID().substr(5); 
						Form.setValue(&quot;teacher_id&quot;,ls_teacher_id);
						return &quot;&quot;;
					}
				}		
			}catch(e){}
		}
		if( conn != null){
			conn.close();
		}	
	}
}

// 設定欄位
function setCol(value){
	Form.getComponent(&quot;CLASS_NAME&quot;).setEnabled(value);
	Form.getComponent(&quot;TRN_TIME&quot;).setEnabled(value);
	Form.getComponent(&quot;trn_date&quot;).setEnabled(value);
	Form.getComponent(&quot;trn_date_end&quot;).setEnabled(value);	 
	Form.getComponent(&quot;TRN_HOUR_BEG&quot;).setEnabled(value);
	Form.getComponent(&quot;TRN_TIME_BEG&quot;).setEnabled(value);
	Form.getComponent(&quot;TRN_HOUR_END&quot;).setEnabled(value);
	Form.getComponent(&quot;TRN_TIME_END&quot;).setEnabled(value);
	Form.getComponent(&quot;TEACHER&quot;).setEnabled(value);
	Form.getComponent(&quot;TRN_WHERE&quot;).setEnabled(value);
}

// 依廠別設定欄位是否顯示
function setCol1(value){ 
	Form.getComponent(&quot;TRN_HOUR_BEG&quot;).setVisible(value);
	Form.getComponent(&quot;FLabel15&quot;).setVisible(value);
	Form.getComponent(&quot;TRN_TIME_BEG&quot;).setVisible(value);
	Form.getComponent(&quot;FLabel16&quot;).setVisible(value);
	Form.getComponent(&quot;TIME&quot;).setVisible(value);
	Form.getComponent(&quot;TRN_HOUR_END&quot;).setVisible(value);
	Form.getComponent(&quot;FLabel17&quot;).setVisible(value);
	Form.getComponent(&quot;TRN_TIME_END&quot;).setVisible(value);
	Form.getComponent(&quot;FLabel18&quot;).setVisible(value);
}

function chkValue(value){	
	var ll_length = value.length(); 
	var ls_intFlag = &quot;false&quot;;
	for ( var i=0;i&lt;ll_length;i++){
		for ( var j=0;j&lt;10;j++){
			var ls_str = value.trim().substr(i,1);				
			if ( ls_str == j.toString()){
				ls_intFlag = &quot;true&quot;;
			}
		}
	}
	if (&quot;true&quot;.equals(ls_intFlag)){
		ll_writen = java.lang.Integer.parseInt(value);
		var ll_mode_written = java.lang.Integer.parseInt(Form.getValue(&quot;MODE_WRITTEN&quot;));
		if ( ll_writen&lt;=0 || ll_writen&gt;100){
			return &quot;【&quot;+value+&quot;】只能介在1~100之間!&quot;
		}else if ( ll_writen &lt; ll_mode_written){
			return &quot;【&quot;+value+&quot;】成績不及格!&quot;
		}else{
			return &quot;&quot;;
		}
	}else{
		return &quot;【&quot;+value+&quot;】不可輸入文字!&quot;;					   			
	}			
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00271112272370906</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/03/31 20:32:50</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.ApproveData</string> 
     </void> 
     <void property="id"> 
      <string>SCL00271112272370906</string> 
     </void> 
     <void property="name"> 
      <string>ApproveData</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//這些都是 Server side 的程式, 一律在財務關卡的 postAction 執行
//loadLibrary(&quot;ScriptLibary.ExpenseFunction.ApproveData&quot;);
//將暫借款申請表單的資料設為 Approved
function approveData_Apply(){
	
	var runDate = new Packages.pase.agenda.MyDate();
	java.lang.System.out.println(&quot;Start [approveData_Apply] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));

	loadLibrary(&quot;ScriptLibary.SystemFunction.DateFunction&quot;);

	//取得相關的 Pkey 欄位值
	var artInstance = MyTask.getArtInstance();
	var currentMember = Server.getMember(MyTask.getRealExecutor());
java.lang.System.out.println(&quot;Finance Emp:&quot;+currentMember.getMyID() + currentMember.getName());
	var calTurnInDate = trimDate(artInstance.getAppValue(&quot;calTurnInDate&quot;));
	var issueNo = artInstance.getAppValue(&quot;txtIssueNo&quot;);
	var apNum = artInstance.getAppValue(&quot;txtApNum&quot;);
	
	//debug for 拋轉序號 Johann Hsu
	java.lang.System.out.println(&quot;apNum :&quot;+apNum);	
	
	if (java.lang.Integer.parseInt(apNum)&lt;=1 || isApNumTransfered(apNum,issueNo)){ //Modified by Johann Hsu 更新拋轉序號

		//更新 FFAATPI
		var updateFFAATPI = &quot;Update FFAATPI SET IARSPN = &apos;&quot;+currentMember.getMyID()+&quot;&apos;, IAGLDT = &apos;&quot;+calTurnInDate+&quot;&apos;, Approved = &apos;Y&apos; Where IASHNS = &apos;&quot;+issueNo+&quot;&apos; and IASHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAATPI);
		//更新 FFABTPI(不用考慮項次)
		var updateFFABTPI = &quot;Update FFABTPI SET Approved = &apos;Y&apos; Where IBSHNS = &apos;&quot;+issueNo+&quot;&apos; and IBSHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFABTPI);
		//更新 FFADTPI(不用考慮項次)
		var updateFFADTPI = &quot;Update FFADTPI SET Approved = &apos;Y&apos; Where IDSHNS = &apos;&quot;+issueNo+&quot;&apos; and IDSHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFADTPI);
	} else {
		oldApNum = java.lang.Integer.parseInt(apNum) - 1; 	
		java.lang.System.out.println(&quot;oldApNum :&quot;+oldApNum);
		
		//更新 FFAATPI
		var updateFFAATPI = &quot;Update FFAATPI SET IARSPN = &apos;&quot;+currentMember.getMyID()+&quot;&apos;, IAGLDT = &apos;&quot;+calTurnInDate+&quot;&apos;, IASHAP = &apos;&quot;+apNum+&quot;&apos;, Approved = &apos;Y&apos; Where IASHNS = &apos;&quot;+issueNo+&quot;&apos; and IASHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAATPI);
		//更新 FFABTPI(不用考慮項次)
		var updateFFABTPI = &quot;Update FFABTPI SET Approved = &apos;Y&apos;&quot;+&quot;, IBSHAP = &apos;&quot;+apNum+&quot;&apos; Where IBSHNS = &apos;&quot;+issueNo+&quot;&apos; and IBSHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFABTPI);
		//更新 FFADTPI(不用考慮項次)
		var updateFFADTPI = &quot;Update FFADTPI SET Approved = &apos;Y&apos;&quot;+&quot;, IDSHAP = &apos;&quot;+apNum+&quot;&apos; Where IDSHNS = &apos;&quot;+issueNo+&quot;&apos; and IDSHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFADTPI);
	
	}	
	
	//將拋轉次數加一
	var newApNum = java.lang.Integer.parseInt(apNum) + 1;
	artInstance.setAppValue(&quot;txtApNum&quot;, (new java.lang.Integer(newApNum)).toString());
	
	//debug for 拋轉序號 Johann Hsu
	java.lang.System.out.println(&quot;NewApNum :&quot;+artInstance.getAppValue(&quot;txtApNum&quot;));

	java.lang.System.out.println(&quot;Data Approved!!&quot;);
	
	java.lang.System.out.println(&quot;End [approveData_Apply] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));

}
//將暫借款收回表單的資料設為 Approved
function approveData_Return(){
	
	var runDate = new Packages.pase.agenda.MyDate();
	java.lang.System.out.println(&quot;Start [approveData_Return] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));

	loadLibrary(&quot;ScriptLibary.SystemFunction.DateFunction&quot;);

	//取得相關的 Pkey 欄位值
	var artInstance = MyTask.getArtInstance();
	var currentMember = Server.getMember(MyTask.getRealExecutor());
	var calTurnInDate = trimDate(artInstance.getAppValue(&quot;calTurnInDate&quot;));
	var orgIssueNo = artInstance.getAppValue(&quot;txtOrgIssueNo&quot;);
	var orgItemNo = artInstance.getAppValue(&quot;txtOrgIssueItem&quot;);
	var trno = artInstance.getAppValue(&quot;txtIssueNo&quot;);
	//更新 FFBATPI
	var updateFFBATPI = &quot;Update FFBATPI SET BAGLDT = &apos;&quot;+calTurnInDate+&quot;&apos;, Approved = &apos;Y&apos; Where BASHNS = &apos;&quot;+orgIssueNo+&quot;&apos; and BASHNN = &apos;&quot;+orgItemNo+&quot;&apos; and BATRNO = &apos;&quot;+trno+&quot;&apos;&quot;;
	Server.SQLupdateValue(updateFFBATPI);
	
java.lang.System.out.println(&quot;Data Approved!!&quot;);

	java.lang.System.out.println(&quot;End [approveData_Return] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));


}
//將暫借款沖銷表單的資料設為 Approved
function approveData_Reverse(){
	
	var runDate = new Packages.pase.agenda.MyDate();
	java.lang.System.out.println(&quot;Start [approveData_Reverse] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));
	
	loadLibrary(&quot;ScriptLibary.SystemFunction.DateFunction&quot;);

	//取得相關的 Pkey 欄位值
	var artInstance = MyTask.getArtInstance();
	var currentMember = Server.getMember(MyTask.getRealExecutor());
	var calTurnInDate = trimDate(artInstance.getAppValue(&quot;calTurnInDate&quot;));
	var dataMap = artInstance.getAppDataMap();
	
	var issueNo = artInstance.getAppValue(&quot;txtIssueNo&quot;);
	var itemNo = new java.lang.Integer(dataMap.get(&quot;tableReturnedRecord&quot;).size() + 1);
	var apNum = artInstance.getAppValue(&quot;txtApNum&quot;);
	
	//debug for 拋轉序號 Johann Hsu
	java.lang.System.out.println(&quot;apNum :&quot;+apNum);
	
	if (java.lang.Integer.parseInt(apNum)&lt;=1 || isApNumTransfered(apNum,issueNo)){ //Modified by Johann Hsu 更新拋轉序號
		
		//更新 FFAATPI
		var updateFFAATPI = &quot;Update FFAATPI SET IARSPN = &apos;&quot;+currentMember.getMyID()+&quot;&apos;, IAGLDT = &apos;&quot;+calTurnInDate+&quot;&apos;, Approved = &apos;Y&apos; Where IASHNS = &apos;&quot;+issueNo+&quot;&apos; and IASHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAATPI);
		//更新 FFABTPI(不用考慮項次)
		var updateFFABTPI = &quot;Update FFABTPI SET Approved = &apos;Y&apos; Where IBSHNS = &apos;&quot;+issueNo+&quot;&apos; and IBSHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFABTPI);
		//更新 FFAFTPI
		var updateFFAFTPI = &quot;Update FFAFTPI SET Approved = &apos;Y&apos; Where IFSHNS = &apos;&quot;+issueNo+&quot;&apos; and IFSHNN = &apos;&quot;+itemNo+&quot;&apos; and IFSHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAFTPI);
		//更新 FFAETPI
		var updateFFAETPI = &quot;Update FFAETPI SET Approved = &apos;Y&apos; Where IESHNS = &apos;&quot;+issueNo+&quot;&apos; and IESHNN = &apos;&quot;+itemNo+&quot;&apos; and IESHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAETPI);
		//更新 FFADTPI
		var updateFFADTPI = &quot;Update FFADTPI SET Approved = &apos;Y&apos; Where IDSHNS = &apos;&quot;+issueNo+&quot;&apos; and IDSHNN = &apos;&quot;+itemNo+&quot;&apos; and IDSHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFADTPI);
	} else {
		
		oldApNum = java.lang.Integer.parseInt(apNum) - 1; 	
		java.lang.System.out.println(&quot;oldApNum :&quot;+oldApNum);
		
		//更新 FFAATPI
		var updateFFAATPI = &quot;Update FFAATPI SET IARSPN = &apos;&quot;+currentMember.getMyID()+&quot;&apos;, IAGLDT = &apos;&quot;+calTurnInDate+&quot;&apos;, IASHAP = &apos;&quot;+apNum+&quot;&apos;, Approved = &apos;Y&apos; Where IASHNS = &apos;&quot;+issueNo+&quot;&apos; and IASHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAATPI);
		//更新 FFABTPI(不用考慮項次)
		var updateFFABTPI = &quot;Update FFABTPI SET Approved = &apos;Y&apos;&quot;+&quot;, IBSHAP = &apos;&quot;+apNum+&quot;&apos; Where IBSHNS = &apos;&quot;+issueNo+&quot;&apos; and IBSHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFABTPI);
		//更新 FFAFTPI
		var updateFFAFTPI = &quot;Update FFAFTPI SET Approved = &apos;Y&apos;&quot;+&quot;, IFSHAP = &apos;&quot;+apNum+&quot;&apos; Where IFSHNS = &apos;&quot;+issueNo+&quot;&apos; and IFSHNN = &apos;&quot;+itemNo+&quot;&apos; and IFSHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAFTPI);
		//更新 FFAETPI
		var updateFFAETPI = &quot;Update FFAETPI SET Approved = &apos;Y&apos;&quot;+&quot;, IESHAP = &apos;&quot;+apNum+&quot;&apos; Where IESHNS = &apos;&quot;+issueNo+&quot;&apos; and IESHNN = &apos;&quot;+itemNo+&quot;&apos; and IESHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAETPI);
		//更新 FFADTPI
		var updateFFADTPI = &quot;Update FFADTPI SET Approved = &apos;Y&apos;&quot;+&quot;, IDSHAP = &apos;&quot;+apNum+&quot;&apos; Where IDSHNS = &apos;&quot;+issueNo+&quot;&apos; and IDSHNN = &apos;&quot;+itemNo+&quot;&apos; and IDSHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFADTPI);		
	
	}	
	
	//將拋轉次數加一
	var newApNum = java.lang.Integer.parseInt(apNum) + 1;
	artInstance.setAppValue(&quot;txtApNum&quot;, (new java.lang.Integer(newApNum)).toString());
	
	//debug for 拋轉序號 Johann Hsu
	java.lang.System.out.println(&quot;NewApNum :&quot;+artInstance.getAppValue(&quot;txtApNum&quot;));
	
	java.lang.System.out.println(&quot;Data Approved!!&quot;);

	java.lang.System.out.println(&quot;End [approveData_Reverse] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));

}
//將部門費用表單的資料設為 Approved
function approveData_Dep(){
	
	var runDate = new Packages.pase.agenda.MyDate();
	java.lang.System.out.println(&quot;Start [approveData_Dep] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));

	loadLibrary(&quot;ScriptLibary.SystemFunction.DateFunction&quot;);
	
	//取得相關的 Pkey 欄位值
	var artInstance = MyTask.getArtInstance();
	var currentMember = Server.getMember(MyTask.getRealExecutor());
	var calTurnInDate = trimDate(artInstance.getAppValue(&quot;calTurnInDate&quot;));
	var dataMap = artInstance.getAppDataMap();
	
	var issueNo = artInstance.getAppValue(&quot;txtIssueNo&quot;);
	var apNum = artInstance.getAppValue(&quot;txtApNum&quot;);
	
	//debug for 拋轉序號 Johann Hsu
	java.lang.System.out.println(&quot;apNum :&quot;+apNum);
	
	if (java.lang.Integer.parseInt(apNum)&lt;=1 || isApNumTransfered(apNum,issueNo)){ //Modified by Johann Hsu 更新拋轉序號
	
		//更新 FFAATPI
		var updateFFAATPI = &quot;Update FFAATPI SET IARSPN = &apos;&quot;+currentMember.getMyID()+&quot;&apos;, IAGLDT = &apos;&quot;+calTurnInDate+&quot;&apos;, Approved = &apos;Y&apos; Where IASHNS = &apos;&quot;+issueNo+&quot;&apos; and IASHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAATPI);
		//更新 FFABTPI(不用考慮項次)
		var updateFFABTPI = &quot;Update FFABTPI SET Approved = &apos;Y&apos; Where IBSHNS = &apos;&quot;+issueNo+&quot;&apos; and IBSHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFABTPI);
		//更新 FFAETPI(不用考慮項次)
		var updateFFAETPI = &quot;Update FFAETPI SET Approved = &apos;Y&apos; Where IESHNS = &apos;&quot;+issueNo+&quot;&apos; and IESHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAETPI);
		//更新 FFADTPI(不用考慮項次)
		var updateFFADTPI = &quot;Update FFADTPI SET Approved = &apos;Y&apos; Where IDSHNS = &apos;&quot;+issueNo+&quot;&apos; and IDSHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFADTPI);
	} else {
	
		oldApNum = java.lang.Integer.parseInt(apNum) - 1; 	
		java.lang.System.out.println(&quot;oldApNum :&quot;+oldApNum);
		
		//更新 FFAATPI
		var updateFFAATPI = &quot;Update FFAATPI SET IARSPN = &apos;&quot;+currentMember.getMyID()+&quot;&apos;, IAGLDT = &apos;&quot;+calTurnInDate+&quot;&apos;, IASHAP = &apos;&quot;+apNum+&quot;&apos;, Approved = &apos;Y&apos; Where IASHNS = &apos;&quot;+issueNo+&quot;&apos; and IASHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAATPI);
		//更新 FFABTPI(不用考慮項次)
		var updateFFABTPI = &quot;Update FFABTPI SET Approved = &apos;Y&apos;&quot;+&quot;, IBSHAP = &apos;&quot;+apNum+&quot;&apos; Where IBSHNS = &apos;&quot;+issueNo+&quot;&apos; and IBSHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFABTPI);
		//更新 FFAETPI(不用考慮項次)
		var updateFFAETPI = &quot;Update FFAETPI SET Approved = &apos;Y&apos;&quot;+&quot;, IESHAP = &apos;&quot;+apNum+&quot;&apos; Where IESHNS = &apos;&quot;+issueNo+&quot;&apos; and IESHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAETPI);
		//更新 FFADTPI(不用考慮項次)
		var updateFFADTPI = &quot;Update FFADTPI SET Approved = &apos;Y&apos;&quot;+&quot;, IDSHAP = &apos;&quot;+apNum+&quot;&apos; Where IDSHNS = &apos;&quot;+issueNo+&quot;&apos; and IDSHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFADTPI);
	
	}	
	
	//將拋轉次數加一
	var newApNum = java.lang.Integer.parseInt(apNum) + 1;
	
	artInstance.setAppValue(&quot;txtApNum&quot;, (new java.lang.Integer(newApNum)).toString());
	
	//debug for 拋轉序號 Johann Hsu
	java.lang.System.out.println(&quot;NewApNum :&quot;+artInstance.getAppValue(&quot;txtApNum&quot;));
	
	java.lang.System.out.println(&quot;Data Approved!!&quot;);
	
	java.lang.System.out.println(&quot;End [approveData_Dep] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));

}
//將出差彙總表單的資料設為 Approved
function approveData_Trip(){
	
	var runDate = new Packages.pase.agenda.MyDate();
	java.lang.System.out.println(&quot;Start [approveData_Trip] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));

	loadLibrary(&quot;ScriptLibary.SystemFunction.DateFunction&quot;);
	
	//取得相關的 Pkey 欄位值
	var artInstance = MyTask.getArtInstance();
	var currentMember = Server.getMember(MyTask.getRealExecutor());
	var calTurnInDate = trimDate(artInstance.getAppValue(&quot;calTurnInDate&quot;));
	var dataMap = artInstance.getAppDataMap();
	
	//取得決裁單號
	var decisionNo =artInstance.getAppValue(&quot;txtDecisionNo&quot;);
	var apNum = artInstance.getAppValue(&quot;txtApNum&quot;);
	
	//debug for 拋轉序號 Johann Hsu
	java.lang.System.out.println(&quot;apNum :&quot;+apNum);
	
	if (java.lang.Integer.parseInt(apNum)&lt;=1 || isApNumTransfered(apNum,decisionNo)){ //Modified by Johann Hsu 更新拋轉序號
	
		//更新 FFAATPI
		var updateFFAATPI = &quot;Update FFAATPI SET Approved = &apos;Y&apos;, IAMSTS =&apos;A&apos;  Where IASHNS = &apos;&quot;+decisionNo+&quot;&apos; and IASHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAATPI);
		//更新 FFABTPI(不用考慮項次)
		var updateFFABTPI = &quot;Update FFABTPI SET Approved = &apos;Y&apos; Where IBSHNS = &apos;&quot;+decisionNo+&quot;&apos; and IBSHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFABTPI);
		//更新 FFAETPI(不用考慮項次)
		var updateFFAETPI = &quot;Update FFAETPI SET Approved = &apos;Y&apos; Where IESHNS = &apos;&quot;+decisionNo+&quot;&apos; and IESHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAETPI);
		//更新 FFADTPI(不用考慮項次)
		var updateFFADTPI = &quot;Update FFADTPI SET Approved = &apos;Y&apos; Where IDSHNS = &apos;&quot;+decisionNo+&quot;&apos; and IDSHAP = &apos;&quot;+apNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFADTPI);
	} else {
	
		oldApNum = java.lang.Integer.parseInt(apNum) - 1; 	
		java.lang.System.out.println(&quot;oldApNum :&quot;+oldApNum);
		
		//更新 FFAATPI
		var updateFFAATPI = &quot;Update FFAATPI SET  IASHAP = &apos;&quot;+apNum+&quot;&apos;, Approved = &apos;Y&apos; , IAMSTS =&apos;A&apos; Where IASHNS = &apos;&quot;+decisionNo+&quot;&apos; and IASHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAATPI);
		//更新 FFABTPI(不用考慮項次)
		var updateFFABTPI = &quot;Update FFABTPI SET Approved = &apos;Y&apos;&quot;+&quot;, IBSHAP = &apos;&quot;+apNum+&quot;&apos; Where IBSHNS = &apos;&quot;+decisionNo+&quot;&apos; and IBSHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFABTPI);
		//更新 FFAETPI(不用考慮項次)
		var updateFFAETPI = &quot;Update FFAETPI SET Approved = &apos;Y&apos;&quot;+&quot;, IESHAP = &apos;&quot;+apNum+&quot;&apos; Where IESHNS = &apos;&quot;+decisionNo+&quot;&apos; and IESHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFAETPI);
		//更新 FFADTPI(不用考慮項次)
		var updateFFADTPI = &quot;Update FFADTPI SET Approved = &apos;Y&apos;&quot;+&quot;, IDSHAP = &apos;&quot;+apNum+&quot;&apos; Where IDSHNS = &apos;&quot;+decisionNo+&quot;&apos; and IDSHAP = &apos;&quot;+oldApNum+&quot;&apos; &quot;;
		Server.SQLupdateValue(updateFFADTPI);
	
	}	
	
	//將拋轉次數加一
	var newApNum = java.lang.Integer.parseInt(apNum) + 1;
	
	artInstance.setAppValue(&quot;txtApNum&quot;, (new java.lang.Integer(newApNum)).toString());
	
	//debug for 拋轉序號 Johann Hsu
	java.lang.System.out.println(&quot;NewApNum :&quot;+artInstance.getAppValue(&quot;txtApNum&quot;));
	
	java.lang.System.out.println(&quot;Data Approved!!&quot;);
	
	java.lang.System.out.println(&quot;End [approveData_Trip] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));

}
//檢查是否已經更改拋轉序號 (利用憑證介面檔)
function isApNumTransfered(apNum,issueNo){
	
	var runDate = new Packages.pase.agenda.MyDate();
	java.lang.System.out.println(&quot;Start [isApNumTransfered] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));

	var sqlQuery = &quot;Select distinct IESHAP  From FFAETPI Where Approved = &apos;Y&apos; and IESHAP = &apos;&quot;+apNum+&quot;&apos; and IESHNS = &apos;&quot;+issueNo+&quot;&apos;&quot;;
	java.lang.System.out.println(sqlQuery.toString());
	result = Server.SQLloadValue(sqlQuery);

	java.lang.System.out.println(&quot;End [isApNumTransfered] &quot;+ runDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;));

	if (result.size()&gt;0) 
		return true;
	else
		return false;

}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>將介面檔資料設成核准狀態</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00271280738792367</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2014/11/28 11:38:19</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Client.EDI_MES</string> 
     </void> 
     <void property="id"> 
      <string>SCL00271280738792367</string> 
     </void> 
     <void property="name"> 
      <string>EDI_MES</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021229049977055</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//寫入 MECN IPQC 鎖帳
function MECN_IPQC_Lock(Table1,Table2){

	var MyTask = Form.getCurrentTask();  
 	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();
	var table1 = dataMap.get(Table1); 
    var table2 = dataMap.get(Table2); 
	var MECN_SP_List = &quot;&quot;; 
	
	if (table2.size()&gt;0){
	   for(var i=0;i&lt;table2.size();i++){
		 if(i == (table2.size()-1)) {
	         MECN_SP_List += &quot;(&quot; + table2.get(i).get(&quot;ITEM1&quot;)+ &quot;,&quot; + table2.get(i).get(&quot;ITEM2&quot;)+&quot;)&quot;;
		 }else{
			 MECN_SP_List += &quot;(&quot; + table2.get(i).get(&quot;ITEM1&quot;)+ &quot;,&quot; + table2.get(i).get(&quot;ITEM2&quot;)+&quot;),&quot;; 
		 }
	  }//for
	}//if (table2.size()&gt;0)
	
    if (table1.size()&gt;0){
		
        var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);
        //抓取BPM 短期資料庫連線
        loadLibrary(&quot;com.gce.Common.Util&quot;);
	    var conn_name = conn_db(v_factory,&quot;MES&quot;);	
    	var conn = Client.createSessionConnection(conn_name);
	    var User_ID =dataMap.get(&quot;Verify_ID&quot;);
	    var Sn =dataMap.get(&quot;Sn&quot;);	
        if(conn != null){		
        try{			
          for(var j=0;j&lt;table1.size();j++){	
              var item_no = table1.get(j).get(&quot;ITEM1&quot;); //變更後料號
              var gce_ver = table1.get(j).get(&quot;ITEM6&quot;); //變更後版序
              var lot_no = table1.get(j).get(&quot;ITEM2&quot;);  //批號
              var hold_work_no = table1.get(j).get(&quot;ITEM3&quot;).substring(0,table1.get(j).get(&quot;ITEM3&quot;).indexOf(&apos;-&apos;)) //站別
              var hold_work_cnt = table1.get(j).get(&quot;ITEM8&quot;) //次數				  
              var Sql = &quot;INSERT INTO wipm060(item_no,gce_ver,lot_no,hold_date,hold_user,del_flag,hold_reason,hold_work_no,hold_work_cnt)&quot;;
		          Sql +=&quot; VALUES ( &apos;&quot;+item_no + &quot;&apos;,&apos;&quot; + gce_ver + &quot;&apos;,&apos;&quot; + lot_no + &quot;&apos;,current,&apos;&quot;+ User_ID + &quot;&apos;,&apos;&apos;,&apos;MECN-&quot;+ Sn +MECN_SP_List+&quot;&apos;,&apos;&quot;+ hold_work_no + &quot;&apos;,&apos;&quot;+hold_work_cnt +&quot;&apos;);&quot;;		
			    Client.addDebugLog(&quot;===MECN-nok-test&quot;+ Sn  + Sql);				  

			      var vResult=conn.updateValue(Sql);
 	              if(vResult==true){
	                 conn.commit();
	              }else{
				    Client.addDebugLog(&quot;===MECN-nok&quot;+ Sn  + Sql);
	                conn.rollback();  
				    Form.showMessageDialog(&quot;Connection insert mis.wipm060 fail.&quot;);//確認有執行connection關閉動作
       	          } 
           }//for 
           }catch(e){
		        conn.rollback(); 
			    java.lang.System.out.println(&quot;expection in informixDB e=&quot;+e);
			    Client.addDebugLog(&quot;===MECN-nok-c&quot;+ Sn  + Sql);
			    Form.setComplete(false);				
			    Form.showMessageDialog(&quot;Connection insert mis.wipm060 exception !\n&quot;);
	          }finally {
			    Client.addDebugLog(&quot;===MECN-nok-f&quot;+ Sn  + Sql);
				conn.close(); // move here by wangwei@201/06/27
  	          }   	  		   
	    }else{
		      Form.showMessageDialog(&quot;Connection &quot;+ v_factory +&quot; MES DB fail !\n&quot;);				
	    }
      
   }//if (table.size()&gt;0)
}//function MECN_IPQC_Lock(Table1,Table2)

function getSubProtskid(){
	//目前為發料單v4
//var sql =&quot;SELECT tskid                                                           &quot;; 
//	sql +=&quot;  FROM task                                                           &quot;; 
//	sql +=&quot; WHERE rootid IN (                                                    &quot;; 
//	sql +=&quot;          SELECT cproottskid                                          &quot;; 
//	sql +=&quot;            FROM task_createpro                                       &quot;; 
//	sql +=&quot;           WHERE iscomplete = &apos;false&apos;                                 &quot;; 
//	sql +=&quot;             AND cproid = &apos;CP01821304651291974&apos;                       &quot;;//觸發子流程cp 
//	sql +=&quot;             AND tskid IN (                                           &quot;; 
//	sql +=&quot;                    SELECT tskid                                      &quot;; 
//	sql +=&quot;                      FROM task                                       &quot;; 
//	sql +=&quot;                     WHERE proid = &apos;PRO10121304651291942&apos;             &quot;;//觸發子流程的前一關 
//	sql +=&quot;                       AND state = &apos;complete&apos;                         &quot;; 
//	sql +=&quot;                       AND rootid IN (                                &quot;; 
//	sql +=&quot;                              SELECT rootid                           &quot;; 
//	sql +=&quot;                                FROM task                             &quot;; 
//	sql +=&quot;                               WHERE proid = &apos;PRO10061304651291895&apos;   &quot;; //主流程等待關卡
//	sql +=&quot;                                 AND state = &apos;complete&apos;)))            &quot;; 
//	sql +=&quot;   AND state &lt;&gt; &apos;complete&apos;                                            &quot;; 
//	sql +=&quot;   AND TYPE &lt;&gt; &apos;root&apos;                                                 &quot;; 


//這一段sql是ECN，子流程被刪除(人員離職刪除待辦)，主流程無法完成
var sql = &quot;select tskid from task where rootid in (select rootid from task where tskid in(SELECT tskid  FROM task_createpro WHERE     iscomplete = &apos;false&apos; AND cproid = &apos;CP01821304651291974&apos; and not exists (select &apos;x&apos; from task t where T.TSKID= cproottskid))) and proid=&apos;PRO10061304651291895&apos; and state=&apos;ready&apos;&quot;;
Form.setValue(&quot;TextArea1&quot;,sql);
var vec = Client.SQLloadValue(sql);
Client.setLocalObject(&quot;object1&quot;, vec); 
Form.showMessageDialog(&quot;共 &quot;+vec.size()+&quot; 筆&quot;);
}

function getMainProtskid(){
	
	var sql = &quot;SELECT a.tskid, a.keyword, b.tskid AS btskid, &apos;&apos; AS tskid_1, &apos;&apos; AS proid &quot;;
		sql +=&quot; FROM (SELECT rootid, tskid, keyword &quot;;
        sql +=&quot;   FROM task &quot;;
        sql +=&quot;  WHERE proid = &apos;PRO10061304651291895&apos; &quot;;//等待關卡
        sql +=&quot;    AND state = &apos;ready&apos; &quot;;
        sql +=&quot;    AND exeid = &apos;MEMPDM0001&apos;) a, &quot;;
        sql +=&quot; (SELECT rootid, tskid, keyword &quot;;
        sql +=&quot;   FROM task &quot;;
        sql +=&quot;  WHERE proid = &apos;PRO10121304651291942&apos; &quot;;//觸發子流程的前一關
        sql +=&quot;    AND state = &apos;complete&apos; &quot;;
        sql +=&quot;    AND exeid = &apos;MEMPDM0001&apos;) b, &quot;;
        sql +=&quot; (SELECT   rootid, MAX (tskid) AS ctskid &quot;;
        sql +=&quot;     FROM task &quot;;
        sql +=&quot;    WHERE proid = &apos;PRO10121304651291942&apos; &quot;;//觸發子流程的前一關
        sql +=&quot;      AND state = &apos;complete&apos; &quot;;
        sql +=&quot;      AND exeid = &apos;MEMPDM0001&apos; &quot;;
        sql +=&quot; GROUP BY rootid) c &quot;;
		sql +=&quot; WHERE a.rootid = b.rootid &quot;;
		sql +=&quot; AND a.rootid = c.rootid &quot;;
		sql +=&quot; AND b.tskid = c.ctskid &quot;;
		sql +=&quot; AND NOT EXISTS (SELECT &apos;x&apos; &quot;;
        sql +=&quot;              FROM task_createpro &quot;;
        sql +=&quot;             WHERE tskid = b.tskid AND iscomplete = &apos;false&apos;) &quot;;
	
	var vec = Client.SQLloadValue(sql);
	Form.setValue(&quot;TextArea1&quot;,sql);
	Client.setLocalObject(&quot;object1&quot;, vec); 
	Form.showMessageDialog(&quot;共 &quot;+vec.size()+&quot; 筆&quot;);
}

function completeTask(){

var vec = Client.getLocalObject(&quot;object1&quot;); 
if(vec!=null){
	var temp = &quot;&quot;;
	var k =0;
	if(vec!=null &amp;&amp; vec.size()&gt;0){	
		for(var i=0;i&lt;vec.size();i++){
			var r_task = Client.getTask(vec.get(i).get(&quot;tskid&quot;));
			var artIns = Client.getArtInstance(r_task.getInstanceID());
			artIns.setAppValue(&quot;Verify_Note&quot;,&quot;批次簽核&quot;);
			r_task.setArtInstance(artIns) ;
			Client.updateTask(r_task);

			var hashmap = Client.completeTask(r_task,&quot;AST19011304668152046&quot;);//子流程結束流程線
			var retValue = hashmap.get(&quot;retValue&quot;);
			if(retValue==false){
				temp += vec.get(i).get(&quot;tskid&quot;)+&quot;;&quot;
				k++;
			}
		}	
		Form.setValue(&quot;TextArea1&quot;,temp);
		Form.showMessageDialog(&quot;失敗共 =&quot;+k+&quot; 筆&quot;);
	}
}else{
	Form.showMessageDialog(&quot;請先查詢!!&quot;);
}
}

function autoCompleteTask(){
	var Ob_date = new Packages.pase.agenda.MyDate();
	var vToday = Ob_date.getCurrentDate() ;
	var vBeg = 	Ob_date.add(vToday ,-10) 
	var vDiffDays= Ob_date.getSubtractDay(&quot;1970/01/01&quot;, vBeg); //num = 19
	var vLong = vDiffDays * 86400000 ;
	var memid = &quot;MEMS1039544&quot;;  //批次簽核人員
	var proid = &quot;PRO08991309332061795&quot;;  //批次簽核關卡
	var astid = &quot;AST19011304668152046&quot;;  //批次簽核送出的流程線
	var sql = &quot;select tskid from task where memid=&apos;&quot;+memid+&quot;&apos; and proid=&apos;&quot;+proid+&quot;&apos; and state&lt;&gt;&apos;complete&apos; and starttime&lt;&quot;+vLong;
//	    sql +=&quot; and tskid=&apos;Tsk000041191980&apos;&quot;;
	var vec = Client.SQLloadValue(sql);
	Form.setValue(&quot;TextArea1&quot;,sql);
	Client.setLocalObject(&quot;object1&quot;, vec); 
	Form.showMessageDialog(&quot;共 &quot;+vec.size()+&quot; 筆&quot;);
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00281177601933625</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2007/04/26 23:38:53</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.PR.SendMail</string> 
     </void> 
     <void property="id"> 
      <string>SCL00281177601933625</string> 
     </void> 
     <void property="name"> 
      <string>SendMail</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00081177250221609</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//===============================================================================
// sendMail
// type : 1.工作通知、2.結案通知、3.駁回通知、4.更新失敗通知
//===============================================================================
function sendMail(type){
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
		var to = Server.getMember(MyTask.getRealExecutor()).getEmail(); 
        var cc = &quot;&quot;; 
		var subject = &quot;主旨 : &lt;&quot; + dataMap.get(&quot;Af_Speed&quot;) + &quot;&gt;&quot; + dataMap.get(&quot;Pmk01&quot;) + &quot;_AF電子表單[&quot; + aInstance.getName() + &quot;]&quot; + type ; // Mail Subject 
		if(&quot;工作通知&quot;.equals(type)){
			var text = getMailContent1(dataMap);
		}else if(&quot;結案通知&quot;.equals(type)) {
			to = getProcessMailAddressList(&quot;請購單通知名單&quot;) + Server.getMember(dataMap.get(&quot;Creator_ID&quot;)).getEmail(); 
			var text = getMailContent2(dataMap);		
		}else if(&quot;駁回通知&quot;.equals(type)) {
			to = getProcessMailAddressList(&quot;沒有&quot;);
			var text = getMailContent3(dataMap);
		}else if(&quot;更新失敗通知&quot;.equals(type)) {
			to = Server.getMember(&quot;administrator&quot;).getEmail();
			var text = getMailContent4(dataMap);
		}
        var fileList = new Packages.java.util.Vector(); 
        Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
}

//-------------------
// 1.工作通知
//-------------------
function getMailContent1(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   這裡是Agentflow管理員，通知有工作已經送到您手上，請儘速登入網站處理。&lt;br&gt;&quot;;			
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  		+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pmk01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   版本 : &quot; + dataMap.get(&quot;Pmk03&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   請購日期 : &quot; + dataMap.get(&quot;Pmk04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據性質 : &quot; + dataMap.get(&quot;Pmk02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmk09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : (&quot; + dataMap.get(&quot;Pmk20&quot;)+ &quot;)&quot; + dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pmk22&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   請購員 : &quot;  + dataMap.get(&quot;Pmk_User_Name&quot;)+&quot;(&quot;+ dataMap.get(&quot;Pmk12&quot;) +&quot;)&quot; 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		text += &quot;   備註 : &quot; + dataMap.get(&quot;Remark&quot;)	+&quot;&lt;br&gt;&quot;;		
		try{
		//var rootexecutor =  Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
        //text += &quot;   流程的啟動者 : &quot; + rootexecutor.getName()+	 &quot;(&quot;+ rootexecutor.getMyID() +&quot;)&quot;	+&quot;&lt;br&gt;&quot;;
		var creator = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)) ;
		var roottask = Server.getTask(MyTask.getRootID());
		var roleID = MyTask.getRoleID();
		var mainroleid = creator.getMainRoleID();
		var depname = &quot;&quot;;
		if(mainroleid != &quot;&quot;){
			var memDR = creator.getMemberDR(mainroleid);
		//		var memDR = creator.getMemberDR(roleID);
			depname = memDR.getDepartmentName();	//部門名稱
		}
		text += &quot;   流程的啟動者 : &quot; + dataMap.get(&quot;Creator&quot;)	+&quot;&lt;br&gt;&quot;;				
		text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
		var frontuser = Server.getMember(MyTask.getFrontUser());
		text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		

		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

//-------------------
// 2.結案通知
//-------------------
function getMailContent2(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		//text += &quot;   此請購單已簽核完成，相關的資料如下所示，或是點選&quot; + arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   此請購單已簽核完成，相關的資料如下所示:&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
	
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pmk01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   版本 : &quot; + dataMap.get(&quot;Pmk03&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   請購日期 : &quot; + dataMap.get(&quot;Pmk04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據性質 : &quot; + dataMap.get(&quot;Pmk02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmk09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : &quot; + dataMap.get(&quot;Pmk20&quot;)+ dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pmk22&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   請購員 : &quot;  + dataMap.get(&quot;Pmk_User_Name&quot;)+&quot;(&quot;+ dataMap.get(&quot;Pmk12&quot;) +&quot;)&quot; 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		text += &quot;   是否向客戶收款 : &quot;+ isReplace(dataMap.get(&quot;Pmkc50&quot;)) +&quot;&lt;br&gt;&quot;;
		text += &quot;   備註 : &quot; + dataMap.get(&quot;Remark&quot;)	+&quot;&lt;br&gt;&quot;;		
		text += &quot;   &lt;br&gt;&quot;;				
		text += &quot;   請進入 ERP 系統做後續處理，謝謝。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

//-------------------
// 3.駁回通知
//-------------------
function getMailContent3(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		//text += &quot;   此請購單已被駁回並凍結，相關的資料如下所示，或是點選&quot; + arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   此請購單已被駁回並凍結，相關的資料如下所示:&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  		+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pmk01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   版本 : &quot; + dataMap.get(&quot;Pmk03&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   請購日期 : &quot; + dataMap.get(&quot;Pmk04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據性質 : &quot; + dataMap.get(&quot;Pmk02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmk09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : &quot; + dataMap.get(&quot;Pmk20&quot;)+ dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pmk22&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   請購員 : &quot;  + dataMap.get(&quot;Pmk_User_Name&quot;)+&quot;(&quot;+ dataMap.get(&quot;Pmk12&quot;) +&quot;)&quot; 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		text += &quot;   備註 : &quot; + dataMap.get(&quot;Remark&quot;)	+&quot;&lt;br&gt;&quot;;
		text += &quot;   主管駁回意見內容 : &quot; + getLastVerifyNotice()+&quot;&lt;br&gt;&quot;;
		try{
		//var rootexecutor =  Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
        //text += &quot;   流程的啟動者 : &quot; + rootexecutor.getName()+	 &quot;(&quot;+ rootexecutor.getMyID() +&quot;)&quot;	+&quot;&lt;br&gt;&quot;;
		var creator = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)) ;
		var roottask = Server.getTask(MyTask.getRootID());
		var roleID = MyTask.getRoleID();
		var mainroleid = creator.getMainRoleID();
		var depname = &quot;&quot;;
		if(mainroleid != &quot;&quot;){
		var memDR = creator.getMemberDR(mainroleid);
		//		var memDR = creator.getMemberDR(roleID);
			 depname = memDR.getDepartmentName();	//部門名稱
		}
		text += &quot;   流程的啟動者 : &quot; + dataMap.get(&quot;Creator&quot;)	+&quot;&lt;br&gt;&quot;;				
		text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
		var frontuser = Server.getMember(MyTask.getFrontUser());
		text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   請進入 ERP 系統做後續處理，謝謝。&lt;br&gt;&quot;;
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}
//-------------------
// 4.更新失敗通知
//-------------------
function getMailContent4(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		//text += &quot;   此請購單已簽核完成，相關的資料如下所示，或是點選&quot; + arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   此採購單更新失敗，相關的資料如下所示:&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
	
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pmk01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   版本 : &quot; + dataMap.get(&quot;Pmk03&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   請購日期 : &quot; + dataMap.get(&quot;Pmk04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據性質 : &quot; + dataMap.get(&quot;Pmk02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmk09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : &quot; + dataMap.get(&quot;Pmk20&quot;)+ dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pmk22&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   請購員 : &quot;  + dataMap.get(&quot;Pmk_User_Name&quot;)+&quot;(&quot;+ dataMap.get(&quot;Pmk12&quot;) +&quot;)&quot; 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		text += &quot;   備註 : &quot; + dataMap.get(&quot;Remark&quot;)	+&quot;&lt;br&gt;&quot;;		
		text += &quot;   &lt;br&gt;&quot;;				
		text += &quot;   請進入 ERP 系統做後續處理，謝謝。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

//===============================================================================
// sendPOMail
// type : 1.工作通知、2.結案通知、3.駁回通知、4.更新失敗通知
//===============================================================================
function sendPOMail(type){
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
		var to = Server.getMember(MyTask.getRealExecutor()).getEmail(); 
        var cc = &quot;&quot;; 
		var subject = &quot;主旨 : &lt;&quot; + dataMap.get(&quot;Af_Speed&quot;) + &quot;&gt;&quot; + dataMap.get(&quot;Pmm01&quot;) + &quot;_AF電子表單[&quot; + aInstance.getName() + &quot;]&quot; + type ; // Mail Subject 
		if(&quot;工作通知&quot;.equals(type)){
			var text = getPOMailContent1(dataMap);
		}else if(&quot;結案通知&quot;.equals(type)) {
			to = getProcessMailAddressList(&quot;採購單通知名單&quot;);
			var text = getPOMailContent2(dataMap);		
		}else if(&quot;駁回通知&quot;.equals(type)) {
			to = getProcessMailAddressList(&quot;沒有&quot;);
			var text = getPOMailContent3(dataMap);
		}else if(&quot;更新失敗通知&quot;.equals(type)) {
			to = Server.getMember(&quot;administrator&quot;).getEmail();
			var text = getPOMailContent4(dataMap);
		}
        var fileList = new Packages.java.util.Vector(); 
        Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
}

//-------------------
// 1.工作通知
//-------------------
function getPOMailContent1(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   這裡是Agentflow管理員，通知有工作已經送到您手上，請儘速登入網站處理。&lt;br&gt;&quot;;			
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  		+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pmm01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   版本 : &quot; + dataMap.get(&quot;Pmm03&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購日期 : &quot; + dataMap.get(&quot;Pmm04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據性質 : &quot; + dataMap.get(&quot;Pmm02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmm09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : (&quot; + dataMap.get(&quot;Pmm20&quot;)+ &quot;)&quot; + dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pmm22&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購員 : &quot;  + dataMap.get(&quot;App_Name&quot;)+&quot;(&quot;+ dataMap.get(&quot;Pmm12&quot;) +&quot;)&quot; 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		try{
		//var rootexecutor =  Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
        //text += &quot;   流程的啟動者 : &quot; + rootexecutor.getName()+	 &quot;(&quot;+ rootexecutor.getMyID() +&quot;)&quot;	+&quot;&lt;br&gt;&quot;;
		var creator = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)) ;
		var roottask = Server.getTask(MyTask.getRootID());
		var roleID = MyTask.getRoleID();
		var mainroleid = creator.getMainRoleID();
		var depname = &quot;&quot;;
		if(mainroleid != &quot;&quot;){
			var memDR = creator.getMemberDR(mainroleid);
		//		var memDR = creator.getMemberDR(roleID);
				depname = memDR.getDepartmentName();	//部門名稱
		}
		text += &quot;   流程的啟動者 : &quot; + dataMap.get(&quot;Creator&quot;)	+&quot;&lt;br&gt;&quot;;				
		text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
		var frontuser = Server.getMember(MyTask.getFrontUser());
		text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

//-------------------
// 2.結案通知
//-------------------
function getPOMailContent2(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   此採購單已簽核完成，相關的資料如下所示:&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
	
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pmm01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   版本 : &quot; + dataMap.get(&quot;Pmm03&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購日期 : &quot; + dataMap.get(&quot;Pmm04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據性質 : &quot; + dataMap.get(&quot;Pmm02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmm09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : &quot; + dataMap.get(&quot;Pmm20&quot;)+ dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pmm22&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購員 : &quot;  + dataMap.get(&quot;App_Name&quot;)+&quot;(&quot;+ dataMap.get(&quot;Pmm12&quot;) +&quot;)&quot; 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;				
		text += &quot;   請進入 ERP 系統做後續處理，謝謝。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

//-------------------
// 3.駁回通知
//-------------------
function getPOMailContent3(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   此採購單已被駁回並凍結，相關的資料如下所示:&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  		+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pmm01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   版本 : &quot; + dataMap.get(&quot;Pmm03&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   請購日期 : &quot; + dataMap.get(&quot;Pmm04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據性質 : &quot; + dataMap.get(&quot;Pmm02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmm09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : &quot; + dataMap.get(&quot;Pmm20&quot;)+ dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pmm22&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購員 : &quot;  + dataMap.get(&quot;App_Name&quot;)+&quot;(&quot;+ dataMap.get(&quot;Pmm12&quot;) +&quot;)&quot; 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		try{
		//var rootexecutor =  Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
        //text += &quot;   流程的啟動者 : &quot; + rootexecutor.getName()+	 &quot;(&quot;+ rootexecutor.getMyID() +&quot;)&quot;	+&quot;&lt;br&gt;&quot;;
		var creator = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)) ;
		var roottask = Server.getTask(MyTask.getRootID());
		var roleID = MyTask.getRoleID();
		var depname = &quot;&quot;;
		var mainroleid = creator.getMainRoleID();
		if(mainroleid != &quot;&quot;){
			var memDR = creator.getMemberDR(mainroleid);
		//		var memDR = creator.getMemberDR(roleID);
			depname = memDR.getDepartmentName();	//部門名稱
		}
		text += &quot;   流程的啟動者 : &quot; + dataMap.get(&quot;Creator&quot;)	+&quot;&lt;br&gt;&quot;;				
		text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
		var frontuser = Server.getMember(MyTask.getFrontUser());
		text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		text += &quot;   主管駁回意見內容 : &quot; + getLastVerifyNotice()+&quot;&lt;br&gt;&quot;;
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   請進入 ERP 系統做後續處理，謝謝。&lt;br&gt;&quot;;
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}
//-------------------
// 4.更新失敗通知 PO
//-------------------
function getPOMailContent4(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		//text += &quot;   此請購單已簽核完成，相關的資料如下所示，或是點選&quot; + arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   此採購單更新失敗，相關的資料如下所示:&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
	
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pmm01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   版本 : &quot; + dataMap.get(&quot;Pmm03&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購日期 : &quot; + dataMap.get(&quot;Pmm04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據性質 : &quot; + dataMap.get(&quot;Pmm02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmm09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : &quot; + dataMap.get(&quot;Pmm20&quot;)+ dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pmm22&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購員 : &quot;  + dataMap.get(&quot;App_Name&quot;)+&quot;(&quot;+ dataMap.get(&quot;Pmm12&quot;) +&quot;)&quot; 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;				
		text += &quot;   請進入 ERP 系統做後續處理，謝謝。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}



//===============================================================================
// sendPOCMail
// type : 1.工作通知、2.結案通知、3.駁回通知、4.更新失敗通知
//===============================================================================
function sendPOCMail(type){
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var from = Server.getMember(&quot;administrator&quot;).getEmail();  		
		var to = Server.getMember(MyTask.getRealExecutor()).getEmail(); 
        var cc = &quot;&quot;; 
		var subject = &quot;主旨 : &lt;&quot; + dataMap.get(&quot;Af_Speed&quot;) + &quot;&gt;&quot; + dataMap.get(&quot;Pna01&quot;) + &quot;_AF電子表單[&quot; + aInstance.getName() + &quot;]&quot; + type ; // Mail Subject 
		if(&quot;工作通知&quot;.equals(type)){
			var text = getPOCMailContent1(dataMap);
		}else if(&quot;結案通知&quot;.equals(type)) {
			to = getProcessMailAddressList(&quot;採購變更單通知名單&quot;);
			var text = getPOCMailContent2(dataMap);		
		}else if(&quot;駁回通知&quot;.equals(type)) {
			to = getProcessMailAddressList(&quot;沒有&quot;);
			var text = getPOCMailContent3(dataMap);
		}else if(&quot;更新失敗通知&quot;.equals(type)) {
			to = Server.getMember(&quot;administrator&quot;).getEmail();
			var text = getPOCMailContent4(dataMap);
		}
        var fileList = new Packages.java.util.Vector(); 
        Server.sendHTMLMailExt(from,to,cc,subject,text,fileList,MyTask); 
}

//-------------------
// 1.工作通知 POC
//-------------------
function getPOCMailContent1(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   這裡是Agentflow管理員，通知有工作已經送到您手上，請儘速登入網站處理。&lt;br&gt;&quot;;			
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  		+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pna01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   變更序號 : &quot; + dataMap.get(&quot;Pna02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購日期 : &quot; + dataMap.get(&quot;Pmm04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmm09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : (&quot; + dataMap.get(&quot;Pna10&quot;)+ &quot;)&quot; + dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pna08&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購員 : &quot;  + dataMap.get(&quot;App_Name&quot;)+ &quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		try{
		//var rootexecutor =  Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
        //text += &quot;   流程的啟動者 : &quot; + rootexecutor.getName()+	 &quot;(&quot;+ rootexecutor.getMyID() +&quot;)&quot;	+&quot;&lt;br&gt;&quot;;
		var creator = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)) ;
		var roottask = Server.getTask(MyTask.getRootID());
		var roleID = MyTask.getRoleID();
		var mainroleid = creator.getMainRoleID();
		var depname = &quot;&quot;;
		if(mainroleid != &quot;&quot;){
			var memDR = creator.getMemberDR(mainroleid);
		//		var memDR = creator.getMemberDR(roleID);
				depname = memDR.getDepartmentName();	//部門名稱
		}
		text += &quot;   流程的啟動者 : &quot; + dataMap.get(&quot;Creator&quot;)	+&quot;&lt;br&gt;&quot;;				
		text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
		var frontuser = Server.getMember(MyTask.getFrontUser());
		text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

//-------------------
// 2.結案通知 POC
//-------------------
function getPOCMailContent2(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   此採購變更單已簽核完成，相關的資料如下所示:&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
	
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pna01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   變更版本 : &quot; + dataMap.get(&quot;Pna02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購日期 : &quot; + dataMap.get(&quot;Pmm04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmm09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : &quot; + dataMap.get(&quot;Pna10&quot;)+ dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pna08&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購員 : &quot;  + dataMap.get(&quot;App_Name&quot;)+ &quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;				
		text += &quot;   請進入 ERP 系統做後續處理，謝謝。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}

//-------------------
// 3.駁回通知 POC
//-------------------
function getPOCMailContent3(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   此採購單已被駁回並凍結，相關的資料如下所示:&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		text += &quot;   流程名稱 : &quot; + Server.getTask(MyTask.getParentID()).getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作名稱 : &quot; + MyTask.getProcessName()  +&quot;&lt;br&gt;&quot;;
		text += &quot;   工作主題 : &quot; + MyTask.getKeyWord()  		+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pmm01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   版本 : &quot; + dataMap.get(&quot;Pmm03&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   請購日期 : &quot; + dataMap.get(&quot;Pmm04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   單據性質 : &quot; + dataMap.get(&quot;Pmm02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmm09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : &quot; + dataMap.get(&quot;Pmm20&quot;)+ dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pmm22&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購員 : &quot;  + dataMap.get(&quot;App_Name&quot;) +&quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		text += &quot;   主管駁回意見內容 : &quot; + getLastVerifyNotice()+&quot;&lt;br&gt;&quot;;		
		try{
		//var rootexecutor =  Server.getMember(Server.getTask(MyTask.getRootID()).getRealExecutor()) ;
        //text += &quot;   流程的啟動者 : &quot; + rootexecutor.getName()+	 &quot;(&quot;+ rootexecutor.getMyID() +&quot;)&quot;	+&quot;&lt;br&gt;&quot;;
		var creator = Server.getMember(dataMap.get(&quot;Creator_ID&quot;)) ;
		var roottask = Server.getTask(MyTask.getRootID());
		var roleID = MyTask.getRoleID();
		var depname = &quot;&quot;;
		var mainroleid = creator.getMainRoleID();
		if(mainroleid != &quot;&quot;){
			var memDR = creator.getMemberDR(mainroleid);
		//		var memDR = creator.getMemberDR(roleID);
			depname = memDR.getDepartmentName();	//部門名稱
		}
		text += &quot;   流程的啟動者 : &quot; + dataMap.get(&quot;Creator&quot;)	+&quot;&lt;br&gt;&quot;;				
		text += &quot;   流程的啟動部門 : &quot; + depname 		+&quot;&lt;br&gt;&quot;;
		var frontuser = Server.getMember(MyTask.getFrontUser());
		text += &quot;   上一關人員 : &quot; + frontuser.getName() + &quot;(&quot; + frontuser.getMyID()  		+&quot;)&lt;br&gt;&quot;;		
		}catch(e){}
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   請進入 ERP 系統做後續處理，謝謝。&lt;br&gt;&quot;;
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}
//-------------------
// 4.更新失敗通知 POC
//-------------------
function getPOCMailContent4(dataMap){
		var arturl = getUrl(4) ;
		var text = &quot;   您 好: &lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
		//text += &quot;   此採購變更單已簽核完成，相關的資料如下所示，或是點選&quot; + arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;;
		text += &quot;   此採購變更單更新失敗，相關的資料如下所示:&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;
	
        text += &quot;   單據編號 : &quot; + dataMap.get(&quot;Pna01&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   變更序號 : &quot; + dataMap.get(&quot;Pna02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購日期 : &quot; + dataMap.get(&quot;Pmm04&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   優先權 : &quot; + dataMap.get(&quot;Af_Speed&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   供應商 : &quot; + dataMap.get(&quot;Pmm09&quot;)+ dataMap.get(&quot;Pmc081&quot;)	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   付款條件 : &quot; + dataMap.get(&quot;Pmm20&quot;)+ dataMap.get(&quot;Pma02&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   幣別 : &quot; + dataMap.get(&quot;Pmm22&quot;) 	+&quot;&lt;br&gt;&quot;;		
        text += &quot;   採購員 : &quot;  + dataMap.get(&quot;App_Name&quot;) +&quot;&lt;br&gt;&quot;;		
        text += &quot;   表單中是否有相關電子檔 : &quot;+ haveAttachFile() +&quot;&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;				
		text += &quot;   請進入 ERP 系統做後續處理，謝謝。&lt;br&gt;&quot;;
		text += &quot;   &lt;br&gt;&quot;;		
		text += &quot;   若有任何疑問，請與資訊部連絡 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;
		text += &quot;   Agentflow電子表單流程網址:http://wfs.edimax.com.tw:8080/WebAgenda   &lt;br&gt;&quot;;		
		text += &quot;   訊舟科技(台灣)資訊部服務信箱: mis_service@edimax.com.tw  &lt;br&gt;&quot;;
		text += &quot;   訊舟科技(台灣)資訊部服務電話: (02)7739-6888 分機 6633 或 6682 &lt;br&gt;&quot;;
		text += &quot;   =================================================================== &lt;br&gt;&quot;;		
		return text;
}


function haveAttachFile(){
	var str = &quot;否&quot;;
	var taskID = MyTask.getID();
	var artInstance = MyTask.getArtInstance(); 
    var artID = artInstance.getArtifactID();
    var InsID = artInstance.getID();
    var sql = &quot;select  FileName from AttachFile where  ArtInsID = &apos;&quot;+InsID+&quot;&apos;&quot;;
    var vc = Server.SQLloadValue(sql);
    if (vc.size()&gt;0){
		str = &quot;是&quot;;
    }
	return str;
}


function isReplace(flg_is){
	var str = &quot;否&quot;;
    if (&quot;true&quot;.equals(flg_is)){
		str = &quot;是&quot;;
    }
	return str;
}

//------------------------
// 發 mail 開啟連結用的 URL 
// n == 1 //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件 ( ie7 無法直接開 ) 
// n == 2 //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
// n == 3 //email開表單，需密碼
// n == 4 //email開表單，不需密碼
//------------------------
function getUrl(n){
           //預設 url 
           var     url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
           var aInstance = MyTask.getArtInstance(); 
           var dataMap = aInstance.getAppDataMap(); 
           var host = Server.getServerEnv().getWebAgendaURL(); //WebAgenda的位置  
           if(1 == n){
                     //給 url 連結 需先登入AEPP 可開啟表單，但是無法下載附件
                     var arturl = host +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(2 == n){
                     //給 url 連結 可開啟表單且可下載附件，非流程參與者可用
                     //var arturl = Server.getServerEnv().getWebAgendaURL() +&quot;/preAction.do?artInsID=&quot;+ aInstance.getID() +&quot;&amp;readOnly=true&quot;;
        //---------------------------------------------------------------------------------------------------------------------
                     var password = &quot;1234&quot; //電子表單開啟密碼 (ex: &quot;1234&quot;)
                     var checkpass = &quot;false&quot;; //是否使用電子表單密碼 (&quot;true&quot; 或 &quot;false&quot;)
                     var taskID = MyTask.getID();
                     var member = Server.getMember(MyTask.getMemberID());
                     //var userName = member.getName();
                     var userName = member.getLoginID();
                     var temp = &quot;taskID=&quot; + taskID + &quot;&amp;userName=&quot; + userName + &quot;&amp;password=&quot; + password + &quot;&amp;checkpass=&quot; + checkpass;
                     var key = Packages.util.SecurityURL.encode(temp);
                     var arturl = host + &quot;/!.do?key=&quot; + key;
        //---------------------------------------------------------------------------------------------------------------------
                     url = &quot;&lt;a href=&apos;&quot;+ arturl +&quot;&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot; ; 
           }else if(3 == n){
           	//email開表單，需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenFormCheckpass&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
           }else if(4 == n ){
           	//email開表單，不需密碼
           	 url = &quot;&lt;a href=&apos;$webAgendaURL$mailOpenForm&apos;&gt;開啟表單&lt;/a&gt;&lt;br&gt;&quot;;
           }
           return url;
}

//=====================================================================
//取得Root Task 流程所經過的人+ 特定 table 抓出來的 email address 字串
//=====================================================================
function getProcessMailAddressList(groupname){
	var emailaddress = &quot;&quot;;
	var memset = java.util.TreeSet();
	//流程上的成員
	var sql = &quot; select DISTINCT exeid from task where rootid = &apos;&quot;+ MyTask.getRootID() +&quot;&apos; and tskid != rootid &quot;;  //and tskid != &apos;&quot;+ MyTask.getID() +&quot;&apos; &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;exeid&quot;)) != null){
					memset.add(vec.get(i).get(&quot;exeid&quot;));
			}
		}
	}
	//Table 上的成員
	var sql = &quot; SELECT Mem_GenInf.MemID memid FROM A_Group INNER JOIN Mem_GenInf ON A_Group.ID = Mem_GenInf.ID WHERE (A_Group.GROUPNAME = &apos;&quot; + groupname + &quot;&apos;) &quot;; 
	var vec = Server.SQLloadValue(sql); 
	if(vec != null &amp;&amp; vec.size() &gt; 0){
		for(var i=0;i&lt;vec.size();i++){
			if(Server.getMember(vec.get(i).get(&quot;memid&quot;)) != null){
					memset.add(vec.get(i).get(&quot;memid&quot;));
			}
		}
	}
	
	var key = memset.iterator();
	while(key.hasNext()){
		var memid = key.next();
		if(memid != null &amp;&amp; memid !=&quot;&quot; &amp;&amp; Server.getMember(memid) != null){
			emailaddress += Server.getMember(memid).getEmail() + &quot;;&quot; ;
		}
	}
	return emailaddress;	
}
//---------------------------------------------------------- 


//===============================================================================
//取得最後一筆的意見 20070625
//===============================================================================
		function getLastVerifyNotice(){
			var verify_notice = &quot;&quot;;
			try{
				var aInstance = MyTask.getArtInstance();
				var formDataMap = aInstance.getAppDataMap();
				var vecTableData = formDataMap.get(&quot;Process_Table&quot;);
				//抓最後一筆的簽核意見記錄
				var row = vecTableData.size()-1;
				if(row &gt;= 0 ){
					verify_notice = vecTableData.get(row).get(&quot;ITEM1&quot;); //簽核意見
				}
			}catch(e){}
			return verify_notice ;
		}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00281284102739398</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2010/09/10 16:12:00</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Server.TRN_SJ_Tran_Record</string> 
     </void> 
     <void property="id"> 
      <string>SCL00281284102739398</string> 
     </void> 
     <void property="name"> 
      <string>TRN_SJ_Tran_Record</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011227091263550</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function InsertMES(){

        var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	


	//將資料寫回教育訓練履歷卡table trnm010 by irenechang 20100910
	var ls_factory=dataMap.get(&quot;Factory&quot;);
	if (&quot;(TGCE)&quot;.equals(ls_factory)) {
		var conn = Server.createSessionConnection(&quot;T-MES&quot;);
	}else if (&quot;(SGCE)&quot;.equals(ls_factory)){
		var conn = Server.createSessionConnection(&quot;SGCEN1&quot;);
	}else if (&quot;(CGCE)&quot;.equals(ls_factory)){
		var conn = Server.createSessionConnection(&quot;CGCEN1&quot;);
	}		
								
	var ls_empno=dataMap.get(&quot;App_ID&quot;);	  // 申請人工號
	var ls_dptno=dataMap.get(&quot;dptno&quot;).substr(0,3);   // 申請部門		
	var ls_class_name = dataMap.get(&quot;class_name_n&quot;); //課程名稱
	var ls_sn = dataMap.get(&quot;Sn&quot;);         // 表單編號						
	var ls_verify = dataMap.get(&quot;verify_ID&quot;); //規定別

	if (&quot;A&quot;.equals(ls_verify)){
		ls_class_type = &apos;C&apos; //特定人員
	}else if (&quot;B&quot;.equals(ls_verify)){
		ls_class_type = &apos;D&apos; //驗證人員
	}else if (&quot;C&quot;.equals(ls_verify)){
		ls_class_type = &apos;B&apos; //基本訓練
	}
	var ls_operate =&quot;&quot;;
	var ls_flag = &quot;&quot;;	

    //  因舊系統仍有資料送審,故先判斷是否有已建立之資料-20100415 by heather
	var upSql  =  &quot;select count(class_name) as  count from trnm090 where dptno = &apos;&quot;+ls_dptno+&quot;&apos;  and af =&apos;&quot;+ls_sn+&quot;&apos;;&quot;; 
	Server.addInfoLog(upSql);
	var vec = conn.loadValue(upSql);
	if (vec.size()&gt;0 &amp;&amp; vec.get(0).get(&quot;COUNT&quot;)&gt;0){						 
	}else{
			var upSql  =  &quot;delete from trnm090 where dptno = &apos;&quot;+ls_dptno+&quot;&apos;  and af =&apos;&quot;+ls_sn+&quot;&apos;;&quot;; 
	        Sever.addDebugLog(upSql);
		  
		   var CLASS_LIST = dataMap.get(&quot;trnm090_Table&quot;);

		   var ll_rowcount = CLASS_LIST.getRowCount();
		for ( var i=0;i&lt;ll_rowcount;i++ ){	
                      var CLASS_LIST_i = CLASS_LIST.get(i);
		      var ls_class_empno = CLASS_LIST_i.get(&quot;ITEM1&quot;); //工號

		      if (&quot;(TGCE)&quot;.equals(ls_factory)){
			  var ls_MemberID=&quot;MEMT1&quot;+ls_class_empno;
		      }else if (&quot;(SGCE)&quot;.equals(ls_factory)){
			  var ls_MemberID=&quot;MEMS1&quot;+ls_class_empno;
		      }else if (&quot;(CGCE)&quot;.equals(ls_factory)){
			  var ls_MemberID=&quot;MEMC1&quot;+ls_class_empno;
		      }

 		      var cMember = Server.getMember(ls_MemberID); 
		      var ls_Joblevel = cMember.getJobLevel(); //職等

		      if ( ls_Joblevel.length()&gt;3){
			   var ls_wkgreat = getWkgreat(ls_Joblevel);
		      }else{
			   var ls_wkgreat = ls_Joblevel;
		      }

					  
	    	  // 訓練日期 將日期轉為 yyyy-mm-dd
			  var ld_date = CLASS_LIST_i.get(&quot;ITEM3&quot;); // 日期起
			  var ld_date_end = CLASS_LIST_i.get(i,&quot;ITEM4&quot;);//日期迄
			  var ls_trn_date = ld_date.substring(0,4)+&quot;-&quot;+ld_date.substring(5,7)+&apos;-&apos;+ ld_date.substring(8);			
			  var ls_trn_date_end = ld_date_end.substring(0,4)+&quot;-&quot;+ld_date_end.substring(5,7)+&apos;-&apos;+ ld_date_end.substring(8);			
			  var ls_trn_time_beg = CLASS_LIST_i.get(&quot;ITEM5&quot;).substring(0,5);	//時間起
			  var ls_trn_time_end = CLASS_LIST_i.get(&quot;ITEM56&quot;).substring(0,5);//時間迄
			  var ls_trn_time_b = CLASS_LIST_i.get(&quot;ITEM5&quot;)+&quot;:00&quot;; //時間起
			  var ls_trn_time_e = CLASS_LIST_i.get(&quot;ITEM6&quot;)+&quot;:00&quot;; //時間迄
			  var ll_timecnt = java.lang.Double.parseDouble(CLASS_LIST_i.get(&quot;ITEM7&quot;));//總時數
			  var ls_teacher =CLASS_LIST_i.get(&quot;ITEM8&quot;);//講師
		      var ls_teacher_id = CLASS_LIST_i.get(&quot;ITEM20&quot;);//講師編碼						  
			  var ls_trn_where = CLASS_LIST_i.get(&quot;ITEM9&quot;);	 //訓練地點
			  var ls_written = CLASS_LIST_i.get(&quot;ITEM11&quot;); //審查成績筆試
			  if (&quot;&quot;.equals(ls_written)){
				  ls_written = &quot;null&quot;;
			  }				 					 			  
		      var ls_oral =  getValueA(CLASS_LIST.getValueAt(&quot;ITEM12&quot;));	//審查成績口試
			  var ls_operate =  getValueA(CLASS_LIST.getValueAt(&quot;ITEM13&quot;)); //審查成績實作
			  var ls_class_no  =  CLASS_LIST.getValueAt(&quot;ITEM19&quot;);//課程編碼
						  	  
			  var upsql = &quot;INSERT INTO trnm090 ( verify ,dptno,class_name,trn_date,trn_date_end,trn_time_beg,trn_time_end,timecnt,&quot;
		          upsql += &quot; teacher,trn_where,empno,remark,trn_flag,verify_date,upd_user,upd_dtime,oral,operate,written,pass_flag,af,class_no,teacher_id) values (&quot;
				  upsql += &quot;&apos;&quot;+ls_verify+&quot;&apos;,&apos;&quot;+ls_dptno+&quot;&apos;,&apos;&quot;+ls_class_name+&quot;&apos;,&apos;&quot;+ls_trn_date+&quot;&apos;,&apos;&quot;+ls_trn_date_end+&quot;&apos;,&apos;&quot;+ls_trn_time_beg+&quot;&apos;,&quot;
				  upsql += &quot;&apos;&quot;+ls_trn_time_end+&quot;&apos;,&apos;&quot;+ll_timecnt+&quot;&apos;,&apos;&quot;+ls_teacher+&quot;&apos;,&apos;&quot;+ls_trn_where+&quot;&apos;,&apos;&quot;+ls_class_empno+&quot;&apos;,&apos;&apos;,&apos;Y&apos;,&quot;
				  upsql += &quot;&apos;&quot;+ls_trn_date+&quot;&apos;,&apos;&quot;+ls_empno+&quot;&apos;,current,&apos;&quot;+ls_oral+&quot;&apos;,&apos;&quot;+ls_operate+&quot;&apos;,&quot;+ls_written+&quot;,&apos;Y&apos;,&apos;&quot;+ls_sn+&quot;&apos;,&quot;
				  upsql += &quot;&apos;&quot;+ls_class_no+&quot;&apos;,&apos;&quot;+ls_teacher_id+&quot;&apos;);&quot;;
			  Server.addDebugLog(upsql);
			  var result = conn.updateValue(upsql);
			  if( true==result){
				   conn.commit();
                                   Server.addInfoLog(&quot;Connection insert successful.&quot;);//確認有執行connection關閉動作				 		

		
			  }else{
				   conn.rollback();	
            		           Server.addInfoLog(&quot;Connection insert fail.&quot;);//確認有執行connection關閉動作			
			  }	
			  
			  var upSql  =  &quot;delete from trnm010 where dptno = &apos;&quot;+ls_dptno+&quot;&apos;  and empno =&apos;&quot;+ls_class_empno+&quot;&apos; and class_no =&apos;&quot;+ls_class_no+&quot;&apos; and trn_date_beg =&apos;&quot;+ls_trn_date+&quot;&apos; and trn_date_end =&apos;&quot;+ls_trn_date_end+&quot;&apos;;&quot;; 
		           Server.addInfoLog(upSql);				 
			  var upsqla = &quot;Insert Into trnm010(empno,dptno,wkgreat,class_inout,class_type,trn_where,class_name,trn_date_beg,trn_date_end,trn_hours,teacher,upd_user,upd_dtime,trn_time_beg,trn_time_end,class_no,teacher_id ) Values (&quot;;
			      upsqla += &quot;&apos;&quot;+ls_class_empno+&quot;&apos;,&apos;&quot;+ls_dptno+&quot;&apos;,&apos;&quot;+ls_wkgreat+&quot;&apos;,&apos;I&apos;,&apos;&quot;+ls_class_type+&quot;&apos;,&apos;&quot;+ls_trn_where+&quot;&apos;,&apos;&quot;+ls_class_name+&quot;&apos;,&apos;&quot;+ls_trn_date+&quot;&apos;,&apos;&quot;+ls_trn_date_end+&quot;&apos;,&quot;+ll_timecnt+&quot;,&apos;&quot;+ls_teacher+&quot;&apos;,&apos;&quot;+ls_empno+&quot;&apos;,current,&apos;&quot;+ls_trn_time_b+&quot;&apos;,&apos;&quot;+ls_trn_time_e+&quot;&apos;,&apos;&quot;+ls_class_no+&quot;&apos;,&apos;&quot;+ls_teacher_id+&quot;&apos;);&quot;;
	Server.addInfoLog(upsqla);
			  var resulta = conn.updateValue(upsqla);
			  if( true==resulta){
				  conn.commit();
                                  Server.addInfoLog(&quot;Connection insert successful.&quot;);//確認有執行connection關閉動作					 	

			
			  }else{
				  conn.rollback();
                                  Server.addInfoLog(&quot;Connection insert fail.&quot;);//確認有執行connection關閉動作	
			  }			
		}	
	}
	
	if( conn != null){
		conn.close();
	}	
	
}


// 取得職等
function getWkgreat(value){
	var ls_return = value.substr(0,1);
	for ( var j=1;j&lt;3;j++){
		  var ls_str = value.substr(j,1);
		  for ( var k=0;k&lt;10;k++){
			    if ( ls_str == k.toString()){
					 ls_return = ls_return + ls_str;
				}
		  }  
    }	  
	return ls_return;
}
		

function getValueA(achievement){
	if (achievement.indexOf(&quot;優&quot;)&gt;=0){
		return &quot;1&quot;
	}else if(achievement.indexOf(&quot;佳&quot;)&gt;=0){
		return &quot;2&quot;
	}else if(achievement.indexOf(&quot;可&quot;)&gt;=0){
		return &quot;3&quot;
	}else if(achievement.indexOf(&quot;差&quot;)&gt;=0){
		return &quot;4&quot;
	}else {
		return &quot;&quot;
	}
}	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00301117094466531</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/05/26 16:01:06</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.ApFunction</string> 
     </void> 
     <void property="id"> 
      <string>SCL00301117094466531</string> 
     </void> 
     <void property="name"> 
      <string>ApFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//查看報銷單的狀態
function checkStatusByNSID(issueNo){
	var status = &quot;-&quot;;  //尚未拋轉
	try{
		var FFALTP = new Packages.hct.dataaccess.data.FFALTP();
		var dataList = FFALTP.getStatebyNSID(issueNo);
		if(dataList.size() &gt; 0){
			var aRow = dataList.get(0);
			status = aRow.getColumnValue(&quot;ALSSTS&quot;).toString().trim();
		}
	}catch(e){
		java.lang.System.out.println(&quot;checkStatusByNSID() Error:&quot;+e);
	}
	return getStatusName(status);
}
//查看報銷單的狀態
function checkStatusByNONN(issueNo,itemNo){
	var status = &quot;-&quot;;  //尚未拋轉
	try{
		var FFALTP = new Packages.hct.dataaccess.data.FFALTP();
		var dataList = FFALTP.getStatebyNONN(issueNo,itemNo);
		if(dataList.size() &gt; 0){
			var aRow = dataList.get(0);
			status = aRow.getColumnValue(&quot;ALSSTS&quot;).toString().trim();
		}
	}catch(e){
		java.lang.System.out.println(&quot;checkStatusByNONN() Error:&quot;+e);
	}
		
	return status;
}
//轉換狀態名詞
function getStatusName(statusID){
	var statusName = &quot;---&quot;;
	if(statusID == null)
		statusName = &quot;None&quot;;
	else if(statusID.equals(&quot;-&quot;))
		statusName = &quot;尚未拋轉[-]&quot;;
	else if(statusID.equals(&quot;A&quot;))
		statusName = &quot;已拋轉[A]&quot;;
	else if(statusID.equals(&quot;B&quot;))
		statusName = &quot;拋轉失敗[B]&quot;;
	else if(statusID.equals(&quot;C&quot;))
		statusName = &quot;已核准[C]&quot;;
	else if(statusID.equals(&quot;D&quot;))
		statusName = &quot;已駁回[D]&quot;;
	else if(statusID.equals(&quot;E&quot;))
		statusName = &quot;迴轉[E]&quot;;
	else if(statusID.equals(&quot;F&quot;))
		statusName = &quot;已付款[F]&quot;;
	else if(statusID.equals(&quot;R&quot;))
		statusName = &quot;已收回[R]&quot;;
		
	return statusName;
}
//查看報銷單回饋的開票日,到期日
function getEPDTAPPRbyNONNVN(icshno, icshnn, icinvn){
	var invnDate = [&quot;&quot;,&quot;&quot;]; 
	try{
		var FFACTPI = new Packages.hct.dataaccess.data.FFACTPI();
		var dataList = FFACTPI.getEPDTAPPRbyNONNVN(icshno, icshnn, icinvn);
		java.lang.System.out.println(&quot;XXX:&quot;+dataList.size());
		if(dataList.size() &gt; 0){
			var aRowArray = dataList.get(0);
			invnDate[0] = aRowArray.get(0);
			invnDate[1] = aRowArray.get(1);
		}
	}catch(e){
		java.lang.System.out.println(&quot;getEPDTAPPRbyNONNVN() Error:&quot;+e);
	}
	
	return invnDate;
}
//查看報銷單回饋的開票日,到期日
function getEPDTAPPRbyNSNNVN(icshno, icshnn, icinvn){
	var invnDate = [&quot;&quot;,&quot;&quot;]; 
	try{
		var FFACTPI = new Packages.hct.dataaccess.data.FFACTPI();
		var dataList = FFACTPI.getEPDTAPPRbyNSNNVN(icshno, icshnn, icinvn);
		java.lang.System.out.println(&quot;OOOO:&quot;+dataList.size());
		if(dataList.size() &gt; 0){
			var aRowArray = dataList.get(0);
			invnDate[0] = aRowArray.get(0);
			invnDate[1] = aRowArray.get(1);
		}
	}catch(e){
		java.lang.System.out.println(&quot;getEPDTAPPRbyNSNNVN() Error:&quot;+e);
	}
	
	return invnDate;
}

</string> 
     </void> 
     <void property="synopsis"> 
      <string>Ap相關函數</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00311120121485718</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/09/21 11:51:14</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.SharedDepTemp</string> 
     </void> 
     <void property="id"> 
      <string>SCL00311120121485718</string> 
     </void> 
     <void property="name"> 
      <string>SharedDepTemp</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//將分攤部門資訊存入DB的 temp table
//若分攤金額為 0  則不存入
function saveShareDepToDB(pkey){
	//存入資料庫(先刪後存)
	var delSQL = &quot;Delete WORK_SHAREDDEP Where PKEY = &apos;&quot; + pkey+ &quot;&apos; &quot;;
	//Debug info
	java.lang.System.out.println(&quot;delSQL String:&quot;+ delSQL);
	
	Client.SQLdeleteValue(delSQL);
	//Client.SQLdeleteValue(&quot;Delete WORK_SHAREDDEP Where PKEY = &apos;&quot;+pkey+&quot;&apos; &quot;);
		
	var tableSharedDep = Form.getComponent(&quot;tableSharedDep&quot;);
	var rowCount = tableSharedDep.getRowCount();
	for(var i = 0; i &lt; rowCount; i++){
		var amount = tableSharedDep.getValueAt(i,&quot;分攤金額&quot;);
		if(amount != null &amp;&amp; !amount.equals(&quot;0&quot;)){
			var insertSQL = &quot;Insert Into WORK_SHAREDDEP (PKEY,ITEM,DEPID,DEPNAME,AMOUNT,MEMO) values(&quot;+
				&quot;&apos;&quot;+pkey+&quot;&apos;,&quot;+
				&quot;&apos;&quot;+tableSharedDep.getValueAt(i,&quot;序號&quot;)+&quot;&apos;,&quot;+
				&quot;&apos;&quot;+tableSharedDep.getValueAt(i,&quot;部門代號&quot;)+&quot;&apos;,&quot;+
				&quot;&apos;&quot;+tableSharedDep.getValueAt(i,&quot;部門名稱&quot;)+&quot;&apos;,&quot;+
				&quot;&apos;&quot;+tableSharedDep.getValueAt(i,&quot;分攤金額&quot;)+&quot;&apos;,&quot;+
				&quot;&apos;&quot;+tableSharedDep.getValueAt(i,&quot;分攤部門摘要&quot;)+&quot;&apos;)&quot;;
				
				//Debug info
				java.lang.System.out.println(&quot;inertSQL String:&quot;+ insertSQL);
				
			Client.SQLinsertValue(insertSQL);
		}
	}
}

//由DB的 temp table將分攤部門資訊取出
function loadShareDepToDB(pkey){
	var querySharedDep = &quot;Select * from WORK_SHAREDDEP WHERE PKEY = &apos;&quot;+pkey+&quot;&apos; ORDER BY ITEM &quot;;
	var shareSet = Client.SQLloadValue(querySharedDep);
	var tableSharedDep = Form.getComponent(&quot;tableSharedDep&quot;);
	tableSharedDep.clear();
	
	for(var i = 0; i &lt; shareSet.size(); i++){
		var aRow = shareSet.get(i);
		
		var row = tableSharedDep.newRow()-1;
		tableSharedDep.setValueAt(new java.lang.Integer(row+1), row, &quot;序號&quot;);
		tableSharedDep.setValueAt(aRow.get(&quot;DEPID&quot;), row, &quot;部門代號&quot;);
		tableSharedDep.setValueAt(aRow.get(&quot;DEPNAME&quot;), row, &quot;部門名稱&quot;);
		tableSharedDep.setValueAt(aRow.get(&quot;AMOUNT&quot;), row, &quot;分攤金額&quot;);
		tableSharedDep.setValueAt(aRow.get(&quot;MEMO&quot;), row, &quot;分攤部門摘要&quot;);
	}
}
function delShareDepItemFromDB(pkey){
	//資料庫刪除
	Client.SQLdeleteValue(&quot;Delete WORK_SHAREDDEP Where PKEY = &apos;&quot;+pkey+&quot;&apos; &quot;);

}
function delShareDepFromDB(objTableName,colName){
	var tableItemList = Form.getComponent(objTableName.toString());
	var len = tableItemList.getRowCount();
	if (len &gt; 0){
		for(var i = 0; i &lt; len; i++){
			var pkey = tableItemList.getValueAt(i,colName.toString());
			delShareDepItemFromDB(pkey);
		}
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>分攤部門相關函數</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00311286783561499</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/04/09 09:15:01</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.Common.Util</string> 
     </void> 
     <void property="id"> 
      <string>SCL00311286783561499</string> 
     </void> 
     <void property="name"> 
      <string>Util</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00241213176827229</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//========================================================================================
// 取得BPM短期資料庫共用連線參數Function
//========================================================================================
function conn_db(Factory,Temp){   
	var conn_name=&quot;&quot;;

	if(Factory==&quot;TGCE&quot;){ 
		
	   if(Temp==&quot;MES&quot;){ 
	      conn_name =&quot;T-MES&quot;;
	   }else if(Temp==&quot;EZFlow&quot;){
		   conn_name =&quot;EZFlow&quot;;
	   }else if(Temp==&quot;FIX&quot;){
		   conn_name =&quot;EZFlow_FIX&quot;;
	    }else if(Temp==&quot;HR&quot;){
		   conn_name =&quot;EZFlow_FIX&quot;;
	    }else if(Temp==&quot;Oracle&quot;){
		   conn_name =&quot;PROD&quot;;
	    }	  
	   
	}else if(Factory==&quot;SGCE&quot;){
		
		if(Temp==&quot;MES&quot;){ 
	      conn_name =&quot;SGCEN1&quot;;
	   }else if(Temp==&quot;EZFlow&quot;){
		   conn_name =&quot;EZFlow_S&quot;;
	   }else if(Temp==&quot;FIX&quot;){
		   conn_name =&quot;SGCE_FIX&quot;;
	   }else if(Temp==&quot;HR&quot;){
		   conn_name =&quot;SGCE_HR&quot;;
	   }	
		   
	 }else if(Factory==&quot;CGCE&quot;){ 
		 
	    if(Temp==&quot;MES&quot;){ 
	       conn_name =&quot;CGCEN1&quot;;
	    }else if(Temp==&quot;EZFlow&quot;){
		   conn_name =&quot;EZFlow_C&quot;;
	    }else if(Temp==&quot;FIX&quot;){
		   conn_name =&quot;CGCE_FIX&quot;;
	    }else if(Temp==&quot;HR&quot;){
		   conn_name =&quot;CGCE_HR&quot;;
	    }
		   
	 }else if(Factory==&quot;HGCE&quot;){		 
		if(Temp==&quot;MES&quot;){ 
	      conn_name =&quot;HGCEN1&quot;;
	    }else if(Temp==&quot;EZFlow&quot;){
		   conn_name =&quot;EZFlow_H&quot;;
	    }else if(Temp==&quot;FIX&quot;){
		   conn_name =&quot;HGCE_FIX&quot;;
	    }else if(Temp==&quot;HR&quot;){
		   conn_name =&quot;HGCE_HR&quot;;
	    }
		
	 }	
	  
	return conn_name;
}

//========================================================================================
// 取得各廠memid 開頭
//========================================================================================
function get_ls_memt(v_factory){
		if (&quot;TGCE&quot;.equals(v_factory)) {	 	
			var ls_memt = &quot;MEMT1&quot;;
		}else if (&quot;SGCE&quot;.equals(v_factory)){		 
			var ls_memt = &quot;MEMS1&quot;;
		}else if (&quot;CGCE&quot;.equals(v_factory)){	 	
			var ls_memt = &quot;MEMC1&quot;;
		}else if (&quot;HGCE&quot;.equals(v_factory)){	 	
			var ls_memt = &quot;MEMH1&quot;;
		}
	return ls_memt;
}
//========================================================================================
// add by wangwei@2011/09/02
// 取得系統管理者的 mail list
// type : 專案別/模組別
//========================================================================================
function getAdmMailList(vType){
//	var vType = type.toLowerCase(); 	   // 轉成小寫避免傳入的有大小寫
	var vMailList = &quot;wangwei@gce.com.tw&quot; ; // 預設
	if(vType==&quot;sys&quot;){
		vMailList = &quot;wangwei@gce.com.tw;yingchieh_wang@gce.com.tw;edison_wang@gce.com.tw&quot;;
	}else if(vType==&quot;iso&quot;){
		vMailList = &quot;wangwei@gce.com.tw;edison_wang@gce.com.tw&quot;;
	}
	return vMailList;
}

//===========================================================================================
// add by wangwei@2018/08/21
// 以別廠取得 ERP 系統上定義的 ORID
// for Client Side function
// 傳入表單廠別代號vFactory ex: TGCE or (TGCE) 
// 要回傳的值 vType : INV :31  庫存/ FIN: 財務  30
//===========================================================================================
function ClientGetERPORGID(vFactory, vType){
	var vID = &quot;&quot;;
	if( vFactory.indexOf(&quot;(&quot;) &gt;=0){
		var vNAME = &quot;OU-&quot; + vFactory.substr(1,4);
	}else{
		var vNAME = &quot;OU-&quot; + vFactory;
	}
	var vSQL = &quot;    SELECT FSP.INVENTORY_ORGANIZATION_ID INVORGID, &quot;;
	vSQL = vSQL + &quot;       FSP.ORG_ID ORGID, &quot;;
	vSQL = vSQL + &quot;       HOU.NAME  ORGNAME , &quot;;
	vSQL = vSQL + &quot;       MP.ORGANIZATION_CODE ORGCODE &quot;;
	vSQL = vSQL + &quot;  FROM FINANCIALS_SYSTEM_PARAMS_ALL  FSP, &quot;;
	vSQL = vSQL + &quot;      HR_ALL_ORGANIZATION_UNITS HOU      , &quot;;
	vSQL = vSQL + &quot;       MTL_PARAMETERS MP &quot;;
	vSQL = vSQL + &quot; WHERE FSP.ORG_ID                    =  HOU.ORGANIZATION_ID &quot;;
	vSQL = vSQL + &quot;   AND FSP.INVENTORY_ORGANIZATION_ID =  MP.ORGANIZATION_ID(+) &quot;;
	vSQL = vSQL + &quot;   AND HOU.NAME = &apos;&quot;+vNAME+&quot;&apos;&quot;;  // --  OU-TGCE/OU-SGCE/OU-CGCE... &quot;;
		
	try{	
		var connERP = Client.createSessionConnection(&quot;PROD&quot;);
		var vec = connERP.loadValue(vSQL);		
		if( vec.size()&gt; 0){
			if(vType==&quot;INV&quot;){vID=vec.get(0).get(&quot;INVORGID&quot;)}
			if(vType==&quot;FIN&quot;){vID=vec.get(0).get(&quot;ORGID&quot;)}			
		}else{
			vID =  &quot;N/A&quot;;		
		}
	}catch(e){						
		Form.showMessageDialog(&quot;ClientGetERPORGID Fail:\n&quot;+e);				
	}finally{
		connERP.close();
	}
	return vID;
}

//===========================================================================================
//　Fine Report Server URL
// add by wangwei@2018/11/30
//===========================================================================================
function getFRURL(){
	
	return &quot;http://rptsrv.gce.com.tw:8080/WebReport/ReportServer&quot;;	  	// 空白表示由程式自行控制　正式區不可空白　http://frptsrv.gce.com.tw:8080/
//	http://rptsrv.gce.com.tw:8080/WebReport/ReportServer?
	 
	
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00321287982186283</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/02/02 10:08:28</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.HR_RP</string> 
     </void> 
     <void property="id"> 
      <string>SCL00321287982186283</string> 
     </void> 
     <void property="name"> 
      <string>HR_RP</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
//*************************************************************	
//Check簽核層級
//*************************************************************
function Check_RP_Type(type,temp,v_rp){
	 if (type==&quot;FCBType&quot;){
		Form.setValue(type,&quot;&quot;);
		Form.setValue(&quot;Rpdesc&quot;,&quot;&quot;);	
        // 記錄獎懲類別欄位   
        Form.setValue(&quot;ChkType&quot;,temp);		
		Form.setValue(&quot;Rorp&quot;,v_rp);		
	}else{
	    Form.setValue(type,&quot;&quot;);
		Form.setValue(&quot;Rpdesc1&quot;,&quot;&quot;);	
        // 記錄獎懲類別欄位   
        Form.setValue(&quot;ChkType1&quot;,temp);		
		Form.setValue(&quot;Rorp1&quot;,v_rp);
	}	

//	var value=&quot;VALUE2&quot;;
	var sql = &quot;select to_char(VALUE2)  value  from A_PARAMETER_DATA where PARAMETER =&apos;HR_RP_LAW&apos; and VALUE1=&apos;&quot; + temp +&quot;&apos; union select &apos;--請選擇--&apos; as VALUE2 from A_PARAMETER_DATA where rownum=1 order by 1&quot;;
		var comboxitem = Form.getComponent(type);
		var c_value = Form.getValue(type);
		var vec = Client.SQLloadValue(sql);
		    comboxitem.removeAllItems();
		for(var i=0;i&lt;vec.size();i++) {
			var item = vec.get(i).get(&quot;value&quot;);
			comboxitem.addItem(item);
		}
		if(&quot;&quot; != c_value){
			Form.setValue(type,c_value);
		}else if(vec.size()&gt;0){
			Form.setValue(type,vec.get(0).get(&quot;value&quot;));	
		}  

}//function Check_RP_Type(type,temp)

//*************************************************************	
//記錄簽核層級
//*************************************************************

function Set_RP_Type(type){	   
  if (type==&quot;0&quot;){
	if (Form.getValue(&quot;Jobrank&quot;) == &quot;直接人員&quot;){
	   if(Form.getValue(&quot;ChkType&quot;) == &quot;解雇&quot;){
		   Form.setValue(&quot;Chk_Y&quot;,&quot;1&quot;);  					//簽核層級 Chk_Y = 1，副總 update by irene_chang 20100414  
	   } else if(Form.getValue(&quot;ChkType&quot;) == &quot;記大功&quot;){
		   Form.setValue(&quot;Chk_Y&quot;,&quot;1&quot;);  					//簽核層級 Chk_Y = 1，副總			  
	   }else{Form.setValue(&quot;Chk_Y&quot;,&quot;0&quot;);}   				//簽核層級 Chk_Y = 0，行政處長//記大過 副總不簽核 20110808		   
	}else if (Form.getValue(&quot;Jobrank&quot;) == &quot;間接人員&quot;){		 
	    if(Form.getValue(&quot;ChkType&quot;) == &quot;解雇&quot; || Form.getValue(&quot;ChkType&quot;) == &quot;記大功&quot;){
			Form.setValue(&quot;Chk_Y&quot;,&quot;2&quot;); 					//簽核層級 Chk_Y = 2，總經理	
		}else{Form.setValue(&quot;Chk_Y&quot;,&quot;0&quot;);}  				//簽核層級 Chk_Y = 0，行政處長//記大過 副總不簽核 20110808 
	 }
 }else{
	  if (Form.getValue(&quot;Jobrank&quot;) == &quot;直接人員&quot;){
		  if(Form.getValue(&quot;ChkType1&quot;) == &quot;解雇&quot;){  
			  Form.setValue(&quot;Chk_Y1&quot;,&quot;1&quot;);  				//簽核層級 Chk_Y = 1，副總  update by irene_chang 20100414
    	  }else if(Form.getValue(&quot;ChkType1&quot;) == &quot;記大功&quot;){
				   Form.setValue(&quot;Chk_Y1&quot;,&quot;1&quot;); 			//簽核層級 Chk_Y = 1，副總 
		  }else{Form.setValue(&quot;Chk_Y1&quot;,&quot;0&quot;);}   			//簽核層級 Chk_Y = 0，行政處長//記大過 副總不簽核 20110808				 
	  }else if (Form.getValue(&quot;Jobrank&quot;) == &quot;間接人員&quot;){		 
		  if(Form.getValue(&quot;ChkType1&quot;) == &quot;解雇&quot; || Form.getValue(&quot;ChkType1&quot;) == &quot;記大功&quot;){
			  Form.setValue(&quot;Chk_Y1&quot;,&quot;2&quot;);  				//簽核層級 Chk_Y = 2，總經理
		  }else{Form.setValue(&quot;Chk_Y1&quot;,&quot;0&quot;);}   			//簽核層級 Chk_Y = 0，行政處長 //記大過 副總不簽核 20110808
	  }
  }
}

//*************************************************************	
 //檢核獎懲單資料重覆 
//*************************************************************
 function check_data(){
	 try{
		  var msg =&quot;&quot;;
          var v_factory = Form.getValue(&quot;Factory&quot;);		  	  
          var v_user_id = Form.getValue(&quot;User_ID&quot;);
          var v_hr_no = Form.getValue(&quot;HR_No&quot;);		  
		  var v_insid = Form.artInstanceID;
          var sql =&quot; select insid from ART00191249539251624_INS&quot;;
  		      sql +=&quot; where ITEM155=&apos;false&apos; &quot;;	
              sql +=&quot; and ITEM213 is not null&quot;;
              sql +=&quot; and ITEM192 =&apos;&quot;+ v_hr_no +&quot;&apos;&quot;; 
			  sql +=&quot; and ITEM178 =&apos;&quot;+ v_user_id +&quot;&apos;&quot;; 	
			  sql +=&quot; and insid &lt;&gt;&apos;&quot;+ v_insid +&quot;&apos;&quot;; 							
		      sql +=&quot; and ITEM2 =&apos;&quot;+ v_factory +&quot;&apos;&quot;; 				
			  sql +=&quot; ORDER BY ITEM12 desc&quot;;					
		  var vec = Client.SQLloadValue(sql);
	  	    if(vec.size()&gt;0){
			   msg += &quot;此人的獎懲單已存在，不能申請，請您確認!!\n&quot;;
		    }				
        return msg;
	  }catch(e){
		return &quot;SQL Error&quot;;  
    }  
  }
//*************************************************************	
//回寫獎懲記錄至HR
//*************************************************************
function INS_HR_RP(v_factory){ 	
		var req_user_ID = Form.getValue(&quot;User_ID&quot;);
		var v_user_Name = Form.getValue(&quot;User_Name&quot;);	
		var req_chkType = Form.getValue(&quot;ChkType1&quot;);
		var vHR_No = Form.getValue(&quot;HR_No&quot;); 				// add by wangwei@2012/04/23
		if (v_user_Name.indexOf(&apos;(&apos;)&gt;0){
			var req_user_Name = v_user_Name.substring(0,v_user_Name.indexOf(&quot;(&quot;));		
		}else{
			var req_user_Name =Form.getValue(&quot;User_Name&quot;);
		} 
		var req_user_Dep_ID = Form.getValue(&quot;User_Dep_ID&quot;);		
        if (Form.getValue(&quot;Rorp&quot;)==&quot;1&quot;){
			 var req_rorp=&quot;獎&quot;;	
		}else{
			var req_rorp=&quot;懲&quot;;	
		}		
		if(req_chkType==&quot;解雇&quot;){
      		var req_rpmethod=&quot;公告&quot;;
		}else{
			var req_rpmethod=&quot;現金、公告&quot;;  
		}			
	   //*************************************************************	  
	   //Inser HR RP
       //*************************************************************	
		var req_rpamount = 0;
		if(Form.getValue(&quot;Rpamount1&quot;)!=&quot;&quot;){
			req_rpamount = java.lang.Integer.parseInt(Form.getValue(&quot;Rpamount1&quot;));
		}
		 
        var mydate = new Packages.pase.agenda.MyDate();
        var req_create_Date=mydate.getCurrentDate(&quot;Y/M/D H:M&quot;)
		var req_ftextArea0=Form.getValue(&quot;FTextArea0&quot;);
		var req_ftextArea0=Form.getValue(&quot;FTextArea0&quot;);
		var req_rpdesc=Form.getValue(&quot;Rpdesc1&quot;);		
		if (Form.getValue(&quot;FTextArea5&quot;)== &quot;&quot;){
            var req_rpdesc1=Form.getValue(&quot;FTextArea4&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;);
		}else{
			var req_rpdesc1=Form.getValue(&quot;FTextArea5&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;);
		} 		
		var req_flag=&apos;1&apos;;
		loadLibrary(&quot;com.gce.Common.Util&quot;);
		var conn_name = conn_db(v_factory,&quot;HR&quot;);
		var conn = null;
	  try{
		  conn = Client.createSessionConnection(conn_name);
		  var delSql = &quot;delete from erewpun where remark=&apos;&quot;+vHR_No+&quot;&apos; and badge=&apos;&quot;+req_user_ID+&quot;&apos;;&quot;;
		  var rs = conn.updateValue(delSql);		  
		  if(rs==true){
			  conn.commit();
			  var upsql = &quot;Insert Into erewpun(badge,     name,                depid,           rorp,             rptype,               rpmethod,      rpamount,        rpdate,              remark,  flagexecrp,           evidence,       evidence_desc) Values (&quot;;
			     upsql +=&quot;&apos;&quot;+req_user_ID+&quot;&apos;,&apos;&quot;+req_user_Name+&quot;&apos;,&apos;&quot;+req_user_Dep_ID+&quot;&apos;,&apos;&quot;+req_rorp+&quot;&apos;,&apos;&quot;+req_chkType+&quot;&apos;,&apos;&quot;+req_rpmethod+&quot;&apos;,&quot;+req_rpamount+&quot;,&apos;&quot;+req_create_Date+&quot;&apos;,&apos;&quot;+ vHR_No +&quot;&apos;,&apos;&quot;+ req_flag +&quot;&apos;,&apos;&quot;+ req_rpdesc+&quot;&apos;,&apos;&quot;+ req_rpdesc1 +&quot;&apos;);&quot;;
				 Client.addDebugLog(&quot;Server insert erewpun sql==&quot;+upsql);				 
				 var result = conn.updateValue(upsql);
				 if(true==result){
					 conn.commit();			    										
				 }else{
					 conn.rollback();				
				 }
		  }else{			  
			  conn.rollback();
		  }
 	  }catch(e){
		  Client.addDebugLog(&quot;新增至HR獎懲Table(erewpun)失敗:&quot;+upsql);
		  Form.setComplete(false);				
		  Form.showMessageDialog(&quot;新增至HR獎懲Table(erewpun)失敗!\n&quot;);
	  }finally{
		  conn.close();		  
	  }
   }//function INS_HR_RP() End  ================================================================================

function Asign_HR(v_factory){
	  // 取得人事主辦 from BPM 參數檔
	var sql = &quot;select to_char(value1) value1,to_char(value2) value2 from A_PARAMETER_DATA where PARAMETER =&apos;TRN_PROCESS&apos;  and TRIM(KEY1)=&apos;&quot;+v_factory+&quot;&apos; and to_char(description)=&apos;獎懲主辦&apos; order by value2&quot;;
	var vec = Client.SQLloadValue(sql);
	var table = Form.getComponent(&quot;HR_RP_Table&quot;);
	table.clear();
	for( var i=0;i&lt;vec .size();i++) {
		var row = table.newRow(); // 在table中新增一筆空白記錄
		row = row - 1; // 由於行數是從0開始，所以在處理
		table.setValueAt(vec.get(i).get(&quot;VALUE2&quot;).trim(),row,&quot;EMPNO&quot;);
		table.setValueAt(vec.get(i).get(&quot;VALUE1&quot;).trim(),row,&quot;CNAME&quot;);		  
	}	
}//function Asign_HR() End
  
  
//*************************************************************	
//回寫獎懲記錄至HR
//*************************************************************

function RE_INS_HR_RP(v_factory,insid){
		
		var Source_Ins = Client.getArtInstance(insid); // 這個是由資料拋轉(DDT)傳入的,是母表單的INSID			 
		//會簽子流程抓取母表單的簽核記錄
		
        if (Source_Ins != &quot;&quot;){  	
			var source_dataMap=Source_Ins.getAppDataMap();			
			var Process_Table =source_dataMap.get(&quot;Process_Table&quot;); 	//抓取母表單【簽核紀錄】，寫入子表單
	    }

		var req_user_ID =source_dataMap.get(&quot;User_ID&quot;);
		var v_user_Name =source_dataMap.get(&quot;User_Name&quot;);	
	    var req_chkType = source_dataMap.get(&quot;ChkType1&quot;);		
		
		if (v_user_Name.indexOf(&apos;(&apos;)&gt;0){
			var req_user_Name = v_user_Name.substring(0,v_user_Name.indexOf(&quot;(&quot;));		
		}else{
			var req_user_Name =source_dataMap.get(&quot;User_Name&quot;);
		 } 
	
		var req_user_Dep_ID = source_dataMap.get(&quot;User_Dep_ID&quot;);
		
        if (source_dataMap.get(&quot;Rorp&quot;)==&quot;1&quot;){
			 var req_rorp=&quot;獎&quot;;	
		}else{
			var req_rorp=&quot;懲&quot;;	
		}
		
		if(req_chkType==&quot;解雇&quot;){
      		var req_rpmethod=&quot;公告&quot;;
		}else{
			var req_rpmethod=&quot;現金、公告&quot;;  
		}	
		
	   //*************************************************************	  
	   //Inser HR RP
       //*************************************************************	
	   var req_rpamount = 0;
	   
		if(source_dataMap.get(&quot;Rpamount1&quot;)!=&quot;&quot;){
			req_rpamount = java.lang.Integer.parseInt(source_dataMap.get(&quot;Rpamount1&quot;));
		}
	    
		
        var mydate = new Packages.pase.agenda.MyDate();
        var req_create_Date=mydate.getCurrentDate(&quot;Y/M/D H:M&quot;)
		var req_ftextArea0=source_dataMap.get(&quot;FTextArea0&quot;);
		var req_ftextArea0=source_dataMap.get(&quot;FTextArea0&quot;);
		var req_rpdesc=source_dataMap.get(&quot;Rpdesc1&quot;);
		var HR_No=source_dataMap.get(&quot;HR_No&quot;);
		
		if (source_dataMap.get(&quot;FTextArea5&quot;)== &quot;&quot;){
            var req_rpdesc1=source_dataMap.get(&quot;FTextArea4&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;);
		}else{
			var req_rpdesc1=source_dataMap.get(&quot;FTextArea5&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;);
		} 
		
		var req_flag=&apos;1&apos;;

		loadLibrary(&quot;com.gce.Common.Util&quot;);
		var conn_name = conn_db(v_factory,&quot;HR&quot;);
		var conn = Client.createSessionConnection(conn_name);

	  try{
		  var upsql = &quot;Insert Into erewpun(badge,name,depid,rorp,rptype,rpmethod,rpamount,rpdate,remark,flagexecrp,evidence,evidence_desc) Values (&quot;;
			  upsql +=&quot;&apos;&quot;+req_user_ID+&quot;&apos;,&apos;&quot;+req_user_Name+&quot;&apos;,&apos;&quot;+req_user_Dep_ID+&quot;&apos;,&apos;&quot;+req_rorp+&quot;&apos;,&apos;&quot;+req_chkType+&quot;&apos;,&apos;&quot;+req_rpmethod+&quot;&apos;,&quot;+req_rpamount+&quot;,&apos;&quot;+req_create_Date+&quot;&apos;,&apos;&quot;+ HR_No+&quot;&apos;,&apos;&quot;+ req_flag +&quot;&apos;,&apos;&quot;+ req_rpdesc+&quot;&apos;,&apos;&quot;+ req_rpdesc1 +&quot;&apos;);&quot;;	
Client.addDebugLog(&quot;獎懲申請單補資料sql=&quot;+upsql);				
		  var result = conn.updateValue(upsql);
			 if(true==result){
				 source_dataMap.put(&quot;insertFlag&quot;,&quot;R&quot;);//寫入資料flag
			 	conn.commit();
				if(Form.getValue(&quot;in_hr&quot;)!=&quot;true&quot;){
					Form.showMessageDialog(&quot;新增至HR獎懲Table(erewpun)完成!\n&quot;);		
				}									
			 }else{
				source_dataMap.put(&quot;insertFlag&quot;,&quot;N&quot;);//寫入資料flag
				conn.rollback();
				Client.addDebugLog(&quot;新增至HR獎懲Table(erewpun)失敗:&quot;+upsql);
				Form.setComplete(false);				
				Form.showMessageDialog(&quot;新增至HR獎懲Table(erewpun)失敗!\n&quot;);
			  }
			  Client.updateArtInstance(Source_Ins);
 	  }catch(e){
		  client.addDebugLog(&quot;新增至HR獎懲Table(erewpun)失敗:&quot;+upsql);
		  Form.setComplete(false);				
		  Form.showMessageDialog(&quot;新增至HR獎懲Table(erewpun)失敗!\n&quot;);
	  }finally{
		  conn.close();
	  }
   }//function RE_INS_HR_RP() End
   
   function s_erewpun(v_factory,s1,s2){
	   loadLibrary(&quot;com.gce.Common.Util&quot;);
		var conn_name = conn_db(v_factory,&quot;HR&quot;);
		var conn = Client.createSessionConnection(conn_name);

	  try{
		  var sql = &quot;select * from  erewpun where badge=&apos;&quot;+s1+&quot;&apos; and rpdate&gt;&apos;20130201 00:00:00&apos; and remark=&apos;&quot;+s2+&quot;&apos;&quot;;
			  
		  var vec = conn.loadValue(sql);
		  if(vec!=null &amp;&amp; vec.size()&gt;0){
			  return vec.get(0).get(&quot;evidence_desc&quot;);
		  }else{
			  return &quot;&quot;;
		  }
 	  }catch(e){
		  
		  Form.setComplete(false);				
		  
	  }finally{
		  conn.close();
	  }
	   
   }
  
//===================================================================
// 獎懲單查詢
// 查詢條件
//===================================================================	
function getQueryConditionExt(){
	var sSQL=&quot;&quot;;
	var vFactory = Form.getValue(&quot;Factory&quot;);						// 廠別
		sSQL += &quot; AND ITEM2 = &apos;&quot; + vFactory + &quot;&apos;&quot;;
	var Ob_date = new Packages.pase.agenda.MyDate();
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);	
	if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; !&quot;true&quot;.equals(ckbEDate)){	   // 起始日期
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			sSQL += &quot; AND ITEM113 &gt;= &apos;&quot; + sDate + &quot;&apos;&quot;;
		}
	}		
	if (&quot;true&quot;.equals(ckbEDate) &amp;&amp; !&quot;true&quot;.equals(ckbSDate)){	   // 終止日期
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM113 &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;
		}
	}		
    if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; &quot;true&quot;.equals(ckbEDate)){	  // 起始日期 ~ 終止日期
		var sDate = Form.getValue(&quot;sDate&quot;);	
		var eDate = Form.getValue(&quot;eDate&quot;);
//		var eDate1= Ob_date.add(Form.getValue(&quot;eDate&quot;),1); 
		if (!&quot;&quot;.equals(sDate)&amp;&amp; !&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM113 &gt;= &apos;&quot; + sDate + &quot;&apos;&quot; + &quot; AND ITEM113 &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;
		}
	}		
	var DepName = Form.getValue(&quot;DepName&quot;);	 						// 部門名稱
	if (!&quot;&quot;.equals(DepName)) {
		sSQL += &quot; AND ITEM38 like &apos;&quot; + DepName.trim() + &quot;%&apos;&quot;;
	}    
	var MemName = Form.getValue(&quot;MemName&quot;);	 						// 申請人姓名
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM24 = &apos;&quot; + MemName + &quot;&apos;&quot;;
	}		
	var vSubject = Form.getValue(&quot;Subject&quot;);	    				// 獎懲人姓名
	if (!&quot;&quot;.equals(vSubject)) {
		sSQL += &quot; AND ITEM106 like &apos;&quot; + vSubject + &quot;%&apos;&quot;;
	}	
	var User_ID = Form.getValue(&quot;User_ID&quot;);	 						// 獎懲人工號
	if (!&quot;&quot;.equals(User_ID)) {
		sSQL += &quot; AND ITEM178 = &apos;&quot; + User_ID + &quot;&apos;&quot;;
	}	
	var HR_No = Form.getValue(&quot;HR_No&quot;);	 							// HR_No
	if (!&quot;&quot;.equals(HR_No)) {
		sSQL += &quot; AND ITEM192 = &apos;&quot; + HR_No + &quot;&apos;&quot;;
	}	
	var RP_Status = Form.getValue(&quot;RP_Status&quot;);	 					// 獎懲類別
	if (!&quot;全部&quot;.equals(RP_Status)) {
		sSQL += &quot; AND ITEM149 = &apos;&quot; + RP_Status + &quot;&apos;&quot;;
	}	
	return sSQL;
}

//===================================================================
// 獎懲單查詢
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable(P){	

	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	    Form.setValue(&quot;Closefg&quot;,&quot;Y&quot;);	
	    Form.setValue(&quot;Count&quot;,vec.size()+&quot;&quot;);
	    Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	if (vec.size()&gt;0) {
		var vTot = 0;
		var vI = 0;
	//	for (var i = 0 ; i &lt; vec.size(); i++) {
         for (var i = (P-1)*N ; i &lt; E; i++) {
			var vG =0;
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;自動&quot;==processname){
					processname=&quot;申請人列印&quot;;
					}				
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;					
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);				
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				if( &quot;已結案&quot;==processname || &quot;作廢&quot; ==processname ){
					table.setValueAt(&quot;--&quot;, row, &quot;申請人&quot;);
				}else{
					if(&quot;申請人列印&quot;==processname){
						table.setValueAt(&quot;申請人&quot;,  row, &quot;目前處理者&quot;);
					}else{
						table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
					}
				}				
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ITEM186&quot;), row, &quot;部門&quot;);	
			table.setValueAt(hm.get(&quot;ITEM24&quot;), row, &quot;申請人&quot;);
			table.setValueAt(hm.get(&quot;ITEM15&quot;), row, &quot;獎懲人&quot;);	
			table.setValueAt(hm.get(&quot;ITEM12&quot;),  row, &quot;開單日期&quot;);			
			table.setValueAt(hm.get(&quot;ITEM115&quot;), row, &quot;結案日期&quot;);		
            table.setValueAt(hm.get(&quot;ITEM89&quot;), row, &quot;獎懲類別&quot;);	
            table.setValueAt(hm.get(&quot;ITEM175&quot;), row, &quot;事件描述&quot;);	
            table.setValueAt(hm.get(&quot;ITEM192&quot;), row, &quot;HR No&quot;);							
			table.setValueAt(hm.get(&quot;INSID&quot;),  row, &quot;InsID&quot;);	
			var v_factory = Form.getValue(&quot;Factory&quot;).substring(1,5);
			if(Form.getValue(&quot;CheckBox1&quot;)==&quot;true&quot;){
				if (hm.get(&quot;ITEM185&quot;)== &quot;&quot;){
					var req_rpdesc=hm.get(&quot;ITEM175&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;);
				}else{
					var req_rpdesc=hm.get(&quot;ITEM185&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;);
				}
				var comm = s_erewpun(v_factory,hm.get(&quot;ITEM16&quot;),hm.get(&quot;ITEM192&quot;));
				
				table.setValueAt(comm,row,&quot;erewpun&quot;);
			}
			if(Form.getValue(&quot;in_hr&quot;)==&quot;true&quot;){
				if (hm.get(&quot;ITEM191&quot;)== &quot;&quot;){
					var req_rpdesc=hm.get(&quot;ITEM175&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;);
				}else{
					var req_rpdesc=hm.get(&quot;ITEM191&quot;).replaceAll(&quot;&apos;&quot;,&quot;’&quot;);
				}
				var comm = s_erewpun(v_factory,hm.get(&quot;ITEM16&quot;),hm.get(&quot;ITEM192&quot;));
				if(comm==&quot;&quot;){
					RE_INS_HR_RP(v_factory,hm.get(&quot;INSID&quot;));
				}else{
					table.setValueAt(comm,row,&quot;erewpun&quot;);
				}
			}
			
			}catch(e){}
		}
	   //if (vec.size()&gt;0)	
	   }else{
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
       }  
}//function showTable(P)



//===================================================================
// TRN 抓取User 部門權限
//===================================================================	
function trn_check_user(v_factory,temp1,temp2){
   	//抓取BPM 短期資料庫連線
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
  	var conn = Client.createSessionConnection(conn_name);	 
	// 取得授權部門	modi by wangwei@2012/03/21 再加上自己所屬的單位
	//var ls_App_ID = Form.getValue(&quot;App_MemID&quot;).substr(5,6);
	var ls_App_ID = Form.getValue(&quot;App_ID&quot;);	
	var vSQL = &quot;select distinct trim(a.dptno)||&apos;-&apos;||trim(b.dptcname) dptcname from empm015 a,empm030 b &quot;;
	    vSQL+= &quot; where a.dptno = b.dptno and ( b.flag= &apos;N&apos; or b.flag is  null) and a.empno=&apos;&quot;+ls_App_ID+&quot;&apos;&quot;;
		vSQL+= &quot; union &quot;;
		vSQL+= &quot; select distinct trim(a.dptno)||&apos;-&apos;||trim(a.dptcname) dptcname from empm030 a,empm020 b &quot;;
		vSQL+= &quot; where b.empno=&apos;&quot;+ls_App_ID+&quot;&apos;  and a.dptno = b.dptno  order by 1;&quot;;
	Client.addDebugLog(&quot;CAll trn_check_user:&quot;+vSQL);
	try{
		var prjList = conn.loadValue(vSQL);
		var memberNameList  = new java.util.Vector();
		memberNameList.add(&quot;&quot;);
		var comboBox = Form.getComponent(temp1);
		comboBox.removeAllItems();
		if (prjList.size() &gt; 0) {
			comboBox.addItem(&quot;==請選擇==&quot;);
			for(var i=0;i&lt;prjList.size();i++){
				var ls_empm030 = prjList.get(i);
				comboBox.addItem(ls_empm030.get(temp2));
			}
			if(ls_App_ID==&quot;005078&quot;){//陳螢榛
				comboBox.addItem(&quot;2Q3-檢驗中心&quot;);
			}
			if(ls_App_ID==&quot;005927&quot;){//劉欣滋				
				comboBox.addItem(&quot;2R2-樣品工程部&quot;);
				comboBox.addItem(&quot;2K2-技術開發部&quot;);
			}
			if(ls_App_ID==&quot;024467&quot;){//邱淑汝
				comboBox.addItem(&quot;2D4-採購一課&quot;);
			}
			
		}
	}catch(e){
		Client.addErrLog(&quot;CAll trn_check_user Error:&quot;+vSQL+e);
	}finally{
		conn.close();
	}
}
//===================================================================
// 基本功查詢
// 查詢條件
//===================================================================	
function getQueryConditionExt_BAS(){
	var sSQL=&quot;&quot;;
	var Ob_date = new Packages.pase.agenda.MyDate();
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	// 起始日期
	if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; !&quot;true&quot;.equals(ckbEDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			sSQL += &quot; AND ITEM113 &gt;= &apos;&quot; + sDate + &quot;&apos;&quot;;
		}
	}	
	// 終止日期
	if (&quot;true&quot;.equals(ckbEDate) &amp;&amp; !&quot;true&quot;.equals(ckbSDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM113 &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;
		}
	}	
	// 起始日期 ~ 終止日期
      if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; &quot;true&quot;.equals(ckbEDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		var eDate = Form.getValue(&quot;eDate&quot;);
		var eDate1= Ob_date.add(Form.getValue(&quot;eDate&quot;),1); 
		if (!&quot;&quot;.equals(sDate)&amp;&amp; !&quot;&quot;.equals(eDate)) {
			sSQL += &quot; AND ITEM113 &gt;= &apos;&quot; + sDate + &quot;&apos;&quot; + &quot; AND ITEM113 &lt;= &apos;&quot; + eDate1 + &quot;&apos;&quot;;
		}
	}	
	// 部門名稱
	var DepName = Form.getValue(&quot;DepName&quot;);	
	if (!&quot;&quot;.equals(DepName)) {
		sSQL += &quot; AND ITEM325 like &apos;&quot; + DepName.trim() + &quot;%&apos;&quot;;
	}
    // 廠別
	var vFactory = Form.getValue(&quot;Factory&quot;);	
		vFactory = &quot;(&quot;+vFactory.trim()+&quot;)&quot;;
		sSQL += &quot; AND ITEM2 = &apos;&quot; + vFactory + &quot;&apos;&quot;;
		
	// 申請人姓名
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		sSQL += &quot; AND ITEM144 like &apos;&quot; + MemName + &quot;%&apos;&quot;;
	}	
	// 認證人姓名
	var vSubject = Form.getValue(&quot;Subject&quot;);	 
	if (!&quot;&quot;.equals(vSubject)) {
		sSQL += &quot; AND ITEM318 like &apos;%&quot; + vSubject + &quot;%&apos;&quot;;
	}
	// No
	var No = Form.getValue(&quot;No&quot;);	 
	if (!&quot;&quot;.equals(No)) {
		sSQL += &quot; AND ITEM62 like &apos;%&quot; + No + &quot;%&apos;&quot;;
	}
//	// 文件狀態
//	var Status = Form.getValue(&quot;Status&quot;);	 
//	if (!&quot;全部&quot;.equals(Status)) {
//		  sSQL += &quot; AND ITEM115 is not null &quot;;			
//	}	
   var v_status = Form.getValue(&quot;Status&quot;);
   
   if(v_status ==&quot;已結案&quot;){
	   sSQL +=&quot; and ITEM155 = &apos;false&apos; and ITEM115 is not null&quot;;
	   
   }else if(v_status ==&quot;未結案&quot;){
       sSQL +=&quot; and ITEM155 = &apos;false&apos;  and ITEM115 is null&quot;;
	 
   }else if(v_status ==&quot;作廢&quot;){
       sSQL +=&quot; and ITEM155 = &apos;true&apos;&quot;;
   
   }else if(v_status ==&quot;下崗&quot;){
       sSQL +=&quot; and ITEM155 = &apos;true&apos;&quot;;
	 
   }else{
       sSQL +=&quot;&quot;;
   }
   
   var v_bas_level = Form.getValue(&quot;bas_level&quot;);
   
   if(v_bas_level !=&quot;全部&quot;){
	   sSQL +=&quot; and ITEM11 = &apos;&quot;+ v_bas_level +&quot;&apos;&quot;;
	  
   }else{
       sSQL +=&quot;&quot;;
   }
   
   var v_check_ok = Form.getValue(&quot;check_ok&quot;);
   
   if(v_check_ok ==&quot;合格&quot;){
	   sSQL +=&quot; and ITEM88 = &apos;&quot;+ v_check_ok +&quot;&apos;&quot;;
	  
   }else if(v_check_ok ==&quot;不合格&quot;){
	   sSQL +=&quot; and ITEM89 = &apos;&quot;+ v_check_ok +&quot;&apos;&quot;;
	  
   }else{
       sSQL +=&quot;&quot;;
   }
   
   

	return sSQL;

}

//===================================================================
//  共用條件的SQL SEARCH Report List
//===================================================================	
function showTable_BAS(P,vec){	
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var vec = Client.getLocalObject(vec);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
//		for (var i =0; i &lt; E; i++) {	
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
//				if(&quot;自動&quot;==processname){
//					processname=&quot;申請人列印&quot;;
//					}				
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;					
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);				
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				if( &quot;已結案&quot;==processname || &quot;作廢&quot; ==processname ){
					table.setValueAt(&quot;--&quot;, row, &quot;申請人&quot;);
				}else{
//					if(&quot;申請人列印&quot;==processname){
//						table.setValueAt(&quot;申請人&quot;,  row, &quot;目前處理者&quot;);
//					}else{
						table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
//					}
				}				
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;ITEM73&quot;),    	row, &quot;列印&quot;);					
			table.setValueAt(hm.get(&quot;ITEM62&quot;),    	row, &quot;文件編號&quot;);			
			table.setValueAt(hm.get(&quot;ITEM325&quot;), 	row, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;ITEM144&quot;),  	row, &quot;填單人姓名&quot;);			
			table.setValueAt(hm.get(&quot;ITEM318&quot;),  	row, &quot;認證人姓名&quot;);
			table.setValueAt(hm.get(&quot;ITEM12&quot;),   	row, &quot;填寫日期&quot;);			
			table.setValueAt(hm.get(&quot;ITEM10&quot;),   	row, &quot;認證單元&quot;);
			table.setValueAt(hm.get(&quot;ITEM11&quot;),  	row, &quot;認證類別&quot;);			
			table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}//function showTable_BAS(P,vec)

//---------------------------------------------------------
//main
//---------------------------------------------------------
function main_BAS() {
	var serverTime = Client.getServerTime();
	var myDate = new Packages.pase.agenda.MyDate(serverTime);
	var today = myDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;);
	var date = myDate.getCurrentDate(&quot;YMDHmS&quot;);
	//var table = Form.getComponent(&quot;ResultTable&quot;);
	var vec = Client.getLocalObject(&quot;vec&quot;);
	writeScriptToFile_BAS(&quot;C:\\temp\\基本功認證申請單_&quot; + date + &quot;.csv&quot;, today, vec);
	Form.downloadFile(&quot;C:\\temp\\&quot;, &quot;基本功認證申請單_&quot; + date + &quot;.csv&quot;);	//for JSP
}

//---------------------------------------------------------
// write Script code to file
// 20071222 改版
//---------------------------------------------------------
function writeScriptToFile_BAS(m_filePath, today, vec) {
    loadLibrary(&quot;com.A.Common.Client.Util&quot;);	
	//table中有幾列,v_col就填多少,第三個要修改的地方
//	var v_col = TOTAL_COLUMNS;
	var file  = new Packages.java.io.File(m_filePath);
	file.createNewFile();
	var pw =  new Packages.java.io.PrintWriter(new Packages.java.io.FileOutputStream(file));
	//以下三行str為表頭,第一個要修改的地方 
	var str = &quot;基本功認證申請單    列印日期: &quot; + today;
	pw.println(str);
	var str  = &quot;&quot;;
	pw.println(str);
	//下一行str各行標題,第二個要修改的地方 			
	var str = &quot;序,目前關卡,目前處理者,文件編號,填單人姓名,部門,認證人姓名,填寫日期,認證單元,認證類別&quot;;	
	pw.println(str);
	//表身
	try{
		for(var i = 0; i &lt; vec.size(); i++) {
			var hm = vec.get(i);	
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			var processname = &quot;&quot;;
			var realExecutor = &quot;&quot;;
			if (task != null){
				processname = task.getProcessName();
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				realExecutor = memberRecord.getName();
			}
			var str1 = i + 1    				+ &quot;,&quot;; //序
			str1 = str1 + processname   		+ &quot;,&quot;;//目前關卡
			str1 = str1 + realExecutor  	    + &quot;,&quot;;//目前處理者			
			str1 = str1 + hm.get(&quot;ITEM62&quot;) 	+ &quot;,&quot;;//文件編號
			str1 = str1 + hm.get(&quot;ITEM144&quot;) 	+ &quot;,&quot;;//填單人姓名				
			str1 = str1 + hm.get(&quot;ITEM325&quot;) 	+ &quot;,&quot;;//部門
			str1 = str1 + hm.get(&quot;ITEM318&quot;)  	+ &quot;,&quot;;//認證人姓名
			str1 = str1 + hm.get(&quot;ITEM12&quot;)    	+ &quot;,&quot;;//填寫日期
			str1 = str1 + hm.get(&quot;ITEM10&quot;) 	+ &quot;,&quot;;//認證單元
			str1 = str1 + hm.get(&quot;ITEM11&quot;)		+ &quot;,&quot;;//認證類別
			pw.println(str1);
		}//for i
	}catch(e){
	}finally{		
		pw.close();
	}
}

//---------------------------------------------------------
// add by wangwei@2013/08/20
// 檢查是否輸入詢欄位,非人事單位一定要有條件
//---------------------------------------------------------
function chkColumn() {
	var member = Client.getCurrentMember();
	if (member.getWorkPlace().indexOf(&quot;A6&quot;)&gt;=0 || member.getWorkPlace().indexOf(&quot;2F0&quot;)&gt;=0){
		return true;
	}else{
		if(&quot;&quot;==Form.getValue(&quot;MemName&quot;)&amp;&amp;&quot;&quot;==Form.getValue(&quot;Subject&quot;)&amp;&amp;&quot;&quot;==Form.getValue(&quot;User_ID&quot;)&amp;&amp;&quot;&quot;==Form.getValue(&quot;DepName&quot;)&amp;&amp;&quot;&quot;==	Form.getValue(&quot;HR_No&quot;)){
			return false;
		}
	}
	return	true;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00331123493696484</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2005/11/07 00:14:24</string> 
     </void> 
     <void property="fullName"> 
      <string>com.A.ExpenseFunction.ExcelImportFunction</string> 
     </void> 
     <void property="id"> 
      <string>SCL00331123493696484</string> 
     </void> 
     <void property="name"> 
      <string>ExcelImportFunction</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001105070014109</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function ImportExcelToTable(objTableName,Item){

    java.lang.System.out.println(&quot;EXCEL import &quot;); 
    
	var headfliePath = &quot;C:/Agentflow/Agentflow2_2/PASE/FileUpload&quot;;
	
	tableDepShare = Form.getComponent(objTableName.toString());
	tableDepShare.clear();
	
	ArtId = Form.getArtifactID();
	AnsId =	Form.getArtInstanceID();
	
	try {
		var fs = new Packages.org.apache.poi.poifs.filesystem.POIFSFileSystem(new Packages.java.io.FileInputStream(headfliePath+&quot;/&quot;+ArtId+&quot;/&quot;+AnsId+Item.toString()+&quot;/&quot;+getUploadflieName(AnsId)+&quot;.tmp&quot;));
		var wb = new Packages.org.apache.poi.hssf.usermodel.HSSFWorkbook(fs);
		var sheet = wb.getSheetAt(0);
		var row = sheet.getRow(0);
		
		var cell = row.getCell(new java.lang.Short(0));
		//java.lang.System.out.println(&quot;cell0&quot;+&quot;=&quot;+cell.getStringCellValue());   
		var i = 0;
		var cellType=0;
		
		var sharedDepList =  new java.util.Vector();
		var sharedDepIDList =  new java.util.Vector();
		
		while (row!=null &amp;&amp; cellType!=3){
			var aRow = new java.util.HashMap();		
			var aRowID = new java.util.HashMap();
			
			
			cell = row.getCell(new java.lang.Short(0));
			
			cellType = cell.getCellType() ;
			
			java.lang.System.out.println(&quot;cellType 0&quot;+&quot;=&quot;+cellType); 
			
			switch(cellType){
				case 0:
					aRow.put(&quot;部門代號&quot;,new java.lang.Integer(cell.getNumericCellValue().toString()).toString());
					aRowID.put(&quot;部門代號&quot;,new java.lang.Integer(cell.getNumericCellValue().toString()).toString());
					break;
				case 1:
					aRow.put(&quot;部門代號&quot;,cell.getStringCellValue());
					aRowID.put(&quot;部門代號&quot;,cell.getStringCellValue());
					break;
				default:
					Form.showMessageDialog(&quot;資料不是文字也不是數字!!&quot;);
					java.lang.System.out.println(&quot;No Data for import !!&quot;); 
		
			}
			
			cell = row.getCell(new java.lang.Short(1));
			aRow.put(&quot;部門名稱&quot;,cell.getStringCellValue());
			
			cell = row.getCell(new java.lang.Short(2));
			aRow.put(&quot;分攤金額&quot;,new java.lang.Integer(cell.getNumericCellValue().toString()));

			
			 
			cell = row.getCell(new java.lang.Short(3));			
			
			if (cell!=null){
			cellType = cell.getCellType() ;
			
			java.lang.System.out.println(&quot;cellType 3&quot;+&quot;=&quot;+cellType); 

			switch(cellType){
				case 0:
					aRow.put(&quot;摘要&quot;,new java.lang.Integer(cell.getNumericCellValue().toString()).toString().replace(&quot;\&apos;&quot;,&quot; &quot;));
					break;
				case 1:
					aRow.put(&quot;摘要&quot;,cell.getStringCellValue().replace(&quot;\&apos;&quot;,&quot; &quot;));
					break;
				case 3:
					aRow.put(&quot;摘要&quot;,&quot;N/A&quot;);
					break;
				default:
					Form.showMessageDialog(&quot;資料不是文字也不是數字!!&quot;);
					java.lang.System.out.println(&quot;No Data for import !!&quot;); 
		
			}

			}
					
			sharedDepList.add(aRow);
			sharedDepIDList.add(aRowID);
			
			i++;
			row = sheet.getRow(i);
			if(row!=null){
				cell = row.getCell(new java.lang.Short(0));
				cellType = cell.getCellType() ;
			}
		}
		java.lang.System.out.println(&quot;rows:&quot; + sharedDepList.size());
		
		if(sharedDepList.size()&gt;0 &amp;&amp; CheckAllImportDepMyId(sharedDepIDList)){
			for(var i = 0; i &lt; sharedDepList.size(); i++){
						
				var rowindex = tableDepShare.newRow() - 1;	
				tableDepShare.setValueAt(new java.lang.Integer(rowindex+1),rowindex,0);	
				tableDepShare.setValueAt(sharedDepList.get(i).get(&quot;部門代號&quot;),rowindex,1);
				tableDepShare.setValueAt(sharedDepList.get(i).get(&quot;部門名稱&quot;),rowindex,2);
				tableDepShare.setValueAt(sharedDepList.get(i).get(&quot;分攤金額&quot;),rowindex,3);
				tableDepShare.setValueAt(sharedDepList.get(i).get(&quot;摘要&quot;),rowindex,4);
		
			}
			Form.showMessageDialog(&quot;EXCEL 匯入完成!!&quot;);
			java.lang.System.out.println(&quot;EXCEL import completed &quot;); 
			
		} else {
	
			Form.showMessageDialog(&quot;沒有資料可供匯入!!&quot;);
			java.lang.System.out.println(&quot;No Data for import !!&quot;); 
		}
	} catch (e) {
		
		Form.showMessageDialog(&quot;沒有檔案可供匯入 !!&quot;);
		java.lang.System.out.println(&quot;No flie for import !!&quot;); 
		java.lang.System.out.println(&quot;Error :&quot;+ e.toString()); 
	
    }	
	
}
function getUploadflieName(ansId){ 
	
		var sqlQuery = &quot;select FileID,FileName from AttachFile where ArtInsID=&apos;&quot;
		+ansId+&quot;&apos; and SaveTime = (select max(SaveTime) from AttachFile where ArtInsID=&apos;&quot;
	    +ansId+&quot;&apos; and FileName like &apos;%.xls&apos; )&quot;;

		java.lang.System.out.println(sqlQuery.toString());
		
		result = Client.SQLloadValue(sqlQuery);
		
      	java.lang.System.out.println(&quot;file Name&quot;+&quot;=&quot;+result.get(0).get(&quot;FileName&quot;).toString());
		
		return result.get(0).get(&quot;FileName&quot;).toString(); 
	
}
function CheckAllImportDepMyId(objVector){ 
	
	var sqlQuery = &quot;select distinct ID as 部門代號 from Dep_GenInf where ID is not Null &quot;;
	var msg=&quot;&quot;;
	java.lang.System.out.println(sqlQuery.toString());
	
	result = Client.SQLloadValue(sqlQuery);
	
    java.lang.System.out.println(result.toString());
    java.lang.System.out.println(objVector.toString()); 
    
    for (var i = 0; i &lt; objVector.size(); i++){
		if (result.indexOf(objVector.get(i))==-1)	
			msg+=&quot;\n沒有 &quot;+ objVector.get(i).get(&quot;部門代號&quot;)+&quot; 這個部門代號!!&quot;;
	}
		
	if(msg.equals(&quot;&quot;)){
		return true;
	}else{
		Form.showMessageDialog(msg);
		return false;
	}
	
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>Excel 匯入功能</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00331297093787246</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/07/20 14:02:01</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Client.PDM_okAction_MECN</string> 
     </void> 
     <void property="id"> 
      <string>SCL00331297093787246</string> 
     </void> 
     <void property="name"> 
      <string>PDM_okAction_MECN</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021229049977055</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function okAction_MECN(){	  
  var aInstance = MyTask.getArtInstance();
  var appDataMap = aInstance.getAppDataMap(); 
  var rootid = MyTask.getRootID();
  var process_name = MyTask.getProcessName();
  var SignTable = appDataMap.get(&quot;Process_Table&quot;);
  var AddAs_Table = appDataMap.get(&quot;AddAs_Table&quot;);
  var Source_Ins_ID = Form.getValue(&quot;Source_Ins_ID&quot;);   // 這個是由資料拋轉(DDT)傳入的,是母表單的INSID	
  var Source_Ins = Client.getArtInstance(Source_Ins_ID);
  var msg = &quot;&quot;;
  
  //*************************************************************	
  //當不是作廢文件時
  //*************************************************************	
  if ( Form.getValue(&quot;Cancel&quot;) != &quot;true&quot; ){	
	//*************************************************************	  
	//當流程關卡名稱包含【申請人】時，且Form.getValue(&quot;Agree&quot;) == &quot;true&quot; 
    //*************************************************************	
	if( process_name.indexOf(&quot;申請人&quot;)&gt;=0 ){	
		
		 //*************************************************************	
		 // Check 【*】基本欄位填寫 
		 //*************************************************************	
		   //檢查【一.變更範圍】各別類型的必填欄位
		    msg+=check_Form(SignTable,msg);	
		   //*************************************************************	
           //show check MECN msg
		   //*************************************************************	
		   if(msg != &quot;&quot;){
			  showmsg(msg);
		   }else{
			      Form.setValue(&quot;mecn_type_t&quot;,Form.getValue(&quot;mecn_type&quot;));	//變更類別		   			   
			      //*************************************************************	
				  // 當 check MECN 無 msg
				  // 定義提出單位最高主管
				  //*************************************************************	
					dp_manager(msg);
				  //*************************************************************	
				  // 當 check MECN 無 msg
				  // 定義Asign Member
				  //*************************************************************	
				  // 清空會簽人員清單 Table
				     clear_Asign_Table();	
				  // 設定相關單位會簽人員 
				  	 insert_Asign_Table(process_name);
		    }//當 check MECN 無 msg -- End		
				 
   //*************************************************************				 
   // 當流程關卡名稱不為【申請人】時
   //*************************************************************
   }else{
	   //記錄目前簽核人員回寫至母表單
	   Source_Ins.setAppValue(&quot;Verify_ID&quot;,Form.getValue(&quot;Verify_ID&quot;));
	   Source_Ins.setAppValue(&quot;Verify_Name&quot;,Form.getValue(&quot;Verify_Name&quot;));

	   if (Form.getValue(&quot;Agree&quot; )== &quot;true&quot;){
		   var temp = &quot;Agree&quot;;
	   }else if( Form.getValue(&quot;Reject&quot;) == &quot;true&quot; ){
		   var temp = &quot;Reject&quot;;
	   }
	   //檢核各關卡必填欄位與特殊條件
	   check_process(Source_Ins,process_name,temp,msg);
   }// 當流程關卡名稱不為【申請人】時 -- End

  }else{//if ( Form.getValue(&quot;Cancel&quot;) == &quot;true&quot; )	
	  //檢核作廢
	  check_cancel(Source_Ins,process_name,msg);
  }//if ( Form.getValue(&quot;Cancel&quot;) != &quot;true&quot; )-- End
  
 Client.updateArtInstance(Source_Ins); 	
}//function okAction_MECN()


//*************************************************************
// ***** function ***** 
//*************************************************************	
function showmsg(msg){
	  Form.setComplete(false);
	  Form.showMessageDialog(msg);	  
}//function showmsg()  

 //抓HR提出單位最高主管
function dp_manager(){
	 var dep_id = Form.getValue(&quot;App_Dep_ID&quot;);
	 var app_memid = Form.getValue(&quot;App_MemID&quot;);	 
	 try{
		//Select 部門單位主管 SQL	 
		var SQL_a  = &quot;SELECT distinct(e.MEMID) as empcode, e.USERNAME,e.JOBTITLE,e.PAGER,substr(e.MAINROLEID,8,3)ROLEID &quot;;
            SQL_a += &quot;from mem_geninf e &quot;;
            SQL_a += &quot;where e.memid =&apos;&quot;+app_memid+&quot;&apos;&quot;;
 	     var vec = Client.SQLloadValue(SQL_a);
         if (vec.size()&gt;0){
			var memid = vec.get(0).get(&quot;empcode&quot;);
			var managerid = vec.get(0).get(&quot;PAGER&quot;);
			var roleid = java.lang.Integer.parseInt(vec.get(0).get(&quot;ROLEID&quot;));
			
            if (roleid &lt; 82){
                check_roleid(managerid);
			}else{
			      Form.setValue(&quot;Top_App_Manager_ID&quot;,memid );
			}
		 }else{//if (vec.size()&gt;0)	 
			   Form.setComplete(false);
	           Form.showMessageDialog(&quot;抓HR提出單位最高主管錯誤，請通知資訊處 22714 張瀚云 處理，謝謝您!!&quot;);	 
		 }
	 }catch(e){	 
		       Form.setComplete(false);
	           Form.showMessageDialog(&quot;抓HR提出單位最高主管錯誤，請通知資訊處 22714 張瀚云 處理，謝謝您!!&quot;);	 
	 }
 }//function dp_manager()
 
//Select 部門單位主管的上一層主管 SQL	 
function check_roleid(managerid){ 
	var SQL_b  = &quot;SELECT distinct(e.MEMID) as empcode, e.USERNAME,e.JOBTITLE,e.PAGER,substr(e.MAINROLEID,8,3)ROLEID &quot;;
        SQL_b += &quot;from  mem_geninf e  &quot;;
        SQL_b += &quot;where e.memid =&apos;&quot;+managerid+&quot;&apos; &quot;;
        SQL_b += &quot;and e.DENIEDLOGIN = &apos;false&apos; &quot;;
	var vec1 = Client.SQLloadValue(SQL_b);
	
	if (vec1.size()&gt;0){
  	    var memid = vec1.get(0).get(&quot;empcode&quot;);
		var managerid = vec1.get(0).get(&quot;PAGER&quot;);
	    var roleid = java.lang.Integer.parseInt(vec1.get(0).get(&quot;ROLEID&quot;));
		
		if (roleid &lt; 82){
            check_roleid(managerid);
		}else{
			 Form.setValue(&quot;Top_App_Manager_ID&quot;,memid );
		}
	}//if (vec1.size()&gt;0)
}//function check_roleid()
 
function check_Form(SignTable,msg){
  if( Form.getValue(&quot;Sn&quot;) == &quot;&quot; ){
	  msg += &quot;此MECN 無單號，無法正常送出，請通知資訊處處理，謝謝您!!!\n&quot;;
  }
  if( Form.getValue(&quot;design-t&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;design-s&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;design-c&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;design-h&quot;) != &quot;true&quot; ){
	  msg += &quot;請至少選擇一筆相關廠別!\n&quot;;
  }
  //* 料號
  if( Form.getValue(&quot;item_no&quot;) == &quot;&quot;  ){
	  msg += &quot;請輸入料號!\n&quot;;
  }	
  //* 一.變更範圍
  //* MECN 類別 
  if( Form.getValue(&quot;FLOWTYPE&quot;).trim().length() &gt; 0 ){	
	  var	FLOWTYPE=Form.getValue(&quot;FLOWTYPE&quot;).substring(0,2);
	  //檢查【一.變更範圍】各別類型的必填欄位
	    msg += check_FLOWTYPE(FLOWTYPE,msg);	
//        msg +=		&quot;1&quot;;
  }else{
		msg += &quot;請選擇(變更範圍)項目!\n&quot;;
  }
  //* 變更理由		
  if( Form.getValue(&quot;FTextArea0&quot;) == &quot;&quot;  ){
	  msg += &quot;請輸入變更理由!\n&quot;;
  }	
  //* 變更對象
  if( Form.getValue(&quot;FCheckBox_s1&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox_s2&quot;) != &quot;true&quot; &amp;&amp;  Form.getValue(&quot;FCheckBox_s3&quot;) != &quot;true&quot; ){
	  msg += &quot;請至少選擇一筆變更對象!\n&quot;;
  }else{
		var table = Form.getComponent(&quot;ITEM_Rev_Table_P&quot;);
	    var row = table.getRowCount();
		if (Form.getValue(&quot;FCheckBox_s1&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextArea_s1&quot;) == &quot;&quot;){
			msg += &quot;(變更對象)By系列別變更 - 說明必須輸入!\n&quot;;
	    }
		if (Form.getValue(&quot;FCheckBox_s2&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextArea_s2&quot;) == &quot;&quot;){
			msg += &quot;(變更對象)與料號無關 - 說明必須輸入!\n&quot;;
		}
		if (Form.getValue(&quot;FCheckBox_s3&quot;) == &quot;true&quot; &amp;&amp; row &lt;= 0 ){
			msg += &quot;(變更對象)By個別料號 - 個別料號至少必須輸入一筆!\n&quot;;
		}
   }	
   //* 變更內容	
   if( Form.getValue(&quot;FTextArea2&quot;) == &quot;&quot;  ){
	   msg += &quot;請輸入變更內容!\n&quot;;
   }
 
   // 與產能相關
	if(Form.getValue(&quot;FRadioButton_w21&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FRadioButton_w22&quot;) != &quot;true&quot; ){
		msg += &quot;請選擇產能項目\n&quot;;
	}else if(Form.getValue(&quot;FRadioButton_w22&quot;) == &quot;true&quot;){
		   if(Form.getValue(&quot;FRadioButton_w22&quot;) == &quot;true&quot; &amp;&amp; ( Form.getValue(&quot;TextField_w22&quot;) == &quot;&quot; || Form.getValue(&quot;TextField_w23&quot;) == &quot;&quot; )){
				  msg += &quot;請確實填寫影響設備與產能計算結果\n&quot;;
		   }else{
			      if(Form.getValue(&quot;FRadioButton_w23&quot;)!= &quot;true&quot;  &amp;&amp; Form.getValue(&quot;FRadioButton_w24&quot;) != &quot;true&quot; ){
				       msg += &quot;請填寫產能是否足夠\n&quot;;
		          }else{
						 if( Form.getValue(&quot;FRadioButton_w24&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;TextField_w24&quot;) == &quot;&quot; ){
				            msg += &quot;請填寫產能不足夠的對策\n&quot;;
		                 }
				  }
	      }
	}
   
   //* MECN 品質相關要求_List
   if( Form.getValue(&quot;MECN_file_name&quot;) == &quot;&quot;  ){
	   msg += &quot;請輸入MECN 品質相關要求_List的檔案名稱\n&quot;;
   }	
   //* 在製品處理方式
   if( Form.getValue(&quot;FRadioButton_w41&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FRadioButton_w42&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FRadioButton_w43&quot;) != &quot;true&quot; &amp;&amp;  Form.getValue(&quot;FRadioButton_w44&quot;) != &quot;true&quot;   ){
	   msg += &quot;請選擇(在製品處理方式)!\n&quot;;
   }else{
		  if (Form.getValue(&quot;FRadioButton_w42&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField_w42&quot;) == &quot;&quot;){
			  msg += &quot;(在製品處理方式)在製品站別必須輸入!\n&quot;;
		  }
	      if (Form.getValue(&quot;FRadioButton_w43&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField_w43&quot;) == &quot;&quot;){
			  msg += &quot;(在製品處理方式)說明必須輸入!\n&quot;;
		  }
   }
   if (SignTable.size() &gt; 0){ 
	   if( Form.getValue(&quot;Verify_Note&quot;) == &quot;&quot; ){
		   msg += &quot;此表單被主管退回,請填寫[簽核意見]再完成送出!\n或勾選作廢按完成結束流程!!&quot;;
	   }
   }	
   	return msg ;	
}//function check_Form() 

function check_FLOWTYPE(FLOWTYPE,msg){
	var table_MFG = Form.getComponent(&quot;MFG_AddAs_Table&quot;);
    if(FLOWTYPE.equals(&quot;A類&quot;)){
	   for(var i=1;i&lt;21;i++){ 
	       var temp_checkbox = &quot;FCheckBox_a&quot; + i; 
		   if (temp_checkbox == &quot;FCheckBox_a4&quot;){
				if(Form.getValue(temp_checkbox+&quot;_1&quot;).equals(&quot;true&quot;) || Form.getValue(temp_checkbox+&quot;_2&quot;).equals(&quot;true&quot;)){
                   var temp=&quot;true&quot;;
				}
		   }else{	 
	              if(Form.getValue(temp_checkbox).equals(&quot;true&quot;)){
                     var temp=&quot;true&quot;;
                  }
			}	
	     }//for 
 	    if(temp!=&quot;true&quot;){
	       msg += &quot;A類:請至少勾選一筆相關原因!\n&quot;;
		}else{
			  if( Form.getValue(&quot;FCheckBox_a18&quot;) == &quot;true&quot; &amp;&amp;  Form.getValue(&quot;FLabel_a1&quot;) == &quot;&quot; ){
				  msg += &quot;(導入標準化文件)文件編號必須輸入!\n&quot;;
			  }
			  if( Form.getValue(&quot;FCheckBox_a19&quot;) == &quot;true&quot; &amp;&amp;  Form.getValue(&quot;FLabel_a3&quot;) == &quot;&quot; ){
				  msg += &quot;(設計準則編號)設計準則編號必須輸入!\n&quot;;
			  }
			  if( Form.getValue(&quot;FCheckBox_a18&quot;) == &quot;true&quot; &amp;&amp; ( Form.getValue(&quot;FLabel_a1&quot;) != &quot;&quot;&amp;&amp; Form.getValue(&quot;FTextField_a2&quot;) == &quot;&quot;)){
				  msg += &quot;導入標準化文件, 需填寫修改章節!\n&quot;;
			  }
			  if( Form.getValue(&quot;FCheckBox_a19&quot;) == &quot;true&quot; &amp;&amp; (Form.getValue(&quot;FLabel_a3&quot;) != &quot;&quot; &amp;&amp; Form.getValue(&quot;FTextField_a4&quot;) == &quot;&quot;)){
				  msg += &quot;設計準則編號, 需填寫修改章節!\n&quot;;
			  }	
			  if( Form.getValue(&quot;FCheckBox_a20&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField_a5&quot;) == &quot;&quot; ){
				  msg += &quot;(其他)說明必須輸入!\n&quot;;
			  }
		 }
		 if( Form.getValue(&quot;FTextArea4&quot;) == &quot;&quot;  ){
			 msg += &quot;A類必需輸入【二.試作批實驗計畫】!\n&quot;;
		 }
		 if (table_MFG.getRowCount()&lt;=0){
			 msg += &quot;A類必需新增【(相關製造部)會簽人員 】!\n&quot;;
		 }
		 //* 變更類別
         if( Form.getValue(&quot;mecn_type&quot;).trim().length()&lt;=0   ){
	         msg += &quot;A類:必需選擇變更類別!\n&quot;;
        } 
	}else if(FLOWTYPE.equals(&quot;B類&quot;)){
		if( Form.getValue(&quot;FCheckBox_b1_1&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox_b1_2&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox_b2&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox_b3&quot;) != &quot;true&quot; ){
			msg += &quot;B類:請至少勾選一筆相關原因!\n&quot;;
		}else{
				if( Form.getValue(&quot;FCheckBox_b3&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField_b1&quot;) == &quot;&quot; ){
					msg += &quot;(B類變更範圍)說明必須輸入!\n&quot;;
				}	
		}
        if (table_MFG.getRowCount()&lt;=0){
			msg += &quot;B類必需新增【(相關製造部)會簽人員 】!\n&quot;;
		}	
		//* 變更類別
         if( Form.getValue(&quot;mecn_type&quot;).trim().length()&lt;=0   ){
	         msg += &quot;B類:必需選擇變更類別!\n&quot;;
        } 
	}else if(FLOWTYPE.equals(&quot;C1&quot;)){	
			 if( Form.getValue(&quot;FCheckBox_c11&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox_c12&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox_c13&quot;) != &quot;true&quot;){
				 msg += &quot;C1類:請至少勾選一筆相關原因!\n&quot;;
			 }
			 //【文件前版處置方式】、【新文件處置方式】
              msg += check_FLOWTYPE_c(msg);
	}else if(FLOWTYPE.equals(&quot;C2&quot;)){
			 if( Form.getValue(&quot;FCheckBox_c21&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox_c22&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox_c23&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox_c24&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox_c25&quot;) != &quot;true&quot;){
				 msg += &quot;C2類:請至少勾選一筆相關原因!\n&quot;;
			 }
			 if( Form.getValue(&quot;FCheckBox_c23&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField_c23&quot;) == &quot;&quot; ){		
				 msg += &quot;Test說明必須輸入!\n&quot;;
			 }				 
			 if( Form.getValue(&quot;FCheckBox_c25&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField_c25&quot;) == &quot;&quot; ){		
				 msg += &quot;(樣品條件變更,變更範圍)說明必須輸入!\n&quot;;
			 }		
			 if (table_MFG.getRowCount()&lt;=0 ){
				 msg += &quot;C2類必需新增【(相關製造部)會簽人員 】!\n&quot;;
			 } 
			 //【文件前版處置方式】、【新文件處置方式】
			 msg += check_FLOWTYPE_c(msg);

	 }else if(FLOWTYPE.equals(&quot;C3&quot;)){
			  if (table_MFG.getRowCount()&lt;=0 ){
				  msg += &quot;C3類必需新增【(相關製造部)會簽人員 】!\n&quot;;
			  }
			  //【文件前版處置方式】、【新文件處置方式】
			  msg += check_FLOWTYPE_c(msg);	
	 }
	 return msg ;
}//check_FLOWTYPE(FLOWTYPE)

function check_FLOWTYPE_c(msg){			
	if( Form.getValue(&quot;FRadioButton_w51&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FRadioButton_w52&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FRadioButton_w53&quot;)!= &quot;true&quot; )	{
//		msg += &quot;請選擇(文件前版處置方式)!\n&quot;;
		msg += &quot;Test!\n&quot;;
	  }else{
	        if (Form.getValue(&quot;FRadioButton_w51&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField_w51&quot;) == &quot;&quot;){
		        msg += &quot;(文件前版處置方式)作廢文件必須輸入No!\n&quot;;			
	            }
	        if (Form.getValue(&quot;FRadioButton_w53&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField_w53&quot;) == &quot;&quot;){
		        msg += &quot;(文件前版處置方式)說明必須輸入!\n&quot;;
               } 
	  }
	 if( Form.getValue(&quot;FCheckBox0&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox1&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox2&quot;) != &quot;true&quot; &amp;&amp;  Form.getValue(&quot;FCheckBox3&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox4&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox5&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FCheckBox7&quot;) != &quot;true&quot; )	{
		msg += &quot;請至少選擇(新文件處置方式)!\n&quot;;
	 }else{
	       if( Form.getValue(&quot;FCheckBox0&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField0&quot;) == &quot;&quot; ){
			   msg += &quot;(立即生效須傳承)說明必須輸入!\n&quot;;
			 }
		   if( Form.getValue(&quot;FCheckBox2&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField6&quot;) == &quot;&quot; ){
			   msg += &quot;(新料號與舊料號逐步導入,優先導入料號)說明必須輸入!\n&quot;;
			 }
		   if( Form.getValue(&quot;FCheckBox3&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField9&quot;) == &quot;&quot; ){
			   msg += &quot;(立即生效不傳承WIP之處置)說明必須輸入!\n&quot;;
			 }
		   if( Form.getValue(&quot;FCheckBox5&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField11&quot;) == &quot;&quot; ){
			   msg += &quot;(REV變更後不傳承WIP之處置)說明必須輸入!\n&quot;;
			 }
		   if( Form.getValue(&quot;FCheckBox7&quot;) == &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField12&quot;) == &quot;&quot; ){
			   msg += &quot;(新文件處置方式其他)說明必須輸入!\n&quot;;
			}				
		}
		return msg;
  }//function check_FLOWTYPE_c()	
  
function clear_Asign_Table(){
	//Local_QAE會簽群組
	  Form.getComponent(&quot;MemTable_Local_QAE&quot;).clear();	
 	  Form.getComponent(&quot;MemTable_Local_QAE_G&quot;).clear();	
	//Tech V.P.會簽群組
	  Form.getComponent(&quot;MemTable_Tech_VP&quot;).clear();	
 	  Form.getComponent(&quot;MemTable_Tech_VP_G&quot;).clear();					  
	//MECN 各部門主管會簽群組	 
	  Form.getComponent(&quot;MemTable_DP_Sign&quot;).clear();			
	  Form.getComponent(&quot;MemTable_DP_Sign_G&quot;).clear();	
	//DE執行會簽群組 		
	  Form.getComponent(&quot;MemTable_DE&quot;).clear();	
	  Form.getComponent(&quot;MemTable_DE_G&quot;).clear();
	//DE主管執行作廢會簽群組	
	  Form.getComponent(&quot;MemTable_DE_M&quot;).clear();	
	  Form.getComponent(&quot;MemTable_DE_M_G&quot;).clear();
	//QA經副理會簽群組
	  Form.getComponent(&quot;MemTable_QA_M&quot;).clear();
 	  Form.getComponent(&quot;MemTable_QA_M_G&quot;).clear();
	//MFG 經副理和廠務會簽群組	
      Form.getComponent(&quot;MemTable_FC_M&quot;).clear();
	  Form.getComponent(&quot;MemTable_FC_M_G&quot;).clear();
	//QC會簽鎖帳群組	
      Form.getComponent(&quot;MemTable_QC&quot;).clear();
	  Form.getComponent(&quot;MemTable_QC_G&quot;).clear();
	//Mail群組	
      Form.getComponent(&quot;Mail_Group&quot;).clear();						  
	//它廠製工會簽，無勾選【相關廠別】的廠別，於A、B類第三階，C類第一階，文件發行之後會簽
	//Mail群組	
      Form.getComponent(&quot;MemTable_other_MFG_M&quot;).clear();	
}//function clear_Asign_Table()	

function insert_Asign_Table(process_name){
  var select_factory =&quot;&quot;;// 設定他廠會簽人員 
  var FLOWTYPE=Form.getValue(&quot;FLOWTYPE&quot;).substring(0,2);
  // TGCE
	 if( Form.getValue(&quot;design-t&quot;) == &quot;true&quot; ){
	     var v_factory =&quot;TGCE&quot;;
 		 var select_factory =&quot;&apos;TGCE&apos;&quot;;
		     Asign_Table(v_factory,FLOWTYPE,process_name,&quot;&quot;);				
//		     //For MECN 處長簽核- 郭天一
//		     if (Form.getValue(&quot;design-t&quot;) == &quot;true&quot; ){ 
//                 addAsignList(&quot;TGCE&quot;,&quot;PLM_QA_SC_M&quot;,&quot;MemberTable_T_QA_SC&quot;);   
//             } 
	  }	
  // SGCE
     if( Form.getValue(&quot;design-s&quot;) == &quot;true&quot; ){
	     var v_factory =&quot;SGCE&quot;;
			 if (select_factory ==&quot;&quot;){
 		         var select_factory =&quot;&apos;SGCE&apos;&quot;;
             }else{
				   select_factory +=&quot;,&apos;SGCE&apos;&quot;;
			 }								 
		  Asign_Table(v_factory,FLOWTYPE,process_name,&quot;&quot;);
     }
   // CGCE
	  if( Form.getValue(&quot;design-c&quot;) == &quot;true&quot; ){
	     var v_factory =&quot;CGCE&quot;;
			 if (select_factory ==&quot;&quot;){
 		         var select_factory =&quot;&apos;CGCE&apos;&quot;;
             }else{
		   		   select_factory +=&quot;,&apos;CGCE&apos;&quot;;
			 }									 
         Asign_Table(v_factory,FLOWTYPE,process_name,&quot;&quot;);
      }
   // HGCE
	  if( Form.getValue(&quot;design-h&quot;) == &quot;true&quot; ){
		  var v_factory =&quot;HGCE&quot;;
              if (select_factory ==&quot;&quot;){
 				  var select_factory =&quot;&apos;HGCE&apos;&quot;;
              }else{
				    select_factory +=&quot;,&apos;HGCE&apos;&quot;;
			  }										 
          Asign_Table(v_factory,FLOWTYPE,process_name,&quot;&quot;);
	  }
	  
	 Asign_Table(v_factory,FLOWTYPE,process_name,select_factory);	
	 
}//function insert_Asign_Table()

function Asign_Table(v_factory,FLOWTYPE,process_name,select_factory){
	 try{
		 loadLibrary(&quot;com.gce.PLM.Common.Client.addAsignTable&quot;);
         var customer_id = &quot;ALL&quot;;
		  try{
		      customer_id = Form.getValue(&quot;item_no&quot;).substring(0,3); 
		  }catch(e){
			  var customer_id = &quot;ALL&quot;;
		      java.lang.System.out.println(&quot;MECN_error=&quot;+e);
		  }
        if (process_name.indexOf(&quot;申請人&quot;)&gt;=0 || process_name == &quot;Local QAE審核&quot;){
	      var PLM_OPM_ROLE = &quot;PLM_OPM&quot; ;
		  
		  if (process_name.indexOf(&quot;申請人&quot;)&gt;=0){
			if(select_factory !=&quot;&quot;){
		  	 //它廠製工會簽，無勾選【相關廠別】的廠別，於A、B類第三階，C類第一階，文件發行之後會簽
//			   if(FLOWTYPE.indexOf(&quot;C&quot;)&gt;=0){
//                 if( Form.getValue(&quot;FCheckBox_c14&quot;) == &quot;true&quot;){					  
//		         addAsign_MECN_MFG(v_factory,&quot;PLM_MECN_MFG&quot;,&quot;MemTable_other_MFG_M&quot;,select_factory);     
//				 }
//	           }	 
	        }else{
              var dep_id = Form.getValue(&quot;App_Dep_ID&quot;);
              var app_dep= Form.getValue(&quot;App_Dep&quot;);			  
		  
		      if((dep_id.indexOf(&quot;2J&quot;)&gt;=0 &amp;&amp; app_dep.indexOf(&quot;HDI&quot;)&gt;=0)||(dep_id.indexOf(&quot;2R&quot;)&gt;=0 &amp;&amp; app_dep.indexOf(&quot;HDI&quot;)&gt;=0)){
		         addAsignList(&quot;HGCE&quot;,&quot;PLM_OP&quot;,&quot;Mail_Group&quot;);     //2J0:HDI工程技術處” 開出來的MECN ，DE OP 執行的同時，需發MAIL 通知 HGCE DE群組(5901DE工程問題).
		      }

			  if(FLOWTYPE.equals(&quot;A類&quot;)){
		         addAsign_DEP_VP_MAX(v_factory,&quot;PLM_VP&quot;,&quot;MemTable_FC_M&quot;);     //VP
	             addAsign_DEP_FC_MAX(v_factory,&quot;PLM_MFG&quot;,&quot;MemTable_FC_M&quot;);    //ME最高主管  ex:高國明 廠長 //廠務最高主管	
		         addAsignList(v_factory,&quot;PLM_QC_Lock&quot;,&quot;MemTable_QC&quot;);             //QC 鎖帳會簽人員
				 addAsignList_Tech_VP(v_factory,dep_id,&quot;MemTable_Tech_VP&quot;);  //Tech_VP 會簽人員
		      }
	          if(FLOWTYPE.equals(&quot;B類&quot;)){
		         addAsign_DEP_VP_MAX(v_factory,&quot;PLM_VP&quot;,&quot;MemTable_FC_M&quot;);     //VP
       	         addAsign_DEP_FC_MAX(v_factory,&quot;PLM_MFG&quot;,&quot;MemTable_FC_M&quot;);    //ME最高主管  ex:高國明 廠長 //廠務最高主管
		         addAsignList(v_factory,&quot;PLM_QC_Lock&quot;,&quot;MemTable_QC&quot;);             //QC 鎖帳會簽人員
				 addAsignList_Tech_VP(v_factory,dep_id,&quot;MemTable_Tech_VP&quot;);  //Tech_VP 會簽人員
              } 
		      if(FLOWTYPE.equals(&quot;A類&quot;) ||FLOWTYPE.equals(&quot;B類&quot;) ||FLOWTYPE.equals(&quot;C2&quot;) ||FLOWTYPE.equals(&quot;C3&quot;)){
		         PLM_OPM_ROLE = &quot;PLM_OPM_A_TYPE&quot;;
		         addAsignList(v_factory,&quot;PLM_QAE&quot;,&quot;MemTable_Local_QAE&quot;);       //QA Local
	          }
		      if(FLOWTYPE.equals(&quot;A類&quot;) ||FLOWTYPE.equals(&quot;B類&quot;)||FLOWTYPE.equals(&quot;C2&quot;)||FLOWTYPE.equals(&quot;C3&quot;)){
		         addAsignList(v_factory,&quot;PLM_QA_M&quot;,&quot;MemTable_QA_M&quot;);           //QA M經理(all)
              }
		      if(FLOWTYPE.equals(&quot;A類&quot;) ||FLOWTYPE.equals(&quot;B類&quot;)){
					addAsignList(v_factory,&quot;PLM_OPM_A_TYPE&quot;,&quot;MemTable_DE_M&quot;);         //DE  單位主管 - DE審核、作廢會簽
	          }else{
					addAsignList(v_factory,&quot;PLM_OPM&quot;,&quot;MemTable_DE_M&quot;);         //DE  單位主管 - DE審核、作廢會簽
		      }
			  if(FLOWTYPE.equals(&quot;C3&quot;)){
		         addAsignList(v_factory,&quot;PLM_QC_Lock&quot;,&quot;MemTable_QC&quot;);             //QC 鎖帳會簽人員
	          }
			   
		      //全部類別均需會簽
	          addAsignList(v_factory,&quot;PLM_OP&quot;,&quot;MemTable_DE&quot;);               //DE 會簽人員
			  
		  }//if (process_name.indexOf(&quot;申請人&quot;)&gt;=0)
		  
		  //***************************************//
		  //MECN 各部門主管會簽群組
		  //**************************************//
		  
		  //目前將抓取【文件標題】包含【LCD】字眼的MECN 單		
		  if(Form.getValue(&quot;Subject&quot;).indexOf(&quot;LCD&quot;)!=&quot;-1&quot;){	
			addAsignCustomer(&quot;SGCE&quot;,&quot;PLM_PM&quot;,&quot;MemTable_DP_Sign&quot;,&quot;LCD&quot;);
		   }
		   
		  if(FLOWTYPE.equals(&quot;A類&quot;)){
		     addAsignList(v_factory,&quot;PLM_QC&quot;,&quot;MemTable_DP_Sign&quot;);          //QC  單位主管
		  }
	      if(FLOWTYPE.equals(&quot;B類&quot;)){
		     addAsignCustomer(v_factory,&quot;PLM_PM&quot;,&quot;MemTable_DP_Sign&quot;,customer_id);	 //PM by Account	
		     addAsignCustomer(v_factory,&quot;PLM_CS&quot;,&quot;MemTable_DP_Sign&quot;,customer_id);   //CS by Account	
          }
		  if(FLOWTYPE.equals(&quot;B類&quot;) ||FLOWTYPE.equals(&quot;C2&quot;) ||FLOWTYPE.equals(&quot;C3&quot;)){
			 addAsignList(v_factory,&quot;PLM_QC&quot;,&quot;MemTable_DP_Sign&quot;);          //QC  單位主管
		     addAsignList(v_factory,&quot;PLM_QA_SC&quot;,&quot;MemTable_DP_Sign&quot;);       //QAE 單位主管 
	      } 

		  //當勾選【量產物料-單次】、【量產物料-永久】，會簽至 IE / 採購 /物管  
		  if( Form.getValue(&quot;FCheckBox_a4_1&quot;) == &quot;true&quot; || Form.getValue(&quot;FCheckBox_a4_2&quot;) == &quot;true&quot; || Form.getValue(&quot;FCheckBox_b1_1&quot;) == &quot;true&quot;|| Form.getValue(&quot;FCheckBox_b1_2&quot;) == &quot;true&quot;|| Form.getValue(&quot;FCheckBox_c26&quot;) == &quot;true&quot; ){
			  addAsignList(v_factory,&quot;PLM_Purchasing_M&quot;,&quot;MemTable_DP_Sign&quot;);   //Purchasing Department經理(all)
			  addAsignList(v_factory,&quot;PLM_IE_M&quot;,&quot;MemTable_DP_Sign&quot;);           //IE M經理(all)
			  addAsignList(v_factory,&quot;PLM_MA_M&quot;,&quot;MemTable_DP_Sign&quot;);            //物管
		  } 
		  
		  //當勾選【UL(製程溫度&gt;100度)】，會簽至材料 
		  if( (Form.getValue(&quot;FCheckBox_a11&quot;) == &quot;true&quot; || Form.getValue(&quot;FCheckBox_b2&quot;) == &quot;true&quot; || Form.getValue(&quot;FCheckBox_c27&quot;) == &quot;true&quot; ) &amp;&amp; v_factory == &quot;SGCE&quot;){
			  addAsignList(&quot;SGCE&quot;,&quot;PLM_MT_E&quot;,&quot;MemTable_DP_Sign&quot;);            //材料
		  }else if( Form.getValue(&quot;FCheckBox_a11&quot;) == &quot;true&quot; || Form.getValue(&quot;FCheckBox_b2&quot;) == &quot;true&quot; || Form.getValue(&quot;FCheckBox_c27&quot;) == &quot;true&quot;  ){
			  addAsignList(&quot;TGCE&quot;,&quot;PLM_MT_E&quot;,&quot;MemTable_DP_Sign&quot;);            //材料
		  }
		  
 	     //當勾選 四、在製品處理方式 - 【需要清線不可跟前板混用】
		  if(Form.getValue(&quot;FRadioButton_w44&quot;) == &quot;true&quot;){
			  addAsignList(v_factory,&quot;PLM_PC_M&quot;,&quot;MemTable_DP_Sign&quot;);   //生管
			  Form.setValue(&quot;PC_Flag&quot;,&quot;Y&quot;);	 //生管會簽Flag
		  }	  
		  
		 //Local QAE 若填寫&quot;不符合客規&quot;, 則流程需簽到PM與QA最高主管 
	     if (process_name.indexOf(&quot;Local QAE審核&quot;)&gt;=0){  

	        if( ( FLOWTYPE.equals(&quot;A類&quot;) || FLOWTYPE.equals(&quot;C2&quot;) ||FLOWTYPE.equals(&quot;C3&quot;)) &amp;&amp; Form.getValue(&quot;FRadioButton_w33&quot;)== &quot;true&quot;){
			    addAsignCustomer(v_factory,&quot;PLM_PM&quot;,&quot;MemTable_DP_Sign&quot;,customer_id);	 //PM by Account	
            }
			Source_Ins.setAppValue(&quot;MemTable_DP_Sign&quot;,Form.getValue(&quot;MemTable_DP_Sign&quot;));
			Source_Ins.setAppValue(&quot;MemTable_DP_Sign_G&quot;,Form.getValue(&quot;MemTable_DP_Sign_G&quot;));

		  }//if (process_name.indexOf(&quot;Local QAE審核&quot;)&gt;=0)
		 }//if(select_factory !=&quot;&quot;){  
	    }//if (process_name.indexOf(&quot;申請人&quot;)&gt;=0 || process_name == &quot;Local QAE審核&quot;)
	  }catch(e){
		java.lang.System.out.println(&quot;PLM_MECN_AsignMember_error=&quot;+e);
    }  
  }//function Asign_Table()
  
function check_process(Source_Ins,process_name,temp,msg){
   //*************************************************************
   //簽核選項為【Agree&quot;】同意 
   //*************************************************************	
	if (temp==&quot;Agree&quot;){
	    //*************************************************************
        //當流程關卡名稱包含【Local QAE審核】時，必需填寫【是否符合客戶規定】選項
		//*************************************************************
	    if(process_name.indexOf(&quot;Local QAE審核&quot;)&gt;=0 ){
	       if (Form.getValue(&quot;FRadioButton_w31&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FRadioButton_w32&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;FRadioButton_w33&quot;)!= &quot;true&quot;){	
		        msg +=&quot;必需填寫是否符合客戶規定，請您確認!\n&quot;;
		   }
	       if ( Form.getValue(&quot;FRadioButton_w33&quot;)== &quot;true&quot; &amp;&amp; Form.getValue(&quot;FTextField_w33&quot;)== &quot;&quot;){	
			    msg +=&quot;選則【不符合，客規規定】，必需填寫原因，請您確認!\n&quot;;
	       }
		   if(msg != &quot;&quot;){
				        showmsg(msg);
		   }else{  
				//Local QAE 若填寫&quot;不符合客規&quot;, 則流程需簽到PM與QA最高主管 
//	              if ( Form.getValue(&quot;FRadioButton_w33&quot;)== &quot;true&quot;){
				       //MECN 各部門主管會簽群組	 
	                     Form.getComponent(&quot;MemTable_DP_Sign&quot;).clear();			
	                     Form.getComponent(&quot;MemTable_DP_Sign_G&quot;).clear();	
						 // 設定相關單位會簽人員 
						 insert_Asign_Table(process_name);
//				   }//Local QAE 若填寫&quot;不符合客規&quot;, 則流程需簽到PM與QA最高主管  --End		
						
					Source_Ins.setAppValue(&quot;FRadioButton_w31&quot;,Form.getValue(&quot;FRadioButton_w31&quot;));  
					Source_Ins.setAppValue(&quot;FRadioButton_w32&quot;,Form.getValue(&quot;FRadioButton_w32&quot;));
					Source_Ins.setAppValue(&quot;FRadioButton_w33&quot;,Form.getValue(&quot;FRadioButton_w33&quot;));
					Source_Ins.setAppValue(&quot;FTextField_w33&quot;,Form.getValue(&quot;FTextField_w33&quot;));			
						
	               }//if(msg == &quot;&quot;) --End   
	     }//當流程關卡名稱包含【Local QAE審核】時，必需填寫【是否符合客戶規定】選項 -- End
			  
		//*************************************************************
	    //當流程關卡名稱包含【MECN各部門主管審核】，並且FLabel18為(&quot;您已設定《小黃加會簽》,請按【完成】將表單送出!若要取消請再按一次《小黃加會簽》將人員刪除按【確定】即可!&quot;)	  
	    //啟動加會簽流程
	    //loadLibrary(&quot;com.A.Common.Client.Action&quot;); -&gt; okAction(); -&gt; chkIsAddAS();
	    //當 Form.getCurrentTask().isExecuteAddAS() = true 時，會啟動系統加會簽
	    //*************************************************************
	    if(process_name.indexOf(&quot;MECN各部門主管審核&quot;)&gt;=0 || process_name.indexOf(&quot;DE&quot;)&gt;=0){ 
		   var depid = Client.getMember(Form.getValue(&quot;Verify_Name&quot;)).getRoleList().get(0).departmentID;	
		   //只限DE 部門人員可以使用【小黃加會簽】，抓取部門名稱有M 的，EX：2M1、2M2
			 if (depid.indexOf(&quot;M&quot;)&gt;=0){
			     if(Form.getValue(&quot;DE_Flag&quot;) !=&quot;Y&quot;){
				    if(MyTask.isExecuteAddAS()){
//if( Form.getComponent(&quot;FLabel18&quot;).getText()==&quot;您已設定《小黃加會簽》,請按【完成】將表單送出!若要取消請再按一次《小黃加會簽》將人員刪除按【確定】即可!&quot;)
			           //把提出加會簽的User，寫回母表單簽核記錄 
			             Source_Ins.setAppValue(&quot;Process_Table&quot;,Form.getValue(&quot;Process_Table&quot;));	
			             //-清空小黃加會簽名單---------
	                       Form.getComponent(&quot;AddAs_Table&quot;).clear();
	                       Form.setValue(&quot;SIGNMSG&quot;,&quot;&quot;); 
				           Form.setValue(&quot;DE_Flag&quot;,&quot;Y&quot;);
				           Source_Ins.setAppValue(&quot;DE_Flag&quot;,Form.getValue(&quot;DE_Flag&quot;));
						   
						   if(process_name.indexOf(&quot;作廢&quot;)&gt;=0 ){
							  Form.setValue(&quot;Verify_Note&quot;,&quot;作廢-DE加會簽&quot;); //不需全部重簽		
						   }
			         }	
			       }else{
					 Form.setComplete(false);
				     Form.showMessageDialog(&quot;已有DE會簽人員處理此單中，請勿再簽核此單，謝謝您!\n&quot;);
			      } 
				}else if(depid.indexOf(&quot;M&quot;)&lt;0 &amp;&amp; MyTask.isExecuteAddAS()){
				  	  Form.setComplete(false);
				      Form.showMessageDialog(&quot;僅DE人員有加會簽的權限，請勿再加會簽此單，謝謝您!\n&quot;);	
			    }  
				Source_Ins.setAppValue(&quot;MemTable_DE&quot;,Form.getValue(&quot;MemTable_DE&quot;));	
				
        }//啟動加會簽流程 --End
		
		//*************************************************************
        //當流程關卡名稱包含【DE執行】時，check申請人是否離職
		//*************************************************************			  
		  if(process_name == &quot;DE執行&quot;){ 
			 loadLibrary(&quot;com.A.Common.Client.Action&quot;); 
			 if(chkIsRESIGN()){
				var member  = Client.getMember(Form.getValue(&quot;App_MemID&quot;));
				    if(!member.getDeputyState()|| Client.getMember(member.getDeputyID())== null ){
					   	Form.setComplete(false);
				        Form.showMessageDialog(&quot;此MECN單,申請人已離職，請您通知資訊處協助處理轉單，謝謝您!\n&quot;);	
					 }					 
	         }
		  }//當流程關卡名稱包含【DE執行】時，check申請人是否離職 -- End
		  
	      //*************************************************************
          //當流程關卡名稱包含【填寫批號】時，回寫母表單
		  //*************************************************************
		  //開放填寫【變更對象】
		    if (process_name == &quot;填寫批號&quot;){
                var	FLOWTYPE=Form.getValue(&quot;FLOWTYPE&quot;).substring(0,2);				
				if((FLOWTYPE.equals(&quot;A類&quot;)||FLOWTYPE.equals(&quot;B類&quot;))&amp;&amp; Form.getValue(&quot;FCheckBox_s3&quot;)==&quot;true&quot;){
				var table = Form.getComponent(&quot;item_lot_no_table_p&quot;);	
	             if(table.getRowCount()&lt;=0){
				  	  Form.setComplete(false);					 
					  Form.showMessageDialog(&quot;此MECN單無選擇驗證批號，不能送出，請您確認，謝謝您!\n&quot;);	
				}
			   }
				Source_Ins.setAppValue(&quot;FCheckBox_s1&quot;,Form.getValue(&quot;FCheckBox_s1&quot;));
  				Source_Ins.setAppValue(&quot;FTextArea_s1&quot;,Form.getValue(&quot;FTextArea_s1&quot;));	
				Source_Ins.setAppValue(&quot;FCheckBox_s2&quot;,Form.getValue(&quot;FCheckBox_s2&quot;));
				Source_Ins.setAppValue(&quot;FTextArea_s2&quot;,Form.getValue(&quot;FTextArea_s2&quot;));	
				Source_Ins.setAppValue(&quot;FCheckBox_s3&quot;,Form.getValue(&quot;FCheckBox_s3&quot;));
			    Source_Ins.setAppValue(&quot;ITEM_Rev_Table_P&quot;,Form.getValue(&quot;ITEM_Rev_Table_P&quot;));	
  				Source_Ins.setAppValue(&quot;item_lot_no_table_p&quot;,Form.getValue(&quot;item_lot_no_table_p&quot;));			   
             }// if (process_name == &quot;填寫批號&quot;)-- End
		  
	      //*************************************************************
          //當流程關卡名稱包含【QC鎖帳通知】時，回寫母表單
		  //*************************************************************
		  //開放填寫【變更對象】
		    if (process_name == &quot;QC鎖帳通知&quot;){
				Source_Ins.setAppValue(&quot;FCheckBox_s1&quot;,Form.getValue(&quot;FCheckBox_s1&quot;));
  				Source_Ins.setAppValue(&quot;FTextArea_s1&quot;,Form.getValue(&quot;FTextArea_s1&quot;));	
				Source_Ins.setAppValue(&quot;FCheckBox_s2&quot;,Form.getValue(&quot;FCheckBox_s2&quot;));
				Source_Ins.setAppValue(&quot;FTextArea_s2&quot;,Form.getValue(&quot;FTextArea_s2&quot;));	
				Source_Ins.setAppValue(&quot;FCheckBox_s3&quot;,Form.getValue(&quot;FCheckBox_s3&quot;));
			    Source_Ins.setAppValue(&quot;ITEM_Rev_Table_P&quot;,Form.getValue(&quot;ITEM_Rev_Table_P&quot;));	
  				Source_Ins.setAppValue(&quot;item_lot_no_table_p&quot;,Form.getValue(&quot;item_lot_no_table_p&quot;));
//				var table = Form.getValue(&quot;item_lot_no_table_p&quot;);
				var table = Form.getComponent(&quot;item_lot_no_table_p&quot;);	
	                if(table.getRowCount()&gt;0){
		             for(var i=0;i&lt;table.getRowCount();i++){
						 if(table.getValueAt(i,&quot;次數&quot;).trim()==&quot;&quot;){
						    var temp_flag =&quot;Y&quot; ;
						 }
	              	}	
					if(temp_flag !=&quot;Y&quot;){ 
				         //MES IPQC 鎖帳 
				         loadLibrary(&quot;com.gce.PLM.Common.Client.EDI_MES&quot;);
                         MECN_IPQC_Lock(&quot;item_lot_no_table_p&quot;,&quot;MECN_SP_List&quot;);
						 Form.showMessageDialog(&quot;系統自動建立IPQC鎖帳完成，請您確認，謝謝您!\n&quot;);
				    }else{
					      Form.showMessageDialog(&quot;此MECN單無進站次數，需手動建立IPQC鎖帳，請您確認，謝謝您!\n&quot;);	
				    }
                  }
             }// if (process_name == &quot;QC鎖帳通知&quot;)-- End
	}else if(temp==&quot;Reject&quot;){
   //*************************************************************
   //簽核選項為【Reject】駁回  
   //*************************************************************	
	  if(process_name.indexOf(&quot;作廢&quot;)&gt;=0  || process_name == &quot;提出單位最高主管&quot; || process_name ==&quot;填寫批號&quot;){
		 //清空 駁回選擇：(不需全部重簽) 所記錄欄位
		 Form.setValue(&quot;Process_ID&quot;,&quot;&quot;);//紀錄目前關卡流程ID
		 Form.setValue(&quot;Process_Name&quot;,&quot;&quot;);//紀錄目前關卡流程Name
		 Form.setValue(&quot;Tsk_ID&quot;,&quot;&quot;);	//紀錄目前關卡Tsk_ID
		 Form.setValue(&quot;State_ID&quot;,&quot;&quot;);//紀錄目前關卡State_ID
		 Form.setValue(&quot;con_result&quot;,&quot;&quot;);
		 Form.setValue(&quot;Type&quot;,&quot;&quot;);
					
		 if( process_name.indexOf(&quot;DE&quot;)&gt;=0 ){ 
			//只限DE 部門人員可以使用【小黃加會簽】，抓取部門名稱有M 的，EX：2M1、2M2
			if(Form.getValue(&quot;DE_Flag&quot;) ==&quot;Y&quot;){
			   Form.setComplete(false);
			   Form.showMessageDialog(&quot;已有DE會簽人員將此單加會簽給主管中，請勿駁回此單，謝謝您!\n&quot;);
			} 
 	     }//DE加會簽流程 --End
					
	  }else{	 
			 if(Form.getValue(&quot;Mail_App_Flag&quot;)==&quot;&quot; &amp;&amp; Form.getValue(&quot;Verify_DE&quot;)!= &quot;true&quot;){
	            Form.setComplete(false);
		        Form.showMessageDialog(&quot;駁回此單前，請先執行【★請發文者來解釋★】，將此單mail 給發文者，待發文者解釋後，請您再次確認是否駁回此單，謝謝您!\n&quot;)
	         }else if(Form.getValue(&quot;Mail_App_Flag&quot;)==&quot;Y&quot; &amp;&amp; Form.getValue(&quot;Verify_DE&quot;)!= &quot;true&quot;){
					  Form.setComplete(false);
		              Form.showMessageDialog(&quot;此單已mail 給發文者，待發文者解釋，請您再次確認是否完成此單，《否》則按【暫停】，儲存此單資訊，《是》則再次按【完成】即可送出此單，謝謝您!\n&quot;)					 
//             		  Form.setValue(&quot;Mail_App_Flag&quot;,&quot;N&quot;);
			 }else{
					Form.setValue(&quot;Mail_App_Flag&quot;,&quot;&quot;);
					Source_Ins.setAppValue(&quot;Verify_ID&quot;,Form.getValue(&quot;Verify_ID&quot;));
	                Source_Ins.setAppValue(&quot;Verify_Name&quot;,Form.getValue(&quot;Verify_Name&quot;));
	 	          	Form.setValue(&quot;con_result&quot;,&quot;false&quot;);	 //駁回選擇預設值 false，表無【駁回選擇：(需要全部重簽)、(不需全部重簽) 】
					//當關卡有駁回選擇：(需要全部重簽)、(不需全部重簽)  
					  if(process_name == &quot;Local QAE審核&quot; || process_name == &quot;直屬主管審核&quot; || process_name == &quot;部門主管審核&quot; || process_name == &quot;QA最高主管審核&quot;|| process_name == &quot;總經理&quot;||process_name.indexOf(&quot;作廢&quot;)&gt;=0 ||process_name == &quot;提出單位最高主管&quot; ||process_name == &quot;QC鎖帳通知&quot;){	
                         if( process_name == &quot;Local QAE審核&quot;){	
                	         Source_Ins.setAppValue(&quot;FRadioButton_w31&quot;,Form.getValue(&quot;FRadioButton_w31&quot;));  
					         Source_Ins.setAppValue(&quot;FRadioButton_w32&quot;,Form.getValue(&quot;FRadioButton_w32&quot;));
	 				         Source_Ins.setAppValue(&quot;FRadioButton_w33&quot;,Form.getValue(&quot;FRadioButton_w33&quot;));
					         Source_Ins.setAppValue(&quot;FTextField_w33&quot;,Form.getValue(&quot;FTextField_w33&quot;));	
                         }
		              }else{
							//*************************************************************
	                        //當流程關卡名稱包含【DE】，並且FLabel18為(&quot;您已設定《小黃加會簽》,請按【完成】將表單送出!若要取消請再按一次《小黃加會簽》將人員刪除按【確定】即可!&quot;)	  
	                        //啟動加會簽流程
	                        //loadLibrary(&quot;com.A.Common.Client.Action&quot;); -&gt; okAction(); -&gt; chkIsAddAS();
	                        //當 Form.getCurrentTask().isExecuteAddAS() = true 時，會啟動系統加會簽
	                        //*************************************************************
	                          if( process_name.indexOf(&quot;DE&quot;)&gt;=0 ){ 
			                     //只限DE 部門人員可以使用【小黃加會簽】，抓取部門名稱有M 的，EX：2M1、2M2
			                       if(Form.getValue(&quot;DE_Flag&quot;) ==&quot;Y&quot;){
				  	                  Form.setComplete(false);
				                      Form.showMessageDialog(&quot;已有DE會簽人員將此單加會簽給主管中，請勿駁回此單，謝謝您!\n&quot;);
			                       } 
						         //當DE執行=&gt; 退回DE主管審核								 
						           if (Form.getValue(&quot;Verify_DE&quot;)== &quot;true&quot;){
					                   Form.setValue(&quot;RJ_DEM_Flag&quot;,&quot;Y&quot;);
					               }	
 	                           }//DE加會簽流程 --End
											
							   //駁回無選擇：(需要全部重簽)、(不需全部重簽) 
							     if (Form.getValue(&quot;Verify_R&quot;) != &quot;true&quot; &amp;&amp; Form.getValue(&quot;Verify_N&quot;)!= &quot;true&quot; &amp;&amp; Form.getValue(&quot;Verify_DE&quot;)!= &quot;true&quot;){
				                     Form.setComplete(false);
				                     Form.showMessageDialog(&quot;駁回時:請您選擇是否(需要全部重簽)還是(不需全部重簽)Thanks!\n&quot;);
				                 }else{
									   //駁回選擇：(需要全部重簽)、(不需全部重簽) 
							           Form.setValue(&quot;Process_ID&quot;,MyTask.getProcessID());//紀錄目前關卡流程ID
								       Form.setValue(&quot;Process_Name&quot;,MyTask.getProcessName());//紀錄目前關卡流程Name
					                   Form.setValue(&quot;Tsk_ID&quot;,MyTask.getID());	//紀錄目前關卡Tsk_ID
					                   Form.setValue(&quot;State_ID&quot;,MyTask.getArtInstance().getArtState().getID());//紀錄目前關卡State_ID
						
						               //駁回選擇：(需要全部重簽)
							  	      if( Form.getValue(&quot;Verify_R&quot;) == &quot;true&quot; ){
							              Form.setValue(&quot;con_result&quot;,&quot;true&quot;);	 //需全部重簽
							              Form.setValue(&quot;Type&quot;,&quot;repeat&quot;);	 //表單重工Status
						              }else{
								            Form.setValue(&quot;con_result&quot;,&quot;repeat&quot;); //不需全部重簽		
								            Form.setValue(&quot;Type&quot;,&quot;repeat&quot;);	 //表單重工Status
							          }		
							    }//駁回選擇：(需要全部重簽)、(不需全部重簽) --End
		                 } //當關卡有駁回選擇：(需要全部重簽)、(不需全部重簽) -- End     
						
						    Source_Ins.setAppValue(&quot;Process_ID&quot;,Form.getValue(&quot;Process_ID&quot;));
						    Source_Ins.setAppValue(&quot;Process_Name&quot;,Form.getValue(&quot;Process_Name&quot;));
						    Source_Ins.setAppValue(&quot;Tsk_ID&quot;,Form.getValue(&quot;Tsk_ID&quot;));
						    Source_Ins.setAppValue(&quot;State_ID&quot;,Form.getValue(&quot;State_ID&quot;));
						    Source_Ins.setAppValue(&quot;con_result&quot;,Form.getValue(&quot;con_result&quot;));
                            Source_Ins.setAppValue(&quot;Type&quot;,Form.getValue(&quot;Type&quot;));	
						    Source_Ins.setAppValue(&quot;RJ_DEM_Flag&quot;,Form.getValue(&quot;RJ_DEM_Flag&quot;));	
				    }// if(Form.getValue(&quot;Mail_App_Flag&quot;)==&quot;&quot; &amp;&amp; Form.getValue(&quot;Verify_DE&quot;)!= &quot;true&quot;){ 
				  }//if(process_name.indexOf(&quot;作廢&quot;)&gt;=0  || process_name == &quot;提出單位最高主管&quot;){		  
	    }//簽核選項為【Reject】駁回 --End	
		
}//function check_process(process_name,Source_Ins)  
  
 function check_cancel(Source_Ins,process_name,msg){
  //填寫作廢原因
     if( Form.getValue(&quot;Verify_Note&quot;) == &quot;&quot; &amp;&amp; Form.getValue(&quot;Process_Table&quot;).size() &gt; 0){
		
	      if ((Form.getValue(&quot;Agree&quot;) == &quot;true&quot; || Form.getValue(&quot;Reject&quot;) == &quot;true&quot;) &amp;&amp; Form.getValue(&quot;SIGNMSG&quot;) ==&quot;&quot;){
		      Form.setComplete(false);
	          Form.showMessageDialog(&quot;請於簽核意見欄填寫【同意作廢】或【駁回作廢】原因!\n&quot;);	
	      }else{
			  if( process_name.indexOf(&quot;申請人&quot;)&gt;=0 ){	
			  Form.setComplete(false);
	          Form.showMessageDialog(&quot;請於簽核意見欄填寫作廢原因!\n&quot;);	
			  
			  //回寫EKM doc_type
		       loadLibrary(&quot;com.gce.PLM.Common.Client.CHK_EKM&quot;);
		       check_doc_type();
		      }		
		 }
		Source_Ins.setAppValue(&quot;Verify_ID&quot;,Form.getValue(&quot;Verify_ID&quot;));
	    Source_Ins.setAppValue(&quot;Verify_Name&quot;,Form.getValue(&quot;Verify_Name&quot;));
        }

}//function check_cancel(Source_Ins,process_name,msg)
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00341297093840136</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2011/07/04 23:15:16</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Client.PDM_openAction_MECN</string> 
     </void> 
     <void property="id"> 
      <string>SCL00341297093840136</string> 
     </void> 
     <void property="name"> 
      <string>PDM_openAction_MECN</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00021229049977055</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function openFormAction_MECN(MyTask){
	
    var process_type = MyTask.artInstance.name;	
	var process_name = MyTask.getProcessName();
	var SignTable = Form.getValue(&quot;Process_Table&quot;);
	var depid = Client.getMember(Form.getValue(&quot;Verify_Name&quot;)).getRoleList().get(0).departmentID;	
	
	Form.setValue(&quot;Agree&quot;,&quot;true&quot;);
    Form.setValue(&quot;Reject&quot;,&quot;false&quot;);
    Form.setValue(&quot;Verify_Note&quot;,&quot;&quot;);
   
	//當簽核關卡為【申請人】
	if( process_name.indexOf(&quot;申請人&quot;)&gt;=0 ){	

		var vIns_ID = Form.getArtInstanceID()
		Form.setValue(&quot;Source_Ins_ID&quot;,vIns_ID);			  // 此欄位是為了要寫入會簽流程中的表單
		Form.setValue(&quot;Main_flag&quot;,&quot;Y&quot;);	                  // 此欄位是為了辨別母 or 子 的表單 (母 &quot;Y&quot; ，子 &quot;N&quot;)
        Form.setValue(&quot;Mail_App_Flag&quot;,&quot;&quot;);                // 駁回【  ★  請發文者來解釋  ★  】check_flag
        Form.setValue(&quot;RJ_DEM_Flag&quot;,&quot;&quot;);                  // 退回【 DE主管審核 】check_flag
		
		Disable_case(process_type); //設定所有的欄位屬性為不可編輯
		
	     if( Form.getValue(&quot;FLOWTYPE&quot;).trim().length() &gt; 0 ){
		     Form.setValue(&quot;SHOWSHOW1&quot;,Form.getValue(&quot;FLOWTYPE&quot;));	
 
	       var FLOWTYPE = Form.getValue(&quot;FLOWTYPE&quot;).substring(0,2); 
		   
	           Visiable_case(FLOWTYPE,process_type); //依類別，開放設定所屬欄位屬性為可編輯
			   
		   if( process_type.indexOf(&quot;MECN申請單&quot;)&gt;=0 ){	   
	           Form.getComponent(&quot;FLOWTYPE&quot;).setVisible(true);
	           Form.getComponent(&quot;SHOWSHOW1&quot;).setVisible(false);
			}   
	      }
	           check_enabled(process_type); //檢查設定欄位屬性為可編輯
			   
		 if( process_type.indexOf(&quot;MECN申請單&quot;)&lt;0 ){
			if( process_type.indexOf(&quot;MECN實驗結果&quot;)&gt;=0){
		        Form.setValue(&quot;Ins_ID2&quot;,vIns_ID); // 此欄位是為了要記錄第二階表單insid		
			}
		 Form.setValue(&quot;Check_Flag&quot;,&quot;&quot;);
		
	    //清空【是否符合預期，可轉量產】選項
        Form.setValue(&quot;yes_to_produce&quot;,&quot;false&quot;);
		Form.setValue(&quot;no_to_produce&quot;,&quot;false&quot;);
 	    Form.setValue(&quot;clear_select&quot;,&quot;false&quot;);
		//清空【驗證人員】
		Form.setValue(&quot;sign_name&quot;,&quot;&quot;);
		//清空【驗證人員會簽Table】選項
        Form.getComponent(&quot;MemberTable_Measure&quot;).clear();
        Form.getComponent(&quot;MemberTable_Measure_G&quot;).clear();

		Visiable_case(FLOWTYPE,process_type); //依類別，開放設定所屬欄位屬性為可編輯
        check_enabled(process_type) //檢查設定欄位屬性為可編輯		
		
       }
	   //當Process_Tableu有簽核記錄	
	   if(SignTable.size() &gt; 0){
		  Form.getComponent(&quot;form_help&quot;).setVisible(false);
		  Form.getComponent(&quot;FLabel65&quot;).setVisible(false);  //簽核
		  Form.getComponent(&quot;FLabel18&quot;).setVisible(false);  //簽核決定
		  Form.setValue(&quot;Agree&quot;,&quot;true&quot;);       //同意
		  Form.getComponent(&quot;Agree&quot;).setVisible(false);     //同意
		  Form.getComponent(&quot;Reject&quot;).setVisible(false);    //駁回	
		  Form.getComponent(&quot;Cancel&quot;).setVisible(true);
		  Form.getComponent(&quot;Select_Process&quot;).setVisible(false);  //簽核
		  Form.getComponent(&quot;FHLine6&quot;).setVisible(false);  //-
		  Form.getComponent(&quot;FVLine1&quot;).setVisible(false);    //|
		  Form.getComponent(&quot;Rectangle1&quot;).setVisible(true);     //底
		  Form.getComponent(&quot;Verify_R&quot;).setVisible(false);  //需全部重簽
		  Form.getComponent(&quot;Verify_N&quot;).setVisible(false);    //不需全部重簽	
		  Form.getComponent(&quot;Verify_Note&quot;).setVisible(true);    //意見
		  Form.getComponent(&quot;Verify_Note&quot;).setEnabled(true);    //意見
		  Form.getComponent(&quot;lbNote&quot;).setVisible(true);    //簽核意見
		  
		  //清空DE 加會簽Flag
		  Form.setValue(&quot;DE_Flag&quot;,&quot;&quot;);
		} 
      //當簽核關卡不為【申請人】
	  }else{

		//當Process_Tableu有簽核記錄	
	   if(SignTable.size() &gt; 0){
		  Form.getComponent(&quot;form_help&quot;).setVisible(false);
		  Form.getComponent(&quot;Agree&quot;).setVisible(true);     //同意
		  Form.getComponent(&quot;Reject&quot;).setVisible(true);    //駁回	
		  Form.getComponent(&quot;Cancel&quot;).setVisible(false);
		  Form.getComponent(&quot;Verify_R&quot;).setVisible(false);  //需全部重簽
		  Form.getComponent(&quot;Verify_N&quot;).setVisible(false);    //不需全部重簽	
		  Form.getComponent(&quot;Select_Process&quot;).setVisible(false);  //簽核
		  Form.getComponent(&quot;FHLine6&quot;).setVisible(true);  //-
		  Form.getComponent(&quot;FVLine1&quot;).setVisible(true);    //|
		  Form.getComponent(&quot;Rectangle1&quot;).setVisible(true);     //底
		  Form.getComponent(&quot;Verify_Note&quot;).setVisible(true);    //意見
		  Form.getComponent(&quot;Verify_Note&quot;).setEnabled(true);    //意見
		  Form.getComponent(&quot;lbNote&quot;).setVisible(true);    //簽核意見
		  Form.getComponent(&quot;FLabel65&quot;).setVisible(true);  //簽核
		  Form.getComponent(&quot;FLabel18&quot;).setVisible(true);  //簽核決定
	     }

		    Form.getComponent(&quot;Cancel&quot;).setVisible(false);  //【作廢】選項
		 //【  ★  請發文者來解釋  ★  】選項	
         if( Form.getValue(&quot;Mail_App_Flag&quot;)==&quot;Y&quot;){
		     Form.setValue(&quot;Mail_App_Flag&quot;,&quot;N&quot;);
		 }
		 	  Form.setValue(&quot;RJ_DEM_Flag&quot;,&quot;&quot;);
		 var FLOWTYPE = Form.getValue(&quot;FLOWTYPE&quot;).substring(0,2); 

		 Form.setValue(&quot;Agree&quot;,&quot;true&quot;);       //同意
		 Form.setValue(&quot;Reject&quot;,&quot;false&quot;);      //駁回
		 Form.setValue(&quot;Verify_R&quot;,&quot;false&quot;);    //駁回需重簽
		 Form.setValue(&quot;Verify_N&quot;,&quot;false&quot;);    //駁回不需重簽
		 Form.setValue(&quot;Cancel&quot;,&quot;false&quot;);      //作廢
		 
		 Form.setValue(&quot;SHOWSHOW1&quot;,Form.getValue(&quot;FLOWTYPE&quot;));
		 Form.getComponent(&quot;FLOWTYPE&quot;).setVisible(false);
		 Form.getComponent(&quot;SHOWSHOW1&quot;).setVisible(true);
		 
		 Disable_case(process_type); //設定所有的欄位屬性為不可編輯 
		 
		 
		 if(!FLOWTYPE.equals(&quot;C1&quot;)){
		   Form.getComponent(&quot;sign_Button&quot;).setText(&quot;(製造部)會簽人員&quot;);
		   // 新增(相關製造部)會簽人員 
	       Form.getComponent(&quot;sign_Button&quot;).setEnabled(true);
		   
		     if(!FLOWTYPE.equals(&quot;C2&quot;)){
			    //三.產品品質驗證項目與允收標準
 		        Form.getComponent(&quot;MECN_file_Button&quot;).setEnabled(true);
				if( process_type.indexOf(&quot;MECN申請單&quot;)&gt;=0 ){
			    Form.getComponent(&quot;MECN_SP_List_B&quot;).setEnabled(true); 
				}
		    }
		 }

		 if(process_name.indexOf(&quot;它廠製工會簽&quot;)&gt;=0){	
			  Form.getComponent(&quot;FButton1&quot;).setVisible(false);
			  Form.getComponent(&quot;Reject&quot;).setVisible(false);	
		   }
		 
		 // 是否符合客戶規定	 
		 if ( process_name == &quot;Local QAE審核&quot; ){
		      Form.getComponent(&quot;FRadioButton_w31&quot;).setEnabled(true);
		      Form.getComponent(&quot;FRadioButton_w32&quot;).setEnabled(true);				
		      Form.getComponent(&quot;FRadioButton_w33&quot;).setEnabled(true);	
           	  if (Form.getValue(&quot;FRadioButton_w33&quot;)== &quot;true&quot;){
		          Form.getComponent(&quot;FTextField_w33&quot;).setEnabled(true);
			  }
         }	

		  if(process_name.indexOf(&quot;作廢&quot;)&gt;=0 || process_name == &quot;提出單位最高主管&quot;){	
			  Form.setValue(&quot;Cancel&quot;,&quot;true&quot;);
			  Form.getComponent(&quot;Cancel&quot;).setEnabled(false);	
			  Form.getComponent(&quot;Cancel&quot;).setVisible(true);	
//			  Form.getComponent(&quot;FButton2&quot;).setVisible(false);						   
			  Form.getComponent(&quot;Agree&quot;).setText(&quot;同意作廢&quot;);
			  Form.getComponent(&quot;Reject&quot;).setText(&quot;駁回作廢&quot;);  
			  //清空【駁回不需重簽】會簽關卡
			  Form.setValue(&quot;Process_Name&quot;,&quot;&quot;);
		   }
		 //顯示 ★ 填寫【試做批批號】★ 按鈕
		 if ( process_name == &quot;填寫批號&quot; ||process_name == &quot;QC鎖帳通知&quot; ){
		      Form.getComponent(&quot;Item_sp_Button&quot;).setVisible(true);
			  Form.getComponent(&quot;Item_sp_Button&quot;).setEnabled(true);
			  Form.getComponent(&quot;FButton1&quot;).setVisible(false);
			  
			  //開放填寫【變更對象】
			  Form.getComponent(&quot;FCheckBox_s1&quot;).setEnabled(true);		
		      Form.getComponent(&quot;FCheckBox_s2&quot;).setEnabled(true);
		      Form.getComponent(&quot;FCheckBox_s3&quot;).setEnabled(true);	
			  if (Form.getValue(&quot;FCheckBox_s3&quot;)== &quot;true&quot;){
		          Form.getComponent(&quot;FButton_s3&quot;).setEnabled(true);
			  }
			  if (process_name == &quot;QC鎖帳通知&quot; ){
			      Form.getComponent(&quot;Item_sp_Button&quot;).setText(&quot;  ★   【試做批批號】  ★ &quot;);
			      Form.getComponent(&quot;Reject&quot;).setVisible(false);				  
			  }
		  }
		  
		 //A類、B類 顯示【作廢】選項
		 if (process_name == &quot;總經理&quot; ||process_name == &quot;填寫批號&quot;||process_name == &quot;QC鎖帳通知&quot; ){
		     Form.getComponent(&quot;Cancel&quot;).setVisible(false);
		 }
		 
		 //有會簽子流程的關卡  
		 if (process_name != &quot;直屬主管審核&quot; || process_name != &quot;部門主管審核&quot; || process_name != &quot;QA最高主管審核&quot; ||process_name != &quot;填寫批號&quot; || process_name != &quot;提出單位最高主管&quot; ){
			 var Source_Ins_ID = Form.getValue(&quot;Source_Ins_ID&quot;);   // 這個是由資料拋轉(DDT)傳入的,是母表單的INSID
			 var Source_Ins = Client.getArtInstance(Source_Ins_ID);
			 
			   //會簽子流程抓取母表單的簽核記錄
               if (Source_Ins_ID!= &quot;&quot;){  	
		           var source_dataMap=Source_Ins.getAppDataMap();
				   //抓取母表單【簽核紀錄】，寫入子表單
			       var Process_Table =source_dataMap.get(&quot;Process_Table&quot;);
				   Form.setValue(&quot;Process_Table&quot;,Process_Table);
				   //抓取母表單【產品品質驗證項目與允收標準】，寫入子表單
				   var MECN_SP_List =source_dataMap.get(&quot;MECN_SP_List&quot;);
				   Form.setValue(&quot;MECN_SP_List&quot;,MECN_SP_List);
                }
				
                if(process_type.indexOf(&quot;MECN申請單&quot;)&lt;0 ){
			   	//顯示 填寫【是否符合預期，可轉1/4/8批試做生產】
		        if ( process_name == &quot;驗證單位審核&quot; ){
				   Form.setValue(&quot;Check_Flag&quot;,&quot;&quot;);
				   
				   //抓取母表單【驗收資料】，寫入子表單				   
				   var sign_name=source_dataMap.get(&quot;sign_name&quot;);
				   
				   if(process_type.indexOf(&quot;MECN實驗結果&quot;)&gt;=0 ){
				      var mecn_comment=source_dataMap.get(&quot;comment&quot;);				   
					      Form.setValue(&quot;comment&quot;,mecn_comment);
				          Form.getComponent(&quot;comment&quot;).setEnabled(true);						  
				   }
				   
   				   var yes_to_produce =source_dataMap.get(&quot;yes_to_produce&quot;);
				   var no_to_produce =source_dataMap.get(&quot;no_to_produce&quot;);
				   
				   Form.setValue(&quot;sign_name&quot;,sign_name);
				   Form.setValue(&quot;yes_to_produce&quot;,yes_to_produce);
				   Form.setValue(&quot;no_to_produce&quot;,no_to_produce);
				  
		           Form.getComponent(&quot;yes_to_produce&quot;).setEnabled(true);
			       Form.getComponent(&quot;no_to_produce&quot;).setEnabled(true);
			       Form.getComponent(&quot;MECN_SP_List&quot;).setEnabled(true);
				   Form.getComponent(&quot;MECN_SP_List_B&quot;).setEnabled(true);
		           Form.getComponent(&quot;MECN_file_Button&quot;).setEnabled(true);
		        }		
               }
			  // 顯示小黃加會簽	 
		      if (process_name.indexOf(&quot;DE&quot;)&gt;=0 ){
				  if(process_name == &quot;DE主管審核&quot;){
				    Form.getComponent(&quot;DE_Assign&quot;).setVisible(true);
				  }
  				   Form.setValue(&quot;DE_Flag&quot;,source_dataMap.get(&quot;DE_Flag&quot;));
			    //只限DE 部門人員可以使用【小黃加會簽】，抓取部門名稱有M 的，EX：2M1、2M2
			       if (depid.indexOf(&quot;M&quot;)&gt;=0){
					   var flg = false;
			           Form.getComponent(&quot;FButton3&quot;).setVisible(true);
				       loadLibrary(&quot;com.A.Common.Client.SignTable&quot;)	
	                   setSignTableResult(&quot;Sub_Process_Table&quot;);  //將會簽結果放入子流程 Sub_Process_Table 審核意見裡面	

				       //只限DE 部門人員使用【小黃加會簽】，且有會簽記錄，則強制Update 母流程表單
					   var Sub_Process_Table = Form.getComponent(&quot;Sub_Process_Table&quot;);
					   var process_table = Form.getComponent(&quot;Process_Table&quot;);
					   var RowCount = Sub_Process_Table.getRowCount();
					    try{

  					     if (RowCount!=0){
                            for(var i = 0;i&lt;RowCount;i++){
								var signtime = Sub_Process_Table.getValueAt(i,&quot;審核日期&quot;);
								var memid = Sub_Process_Table.getValueAt(i,&quot;工號&quot;);
							  if(!check_process_table(process_table,signtime,memid)){
		                          var row = process_table.newRow()-1;
 		 			                  process_table.setValueAt(row+1+&quot;&quot;,row,&quot;序號&quot;);   
	           						  process_table.setValueAt(signtime,row,&quot;審核日期&quot;);
							          process_table.setValueAt(&quot;*動態加會簽&quot;,row,&quot;關卡名稱&quot;);
  		                              process_table.setValueAt(Sub_Process_Table.getValueAt(i,&quot;部門&quot;),row,&quot;部門&quot;);
		                              process_table.setValueAt(Sub_Process_Table.getValueAt(i,&quot;職稱&quot;),row,&quot;職稱&quot;);							 
  		                              process_table.setValueAt(memid,row,&quot;工號&quot;);
		                              process_table.setValueAt(Sub_Process_Table.getValueAt(i,&quot;姓名&quot;),row,&quot;姓名&quot;);
							          process_table.setValueAt(Sub_Process_Table.getValueAt(i,&quot;是否核准&quot;),row,&quot;是否核准&quot;);							 
                                      process_table.setValueAt(Sub_Process_Table.getValueAt(i,&quot;審核意見&quot;),row,&quot;審核意見&quot;);
							          process_table.setValueAt(Sub_Process_Table.getValueAt(i,&quot;TaskID&quot;),row,&quot;TaskID&quot;);
                               }//if(!memisDauble(Sub_Process_Table,signtime,memid))   
                           }
				           Source_Ins.setAppValue(&quot;Process_Table&quot;,Form.getValue(&quot;Process_Table&quot;));
						   Form.setValue(&quot;DE_Flag&quot;,&quot;&quot;);
						   Source_Ins.setAppValue(&quot;DE_Flag&quot;,&quot;&quot;);
	                       Client.updateArtInstance(Source_Ins); 
						   
						   //清空加會簽
	                       MyTask.setExecuteAddAS(false);
	                       MyTask.setAddASTitle(&quot;&quot;);
	                       MyTask.setAddASAuditsString(new java.util.Vector());//清空
						   } 
					   }catch(e){} 
					   
			       }//if (depid.indexOf(&quot;M&quot;)&gt;=0)
			   }
			 // 是否符合客戶規定	 
			  if ( process_name == &quot;Local QAE審核&quot; ){	
				  
				   //抓取母表單【是否符合客戶規定	】，寫入子表單
				   Form.setValue(&quot;FRadioButton_w31&quot;,source_dataMap.get(&quot;FRadioButton_w31&quot;));
   				   Form.setValue(&quot;FRadioButton_w32&quot;,source_dataMap.get(&quot;FRadioButton_w32&quot;));
   				   Form.setValue(&quot;FRadioButton_w33&quot;,source_dataMap.get(&quot;FRadioButton_w33&quot;));
   				   Form.setValue(&quot;FTextField_w33&quot;,source_dataMap.get(&quot;FTextField_w33&quot;));	

		           Form.getComponent(&quot;FRadioButton_w31&quot;).setEnabled(true);
		           Form.getComponent(&quot;FRadioButton_w32&quot;).setEnabled(true);				
		           Form.getComponent(&quot;FRadioButton_w33&quot;).setEnabled(true);	
           		   if (Form.getValue(&quot;FRadioButton_w33&quot;)== &quot;true&quot;){
		               Form.getComponent(&quot;FTextField_w33&quot;).setEnabled(true);
			       }
              }		  
           } //有會簽子流程的關卡 End   
	 }//當簽核關卡不為【申請人】End	
 }//function check_enabled()openFormAction_MECN()	  
 
function Visiable_case(FLOWTYPE,process_type){	
	// 變更內容     
	Form.getComponent(&quot;FTextArea2&quot;).setEnabled(true);	
		 
	// 變更對象    
	Form.getComponent(&quot;FCheckBox_s1&quot;).setEnabled(true);		
	Form.getComponent(&quot;FCheckBox_s2&quot;).setEnabled(true);
	Form.getComponent(&quot;FCheckBox_s3&quot;).setEnabled(true);	

	// 四.在製品處理方式	  
	Form.getComponent(&quot;FRadioButton_w41&quot;).setEnabled(true);
	Form.getComponent(&quot;FRadioButton_w42&quot;).setEnabled(true);				
	Form.getComponent(&quot;FRadioButton_w43&quot;).setEnabled(true);		
 	Form.getComponent(&quot;FRadioButton_w44&quot;).setEnabled(true);	 
	 
	if( process_type.indexOf(&quot;MECN申請單&quot;)&gt;=0){
		
	if(!FLOWTYPE.equals(&quot;C1&quot;)){	//除C1類，均需填寫 ★  新增(相關製造部)會簽人員  ★ 
		  	Form.getComponent(&quot;sign_Button&quot;).setEnabled(true);	 //  ★  新增(相關製造部)會簽人員  ★ 
			if(!FLOWTYPE.equals(&quot;C2&quot;)){	//除C2類，均需填寫 MECN 品質相關要求_List、 ★  填寫【產品品質驗證項目與允收標準】  ★  
				Form.getComponent(&quot;MECN_file_Button&quot;).setEnabled(true); //MECN 品質相關要求_List
		        Form.getComponent(&quot;MECN_SP_List_B&quot;).setEnabled(true);   //  ★  填寫【產品品質驗證項目與允收標準】  ★  
			}	
	  }		
     //* 變更類別	  
	if(FLOWTYPE.indexOf(&quot;C&quot;)&gt;=0){  
	  Form.getComponent(&quot;mecn_type&quot;).setEnabled(false);	
	}else{
	  Form.getComponent(&quot;mecn_type&quot;).setEnabled(true);	
	}	
	// 變更理由   
	 Form.getComponent(&quot;FTextArea0&quot;).setEnabled(true);	 
	
	  if(FLOWTYPE.equals(&quot;A類&quot;)){
		 for(var i=1;i&lt;21;i++){ 
	        var temp_checkbox = &quot;FCheckBox_a&quot; + i; 
			if (temp_checkbox == &quot;FCheckBox_a4&quot;){
        		   Form.getComponent(&quot;FCheckBox_a4_1&quot;).setEnabled(true);
 		           Form.getComponent(&quot;FCheckBox_a4_2&quot;).setEnabled(true);			   
			}else{	 
	               Form.getComponent(temp_checkbox).setEnabled(true);
            }
	    }//for 
         Form.getComponent(&quot;FTextArea4&quot;).setEnabled(true);	// 【二.試作批實驗計畫】(僅A類需填寫)
  	   }
	  else if(FLOWTYPE.equals(&quot;B類&quot;)){	 
		 Form.getComponent(&quot;FCheckBox_b1_1&quot;).setEnabled(true);
		 Form.getComponent(&quot;FCheckBox_b1_2&quot;).setEnabled(true);
		 Form.getComponent(&quot;FCheckBox_b2&quot;).setEnabled(true);
		 Form.getComponent(&quot;FCheckBox_b3&quot;).setEnabled(true);
 	   }
	  else if(FLOWTYPE.equals(&quot;C1&quot;)){
		 Form.getComponent(&quot;FCheckBox_c11&quot;).setEnabled(true);
		 Form.getComponent(&quot;FCheckBox_c12&quot;).setEnabled(true);
		 Form.getComponent(&quot;FCheckBox_c13&quot;).setEnabled(true);		
	   }
	  else if(FLOWTYPE.equals(&quot;C2&quot;)){		
		 Form.getComponent(&quot;FCheckBox_c21&quot;).setEnabled(true);				
		 Form.getComponent(&quot;FCheckBox_c22&quot;).setEnabled(true);
		 Form.getComponent(&quot;FCheckBox_c23&quot;).setEnabled(true);
		 Form.getComponent(&quot;FCheckBox_c24&quot;).setEnabled(true);				
		 Form.getComponent(&quot;FCheckBox_c25&quot;).setEnabled(true);					 
	  }
	  
	  if( FLOWTYPE.indexOf(&quot;C&quot;)&gt;=0 ){	//C類一階，填寫【五.MECN文件前版處置方式】、【六.MECN新文件處置方式】
		  Form.getComponent(&quot;FRadioButton_w51&quot;).setEnabled(true);
		  Form.getComponent(&quot;FRadioButton_w52&quot;).setEnabled(true);				
		  Form.getComponent(&quot;FRadioButton_w53&quot;).setEnabled(true);
		  
		  Form.getComponent(&quot;FCheckBox0&quot;).setEnabled(true);	
		  Form.getComponent(&quot;FCheckBox1&quot;).setEnabled(true);	
		  Form.getComponent(&quot;FCheckBox2&quot;).setEnabled(true);	
		  Form.getComponent(&quot;FCheckBox3&quot;).setEnabled(true);	
		  Form.getComponent(&quot;FCheckBox4&quot;).setEnabled(true);	
		  Form.getComponent(&quot;FCheckBox5&quot;).setEnabled(true);					
		  Form.getComponent(&quot;FCheckBox7&quot;).setEnabled(true);	
     }

	 //與產能相關
	 Form.getComponent(&quot;FRadioButton_w21&quot;).setEnabled(true);
	 Form.getComponent(&quot;FRadioButton_w22&quot;).setEnabled(true);	

     }else if(process_type.indexOf(&quot;MECN實驗結果&quot;)&gt;=0 ){
		Form.getComponent(&quot;MECN_file_Button&quot;).setEnabled(true);
		Form.getComponent(&quot;comment&quot;).setEnabled(true);
		//新增(驗證)會簽人員
		Form.getComponent(&quot;FButton10&quot;).setEnabled(true);
	 }else if(process_type.indexOf(&quot;MECN核准單&quot;)&gt;=0){
		Form.getComponent(&quot;MECN_file_Button&quot;).setEnabled(true);
		//新增(驗證)會簽人員
		Form.getComponent(&quot;FButton10&quot;).setEnabled(true); 

	 	// 五.MECN文件前版處置方式
		Form.getComponent(&quot;FRadioButton_w51&quot;).setEnabled(true);
		Form.getComponent(&quot;FRadioButton_w52&quot;).setEnabled(true);				
		Form.getComponent(&quot;FRadioButton_w53&quot;).setEnabled(true);
		
		// 六.MECN新文件處置方式
		Form.getComponent(&quot;FCheckBox0&quot;).setEnabled(true);	
		Form.getComponent(&quot;FCheckBox1&quot;).setEnabled(true);	
		Form.getComponent(&quot;FCheckBox2&quot;).setEnabled(true);	
		Form.getComponent(&quot;FCheckBox3&quot;).setEnabled(true);	
		Form.getComponent(&quot;FCheckBox4&quot;).setEnabled(true);	
		Form.getComponent(&quot;FCheckBox5&quot;).setEnabled(true);					
	    Form.getComponent(&quot;FCheckBox7&quot;).setEnabled(true);	
	 }	 	  
	}

 function Disable_case(process_type){
		// 一.變更範圍
		//A類	
		for(var i=1;i&lt;21;i++){ 
	        var temp_checkbox = &quot;FCheckBox_a&quot; + i; 
			if (temp_checkbox == &quot;FCheckBox_a4&quot;){
        		   Form.getComponent(&quot;FCheckBox_a4_1&quot;).setEnabled(false);
 		           Form.getComponent(&quot;FCheckBox_a4_2&quot;).setEnabled(false);
			}else{	 
	               Form.getComponent(temp_checkbox).setEnabled(false);
            }
	    }//for 
 
		Form.getComponent(&quot;FTextField_a2&quot;).setEnabled(false);
		Form.getComponent(&quot;FTextField_a4&quot;).setEnabled(false);
//		Form.getComponent(&quot;FTextField_a5&quot;).setEnabled(false);
		Form.getComponent(&quot;FButton8&quot;).setEnabled(false);
		Form.getComponent(&quot;FButton9&quot;).setEnabled(false);

	   if( process_type.indexOf(&quot;MECN申請單&quot;)&gt;=0 ||process_type.indexOf(&quot;MECN核准單&quot;)&gt;=0){
		//B類
		Form.getComponent(&quot;FCheckBox_b1_1&quot;).setEnabled(false);
		Form.getComponent(&quot;FCheckBox_b1_2&quot;).setEnabled(false);		
		Form.getComponent(&quot;FCheckBox_b2&quot;).setEnabled(false);
		Form.getComponent(&quot;FCheckBox_b3&quot;).setEnabled(false);
		}
		
		if( process_type.indexOf(&quot;MECN申請單&quot;)&gt;=0){ 
		// 變更理由   
		Form.getComponent(&quot;FTextArea0&quot;).setEnabled(false);	
		
		//* 變更類別
		Form.getComponent(&quot;mecn_type&quot;).setEnabled(false);			
		
		//C1類
		Form.getComponent(&quot;sign_Button&quot;).setEnabled(false);	 		
		Form.getComponent(&quot;FCheckBox_c11&quot;).setEnabled(false);
		Form.getComponent(&quot;FCheckBox_c12&quot;).setEnabled(false);
		Form.getComponent(&quot;FCheckBox_c13&quot;).setEnabled(false);
		
		//C2類		
		Form.getComponent(&quot;FCheckBox_c21&quot;).setEnabled(false);
		Form.getComponent(&quot;FCheckBox_c22&quot;).setEnabled(false);
		Form.getComponent(&quot;FCheckBox_c23&quot;).setEnabled(false);
		Form.getComponent(&quot;FCheckBox_c24&quot;).setEnabled(false);
		Form.getComponent(&quot;FCheckBox_c25&quot;).setEnabled(false);
		}
	
		// 變更對象    
		Form.getComponent(&quot;FCheckBox_s1&quot;).setEnabled(false);		
		Form.getComponent(&quot;FCheckBox_s2&quot;).setEnabled(false);
		Form.getComponent(&quot;FCheckBox_s3&quot;).setEnabled(false);	
		Form.getComponent(&quot;FTextArea_s1&quot;).setEnabled(false);		
		Form.getComponent(&quot;FTextArea_s2&quot;).setEnabled(false);
		// 變更內容     
		Form.getComponent(&quot;FTextArea2&quot;).setEnabled(false);	

        // 是否符合客戶規定
		Form.getComponent(&quot;FRadioButton_w31&quot;).setEnabled(false);
		Form.getComponent(&quot;FRadioButton_w32&quot;).setEnabled(false);				
		Form.getComponent(&quot;FRadioButton_w33&quot;).setEnabled(false);		
		Form.getComponent(&quot;FTextField_w33&quot;).setEnabled(false);
		
        // 與產能相關
		Form.getComponent(&quot;FRadioButton_w21&quot;).setEnabled(false);
		Form.getComponent(&quot;FRadioButton_w22&quot;).setEnabled(false);				
		Form.getComponent(&quot;FRadioButton_w23&quot;).setEnabled(false);		
		Form.getComponent(&quot;FRadioButton_w24&quot;).setEnabled(false);		
		Form.getComponent(&quot;TextField_w22&quot;).setEnabled(false);				
		Form.getComponent(&quot;TextField_w23&quot;).setEnabled(false);		
		Form.getComponent(&quot;TextField_w24&quot;).setEnabled(false);
		
        if( process_type.indexOf(&quot;MECN核准單&quot;)&lt;0 ){
        //二.試作批實驗計畫
		Form.getComponent(&quot;FTextArea4&quot;).setEnabled(false);	
        }	
		
		//三.產品品質驗證項目與允收標準
//		Form.getComponent(&quot;MECN_file_Button&quot;).setEnabled(false);
		Form.getComponent(&quot;MECN_SP_List_B&quot;).setEnabled(false);
		
		// 四.在製品處理方式
		Form.getComponent(&quot;FRadioButton_w41&quot;).setEnabled(false);
		Form.getComponent(&quot;FRadioButton_w42&quot;).setEnabled(false);				
		Form.getComponent(&quot;FRadioButton_w43&quot;).setEnabled(false);		
		Form.getComponent(&quot;FRadioButton_w44&quot;).setEnabled(false);			
		Form.getComponent(&quot;FTextField_w42&quot;).setEnabled(false);
		Form.getComponent(&quot;FTextField_w43&quot;).setEnabled(false);	
		
        if( process_type.indexOf(&quot;MECN申請單&quot;)&gt;=0 ||process_type.indexOf(&quot;MECN核准單&quot;)&gt;=0){
		// 五.MECN文件前版處置方式
		Form.getComponent(&quot;FRadioButton_w51&quot;).setEnabled(false);
		Form.getComponent(&quot;FRadioButton_w52&quot;).setEnabled(false);				
		Form.getComponent(&quot;FRadioButton_w53&quot;).setEnabled(false);	
		Form.getComponent(&quot;FTextField_w51&quot;).setEnabled(false);				
		Form.getComponent(&quot;FTextField_w53&quot;).setEnabled(false);		
		
		// 六.MECN新文件處置方式
		Form.getComponent(&quot;FCheckBox0&quot;).setEnabled(false);	
		Form.getComponent(&quot;FCheckBox1&quot;).setEnabled(false);	
		Form.getComponent(&quot;FCheckBox2&quot;).setEnabled(false);	
		Form.getComponent(&quot;FCheckBox3&quot;).setEnabled(false);	
		Form.getComponent(&quot;FCheckBox4&quot;).setEnabled(false);	
		Form.getComponent(&quot;FCheckBox5&quot;).setEnabled(false);					
		Form.getComponent(&quot;FCheckBox7&quot;).setEnabled(false);		
		Form.getComponent(&quot;FTextField0&quot;).setEnabled(false);	
		Form.getComponent(&quot;FTextField6&quot;).setEnabled(false);	
		Form.getComponent(&quot;FTextField9&quot;).setEnabled(false);	
		Form.getComponent(&quot;FTextField11&quot;).setEnabled(false);		
		Form.getComponent(&quot;FTextField12&quot;).setEnabled(false);	
        }	
		
		if( process_type.indexOf(&quot;MECN實驗結果&quot;)&gt;=0 ||process_type.indexOf(&quot;MECN核准單&quot;)&gt;=0){
		//新增(驗證)會簽人員
		Form.getComponent(&quot;FButton10&quot;).setEnabled(false);
		
		Form.getComponent(&quot;yes_to_produce&quot;).setEnabled(false);
		Form.getComponent(&quot;no_to_produce&quot;).setEnabled(false);
		
		  if( process_type.indexOf(&quot;MECN實驗結果&quot;)&gt;=0){
		   //comment
		   Form.getComponent(&quot;comment&quot;).setEnabled(false);
		  }
		}
	}
	
function check_enabled(process_type){

	  //變更對象-By系列別變更
	   if(Form.getValue(&quot;FCheckBox_s1&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextArea_s1&quot;).setEnabled(true);
	   }
	   //變更對象-與料號無關
	   if(Form.getValue(&quot;FCheckBox_s2&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextArea_s2&quot;).setEnabled(true);
	   }
	   //變更對象-By個別料號
	   if(Form.getValue(&quot;FCheckBox_s3&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FButton_s3&quot;).setEnabled(true);
	   }
	   //四.在製品處理方式-管制生產
	   if(Form.getValue(&quot;FRadioButton_w42&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField_w42&quot;).setEnabled(true);
	   }
	   //四.在製品處理方式-其他
	   if(Form.getValue(&quot;FRadioButton_w43&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField_w43&quot;).setEnabled(true);
	   }
		
      if( process_type.indexOf(&quot;MECN申請單&quot;)&gt;=0){  
		  
		//A類-導入標準化文件
	   if(Form.getValue(&quot;FCheckBox_a18&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField_a2&quot;).setEnabled(true);
		  Form.getComponent(&quot;FButton8&quot;).setEnabled(true);
	   }
       //A類-設計準則
	   if(Form.getValue(&quot;FCheckBox_a19&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField_a4&quot;).setEnabled(true);
		  Form.getComponent(&quot;FButton9&quot;).setEnabled(true);
	   }
	   //A類-其他
	   if(Form.getValue(&quot;FCheckBox_a20&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField_a5&quot;).setEnabled(true);
	   }
       //B類-特殊案件, 有急迫的時間壓力, 變更範圍
	   if(Form.getValue(&quot;FCheckBox_b3&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField_b1&quot;).setEnabled(true);
	   }
	   //C2類-樣品條件變更, 變更範圍
	   if(Form.getValue(&quot;FCheckBox_c23&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField_c23&quot;).setEnabled(true);
       }
	   if(Form.getValue(&quot;FCheckBox_c25&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField_c25&quot;).setEnabled(true);
       }
	    // 與產能相關
		if(Form.getValue(&quot;FRadioButton_w22&quot;) == &quot;true&quot; ){	
		   Form.getComponent(&quot;FRadioButton_w23&quot;).setEnabled(true);		
		   Form.getComponent(&quot;FRadioButton_w24&quot;).setEnabled(true);		
		   Form.getComponent(&quot;TextField_w22&quot;).setEnabled(true);				
		   Form.getComponent(&quot;TextField_w23&quot;).setEnabled(true);	
	 	   if(Form.getValue(&quot;FRadioButton_w23&quot;) == &quot;true&quot; ){
		      Form.getComponent(&quot;TextField_w24&quot;).setEnabled(true);	
		   }
	   }

	   //五.MECN文件前版處置方式-作廢，文件No
	   if(Form.getValue(&quot;FRadioButton_w51&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField_w51&quot;).setEnabled(true);
	   }
	   //五.MECN文件前版處置方式-其他
	   if(Form.getValue(&quot;FRadioButton_w53&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField_w53&quot;).setEnabled(true);
	   }
	   //六.MECN新文件處置方式-立即生效須傳承 (註明WIP之處置及舊料號之導入時間)
	   if(Form.getValue(&quot;FCheckBox0&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField0&quot;).setEnabled(true);
	   }
	   //六.MECN新文件處置方式-新料號與舊料號逐步導入,優先導入料
	   if(Form.getValue(&quot;FCheckBox2&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField6&quot;).setEnabled(true);
	   }
	   //六.MECN新文件處置方式-立即生效不傳承(註明WIP之處置)
	   if(Form.getValue(&quot;FCheckBox3&quot;)== &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField9&quot;).setEnabled(true);
	   }
	   //六.MECN新文件處置方式-REV變更後不傳承(註明WIP之處置
	   if(Form.getValue(&quot;FCheckBox5&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField11&quot;).setEnabled(true);
	   }
	   //六.MECN新文件處置方式-其他
	   if(Form.getValue(&quot;FCheckBox7&quot;) == &quot;true&quot; ){
		  Form.getComponent(&quot;FTextField12&quot;).setEnabled(true);
	   }
   }else if(process_type.indexOf(&quot;MECN核准單&quot;)&gt;=0){
	   
   }
}//function check_enabled()	
	
function check_process_table(process_table,signtime,memid){
   for(var j = 0;j&lt;process_table.getRowCount();j++){
	   if(process_table.getValueAt(j,&quot;審核日期&quot;).equals(signtime)&amp;&amp; process_table.getValueAt(j,&quot;工號&quot;).equals(memid)){
		  return true;
	   }
   }
	return false ;		
}//function check_process_table

function clear_trans_table(){
   var MyTask = Form.getCurrentTask();
    if( MyTask != null ){
	// 抓取驗證人員table------------
	var table1= Form.getComponent(&quot;MemberTable_Measure&quot;);
	var row =table1.getRowCount();
    if(row&lt;=0){	
	//清除第一、二階【資料拋轉】的欄位
	Form.getComponent(&quot;Process_Table&quot;).clear();
	Form.getComponent(&quot;item_lot_no_table_p&quot;).clear();
	Form.getComponent(&quot;AddAs_Table&quot;).clear();
	Form.getComponent(&quot;Sub_Process_Table&quot;).clear();
	Form.getComponent(&quot;MemberTable_Measure&quot;).clear();	
	Form.getComponent(&quot;MemberTable_Measure_G&quot;).clear();

	//實驗結果驗證單位簽名
	Form.setValue(&quot;sign_name&quot;,&quot;&quot;);
	//是否符合預期，可轉量產 
	Form.setValue(&quot;yes_to_produce&quot;,&quot;false&quot;);
	Form.setValue(&quot;no_to_produce&quot;,&quot;false&quot;);		
	
  	//清空 駁回選擇：(不需全部重簽) 所記錄欄位
	Form.setValue(&quot;Process_ID&quot;,&quot;&quot;);//紀錄目前關卡流程ID
	Form.setValue(&quot;Process_Name&quot;,&quot;&quot;);//紀錄目前關卡流程Name
	Form.setValue(&quot;Tsk_ID&quot;,&quot;&quot;);	//紀錄目前關卡Tsk_ID
	Form.setValue(&quot;State_ID&quot;,&quot;&quot;);//紀錄目前關卡State_ID
	Form.setValue(&quot;con_result&quot;,&quot;&quot;);
	Form.setValue(&quot;Type&quot;,&quot;&quot;);	
	
	Form.setValue(&quot;DE_Flag&quot;,&quot;&quot;);	
	
	// 把之前的【連續試做批實驗結果】欄位清空------------
	var table= Form.getComponent(&quot;MECN_SP_List&quot;);
    var row =table.getRowCount();
    for(var i =0;i&lt;row ;i++){
		table.setValueAt(&quot;&quot;,i,&quot;抽樣數量&quot;);
		table.setValueAt(&quot;&quot;,i,&quot;抽樣結果&quot;);
		table.setValueAt(&quot;&quot;,i,&quot;判定&quot;);		
	 }
	} 
   }// if( MyTask != null )
}//clear_trans_table()

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00351300098563864</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2017/05/11 09:24:11</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.TRN</string> 
     </void> 
     <void property="id"> 
      <string>SCL00351300098563864</string> 
     </void> 
     <void property="name"> 
      <string>TRN</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>	
function search_data(){
	/**設定 artifact id*/
	var artifact_name = Form.getValue(&quot;Artifact&quot;);
	var v_factory = Form.getValue(&quot;Factory&quot;);	
	var v_dptno = Form.getValue(&quot;dptno&quot;);		
	
	//TRN 教育訓練   
	if(artifact_name == &quot;特定及驗證人員審查規定&quot;){
		
	   var artid = &quot;ART00951274066214537&quot;; //特定及驗證人員審查規定 V1
	   var temp =&quot;,ITEM19 create_date,ITEM80 sn,ITEM15 appname,ITEM15 username, ITEM27 type&quot;;
	   
	   var artid_1 = &quot;ART00311201065486776&quot;; //特定及驗證人員審查規定
	   var temp_1 =&quot;,ITEM19 create_date,ITEM80 sn,ITEM15 appname,ITEM15 username,ITEM30 type&quot;;

	}else if(artifact_name == &quot;特定及驗證人員訓練記錄&quot;){
		
	   var artid = &quot;ART00961274098363348&quot;; //特定及驗證人員訓練記錄 V1
	   var temp =&quot;,ITEM2 create_date,ITEM9 sn,ITEM144 appname,ITEM43 username,ITEM17 type&quot;;
	   
	   var artid_1 = &quot;ART00071223000845573&quot;; //特定及驗證人員訓練記錄
	   var temp_1 =&quot;,ITEM2 create_date,ITEM9 sn,ITEM144 appname,ITEM43 username,ITEM17 type&quot;;

	}else if(artifact_name == &quot;操作人員工安訓練規定&quot;){
		
	   var artid = &quot;ART00971274146898338&quot;; //操作人員工安訓練規定 V1
	   var temp =&quot;,ITEM12 create_date,ITEM9 sn,ITEM144 appname,ITEM24 username&quot;;
	   
	   var artid_1 = &quot;ART00751258293039449&quot;; //操作人員工安訓練規定
	   var temp_1 =&quot;,ITEM12 create_date,ITEM9 sn,ITEM144 appname,ITEM24 username&quot;;

	}else if(artifact_name == &quot;操作人員工安訓練記錄&quot;){
		
	   var artid = &quot;ART00981274150895006&quot;; //操作人員工安訓練記錄 V1
	   var temp=&quot;,ITEM12 create_date,ITEM9 sn,ITEM144 appname,ITEM24 username&quot;;
	   
	   var artid_1 = &quot;ART00771258438655622&quot;;//操作人員工安訓練記錄
	   var temp_1 =&quot;,ITEM12 create_date,ITEM9 sn,ITEM144 appname,ITEM24 username&quot;;
    }else if(artifact_name == &quot;年度教育訓練請假單&quot;){
		
	   var artid = &quot;ART00991274152867265&quot;; //年度教育訓練請假單 V1
	   var temp =&quot;,ITEM12 create_date,ITEM10 sn,ITEM23,ITEM144 appname,ITEM24 username&quot;;
	   
	   var artid_1 = &quot;ART01811235204823565&quot;;//年度教育訓練請假單
	   var temp_1 =&quot;,ITEM12 create_date,ITEM10 sn,ITEM23,ITEM144 appname,ITEM24 username&quot;;
    }

	//文件狀態
	var Status = Form.getValue(&quot;Status&quot;);	

	if (&quot;全部&quot;.equals(Status) || &quot;已結案&quot;.equals(Status) || &quot;未結案&quot;.equals(Status)|| &quot;已作廢&quot;.equals(Status)){
	  try{
		var sql = &quot;SELECT A.INSID,A.ITEM2,A.ITEM12,A.ITEM186&quot; + temp;
		    sql +=&quot;  FROM &quot;+ artid +&quot;_INS A&quot;;
		    sql +=&quot; WHERE ITEM2 != &apos;null&apos; &quot; ;
		    sql += getQueryCondition_trn(artifact_name) + check_status(Status) + check_factory(v_factory,artifact_name);
		if (artid_1 != &quot;&quot;){
            sql +=&quot; union  &quot;;
			sql +=&quot;SELECT A.INSID,A.ITEM2,A.ITEM12,A.ITEM186&quot; + temp_1;
		    sql +=&quot;  FROM &quot;+ artid_1 +&quot;_INS A&quot;;
		    sql +=&quot; WHERE ITEM2 != &apos;null&apos; &quot; ;
            sql += getQueryCondition_trn(artifact_name)  + check_status(Status) + check_factory(v_factory,artifact_name);
		}	
		    sql += &quot;ORDER BY ITEM12 &quot;;		
		var vec = Client.SQLloadValue(sql);
		Client.setLocalObject(&quot;vec&quot;,vec);
	 }catch(e){
		java.lang.System.out.println(&quot;TRN_List_error=&quot;+e);	
	 }
   // 已結案(被退件過) or 未結案(被退件過)
   }
	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;Count&quot;,vec.size()+&quot;&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);
	showTable_TRN(1,vec,artifact_name);
}//function search_data()


function getQueryCondition_trn(artifact_name){
	var sSQL=&quot;&quot;;	
	// 起始日期
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	if (&quot;true&quot;.equals(ckbSDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
          if(artifact_name == &quot;特定及驗證人員審查規定&quot;){
		    sSQL += &quot; AND ITEM19 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
		  }else if(artifact_name == &quot;特定及驗證人員訓練記錄&quot;){
			sSQL += &quot; AND ITEM2 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
		  }else{
		    sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot; 00:00&apos;&quot;;
		  }			
		}
	}	
	// 終止日期
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);
	if (&quot;true&quot;.equals(ckbEDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
		  if(artifact_name == &quot;特定及驗證人員審查規定&quot;){
		    sSQL += &quot; AND ITEM19 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
		  }else if(artifact_name == &quot;特定及驗證人員訓練記錄&quot;){
			sSQL += &quot; AND ITEM2 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
		  }else{
		    sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot; 23:59&apos;&quot;;
		  }			
		}
	}	

	// 申請人姓名
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
		if(artifact_name == &quot;特定及驗證人員審查規定&quot;){
		    sSQL += &quot; AND ITEM3 = &apos;&quot; + MemName + &quot;&apos;&quot;;
		}else{
		    sSQL += &quot; AND ITEM144 like &apos;&quot; + MemName + &quot;%&apos;&quot;;
		}
	}
			
	// 部門
	var v_dptno = Form.getValue(&quot;dptno&quot;);	
	var v_dptno1 = Form.getValue(&quot;dptno1&quot;);	
	if (!&quot;&quot;.equals(v_dptno)) {
	   if(v_dptno== &quot;==請選擇==&quot;){
		    sSQL += &quot; AND ITEM186 like &apos;%&apos;&quot;;
		}else{
		   sSQL += &quot; AND ITEM186 like &apos;%&quot; + v_dptno + &quot;%&apos;&quot;;
		}
	}else{
	  if (!&quot;&quot;.equals(v_dptno1)) {
		    sSQL += &quot; AND ITEM186 like &apos;%&quot; + v_dptno + &quot;%&apos;&quot;;	
	
	 }	
	}

	
	// 文件編號
	var Sn = Form.getValue(&quot;Sn&quot;);	
	if (!&quot;&quot;.equals(Sn)) {
		if(artifact_name == &quot;特定及驗證人員審查規定&quot;){
		    sSQL += &quot; AND ITEM80 like &apos;%&quot; + Sn + &quot;%&apos;&quot;;
		}else if(artifact_name == &quot;年度教育訓練請假單&quot;){
			sSQL += &quot; AND ITEM10 like &apos;%&quot; + Sn + &quot;%&apos;&quot;;
		}else{
		    sSQL += &quot; AND ITEM9 like &apos;%&quot; + Sn + &quot;%&apos;&quot;;
		}
	}		

	return sSQL;	
}

function check_status(Status){
	var sSQL=&quot;&quot;;
	
    if (&quot;已結案&quot;.equals(Status)) {
				sSQL += &quot; AND ITEM115 is not null &quot;;
	}else if (&quot;未結案&quot;.equals(Status)){
				sSQL += &quot; AND ITEM115 is null AND ITEM155 = &apos;false&apos; &quot;;	
	}else if (&quot;已作廢&quot;.equals(Status)){
				sSQL += &quot; AND ITEM155 = &apos;true&apos;  &quot;;			
	}else{
	     sSQL += &quot;&quot;;
	}	
    return sSQL;		
}

//抓取廠別
function check_factory(v_factory,artifact_name){
  var sSQL=&quot;&quot;;
  if( artifact_name == &quot;特定及驗證人員訓練記錄&quot;){
	  sSQL += &quot; and ITEM4 =&apos;&quot;+ v_factory +&quot;&apos;&quot;;	
  }else{
      sSQL += &quot; and ITEM2 =&apos;&quot;+ v_factory +&quot;&apos;&quot;;	
  }
    return sSQL;
}
//===================================================================
// TRN查詢
// 文件變更單分頁顯示 P:第P頁 N:每頁顯示N筆 T:總頁數
//===================================================================	
function showTable_TRN(P){	

	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var vec = Client.getLocalObject(&quot;vec&quot;);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
	    Form.setValue(&quot;Closefg&quot;,&quot;Y&quot;);	
	    Form.setValue(&quot;Count&quot;,vec.size()+&quot;&quot;);
	    Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	if (vec.size()&gt;0) {
		var vTot = 0;
		var vI = 0;
//		for (var i = 0 ; i &lt; vec.size(); i++) {
         for (var i = (P-1)*N ; i &lt; E; i++) {
			var vG =0;
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			if (task != null){
				var processname = task.getProcessName();
				if(&quot;自動&quot;==processname){
					processname=&quot;申請人列印&quot;;
					}				
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;					
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);				
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				if( &quot;已結案&quot;==processname || &quot;作廢&quot; ==processname ){
					table.setValueAt(&quot;--&quot;, row, &quot;申請人&quot;);
				}else{
					if(&quot;申請人列印&quot;==processname){
						table.setValueAt(&quot;申請人&quot;,  row, &quot;目前處理者&quot;);
					}else{
						table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
					}
				}				
			}
			table.setValueAt((i + 1) + &quot;&quot;, row, &quot;序&quot;);			
			table.setValueAt(hm.get(&quot;ITEM186&quot;), row, &quot;部門&quot;);				
			table.setValueAt(hm.get(&quot;username&quot;), row, &quot;申請人&quot;);
			table.setValueAt(hm.get(&quot;appname&quot;), row, &quot;填單人&quot;);			
			table.setValueAt(hm.get(&quot;create_date&quot;),  row, &quot;申請日期&quot;);	
            table.setValueAt(hm.get(&quot;type&quot;), row, &quot;文件類型&quot;);		
            table.setValueAt(hm.get(&quot;sn&quot;), row, &quot;文件編號&quot;);							
			table.setValueAt(hm.get(&quot;INSID&quot;),  row, &quot;InsID&quot;);					
		
			}catch(e){}
		}
	   //if (vec.size()&gt;0)	
	   }else{
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
       }  
}//function showTable(P)

function selectClassName(){
	var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);
    //抓取BPM 短期資料庫連線
    loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
  	var conn = Client.createSessionConnection(conn_name);		
	
	var vApp_Dep_ID = Form.getValue(&quot;App_Dep_ID&quot;) ;
//	var vApp_ID = Form.getValue(&quot;App_Dep_ID&quot;) ;
	var vDate  = Form.getValue(&quot;date_beg_d&quot;);	
    // 20091028 人事育如:因2G5只有一個人,若請假會無法帶出課程,因會與2G6一起上,故寫死-BY HEATHER	
	if (&quot;2G5&quot;.equals(vApp_Dep_ID)){
		vApp_Dep_ID = &quot;2G6&quot;;
	}
	var vTrn_date = vDate.substring(0,4)+&apos;/&apos;+vDate.substring(5,7)+&apos;/&apos;+vDate.substring(8,10);		
	// 取得年度教育訓練課程名稱及課程編碼
	var vSQL = &quot;select distinct class_name,class_no,teacher_id from trnm040 where trn_date_beg = date(&apos;&quot;+vTrn_date+&quot;&apos;) and dptno=&apos;&quot;+vApp_Dep_ID+&quot;&apos; ;&quot;;				
	Client.addDebugLog(vSQL);	
	try{
		var prjList = conn.loadValue(vSQL) ;
		var memberNameList  = new java.util.Vector();
			memberNameList.add(&quot;&quot;);
		var comboBox = Form.getComponent(&quot;className&quot;);
			comboBox.removeAllItems();
		if (prjList.size() &gt; 0) {
			comboBox.addItem(&quot;  &quot;);
			for(var i=0;i&lt;prjList.size();i++){
				var vRowData = prjList.get(i);
				comboBox.addItem(vRowData.get(&quot;class_name&quot;));
			}
			Form.setValue(&quot;class_no&quot;,vRowData.get(&quot;class_no&quot;));//課程編碼
			Form.setValue(&quot;teacher_id&quot;,vRowData.get(&quot;teacher_id&quot;));//講師編碼
		}
		conn.commit();
		conn.close();	
	}catch(e){
		conn.commit();
		conn.close();					
		Form.showMessageDialog(&quot;沒有缺課紀錄!\n請確認!!&quot;);
	}
}

function deleteTrnm040_050_010(conn){
	
	var ls_class_name = Form.getValue(&quot;className&quot;);
	var ls_empno = Form.getValue(&quot;App_ID&quot;);
	var ld_trn_date = Form.getValue(&quot;p_date_beg_d&quot;);
	var	vTrn_date = ld_trn_date.substring(0,4)+&apos;/&apos;+ld_trn_date.substring(5,7)+&apos;/&apos;+ld_trn_date.substring(8,10);
	var insid  = Form.getArtInstanceID();
	var sql_1=&quot;delete trnm040 where empno =&apos;&quot;+ls_empno+&quot;&apos;AND trn_date_beg =date(&apos;&quot;+vTrn_date+&quot;&apos;)  AND class_name = &apos;&quot;+ls_class_name+&quot;&apos; ;&quot;;
	var sql_2=&quot;delete trnm010 where empno =&apos;&quot;+ls_empno+&quot;&apos;AND trn_date_beg =date(&apos;&quot;+vTrn_date+&quot;&apos;)  AND class_name = &apos;&quot;+ls_class_name+&quot;&apos; ;&quot;;
	var sql_3=&quot;delete trnm050 where af = &apos;&quot;+insid+&quot;&apos;;&quot;;
	var msg = &quot;&quot;;
	try{
		var rs_1 = conn.updateValue(sql_1);
		conn.commit();
		var rs_2 = conn.updateValue(sql_2);
		conn.commit();
		var rs_3 = conn.updateValue(sql_3);
		conn.commit();
	}catch(e){
		msg =&quot;deleteTrnm040_050_010_error:&quot;+e;
		conn.rollback();
		conn.close();
	}finally{
		
	}
	return msg;
}

function insertTrnm040(conn){
// 先讀取一筆上課紀錄	
    var msg=&quot;&quot;;
    var ls_temp_value = &quot;N&quot;;
	var ld_beg = Form.getValue(&quot;date_beg_d&quot;);
	var ld_end = Form.getValue(&quot;date_end_d&quot;);	
	var ls_dptno_org = Form.getValue(&quot;App_Dep_ID&quot;);
	if (&quot;2G5&quot;.equals(ls_dptno_org)){
		ls_dptno_org = &quot;2G6&quot;;
		ls_temp_value = &quot;Y&quot;;
	}
	if (&quot;2T0&quot;.equals(ls_dptno_org)){
		ls_dptno_org = &quot;2D6&quot;;
		ls_temp_value = &quot;Y&quot;;
	}
	if (&quot;2D0&quot;.equals(ls_dptno_org)){
		ls_dptno_org = &quot;2D3&quot;;
		ls_temp_value = &quot;Y&quot;;
	}
	if (&quot;2A2&quot;.equals(ls_dptno_org)){
		ls_dptno_org = &quot;2A3&quot;;
		ls_temp_value = &quot;Y&quot;;
	}
	var ls_class_name = Form.getValue(&quot;className&quot;);
	var ls_empno = Form.getValue(&quot;App_ID&quot;);
	var ls_upd_user = Form.getValue(&quot;Verify_ID&quot;);
	var ld_trn_date = Form.getValue(&quot;p_date_beg_d&quot;);
	var date_beg_h=Form.getValue(&quot;p_date_beg_h&quot;);
	var date_beg_m=Form.getValue(&quot;p_date_beg_m&quot;);
	var date_end_h=Form.getValue(&quot;p_date_end_h&quot;);
	var date_end_m=Form.getValue(&quot;p_date_end_m&quot;);	
	var	vTrn_time_beg = date_beg_h+&quot;:&quot;+date_beg_m+&quot;:00&quot;;//補課時間起
	var vTrn_time_end = date_end_h+&quot;:&quot;+date_end_m+&quot;:00&quot;;//補課時間訖
	var	vTrn_date = ld_trn_date.substring(0,4)+&apos;/&apos;+ld_trn_date.substring(5,7)+&apos;/&apos;+ld_trn_date.substring(8,10);	
    var ls_class_no = Form.getValue(&quot;class_no&quot;);
    var ls_teacher_id = Form.getValue(&quot;teacher_id&quot;);	
	var vSQL1 = &quot; SELECT distinct trn_days, trn_hours, trn_where, class_type, teacher FROM trnm040 &quot;; 
 	    vSQL1 += &quot; WHERE ( trn_date_beg = date(&apos;&quot;+ld_beg+&quot;&apos;)) AND &quot;;
		vSQL1 += &quot; ( trn_date_end = date(&apos;&quot;+ld_end+&quot;&apos;)) AND &quot;;
		vSQL1 += &quot; ( dptno = &apos;&quot;+ls_dptno_org+&quot;&apos; ) AND &quot; ;
		vSQL1 += &quot; ( class_name =&apos;&quot;+ls_class_name+&quot;&apos; ) ;&quot;;
	Client.addDebugLog(&quot;insertTrnm040 SQL1&quot;+vSQL1);
	try{
		var vec = conn.loadValue(vSQL1) ;		
		if(vec.size()&gt;0){
// 為了避免書記先維護了上課紀錄檔so 再檢查一次,若沒有則再進行新增
			var vCheck=&quot;select *from trnm040 where empno =&apos;&quot;+ls_empno+&quot;&apos;AND trn_date_beg =date(&apos;&quot;+vTrn_date+&quot;&apos;)  AND class_name = &apos;&quot;+ls_class_name+&quot;&apos; ;&quot;				
				var vector = conn.loadValue(vCheck);
				if (vector.size()&gt;0) {
					msg +=&quot;訓練履歷卡已有資料\n!&quot;;
				}
		    if (&quot;Y&quot;.equals(ls_temp_value) &amp;&amp; &quot;2G6&quot;.equals(ls_dptno_org)){
				ls_dptno_org = &quot;2G5&quot;;
			}
			if (&quot;Y&quot;.equals(ls_temp_value) &amp;&amp; &quot;2D6&quot;.equals(ls_dptno_org)){
				ls_dptno_org = &quot;2T0&quot;;
			}
			if (&quot;Y&quot;.equals(ls_temp_value) &amp;&amp; &quot;2D3&quot;.equals(ls_dptno_org)){
				ls_dptno_org = &quot;2D0&quot;;
			}
			if (&quot;Y&quot;.equals(ls_temp_value) &amp;&amp; &quot;2A3&quot;.equals(ls_dptno_org)){
				ls_dptno_org = &quot;2A2&quot;;
			}
			var lc_trn_days = vec.get(0).get(&quot;trn_days&quot;);
			var lc_trn_hours= vec.get(0).get(&quot;trn_hours&quot;);
			var ls_trn_where= vec.get(0).get(&quot;trn_where&quot;);
			var ls_class_type= vec.get(0).get(&quot;class_type&quot;);
			var ls_teacher = vec.get(0).get(&quot;teacher&quot;);
			var vSQL2=&quot;INSERT INTO trnm040 &quot; ;
				vSQL2+=&quot;( trn_date_beg,trn_date_end,trn_days,trn_hours, &quot; ;
				vSQL2+=&quot; trn_where,class_type,class_name,teacher, &quot;;
				vSQL2+=&quot; empno,dptno,trn_flag,upd_user,upd_dtime,trn_time_beg,trn_time_end,class_no,teacher_id ) &quot;; 
				vSQL2+=&quot; VALUES ( &apos;&quot;+ld_trn_date+&quot;&apos;,&apos;&quot;+ld_trn_date+&quot;&apos;,&apos;&quot;+lc_trn_days+&quot;&apos;,&apos;&quot;+lc_trn_hours+&quot;&apos;,&quot;;	
				vSQL2+=&quot;&apos;&quot;+ls_trn_where+&quot;&apos;,&apos;&quot;+ls_class_type+&quot;&apos;,&apos;&quot;+ls_class_name+&quot;&apos;,&apos;&quot;+ls_teacher+&quot;&apos;,&quot;;
				vSQL2+=&quot;&apos;&quot;+ls_empno+&quot;&apos;,&apos;&quot;+ls_dptno_org+&quot;&apos;,&apos;Y&apos;,&apos;&quot;+ls_upd_user+&quot;&apos;,current,&apos;&quot;+vTrn_time_beg+&quot;&apos;,&quot;;
				vSQL2+=&quot;&apos;&quot;+vTrn_time_end+&quot;&apos;,&apos;&quot;+ls_class_no+&quot;&apos;,&apos;&quot;+ls_teacher_id+&quot;&apos;);&quot;;
				Client.addDebugLog(&quot;insertTrnm040 SQL2&quot;+vSQL2);				
		    var result = conn.updateValue(vSQL2);
			conn.commit();	
			if( true==result){
//            try{       // 不要在for loop 中try catch
	             var vCheck=&quot;select *from trnm010 where empno =&apos;&quot;+ls_empno+&quot;&apos;AND trn_date_beg =date(&apos;&quot;+vTrn_date+&quot;&apos;)  AND class_name = &apos;&quot;+ls_class_name+&quot;&apos; ;&quot;				
	             var vector = conn.loadValue(vCheck);
	             if (vector.size()&gt;0) {
		                 msg +=&quot;TRND010_年度教育訓練已有資料!\n!&quot;;
	             }else{	
		                 try{
			               var ls_wkgreat = Form.getValue(&quot;JobLevel&quot;).substring(0,2);
		                }catch(e){
			                msg +=&quot;職等不得為空\n&quot;;
		                }
	             var vSQL3=&quot; INSERT INTO trnm010 &quot; ;
		             vSQL3+=&quot;( empno,dptno,wkgreat,class_inout,class_type, &quot; ;  
		             vSQL3+=&quot; trn_where,class_name,trn_date_beg,trn_date_end,trn_hours, &quot;  ;
		             vSQL3+=&quot; teacher,trn_time_beg,trn_time_end,upd_user,upd_dtime,class_no,teacher_id ) &quot;;
		             vSQL3+=&quot; VALUES ( &apos;&quot;+ls_empno+&quot;&apos;,&apos;&quot;+ls_dptno_org+&quot;&apos;,&apos;&quot;+ls_wkgreat+&quot;&apos;,&apos;I&apos;,&apos;&quot;+ls_class_type+&quot;&apos;,&quot;;							
		             vSQL3+=&quot;&apos;&quot;+ls_trn_where+&quot;&apos;,&apos;&quot;+ls_class_name+&quot;&apos;,&apos;&quot;+ld_trn_date+&quot;&apos;,&apos;&quot;+ld_trn_date+&quot;&apos;,&apos;&quot;+lc_trn_hours+&quot;&apos;,&quot; ;							
		             vSQL3+=&quot;&apos;&quot;+ls_teacher+&quot;&apos;,&apos;&quot;+vTrn_time_beg+&quot;&apos;,&apos;&quot;+vTrn_time_end+&quot;&apos;,&apos;&quot;+ls_upd_user+&quot;&apos;,current,&quot;;
		             vSQL3+=&quot;&apos;&quot;+ls_class_no+&quot;&apos;,&apos;&quot;+ls_teacher_id+&quot;&apos; )&quot;;
	                 Client.addDebugLog(&quot;insertTrnm040 SQL3&quot;+vSQL3);	
	             var result = conn.updateValue(vSQL3);	
				 conn.commit();						
		          if(true==result){
 		          }else{
			             conn.rollback();
		                 msg +=&quot;新增至教育訓練系統(trnm010)失敗!\n&quot;+vSQL3;
		                 Client.addExeLog(&quot;[SQL Code]:&quot;+vSQL3);
		          }
	           }
//          }catch(e){
//			 msg +=&quot;新增至教育訓練系統(trnm010)失敗!\n&quot;;
//          }	
			}else{
						conn.rollback();
						msg +=&quot;新增至教育訓練系統(trnm040)失敗!\n&quot;+vSQL2;
						Client.addExeLog(&quot;[SQL Code]:&quot;+vSQL2);
			}
		}else{
			msg +=&quot;TRND040_年度教育訓練找不到資料!\n&quot;+vSQL1;
		}
		}catch(e){
			 msg +=&quot;新增請假檔失敗(trnm040)失敗!\n&quot;;
		}finally{
//			   conn.close();
	    }	
	return msg;
}

function insertTrnm050(conn){
// insert to 請假紀錄檔,有可能沒有補課日期	
	    var msg=&quot;&quot;;	
		var Ob_date = new Packages.pase.agenda.MyDate();
		var thisyear = Ob_date.getCurrentDate(&quot;Y&quot;); 
		var artid = Form.getArtifactID();
		var factory=Form.getValue(&quot;Factory&quot;);
		var req_empno=Form.getValue(&quot;App_ID&quot;);	
		var req_class_name=Form.getValue(&quot;Subject&quot;);
		var req_dptno=Form.getValue(&quot;App_Dep_ID&quot;);	
		var req_date_end_d=Form.getValue(&quot;date_end_d&quot;);
		var req_date_end_h=Form.getValue(&quot;date_end_h&quot;);
		var req_date_end_m=Form.getValue(&quot;date_end_m&quot;);
		var req_date_end=req_date_end_d+req_date_end_h+req_date_end_m;
		var req_date_beg_d=Form.getValue(&quot;date_beg_d&quot;);
		var req_date_beg_h=Form.getValue(&quot;date_beg_h&quot;);
		var req_date_beg_m=Form.getValue(&quot;date_beg_m&quot;);
		var vReason = Form.getValue(&quot;FTextArea0&quot;);  // 請假原因
		var req_date_beg=req_date_beg_d+req_date_beg_h+&apos;:&apos;+ req_date_beg_m;	
		var req_hours=((req_date_end_h * 60 + req_date_end_m*1 ) - ( req_date_beg_h * 60 + req_date_beg_m*1))/60;	
		// 將日期轉為 mm-dd-yyyy
		var req_date_end_d1 = req_date_end.substring(5,7)+&apos;-&apos;+req_date_end.substring(8,10)+&apos;-&apos;+req_date_end.substring(0,4);
		var req_date_beg_d1 = req_date_beg.substring(5,7)+&apos;-&apos;+req_date_beg.substring(8,10)+&apos;-&apos;+req_date_beg.substring(0,4);
// -----補課日期---------		
		var vTrn_date=Form.getValue(&quot;p_date_beg_d&quot;);  // 補課日期
		var date_beg_h=Form.getValue(&quot;p_date_beg_h&quot;);
		var date_beg_m=Form.getValue(&quot;p_date_beg_m&quot;);
		var date_end_h=Form.getValue(&quot;p_date_end_h&quot;);
		var date_end_m=Form.getValue(&quot;p_date_end_m&quot;);	
		
		var vTrn_time_beg = &quot;&quot;;
		var vTrn_time_end = &quot;&quot;;
		var ls_class_no = Form.getValue(&quot;class_no&quot;);//課程編碼
		var ls_teacher_id = Form.getValue(&quot;teacher_id&quot;);//講師編碼
		
			vTrn_date = vTrn_date.substring(0,4)+&apos;/&apos;+vTrn_date.substring(5,7)+&apos;/&apos;+vTrn_date.substring(8,10);
// 有日期一定要有時間			
			vTrn_time_beg = date_beg_h+&apos;:&apos;+date_beg_m;//補課時間起
			vTrn_time_end = date_end_h+&apos;:&apos;+date_end_m;//補課時間訖		
try{
	var req_upd_user=Form.getValue(&quot;Verify_ID&quot;);			
	var insid  = Form.getArtInstanceID();
	var SQL = &quot;SELECT * from trnm050 where af = &apos;&quot;+insid+&quot;&apos;;&quot; 		// 單號已存在, 就判讀為無法再收件
		Client.addDebugLog(SQL);
	var vector = conn.loadValue(SQL);		
		if (vector.size()&lt;=0) {
// trnm050所需寫入的欄位有 empno、dptno、trn_date_beg、trn_date_end、trn_hours、class_name、upd_user、upd_dtime、trn_date、af		
			vReason = vReason.trim();
		var upsql = &quot;Insert Into trnm050(empno,dptno,trn_date_beg,trn_date_end,trn_hours,class_name,upd_user,upd_dtime,trn_date,af,trn_abs_desc,trn_time_beg,trn_time_end,class_no,teacher_id) Values (&quot;;
			upsql +=&quot;&apos;&quot;+req_empno+&quot;&apos;,&apos;&quot;+req_dptno+&quot;&apos;,&apos;&quot;+req_date_beg_d+&quot;&apos;,&apos;&quot;+req_date_end_d+&quot;&apos;,&apos;&quot;+req_hours+&quot;&apos;,&apos;&quot;+req_class_name+&quot;&apos;,&apos;&quot;+req_upd_user+&quot;&apos;,current,&apos;&quot;+vTrn_date+&quot;&apos;,&apos;&quot;+insid+&quot;&apos;,&apos;&quot;+vReason+&quot;&apos;,&apos;&quot;+ vTrn_time_beg+&quot;&apos;,&apos;&quot;+vTrn_time_end +&quot;&apos;,&apos;&quot;+ls_class_no+&quot;&apos;,&apos;&quot;+ls_teacher_id+&quot;&apos;);&quot;;
		    Client.addDebugLog(upsql);
		var result = conn.updateValue(upsql);
		conn.commit();	
			if(true==result){		
			}else{
				conn.rollback();			
				 msg +=&quot;新增至教育訓練系統(trnm050)失敗!\n&quot;+upsql;
			}
		}
  }catch(e){
			 msg +=&quot;新增請假記錄檔失敗(trnm050)失敗!\n&quot;;
  }					
	return msg;
}
// 20091003 增加判斷trnm050是否已有請假記錄存在-by heather
function trnm050_chk(){
	var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);
    //抓取BPM 短期資料庫連線
    loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
  	var conn = Client.createSessionConnection(conn_name);	
			
	var ls_empno = Form.getValue(&quot;App_ID&quot;);
	var ld_beg = Form.getValue(&quot;date_beg_d&quot;);
	var ld_end = Form.getValue(&quot;date_end_d&quot;);
	var ls_class_name = Form.getValue(&quot;className&quot;);
	var vSQL3 = &quot; SELECT count(empno) as emp_count FROM trnm050 &quot;; 
 	    vSQL3 += &quot; WHERE ( trn_date_beg = date(&apos;&quot;+ld_beg.substring(5,7)+&apos;/&apos;+ld_beg.substring(8,10)+&apos;/&apos;+ld_beg.substring(0,4)+&quot;&apos;)) AND &quot;;
		vSQL3 += &quot; ( trn_date_end = &apos;&quot;+ld_end+&quot;&apos;) AND &quot;;	
		vSQL3 += &quot; ( empno = &apos;&quot;+ls_empno+&quot;&apos;) AND &quot;;
		vSQL3 += &quot; ( class_name =&apos;&quot;+ls_class_name+&quot;&apos; ) ;&quot;;
	    Client.addDebugLog(vSQL3);				
	var vec1 = conn.loadValue(vSQL3) ;
	if( vec1.size()&gt;0){
		for(var i=0;i&lt;vec1.size();i++){
			var vcount = vec1.get(i).get(&quot;emp_count&quot;);
		    if ( vcount &gt; 0 ) {
				
				if( conn != null){
					conn.close();
				}
				return &quot;true&quot;;		
			}
		}
		
    }
}

function trnm050chk(){
	var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);
    //抓取BPM 短期資料庫連線
    loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
  	var conn = Client.createSessionConnection(conn_name);	
			
	var ls_empno = Form.getValue(&quot;App_ID&quot;);
	var ld_beg = Form.getValue(&quot;date_beg_d&quot;);
	var ld_end = Form.getValue(&quot;date_end_d&quot;);
	var ls_class_name = Form.getValue(&quot;className&quot;);
	var vSQL3 = &quot; SELECT count(empno) as emp_count FROM trnm050 &quot;; 
 	    vSQL3 += &quot; WHERE ( trn_date_beg = &apos;&quot;+ld_beg+&quot;&apos;) AND &quot;;
		vSQL3 += &quot; ( trn_date_end = &apos;&quot;+ld_end+&quot;&apos;) AND &quot;;	
		vSQL3 += &quot; ( empno = &apos;&quot;+ls_empno+&quot;&apos;) AND &quot;;
		vSQL3 += &quot; ( class_name =&apos;&quot;+ls_class_name+&quot;&apos; ) ;&quot;;
	var flag = false;
	try{
		var vec1 = conn.loadValue(vSQL3) ;
		if( vec1.size()&gt;0){		
			var vcount = vec1.get(0).get(&quot;emp_count&quot;);
		    if ( vcount &gt; 0 ) {
				flag = true;		
			}		
		}
		return flag;
	}catch(e){
		Client.addDebugLog(e+&quot;: sql = &quot;+vSQL3);
	}finally{
		conn.close();
	}
}

function setColumn(value){	
		Form.getComponent(&quot;FLabel16&quot;).setVisible(value);
		Form.getComponent(&quot;p_date_beg_d&quot;).setVisible(value);
		Form.getComponent(&quot;p_date_beg_h&quot;).setVisible(value);
		Form.getComponent(&quot;FLabel24&quot;).setVisible(value);
		Form.getComponent(&quot;p_date_beg_m&quot;).setVisible(value);
		Form.getComponent(&quot;FLabel18&quot;).setVisible(value);
		Form.getComponent(&quot;p_date_end_h&quot;).setVisible(value);
		Form.getComponent(&quot;FLabel31&quot;).setVisible(value);
		Form.getComponent(&quot;p_date_end_m&quot;).setVisible(value);
		Form.getComponent(&quot;FLabel34&quot;).setVisible(value);
	
}

//===================================================================
// TRN 抓取User 部門權限
//===================================================================	
function trn_check_user(v_factory,temp1,temp2){

   	//抓取BPM 短期資料庫連線
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
  	var conn = Client.createSessionConnection(conn_name);	 
	// 取得授權部門	
	var ls_App_ID = Form.getValue(&quot;App_ID&quot;);	
	var SQL = &quot; select distinct trim(a.dptno)||&apos;-&apos;||trim(b.dptcname) dptcname from empm015 a,empm030 b &quot;;
	    SQL += &quot; where a.dptno = b.dptno and ( b.flag= &apos;N&apos; or b.flag is  null) and a.empno=&apos;&quot;+ls_App_ID+&quot;&apos; order by 1;&quot;;
	try{	
		var vec = conn.loadValue(SQL);
		if(vec.size()&gt;0){
//		var memberNameList  = new java.util.Vector();
//		memberNameList.add(&quot;&quot;);
		var comboBox = Form.getComponent(temp1);
		comboBox.removeAllItems();
		if(Form.getValue(&quot;dptno_t&quot;) !=&quot;&quot;){	
			comboBox.addItem(Form.getValue(&quot;dptno_t&quot;));
		   for(var i=0;i&lt;vec.size();i++){
		    if (!vec.get(i).get(&quot;dptcname&quot;).equals(Form.getValue(&quot;dptno_t&quot;) )) {				 
			 comboBox.addItem(vec.get(i).get(temp2));	
			 }
		 }
	    }else{		
		comboBox.addItem(&quot;==請選擇==&quot;);			
		 for(var i=0;i&lt;vec.size();i++){
			 comboBox.addItem(vec.get(i).get(temp2));				
		 }
		} 
		 
		}	
	}catch(e){
		
	}finally{
		conn.close();
	}

//	if(conn != null){
//		try{
//			conn.commit();
//			conn.close();
//		}catch(e){
//			java.lang.System.out.println(&quot;expection in informixDB e=&quot;+e);
//		}
//		conn.close();
//	}		
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00361300344812880</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2017/10/05 14:57:44</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.BAS</string> 
     </void> 
     <void property="id"> 
      <string>SCL00361300344812880</string> 
     </void> 
     <void property="name"> 
      <string>BAS</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function serach_user_data(temp){
	var member_no =	Form.getValue(&quot;App_MemID&quot;);	
	var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);
	var v_memid = Form.getValue(&quot;Verify_ID&quot;);
		 
	//抓取班別和歸屬單位
	 var SQL  = &quot;select MILITARYSERVICE,workplace&quot;;
         SQL += &quot; ,(select name from dep_geninf where id=trim(ASSOCIATION))assign_dept &quot;;
         SQL += &quot; from mem_geninf&quot;;
         SQL += &quot; where MEMID=&apos;&quot; + member_no + &quot;&apos; and upper(RESIGN) &lt;&gt; &apos;TRUE&apos;&quot;

	 var vec = Client.SQLloadValue(SQL);
	   if (vec.size()&gt;0){		
		   var v_work_type = vec.get(0).get(&quot;MILITARYSERVICE&quot;);
		   Form.setValue(&quot;Work_Type&quot;,v_work_type);
		   var v_workplace =vec.get(0).get(&quot;workplace&quot;).substr(4,3);
		   if( v_workplace ==&quot;2L1&quot;){
		      var v_assign_dept = vec.get(0).get(&quot;assign_dept&quot;);
		      var v_assign_dept_id = v_assign_dept.substr(0,3);
			  
			  Form.setValue(&quot;App_Dep&quot;,v_assign_dept);
		      Form.setValue(&quot;App_Dep_ID&quot;,v_assign_dept_id);	
           }
		   
	     // 驗證開單人員是否有申請此部門人員的權限，同TRN權限
         check_trn_user(v_factory,v_memid,v_workplace,v_assign_dept_id,temp);// 驗證TRN授權部門   
	  }	   
}
	
function check_trn_user(v_factory,v_memid,v_workplace,v_assign_dept_id,temp){
   	//抓取BPM 短期資料庫連線
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
  	var conn = Client.createSessionConnection(conn_name);	 

	// 取得授權部門	
    var vSQL = &quot; select trim(a.dptno) dptno,&quot;;
        vSQL +=	&quot; trim(a.dptno)||&apos;-&apos;||(select trim(b.dptcname) from empm030 b where b.dptno=a.dptno and ( flag= &apos;N&apos; or flag is  null))&quot;;
        vSQL +=	&quot; from empm015 a&quot;;
        vSQL +=	&quot; where a.prgmid=&apos;TRN&apos;&quot;;
        vSQL +=	&quot; and a.empno=&apos;&quot;+v_memid+&quot;&apos;;&quot;;
		
	var vec = conn.loadValue(vSQL);	

	if (vec.size() &gt; 0){
	    var flag=&quot;&quot;;
		for(var i = 0;i&lt;vec.size();i++){
			if(v_workplace == vec.get(i).get(&quot;dptno&quot;) &amp;&amp; v_workplace !=&quot;2L1&quot;){
			  var flag=&quot;true&quot;; 	
//			 }else if( v_workplace ==&quot;2L1&quot; &amp;&amp; v_assign_dept_id == vec.get(i).get(&quot;dptno&quot;) ){ 
		     }else if( v_workplace ==&quot;2L1&quot; &amp;&amp; &quot;2L1&quot;== vec.get(i).get(&quot;dptno&quot;) ){		
				var flag=&quot;true&quot;; 					 
			}else if(vec.get(i).get(&quot;dptno&quot;)==&quot;ALL&quot;){
				var flag=&quot;true&quot;; 	
			}
		}
		if(flag !=&quot;true&quot; ){
		  if(v_workplace ==&quot;2L1&quot;){ 	
		   Form.showMessageDialog(&quot;您無此【&quot; + v_workplace + &quot;】單位的建立權限!!\n&quot;);
		  }else{
		   Form.showMessageDialog(&quot;您無此【&quot; + v_workplace + &quot;】單位的建立權限，請通知HR開放部門權限!!\n&quot;);
		  }
		   clear(temp,&quot;0&quot;);//清空內容資訊		  
		}else{
		   if(chkPermission()){
				Form.showMessageDialog(&quot;此人員已列管，若有問題請洽品管人員(陳慶旭)!!\n&quot;);
				clear(temp,&quot;0&quot;);//清空內容資訊	
			}else{
				clear(temp,&quot;1&quot;);//清空內容資訊
			}		
		}
	}else{
	   	   Form.showMessageDialog(&quot;您無教育訓練的部門權限，請通知HR開放部門權限!!\n&quot;);
		   clear(temp,&quot;0&quot;);//清空內容資訊			
	}

	if(conn != null){
		try{
			conn.commit();
		}catch(e){
			java.lang.System.out.println(&quot;expection in informixDB e=&quot;+e);
		}finally{
		conn.close();
		}
	}		
}	

function chkPermission(){
	var flag = false;
	var mid = Form.getValue(&quot;App_MemID&quot;);
	var sql = &quot;select * from A_BAS_PERMISSIONS where memid=&apos;&quot;+mid+&quot;&apos; and p_flag=&apos;Y&apos;&quot;;
	var vec = Client.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		var p_date = vec.get(0).get(&quot;p_date&quot;);
		var Ob_date = new Packages.pase.agenda.MyDate();
		var s_date = Ob_date.getCurrentDate();
		if (p_date==&quot;&quot; || Ob_date.getSubtractSecond(p_date,s_date)&lt;0){
			flag = true;
		}
	}
	return flag;
}

function clear(temp,type){
   //清空內容資訊
   if(temp ==&quot;上崗&quot;){

   //認證階段：	   
	Form.getComponent(&quot;BAS_level&quot;).setEnabled(true); 
	var comboxitem = Form.getComponent(&quot;BAS_level&quot;);
		comboxitem.removeAllItems();	
	 if(type ==&quot;1&quot;){	
		comboxitem.addItem(&quot;==請選擇==&quot;);
		comboxitem.addItem(&quot;E0&quot;);
		comboxitem.addItem(&quot;E1&quot;);
		comboxitem.addItem(&quot;E2&quot;);
		comboxitem.addItem(&quot;E3&quot;);		

	 }else{
	 	comboxitem.setEnabled(false);	
	    Form.setValue(&quot;App_Name&quot;,&quot;&quot;);
	    Form.setValue(&quot;App_Title&quot;,&quot;&quot;);
	    Form.setValue(&quot;App_Tel&quot;,&quot;&quot;);				
	    Form.setValue(&quot;App_Dep&quot;,&quot;&quot;);
	    Form.setValue(&quot;App_Dep_ID&quot;,&quot;&quot;);
	    Form.setValue(&quot;Work_Type&quot;,&quot;&quot;);	
	  }	
	  
	//認證單元：	
	var comboxitem = Form.getComponent(&quot;unit_no&quot;);
 	    comboxitem.removeAllItems();
	    comboxitem.setEnabled(false);	
		
	//機台：	
    var comboxitem = Form.getComponent(&quot;m_name&quot;);
 	    comboxitem.removeAllItems();
	    comboxitem.setEnabled(false);	

	//部門：	
    var comboxitem = Form.getComponent(&quot;deplist&quot;);
 	    comboxitem.removeAllItems();
	    comboxitem.setEnabled(false);		
		
	//檢驗人員：	
    var comboxitem = Form.getComponent(&quot;PQE_EMP_S&quot;);
 	    comboxitem.removeAllItems();
	    comboxitem.setEnabled(false);	
		
	    Form.setValue(&quot;check_ok&quot;,&quot;&quot;);		  //合格：			
	    Form.setValue(&quot;check_nok&quot;,&quot;&quot;);		  //不合格：	
	    Form.setValue(&quot;sop_no&quot;,&quot;&quot;);		      //SOP單號：
		
        Form.getComponent(&quot;Unit_data&quot;).clear(); //Unit_data		
		
	}else if(temp ==&quot;下崗&quot;){
	 if(type ==&quot;1&quot;){
		Form.getComponent(&quot;once_fail&quot;).setEnabled(true);  
	    Form.getComponent(&quot;all_fail&quot;).setEnabled(true);  
	    Form.setValue(&quot;once_fail&quot;,&quot;&quot;); 		
	    Form.setValue(&quot;all_fail&quot;,&quot;&quot;);  					  		 
	 }else{
	    Form.setValue(&quot;App_Name&quot;,&quot;&quot;);
	    Form.setValue(&quot;App_Title&quot;,&quot;&quot;);
	    Form.setValue(&quot;App_Tel&quot;,&quot;&quot;);				
	    Form.setValue(&quot;App_Dep&quot;,&quot;&quot;);
	    Form.setValue(&quot;App_Dep_ID&quot;,&quot;&quot;);
	    Form.setValue(&quot;Work_Type&quot;,&quot;&quot;);	
	    Form.getComponent(&quot;once_fail&quot;).setEnabled(false);  
	    Form.getComponent(&quot;all_fail&quot;).setEnabled(false);  	
	    Form.setValue(&quot;once_fail&quot;,&quot;&quot;); 		
	    Form.setValue(&quot;all_fail&quot;,&quot;&quot;);  	
	 }
	 
	//缺失類別：	
	var comboxitem = Form.getComponent(&quot;bas_type&quot;);
 	    comboxitem.removeAllItems();
	    comboxitem.setEnabled(false);	

	//缺失細項：	
	var comboxitem = Form.getComponent(&quot;type_desc&quot;);
 	    comboxitem.removeAllItems();
	    comboxitem.setEnabled(false);	
	 	Form.getComponent(&quot;once&quot;).setEnabled(false);  
	    Form.getComponent(&quot;more&quot;).setEnabled(false);  	
		Form.setValue(&quot;once&quot;,&quot;&quot;); 
		Form.setValue(&quot;more&quot;,&quot;&quot;); 		
	 	Form.getComponent(&quot;search_fail_data&quot;).setEnabled(false);  			
	 	Form.getComponent(&quot;search_data&quot;).setEnabled(false);  		
	 	Form.getComponent(&quot;Fail_data&quot;).clear(); //Fail_data	 
		Form.getComponent(&quot;User_data&quot;).clear(); //User_data	 
	 
	}	
}

//===================================================================
// 基本功認證
// okAction條件
//===================================================================	

//撈出所屬廠別的廠長
//撈出所屬廠別Q單位的部門主管 
 function dpt_Manager(v_factory,dpt_temp){ 
  try{
	var SQL = &quot;SELECT  managerid from dep_geninf&quot;;
	    if(v_factory == &quot;TGCE&quot;){
		  if(dpt_temp ==&quot;品保&quot;){
           SQL +=&quot; where id=&apos;2G4&apos;&quot;;//鄭志雯
		  }else{
		   SQL +=&quot; where id=&apos;2P0&apos;&quot;;
		  }
		}else if(v_factory == &quot;SGCE&quot;){
		  if(dpt_temp ==&quot;品保&quot;){
           SQL +=&quot; where id=&apos;6G0&apos;&quot;;//黎祥
		  }else{
		   SQL +=&quot; where id=&apos;6P0&apos;&quot;;//董憲卿
		  }
		}else if(v_factory == &quot;CGCE&quot;){
		  if(dpt_temp ==&quot;品保&quot;){
           SQL +=&quot; where id=&apos;8G7&apos;&quot;;//周利華
		  }else{
		   SQL +=&quot; where id=&apos;8P0&apos;&quot;;//石俊傑
		  }
		}else if(v_factory == &quot;HGCE&quot;){
		  if(dpt_temp ==&quot;品保&quot;){
           SQL +=&quot; where id=&apos;5G3&apos;&quot;;//楊濤
		  }else{
		   SQL +=&quot; where id=&apos;8P0&apos;&quot;;//石俊傑
		  }
		}
	var vec = Client.SQLloadValue(SQL);
	Client.setLocalObject(&quot;vec&quot;,vec);
	
	if(vec.size()&gt;0){	
		var temp = vec.get(0).get(&quot;managerid&quot;);
		
		//add by edison@20161014 吳雅雯
		if(v_factory == &quot;TGCE&quot; &amp;&amp; dpt_temp ==&quot;品保&quot;){
			temp = &quot;MEMT1032095&quot;;
		}
	}else{
	  Form.showMessageDialog(v_factory + &quot;無&quot; + dpt_temp +&quot;單位主管資料&quot;);
	}
	 return temp;
			
  }catch(e){}
 }//function dpt_Manager
 
 
 function unit_check_function(){  
  		//check 【產品認證資訊】
		var table = Form.getComponent(&quot;Unit_check&quot;);
	    var row = table.getRowCount();	
		  for(var i = 0;i&lt;row;i++){
			if(table.getValueAt(i,&quot;料號&quot;)==&quot;&quot; || table.getValueAt(i,&quot;批號&quot;)==&quot;&quot; || table.getValueAt(i,&quot;檢驗項目&quot;)==&quot;&quot; || table.getValueAt(i,&quot;抽檢數&quot;)==&quot;&quot; || table.getValueAt(i,&quot;結果判定&quot;)==&quot;&quot; || table.getValueAt(i,&quot;檢驗人員&quot;)==&quot;&quot; ){
			  var flag =&quot;N&quot;;
			}
          }
		  if(flag ==&quot;N&quot;){
			  return false;
		  }else{
		      return true;
		 }
  }//unit_check_function() End

 function unit_data_function(){  
  		//check 【認證資訊】
		var msg=&quot;&quot;;	
		var count=0;			
		var table = Form.getComponent(&quot;Unit_data&quot;);
		var v_bas_level = Form.getValue(&quot;BAS_level_t&quot;)
	    var row = table.getRowCount();	
		  for(var i = 0;i&lt;row;i++){
			  
			if(v_bas_level ==&quot;E0&quot;){
			  //E0：不得有0分	
			  if(table.getValueAt(i,&quot;認證核定&quot;)==&quot;0分&quot;){
				var check_ok=&quot;N&quot;;
			  }	 
			}else if(v_bas_level ==&quot;E1&quot;){ 
			  //E1：必須3分以上	
			  if(table.getValueAt(i,&quot;認證核定&quot;)==&quot;0分&quot; || table.getValueAt(i,&quot;認證核定&quot;)==&quot;1分&quot;){
				var check_ok=&quot;N&quot;;
			  }	
//			}else if(v_bas_level ==&quot;E2&quot;){
			  //E2：必須3分以上,且只能有2個3分，其餘的要5分?分
//			   if(table.getValueAt(i,&quot;認證核定&quot;)==&quot;3分&quot; || table.getValueAt(i,&quot;認證核定&quot;)==&quot;5分&quot; || table.getValueAt(i,&quot;認證核定&quot;)==&quot;N/A&quot;){
//				 if(table.getValueAt(i,&quot;認證核定&quot;)==&quot;3分&quot;){
//				     count ++;
//			     } 	
//			  }else{
//			   	var check_ok=&quot;N&quot;;
//			  }
//			  if(count &gt;2){
//                var check_ok=&quot;N&quot;;
//			  }
			}else if(v_bas_level ==&quot;E2&quot; || v_bas_level ==&quot;E3&quot;){ 
			  //E2、E3：必須全5分滿分					
			  if(table.getValueAt(i,&quot;認證核定&quot;)!=&quot;5分&quot; &amp;&amp;  table.getValueAt(i,&quot;認證核定&quot;)!=&quot;N/A&quot;){
				var check_ok=&quot;N&quot;;
			  }	
			}

			if(table.getValueAt(i,&quot;認證核定&quot;)==&quot;== 請選擇 ==&quot;){
				msg += table.getValueAt(i,&quot;認證分類&quot;) + table.getValueAt(i,&quot;項次&quot;) + &quot;-&quot;+ table.getValueAt(i,&quot;認證項目&quot;) + &quot;:&quot; +&quot;未維護認證核定 !\n&quot;;
			}else if((table.getValueAt(i,&quot;認證核定&quot;)==&quot;0分&quot; || table.getValueAt(i,&quot;認證核定&quot;)==&quot;1分&quot;) &amp;&amp; table.getValueAt(i,&quot;0~1分，請敘述異常事項&quot;)==&quot;&quot;){
			     msg += table.getValueAt(i,&quot;認證分類&quot;) + table.getValueAt(i,&quot;項次&quot;) + &quot;-&quot;+ table.getValueAt(i,&quot;認證項目&quot;) +&quot;:&quot; + table.getValueAt(i,&quot;認證核定&quot;) +&quot;未維護0~1分，異常事項原因 !\n&quot;;
			}
          }//for
		   if(check_ok !=&quot;N&quot;){
		   	 Form.setValue(&quot;check_ok&quot;,&quot;合格&quot;);
		     Form.setValue(&quot;check_nok&quot;,&quot;&quot;);		 
		   }else{
		   	 Form.setValue(&quot;check_ok&quot;,&quot;&quot;);				   
		     Form.setValue(&quot;check_nok&quot;,&quot;不合格&quot;);
		   }
			  return msg;

  }//unit_data_function() End

 function Asign_Table(v_factory,process_name){
	 try{
		loadLibrary(&quot;com.gce.PLM.Common.Client.addAsignTable&quot;);
	     addAsignList(v_factory,&quot;BAS_PM&quot;,&quot;PM_Table&quot;);               //PM 會簽人員
	  }catch(e){
		java.lang.System.out.println(&quot;BAS_PM_AsignMember_error=&quot;+e);
    }  
 }//function Asign_Table() End  
 

 //檢核基本功認證資料重覆  
 function check_data(){
	 try{
		  var msg =&quot;&quot;;
		  var temp =&quot;&quot;;
          var v_factory = Form.getValue(&quot;Factory&quot;);		  	  
          var v_app_id = Form.getValue(&quot;App_ID&quot;);
          var v_bas_level = Form.getValue(&quot;BAS_level&quot;);		  
          var v_unit_no = Form.getValue(&quot;unit_no&quot;);		  
          var v_m_name = Form.getValue(&quot;m_name&quot;);	
		  var v_insid = Form.artInstanceID;
		  
		  //檢核認證資料前階段是否申請
		  if(v_bas_level ==&quot;E0&quot;||v_bas_level ==&quot;E1&quot;){
		    var  temp =&quot;E0&quot;;
		  }else if(v_bas_level ==&quot;E2&quot;){
			var  temp =&quot;E1&quot;;
		  }else if(v_bas_level ==&quot;E3&quot;){
			var  temp =&quot;E2&quot;;
		  }

		 //檢核認證資料重覆(當PQE尚未審核)
	      var sql = &quot;select * from ART00061289527119196_INS where ITEM2=&apos;&quot;+ v_factory +&quot;&apos;&quot;;
		      sql +=&quot; and ITEM322 =&apos;&quot; + v_app_id + &quot;&apos;&quot;;
			  sql +=&quot; and ITEM11  =&apos;&quot; + v_bas_level + &quot;&apos;&quot;;	 
			  sql +=&quot; and ITEM10  =&apos;&quot; + v_unit_no+ &quot;&apos;&quot;;	
			  sql +=&quot; and ITEM155  =&apos;false&apos;&quot;;				  
			  sql +=&quot; and insid  &lt;&gt;&apos;&quot;+ v_insid  +&quot;&apos;&quot;;				  
			  if(v_m_name!=&quot;&quot;){
			  sql +=&quot; and ITEM9  =&apos;&quot; + v_m_name + &quot;&apos;&quot;;				     		  
			  }else{
			  sql +=&quot; and ITEM9 is null&quot;;	
			  }	
			  sql +=&quot; and ITEM88 is null&quot;;					  
			  sql +=&quot; and ITEM89 is null&quot;;		
			  sql +=&quot; and ITEM24 is not null &quot;; 
			  sql +=&quot; and ITEM83 &lt;&gt;&apos;Y&apos; &quot;;
          var vec = Client.SQLloadValue(sql);
		  Client.addDebugLog(&quot;待PQE審核中sql ==&quot;+vec.size()+&quot;==&quot;+sql);
		  if(vec.size()&gt;0){
			   msg += &quot;此人的基本功認證申請已存在，待PQE審核中，不需重覆開立表單，請您確認!!\n&quot;;
		  }
		  
		 //檢核認證資料(當系統有認證且PQE尚未審核，則不能開立其他認證單)
	      var sql = &quot;select * from ART00061289527119196_INS where ITEM2=&apos;&quot;+ v_factory +&quot;&apos;&quot;;
		      sql +=&quot; and ITEM322 =&apos;&quot; + v_app_id + &quot;&apos;&quot;;
			  sql +=&quot; and ITEM155  =&apos;false&apos;&quot;;				  
			  sql +=&quot; and insid  &lt;&gt;&apos;&quot;+ v_insid  +&quot;&apos;&quot;;	
             // sql +=&quot; and ITEM24 is null &quot;; 			  
			  sql +=&quot; and ITEM96 is null&quot;;	
			  sql +=&quot; and ITEM102 is null&quot;;			//未被下崗	  	  		  
          var vec = Client.SQLloadValue(sql);
		  Client.addDebugLog(&quot;尚有其他認證待PQE審核中sql ==&quot;+vec.size()+&quot;==&quot;+sql);
		  if(vec.size()&gt;0){
			   msg += &quot;此人的基本功認證申請，尚有其他認證待PQE審核中，不能申請新認證，請您確認!!\n&quot;;
		  }	
		  
		  //檢核認證資料重覆覆(當PQE已審核)
	      var sql = &quot;select * from ART00061289527119196_INS where ITEM2=&apos;&quot;+ v_factory +&quot;&apos;&quot;;
		      sql +=&quot; and ITEM322 =&apos;&quot; + v_app_id + &quot;&apos;&quot;;
			  sql +=&quot; and ITEM11  =&apos;&quot; + v_bas_level + &quot;&apos;&quot;;	 
			  sql +=&quot; and ITEM10  =&apos;&quot; + v_unit_no + &quot;&apos;&quot;;	
			  sql +=&quot; and insid  &lt;&gt;&apos;&quot;+ v_insid  +&quot;&apos;&quot;;				  			  
			  sql +=&quot; and ITEM155  =&apos;false&apos;&quot;;				  
			  if(v_m_name!=&quot;&quot;){
			  sql +=&quot; and ITEM9  =&apos;&quot; + v_m_name + &quot;&apos;&quot;;				     		  
			  }else{
			  sql +=&quot; and ITEM9 is null&quot;;	
			  }
			  sql +=&quot; and ((ITEM83  !=&apos;Y&apos; and ITEM83  !=&apos;P&apos;) or ITEM83 is null) &quot;;	//下崗作廢Flag				  
			  sql +=&quot; and ITEM88  =&apos;合格&apos;&quot;;				     		  
          var vec = Client.SQLloadValue(sql);
		  if(vec.size()&gt;0){
			   msg += &quot;此人的基本功認證已存在，不需重覆認證，請您確認!!\n&quot;;
			   msg += sql;
			   
		  }
		  
		  //檢核認證資料是否申請前一階認證
//		  if(v_bas_level ==&quot;E1&quot;){
//		  var sql = &quot;select ITEM322 USER_ID,ITEM11 U_LEVEL from ART00061289527119196_INS where ITEM2=&apos;&quot;+ v_factory +&quot;&apos;&quot;;
//		      sql +=&quot; and ITEM322 =&apos;&quot; + v_app_id + &quot;&apos;&quot;;
//			  sql +=&quot; and ITEM11  =&apos;&quot; + temp + &quot;&apos;&quot;;	 
//			  sql +=&quot; and insid  &lt;&gt;&apos;&quot;+ v_insid  +&quot;&apos;&quot;;				  			  
//			  sql +=&quot; and (ITEM83  !=&apos;Y&apos; or ITEM83 is null) &quot;;	//下崗作廢Flag					  
//			  sql +=&quot; and ITEM88  =&apos;合格&apos;&quot;;	
//			  sql +=&quot; union &quot;;			  
//              sql +=&quot; select USER_ID,U_LEVEL from A_BAS_UNIT_OLDDATA where area=&apos;&quot;+ v_factory.substr(1,4) +&quot;&apos;&quot;;
//		      sql +=&quot; and USER_ID =&apos;&quot; + v_app_id + &quot;&apos;&quot;; 
//			  sql +=&quot; and U_LEVEL =&apos;&quot;+ temp +&quot;&apos;&quot;; 
//		      sql +=&quot; and FAIL_FLAG  =&apos;N&apos;&quot;;	//下崗作廢Flag
//			  
//		 }else if(temp !=&quot;E0&quot;){ 
		  var sql = &quot;select ITEM322 USER_ID,ITEM11 U_LEVEL from ART00061289527119196_INS where ITEM2=&apos;&quot;+ v_factory +&quot;&apos;&quot;;
		      sql +=&quot; and ITEM322 =&apos;&quot; + v_app_id + &quot;&apos;&quot;;
			  sql +=&quot; and ITEM11  =&apos;&quot; + temp + &quot;&apos;&quot;;	 
			  sql +=&quot; and ITEM10  =&apos;&quot; + v_unit_no+ &quot;&apos;&quot;;	
			  sql +=&quot; and insid  &lt;&gt;&apos;&quot;+ v_insid  +&quot;&apos;&quot;;				  			  
			  sql +=&quot; and ITEM155  =&apos;false&apos;&quot;;				  
			  if(v_m_name!=&quot;&quot;){
			  sql +=&quot; and ITEM9  =&apos;&quot; + v_m_name + &quot;&apos;&quot;;				     		  
			  }else{
			  sql +=&quot; and ITEM9 is null&quot;;	
			  }
			  sql +=&quot; and ((ITEM83  !=&apos;Y&apos; and ITEM83  !=&apos;P&apos;) or ITEM83 is null) &quot;;	//下崗作廢Flag				  
			  sql +=&quot; and ITEM88  =&apos;合格&apos;&quot;;	
			  sql +=&quot; union &quot;;	
		      sql +=&quot; select USER_ID,U_LEVEL from A_BAS_UNIT_OLDDATA where area=&apos;&quot;+ v_factory.substr(1,4) +&quot;&apos;&quot;;
		      sql +=&quot; and USER_ID =&apos;&quot; + v_app_id + &quot;&apos;&quot;; 
			  sql +=&quot; and U_LEVEL =&apos;&quot;+ temp +&quot;&apos;&quot;; 
			  sql +=&quot; and U_NO  =&apos;&quot; + v_unit_no.substr(0,5) + &quot;&apos;&quot;;	
			   if(v_m_name!=&quot;&quot;){
			      sql +=&quot; and M_NAME  =&apos;&quot; + v_m_name + &quot;&apos;&quot;;		     		  
			   }else{
			      sql +=&quot; and M_NAME  is null&quot;;
			   }
		      sql +=&quot; and FAIL_FLAG  =&apos;N&apos;&quot;;	//下崗作廢Flag				  
//         }		     		  
		  if(v_bas_level !=&quot;E0&quot;){
			  Client.addDebugLog(&quot;基本功檢查前一階認證sql=&quot;+sql);
          var vec = Client.SQLloadValue(sql);
		   if(vec.size()&lt;=0){
			   msg += &quot;此人的基本功認證【&quot;+v_bas_level+&quot;】階，並無申請【&quot;+ temp +&quot;】階的認證，不能申請，請您確認!!\n&quot;;
		   }	
		  } 

		  //檢核認證資料是否超過3個機台認證(E0不卡)
		  if(v_bas_level !=&quot;E0&quot;){
	        var sql = &quot;select ITEM322 USER_ID,ITEM11 U_LEVEL,ITEM10 U_NAME,ITEM9 M_NAME,&apos;form_data&apos; TYPE from ART00061289527119196_INS where ITEM2=&apos;&quot;+ v_factory +&quot;&apos;&quot;;
		        sql +=&quot; and ITEM322 =&apos;&quot; + v_app_id + &quot;&apos;&quot;;
			    sql +=&quot; and insid  &lt;&gt;&apos;&quot;+ v_insid  +&quot;&apos;&quot;;				  				
			    sql +=&quot; and ITEM11  =&apos;&quot; + v_bas_level+ &quot;&apos;&quot;;	
  			    sql +=&quot; and ITEM155  =&apos;false&apos;&quot;;					
			    sql +=&quot; and (ITEM83  !=&apos;Y&apos; or ITEM83 is null) &quot;;	//下崗作廢Flag				
			    sql +=&quot; and  ITEM89 is null&quot;;	
			    sql +=&quot; union &quot;;	
			    sql +=&quot; select USER_ID,U_LEVEL,u_no||&apos;-&apos;||u_name U_NAME ,M_NAME,&apos;old_data&apos; TYPE from A_BAS_UNIT_OLDDATA where area=&apos;&quot;+ v_factory.substr(1,4) +&quot;&apos;&quot;;
		        sql +=&quot; and USER_ID =&apos;&quot; + v_app_id + &quot;&apos;&quot;; 
			    sql +=&quot; and U_LEVEL =&apos;&quot;+ v_bas_level +&quot;&apos;&quot;; 
		        sql +=&quot; and FAIL_FLAG  !=&apos;Y&apos;&quot;;	//下崗作廢Flag					
			  
            var vec = Client.SQLloadValue(sql);
	  	    if(vec.size()&gt;=3){
			   msg += &quot;此人的基本功認證【&quot;+v_bas_level+&quot;】階，已滿3機台認證，不能申請，請您確認!!\n&quot;;
		    }	
		   }//if(v_bas_level !=&quot;E0&quot;) 

		    //檢核認證資料是否下崗中
	        var sql = &quot;select ITEM322 USER_ID,ITEM11 U_LEVEL from ART00061289527119196_INS where ITEM2=&apos;&quot;+ v_factory +&quot;&apos;&quot;;
		        sql +=&quot; and ITEM322 =&apos;&quot; + v_app_id + &quot;&apos;&quot;;
			    sql +=&quot; and ITEM155  =&apos;false&apos;&quot;;					
			    sql +=&quot; and (ITEM11  =&apos;&quot; + v_bas_level+ &quot;&apos; or ITEM11  =&apos;&quot; + temp + &quot;&apos;)&quot;;	
		        sql +=&quot; and (ITEM83  =&apos;Y&apos; or ITEM83=&apos;P&apos;)&quot;;	//下崗作廢Flag	
		        sql +=&quot; and ITEM93 is null&quot;; //下崗日期				
			    sql +=&quot; and ITEM88  =&apos;合格&apos;&quot;;	
//			    sql +=&quot; union &quot;;	
//			    sql +=&quot; select USER_ID,U_LEVEL from A_BAS_UNIT_OLDDATA where area=&apos;&quot;+ v_factory.substr(1,4) +&quot;&apos;&quot;;
//		        sql +=&quot; and USER_ID =&apos;&quot; + v_app_id + &quot;&apos;&quot;; 
//			    sql +=&quot; and (U_LEVEL =&apos;&quot;+ v_bas_level +&quot;&apos; or U_LEVEL =&apos;&quot; + temp + &quot;&apos;)&quot;;	
//		        sql +=&quot; and FAIL_FLAG =&apos;N&apos;&quot;;	//下崗作廢Flag	
//		        sql +=&quot; and FAIL_DATE is null&quot;; //下崗日期						
			Client.addDebugLog(&quot;基本功檢查認證重複==&quot;+sql);  
            var vec = Client.SQLloadValue(sql);
	  	    if(vec.size()&gt;0){
			   msg += &quot;此人的基本功認證【&quot;+v_bas_level+&quot;】階或前一階認證，已下崗或認證下崗中，不能申請，請您確認!!\n&quot;;
		    }	
		   
	      //檢核舊認證資料重覆
//		  var v_unit_no = Form.getValue(&quot;unit_no&quot;).substr(0,5);	
//          var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);				  
          msg += check_old_data(v_factory,temp,v_app_id,v_bas_level,v_unit_no,v_m_name);
			
        return msg;
	  }catch(e){
		return msg;  
		java.lang.System.out.println(&quot;BAS_PM_AsignMember_error=&quot;+e);
    }  
  }//function check_data() End 
   
 //檢核舊認證資料重覆 
 function check_old_data(v_factory,temp,v_app_id,v_bas_level,v_unit_no,v_m_name){
	 try{
//		 var v_factory =v_factory.substr(1,4);
		 var msg =&quot;&quot;;
		 //檢核舊認證資料重覆
	      var sql = &quot;select * from A_BAS_UNIT_OLDDATA where area=&apos;&quot;+ v_factory.substr(1,4) +&quot;&apos;&quot;;
		      sql +=&quot; and USER_ID =&apos;&quot; + v_app_id + &quot;&apos;&quot;; 
			  sql +=&quot; and U_LEVEL =&apos;&quot;+ v_bas_level +&quot;&apos;&quot;; 
			  sql +=&quot; and U_NO  =&apos;&quot; + v_unit_no.substr(0,5) + &quot;&apos;&quot;;	
			  if(v_m_name!=&quot;&quot;){
			  sql +=&quot; and M_NAME  =&apos;&quot; + v_m_name + &quot;&apos;&quot;;		     		  
			  }else{
			  sql +=&quot; and M_NAME  is null&quot;;
			  }
		      sql +=&quot; and FAIL_FLAG =&apos;N&apos;&quot;;	//下崗作廢Flag				  
		  Client.addDebugLog(&quot;基本功檢查old_data是否存在sql=&quot;+sql);	     		  
          var vec = Client.SQLloadValue(sql);
		  if(vec.size()&gt;0){
			   msg += &quot;此人的基本功認證申請已存在(old_data)，不需重覆開立表單，請您確認!!\n&quot;;
		  }

        return msg;
	  }catch(e){
		return msg;  
		java.lang.System.out.println(&quot;BAS_PM_AsignMember_error=&quot;+e);
    }  
  }//function check_old_data() End   
  
//檢核基本功認證資料時間，距上階認證，是否超過一個月
 function check_date(){
	 try{
		  var msg =&quot;&quot;;
		  var temp =&quot;&quot;;
          var v_app_id = Form.getValue(&quot;App_ID&quot;);
          var v_bas_level = Form.getValue(&quot;BAS_level&quot;);		  
          var v_unit_no = Form.getValue(&quot;unit_no&quot;);		  
          var v_m_name = Form.getValue(&quot;m_name&quot;);		
          var v_create_date = Form.getValue(&quot;Create_Date&quot;);	
          var v_factory = Form.getValue(&quot;Factory&quot;);		  		  
		  var v_insid = Form.artInstanceID;		
   	      var mydate = new Packages.pase.agenda.MyDate();		  	  

		  if(v_bas_level == &quot;E1&quot; || v_bas_level == &quot;E2&quot; || v_bas_level == &quot;E3&quot;){
			if (v_bas_level == &quot;E1&quot;){
				var v_bas_level_temp =&quot;E0&quot;
		    }else if (v_bas_level == &quot;E2&quot;){
				var v_bas_level_temp =&quot;E1&quot;
		    }else if (v_bas_level == &quot;E3&quot;){
				var v_bas_level_temp =&quot;E2&quot;
		    }
		 //檢核前一階認證資料
	      var sql = &quot;select ITEM96 pqe_date from ART00061289527119196_INS where ITEM2=&apos;&quot;+ v_factory +&quot;&apos;&quot;;
		  	  sql +=&quot; and ITEM322 =&apos;&quot; + v_app_id + &quot;&apos;&quot;;
			  sql +=&quot; and insid  &lt;&gt;&apos;&quot;+ v_insid  +&quot;&apos;&quot;;		
			  sql +=&quot; and ITEM96 is not null&quot;;				  			  
			  sql +=&quot; and ITEM11  =&apos;&quot; + v_bas_level_temp + &quot;&apos;&quot;;	 
			  sql +=&quot; and ITEM10  =&apos;&quot; + v_unit_no + &quot;&apos;&quot;;	
			  sql +=&quot; and ITEM155  =&apos;false&apos;&quot;;				
			  if(v_m_name!=&quot;&quot;){
			  sql +=&quot; and ITEM9  =&apos;&quot; + v_m_name + &quot;&apos;&quot;;				     		  
			  }else{
			  sql +=&quot; and ITEM9 is null&quot;;	
			  }			  			  
			  sql +=&quot; and ITEM88  =&apos;合格&apos;&quot;;	
			  sql +=&quot; and ITEM93 is null&quot;;	//下崗日期			  
              sql +=&quot; and ITEM36 is null&quot;   //下崗單號	
			  sql +=&quot; union &quot;;	
			  sql +=&quot; select pqe_date &quot;;
			  sql +=&quot; from A_BAS_UNIT_OLDDATA &quot;;
			  sql +=&quot; where area=&apos;&quot;+ v_factory.substr(1,4) +&quot;&apos;&quot;;
		      sql +=&quot; and USER_ID =&apos;&quot; + v_app_id + &quot;&apos;&quot;; 
			  sql +=&quot; and U_LEVEL =&apos;&quot;+ v_bas_level +&quot;&apos;&quot;; 
			  sql +=&quot; and fail_flag=&apos;N&apos; and fail_date is null and fail_sn is null &quot;;  //下崗資訊
			  sql +=&quot; and u_no||&apos;-&apos;||u_name =&apos;&quot; + v_unit_no + &quot;&apos;&quot;;				
			  if(v_m_name!=&quot;&quot;){
			  sql +=&quot; and m_name  =&apos;&quot; + v_m_name + &quot;&apos;&quot;;				     		  
			  }else{
			  sql +=&quot; and m_name is null&quot;;
			  }				  		   		 
          var vec = Client.SQLloadValue(sql);
		  if(vec.size()&gt;0){
			 var temp =&quot;30&quot;; //1天
			 var bas_date = vec.get(vec.size()-1).get(&quot;pqe_date&quot;);	
	         var days = mydate.getSubtractDay(bas_date,v_create_date)+1;			 
//			 var v_fail_date = fail_date +temp;	
		  }//if(vec.size()&gt;0)
		 
		   if(days &lt; 30 ){ 
			    msg += &quot;此人的基本功認證【&quot;+v_bas_level+&quot;】階，距上階認證日期，需超過1個月以上時間，始可再報名上崗認證資格，請您確認!!\n&quot;;
		   }
        }
		
		 //檢核認證不合格，下次再提報時，系統需判定，是否已間隔1個月(30天)
	      var sql = &quot;select ITEM96 pqe_date from ART00061289527119196_INS where ITEM2=&apos;&quot;+ v_factory +&quot;&apos;&quot;;
		  	  sql +=&quot; and ITEM322 =&apos;&quot; + v_app_id + &quot;&apos;&quot;;
			  sql +=&quot; and insid  &lt;&gt;&apos;&quot;+ v_insid  +&quot;&apos;&quot;;		
			  sql +=&quot; and ITEM96 is not null&quot;;				  			  
			  sql +=&quot; and ITEM11  =&apos;&quot; + v_bas_level + &quot;&apos;&quot;;	 
			  sql +=&quot; and ITEM10  =&apos;&quot; + v_unit_no + &quot;&apos;&quot;;	
			  sql +=&quot; and ITEM155  =&apos;false&apos;&quot;;				
			  if(v_m_name!=&quot;&quot;){
			  sql +=&quot; and ITEM9  =&apos;&quot; + v_m_name + &quot;&apos;&quot;;				     		  
			  }else{
			  sql +=&quot; and ITEM9 is null&quot;;	
			  }			  			  
			  sql +=&quot; and ITEM89  =&apos;不合格&apos;&quot;;	
          var vec = Client.SQLloadValue(sql);
		  if(vec.size()&gt;0){
			 var temp =&quot;30&quot;; //1天
			 var bas_date = vec.get(vec.size()-1).get(&quot;pqe_date&quot;);	
	         var days = mydate.getSubtractDay(bas_date,v_create_date)+1;			 
		  }//if(vec.size()&gt;0)
		   if(days &lt; 30 ){ 
			    msg += &quot;此人的基本功認證【&quot;+v_bas_level+&quot;】階，距上次認證日期，需超過1個月以上時間，始可再報名上崗認證資格，請您確認!!\n&quot;;
		   }
		
        return msg;
	  }catch(e){
		return msg;  
		java.lang.System.out.println(&quot;BAS_check_date_error=&quot;+e);
    }  
  }//function check_old_data() End  
  
 //檢核再次上崗認證時間
 function check_sent_again(){
	 try{
		  var msg =&quot;&quot;;
		  var temp =&quot;&quot;;
          var v_app_id = Form.getValue(&quot;App_ID&quot;);
          var v_bas_level = Form.getValue(&quot;BAS_level&quot;);		  
          var v_unit_no = Form.getValue(&quot;unit_no&quot;);		  
          var v_m_name = Form.getValue(&quot;m_name&quot;);		
          var v_create_date = Form.getValue(&quot;Create_Date&quot;);	
          var v_factory = Form.getValue(&quot;Factory&quot;);		  		  
		  var v_insid = Form.artInstanceID;			  
	      var mydate = new Packages.pase.agenda.MyDate();			  
		  
		 //檢核舊認證資料重覆
	      var sql = &quot;select ITEM93 from ART00061289527119196_INS where ITEM2=&apos;&quot;+ v_factory +&quot;&apos;&quot;;
		  	  sql +=&quot; and ITEM322 =&apos;&quot; + v_app_id + &quot;&apos; and ITEM36 is not null&quot;;
			  sql +=&quot; and insid  &lt;&gt;&apos;&quot;+ v_insid  +&quot;&apos;&quot;;				  			  
			  sql +=&quot; and ITEM11  =&apos;&quot; + v_bas_level + &quot;&apos;&quot;;	 
			  sql +=&quot; and ITEM10  =&apos;&quot; + v_unit_no + &quot;&apos;&quot;;	
			  sql +=&quot; and ITEM155  =&apos;false&apos;&quot;;				
			  if(v_m_name!=&quot;&quot;){
			  sql +=&quot; and ITEM9  =&apos;&quot; + v_m_name + &quot;&apos;&quot;;				     		  
			  }else{
			  sql +=&quot; and ITEM9 is null&quot;;	
			  }			  
			  sql +=&quot; and ITEM93 is not null&quot;;	//下崗日期			  
			  sql +=&quot; and ITEM83  =&apos;Y&apos;&quot;;	//下崗作廢Flag				  
			  sql +=&quot; and ITEM88  =&apos;合格&apos;&quot;;						  
			  sql +=&quot; order by ITEM93 desc&quot;;			  
			     		  
          var vec = Client.SQLloadValue(sql);
		  if(vec.size()&gt;0){
//			 if(v_bas_level==&quot;E0&quot;){  			
//			  if(vec.size()==1){
//			     var temp =&quot;1&quot;; //1天
//			  }else if(vec.size()==2){   
//			     var temp =&quot;3&quot;; //3天
//			  }else{
//			     var temp =&quot;7&quot;; //7天
//			  }
//			}else if(v_bas_level==&quot;E1&quot;){  
//			  if(vec.size()==1){
//			     var temp =&quot;14&quot;; //14天
//			  }else if(vec.size()==2){   
//			     var temp =&quot;30&quot;; //30天
//			  }else{
//			     var temp =&quot;90&quot;; //90天
//			  }	
//			}else if(v_bas_level==&quot;E2&quot;|| v_bas_level==&quot;E3&quot;){  
//			  if(vec.size()==1){
//			     var temp =&quot;30&quot;; //30天
//			  }else if(vec.size()==2){   
//			     var temp =&quot;60&quot;; //60天
//			  }else{
//			     var temp =&quot;90&quot;; //90天
//			  }	
//	        }//if(v_bas_level==&quot;E0&quot;)
			
			//modify by edison@20140410
			//Ans000019764319 一律改30才能申請
			var temp = &quot;30&quot;;
			
			 var fail_date = vec.get(vec.size()-1).get(&quot;ITEM93&quot;);	
	         var days = mydate.getSubtractDay(fail_date,v_create_date)+1;				 
//			 var v_fail_date = fail_date +temp;	
		  }//if(vec.size()&gt;0)
		  var flag = true;
		  if(days &lt; temp){
			  flag = false;
			 msg += &quot;此人的基本功認證【&quot;+v_bas_level+&quot;】階，下崗日期【&quot;+ fail_date +&quot;】並未到達&quot;+ temp +&quot;天訓練後，始可再報名上崗認證資格，請您確認!!\n&quot;;
		  }
		  if(flag){//若表單沒有符合的資料，再檢查olddata
			   var sqla = &quot;select fail_date from A_BAS_UNIT_OLDDATA where area=&apos;&quot;+v_factory.substr(1,4)+&quot;&apos; &quot;; 
			       sqla +=&quot; and user_id=&apos;&quot; + v_app_id + &quot;&apos; &quot;;
				   sqla +=&quot; and fail_flag=&apos;Y&apos; &quot;;
				   sqla +=&quot; and u_no||&apos;-&apos;||u_name=&apos;&quot; + v_unit_no + &quot;&apos; &quot;;
				   sqla +=&quot; and u_level=&apos;&quot; + v_bas_level + &quot;&apos; &quot;;
				   if(v_m_name!=&quot;&quot;){
					   sqla +=&quot; and m_name  =&apos;&quot; + v_m_name + &quot;&apos;&quot;;				     		  
				   }else{
					   sqla +=&quot; and m_name is null&quot;;
				   }
				   sqla +=&quot; order by fail_date desc&quot;;
				   var veca = Client.SQLloadValue(sqla);
				   if(veca.size()&gt;0){					  
					   var bas_date = veca.get(0).get(&quot;fail_date&quot;);	
					   var days = mydate.getSubtractDay(bas_date,v_create_date)+1;
					   if(days &lt; 30 ){ 					   
						   msg += &quot;此人的基本功認證olddata【&quot;+v_bas_level+&quot;】階，距上階認證日期，需超過1個月以上時間，始可再報名上崗認證資格，請您確認!!\n&quot;;
					   }
				   }
				   
				   
		   }

        return msg;
	  }catch(e){
		return msg;  
		java.lang.System.out.println(&quot;BAS_PM_AsignMember_error=&quot;+e);
    }  
  }//function check_old_data() End   
  
 //檢核下崗認證資料  
 function check_fail_data(){
	 try{
		  var msg=&quot;&quot;;
          var v_factory = Form.getValue(&quot;Factory&quot;);				  
          var v_app_id = Form.getValue(&quot;App_ID&quot;);
          var v_bas_level_t = Form.getValue(&quot;BAS_level_t&quot;);		  
          var v_unit_no_t = Form.getValue(&quot;unit_no_t&quot;);		  
          var v_m_name_t = Form.getValue(&quot;m_name_t&quot;);		
		  var v_insid = Form.artInstanceID;		  

		 //檢核下崗資料，依不同階段卡關再次上崗認證
	      var sql = &quot;select * from ART01101300263603615_INS where ITEM2=&apos;&quot;+ v_factory +&quot;&apos;&quot;;
		      sql +=&quot; and ITEM322 =&apos;&quot; + v_app_id + &quot;&apos;&quot;;
			  sql +=&quot; and insid  &lt;&gt;&apos;&quot;+ v_insid  +&quot;&apos;&quot;;				  			  
			  sql += &quot; and ITEM11  =&apos;&quot; + v_bas_level_t + &quot;&apos;&quot;;	 
			  sql += &quot; and ITEM10  =&apos;&quot; + v_unit_no_t + &quot;&apos;&quot;;	
			  sql +=&quot; and ITEM155  =&apos;false&apos;&quot;;				  
			  if(v_m_name!=&quot;&quot;){
			  sql +=&quot; and ITEM9  =&apos;&quot; + v_m_name + &quot;&apos;&quot;;				     		  
			  }else{
			  sql +=&quot; and ITEM9 is null&quot;;	
			  }		     		  
          var vec = Client.SQLloadValue(sql);
		  if(vec.size()&gt;0){
			   msg += &quot;此人的基本功認證申請已存在，待PQE審核中，不需重覆開立表單，請您確認!!\n&quot;;
		  }

        return msg;
	  }catch(e){
		java.lang.System.out.println(&quot;BAS_PM_AsignMember_error=&quot;+e);
    }  
  }//function check_fail_data() End   

  
  function add_Fail_data(v_Source_Ins_ID){
	var Source_Ins = Server.getArtInstance(v_Source_Ins_ID);

	if(Source_Ins != null){	
//		var source_dataMap = Source_Ins.getAppDataMap();		
//		var vecTableData = source_dataMap.get(&quot;Process_Table&quot;);
//		var rowCount = vecTableData.size();//vecTableData裡資料筆數
//		var depid = MyTask.getDepartmentID();
//		var dep = Server.getDepartment(depid);		
//		var member = Server.getMember(MyTask.getRealExecutor()); //執行者
//		var id = member.getMyID();
//		var roleTitle = member.getJobTitle();

		Source_Ins.setAppValue(&quot;fail_flag&quot;,&quot;Y&quot;);//下崗旗標
		Source_Ins.setAppValue(&quot;fail_flag&quot;,getFormatedCurrentTime());//下崗日期	
	}
}	
function get_App_User(){
     if (  Form.getValue(&quot;App_ID&quot;) !=&quot;&quot;){
		   var sApp_ID = Form.getValue(&quot;App_ID&quot;);
	       var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);
		   
		   loadLibrary(&quot;com.gce.Common.Util&quot;);
	       var ls_memt = get_ls_memt(v_factory);
		   
		   var member = Client.getMemberByID(ls_memt+sApp_ID) ;
		   var member_no= ls_memt + sApp_ID;
	
		Form.setValue(&quot;App_MemID&quot;, member_no);
		
		if(member!=null){
		//當按ENTER時，離職不員不能申請,resign&lt;&gt;true,表示在職
		 try{
			var SQL = &quot; select a.username, a.jobtitle,a.officephone,a.joblevel,a.pager,a.RESIGN,b.name,b.id&quot;;
			    SQL +=&quot; from mem_geninf a,dep_geninf b &quot;;
            	SQL +=&quot; where a.MEMID=&apos;&quot; + member_no + &quot;&apos;&quot;;
                SQL +=&quot; and a.workplace =b.depid&quot;;
			
			var vec = Client.SQLloadValue(SQL);
			if  (vec.size()&gt;0){
              if (vec.get(0).get(&quot;RESIGN&quot;)==&quot;false&quot;){
				 var app_name = member.getName();
				 var app_title = member.getJobTitle();				 
				 var roleID = member.getMainRoleID();
				 var memDR = member.getMemberDR(roleID);
				 var sDepName = memDR.getDepartmentName();	
				 var sDepID = Client.getDepartment(memDR.getDepartmentID()).getMyID();		
				 var app_tel = member.getOfficePhone();			
				 var jobLevel = member.getJobLevel();						 
				 var manager_id = member.getPager();				 
				 var flag=&quot;true&quot;;
			}else{
				 var app_name = vec.get(0).get(&quot;username&quot;);
				 var app_title = vec.get(0).get(&quot;jobtitle&quot;);	 
				 var app_tel = vec.get(0).get(&quot;officephone&quot;);
				 var jobLevel = vec.get(0).get(&quot;joblevel&quot;);
				 var manager_id = vec.get(0).get(&quot;pager&quot;);		
				 var sDepID = vec.get(0).get(&quot;id&quot;);		
				 var sDepName = vec.get(0).get(&quot;name&quot;);		
				 
				 var flag=&quot;false&quot;;
			}
					Form.setValue(&quot;App_Name&quot;,app_name);		
				    Form.setValue(&quot;App_Title&quot;,app_title);					
				    Form.setValue(&quot;App_Dep&quot;,sDepName);
				    Form.setValue(&quot;App_Dep_ID&quot;,sDepID);	
				    Form.setValue(&quot;Manager_ID&quot;,manager_id); // 直屬主管
				    Form.setValue(&quot;JobLevel&quot;,jobLevel) ;				
				    Form.setValue(&quot;App_Tel&quot;,app_tel); // 分機		
		 }	
		}catch(e){ 
				  var flag=&quot;false&quot;;			
		java.lang.System.out.println(&quot;(com.gce.HR.Client.BAS)get_App_User_error=&quot;+e);	
		}
		}else{
				Form.setValue(&quot;App_Name&quot;,&quot;&quot;);
				Form.setValue(&quot;App_Title&quot;,&quot;&quot;);
				Form.setValue(&quot;App_Tel&quot;,&quot;&quot;);						
				Form.setValue(&quot;App_Dep&quot;,&quot;&quot;);
				Form.setValue(&quot;App_Dep_ID&quot;,&quot;&quot;);
				var flag=&quot;null&quot;;				
		}			
	}
   return flag;
}	

//=========================================
//基本功認亦證系統，自動駁回
//=========================================
function bas_autoreject_process(nextflow,v_Source_Ins_ID,process,v_member){
    Server.addInfoLog(&quot;bas_autoreject_process：start&quot;);//BAS 系統自動駁回 開始
    loadLibrary(&quot;com.gce.PLM.Common.Server.Process&quot;);    
    //20110103 irene_chang
    //如果是 reject 退回填單人    
    try{
        var Source_Ins = Server.getArtInstance(v_Source_Ins_ID);
        bas_add_Process_Table(v_Source_Ins_ID,&quot;稽核缺失&quot;,process,v_member);
         Server.updateArtInstance(Source_Ins);
        
            //Reject 退回申請人
            if(Source_Ins != null ){
                var source_dataMap = Source_Ins.getAppDataMap();
                var artExitStateID = getStateID(Source_Ins.getArtifactID(),&quot;作廢&quot;);                        
                var V_ASTID = Source_Ins.getArtState().getID();
                var sql_t = &quot; select tskid from TASK_ARTINS where ASTID = &apos;&quot; + V_ASTID + &quot;&apos; AND INSID = &apos;&quot; +  v_Source_Ins_ID + &quot;&apos;&quot;; 
                var vec_t = Server.SQLloadValue(sql_t);
                if(vec_t != null &amp;&amp; vec_t.size()&gt;0){
                  var TaskID = Server.getTask(vec_t.get(0).get(&quot;tskid&quot;));
                }
                if(TaskID != null){                          
                     Server.completeTask(TaskID,artExitStateID);                                 
                }
        }
    }catch(e){}
    Server.addInfoLog(&quot;bas_autoreject_process：End&quot;);//BAS 系統自動駁回 結束    
}

function bas_add_Process_Table(v_Source_Ins_ID,proName,process,v_member){
    var Source_Ins = Server.getArtInstance(v_Source_Ins_ID);
    var source_dataMap = Source_Ins.getAppDataMap();
    if(Source_Ins != null){    
        if(process==&quot;認證中&quot;){        
            source_dataMap.put(&quot;Cancel&quot;,&quot;true&quot;);//作廢-未結案且未認證的上崗認證
        }else{
            source_dataMap.put(&quot;Cancel&quot;,&quot;false&quot;);//下崗-未結案且未認證的上崗認證
        }    
        source_dataMap.put(&quot;Close_Time&quot;,getFormatedCurrentTime());//結案時間        
        var vecTableData = source_dataMap.get(&quot;Process_Table&quot;);
        var rowCount = vecTableData.size();//vecTableData裡資料筆數
        var member = Server.getMemberByID(v_member);    
        var id= member.getMyID();        
        var roleTitle = member.getJobTitle();        
        var roleID = member.getMainRoleID();
        var memDR =  member.getMemberDR(roleID);    
        var depid = memDR.getDepartmentID();    //使用者部門id            
        var department = memDR.getDepartmentName();    //使用者部門名稱                  

           if(department == null){
            //抓不到部門(可能是專案職務)，就抓主要職務的部門
            var roleID = member.getMainRoleID();
            var memDR = member.getMemberDR(roleID);
            var department = memDR.getDepartmentName();    //使用者部門名稱
           }
        
//        //加入代理人資訊 20070625
//        if(! MyTask.getRealExecutor().equals(v_member)){
//            name =  name + &quot;(代理:&quot; + Server.getMemberByID(v_member).getName() + &quot;)&quot;;
//        }
        var hm = java.util.HashMap();
        if (proName==&quot;&quot;){
            var proName = MyTask.getProcessName();//關卡名稱
        }
//        var proName = &quot;會簽(觸發)&quot;;//關卡名稱
        hm.put(&quot;ITEM8&quot;,proName);//Process Name 關卡名稱
        hm.put(&quot;ITEM7&quot;,(rowCount+1)+&quot;&quot;);//Serial Number 序號
        hm.put(&quot;ITEM5&quot;, getFormatedCurrentTime());//簽核時間
        hm.put(&quot;ITEM6&quot;, department);//Department 部門
        hm.put(&quot;ITEM9&quot;, roleTitle);//Title 職稱
        hm.put(&quot;ITEM2&quot;, id);//ID 工號    
        hm.put(&quot;ITEM4&quot;, member);//Name 姓名
        if(process==&quot;認證中&quot;){
           hm.put(&quot;ITEM3&quot;,&quot;作廢&quot;);//status
        }else{
           hm.put(&quot;ITEM3&quot;,&quot;下崗&quot;);//status         
        }
        hm.put(&quot;ITEM1&quot;, &quot;此階資格未取得，前一階已下崗&quot;);//Opinion 意見
//        hm.put(&quot;ITEM10&quot;, MyTask.getID());    //TaskID    
        vecTableData.add(rowCount,hm);
        Source_Ins.setAppValue(&quot;Process_Table&quot;,vecTableData);
    }
} 

function check_m_type(){
	var bas_level = Form.getValue(&quot;BAS_level&quot;);//本次新增的認證階段
	var loginid = Form.getValue(&quot;App_ID&quot;);
	var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);
	var msg = &quot;&quot;;
	var sql = &quot;SELECT a.u_level, COUNT (*) COUNT &quot;;
		sql +=&quot;  FROM A_BAS_ALLDATA_V a &quot;;
		sql +=&quot; WHERE     a.ITEM155 = &apos;false&apos; &quot;;
		sql +=&quot;       AND (a.fail_flag IS NULL OR a.fail_flag = &apos;P&apos; OR a.fail_flag = &apos;N&apos;) &quot;;
		sql +=&quot;       AND userid = &apos;&quot;+loginid+&quot;&apos; &quot;;
		sql +=&quot;       AND a.area = &apos;&quot;+v_factory+&quot;&apos; &quot;;
		sql +=&quot;       AND a.ok IS NOT NULL &quot;;
		sql +=&quot;       AND a.return_date IS NOT NULL &quot;;
		sql +=&quot;       AND a.u_level &lt;&gt; &apos;E0&apos; &quot;;
		sql +=&quot;       AND a.userid = &apos;&quot;+loginid+&quot;&apos; &quot;;
		sql +=&quot;       AND a.u_level in &quot;;
		sql +=&quot;              (SELECT MAX (b.u_level) &quot;;
		sql +=&quot;                 FROM A_BAS_ALLDATA_V b &quot;;
		sql +=&quot;                WHERE     b.return_date IS NOT NULL &quot;;
		sql +=&quot;                      AND b.ITEM155 = &apos;false&apos; &quot;;
		sql +=&quot;                      AND b.ok IS NOT NULL &quot;;
		sql +=&quot;                      AND a.userid = b.userid &quot;;
		sql +=&quot;                      AND (   b.fail_flag IS NULL &quot;;
		sql +=&quot;                          OR b.fail_flag = &apos;P&apos; &quot;;
		sql +=&quot;                          OR b.fail_flag = &apos;N&apos;) &quot;;
		sql +=&quot;                     AND a.u_name = b.u_name &quot;;
		sql +=&quot;                     AND (   a.m_name = b.m_name &quot;;
		sql +=&quot;                          OR (a.m_name IS NULL AND b.m_name IS NULL)) &quot;;
		sql +=&quot;                     AND b.area = &apos;&quot;+v_factory+&quot;&apos; &quot;;
		sql +=&quot;                     AND userid = &apos;&quot;+loginid+&quot;&apos;) &quot;;
		sql +=&quot; GROUP BY a.u_level &quot;;
		sql +=&quot; ORDER BY a.u_level DESC&quot;;
	var vec = Client.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		var max_level = vec.get(0).get(&quot;u_level&quot;);
		if(max_level==&quot;E3&quot;){
			msg +=&quot;組長不能有E1以上多能功(目前最高E3)，請確認!\n&quot;;
		}else if(max_level==&quot;E2&quot;){
			if(bas_level==&quot;E2&quot;){
				msg +=&quot;組長不能有E1以上多能功(目前最高E2)，請確認!\n&quot;;
			}else if(bas_level==&quot;E1&quot;){
				msg +=&quot;組長不能有E1以上多能功(目前最高E2)，請確認!\n&quot;;
			}
		}else{
			if(bas_level==&quot;E1&quot;){
				msg +=&quot;組長不能有E1以上多能功(目前最高E1)，請確認!\n&quot;;
			}
		}
	}
	return msg;
}     

function check_bas_dep(v_factory,empno,v_bas_level,v_unit_no,v_m_name,dep_id2){
	var msg = &quot;&quot;;
	var u_name = v_unit_no+&quot;-&quot;+v_m_name;
	var sql = &quot;SELECT * FROM A_BAS_DEP where area=&apos;&quot;+v_factory+&quot;&apos; and u_name=&apos;&quot;+u_name+&quot;&apos;&quot;;
	var vec = Client.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		
		var depid = vec.get(0).get(&quot;depid&quot;);//歸屬單位
		
		
		var SQL  =&quot; SELECT &quot;;
			SQL +=&quot;         A.ITEM10 u_name, &quot;;
			SQL +=&quot;         A.ITEM9 m_name       &quot;;
//			SQL +=&quot;        (select depid from a_bas_dep where area=&apos;TGCE&apos; and u_name =A.ITEM10||&apos;-&apos;||A.ITEM9) depid &quot;;
			SQL +=&quot;   FROM ART00061289527119196_INS A &quot;;
			SQL +=&quot;  WHERE     ITEM62 IS NOT NULL &quot;;
			SQL +=&quot;        AND  A.ITEM2 = &apos;(&quot;+v_factory+&quot;)&apos; &quot;;
			SQL +=&quot;        AND  A.ITEM322 = &apos;&quot;+empno+&quot;&apos; &quot;;
			SQL +=&quot;        AND  A.ITEM155 = &apos;false&apos;    &quot;;
			SQL +=&quot;      AND  A.ITEM115 IS NOT NULL      &quot;;
			SQL +=&quot;        AND ( A.ITEM83 IS  NULL OR  A.ITEM83 = &apos;N&apos;)        &quot;;
			SQL +=&quot;        AND  A.ITEM88 = &apos;合格&apos; &quot;;
			SQL +=&quot;        AND  A.ITEM83 IS NULL &quot;;
			SQL +=&quot;        AND  A.ITEM155 = &apos;false&apos;        &quot;;
			SQL +=&quot;        AND A.ITEM11=&apos;&quot;+v_bas_level+&quot;&apos;        &quot;;
			SQL +=&quot;        AND A.ITEM94 IS NOT NULL &quot;;
			SQL +=&quot; UNION &quot;;
			SQL +=&quot; SELECT       &quot;;
			SQL +=&quot;        B.u_no || &apos;-&apos; || B.u_name u_name, &quot;;
			SQL +=&quot;        B.m_name       &quot;;
//			SQL +=&quot;         (select depid from a_bas_dep where area=&apos;TGCE&apos; and u_name =B.u_no || &apos;-&apos; || B.u_name||&apos;-&apos;||B.M_NAME) depid &quot;;
			SQL +=&quot;   FROM A_BAS_UNIT_OLDDATA B &quot;;
			SQL +=&quot;  WHERE     B.area = &apos;&quot;+v_factory+&quot;&apos; &quot;;
			SQL +=&quot;        AND B.user_id = &apos;&quot;+empno+&quot;&apos; &quot;;
			SQL +=&quot;        AND (B.fail_flag = &apos;N&apos; or B.fail_flag is null)       &quot;;
			SQL +=&quot;        AND B.U_LEVEL=&apos;&quot;+v_bas_level+&quot;&apos; &quot;;
			SQL +=&quot;        AND B.RETURN_DATE IS NOT NULL &quot;;
		var rs = Client.SQLloadValue(SQL);
		if(rs!=null &amp;&amp; rs.size()&gt;0){
			var count = 0;
			if(v_bas_level==&quot;E3&quot;){
				msg +=&quot;製造單位不可申請E3多能功，請確認!&quot;
			}else{
				if(!depid.equals(dep_id2)){//本次新增的認證單元歸屬單位與申請人歸屬單位不同
				}else{
					for(var i = 0;i&lt;rs.size();i++){					
						var ls_u_name = rs.get(i).get(&quot;u_name&quot;);
						var ls_m_name = rs.get(i).get(&quot;m_name&quot;);
						if(chk_unit_dep(ls_u_name,ls_m_name,dep_id2)){		
							msg +=&quot;製造單位只能新增跨單位多能功，請確認!\n已申請過(&quot;+ls_u_name+&quot;-&quot;+ls_m_name+&quot;)&quot;;
							break;
						}
					}
				}
				
			}
			
		}
		
	}else{
		msg +=&quot;【&quot;+v_unit_no+&quot;】&quot;+&quot;【&quot;+v_m_name+&quot;】尚未建立歸屬單位，請洽專案負責人!&quot;;
	}
	return msg;
}

function chk_unit_dep(ls_u_name,ls_m_name,dep_id2){
	var flag = false;	
	var sql =&quot;select depid from a_bas_dep where area=&apos;TGCE&apos; and u_name =&apos;&quot;+ls_u_name+&quot;-&quot;+ls_m_name+&quot;&apos;&quot;;
	Client.addDebugLog(&quot;sql==&quot;+sql);
	Client.addDebugLog(&quot;dep_id2==&quot;+dep_id2);
	var vec = Client.SQLloadValue(sql);
	if(vec!=null &amp;&amp; vec.size()&gt;0){
		for(var i = 0;i&lt;vec.size();i++){
			var v_depid = vec.get(i).get(&quot;depid&quot;);
			Client.addDebugLog(&quot;v_depid==&quot;+v_depid);
			if(v_depid.equals(dep_id2)){
				
				flag = true;
				break;
			}
		}
	}
	return flag;
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00371304154561490</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2017/03/30 09:10:54</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.PLM.Common.Server.addAsignTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00371304154561490</string> 
     </void> 
     <void property="name"> 
      <string>addAsignTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00281213180209899</string> 
     </void> 
     <void property="scriptSource"> 
      <string>// 設定會簽人員function
function addAsignList(MyTask,companyID,PARAMETER,Sign_MemberTable){
//	Server.addDebugLog(&quot;CAll addAsignList ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);	
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
		SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;				
		SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
		SQL += &quot; and B.KEY1 = &apos;&quot;+companyID+&quot;&apos;&quot;  ;	
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
		SQL += &quot; and C.MEMID=B.VALUE2&quot;;		
	  try{
	  	var vec = Server.SQLloadValue(SQL);			
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;);				 
			      var cMember = Server.getMemberByID(memid);					  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);			  
		           }		  				  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
			    //離職人員判斷，若離職則轉單至ADM
				var Dauble_flag = memisDauble(SignTable,memid) ;
				var cmemid = memid ;
				if(Dauble_flag != &quot;Y&quot;){
				   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, companyID+PARAMETER);				    
					      SignTable.add(row,hm);
				   var new_record =&quot;Y&quot; ;				  
				}
			 }//for
			//寫入會簽群組Table，子流程使用
		    if (SignTable_G != null){			
			  if (new_record == &quot;Y&quot;){				 
				var Dauble_flag_G = memisDauble(SignTable_G,companyID+PARAMETER) ;
			     if(Dauble_flag_G != &quot;Y&quot;){
					var hm1 = new java.util.HashMap();
                    var row1 = SignTable_G.size();//SignTable裡資料筆數		
						hm1.put(&quot;ITEM1&quot;, companyID+PARAMETER);	
						SignTable_G.add(row1,hm1);
		        }
			  }	
		    }		
		}else{			
			Server.addInfoLog(companyID+&quot;_&quot;+PARAMETER+&quot;沒有設定會簽人員!&quot;+memid);
		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignList !!!\n&quot;+SQL+memid);
	}
//	Server.addDebugLog(&quot;CAll addAsignList ===&gt;&gt; End &quot;);
}//function addAsignList
function addAsignList_temp(MyTask,companyID,PARAMETER,Sign_MemberTable,temp){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
		SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;			
		SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
		SQL += &quot; and B.KEY1 = &apos;&quot;+companyID+&quot;&apos;&quot;  ;	
        SQL += &quot; and B.VALUE3 like &apos;%&quot; + temp + &quot;%&apos; &quot;;	
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
		SQL += &quot; and C.MEMID=B.VALUE2&quot;;
	var vec = Server.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Server.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
//			    //離職人員判斷，若離職則轉單至ADM

					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;

				if(Dauble_flag != &quot;Y&quot;){
                   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, companyID+PARAMETER);				    
					      SignTable.add(row,hm);
				   var new_record =&quot;Y&quot; ;
				}
			 }//for
			//寫入會簽群組Table，子流程使用
  	        if (SignTable_G != null){
			 if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble(SignTable_G,companyID+PARAMETER);
			     if(Dauble_flag_G != &quot;Y&quot;){
					var hm1 = new java.util.HashMap();
                    var row1 = SignTable_G.size();//SignTable裡資料筆數		
						hm1.put(&quot;ITEM1&quot;, companyID+PARAMETER);	
						SignTable_G.add(row1,hm1);
		         }	
		      }
		   }	
		}else{
			Server.addInfoLog(companyID+&quot;_&quot;+PARAMETER+&quot;沒有設定會簽人員!&quot;+memid);			
		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignList_temp !!!\n&quot;+SQL+memid);
	}
}//function addAsignList

function addAsignList_temp_d(MyTask,companyID,PARAMETER,Sign_MemberTable,temp,desc){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
		SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;			
		SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
		SQL += &quot; and B.KEY1 = &apos;&quot;+companyID+&quot;&apos;&quot;  ;	
        SQL += &quot; and B.VALUE3 like &apos;%&quot; + temp + &quot;%&apos; &quot;;	
		SQL += &quot; and B.description =&apos;&quot;+desc+&quot;&apos; &quot;;
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
		SQL += &quot; and C.MEMID=B.VALUE2&quot;;
	var vec = Server.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Server.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
//			    //離職人員判斷，若離職則轉單至ADM

					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;

				if(Dauble_flag != &quot;Y&quot;){
                   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, companyID+PARAMETER);				    
					      SignTable.add(row,hm);
				   var new_record =&quot;Y&quot; ;
				}
			 }//for
			//寫入會簽群組Table，子流程使用
  	        if (SignTable_G != null){
			 if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble(SignTable_G,companyID+PARAMETER);
			     if(Dauble_flag_G != &quot;Y&quot;){
					var hm1 = new java.util.HashMap();
                    var row1 = SignTable_G.size();//SignTable裡資料筆數		
						hm1.put(&quot;ITEM1&quot;, companyID+PARAMETER);	
						SignTable_G.add(row1,hm1);
		         }	
		      }
		   }	
		}else{
			Server.addInfoLog(companyID+&quot;_&quot;+PARAMETER+&quot;沒有設定會簽人員!&quot;+memid);			
		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignList_temp !!!\n&quot;+SQL+memid);
	}
}//function addAsignList

function addAsignCustomer(MyTask,companyID,PARAMETER,Sign_MemberTable,item_no){ 
//PLM PM CS角色
//	Server.addDebugLog(&quot;CAll addAsignCustomer ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
		SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;			
		SQL += &quot; and A.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		SQL += &quot; and B.KEY1 in (&apos;&quot;+ companyID +&quot;&apos;) &quot;  ;	
		SQL += &quot; and B.VALUE3 LIKE &apos;%&quot;+ item_no +&quot;%&apos; &quot;  ;
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
		SQL += &quot; and C.MEMID=B.VALUE2&quot;;
		
  var vec = Server.SQLloadValue(SQL);
  try{			
    if ( vec != null ){
	   if (vec.size()&gt;0){
		   var new_record =&quot;&quot;;
		  for(var i=0;i&lt;vec.size();i++)  {
			  var ht = vec.get(i);
			  var memid = ht.get(&quot;memid&quot;)
			  var cMember = Server.getMemberByID(memid);			  
			  if(cMember == null){
              // 檢核員工是否是有效的,若無效基本上會傳給PDM , 
				memid = &quot;MEMPDM0001&quot;  	
				var cMember = Server.getMemberByID(memid);
			  }		  
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);		  
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  
//			  //離職人員判斷，若離職則轉單至ADM
//				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;
//			    }else{
//					 var Dauble_flag = memisDauble(SignTable,memid) ;	
//					 var cmemid = &quot;PDM&quot; ;	 
//				}//if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;)
//
				if(Dauble_flag != &quot;Y&quot;){
                   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, companyID+PARAMETER);				    
					      SignTable.add(row,hm);		   
				   var new_record =&quot;Y&quot; ;
				}
			 }//for
			//寫入會簽群組Table，子流程使用
 	        if (SignTable_G != null){
			  if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble(SignTable_G,companyID+PARAMETER) ;
				 if(Dauble_flag_G != &quot;Y&quot;){
					var hm1 = new java.util.HashMap();
                    var row1 = SignTable_G.size();//SignTable裡資料筆數		
						hm1.put(&quot;ITEM1&quot;, companyID+PARAMETER);	
						SignTable_G.add(row1,hm1);
		          }
			  }
		    }		
			  
		  }else{
                 var item_no=&quot;ALL&quot;;
		         var SQL_1  = &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
				     SQL_1 += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		             SQL_1 += &quot; where  A.ACTIVE = &apos;true&apos; &quot;;
               		 SQL_1 += &quot; and C.RESIGN = &apos;false&apos;&quot; ;							 
		             SQL_1 += &quot; and A.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		             SQL_1 += &quot; and B.KEY1 in (&apos;&quot;+ companyID +&quot;&apos;) &quot;  ;	
		             SQL_1 += &quot; and B.VALUE3 LIKE &apos;%&quot;+ item_no +&quot;%&apos; &quot;  ;
                     SQL_1 += &quot; and A.PARAMETER = B.PARAMETER &quot;;					 
		             SQL_1 += &quot; and C.MEMID=B.VALUE2&quot;;
		
 	             var vec_1 = Server.SQLloadValue(SQL_1);
				 
				 if (vec_1.size()&gt;0){
		             for(var i=0;i&lt;vec_1.size();i++)  {			 
			             var ht = vec_1.get(i);
			             var memid = ht.get(&quot;memid&quot;)
			             var cMember = Server.getMemberByID(memid);	
					 
//			             if(cMember == null){
//                            // 檢核員工是否是有效的,若無效基本上會傳給PDM , 
//				            memid = &quot;MEMPDM0001&quot; 
//				            var cMember = Server.getMemberByID(memid);	
//			             }
			               var roleID = cMember.getMainRoleID();
			               var memDR =  cMember.getMemberDR(roleID);		  
			               var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  
//			               //離職人員判斷，若離職則轉單至ADM
//				           if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
//					           SignTable.setValueAt(memid,row,&quot;memid&quot;);
					       var Dauble_flag = memisDauble(SignTable,memid) ;
					       var cmemid = memid ;
//			               }else{
//						       SignTable.setValueAt(&quot;MEMPDM0001&quot;,row,&quot;memid&quot;);
//						   }
				    if(Dauble_flag != &quot;Y&quot;){
                      var hm = new java.util.HashMap();
				      var row = SignTable.size();//SignTable裡資料筆數
					      hm.put(&quot;ITEM1&quot;, cmemid);
					      hm.put(&quot;ITEM3&quot;, cMember);
					      hm.put(&quot;ITEM4&quot;, dptcname);
					      hm.put(&quot;ITEM2&quot;, memDR);
					      hm.put(&quot;ITEM5&quot;, companyID+PARAMETER);				    
					         SignTable.add(row,hm);		   
				      var new_record =&quot;Y&quot; ;
				    }
			       }//for			
			     if (SignTable_G != null){
			       if (new_record == &quot;Y&quot;){
			           var Dauble_flag_G = memisDauble(SignTable_G,companyID+PARAMETER) ;
				        if(Dauble_flag_G != &quot;Y&quot;){
				   	       var hm1 = new java.util.HashMap();
                           var row1 = SignTable_G.size();//SignTable裡資料筆數		
						       hm1.put(&quot;ITEM1&quot;, companyID+PARAMETER);	
						       SignTable_G.add(row1,hm1);
		                }
			       }
		         }
				}else{	
			       Server.addInfoLog(companyID+&quot;_&quot;+PARAMETER+&quot;沒有設定會簽人員!&quot;+memid);		
		       } //if (vec_1.size()&gt;0)  
		  }//if (vec.size()&gt;0)	  
	}//if ( vec != null )
  }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignCustomer !!!\n&quot;+SQL+memid);
 }		
// 	Server.addDebugLog(&quot;CAll addAsignCustomer ===&gt;&gt; End&quot;);
}//function addAsignCustomer

function addAsignList_VP(MyTask,companyID,PARAMETER,Sign_MemberTable,temp1,temp2){
//	Server.addDebugLog(&quot;CAll addAsignList_VP ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
		SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;			
		SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
		SQL += &quot; and B.KEY1 = &apos;&quot;+companyID+&quot;&apos;&quot;  ;	
        SQL += &quot; and B.VALUE3 like &apos;%&quot; + temp1 + &quot;%&apos; &quot;;	
		if( temp1 == &quot;PE_MAX&quot;){
        SQL += &quot; and B.VALUE2 &lt;&gt;&apos;&quot; + dataMap.get(&quot;director_memid&quot;) + &quot;&apos; &quot;;				
        }		
		if(temp2!=&quot;&quot;){
	      if((companyID == &quot;TGCE&quot; &amp;&amp;  temp2.substr(0,2)== &quot;2J&quot; ) ||
		     (companyID == &quot;TGCE&quot; &amp;&amp;  temp2.substr(0,3)== &quot;2R2&quot; ) ||
	          companyID == &quot;HGCE&quot;){			
           SQL += &quot; and B.description like &apos;%&quot; + temp2.substr(0,2) + &quot;%&apos; &quot;;			
		  }else{
		   SQL += &quot; and B.description is null&quot;;		   
		  } 
		}
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
		SQL += &quot; and C.MEMID=B.VALUE2&quot;;
	var vec = Server.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Server.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
				  var Dauble_flag = memisDauble(SignTable,memid) ;
				  var cmemid = memid ;
				  
				if(Dauble_flag != &quot;Y&quot;){
                   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, companyID+temp1);				    
					      SignTable.add(row,hm);
				   var new_record =&quot;Y&quot; ;
				}
			 }//for
			//寫入會簽群組Table，子流程使用
  	        if (SignTable_G != null){
			 if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble(SignTable_G,companyID+temp1);
			     if(Dauble_flag_G != &quot;Y&quot;){
					var hm1 = new java.util.HashMap();
                    var row1 = SignTable_G.size();//SignTable裡資料筆數		
						hm1.put(&quot;ITEM1&quot;, companyID+temp1);	
						SignTable_G.add(row1,hm1);
		         }	
		      }
		   }	
		}else{
			Server.addInfoLog(companyID+&quot;_&quot;+temp1+&quot;沒有設定會簽人員!&quot;+memid);			
		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignList_temp !!!\n&quot;+SQL+memid);
	}
//	Server.addDebugLog(&quot;CAll addAsignList_VP ===&gt;&gt; End&quot;);
}//function addAsignList_VP

function addAsign_ECN(MyTask,companyID,PARAMETER,Sign_MemberTable,item_no){ 
//PLM PM CS角色
//	Server.addDebugLog(&quot;CAll addAsign_ECN ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
        SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;				
		SQL += &quot; and A.PARAMETER = &apos;&quot;+ PARAMETER +&quot;&apos; &quot;;
		SQL += &quot; and B.KEY1 in (&apos;&quot;+ companyID +&quot;&apos;) &quot;  ;	
		SQL += &quot; and B.VALUE3 in (&quot;+ item_no +&quot;)&quot;  ;
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
		SQL += &quot; and C.MEMID = B.VALUE2&quot;;
  var vec = Server.SQLloadValue(SQL);		
  try{			
    if ( vec != null ){
	   if (vec.size()&gt;0){
		   var new_record =&quot;&quot;;
		  for(var i=0;i&lt;vec.size();i++)  {
			  var ht = vec.get(i);
			  var memid = ht.get(&quot;memid&quot;)
			  var cMember = Server.getMemberByID(memid);		  
			  if(cMember == null){
              // 檢核員工是否是有效的,若無效基本上會傳給PDM , 
				memid = &quot;MEMPDM0001&quot; 	
				var cMember = Server.getMemberByID(memid);
			  }		  
			  var roleID = cMember.getMainRoleID();
			  var memDR =  cMember.getMemberDR(roleID);		  
			  var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  
			  //離職人員判斷，若離職則轉單至ADM
//				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(SignTable,memid) ;
					var cmemid = memid ;
//			    }else{
//					 var Dauble_flag = memisDauble(SignTable,memid) ;	
//					 var cmemid = &quot;PDM&quot; ;	 
//				}//if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;)

				if(Dauble_flag != &quot;Y&quot;){
                   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, companyID+&quot;PLM&quot;+cmemid);				    
					      SignTable.add(row,hm);			   
				   var new_record =&quot;Y&quot; ;
				}
			
			 }//for
			//寫入會簽群組Table，子流程使用
	        if (SignTable_G != null){
			  if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble_G(SignTable_G,companyID+&quot;PLM&quot;+cmemid) ;			
				  if(Dauble_flag_G != &quot;Y&quot;){
					var hm1 = new java.util.HashMap();
                    var row1 = SignTable_G.size();//SignTable裡資料筆數		
						hm1.put(&quot;ITEM1&quot;, companyID+&quot;PLM&quot;+cmemid);	
						SignTable_G.add(row1,hm1);
		          }
			  }
		    }		
		  }
	}//if ( vec != null )
  }catch(e){
   		Server.addInfoLog(&quot;讀取參數檔失敗 addAsign_ECN !!!\n&quot;+SQL+memid);
 }	
// Server.addDebugLog(&quot;CAll addAsign_ECN ===&gt;&gt; End&quot;);	
}//function addAsign_ECN

function addAsign_DEP_FC_MAX(MyTask,companyID,PARAMETER,Sign_MemberTable){ 
//PLM角色  ME最高主管  ex:高國明 廠長
//		Form.showMessageDialog(&quot;addAsign_DEP_FC_MAX&quot;);
//	Server.addDebugLog(&quot;CAll addAsign_DEP_FC_MAX ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	if( dataMap.get(&quot;design-t&quot;) == &quot;true&quot;){	
			var Depart_ID = &quot;DEPT2P0&quot;
			var Department = Server.getDepartment(Depart_ID); // 取得部門物件
			var v_jobtitle = &quot;T_FC_MAX&quot;;
		}
	else if( dataMap.get(&quot;design-s&quot;) == &quot;true&quot;){
			var Depart_ID = &quot;DEPS6P0&quot;
			var Department = Server.getDepartment(Depart_ID); // 取得部門物件		
            var v_jobtitle = &quot;S_FC_MAX&quot;;			
			}
	else if( dataMap.get(&quot;design-c&quot;) == &quot;true&quot;){
			var Depart_ID = &quot;DEPC8P0&quot;
			var Department = Server.getDepartment(Depart_ID); // 取得部門物件	
            var v_jobtitle = &quot;C_FC_MAX&quot;;				
		}
	else if( dataMap.get(&quot;design-h&quot;) == &quot;true&quot;){
			var Depart_ID = &quot;DEPH5P0&quot;
			var Department = Server.getDepartment(Depart_ID); // 取得部門物件	
            var v_jobtitle = &quot;H_FC_MAX&quot;;				
	}
	
	  if(Department != null){
		 var memid = Department.getManagerID() ;

		 var SQL =    &quot; select RESIGN from mem_geninf where memid =&apos;&quot;+ memid +&quot;&apos;&quot;;
	     var vec = Server.SQLloadValue(SQL);			
		   if ( vec != null &amp;&amp; vec.size()&gt;0){
				 for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			       if(memid== null){
                       // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				       memid = &quot;MEMPDM0001&quot;  
			       }
				  var cMember = Server.getMemberByID(memid);
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
			    //離職人員判斷，若離職則轉單至ADM
//				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var cmemid = memid ;
//			    }else{
//					 var cmemid = &quot;PDM&quot; ;	 
//				}//if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;)
		      var Dauble_flag = memisDauble(SignTable,memid) ;	
	          if(Dauble_flag != &quot;Y&quot;){	
                   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, companyID+PARAMETER);				    
					      SignTable.add(row,hm);
					 var  new_record = &quot;Y&quot;;
				}
			 
			 if (SignTable_G != null){
			       if (new_record == &quot;Y&quot;){
			           var Dauble_flag_G = memisDauble(SignTable_G,companyID+PARAMETER) ;
				        if(Dauble_flag_G != &quot;Y&quot;){
				   	       var hm1 = new java.util.HashMap();
                           var row1 = SignTable_G.size();//SignTable裡資料筆數		
						       hm1.put(&quot;ITEM1&quot;, companyID+PARAMETER);	
						       SignTable_G.add(row1,hm1);
		                }
			       }
		     }	
		   }	
		  }//for
		}
//		Server.addDebugLog(&quot;CAll addAsign_DEP_FC_MAX ===&gt;&gt; End&quot;);
	}

function addAsignList_OPE(MyTask,companyID,PARAMETER,Sign_MemberTable){
//	Server.addDebugLog(&quot;CAll addAsignList_OPE ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	var SQL = &quot;select MEMID from mem_geninf  where username=&apos;&quot; + PARAMETER + &quot;&apos;&quot;;	
	var vec = Server.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				   var cmemid = vec.get(0).get(&quot;memid&quot;);
                   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;,&quot;&quot;);
					   hm.put(&quot;ITEM4&quot;,&quot;&quot;);
					   hm.put(&quot;ITEM2&quot;,PARAMETER);
					   hm.put(&quot;ITEM5&quot;, PARAMETER);				    
					      SignTable.add(row,hm);	

			    if (SignTable_G != null){
				  var hm1 = new java.util.HashMap();
                  var row1 = SignTable_G.size();//SignTable裡資料筆數		
				      hm1.put(&quot;ITEM1&quot;, PARAMETER);	
				     SignTable_G.add(row1,hm1);
		        }		
		    }else{
			   Server.addInfoLog(PARAMETER+&quot;沒有設定會簽人員!&quot;+memid);	
		    }//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
	   Server.addInfoLog(&quot;讀取參數檔失敗 addAsignList_OPE !!!\n&quot;+SQL+memid);
	}
//	Server.addDebugLog(&quot;CAll addAsignList_OPE ===&gt;&gt; End&quot;);
}//function addAsignList_OPE	

//PE/ME最高主管(ALL)   ex:湯智彬
function addAsign_DEP_PE_ME_MAX(MyTask,companyID,PARAMETER,Sign_MemberTable){
//PLM角色
//	Server.addDebugLog(&quot;CAll addAsign_DEP_PE_ME_MAX ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
//#DEPT2J0 #DEPT2J2 #DEPT2J5  yes都Run
	if( &quot;true&quot;==dataMap.get(&quot;design-t&quot;) ){	
		for(var i=0;i&lt;6;i++){	
				if( i == 1 || i == 3 || i == 4 ){				
					continue ;
				}
				var Depart_ID = &quot;DEPT2J&quot;+i							 
				var Department = Server.getDepartment(Depart_ID); // 取得部門物件				
				if(Department != null){
					var memid = Department.getManagerID() ;
					var Member = Server.getMemberByID(memid);			
					var username = Member.getName(); 				
					var row = SignTable.newRow()-1;
					SignTable.setValueAt(username,row,&quot;cname&quot;);
					SignTable.setValueAt(memid,row,&quot;memid&quot;);	
					SignTable.setValueAt(&quot;T_PE_MAX&quot;,row,&quot;jobtitle&quot;);	
				    SignTable.setValueAt(&quot;T_PE_MAX&quot;,row,&quot;groupid&quot;);		
		   }
		}
		 if (SignTable_G != null){
			 var hm1 = new java.util.HashMap();
             var row1 = SignTable_G.size();//SignTable裡資料筆數		
				 hm1.put(&quot;ITEM1&quot;, &quot;T_PE_MAX&quot;);	
				 SignTable_G.add(row1,hm1);
		}	
	}
//	if( &quot;true&quot;==dataMap.get(&quot;design-t&quot;) ){
//		memid = &quot;MEMT1001852&quot;  // 先設給001852	    
//		var cMember = Client.getMemberByID(memid);			
//		var row = SignTable.newRow()-1;
//		SignTable.setValueAt(&quot;許朝政&quot;,row,&quot;cname&quot;);
//		SignTable.setValueAt(memid,row,&quot;memid&quot;);	
//		SignTable.setValueAt(&quot;T_PE_MAX&quot;,row,&quot;jobtitle&quot;);
//	}				
	//#DEPS6J0 #DEPS6J1 #DEPS6J2
	if( &quot;true&quot;==appDataMap.get(&quot;design-s&quot;)  ){
		for(var i=0;i&lt;3;i++){	
			var Depart_ID = &quot;DEPS6J&quot;+i
			var Department = Server.getDepartment(Depart_ID);			
			if(Department != null){
				var memid = Department.getManagerID() ;
				var Member = Server.getMemberByID(memid);			
				var username = Member.getName(); 
					var row = SignTable.newRow()-1;
					SignTable.setValueAt(username,row,&quot;cname&quot;);
					SignTable.setValueAt(memid,row,&quot;memid&quot;);	
					SignTable.setValueAt(&quot;S_PE_MAX&quot;,row,&quot;jobtitle&quot;);
				    SignTable.setValueAt(&quot;S_PE_MAX&quot;,row,&quot;groupid&quot;);							
			}	
		}
	if (SignTable_G != null){
		var hm1 = new java.util.HashMap();
        var row1 = SignTable_G.size();//SignTable裡資料筆數		
			hm1.put(&quot;ITEM1&quot;,&quot;S_PE_MAX&quot;);	
			SignTable_G.add(row1,hm1);
	}	
		
	}
	//#DEPC8J1 #DEPC8J2							 
	if( &quot;true&quot;==appDataMap.get(&quot;design-c&quot;)  ){
		for(var i=1;i&lt;3;i++){	
			var Depart_ID = &quot;DEPC8J&quot;+i
			var Department = Server.getDepartment(Depart_ID); // 取得部門物件			
			if(Department != null){
				var memid = Department.getManagerID() ;
				var Member = Server.getMemberByID(memid);	
				var username = Member.getName(); 
				var row = SignTable.newRow()-1;
				SignTable.setValueAt(username,row,&quot;cname&quot;);
				SignTable.setValueAt(memid,row,&quot;memid&quot;);	
				SignTable.setValueAt(&quot;C_PE_MAX&quot;,row,&quot;jobtitle&quot;);	
				SignTable.setValueAt(&quot;C_PE_MAX&quot;,row,&quot;groupid&quot;);						
			}	
		}
	if (SignTable_G != null){
		var hm1 = new java.util.HashMap();
        var row1 = SignTable_G.size();//SignTable裡資料筆數		
			hm1.put(&quot;ITEM1&quot;,&quot;C_PE_MAX&quot;);	
			SignTable_G.add(row1,hm1);		
	}	
		
	}
	
  	//#DEPC8J1 #DEPC8J2							 
	if( &quot;true&quot;==appDataMap.get(&quot;design-h&quot;)  ){
		for(var i=1;i&lt;1;i++){	
			var Depart_ID = &quot;DEPH5J0&quot;+i
			var Department = Server.getDepartment(Depart_ID); // 取得部門物件			
			if(Department != null){
				var memid = Department.getManagerID() ;
				var Member = Server.getMemberByID(memid);	
				var username = Member.getName(); 
				var row = SignTable.newRow()-1;
				SignTable.setValueAt(username,row,&quot;cname&quot;);
				SignTable.setValueAt(memid,row,&quot;memid&quot;);	
				SignTable.setValueAt(&quot;H_PE_MAX&quot;,row,&quot;jobtitle&quot;);	
				SignTable.setValueAt(&quot;H_PE_MAX&quot;,row,&quot;groupid&quot;);						
			}	
		}	
	if (SignTable_G != null){
	   var hm1 = new java.util.HashMap();
       var row1 = SignTable_G.size();//SignTable裡資料筆數		
				hm1.put(&quot;ITEM1&quot;, companyID+PARAMETER);	
				SignTable_G.add(row1,hm1);
	     var row1 = SignTable_G.newRow()-1;	
		SignTable_G.setValueAt(&quot;H_PE_MAX&quot;,row1,&quot;groupid&quot;);
	}	
		
	}
//	Server.addDebugLog(&quot;CAll addAsign_DEP_PE_ME_MAX ===&gt;&gt; End&quot;);	
}	

function addAsignList_Tech_VP(MyTask,companyID,PARAMETER,Sign_MemberTable){
//	Server.addDebugLog(&quot;CAll addAsignList_Tech_VP ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	
	
	if((companyID == &quot;TGCE&quot; &amp;&amp;  PARAMETER.substring(0,2)== &quot;2J&quot; ) ||
		(companyID == &quot;TGCE&quot; &amp;&amp;  PARAMETER.substring(0,3)== &quot;2R2&quot; ) ||
	    companyID == &quot;HGCE&quot;){
	var memid =&quot;MEMT1006161&quot;;
	var cMember = Server.getMemberByID(memid);					  
	if(cMember == null){
        // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
		memid = &quot;MEMPDM0001&quot;  
	    var cMember = Server.getMemberByID(memid);			  
    }		  				  
	var roleID = cMember.getMainRoleID();
	var memDR =  cMember.getMemberDR(roleID);		  
	var dptcname = memDR.getDepartmentName();	//使用者部門名稱
	  var Dauble_flag = memisDauble(SignTable,&quot;MEMT1006161&quot;) ;	
	   if(Dauble_flag != &quot;Y&quot;){	
		 var hm = new java.util.HashMap();
		 var row = SignTable.size();//SignTable裡資料筆數
			 hm.put(&quot;ITEM1&quot;, cMember.getID());
			 hm.put(&quot;ITEM3&quot;, cMember);
			 hm.put(&quot;ITEM4&quot;, dptcname);
			 hm.put(&quot;ITEM2&quot;, memDR);
			 hm.put(&quot;ITEM5&quot;, companyID+PARAMETER);				    
			SignTable.add(row,hm);	 

	    //寫入會簽群組Table，子流程使用		 
		var hm1 = new java.util.HashMap();
        var row1 = SignTable_G.size();//SignTable裡資料筆數		
			hm1.put(&quot;ITEM1&quot;, companyID+&quot;MEMT1019244&quot;);	
			SignTable_G.add(row1,hm1);
     } 		 
	}else{
	   var memid =&quot;MEMT1006161&quot;;
	   var cMember = Server.getMemberByID(memid);					  
	   if(cMember == null){
		   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
		   memid = &quot;MEMPDM0001&quot;  
		   var cMember = Server.getMemberByID(memid);			  
	   }		  				  
	   var roleID = cMember.getMainRoleID();
	   var memDR =  cMember.getMemberDR(roleID);		  
	   var dptcname = memDR.getDepartmentName();	//使用者部門名稱	
	   var Dauble_flag = memisDauble(SignTable,&quot;MEMT1016470&quot;) ;	
	   if(Dauble_flag != &quot;Y&quot;){	
		  var hm = new java.util.HashMap();
		  var row = SignTable.size();//SignTable裡資料筆數
			  hm.put(&quot;ITEM1&quot;, cMember.getID());
			  hm.put(&quot;ITEM3&quot;, cMember);
			  hm.put(&quot;ITEM4&quot;, dptcname);
			  hm.put(&quot;ITEM2&quot;, memDR);
			  hm.put(&quot;ITEM5&quot;, companyID+PARAMETER);				    
		  SignTable.add(row,hm);	
		  
		//寫入會簽群組Table，子流程使用	
		 var hm1 = new java.util.HashMap();
         var row1 = SignTable_G.size();//SignTable裡資料筆數		
			 hm1.put(&quot;ITEM1&quot;,companyID+&quot;MEMT1016470&quot;);	
			 SignTable_G.add(row1,hm1);
      }				 
   }
//   	Server.addDebugLog(&quot;CAll addAsignList_Tech_VP ===&gt;&gt; End&quot;);
  }//function addAsignList_Tech_VP
  
function addAsign_MECN_MFG(MyTask,companyID,table,Sign_MemberTable){
//	Server.addDebugLog(&quot;CAll addAsign_MECN_MFG ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var table = dataMap.get(table);
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);

	try{	
	 if (table.size()&gt;0){		
	 for(var i =0;i&lt;table.size();i++){
		 var cmemid = table.get(i).get(&quot;ITEM2&quot;);
		 var cMember = table.get(i).get(&quot;ITEM4&quot;);
		 var dptcname = table.get(i).get(&quot;ITEM1&quot;);
		 var memDR = table.get(i).get(&quot;ITEM9&quot;);
		 var groupid = &quot;MFG_&quot;+table.get(i).get(&quot;ITEM1&quot;);	
		 var new_record =&quot;N&quot; ; 
		 var Dauble_flag = memisDauble(SignTable,cmemid);	
		 var member = Server.getMemberByID(cmemid);
		 if(member==null || member.isResign()){ //若會簽人員離職了，就不加進table中 add by edison@20141208
			 Dauble_flag = &quot;Y&quot;;
		 }
	   
	   if(Dauble_flag != &quot;Y&quot; &amp;&amp; cmemid!=&quot;MEMT1004670&quot;){	 //李瑞彬不用簽教育訓練關卡 add by edison@20141208
		 var hm = new java.util.HashMap();
		 var row = SignTable.size();//SignTable裡資料筆數
		     hm.put(&quot;ITEM1&quot;, cmemid);
			 hm.put(&quot;ITEM3&quot;, cMember);
			 hm.put(&quot;ITEM4&quot;, dptcname);
			 hm.put(&quot;ITEM2&quot;, memDR);
			 hm.put(&quot;ITEM5&quot;, groupid);				    
			 SignTable.add(row,hm);
			 new_record =&quot;Y&quot; ;  
		}
	    //寫入會簽群組Table，子流程使用
		if (SignTable_G != null){
		    if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble(SignTable_G,groupid) ;
				    if(Dauble_flag_G != &quot;Y&quot;){
				   	   var hm1 = new java.util.HashMap();
                       var row1 = SignTable_G.size();//SignTable裡資料筆數		
						   hm1.put(&quot;ITEM1&quot;, groupid);	
						   SignTable_G.add(row1,hm1);
		            }
			 }
		 }	
	 }//for
	}// if (table.size()&gt;0)
   }catch(e){
	Server.addInfoLog(&quot;讀取參數檔失敗 addAsign_MECN_MFG !!!\n&quot;+SQL+memid);
   }
//   	Server.addDebugLog(&quot;CAll addAsign_MECN_MFG ===&gt;&gt; End&quot;);
}//function addAsign_MECN_MFG	 

function addAsign_MECN_TEMP(MyTask,companyID,table,Sign_MemberTable){
//	Server.addDebugLog(&quot;CAll addAsign_MECN_TEMP ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var table = dataMap.get(table);
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);

	try{	
	 if (table.size()&gt;0){		
	 for(var i =0;i&lt;table.size();i++){
	   var cmemid = table.get(i).get(&quot;ITEM1&quot;);
	   var groupid = table.get(i).get(&quot;ITEM5&quot;);	   
	   var Dauble_flag = memisDauble(SignTable,cmemid);	
	   
	   if(Dauble_flag != &quot;Y&quot; &amp;&amp; table!=Sign_MemberTable){	 
		 var hm = new java.util.HashMap();
		 var row = SignTable.size();//SignTable裡資料筆數
		     hm.put(&quot;ITEM1&quot;, table.get(i).get(&quot;ITEM1&quot;));
			 hm.put(&quot;ITEM3&quot;, table.get(i).get(&quot;ITEM3&quot;));
			 hm.put(&quot;ITEM4&quot;, table.get(i).get(&quot;ITEM4&quot;));
			 hm.put(&quot;ITEM2&quot;, table.get(i).get(&quot;ITEM2&quot;));
			 hm.put(&quot;ITEM5&quot;, table.get(i).get(&quot;ITEM5&quot;));				    
			 SignTable.add(row,hm);
		 var new_record =&quot;Y&quot; ;  
		}
	    //寫入會簽群組Table，子流程使用
		if (SignTable_G != null){
		    if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble(SignTable_G,groupid) ;
				    if(Dauble_flag_G != &quot;Y&quot;){
				   	   var hm1 = new java.util.HashMap();
                       var row1 = SignTable_G.size();//SignTable裡資料筆數		
						   hm1.put(&quot;ITEM1&quot;, groupid);	
						   SignTable_G.add(row1,hm1);
		            }
			 }
		 }	
	 }//for
	}// if (table.size()&gt;0)
   }catch(e){
	Server.addInfoLog(&quot;讀取參數檔失敗 addAsign_MECN_TEMP !!!\n&quot;+SQL+memid);
   }
//   	Server.addDebugLog(&quot;CAll addAsign_MECN_TEMP ===&gt;&gt; End&quot;);
}//function addAsign_MECN_TEMP	

function memisDauble(table,temp){
        var flag =&quot;&quot;;
		for(var j = 0;j&lt;table.size();j++){
			if(table.get(j).get(&quot;ITEM1&quot;).equals(temp)){
		 		var flag =&quot;Y&quot;;
			}
		}
		return flag ;		
}//function memisDauble

function memisDauble_G(table,groupid){
        var flag =&quot;&quot;;
		for(var j = 0;j&lt;table.size();j++){
			if(table.get(j).get(&quot;ITEM1&quot;).equals(groupid)){			
		 		var flag =&quot;Y&quot;;
			}
		}
		return flag ;		
}//function memisDauble_G

function mecn_local_qae(MyTask,temp){	
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();		
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
	// 清空設定相關單位會簽人員 table 
	//設定 OP 會簽群組 
	if(temp==&quot;new&quot;){
	   var sign_table =&quot;Assign_Table&quot;;	
	}else{
	   var sign_table =&quot;MemTable_Local_QAE&quot;;		
	}
	var sign_table_G =sign_table + &quot;_G&quot;;
	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();	

	  // 設定相關單位會簽人員
	  addAsignList(MyTask,v_factory,&quot;PLM_QAE&quot;,sign_table);       //QA Local			
}//function mecn_local_qae

function mecn_tech_vp(MyTask,temp){	
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();		
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
    var dep_id = dataMap.get(&quot;App_Dep_ID&quot;);	
	// 清空設定相關單位會簽人員 table 
	//設定 OP 會簽群組 
	if(temp==&quot;old&quot;){
//	   var sign_table =&quot;MemTable_Tech_VP&quot;;	
//	   var sign_table_G =sign_table + &quot;_G&quot;;
//	
//	   dataMap.get(sign_table).clear();	
//	   dataMap.get(sign_table_G).clear();		   
	   addAsignList_Tech_VP(MyTask,v_factory,dep_id,&quot;MemTable_Tech_VP&quot;);  //Tech_VP 會簽人員
	}else{
	 	var sign_table =&quot;Assign_Table&quot;;	
	    var sign_table_G =sign_table + &quot;_G&quot;;
	
	    dataMap.get(sign_table).clear();	
	    dataMap.get(sign_table_G).clear();	

	// 設定相關單位會簽人員
	addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;Tech_VP&quot;,dep_id);   //Tech_VP 會簽人員				
	}
	
}//function mecn_tech_vp

//function mecn_mfg(MyTask,temp){	
//	var artIns = MyTask.getArtInstance();
//	var dataMap = artIns.getAppDataMap();		
//    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
//    var dep_id = dataMap.get(&quot;App_Dep_ID&quot;);	
//	// 清空設定相關單位會簽人員 table 
//	//設定 OP 會簽群組 
//	if(temp==&quot;old&quot;){
//	   var sign_table =&quot;MemTable_Tech_VP&quot;;		
//	}
//	var sign_table_G =sign_table + &quot;_G&quot;;
//	
//	dataMap.get(sign_table).clear();	
//	dataMap.get(sign_table_G).clear();	
//
//	// 設定相關單位會簽人員
//	addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;Tech_VP&quot;,dep_id);   //Tech_VP 會簽人員			
//}//function mecn_mfg
//
//function mecn_mfg_m(MyTask,temp){	
//	var artIns = MyTask.getArtInstance();
//	var dataMap = artIns.getAppDataMap();		
//    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
//    var dep_id = dataMap.get(&quot;App_Dep_ID&quot;);	
//	// 清空設定相關單位會簽人員 table 
//	//設定 OP 會簽群組 
//	if(temp==&quot;old&quot;){
//	   var sign_table =&quot;MemTable_Tech_VP&quot;;		
//	}
//	var sign_table_G =sign_table + &quot;_G&quot;;
//	
//	dataMap.get(sign_table).clear();	
//	dataMap.get(sign_table_G).clear();	
//
//	// 設定相關單位會簽人員
//	addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;Tech_VP&quot;,dep_id);   //Tech_VP 會簽人員			
//}//function mecn_mfg_m

function mecn_mfc(MyTask,temp){	
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();		
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
    var dep_id = dataMap.get(&quot;App_Dep_ID&quot;);	
	// 清空設定相關單位會簽人員 table 
	//設定 OP 會簽群組 
	if(temp==&quot;old&quot;){
	   var sign_table =&quot;MemTable_FC_M&quot;;		
	}
	var sign_table_G =sign_table + &quot;_G&quot;;
	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();	

	// 設定相關單位會簽人員
	 if(v_factory !=&quot;TGCE&quot;){
	      addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;VP_MAX&quot;,&quot;&quot;);        //VP
	 }	
	      addAsign_DEP_FC_MAX(MyTask,v_factory,&quot;PLM_MFG&quot;,sign_table);                         //ME最高主管  ex:高國明 廠長 //廠務最高主管	   ex:湯智彬				
}//function mecn_mfc


function mecn_dep(MyTask,temp){
//	Server.addDebugLog(&quot;Call mecn_dep ===&gt;&gt; Start&quot;);
	var artIns = MyTask.getArtInstance();
	var dataMap = artIns.getAppDataMap();		
	var	FLOWTYPE=dataMap.get(&quot;FLOWTYPE&quot;).substring(0,2); 
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
	// 清空設定相關單位會簽人員 table 
	//設定 OP 會簽群組 
	if(temp==&quot;new&quot;){
	   var sign_table =&quot;Assign_Table&quot;;	
	   var sign_table_G =sign_table + &quot;_G&quot;; 	
	       dataMap.get(sign_table).clear();	
    	   dataMap.get(sign_table_G).clear();		   
		  var customer_id = &quot;ALL&quot;;
		  try{
		      customer_id = dataMap.get(&quot;item_no&quot;).trim().substr(0,3); 
		  }catch(e){
			  var customer_id = &quot;ALL&quot;;
		      java.lang.System.out.println(&quot;MECN_error=&quot;+e);
		  }
		  
         //目前將抓取【文件標題】包含【LCD】字眼的MECN 單		
		  if(dataMap.get(&quot;Subject&quot;).indexOf(&quot;LCD&quot;)!=&quot;-1&quot;){	
			addAsignCustomer(MyTask,&quot;SGCE&quot;,&quot;PLM_PM&quot;,sign_table,&quot;LCD&quot;);
		   }
		   
		  if(!FLOWTYPE.equals(&quot;C1&quot;)){	
	         var dep_id = dataMap.get(&quot;App_Dep_ID&quot;); 		
//			 if(dep_id == &quot;2R2&quot;){
//	         addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;MFG_M&quot;,dep_id);   //2R2特殊會簽人員 -江世豐經理
//			 }			  
		     addAsign_MECN_MFG(MyTask,v_factory,&quot;MFG_AddAs_Table&quot;,sign_table)    //MFG主管	    
		   }

//		  	  addAsignList(MyTask,v_factory,&quot;PLM_QC&quot;,sign_table);                                 //QC  單位主管		 
		  var process_type = MyTask.artInstance.name;
		  if( process_type.indexOf(&quot;MECN申請單&quot;)&gt;=0 ){	
			  
		    if(FLOWTYPE.equals(&quot;B類&quot;)){
		       addAsignList(MyTask,v_factory,&quot;PLM_QA_SC&quot;,sign_table);       //QAE 單位主管
			   if(v_factory==&quot;TGCE&quot;){
				   addAsignList(MyTask,v_factory,&quot;PLM_QA_SC_A&quot;,sign_table);       //(鄭志雯)爲了避免跟邱玉婷同群組,故獨立出來 add by edison@20120601
			   }
//			   if(v_factory==&quot;SGCE&quot;){
//				   addAsignList(MyTask,v_factory,&quot;PLM_QA_SC_S&quot;,sign_table);       //S廠朱昌輝也要簽 add by edison@20120903
//			   }
			   if(v_factory == &quot;TGCE&quot;){
				   if(customer_id==&quot;910&quot; &amp;&amp; dataMap.get(&quot;item_no&quot;).trim().substr(5,1)!=&quot;9&quot;){ //add by edison@20120629 910__9xxx才給陳宗元簽				
				   }else{
					   addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//PM
				   }				
			   }
			
//				if(v_factory == &quot;SGCE&quot; &amp;&amp; customer_id==&quot;222&quot;){
//					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//add by edison@20120629 sgce&amp;222 才給陳呂龍簽,其餘蘇州廠不簽
//				}
				if(v_factory == &quot;CGCE&quot; || v_factory == &quot;HGCE&quot; || v_factory == &quot;SGCE&quot;){
					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);
				}
		       //addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,sign_table,customer_id);	 //PM by Account	
		       addAsignCustomer(MyTask,v_factory,&quot;PLM_CS&quot;,sign_table,customer_id);     //CS by Account				
			   
		    }else if(FLOWTYPE.equals(&quot;C2&quot;)){
		       addAsignList(MyTask,v_factory,&quot;PLM_QA_SC&quot;,sign_table);       //QAE 單位主管
			   if(v_factory==&quot;TGCE&quot;){
				   addAsignList(MyTask,v_factory,&quot;PLM_QA_SC_A&quot;,sign_table);       //(鄭志雯)爲了避免跟邱玉婷同群組,故獨立出來 add by edison@20120601
			   }
//			   if(v_factory==&quot;SGCE&quot;){
//				   addAsignList(MyTask,v_factory,&quot;PLM_QA_SC_S&quot;,sign_table);       //S廠朱昌輝也要簽 add by edison@20120903
//			   } 		   				
			}	
			//Local QAE 若填寫&quot;不符合客規&quot;, 則流程需簽到PM與QA最高主管 
	        if(dataMap.get(&quot;FRadioButton_w33&quot;)== &quot;true&quot;){
		       //addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,sign_table,customer_id);	 //PM by Account
			   if(v_factory == &quot;TGCE&quot;){
				   if(customer_id==&quot;910&quot; &amp;&amp; dataMap.get(&quot;item_no&quot;).trim().substr(5,1)!=&quot;9&quot;){ //add by edison@20120629 910__9xxx才給陳宗元簽				
				   }else{
					   addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//PM
				   }				
			   }
			
//				if(v_factory == &quot;SGCE&quot; &amp;&amp; customer_id==&quot;222&quot;){
//					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//add by edison@20120629 sgce&amp;222 才給陳呂龍簽,其餘蘇州廠不簽
//				}
				if(v_factory == &quot;CGCE&quot; || v_factory == &quot;HGCE&quot; || v_factory == &quot;SGCE&quot;){
					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);
				}
            }	
			
	      }else{
		     addAsignList(MyTask,v_factory,&quot;PLM_QA_SC&quot;,sign_table);       //QAE 單位主管 	
			 if(v_factory==&quot;TGCE&quot;){
				   addAsignList(MyTask,v_factory,&quot;PLM_QA_SC_A&quot;,sign_table);       //(鄭志雯)爲了避免跟邱玉婷同群組,故獨立出來 add by edison@20120601
			 }
//			 if(v_factory==&quot;SGCE&quot;){
//				   addAsignList(MyTask,v_factory,&quot;PLM_QA_SC_S&quot;,sign_table);       //S廠朱昌輝也要簽 add by edison@20120903
//			 }  
		     //addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,sign_table,customer_id);	 //PM by Account	
			 if(v_factory == &quot;TGCE&quot;){
				   if(customer_id==&quot;910&quot; &amp;&amp; dataMap.get(&quot;item_no&quot;).trim().substr(5,1)!=&quot;9&quot;){ //add by edison@20120629 910__9xxx才給陳宗元簽				
				   }else{
					   addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//PM
				   }				
			   }
			
//				if(v_factory == &quot;SGCE&quot; &amp;&amp; customer_id==&quot;222&quot;){
//					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//add by edison@20120629 sgce&amp;222 才給陳呂龍簽,其餘蘇州廠不簽
//				}
				if(v_factory == &quot;CGCE&quot; || v_factory == &quot;HGCE&quot; || v_factory == &quot;SGCE&quot;){
					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);
				}
		     addAsignCustomer(MyTask,v_factory,&quot;PLM_CS&quot;,sign_table,customer_id);     //CS by Account			 
		  }
		  if( process_type.indexOf(&quot;MECN申請單 V6&quot;)&gt;=0 ){
			 
			  //當勾選【量產物料-單次】、【量產物料-永久】，會簽至 IE / 採購 /物管  
			  //v9版 當勾選【直接物料】、【間接物料】，會簽至 IE / 採購 /物管  
			  if( dataMap.get(&quot;ab_1&quot;) == &quot;true&quot; || dataMap.get(&quot;ab_2&quot;) == &quot;true&quot;){
				  addAsignList(MyTask,v_factory,&quot;PLM_Purchasing_M&quot;,sign_table);   //Purchasing Department經理(all)
				  addAsignList(MyTask,v_factory,&quot;PLM_IE_M&quot;,sign_table);           //IE M經理(all)
				  addAsignList(MyTask,v_factory,&quot;PLM_MA_M&quot;,sign_table);            //物管
			  } 
		  
		  
		    //當勾選【UL(製程溫度&gt;100度)】，會簽至材料 
			if( dataMap.get(&quot;ab_11&quot;) == &quot;true&quot;){
				addAsignList(MyTask,&quot;TGCE&quot;,&quot;PLM_MT_E&quot;,sign_table);            //材料
			}
		  
		    //當勾選 四、在製品處理方式 - 【需要清線不可跟前板混用】
		    if(dataMap.get(&quot;FRadioButton_w44&quot;) == &quot;true&quot;){
				addAsignList(MyTask,v_factory,&quot;PLM_PC_M&quot;,sign_table);   //生管
				dataMap.put(&quot;PC_Flag&quot;,&quot;Y&quot;);	 //生管會簽Flag
			}	
		  }else{
			  
			   //當勾選【量產物料-單次】、【量產物料-永久】，會簽至 IE / 採購 /物管  
			   if( dataMap.get(&quot;FCheckBox_a4_1&quot;) == &quot;true&quot; || dataMap.get(&quot;FCheckBox_a4_2&quot;) == &quot;true&quot; || dataMap.get(&quot;FCheckBox_b1_1&quot;) == &quot;true&quot;|| dataMap.get(&quot;FCheckBox_b1_2&quot;) == &quot;true&quot;|| dataMap.get(&quot;FCheckBox_c26&quot;) == &quot;true&quot; ){
				   addAsignList(MyTask,v_factory,&quot;PLM_Purchasing_M&quot;,sign_table);   //Purchasing Department經理(all)
				   addAsignList(MyTask,v_factory,&quot;PLM_IE_M&quot;,sign_table);           //IE M經理(all)
				   addAsignList(MyTask,v_factory,&quot;PLM_MA_M&quot;,sign_table);            //物管
			   } 
		  
		  
		     //當勾選【UL(製程溫度&gt;100度)】，會簽至材料 
			 if( dataMap.get(&quot;FCheckBox_a11&quot;) == &quot;true&quot; || dataMap.get(&quot;FCheckBox_b2&quot;) == &quot;true&quot; || dataMap.get(&quot;FCheckBox_c27&quot;) == &quot;true&quot;  ){
				 addAsignList(MyTask,&quot;TGCE&quot;,&quot;PLM_MT_E&quot;,sign_table);            //材料
			 }
		  
		  //當勾選 四、在製品處理方式 - 【需要清線不可跟前板混用】
		     if(dataMap.get(&quot;FRadioButton_w44&quot;) == &quot;true&quot;){
				 addAsignList(MyTask,v_factory,&quot;PLM_PC_M&quot;,sign_table);   //生管
				 dataMap.put(&quot;PC_Flag&quot;,&quot;Y&quot;);	 //生管會簽Flag
			 }	 
		   }
		    
		  
	}else{	
	  var process_type = MyTask.artInstance.name;	
	   var sign_table =&quot;MemTable_DP_Sign&quot;;	
	   var sign_table_G =sign_table + &quot;_G&quot;; 	
	       dataMap.get(sign_table).clear();	
    	   dataMap.get(sign_table_G).clear();	
		
      var customer_id = &quot;ALL&quot;;
		try{
		    customer_id = dataMap.get(&quot;item_no&quot;).substr(0,3); 
		  }catch(e){
			  var customer_id = &quot;ALL&quot;;
		      java.lang.System.out.println(&quot;MECN_error=&quot;+e);
		  }
		  
         //目前將抓取【文件標題】包含【LCD】字眼的MECN 單		
		  if(dataMap.get(&quot;Subject&quot;).indexOf(&quot;LCD&quot;)!=&quot;-1&quot;){	
			addAsignCustomer(MyTask,&quot;SGCE&quot;,&quot;PLM_PM&quot;,sign_table,&quot;LCD&quot;);
		   }
		   
	          addAsignList(MyTask,v_factory,&quot;PLM_QC&quot;,sign_table);                                 //QC  單位主管		
		   
		  if( process_type.indexOf(&quot;MECN申請單&quot;)&gt;=0 ){				  
		    if(FLOWTYPE.equals(&quot;B類&quot;) ){
		       addAsignList(MyTask,v_factory,&quot;PLM_QA_SC&quot;,sign_table);       //QAE 單位主管 				
		       addAsignCustomer(MyTask,v_factory,&quot;PLM_CS&quot;,sign_table,customer_id);   //CS by Account
			   //addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,sign_table,customer_id);	 //PM by Account
				if(v_factory == &quot;TGCE&quot;){
				   if(customer_id==&quot;910&quot; &amp;&amp; dataMap.get(&quot;item_no&quot;).trim().substr(5,1)!=&quot;9&quot;){ //add by edison@20120629 910__9xxx才給陳宗元簽				
				   }else{
					   addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//PM
				   }				
			   }
			
//				if(v_factory == &quot;SGCE&quot; &amp;&amp; customer_id==&quot;222&quot;){
//					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//add by edison@20120629 sgce&amp;222 才給陳呂龍簽,其餘蘇州廠不簽
//				}
				if(v_factory == &quot;CGCE&quot; || v_factory == &quot;HGCE&quot; || v_factory == &quot;SGCE&quot;){
					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);
				}				   
		    }else if(FLOWTYPE.equals(&quot;C2&quot;)){
		       addAsignList(MyTask,v_factory,&quot;PLM_QA_SC&quot;,sign_table);       //QAE 單位主管 				
			}	
				
			//Local QAE 若填寫&quot;不符合客規&quot;, 則流程需簽到PM與QA最高主管 
	        if(dataMap.get(&quot;FRadioButton_w33&quot;)== &quot;true&quot;){
			   //addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,sign_table,customer_id);	 //PM by Account
			   if(v_factory == &quot;TGCE&quot;){
				   if(customer_id==&quot;910&quot; &amp;&amp; dataMap.get(&quot;item_no&quot;).trim().substr(5,1)!=&quot;9&quot;){ //add by edison@20120629 910__9xxx才給陳宗元簽				
				   }else{
					   addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//PM
				   }				
			   }
			
//				if(v_factory == &quot;SGCE&quot; &amp;&amp; customer_id==&quot;222&quot;){
//					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//add by edison@20120629 sgce&amp;222 才給陳呂龍簽,其餘蘇州廠不簽
//				}
				if(v_factory == &quot;CGCE&quot; || v_factory == &quot;HGCE&quot; || v_factory == &quot;SGCE&quot;){
					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);
				}
            }	
		  }else{
		       addAsignList(MyTask,v_factory,&quot;PLM_QA_SC&quot;,sign_table);       //QAE 單位主管 				 
		       addAsignCustomer(MyTask,v_factory,&quot;PLM_CS&quot;,sign_table,customer_id);   //CS by Account	
      	       //addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,sign_table,customer_id);	 //PM by Account	
				if(v_factory == &quot;TGCE&quot;){
				   if(customer_id==&quot;910&quot; &amp;&amp; dataMap.get(&quot;item_no&quot;).trim().substr(5,1)!=&quot;9&quot;){ //add by edison@20120629 910__9xxx才給陳宗元簽				
				   }else{
					   addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//PM
				   }				
			   }
			
//				if(v_factory == &quot;SGCE&quot; &amp;&amp; customer_id==&quot;222&quot;){
//					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);//add by edison@20120629 sgce&amp;222 才給陳呂龍簽,其餘蘇州廠不簽
//				}
				if(v_factory == &quot;CGCE&quot; || v_factory == &quot;HGCE&quot; || v_factory == &quot;SGCE&quot;){
					addAsignCustomer(MyTask,v_factory,&quot;PLM_PM&quot;,&quot;Assign_Table&quot;,customer_id);
				}			   	
		  }

		  if( process_type.indexOf(&quot;MECN申請單 V6&quot;)&gt;=0 ){
			  //當勾選【量產物料-單次】、【量產物料-永久】，會簽至 IE / 採購 /物管  
			  //v9版 當勾選【直接物料】、【間接物料】，會簽至 IE / 採購 /物管  
			  if( dataMap.get(&quot;ab_1&quot;) == &quot;true&quot; || dataMap.get(&quot;ab_2&quot;) == &quot;true&quot;){
				  addAsignList(MyTask,v_factory,&quot;PLM_Purchasing_M&quot;,sign_table);   //Purchasing Department經理(all)
				  addAsignList(MyTask,v_factory,&quot;PLM_IE_M&quot;,sign_table);           //IE M經理(all)
				  addAsignList(MyTask,v_factory,&quot;PLM_MA_M&quot;,sign_table);            //物管
			  } 
		  
		  
		    //當勾選【UL(製程溫度&gt;100度)】，會簽至材料 
			if( dataMap.get(&quot;ab_11&quot;) == &quot;true&quot;){
				addAsignList(MyTask,&quot;TGCE&quot;,&quot;PLM_MT_E&quot;,sign_table);            //材料
			}
		  
		    //當勾選 四、在製品處理方式 - 【需要清線不可跟前板混用】
		    if(dataMap.get(&quot;FRadioButton_w44&quot;) == &quot;true&quot;){
				addAsignList(MyTask,v_factory,&quot;PLM_PC_M&quot;,sign_table);   //生管
				dataMap.put(&quot;PC_Flag&quot;,&quot;Y&quot;);	 //生管會簽Flag
			}	
		  }else{
			   //當勾選【量產物料-單次】、【量產物料-永久】，會簽至 IE / 採購 /物管  
			   if( dataMap.get(&quot;FCheckBox_a4_1&quot;) == &quot;true&quot; || dataMap.get(&quot;FCheckBox_a4_2&quot;) == &quot;true&quot; || dataMap.get(&quot;FCheckBox_b1_1&quot;) == &quot;true&quot;|| dataMap.get(&quot;FCheckBox_b1_2&quot;) == &quot;true&quot;|| dataMap.get(&quot;FCheckBox_c26&quot;) == &quot;true&quot; ){
				   addAsignList(MyTask,v_factory,&quot;PLM_Purchasing_M&quot;,sign_table);   //Purchasing Department經理(all)
				   addAsignList(MyTask,v_factory,&quot;PLM_IE_M&quot;,sign_table);           //IE M經理(all)
				   addAsignList(MyTask,v_factory,&quot;PLM_MA_M&quot;,sign_table);            //物管
			   } 
		  
		  
		     //當勾選【UL(製程溫度&gt;100度)】，會簽至材料 
			 if( dataMap.get(&quot;FCheckBox_a11&quot;) == &quot;true&quot; || dataMap.get(&quot;FCheckBox_b2&quot;) == &quot;true&quot; || dataMap.get(&quot;FCheckBox_c27&quot;) == &quot;true&quot;  ){
				 addAsignList(MyTask,&quot;TGCE&quot;,&quot;PLM_MT_E&quot;,sign_table);            //材料
			 }
		  
		  //當勾選 四、在製品處理方式 - 【需要清線不可跟前板混用】
		     if(dataMap.get(&quot;FRadioButton_w44&quot;) == &quot;true&quot;){
				 addAsignList(MyTask,v_factory,&quot;PLM_PC_M&quot;,sign_table);   //生管
				 dataMap.put(&quot;PC_Flag&quot;,&quot;Y&quot;);	 //生管會簽Flag
			 }	 
		   }
	}		
//	Server.addDebugLog(&quot;CAll mecn_dep ===&gt;&gt; End&quot;);
}//function mecn_dep()


function mecn_dep_m(MyTask,temp){
//  Server.addDebugLog(&quot;CAll mecn_dep_m ===&gt;&gt; Start&quot;);
  var artIns = MyTask.getArtInstance(); 
  var dataMap = artIns.getAppDataMap();	
  var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);  
  var FLOWTYPE = dataMap.get(&quot;FLOWTYPE&quot;).substring(0,2);  
	// 清空設定相關單位會簽人員 table 

	if(temp==&quot;new&quot;){
	   var sign_table =&quot;Assign_Table&quot;;	
	   var sign_table_G =sign_table + &quot;_G&quot;;	   
	   dataMap.get(sign_table).clear();	
	   dataMap.get(sign_table_G).clear();	
	   
	   // 設定相關單位會簽人員
       var dep_id = dataMap.get(&quot;App_Dep_ID&quot;);
       var app_dep= dataMap.get(&quot;App_Dep&quot;);		
	   if(FLOWTYPE.equals(&quot;C2&quot;) ){
	      addAsignList(MyTask,v_factory,&quot;PLM_QC&quot;,sign_table);                                 //QC  單位主管	
		  if(v_factory ==&quot;TGCE&quot;){
			  addAsignList(MyTask,v_factory,&quot;PLM_QC_1&quot;,sign_table);//add by edison@20120831
		  }
	   }else{
   	     if((dep_id.indexOf(&quot;2J&quot;)&gt;=0 &amp;&amp; app_dep.indexOf(&quot;HDI&quot;)&gt;=0)||(dep_id.indexOf(&quot;2R&quot;)&gt;=0 &amp;&amp; app_dep.indexOf(&quot;HDI&quot;)&gt;=0)){
		   addAsignList(MyTask,&quot;HGCE&quot;,&quot;PLM_OP&quot;,&quot;Mail_Group&quot;);     //2J0:HDI工程技術處” 開出來的MECN ，DE OP 執行的同時，需發MAIL 通知 HGCE DE群組(5901DE工程問題).      
	     }
         if(v_factory !=&quot;TGCE&quot;){
	      addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;VP_MAX&quot;,&quot;&quot;);        //VP
	     }	
	     if(v_factory ==&quot;TGCE&quot;){
   	      addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;PE_MAX&quot;,&quot;&quot;);        //各工程單位最高主管
		  addAsignList(MyTask,v_factory,&quot;PLM_QC_1&quot;,sign_table);//add by edison@20120831
	     }	  
	      addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;Tech_VP&quot;,dep_id);   //Tech_VP 會簽人員	
	      addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;DE_TOP&quot;,&quot;&quot;);        //DE_協理
	      addAsign_DEP_FC_MAX(MyTask,v_factory,&quot;PLM_MFG&quot;,sign_table);                         //ME最高主管  ex:高國明 廠長 //廠務最高主管	   ex:湯智彬		
	      //addAsignList(MyTask,v_factory,&quot;PLM_QC&quot;,sign_table);                                 //QC  單位主管		   
	   }
	}else{
	
	}
//	Server.addDebugLog(&quot;CAll mecn_dep_m ===&gt;&gt; End&quot;);		
}//function mecn_dep_m(MyTask)


function mecn_de_m(MyTask,temp){
//	Server.addDebugLog(&quot;CAll mecn_de_m ===&gt;&gt; Start&quot;);
  var aInstance = MyTask.getArtInstance(); 
  var dataMap = aInstance.getAppDataMap();	 
  var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);  
  var FLOWTYPE = dataMap.get(&quot;FLOWTYPE&quot;).substr(0,2);  
	// 清空設定相關單位會簽人員 table 
	if(temp==&quot;new&quot;){
	   var sign_table =&quot;Assign_Table&quot;;	
	}else{
	   var sign_table =&quot;MemTable_DE_M&quot;;		
	   
	}
	var sign_table_G =sign_table + &quot;_G&quot;;
	   	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();	
	 
	// 設定相關單位會簽人員
	if(FLOWTYPE.equals(&quot;A類&quot;) ||FLOWTYPE.equals(&quot;B類&quot;)){
	    addAsignList(MyTask,v_factory,&quot;PLM_OPM_A_TYPE&quot;,sign_table);  //DE  單位主管 - DE審核、作廢會簽
	}else{
		addAsignList(MyTask,v_factory,&quot;PLM_OPM&quot;,sign_table);         //DE  單位主管 - DE審核、作廢會簽
	}
	
	dataMap.get(&quot;MemTable_DE&quot;).clear();	
	if(temp==&quot;old&quot;){
	dataMap.get(&quot;MemTable_DE_G&quot;).clear();	
	}
	addAsignList(MyTask,v_factory,&quot;PLM_OP&quot;,&quot;MemTable_DE&quot;);         //DE執行 
	
//	Server.addDebugLog(&quot;CAll mecn_de_m ===&gt;&gt; End&quot;);
}//function mecn_de_m


function mecn_qa_m(MyTask,temp){
//	Server.addDebugLog(&quot;CAll mecn_qa_m ===&gt;&gt; Start&quot;);
   var aInstance = MyTask.getArtInstance(); 
   var dataMap = aInstance.getAppDataMap();
   var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
	// 清空設定相關單位會簽人員 table 
	if(temp==&quot;new&quot;){
	   var sign_table =&quot;Assign_Table&quot;;	
	}else{
	   var sign_table =&quot;MemTable_QA_M&quot;;		
	}
	var sign_table_G =sign_table + &quot;_G&quot;;
	   	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();			 
	// 設定相關單位會簽人員
	var process_type = MyTask.getRootName();
	if( process_type.indexOf(&quot;V8&quot;)&gt;=0 ){
		addAsignList(MyTask,v_factory,&quot;PLM_QA_M_V8&quot;,sign_table);           //QA M經理(V8)
	}else{
		addAsignList(MyTask,v_factory,&quot;PLM_QA_M&quot;,sign_table);           //QA M經理(all)
	}    
//	//add by edison_wang@20110914
//	if(v_factory!=&quot;TGCE&quot;){
//		addAsignList(MyTask,v_factory,&quot;PLM_QA_M_A&quot;,sign_table);   //QA 副處廖智源(TGCE除外)
//	}
//  	Server.addDebugLog(&quot;CAll mecn_qa_m ===&gt;&gt; End&quot;);
}// function mecn_qa_m

function mecn_qa_d(MyTask,temp){ //QA 處級主管
//	Server.addDebugLog(&quot;CAll mecn_qa_d ===&gt;&gt; Start&quot;);
   var aInstance = MyTask.getArtInstance(); 
   var dataMap = aInstance.getAppDataMap();
   var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 
	// 清空設定相關單位會簽人員 table 
	if(temp==&quot;new&quot;){
	   var sign_table =&quot;Assign_Table&quot;;	
	}else{
	   var sign_table =&quot;MemTable_QA_M&quot;;		
	}
	var sign_table_G =sign_table + &quot;_G&quot;;
	   	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();			 
	// 設定相關單位會簽人員
	addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;QA_DEP&quot;,&quot;&quot;);           //QA 處級主管    

//  	Server.addDebugLog(&quot;CAll mecn_qa_d ===&gt;&gt; End&quot;);
}// function mecn_qa_m

function mecn_qa_top(MyTask,temp){
//	Server.addDebugLog(&quot;CAll mecn_qa_top ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);   

	// 清空設定相關單位會簽人員 table 
	if(temp==&quot;new&quot;){
	   var sign_table =&quot;Assign_Table&quot;;	
	}else{
	   var sign_table =&quot;MemTable_QA_M&quot;;		
	}
	var sign_table_G =sign_table + &quot;_G&quot;;
	   	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();			 
	// 設定相關單位會簽人員
	  addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;QA_TOP&quot;,&quot;&quot;);          //QA_協理	
//	Server.addDebugLog(&quot;CAll mecn_qa_top ===&gt;&gt; End&quot;);	  
}//  function mecn_qa_top

function mecn_mr_top(MyTask,temp){	
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);   

	// 清空設定相關單位會簽人員 table 
	if(temp==&quot;new&quot;){
	   var sign_table =&quot;Assign_Table&quot;;	
	}else{
	   var sign_table =&quot;MemTable_QA_M&quot;;		
	}
	var sign_table_G =sign_table + &quot;_G&quot;;
	   	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();			 
	// 設定相關單位會簽人員
	  addAsignList_VP(MyTask,v_factory,&quot;PLM_MECN_Process&quot;,sign_table,&quot;MR_TOP&quot;,&quot;&quot;);          	
	
}

function mecn_de(MyTask,temp){
//	Server.addDebugLog(&quot;CAll mecn_de ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);  
	// 清空設定相關單位會簽人員 table 
	if(temp==&quot;new&quot;){
	   var sign_table =&quot;Assign_Table&quot;;	
	       dataMap.get(sign_table).clear();	
	       dataMap.get(sign_table+&quot;_G&quot;).clear();			 	   
	}else{
	   var sign_table =&quot;MemTable_DE&quot;;		
	}
	var sign_table_G =sign_table + &quot;_G&quot;;
	// 設定相關單位會簽人員	
	 if(dataMap.get(&quot;MemTable_DE&quot;).size()&lt;=0 ){
	  addAsignList(MyTask,v_factory,&quot;PLM_OP&quot;,&quot;MemTable_DE&quot;);         //DE執行 會簽人員		   
     }
     addAsign_MECN_TEMP(MyTask,v_factory,&quot;MemTable_DE&quot;,sign_table)    //DE執行 會簽人員		 
//	Server.addDebugLog(&quot;CAll mecn_de ===&gt;&gt; End&quot;);	 
}//function mecn_de

function mecn_qc_lock(MyTask,temp){
//	Server.addDebugLog(&quot;CAll mecn_qc_lock ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap()	
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);  

	// 清空設定相關單位會簽人員 table 
	if(temp==&quot;new&quot;){
	   var sign_table =&quot;Assign_Table&quot;;	
	}else{
	   var sign_table =&quot;MemTable_QC&quot;;		
	}
	var sign_table_G =sign_table + &quot;_G&quot;;
	   	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table_G).clear();		
		 
	// 設定相關單位會簽人員
	if(temp==&quot;new&quot;){	
     addAsign_MECN_TEMP(MyTask,v_factory,&quot;Measure_Table&quot;,sign_table)    //QA 會簽人員	
	}else{
	 addAsignList(MyTask,v_factory,&quot;PLM_QC_Lock&quot;,sign_table);           //QA 會簽人員			
	} 
//	Server.addDebugLog(&quot;CAll mecn_qc_lock ===&gt;&gt; End&quot;);	 
}//function mecn_qc_lock

//抓提出單位最高主管
function dp_manager(MyTask,temp,level){
//	Server.addDebugLog(&quot;CAll dp_manager ===&gt;&gt; Start&quot;);
	 var aInstance = MyTask.getArtInstance();
	 var dataMap = aInstance.getAppDataMap()		
	 var dep_id = dataMap.get(&quot;App_Dep_ID&quot;);
	 var app_memid = dataMap.get(&quot;App_MemID&quot;);
     var v_memid =&quot;&quot;;	 
	 try{
		//Select 部門單位主管 SQL	 
		var SQL_a  = &quot;SELECT distinct(e.MEMID) as empcode, e.USERNAME,e.JOBTITLE,e.PAGER,substr(e.MAINROLEID,8,3)ROLEID &quot;;
            SQL_a += &quot;from mem_geninf e &quot;;
            SQL_a += &quot;where e.memid =&apos;&quot;+app_memid+&quot;&apos;&quot;;
 	     var vec = Server.SQLloadValue(SQL_a);
         if (vec.size()&gt;0){
			var memid = vec.get(0).get(&quot;empcode&quot;);
			var managerid = vec.get(0).get(&quot;PAGER&quot;);
			var roleid = java.lang.Integer.parseInt(vec.get(0).get(&quot;ROLEID&quot;));
			
            if (roleid &lt; temp){
                 v_memid = check_roleid(managerid,temp);
			}else{
				 v_memid = memid;
			}
		 }
	 }catch(e){	  
	 }
//	Server.addDebugLog(&quot;CAll dp_manager ===&gt;&gt; End&quot;);	 
	 return v_memid ;
 }//function dp_manager()
 
//Select 部門單位主管的上一層主管 SQL	 
function check_roleid(managerid,temp){ 
//	Server.addDebugLog(&quot;CAll  check_roleid ===&gt;&gt; Start&quot;);
	var SQL_b  = &quot;SELECT distinct(e.MEMID) as empcode, e.USERNAME,e.JOBTITLE,e.PAGER,substr(e.MAINROLEID,8,3)ROLEID &quot;;
        SQL_b += &quot;from  mem_geninf e  &quot;;
        SQL_b += &quot;where e.memid =&apos;&quot;+managerid+&quot;&apos; &quot;;
        SQL_b += &quot;and e.DENIEDLOGIN = &apos;false&apos; &quot;;
	var vec1 = Server.SQLloadValue(SQL_b);
	
	if (vec1.size()&gt;0){
  	    var memid = vec1.get(0).get(&quot;empcode&quot;);
		var managerid = vec1.get(0).get(&quot;PAGER&quot;);
	    var roleid = java.lang.Integer.parseInt(vec1.get(0).get(&quot;ROLEID&quot;));
		
		if (roleid &lt; temp){
            v_memid = check_roleid(managerid,temp);
		}else{
            v_memid = memid;
		}
	}//if (vec1.size()&gt;0)
//	Server.addDebugLog(&quot;CAll  check_roleid ===&gt;&gt; End&quot;);
	 return v_memid ;	
}//function check_roleid() 

//判斷是否為9大項，需會簽至它廠的MECN類別
function check_type(){
	var artIns = MyTask.getArtInstance(); 
    var dataMap = artIns.getAppDataMap();
	var	FLOWTYPE=dataMap.get(&quot;FLOWTYPE&quot;).substring(0,2); 
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4); 	

	if(FLOWTYPE.indexOf(&quot;A&quot;)&gt;=0){
	   if(dataMap.get(&quot;FCheckBox_a0&quot;)==&quot;true&quot; || dataMap.get(&quot;FCheckBox_a6&quot;)==&quot;true&quot; ||dataMap.get(&quot;FCheckBox_a3&quot;)==&quot;true&quot; ||	dataMap.get(&quot;FCheckBox_a21&quot;)==&quot;true&quot; || dataMap.get(&quot;FCheckBox_a22&quot;)==&quot;true&quot; ||dataMap.get(&quot;FCheckBox_a23&quot;)==&quot;true&quot; ||dataMap.get(&quot;FCheckBox_a24&quot;)==&quot;true&quot; || dataMap.get(&quot;FCheckBox_a13&quot;)==&quot;true&quot; ||dataMap.get(&quot;FCheckBox_a25&quot;)==&quot;true&quot; ){
	       return true;
	   }else{
  	       return false;
	   }
	}else{
	   if(dataMap.get(&quot;FCheckBox_b4&quot;)==&quot;true&quot; || dataMap.get(&quot;FCheckBox_b5&quot;)==&quot;true&quot; ||dataMap.get(&quot;FCheckBox_b6&quot;)==&quot;true&quot; || dataMap.get(&quot;FCheckBox_b7&quot;)==&quot;true&quot; || dataMap.get(&quot;FCheckBox_b8&quot;)==&quot;true&quot; ||dataMap.get(&quot;FCheckBox_b9&quot;)==&quot;true&quot; || dataMap.get(&quot;FCheckBox_b10&quot;)==&quot;true&quot; || dataMap.get(&quot;FCheckBox_b11&quot;)==&quot;true&quot; ||dataMap.get(&quot;FCheckBox_b12&quot;)==&quot;true&quot; ){
	       return true;
	   }else{
  	       return false;
	   }
	}	   	
}//function check_type()

//抓它廠主管會簽人員
function another_factory_addAsignList(MyTask,companyID,PARAMETER,Sign_MemberTable,s1){
//	Server.addDebugLog(&quot;CAll another_factory_addAsignList ===&gt;&gt; Start&quot;);
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	if(s1==&quot;ALL&quot;){
		var SQL = &quot;select value2 as memid from a_parameter_data where parameter=&apos;&quot;+PARAMETER+&quot;&apos; and key1 not in (&apos;&quot;+companyID+&quot;&apos;)&quot;;
	}else{
		var count = 0;
		var temp = &quot;&quot;;
		if(dataMap.get(&quot;tgce&quot;).equals(&quot;true&quot;)){
			if(count==0){
				temp = &quot;&apos;TGCE&apos;&quot;;
			}else{
				temp +=&quot;,&apos;TGCE&apos;&quot;
			}
			count++;
		}
		if(dataMap.get(&quot;sgce&quot;).equals(&quot;true&quot;)){
			if(count==0){
				temp = &quot;&apos;SGCE&apos;&quot;;
			}else{
				temp +=&quot;,&apos;SGCE&apos;&quot;
			}
			count++;
		}
		if(dataMap.get(&quot;cgce&quot;).equals(&quot;true&quot;)){
			if(count==0){
				temp = &quot;&apos;CGCE&apos;&quot;;
			}else{
				temp +=&quot;,&apos;CGCE&apos;&quot;
			}
			count++;
		}
		if(dataMap.get(&quot;hgce&quot;).equals(&quot;true&quot;)){
			if(count==0){
				temp = &quot;&apos;HGCE&apos;&quot;;
			}else{
				temp +=&quot;,&apos;HGCE&apos;&quot;
			}
			count++;
		}
		var SQL =&quot;select value2 as memid from a_parameter_data where parameter=&apos;&quot;+PARAMETER+&quot;&apos; and key1 in (&quot;+temp+&quot;)&quot;;
		
	}

	  try{
	  	var vec = Server.SQLloadValue(SQL);			
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var cmemid = ht.get(&quot;memid&quot;)
			      var cMember = Server.getMemberByID(cmemid);			  	  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  
				  var Dauble_flag = memisDauble(SignTable,cmemid) ;
				  var groupid = companyID+cmemid;		
				if(Dauble_flag != &quot;Y&quot;){
				   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, groupid);				    
					      SignTable.add(row,hm);
				   var new_record =&quot;Y&quot; ;
				}

			//寫入會簽群組Table，子流程使用
		    if (SignTable_G != null){			
			  if (new_record == &quot;Y&quot;){
				var Dauble_flag_G = memisDauble(SignTable_G,groupid) ;
			     if(Dauble_flag_G != &quot;Y&quot;){
					var hm1 = new java.util.HashMap();
                    var row1 = SignTable_G.size();//SignTable裡資料筆數		
						hm1.put(&quot;ITEM1&quot;, groupid);	
						SignTable_G.add(row1,hm1);
		        }
			  }	
		    }	
		 }//for	
	
		}else{
			Server.addInfoLog(PARAMETER+&quot;沒有設定會簽人員!&quot;);
		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignList !!!\n&quot;+SQL+memid);
	}
//	Server.addDebugLog(&quot;CAll another_factory_addAsignList ===&gt;&gt; End&quot;);
}//function another_factory_addAsignList

//mecn核准單 抓取它廠設工 add by edison@20111117
function mecn_de_another(MyTask,temp){
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
    var v_factory = dataMap.get(&quot;Factory&quot;).substr(1,4);
	if(temp==&quot;new&quot;){
	   var sign_table =&quot;Assign_Table&quot;;		   			 	   
	}else{
	   var sign_table =&quot;MemTable_DE&quot;;		
	}
	
	dataMap.get(sign_table).clear();	
	dataMap.get(sign_table+&quot;_G&quot;).clear();
	//會簽本廠以外的他廠設工
	if(v_factory==&quot;TGCE&quot;){
		addAsignList(MyTask,&quot;SGCE&quot;,&quot;PLM_OP&quot;,sign_table);
		addAsignList(MyTask,&quot;HGCE&quot;,&quot;PLM_OP&quot;,sign_table);
		addAsignList(MyTask,&quot;CGCE&quot;,&quot;PLM_OP&quot;,sign_table);
	}else if(v_factory==&quot;SGCE&quot;){
		addAsignList(MyTask,&quot;TGCE&quot;,&quot;PLM_OP&quot;,sign_table);
		addAsignList(MyTask,&quot;HGCE&quot;,&quot;PLM_OP&quot;,sign_table);
		addAsignList(MyTask,&quot;CGCE&quot;,&quot;PLM_OP&quot;,sign_table);
	}else if(v_factory==&quot;CGCE&quot;){
		addAsignList(MyTask,&quot;SGCE&quot;,&quot;PLM_OP&quot;,sign_table);
		addAsignList(MyTask,&quot;HGCE&quot;,&quot;PLM_OP&quot;,sign_table);
		addAsignList(MyTask,&quot;TGCE&quot;,&quot;PLM_OP&quot;,sign_table);
    }else if(v_factory==&quot;HGCE&quot;){
		addAsignList(MyTask,&quot;SGCE&quot;,&quot;PLM_OP&quot;,sign_table);
		addAsignList(MyTask,&quot;TGCE&quot;,&quot;PLM_OP&quot;,sign_table);
		addAsignList(MyTask,&quot;CGCE&quot;,&quot;PLM_OP&quot;,sign_table);
	}
}

function addAsignList_v1(MyTask,companyID,PARAMETER,Sign_MemberTable,temp1){
	
	var aInstance = MyTask.getArtInstance();
	var dataMap = aInstance.getAppDataMap();	
	var SignTable = dataMap.get(Sign_MemberTable);
	var SignTable_G = dataMap.get(Sign_MemberTable + &quot;_G&quot;);
	
	var SQL =  &quot; select B.VALUE2 memid ,B.VALUE1 username ,C.RESIGN &quot;;
	    SQL += &quot; from A_PARAMETER_ITEM A, A_PARAMETER_DATA B, MEM_GENINF C&quot;;
		SQL += &quot; where A.ACTIVE = &apos;true&apos; &quot;;
		SQL += &quot; and C.RESIGN = &apos;false&apos;&quot; ;			
		SQL += &quot; and A.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
		SQL += &quot; and B.KEY1 = &apos;&quot;+companyID+&quot;&apos;&quot;  ;	
        SQL += &quot; and B.VALUE3 like &apos;%&quot; + temp1 + &quot;%&apos; &quot;;		
        SQL += &quot; and A.PARAMETER = B.PARAMETER &quot;;		
		SQL += &quot; and C.MEMID=B.VALUE2&quot;;
	var vec = Server.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Server.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
				  var Dauble_flag = memisDauble(SignTable,memid) ;
				  var cmemid = memid ;
				  
				if(Dauble_flag != &quot;Y&quot;){
                   var hm = new java.util.HashMap();
				   var row = SignTable.size();//SignTable裡資料筆數
					   hm.put(&quot;ITEM1&quot;, cmemid);
					   hm.put(&quot;ITEM3&quot;, cMember);
					   hm.put(&quot;ITEM4&quot;, dptcname);
					   hm.put(&quot;ITEM2&quot;, memDR);
					   hm.put(&quot;ITEM5&quot;, companyID+temp1);				    
					      SignTable.add(row,hm);
				   var new_record =&quot;Y&quot; ;
				}
			 }//for
			//寫入會簽群組Table，子流程使用
  	        if (SignTable_G != null){
			 if (new_record == &quot;Y&quot;){
			    var Dauble_flag_G = memisDauble(SignTable_G,companyID+temp1);
			     if(Dauble_flag_G != &quot;Y&quot;){
					var hm1 = new java.util.HashMap();
                    var row1 = SignTable_G.size();//SignTable裡資料筆數		
						hm1.put(&quot;ITEM1&quot;, companyID+temp1);	
						SignTable_G.add(row1,hm1);
		         }	
		      }
		   }	
		}else{
			Server.addInfoLog(companyID+&quot;_&quot;+temp1+&quot;沒有設定會簽人員!&quot;+memid);			
		}//if (vec.size()&gt;0)
	   }//if ( vec != null )
	 }catch(e){
		Server.addInfoLog(&quot;讀取參數檔失敗 addAsignList_v1 !!!\n&quot;+SQL+memid);
	}
	
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00381306142008999</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2013/09/02 16:14:39</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.addAsignTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00381306142008999</string> 
     </void> 
     <void property="name"> 
      <string>addAsignTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00041211951346768</string> 
     </void> 
     <void property="scriptSource"> 
      <string>// 設定會簽人員function
function addAsignList(PARAMETER,Sign_MemberTable,Description){
	var Ati = MyTask.getArtInstance();
	var hm = Ati.getAppDataMap();
	var factory = hm.get(&quot;Factory&quot;) ;
    var v_factory=factory.substring(1,5);
	var SignTable = hm.get(Sign_MemberTable);
	//SignTable.clear();
	var SignTable_G = hm.get(Sign_MemberTable+&quot;_G&quot;);
    //SignTable_G.clear();	
	var SQL =    &quot; select VALUE2 memid ,VALUE1 username ,RESIGN  from A_PARAMETER_ITEM , A_PARAMETER_DATA, MEM_GENINF &quot;;
	SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
	SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
	SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
	SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 = &apos;&quot;+v_factory+&quot;&apos;&quot;  ;	
	SQL = SQL +  &quot; and MEM_GENINF .MEMID=A_PARAMETER_DATA.VALUE2&quot;;
	SQL = SQL +  &quot; and MEM_GENINF.RESIGN=&apos;false&apos; &quot;;
	if(Description!=&quot;&quot;){
		SQL = SQL +  &quot; and A_PARAMETER_DATA.DESCRIPTION = &apos;&quot;+Description+&quot;&apos;&quot;  ;
	}
	
	var vec = Server.SQLloadValue(SQL);			
	  try{
		  
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
				
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Server.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
			    //離職人員判斷，若離職則轉單至ADM
				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(Sign_MemberTable,memid) ;
					var cmemid = memid ;
			    }else{
					 var Dauble_flag = memisDauble(Sign_MemberTable,memid) ;	
					 var cmemid = &quot;PDM&quot; ;	 
				}

				if(Dauble_flag != &quot;Y&quot;){					
				   var dataMap = new java.util.HashMap();
				   dataMap.put(&quot;ITEM1&quot;,cmemid);
				   dataMap.put(&quot;ITEM2&quot;,cMember);		
				   dataMap.put(&quot;ITEM3&quot;,dptcname);
				   dataMap.put(&quot;ITEM4&quot;,memDR);		
				   dataMap.put(&quot;ITEM5&quot;,(v_factory+PARAMETER));									
				   SignTable.add(dataMap);	
				   Ati.setAppValue(Sign_MemberTable,SignTable);
				   var new_record =&quot;Y&quot; ;
				}
			
			 }
			 
			//寫入會簽群組Table，子流程使用
			if (new_record == &quot;Y&quot;){
			    if (SignTable_G != null){
					var dataMap = new java.util.HashMap();
					dataMap.put(&quot;ITEM1&quot;,(v_factory+PARAMETER));									
				    SignTable_G.add(dataMap);				    
					Ati.setAppValue((Sign_MemberTable+&quot;_G&quot;),SignTable_G);
					
		        }	
		    }		
		}else{		     
		}
	   }
	 }catch(e){		
		Server.addDebugLog(&quot;[addAsignList]讀取參數檔失敗!請與系統負責聯絡!!\n&quot;);
	}
}//function addAsignList
//全簽子流程使用
function addAsignList_a(PARAMETER,Sign_MemberTable,Description,value3){
	var Ati = MyTask.getArtInstance();
	var hm = Ati.getAppDataMap();
	var factory = hm.get(&quot;Factory&quot;) ;
    var v_factory=factory.substring(1,5);
	var SignTable = hm.get(Sign_MemberTable);
	//SignTable.clear();
	var SignTable_G = hm.get(Sign_MemberTable+&quot;_G&quot;);
    //SignTable_G.clear();	
	var SQL =    &quot; select VALUE2 memid ,VALUE1 username ,RESIGN  from A_PARAMETER_ITEM , A_PARAMETER_DATA, MEM_GENINF &quot;;
	SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
	SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
	SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
	SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 = &apos;&quot;+v_factory+&quot;&apos;&quot;  ;	
	SQL = SQL +  &quot; and MEM_GENINF .MEMID=A_PARAMETER_DATA.VALUE2&quot;;
	if(Description!=&quot;&quot;){
		SQL = SQL +  &quot; and A_PARAMETER_DATA.DESCRIPTION = &apos;&quot;+Description+&quot;&apos;&quot;  ;
	}
	if(value3!=&quot;&quot;){
		SQL = SQL +  &quot; and A_PARAMETER_DATA.value3 = &apos;&quot;+value3+&quot;&apos;&quot;  ;
	}
	Server.addDebugLog(&quot;PM品保認證別簽核人員SQL==&quot;+SQL);
	var vec = Server.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Server.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
			    //離職人員判斷，若離職則轉單至ADM
				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(Sign_MemberTable,memid) ;
					var cmemid = memid ;
			    }else{
					 var Dauble_flag = memisDauble(Sign_MemberTable,memid) ;	
					 var cmemid = &quot;PDM&quot; ;	 
				}

				if(Dauble_flag != &quot;Y&quot;){					
				   var dataMap = new java.util.HashMap();
				   dataMap.put(&quot;ITEM1&quot;,cmemid);
				   dataMap.put(&quot;ITEM2&quot;,cMember);		
				   dataMap.put(&quot;ITEM3&quot;,dptcname);
				   dataMap.put(&quot;ITEM4&quot;,memDR);		
				   dataMap.put(&quot;ITEM5&quot;,(v_factory+cmemid));									
				   SignTable.add(dataMap);	
				   Ati.setAppValue(Sign_MemberTable,SignTable);
				   var new_record =&quot;Y&quot; ;
				}
				//寫入會簽群組Table，子流程使用
				if (new_record == &quot;Y&quot;){
					if (SignTable_G != null){
						var dataMap = new java.util.HashMap();
						dataMap.put(&quot;ITEM1&quot;,(v_factory+cmemid));									
						SignTable_G.add(dataMap);				    
						Ati.setAppValue((Sign_MemberTable+&quot;_G&quot;),SignTable_G);
					
					}	
				}
			
			 }
					
		}else{		     
		}
	   }
	 }catch(e){		
		Server.addDebugLog(&quot;[addAsignList]讀取參數檔失敗!請與系統負責聯絡!!\n&quot;);
	}
}//function addAsignList

function memisDauble(table,memid){
        var flag =&quot;&quot;;	
		var Ati = MyTask.getArtInstance();
	    var hm = Ati.getAppDataMap();
	    var table = hm.get(table);
		for(var j = 0;j&lt;table.size();j++){
			if(table.get(j).get(&quot;ITEM1&quot;).equals(memid)){
		 		var flag =&quot;Y&quot;;
			}
		}
		return flag ;		
}//function memisDauble

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00391307953879424</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/03/22 17:18:42</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.BAS_Search_Data</string> 
     </void> 
     <void property="id"> 
      <string>SCL00391307953879424</string> 
     </void> 
     <void property="name"> 
      <string>BAS_Search_Data</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//===================================================================
// 基本功查詢
// 查詢條件
//===================================================================	
function getQueryConditionExt_BAS(temp){
	var sSQL=&quot;&quot;;
	var Ob_date = new Packages.pase.agenda.MyDate();
	var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	var ckbSDate_bas = Form.getValue(&quot;ckbSDate_bas&quot;);
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);	
	var ckbEDate_bas = Form.getValue(&quot;ckbEDate_bas&quot;);
	
	if(temp==&quot;1&quot; ||temp==&quot;2&quot;){
	var ckbSDate_bas_fail = Form.getValue(&quot;ckbSDate_bas_fail&quot;);
	var ckbEDate_bas_fail = Form.getValue(&quot;ckbEDate_bas_fail&quot;);
	}
//申請日期
	// 起始日期
	if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; !&quot;true&quot;.equals(ckbEDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		if (!&quot;&quot;.equals(sDate)) {
			if(temp ==&quot;1&quot;){
			   sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot;&apos;&quot;;
			}else if(temp ==&quot;2&quot;){
			   sSQL += &quot; AND key_date &gt;= &apos;&quot; + sDate + &quot;&apos;&quot;;
			}else{
			   sSQL += &quot; AND return_date &gt;= &apos;&quot; + sDate + &quot;&apos;&quot;;		   
			   sSQL += &quot; AND ( fail_date is null or fail_flag=&apos;P&apos; or (fail_flag=&apos;Y&apos; and fail_date &gt; &apos;&quot; + sDate + &quot;&apos;))&quot;;				   
			}
		}
	}	
	// 終止日期
	if (&quot;true&quot;.equals(ckbEDate) &amp;&amp; !&quot;true&quot;.equals(ckbSDate)){	
		var eDate = Form.getValue(&quot;eDate&quot;);	
		if (!&quot;&quot;.equals(eDate)) {
          if(temp ==&quot;1&quot;){			
			sSQL += &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;
		  }else if(temp ==&quot;2&quot;){
			sSQL += &quot; AND key_date &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;   
		  }else{
		  	sSQL += &quot; AND return_date &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;   	 		
		  	sSQL += &quot; AND ( fail_date is null or fail_flag=&apos;P&apos; or (fail_flag=&apos;Y&apos; and fail_date &gt; &apos;&quot; + eDate + &quot;&apos;))&quot;;   	 			
		  }	  
		}
	}	
	// 起始日期 ~ 終止日期
      if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; &quot;true&quot;.equals(ckbEDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		var eDate = Form.getValue(&quot;eDate&quot;);
//		var eDate1= Ob_date.add(Form.getValue(&quot;eDate&quot;),1); 
		if (!&quot;&quot;.equals(sDate)&amp;&amp; !&quot;&quot;.equals(eDate)) {
          if(temp ==&quot;1&quot;){				
			sSQL += &quot; AND ITEM12 &gt;= &apos;&quot; + sDate + &quot;&apos;&quot; + &quot; AND ITEM12 &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;
		  }else if(temp ==&quot;2&quot;){
            sSQL += &quot; AND key_date &gt;= &apos;&quot; + sDate + &quot;&apos;&quot; + &quot; AND key_date &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;		  
		  }else{
            sSQL += &quot; AND return_date &gt;= &apos;&quot; + sDate + &quot;&apos;&quot; + &quot; AND return_date &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;		 				
            sSQL += &quot; AND ( fail_date is null or fail_flag=&apos;P&apos; or  (fail_flag=&apos;Y&apos; and fail_date &gt; &apos;&quot; + eDate + &quot;&apos;))&quot;;				
		  }	
		}
	  }

	//認證日期
	// 起始日期
	if (&quot;true&quot;.equals(ckbSDate_bas) &amp;&amp; !&quot;true&quot;.equals(ckbEDate_bas)){	
		var sDate_bas = Form.getValue(&quot;sDate_bas&quot;);	
		if (!&quot;&quot;.equals(sDate_bas)) {
			if(temp ==&quot;1&quot;){
			   sSQL += &quot; AND ITEM96 &gt;= &apos;&quot; + sDate_bas + &quot;&apos;&quot;;
			}else if(temp ==&quot;2&quot;){
			   sSQL += &quot; AND pqe_date &gt;= &apos;&quot; + sDate_bas + &quot;&apos;&quot;;			  			
			}
		}
	}	
	// 終止日期
	if (&quot;true&quot;.equals(ckbEDate_bas) &amp;&amp; !&quot;true&quot;.equals(ckbSDate_bas)){	
		var eDate_bas = Form.getValue(&quot;eDate_bas&quot;);
		if (!&quot;&quot;.equals(eDate_bas)) {
          if(temp ==&quot;1&quot;){			
			sSQL += &quot; AND ITEM96 &lt;= &apos;&quot; + eDate_bas + &quot;&apos;&quot;;
		  }else if(temp ==&quot;2&quot;){
			sSQL += &quot; AND pqe_date &lt;= &apos;&quot; + eDate_bas + &quot;&apos;&quot;;   		    		
		  } 
		}
	}	
	// 起始日期 ~ 終止日期
      if (&quot;true&quot;.equals(ckbSDate_bas) &amp;&amp; &quot;true&quot;.equals(ckbEDate_bas)){	
		var sDate_bas = Form.getValue(&quot;sDate_bas&quot;);	
		var eDate_bas = Form.getValue(&quot;eDate_bas&quot;);
//		var eDate1_bas= Ob_date.add(Form.getValue(&quot;eDate_bas&quot;),1); 
		if (!&quot;&quot;.equals(sDate_bas)&amp;&amp; !&quot;&quot;.equals(eDate_bas)) {
          if(temp ==&quot;1&quot;){				
			sSQL += &quot; AND ITEM96 &gt;= &apos;&quot; + sDate_bas + &quot;&apos;&quot; + &quot; AND ITEM96 &lt;= &apos;&quot; + eDate_bas + &quot;&apos;&quot;;
		  }else if(temp ==&quot;2&quot;){
            sSQL += &quot; AND pqe_date &gt;= &apos;&quot; + sDate_bas + &quot;&apos;&quot; + &quot; AND pqe_date &lt;= &apos;&quot; + eDate_bas + &quot;&apos;&quot;;		    
		  }		
		}
	}
	
	//下崗日期
	// 起始日期
	if (&quot;true&quot;.equals(ckbSDate_bas_fail) &amp;&amp; !&quot;true&quot;.equals(ckbEDate_bas_fail)){	
		var sDate_bas_fail = Form.getValue(&quot;sDate_bas_fail&quot;);	
		if (!&quot;&quot;.equals(sDate_bas_fail)) {
			if(temp ==&quot;1&quot;){
			   sSQL += &quot; AND ITEM93 &gt;= &apos;&quot; + sDate_bas_fail + &quot;&apos;&quot;;
			}else if(temp ==&quot;2&quot;){
			   sSQL += &quot; AND fail_date &gt;= &apos;&quot; + sDate_bas_fail + &quot;&apos;&quot;;			  			
			}
		}
	}	
	// 終止日期
	if (&quot;true&quot;.equals(ckbEDate_bas_fail) &amp;&amp; !&quot;true&quot;.equals(ckbSDate_bas_fail)){	
		var eDate_bas_fail = Form.getValue(&quot;eDate_bas_fail&quot;);
		if (!&quot;&quot;.equals(eDate_bas)) {
          if(temp ==&quot;1&quot;){			
			sSQL += &quot; AND ITEM93 &lt;= &apos;&quot; + eDate_bas_fail + &quot;&apos;&quot;;
		  }else if(temp ==&quot;2&quot;){
			sSQL += &quot; AND fail_date &lt;= &apos;&quot; + eDate_bas_fail + &quot;&apos;&quot;;   		    		
		  } 
		}
	}	
	// 起始日期 ~ 終止日期
      if (&quot;true&quot;.equals(ckbSDate_bas_fail) &amp;&amp; &quot;true&quot;.equals(ckbEDate_bas_fail)){	
		var sDate_bas_fail = Form.getValue(&quot;sDate_bas_fail&quot;);	
		var eDate_bas_fail = Form.getValue(&quot;eDate_bas_fail&quot;);
//		var eDate1_bas= Ob_date.add(Form.getValue(&quot;eDate_bas&quot;),1); 
		if (!&quot;&quot;.equals(sDate_bas_fail)&amp;&amp; !&quot;&quot;.equals(eDate_bas_fail)) {
          if(temp ==&quot;1&quot;){				
			sSQL += &quot; AND ITEM93 &gt;= &apos;&quot; + sDate_bas_fail + &quot;&apos;&quot; + &quot; AND ITEM93 &lt;= &apos;&quot; + eDate_bas_fail + &quot;&apos;&quot;;
		  }else if(temp ==&quot;2&quot;){
            sSQL += &quot; AND fail_date &gt;= &apos;&quot; + sDate_bas_fail + &quot;&apos;&quot; + &quot; AND fail_date &lt;= &apos;&quot; + eDate_bas_fail + &quot;&apos;&quot;;		    
		  }		
		}
	}	
	
	// 部門名稱
	var DepName = Form.getValue(&quot;DepName&quot;);	
	if (!&quot;&quot;.equals(DepName)) {
      if(temp ==&quot;1&quot;){			
		sSQL += &quot; AND ITEM325 like &apos;&quot; + DepName.trim() + &quot;%&apos;&quot;;
	  }else if(temp ==&quot;2&quot;){
	  	sSQL += &quot; AND dpt_no||dpt_name like &apos;%&quot; + DepName.trim() + &quot;%&apos;&quot;;
	  }else{
	  	//sSQL += &quot; AND dptno like &apos;%&quot; + DepName.trim() + &quot;%&apos;&quot;;	
		sSQL += &quot; and userid in(select id from mem_geninf where mainroleid like &apos;%&quot;+DepName.trim()+&quot;%&apos;) &quot;;	  
	  }	
	}

	// 申請人姓名
	var MemName = Form.getValue(&quot;MemName&quot;);	
	if (!&quot;&quot;.equals(MemName)) {
	  if(temp ==&quot;1&quot;){			
		sSQL += &quot; AND ITEM144 like &apos;&quot; + MemName + &quot;%&apos;&quot;;
	  }else if(temp ==&quot;2&quot;){
	    sSQL += &quot; AND user_name=&apos;&apos;&quot;;//匯入的data 無申請人姓名		
	  }else{
		  sSQL += &quot; AND username like &apos;&quot; + MemName + &quot;%&apos;&quot;;
	  }
	}	
	// 認證人姓名
	var vSubject = Form.getValue(&quot;Subject&quot;);	 
	if (!&quot;&quot;.equals(vSubject)) {
		if(temp ==&quot;1&quot;){	
		sSQL += &quot; AND ITEM318 like &apos;%&quot; + vSubject + &quot;%&apos;&quot;;
		}else if(temp ==&quot;2&quot;){
		sSQL += &quot; AND user_name like &apos;%&quot; + vSubject + &quot;%&apos;&quot;; 
		}else {
		sSQL += &quot; AND username like &apos;%&quot; + vSubject + &quot;%&apos;&quot;; 
		}
	}
	// 認證人工號 MODI YB wagnwei@2014/2/17原是用LIKE 改為 = 
	var vUser_id = Form.getValue(&quot;User_id&quot;);	 
	if (!&quot;&quot;.equals(vUser_id)) {
		if(temp ==&quot;1&quot;){	
			sSQL += &quot; AND ITEM322 = &apos;&quot; + vUser_id + &quot;&apos;&quot;;
		}else if(temp ==&quot;2&quot;){
			sSQL += &quot; AND user_id = &apos;&quot; + vUser_id + &quot;&apos;&quot;; 
		}else{
			sSQL += &quot; AND userid = &apos;&quot; + vUser_id + &quot;&apos;&quot;; 		
		}
	}	
	// No
	var No = Form.getValue(&quot;No&quot;);	 
	if (!&quot;&quot;.equals(No)) {
		if(temp ==&quot;1&quot;){			
		sSQL += &quot; AND ITEM62 like &apos;%&quot; + No + &quot;%&apos;&quot;;
		}else if(temp ==&quot;2&quot;){
		sSQL +=&quot;and fail_flag = &apos;1&apos;&quot;; //匯入的data 沒有單號
		}else{
		sSQL += &quot; AND SN like &apos;%&quot; + No + &quot;%&apos;&quot;;		 
		}
	}
	
   var v_status = Form.getValue(&quot;Status&quot;);
   if(temp ==&quot;1&quot;){	
     if(v_status ==&quot;已結案&quot;){
	    sSQL +=&quot; and ITEM155 = &apos;false&apos; and ITEM115 is not null and (ITEM83 is not null or ITEM83=&apos;N&apos;)&quot;;
     }else if(v_status ==&quot;未結案&quot;){
        sSQL +=&quot; and ITEM155 = &apos;false&apos;  and ITEM115 is null&quot;;
     }else if(v_status ==&quot;作廢&quot;){
        sSQL +=&quot; and ITEM155 = &apos;true&apos;&quot;;
     }else if(v_status ==&quot;下崗&quot;){
        sSQL +=&quot; and ITEM83 = &apos;Y&apos;&quot;;
     }else{
            sSQL +=&quot;&quot;;
     }
   }else if(temp ==&quot;2&quot;){
     if(v_status ==&quot;已結案&quot;){
		sSQL +=&quot; and fail_flag = &apos;N&apos;&quot;;
     }else if(v_status ==&quot;未結案&quot; || v_status ==&quot;作廢&quot;){		
		sSQL +=&quot; and fail_flag = &apos;&apos;&quot;; 
     }else if(v_status ==&quot;下崗&quot;){
        sSQL +=&quot; and fail_flag = &apos;Y&apos;&quot;;
     }else{
        sSQL +=&quot;&quot;;
     } 
   }
   
   var v_bas_level = Form.getValue(&quot;bas_level&quot;);
   if(temp ==&quot;1&quot;){
     if(v_bas_level !=&quot;全部&quot;){
	    sSQL +=&quot; and ITEM11 = &apos;&quot;+ v_bas_level +&quot;&apos;&quot;;
     }else{
          sSQL +=&quot;&quot;;
     }
   }else{
      if(v_bas_level !=&quot;全部&quot;){
	    sSQL +=&quot; and u_level = &apos;&quot;+ v_bas_level +&quot;&apos;&quot;;
     }else{
          sSQL +=&quot;&quot;;
     }
   }
   var v_check_ok = Form.getValue(&quot;check_ok&quot;);
   if(temp ==&quot;1&quot;){
     if(v_check_ok ==&quot;合格&quot;){
	    sSQL +=&quot; and ITEM88 = &apos;&quot;+ v_check_ok +&quot;&apos;&quot;;
        sSQL +=&quot; and ITEM83 is null&quot;;			   
		sSQL +=&quot; and ITEM155 = &apos;false&apos;&quot;;			
     }else if(v_check_ok ==&quot;不合格&quot;){
	    sSQL +=&quot; and ITEM89 = &apos;&quot;+ v_check_ok +&quot;&apos;&quot;;
	    sSQL +=&quot; and ITEM155 = &apos;false&apos;&quot;;			
     }else if(v_check_ok ==&quot;取得資格&quot;){
		if( v_bas_level == &quot;E1&quot; || v_bas_level == &quot;E2&quot;){
	       sSQL +=&quot; and ITEM94 is not null&quot;;		
		}
	       sSQL +=&quot; and ITEM88 = &apos;合格&apos;&quot;;
           sSQL +=&quot; and ITEM83 is null&quot;;			   
		   sSQL +=&quot; and ITEM155 = &apos;false&apos;&quot;;	
     }else{
        sSQL +=&quot;&quot;;
     }
   }else if(temp ==&quot;2&quot;){
	 if(v_check_ok ==&quot;不合格&quot;){  
      sSQL +=&quot;and fail_flag = &apos;1&apos;&quot;; //匯入的data 都是合格的
	 }else if(v_check_ok ==&quot;全部&quot;){
	  sSQL +=&quot;&quot;;	
	 }else{
      sSQL +=&quot;and fail_flag = &apos;N&apos;&quot;;	 
	 }
//   }else if(temp ==&quot;3&quot;){//下載最高階段
//	         sSQL +=&quot;and (fail_flag is null or fail_flag !=&apos;Y&apos;)&quot;;	 
   }  
	return sSQL;
}

//===================================================================
//  共用條件的SQL SEARCH Report List
//===================================================================	
function showTable_BAS(P,vec){	
	loadLibrary(&quot;com.A.Common.Client.Util&quot;);
	var vec = Client.getLocalObject(vec);
	var N = Form.getValue(&quot;N&quot;);
	var T = Math.ceil(vec.size()/N); //無條件進位
    Form.setValue(&quot;Count&quot;,vec.size()+&quot;&quot;);
	Form.setValue(&quot;T&quot;,&quot;&quot;+T);	
	var table = Form.getComponent(&quot;ResultTable&quot;);
	table.clear();
	var row = 0;
	Form.setValue(&quot;P&quot;,&quot;&quot;+ P);
	var E = P * N;
	if(vec.size()&lt; E){
		E = vec.size();
	}
	if (vec.size()&gt;0) {
		for (var i = (P-1)*N ; i &lt; E; i++) {
			try{
			var hm = vec.get(i);
			var row = table.newRow()-1;
			
			if(hm.get(&quot;OK&quot;)==&quot;合格&quot;){	
					var v_result =&quot;合格&quot;;
				}else if(hm.get(&quot;NOK&quot;)==&quot;不合格&quot;){
   					var v_result =&quot;不合格&quot;;
				}else{
				   var v_result =&quot;&quot;;
			}	
			
			if(hm.get(&quot;INSID&quot;)==&quot;old_data&quot;){
                processname =&quot;已結案(old_data)&quot;;				
			   if(&quot;Y&quot; == hm.get(&quot;fail_flag&quot;)){
					processname = &quot;下崗(old_data)&quot;;
				}  	
				if(&quot;P&quot; == hm.get(&quot;fail_flag&quot;)){
					processname = &quot;下崗中(old_data)&quot;;
				}
				table.setValueAt(processname,   row, &quot;目前關卡&quot;);				
				table.setValueAt(&quot;&quot;,  row, &quot;目前處理者&quot;);
				
			}else{

			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			 if (task != null){
				var processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					if(&quot;Y&quot; == hm.get(&quot;fail_flag&quot;) &amp;&amp; v_result !=&quot;&quot;){
					  processname = &quot;下崗&quot;;						
					}else{	
					  processname = &quot;作廢&quot;;
					}
				}else if(&quot;Y&quot; == hm.get(&quot;fail_flag&quot;)){					
					processname = &quot;下崗&quot;;
				}else if(&quot;P&quot; == hm.get(&quot;fail_flag&quot;)){
					processname = &quot;下崗中&quot;;					
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}

				table.setValueAt(processname,   row, &quot;目前關卡&quot;);				
				var realExecutorMemID = task.getRealExecutor();
				var memberRecord = Client.getMemberByID(realExecutorMemID);
				if( &quot;已結案&quot;==processname || &quot;作廢&quot; ==processname ){
					table.setValueAt(&quot;--&quot;, row, &quot;申請人&quot;);
				}else if(hm.get(&quot;ITEM115&quot;)!=&quot;&quot; &amp;&amp; (&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState())){//結案時間
					table.setValueAt(&quot;&quot;,  row, &quot;目前處理者&quot;);
				}else{
						table.setValueAt(memberRecord.getName(),  row, &quot;目前處理者&quot;);
				}				
			  }
			}
			table.setValueAt((i + 1) + &quot;&quot;,          row, &quot;序&quot;);
			table.setValueAt(hm.get(&quot;print_flag&quot;),  row, &quot;列印&quot;);					
			table.setValueAt(hm.get(&quot;sn&quot;),    	    row, &quot;文件編號&quot;);			
			table.setValueAt(hm.get(&quot;dptno&quot;), 	    row, &quot;部門&quot;);
			table.setValueAt(hm.get(&quot;appname&quot;),  	row, &quot;填單人姓名&quot;);			
			table.setValueAt(hm.get(&quot;username&quot;),  	row, &quot;認證人姓名&quot;);
			table.setValueAt(hm.get(&quot;userid&quot;),  	row, &quot;認證人工號&quot;);	
			table.setValueAt(hm.get(&quot;work_type&quot;),  	row, &quot;認證人班別&quot;);				
			table.setValueAt(hm.get(&quot;createdate&quot;),  row, &quot;填寫日期&quot;);		
			table.setValueAt(hm.get(&quot;pqe_date&quot;),   	row, &quot;認證日期&quot;);					
			table.setValueAt(hm.get(&quot;u_name&quot;),   	row, &quot;認證單元&quot;);
			table.setValueAt(hm.get(&quot;m_name&quot;),   	row, &quot;認證機台&quot;);			
			table.setValueAt(hm.get(&quot;u_level&quot;),  	row, &quot;認證類別&quot;);					
			table.setValueAt(v_result,  	        row, &quot;考核結果&quot;);		
			table.setValueAt(hm.get(&quot;return_date&quot;), row, &quot;產品認證日期&quot;);					
			table.setValueAt(hm.get(&quot;fail_date&quot;),  	row, &quot;下崗日期&quot;);			
			table.setValueAt(hm.get(&quot;fail_sn&quot;),  	row, &quot;下崗單號&quot;);		
			table.setValueAt(hm.get(&quot;fail_insid&quot;),  row, &quot;F_InsID&quot;);									
			table.setValueAt(hm.get(&quot;INSID&quot;),   	row, &quot;InsID&quot;);
			}catch(e){}
		}
	} else {
		Form.showMessageDialog(&quot;查無任何相關記錄！&quot;);
	}
}//function showTable_BAS(P,vec)

//---------------------------------------------------------
//main
//---------------------------------------------------------
function main_BAS(temp) {
	var serverTime = Client.getServerTime();
	var myDate = new Packages.pase.agenda.MyDate(serverTime);
	var today = myDate.getCurrentDate(&quot;Y/M/D H:m:S&quot;);
	var date = myDate.getCurrentDate(&quot;YMDHmS&quot;);
	//var table = Form.getComponent(&quot;ResultTable&quot;);
	var vec = Client.getLocalObject(&quot;vec&quot;);
	if(temp==&quot;&quot;){
     var v_name = &quot;基本功認證申請單&quot;;
	}else if(temp==&quot;1&quot;){
     var v_name = &quot;基本功認證各認證最高階明細&quot;;		
	}else if(temp==&quot;2&quot;){
     var v_name = &quot;基本功認證最高階認證明細&quot;;		
	}else if(temp==&quot;3&quot;){		
     var v_name = &quot;基本功認證多人功明細&quot;;		
	}else if(temp==&quot;4&quot;){		
     var v_name = &quot;基本功認證報表&quot;;		
	}else if(temp==&quot;5&quot;){		
     var v_name = &quot;離職留停人員比對基本功認證&quot;;		
	}else if(temp==&quot;6&quot;){		
     var v_name = &quot;基本下崗資訊&quot;;		
	}else if(temp==&quot;7&quot;){		
     var v_name = &quot;基本下崗缺失資訊&quot;;			 
	}
	
     writeScriptToFile_BAS(&quot;C:\\temp\\&quot;+ v_name + &quot;_&quot; + date + &quot;.csv&quot;, today, vec,temp);
	 Form.downloadFile(&quot;C:\\temp\\&quot;, v_name + &quot;_&quot; + date + &quot;.csv&quot;);	//for JSP
}

//---------------------------------------------------------
// write Script code to file
// 20071222 改版
//---------------------------------------------------------
function writeScriptToFile_BAS(m_filePath, today, vec,temp) {
    loadLibrary(&quot;com.A.Common.Client.Util&quot;);	
	//table中有幾列,v_col就填多少,第三個要修改的地方
//	var v_col = TOTAL_COLUMNS;
	var file  = new Packages.java.io.File(m_filePath);
	file.createNewFile();
	var pw =  new Packages.java.io.PrintWriter(new Packages.java.io.FileOutputStream(file));
	var v_factory = Form.getValue(&quot;Factory&quot;).substr(1,4);
	//以下三行str為表頭,第一個要修改的地方 
	if(temp==&quot;&quot;){
      var str = &quot;基本功認證申請單&quot;+Form.getValue(&quot;sDate&quot;)+&quot;~&quot;+Form.getValue(&quot;eDate&quot;)+&quot;    列印日期: &quot; + today;	
	}else if(temp==&quot;1&quot;){
	  var str = &quot;基本功認證各認證最高階明細 &quot;+Form.getValue(&quot;sDate&quot;)+&quot;~&quot;+Form.getValue(&quot;eDate&quot;)+&quot;    列印日期: &quot; + today;		
	}else if(temp==&quot;2&quot;){
	  var str = &quot;基本功認證最高階認證明細 &quot;+Form.getValue(&quot;sDate&quot;)+&quot;~&quot;+Form.getValue(&quot;eDate&quot;)+&quot;    列印日期: &quot; + today;	
	}else if(temp==&quot;3&quot;){		
  	  var str = &quot;基本功認證多能功明細 &quot;+Form.getValue(&quot;sDate&quot;)+&quot;~&quot;+Form.getValue(&quot;eDate&quot;)+&quot;    列印日期: &quot; + today;	
	}else if(temp==&quot;4&quot;){		
  	  var str = &quot;基本功認證報表&quot;+Form.getValue(&quot;sDate&quot;)+&quot;~&quot;+Form.getValue(&quot;eDate&quot;)+&quot;    列印日期: &quot; + today;		
	}else if(temp==&quot;5&quot;){		
  	  var str = &quot;離職留停人員比對基本功認證&quot;+Form.getValue(&quot;sDate&quot;)+&quot;~&quot;+Form.getValue(&quot;eDate&quot;)+&quot;    列印日期: &quot; + today;		
	}else if(temp==&quot;6&quot;){		
  	  var str = &quot;基本下崗資訊&quot;+Form.getValue(&quot;sDate&quot;)+&quot;~&quot;+Form.getValue(&quot;eDate&quot;)+&quot;    列印日期: &quot; + today;		
	}else if(temp==&quot;7&quot;){		
  	  var str = &quot;基本下崗缺失資訊&quot;+Form.getValue(&quot;sDate&quot;)+&quot;~&quot;+Form.getValue(&quot;eDate&quot;)+&quot;    列印日期: &quot; + today;		
	}else if(temp==&quot;8&quot;){		
  	  var str = &quot;多能功獎金計算&quot;+Form.getValue(&quot;sDate&quot;)+&quot;~&quot;+Form.getValue(&quot;eDate&quot;)+&quot;    列印日期: &quot; + today;		
	}else if(temp==&quot;9&quot;){		
  	  var str = &quot;多能功獎金計算&quot;+Form.getValue(&quot;sDate&quot;)+&quot;~&quot;+Form.getValue(&quot;eDate&quot;)+&quot;    列印日期: &quot; + today;		
	}
	if(temp!=&quot;8&quot;){
		pw.println(str);
	}
	
	var str  = &quot;&quot;;
	if(temp!=&quot;8&quot;){
		pw.println(str);
	}
	//下一行str各行標題,第二個要修改的地方 		
	if(temp==&quot;&quot;){
       var str = &quot;序,目前關卡,目前處理者,文件編號,填單人姓名,當時認證的部門,目前所屬單位,認證人姓名,認證人工號,認證人班別,填寫日期,認證日期,認證單元,認證機台,認證類別,考核結果,產品認證日期,下崗日期,下崗單號&quot;;	
	}else if(temp==&quot;1&quot;){
       var str = &quot;序,文件編號,填單人姓名,當時認證的部門,目前所屬單位,認證人姓名,認證人工號,認證人班別,填寫日期,認證日期,認證單元,認證機台,認證類別,產品認證日期&quot;;	
	}else if(temp==&quot;2&quot;){
       var str = &quot;序,文件編號,填單人姓名,部門,認證人姓名,認證人工號,認證人班別,填寫日期,認證日期,認證單元,認證機台,認證類別,產品認證日期&quot;;	   
	}else if(temp==&quot;3&quot;){
		if(v_factory==&quot;TGCE&quot;){
			var str = &quot;序,部門,認證人姓名,認證人工號,人員狀態,填寫日期,認證日期,取得資格日期,認證單元,認證機台,最高認證類別,最高認證獎金,E3認證類別,E3認證獎金(1800),E2認證類別,E2認證獎金(1200),E1認證類別,E1認證獎金(600),總計&quot;;
		}else{
			var str = &quot;序,部門,認證人姓名,認證人工號,人員狀態,填寫日期,認證日期,取得資格日期,認證單元,認證機台,最高認證類別,最高認證獎金,老E1,總計&quot;;
			if(v_factory==&quot;HGCE&quot;){
				var str = &quot;序,部門,認證人姓名,認證人工號,人員狀態,離職日期,填寫日期,認證日期,取得資格日期,認證單元,認證機台,最高認證類別,最高認證獎金,老E1,總計&quot;;

			}
		}
       		
	}else if(temp==&quot;4&quot;){
       var str = &quot;序,認證單元,認證機台,E0認證類別,E1認證類別,E2認證類別,E3認證類別&quot;;		
	}else if(temp==&quot;5&quot;){
       var str = &quot;序,部門,工號,姓名,離職日期,認證計數&quot;;		
	}else if(temp==&quot;6&quot;){
       var str = &quot;序,目前關卡,目前處理者,文件編號,填單人姓名,部門,下崗人姓名,下崗人工號,下崗人班別,填寫日期,下崗類別,缺失類別,下崗缺失型態,缺失細項,下崗日期,備註,認證階段,認證課程,認證機台&quot;;		
	}else if(temp==&quot;7&quot;){
       var str = &quot;序,工號,姓名,部門,下崗日期,下崗缺失型態,下崗缺失類別&quot;;		
	}else if(temp==&quot;8&quot;){
       var str = &quot;序,認證部門,部門,工號,姓名,工作型態,在/離職,離職日期,取得資格日期,最高認證類別,E3多能功,E2多能功,E1多能功,身份別&quot;;		
	}else if(temp==&quot;9&quot;){
       var str = &quot;序,認證部門,部門,工號,姓名,工作型態,在/離職,離職日期,取得資格日期,最高認證類別,老E1&quot;;		
	}
	pw.println(str);
	
	var ckbEDate = Form.getValue(&quot;ckbEDate&quot;); 	
	//抓取BPM 短期資料庫連線
    loadLibrary(&quot;com.gce.Common.Util&quot;);
    var ls_memt = get_ls_memt(v_factory);
 	var conn_name = conn_db(v_factory,&quot;MES&quot;);	
    var conn = Client.createSessionConnection(conn_name);
	//表身
	if(temp==&quot;&quot;){
		for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
				if(hm.get(&quot;OK&quot;)==&quot;合格&quot;){	
					var v_result =&quot;合格&quot;;
				}else if(hm.get(&quot;NOK&quot;)==&quot;不合格&quot;){
   					var v_result =&quot;不合格&quot;;
				}else{
				   var v_result =&quot;&quot;;
			    }	
				
			if(hm.get(&quot;INSID&quot;) == &quot;old_data&quot;){
			 var processname = &quot;已結案(old_data)&quot;;
			 var realExecutor = &quot;&quot;;
                if(&quot;Y&quot; == hm.get(&quot;fail_flag&quot;)){
					processname = &quot;下崗(old_data)&quot;;
				}			
			}else{	
			 var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			 var processname = &quot;&quot;;
			 var realExecutor = &quot;&quot;;
			   if (task != null){
				   processname = task.getProcessName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
                    if(&quot;Y&quot; == hm.get(&quot;fail_flag&quot;) &amp;&amp; v_result !=&quot;&quot;){
					  processname = &quot;下崗&quot;;						
					}else{	
					  processname = &quot;作廢&quot;;
					}
				}else if(&quot;Y&quot; == hm.get(&quot;fail_flag&quot;)){
					processname = &quot;下崗&quot;;
				}else if(&quot;P&quot; == hm.get(&quot;fail_flag&quot;)){
					processname = &quot;下崗中&quot;;					
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState()){
					processname = &quot;已結案&quot;;
				}				   
				   var realExecutorMemID = task.getRealExecutor();
				   var memberRecord = Client.getMemberByID(realExecutorMemID);
				   realExecutor = memberRecord.getName();
				   if(hm.get(&quot;ITEM115&quot;)!=&quot;&quot; &amp;&amp; (&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState())){//結案時間
					   realExecutor=&quot;&quot;;
				   }
			   }
			}
			
			var str1 = i + 1    				  + &quot;,&quot;; //序
			    str1 += processname   		      + &quot;,&quot;;//目前關卡
			    str1 += realExecutor  	          + &quot;,&quot;;//目前處理者					
			    str1 += hm.get(&quot;sn&quot;) 	          + &quot;,&quot;;//文件編號
			    str1 += hm.get(&quot;appname&quot;) 	      + &quot;,&quot;;//填單人姓名				
			    str1 += hm.get(&quot;dptno&quot;) 	      + &quot;,&quot;;//當時認證的部門
				var v_area = &quot;MEMT1&quot;;
				if(v_factory==&quot;TGCE&quot;){
					v_area = &quot;MEMT1&quot;;
				}else if(v_factory==&quot;SGCE&quot;){
					v_area = &quot;MEMS1&quot;;
				}else if(v_factory==&quot;CGCE&quot;){
					v_area = &quot;MEMC1&quot;;
				}else if(v_factory==&quot;HGCE&quot;){	
					v_area = &quot;MEMH1&quot;;
				}
				var v_member = Client.getMemberByID(v_area+hm.get(&quot;userid&quot;));
				var dpt_new = &quot;&quot;;
				if(v_member!=null){					
					var roleID = v_member.getMainRoleID();
					var memDR = v_member.getMemberDR(roleID);
					dpt_new = memDR.getDepartmentName();	//使用者部門名稱
				}
				str1 += dpt_new 	      + &quot;,&quot;;//目前所屬單位
			    str1 += hm.get(&quot;username&quot;)  	  + &quot;,&quot;;//認證人姓名
			    str1 += hm.get(&quot;userid&quot;)  	      + &quot;,&quot;;//認證人工號	
			    str1 += hm.get(&quot;work_type&quot;)  	  + &quot;,&quot;;//認證人班別						
			    str1 += hm.get(&quot;createdate&quot;)      + &quot;,&quot;;//填寫日期
			    str1 += hm.get(&quot;pqe_date&quot;)    	  + &quot;,&quot;;//認證日期	
			    str1 += hm.get(&quot;u_name&quot;) 	      + &quot;,&quot;;//認證單元	
			    str1 += hm.get(&quot;m_name&quot;) 	      + &quot;,&quot;;//認證機台			
			    str1 += hm.get(&quot;u_level&quot;)		  + &quot;,&quot;;//認證類別
			    str1 += v_result	              + &quot;,&quot;;//考核結果
     			str1 += hm.get(&quot;return_date&quot;)	  + &quot;,&quot;;//產品認證日期
			    str1 += hm.get(&quot;fail_date&quot;)	      + &quot;,&quot;;//下崗日期
			    str1 += hm.get(&quot;fail_sn&quot;)		  + &quot;,&quot;;//下崗單號		
	
			pw.println(str1);
			}catch(e){}
	}//for i
   }else if(temp==&quot;1&quot;){
	   for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
			
			var str1 = i + 1    				      + &quot;,&quot;; //序				
			    str1 += hm.get(&quot;sn&quot;) 	              + &quot;,&quot;;//文件編號
			    str1 += hm.get(&quot;appname&quot;) 	          + &quot;,&quot;;//填單人姓名				
			    str1 += hm.get(&quot;dptno&quot;) 	      + &quot;,&quot;;//當時認證的部門
				var v_area = &quot;MEMT1&quot;;
				if(v_factory==&quot;TGCE&quot;){
					v_area = &quot;MEMT1&quot;;
				}else if(v_factory==&quot;SGCE&quot;){
					v_area = &quot;MEMS1&quot;;
				}else if(v_factory==&quot;CGCE&quot;){
					v_area = &quot;MEMC1&quot;;
				}else if(v_factory==&quot;HGCE&quot;){	
					v_area = &quot;MEMH1&quot;;
				}
				var v_member = Client.getMemberByID(v_area+hm.get(&quot;userid&quot;));
				var dpt_new = &quot;&quot;;
				if(v_member!=null){					
					var roleID = v_member.getMainRoleID();
					var memDR = v_member.getMemberDR(roleID);
					dpt_new = memDR.getDepartmentName();	//使用者部門名稱
				}
				str1 += dpt_new 	      + &quot;,&quot;;//目前所屬單位
			    str1 += hm.get(&quot;username&quot;)  	      + &quot;,&quot;;//認證人姓名
			    str1 += hm.get(&quot;userid&quot;)  	          + &quot;,&quot;;//認證人工號	
			    str1 += hm.get(&quot;work_type&quot;)  	      + &quot;,&quot;;//認證人班別						
			    str1 += hm.get(&quot;createdate&quot;)          + &quot;,&quot;;//填寫日期
			    str1 += hm.get(&quot;pqe_date&quot;)    	      + &quot;,&quot;;//認證日期	
			    str1 += hm.get(&quot;u_name&quot;) 	          + &quot;,&quot;;//認證單元	
			    str1 += hm.get(&quot;m_name&quot;) 	          + &quot;,&quot;;//認證機台			
			    str1 += hm.get(&quot;u_level&quot;)		      + &quot;,&quot;;//認證類別
			    str1 += hm.get(&quot;return_date&quot;)	      + &quot;,&quot;;//產品認證日期
			pw.println(str1);
			}catch(e){}
	}//for i

   }else if(temp==&quot;2&quot;){	
	   try{
	     var sql = &quot; select a.return_date,a.ok,a.fail_insid,a.fail_flag,a.fail_date,a.fail_sn,a.ITEM115,a.ITEM155,a.print_flag,a.sn,a.dptno,a.appname,a.username,a.userid,a.work_type,a.createdate,a.pqe_date,a.u_name,a.m_name,a.u_level,a.INSID&quot;;
             sql +=&quot; from A_BAS_ALLDATA_V a	&quot;;
             sql +=&quot; where a.ITEM155 =&apos;false&apos;&quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (a.fail_flag is null or a.fail_flag =&apos;N&apos;)&quot;;
			 }
             sql +=  getQueryConditionExt_BAS(&quot;3&quot;); 
             sql +=&quot; and a.area =&apos;&quot;+ v_factory + &quot;&apos;&quot;;			 
             sql +=&quot; and a.ok is not null&quot;;
	         sql +=&quot; and a.return_date is not null&quot;;		
			 sql +=&quot; and a.u_level in ( select max(b.u_level) from A_BAS_ALLDATA_V b where b.return_date IS NOT NULL and  b.ITEM155 =&apos;false&apos; and b.ok is not null  and a.userid= b.userid &quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; AND (b.fail_flag IS NULL  or b.fail_flag=&apos;P&apos; OR b.fail_flag = &apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and b.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;
             sql +=&quot; and a.u_name in ( select min(c.u_name) from A_BAS_ALLDATA_V c where c.return_date IS NOT NULL and  c.ITEM155 =&apos;false&apos; and c.ok is not null  and a.userid= c.userid  &quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (c.fail_flag is null  or c.fail_flag=&apos;P&apos; or c.fail_flag =&apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and a.u_level=c.u_level and c.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot; )&quot;;
             sql +=&quot; and a.return_date in (  select min(d.return_date) from A_BAS_ALLDATA_V d where d.return_date IS NOT NULL and  d.ITEM155 =&apos;false&apos; and d.ok is not null  and a.userid= d.userid  &quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (d.fail_flag is null  or d.fail_flag=&apos;P&apos; or d.fail_flag =&apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and a.u_name=d.u_name and a.u_level=d.u_level and d.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;
             sql +=&quot; and a.createdate in (  select min(e.createdate) from A_BAS_ALLDATA_V e where e.return_date IS NOT NULL and  e.ITEM155 =&apos;false&apos; and e.ok is not null and a.userid= e.userid  &quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (e.fail_flag is null  or e.fail_flag=&apos;P&apos; or e.fail_flag =&apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and a.u_name=e.u_name and a.u_level=e.u_level and e.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;		
			 sql +=&quot; order by a.dptno,a.userid,a.pqe_date,a.u_name,a.m_name,a.u_level&quot;;			 
			 
//             sql +=&quot; and a.u_level in (select max(b.u_level) from A_BAS_ALLDATA_V b where b.ITEM155 =&apos;false&apos; and b.ok is not null and (b.fail_flag is null or b.fail_flag !=&apos;Y&apos;) and a.userid= b.userid and b.area =&apos;&quot;+ v_factory.substr(1,4)+&quot;&apos;)&quot;;
//			 sql +=&quot; and a.u_level in (select max(b.u_level) from A_BAS_ALLDATA_V b where b.ITEM155 =&apos;false&apos; and b.ok is not null  and (b.fail_flag is null or b.fail_flag !=&apos;Y&apos;) and a.userid= b.userid and b.area =&apos;&quot;+ v_factory + &quot;&apos;&quot;;
//             sql +=&quot; and (b.u_name,b.u_level) in (select min(c.u_name),c.u_level from A_BAS_ALLDATA_V c where c.ITEM155 =&apos;false&apos; and c.ok is not null and (c.fail_flag is null or c.fail_flag !=&apos;Y&apos;) and b.userid= c.userid and c.area =&apos;&quot;+ v_factory + &quot;&apos;&quot;;
//             sql +=&quot; group by c.u_level) &quot;;
//             sql +=&quot; and a.return_date in ( &quot;;
//             sql +=&quot; select min(d.return_date) from A_BAS_ALLDATA_V d where d.ITEM155 =&apos;false&apos; and d.ok is not null  and (d.fail_flag is null or d.fail_flag !=&apos;Y&apos;) and a.userid= d.userid  and a.u_level=d.u_level and d.area =&apos;&quot;+ v_factory + &quot;&apos;) &quot;;
//             sql +=&quot; ) &quot;; 
//             sql +=&quot; order by a.dptno,a.userid,a.pqe_date,a.u_name,a.m_name,a.u_level &quot;;
		var vec = Client.SQLloadValue(sql);
		Client.addDebugLog(&quot;下載最高階資訊sql==&quot;+sql);
		Client.setLocalObject(&quot;vec&quot;,vec);
      }catch(e){				
      }
	  if(vec.size()&gt;0){	   
	   	   for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
			
			var str1 = i + 1    				      + &quot;,&quot;; //序				
			    str1 += hm.get(&quot;sn&quot;) 	              + &quot;,&quot;;//文件編號
			    str1 += hm.get(&quot;appname&quot;) 	          + &quot;,&quot;;//填單人姓名				
			    str1 += hm.get(&quot;dptno&quot;) 	          + &quot;,&quot;;//部門
			    str1 += hm.get(&quot;username&quot;)  	      + &quot;,&quot;;//認證人姓名
			    str1 += hm.get(&quot;userid&quot;)  	          + &quot;,&quot;;//認證人工號	
			    str1 += hm.get(&quot;work_type&quot;)  	      + &quot;,&quot;;//認證人班別						
			    str1 += hm.get(&quot;createdate&quot;)          + &quot;,&quot;;//填寫日期
			    str1 += hm.get(&quot;pqe_date&quot;)    	      + &quot;,&quot;;//認證日期	
			    str1 += hm.get(&quot;u_name&quot;) 	          + &quot;,&quot;;//認證單元	
			    str1 += hm.get(&quot;m_name&quot;) 	          + &quot;,&quot;;//認證機台			
			    str1 += hm.get(&quot;u_level&quot;)		      + &quot;,&quot;;//認證類別
			    str1 += hm.get(&quot;return_date&quot;)	      + &quot;,&quot;;//產品認證日期
			pw.println(str1);
			}catch(e){}
	       }//for i
      }
   }else if(temp==&quot;3&quot;){
	   
    try{


 var sql = &quot; select a.return_date,a.ok,a.fail_insid,a.fail_flag,a.fail_date,a.fail_sn,a.ITEM115,a.ITEM155,a.print_flag,a.sn,a.dptno,a.appname,a.username,a.userid,a.work_type,a.createdate,a.pqe_date,a.u_name,a.m_name,a.u_level,a.INSID&quot;;
             sql +=&quot; from A_BAS_ALLDATA_V a	&quot;;
             sql +=&quot; where a.ITEM155 =&apos;false&apos;&quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (a.fail_flag is null or a.fail_flag=&apos;P&apos; or a.fail_flag =&apos;N&apos;) &quot;;
			 }
             sql +=  getQueryConditionExt_BAS(&quot;3&quot;); 
             sql +=&quot; and a.area =&apos;&quot;+ v_factory + &quot;&apos;&quot;;			 
             sql +=&quot; and a.ok is not null&quot;;
             sql +=&quot; and a.return_date is not null&quot;;		
			 sql +=&quot; and a.u_level in ( select max(b.u_level) from A_BAS_ALLDATA_V b where b.return_date IS NOT NULL and b.ITEM155 =&apos;false&apos; and b.ok is not null  and a.userid= b.userid &quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; AND (b.fail_flag IS NULL  or b.fail_flag=&apos;P&apos; OR b.fail_flag = &apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and b.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;
             sql +=&quot; and a.return_date in (  select min(d.return_date) from A_BAS_ALLDATA_V d where d.return_date IS NOT NULL and d.ITEM155 =&apos;false&apos; and d.ok is not null  and a.userid= d.userid  &quot;;
			 if(ckbEDate == &quot;false&quot;){
			 sql +=&quot; and (d.fail_flag is null  or d.fail_flag=&apos;P&apos; or d.fail_flag =&apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and a.u_level=d.u_level and d.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;
			 sql +=&quot; and a.createdate in (  select min(e.createdate) from A_BAS_ALLDATA_V e where e.return_date IS NOT NULL and  e.ITEM155 =&apos;false&apos; and e.ok is not null and a.userid= e.userid  &quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (e.fail_flag is null  or e.fail_flag=&apos;P&apos; or e.fail_flag =&apos;N&apos;)&quot;; 
			 }
			 sql +=&quot; and a.return_date =e.return_date and a.u_level=e.u_level and e.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;		
			 sql +=&quot; and a.u_name in ( select min(c.u_name) from A_BAS_ALLDATA_V c where c.return_date IS NOT NULL and  c.ITEM155 =&apos;false&apos; and c.ok is not null  and a.userid= c.userid  &quot;; 
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (c.fail_flag is null  or c.fail_flag=&apos;P&apos; or c.fail_flag =&apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and a.u_level=c.u_level and a.return_date =c.return_date and a.createdate =c.createdate and c.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot; )&quot;;
			 sql +=&quot; order by a.dptno,a.userid,a.pqe_date,a.u_name,a.m_name,a.u_level&quot;;		
		
		var vec = Client.SQLloadValue(sql);
		//Client.addDebugLog(&quot;基本功最高認證類別sql=&quot;+sql);
		Client.setLocalObject(&quot;vec&quot;,vec);
      }catch(e){				
     }
     if(vec.size()&gt;0){	   
	   for (var i = 0; i &lt; vec.size(); i++) {
			try{
//				Client.addDebugLog(&quot;基本功多能功匯出第&quot;+i+&quot;筆&quot;);
			var hm = vec.get(i);
			var temp =&quot;0&quot;; //初始化
	
			var v_leaveflag =&quot;&quot;;
			var resign_date = &quot;&quot;;
			if(v_factory==&quot;TGCE&quot;){
				try{
					var vSQL = &quot;select leaveflag from empm140 where empno=&apos;&quot;+ hm.get(&quot;userid&quot;) +&quot;&apos; ;&quot;;
					var prjList = conn.loadValue(vSQL);
					var v_count =0;
					
					if(prjList.size()&gt;0){                     
				      v_leaveflag =prjList.get(0).get(&quot;leaveflag&quot;);					  
					}
				}catch(e){}				
			}else{
				if(v_factory==&quot;SGCE&quot;){
					var v_memid = &quot;MEMS1&quot;+hm.get(&quot;userid&quot;);
				}else if(v_factory==&quot;CGCE&quot;){
					var v_memid = &quot;MEMC1&quot;+hm.get(&quot;userid&quot;);
				}else if(v_factory==&quot;HGCE&quot;){	
					var v_memid = &quot;MEMH1&quot;+hm.get(&quot;userid&quot;);
				}
				var v_member = Client.getMemberByID(v_memid);
				if(v_member!=null &amp;&amp; v_member.isResign()){
					v_leaveflag = &quot;1&quot;;
					if(v_factory==&quot;HGCE&quot;){
						resign_date = v_member.getResignDate();
					}
				}else{
				}
				
			}
					var str1 = i + 1    				    + &quot;,&quot;; //序				
					
					str1 += hm.get(&quot;dptno&quot;) 	         + &quot;,&quot;;//部門
					str1 += hm.get(&quot;username&quot;)  	        + &quot;,&quot;;//填單人姓名	
					str1 += hm.get(&quot;userid&quot;)  	         + &quot;,&quot;;//認證人工號					
				if(v_leaveflag ==&quot;1&quot;){
					str1 += &quot;離職&quot;                       + &quot;,&quot;;//人員狀態	
				}else if(v_leaveflag ==&quot;2&quot;){
					str1 += &quot;留停&quot;                       + &quot;,&quot;;//人員狀態							
				}else{
					str1 += &quot;在職&quot;                   + &quot;,&quot;;//人員狀態
				}
				if(v_factory==&quot;HGCE&quot;){
					str1 += resign_date                   + &quot;,&quot;;//離職日期
				}
			    str1 += hm.get(&quot;createdate&quot;)         + &quot;,&quot;;//填寫日期
			    str1 += hm.get(&quot;pqe_date&quot;)    	     + &quot;,&quot;;//認證日期	
			    str1 += hm.get(&quot;return_date&quot;)        + &quot;,&quot;;//產品認證日期				
			    str1 += hm.get(&quot;u_name&quot;) 	         + &quot;,&quot;;//認證單元	
			    str1 += hm.get(&quot;m_name&quot;) 	         + &quot;,&quot;;//認證機台			
			    str1 += hm.get(&quot;u_level&quot;)		     + &quot;,&quot;;//最高認證類別
			
				if(hm.get(&quot;u_level&quot;)==&quot;E3&quot;){
					if(v_factory==&quot;TGCE&quot;){
						var temp = &quot;7200&quot;; //E3認證獎金
					}else{
						var temp = &quot;400&quot;; //E3認證獎金
					}
                   
				}else if(hm.get(&quot;u_level&quot;)==&quot;E2&quot;){
                   if(v_factory==&quot;TGCE&quot;){
						var temp = &quot;3600&quot;; //E2認證獎金
					}else{
						var temp = &quot;300&quot;; //E2認證獎金
					}
				}else if(hm.get(&quot;u_level&quot;)==&quot;E1&quot;){
                   if(v_factory==&quot;TGCE&quot;){
						var temp = &quot;1200&quot;; //E1認證獎金
					}else{
						var temp = &quot;200&quot;; //E1認證獎金
					}
				}else{
					var temp =&quot;0&quot;; //E0認證獎金
				}
				str1 += temp		            + &quot;,&quot;;//最高認證獎金
				
				if(v_factory==&quot;TGCE&quot;){
				try{

//	             var sql = &quot; select a.u_level,count(*) count&quot;;
//                     sql +=&quot; from A_BAS_ALLDATA_V a	&quot;;
//                     sql +=&quot; where a.ITEM155 =&apos;false&apos;&quot;;
//                     sql +=&quot; and (a.fail_flag is null or a.fail_flag =&apos;N&apos;)&quot;;
//                     sql +=  getQueryConditionExt_BAS(&quot;3&quot;); 
//                     sql +=&quot; and a.area =&apos;&quot;+ v_factory+&quot;&apos;&quot;;			 
//                     sql +=&quot; and a.ok is not null&quot;;
//                     sql +=&quot; and a.return_date is not null&quot;;
//                     sql +=&quot; and a.u_level&lt;&gt;&apos;E0&apos;&quot;;		 
//                     sql +=&quot; and a.userid=&apos;&quot;+ hm.get(&quot;userid&quot;) +&quot;&apos;&quot;;		 
//                     sql +=&quot; and a.u_level in (select max(b.u_level) from A_BAS_ALLDATA_V b where b.return_date IS NOT NULL and  b.ITEM155 =&apos;false&apos; and b.ok is not null  and a.userid= b.userid and (b.fail_flag is null or b.fail_flag =&apos;N&apos;) and a.u_name = b.u_name and (a.m_name = b.m_name or (a.m_name  is null and  b.m_name is null))  and b.area =&apos;&quot;+ v_factory +&quot;&apos;&quot;+ getQueryConditionExt_BAS(&quot;3&quot;) +&quot;)&quot;;
//
					var sql = &quot; select a.u_level,count(*) count&quot;;
                     sql +=&quot; from A_BAS_ALLDATA_V a	&quot;;
                     sql +=&quot; where a.ITEM155 =&apos;false&apos;&quot;; 
					 if(ckbEDate == &quot;false&quot;){
						 sql +=&quot; and (a.fail_flag is null or a.fail_flag=&apos;P&apos; or a.fail_flag =&apos;N&apos;) &quot;;
					 }
                     sql +=  getQueryConditionExt_BAS(&quot;3&quot;); 
                     sql +=&quot; and a.area =&apos;&quot;+ v_factory+&quot;&apos;&quot;;			 
                     sql +=&quot; and a.ok is not null&quot;;
                     sql +=&quot; and a.return_date is not null&quot;;
                     sql +=&quot; and a.u_level&lt;&gt;&apos;E0&apos;&quot;;		 
                     sql +=&quot; and a.userid=&apos;&quot;+ hm.get(&quot;userid&quot;) +&quot;&apos;&quot;;		 
                     sql +=&quot; and a.u_level in (select max(b.u_level) from A_BAS_ALLDATA_V b where b.return_date IS NOT NULL and  b.ITEM155 =&apos;false&apos; and b.ok is not null  and a.userid= b.userid  &quot;;
					 if(ckbEDate == &quot;false&quot;){
						 sql +=&quot; and (b.fail_flag is null  or b.fail_flag=&apos;P&apos; or b.fail_flag =&apos;N&apos;) &quot;;
					 }
					 sql +=&quot; and a.u_name = b.u_name and (a.m_name = b.m_name or (a.m_name  is null and  b.m_name is null))  and b.area =&apos;&quot;+ v_factory +&quot;&apos;&quot;+ getQueryConditionExt_BAS(&quot;3&quot;) +&quot;)&quot;;

			 sql +=&quot; group by a.u_level &quot;;
			 sql +=&quot; order by a.u_level desc&quot;;		
Client.addDebugLog(&quot;基本功最高認證類別金額sql33=&quot;+sql);				 
		         var vec1 = Client.SQLloadValue(sql);
		             Client.setLocalObject(&quot;vec1&quot;,vec1);
           }catch(e){				
           }   
		     if(vec1.size()&gt;0){
				var e3_count =0;     
				var e3_prize =0; 
				var e2_count =0;     
				var e2_prize =0; 
				var e1_count =0;     
				var e1_prize =0; 	
						 
             for (var j = 0; j &lt; vec1.size(); j++) {		 
			      try{
			          var hm1 = vec1.get(j);
					      if(hm1.get(&quot;u_level&quot;)==&quot;E3&quot;){
							 e3_count =  hm1.get(&quot;count&quot;);      //E3認證類別
						  }
						  if(hm1.get(&quot;u_level&quot;)==&quot;E2&quot;){
							 e2_count =  hm1.get(&quot;count&quot;);      //E2認證類別
						  }
						  if(hm1.get(&quot;u_level&quot;)==&quot;E1&quot;){
							 e1_count =  hm1.get(&quot;count&quot;);      //E1認證類別						  				 
						  }				
			      }catch(e){}
	         }//for i
			 
			}else{
				             var e3_count =0;     
//				             var e3_prize =0; 
				             var e2_count =0;     
//				             var e2_prize =0; 
				             var e1_count =0;     
//				             var e1_prize =0; 					 
			}	
			
			if(hm.get(&quot;u_level&quot;)==&quot;E3&quot; &amp;&amp; e3_count &gt;0){
                   e3_count -- ; //E3認證計數
			}else if(hm.get(&quot;u_level&quot;)==&quot;E2&quot; &amp;&amp; e2_count &gt;0){
                   e2_count -- ; //E2認證計數
			}else if(hm.get(&quot;u_level&quot;)==&quot;E1&quot; &amp;&amp; e1_count &gt;0){
                   e1_count -- ; //E1認證計數
			}

				
				str1 += e3_count	             + &quot;,&quot;;//E3認證類別
				str1 += e3_count * 1800	         + &quot;,&quot;;//E3認證獎金(多人功)	
				
				str1 += e2_count	             + &quot;,&quot;;//E2認證類別
				str1 += e2_count * 1200          + &quot;,&quot;;//E2認證獎金(多人功)	
				
				str1 += e1_count	             + &quot;,&quot;;//E1認證類別
				str1 += e1_count * 600           + &quot;,&quot;;//E1認證獎金(多人功)	
				
			
			var total =java.lang.Integer.parseInt(temp); 
				total +=java.lang.Integer.parseInt(e3_count * 1800); //E3認證獎金(多人功)	
				total +=java.lang.Integer.parseInt(e2_count * 1200); //E2認證獎金(多人功)				
				total +=java.lang.Integer.parseInt(e1_count * 600);  //E1認證獎金(多人功)	
				str1 += total                                     + &quot;,&quot;;//總計
			}else{
				var total =java.lang.Integer.parseInt(temp);
				var olde = 0;
				var sqle = &quot;select userid from a_bas_olde where area=&apos;&quot;+v_factory+&quot;&apos; and userid=&apos;&quot;+hm.get(&quot;userid&quot;)+&quot;&apos;&quot;;
				try{
					var vece = Client.SQLloadValue(sqle);
					if(vece!=null &amp;&amp; vece.size()&gt;0){
						olde = 60;
					}
					str1 += olde                                     + &quot;,&quot;;//老E1
					str1 += total+olde                                     + &quot;,&quot;;//總計
				}catch(e){
				}
				
			}
					
			
			pw.println(str1);
			}catch(e){}
	     }//for i	
	  }	 
	}else if(temp==&quot;4&quot;){
		   for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
			var temp =&quot;0&quot;; //初始化
			
			var str1 = i + 1    				+ &quot;,&quot;; //序							
//			    str1 += hm.get(&quot;dptno&quot;) 	    + &quot;,&quot;;//部門						
			    str1 += hm.get(&quot;u_name&quot;) 	    + &quot;,&quot;;//認證單元	
			    str1 += hm.get(&quot;m_name&quot;) 	    + &quot;,&quot;;//認證機台			
			
            try{
				 var v_factory = Form.getValue(&quot;Factory&quot;); 
	             var sql = &quot; select a.u_level,count(*) count&quot;;
                     sql +=&quot; from A_BAS_ALLDATA_V a	&quot;;
                     sql +=&quot; where a.ITEM155 =&apos;false&apos;&quot;;
					 if(ckbEDate == &quot;false&quot;){
						 sql +=&quot; and (a.fail_flag is null or a.fail_flag !=&apos;Y&apos;)&quot;;
					 }
                     sql +=  getQueryConditionExt_BAS(&quot;3&quot;); 
                     sql +=&quot; and a.area =&apos;&quot;+ v_factory + &quot;&apos;&quot;;			 
                     sql +=&quot; and a.ok is not null&quot;;
                     sql +=&quot; and a.return_date is not null&quot;;
                     //sql +=&quot; and a.u_no=&apos;&quot;+ hm.get(&quot;u_no&quot;) +&quot;&apos;&quot;;	
					 if(hm.get(&quot;m_name&quot;) !=&quot;&quot;){
                     sql +=&quot; and a.m_name=&apos;&quot;+ hm.get(&quot;m_name&quot;) +&quot;&apos;&quot;;		 					 
					 }else{
                     sql +=&quot; and a.m_name is null&quot;;		 					 					 
					 }
                     sql +=&quot; and a.u_level in (select max(b.u_level) from A_BAS_ALLDATA_V b where b.return_date IS NOT NULL and  b.ITEM155 =&apos;false&apos; and b.ok is not null &quot;;
					 if(ckbEDate == &quot;false&quot;){
						 sql +=&quot; and (b.fail_flag is null  or b.fail_flag=&apos;P&apos; or b.fail_flag !=&apos;Y&apos;) &quot;;
					 }
					 sql +=&quot; and a.userid= b.userid and a.u_name = b.u_name and (a.m_name = b.m_name or (a.m_name  is null and  b.m_name is null))  and b.area =&apos;&quot;+ v_factory + &quot;&apos;)&quot;;
//			 sql +=&quot; and (a.u_name,a.u_level) in ( &quot;;
//             sql +=&quot; select min(b.u_name),b.u_level from A_BAS_ALLDATA_V b where b.ITEM155 =&apos;false&apos; and b.ok is not null &quot;;
//             sql +=&quot; and (b.fail_flag is null or b.fail_flag !=&apos;Y&apos;) and a.userid= b.userid and b.area =&apos;&quot;+ v_factory.substr(1,4)+&quot;&apos; &quot;;
//             sql +=&quot; and b.return_date in ( &quot;;
//             sql +=&quot; select min(c.return_date) from A_BAS_ALLDATA_V c where c.ITEM155 =&apos;false&apos; and c.ok is not null &quot;;
//             sql +=&quot; and (c.fail_flag is null or c.fail_flag !=&apos;Y&apos;) and b.userid= c.userid and c.area =&apos;&quot;+ v_factory.substr(1,4)+&quot;&apos; &quot;;
//             sql +=&quot; and c.u_level in ( &quot;;
//             sql +=&quot; select max(d.u_level) from A_BAS_ALLDATA_V d where d.ITEM155 =&apos;false&apos; and d.ok is not null &quot;;
//             sql +=&quot; and (d.fail_flag is null or d.fail_flag !=&apos;Y&apos;) and c.userid= d.userid and d.area =&apos;&quot;+ v_factory.substr(1,4)+&quot;&apos; &quot;;
//             sql +=&quot;  ) &quot;;
//             sql +=&quot; ) &quot;;
//	         sql +=&quot; group by b.u_level &quot;;  
//             sql +=&quot; ) &quot;;
			         sql +=&quot; group by a.u_level&quot;;	
			         sql +=&quot; order by a.u_level desc&quot;;						 
		         var vec1 = Client.SQLloadValue(sql);
		             Client.setLocalObject(&quot;vec1&quot;,vec1);
           }catch(e){				
           }   
		     if(vec1.size()&gt;0){
				var e0_count =0;   				 
				var e1_count =0;     
				var e2_count =0;     
				var e3_count =0;     
						 
             for (var j = 0; j &lt; vec1.size(); j++) {		 
			      try{
			          var hm1 = vec1.get(j);
                          if(hm1.get(&quot;u_level&quot;)==&quot;E0&quot;){
							 e0_count =  hm1.get(&quot;count&quot;);      //E0認證類別	
						  }					  
					      if(hm1.get(&quot;u_level&quot;)==&quot;E1&quot;){
							 e1_count =  hm1.get(&quot;count&quot;);      //E1認證類別	
						  }
						  if(hm1.get(&quot;u_level&quot;)==&quot;E2&quot;){
							 e2_count =  hm1.get(&quot;count&quot;);      //E2認證類別
						  }
						  if(hm1.get(&quot;u_level&quot;)==&quot;E3&quot;){
							 e3_count =  hm1.get(&quot;count&quot;);      //E3認證類別					  				 
						  }				
			      }catch(e){}
	         }//for i
			 
			}else{
				             var e0_count =0;    				
				             var e1_count =0;     
				             var e2_count =0;     
				             var e3_count =0;     				 
			}	
						 	 str1 += e0_count	              + &quot;,&quot;;//E0認證類別			
						 	 str1 += e1_count	              + &quot;,&quot;;//E1認證類別
						     str1 += e2_count	              + &quot;,&quot;;//E2認證類別
							 str1 += e3_count	              + &quot;,&quot;;//E3認證類別

			pw.println(str1);
			}catch(e){}
	     }//for i
	}else if(temp==&quot;5&quot;){
	  var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	  var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);	
      if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; &quot;true&quot;.equals(ckbEDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		var eDate = Form.getValue(&quot;eDate&quot;);
		// 將日期轉為 mm-dd-yyyy
//        yyyy-mm-dd		
	    var v_sDate = sDate.substring(0,4)+&quot;-&quot;+sDate.substring(5,7)+&apos;-&apos;+ sDate.substring(8);			
	    var v_eDate = eDate.substring(0,4)+&quot;-&quot;+eDate.substring(5,7)+&apos;-&apos;+ eDate.substring(8);		
//		var v_sDate = sDate.substring(5,7)+&apos;/&apos;+sDate.substring(8,10)+&apos;/&apos;+sDate.substring(0,4);
//		var v_eDate = eDate.substring(5,7)+&apos;/&apos;+eDate.substring(8,10)+&apos;/&apos;+eDate.substring(0,4);		
	  }
	        try{
		        var vSQL = &quot; select dptno,empno,cname,leaveworkday,leaveflag from empm140 &quot;;
                    vSQL +=&quot; where leaveflag in(&apos;1&apos;,&apos;2&apos;)&quot;;
                    vSQL +=&quot; and leaveworkday &gt;= &apos;&quot; + v_sDate + &quot;&apos;&quot; + &quot; and leaveworkday &lt;= &apos;&quot; + v_eDate + &quot;&apos;&quot;;
                    vSQL +=&quot; union&quot;;
                    vSQL +=&quot; select dptno,empno,cname,leaveworkday,leaveflag from empm020&quot;;
                    vSQL +=&quot; where leaveflag in(&apos;1&apos;,&apos;2&apos;)&quot;;
                    vSQL +=&quot; and leaveworkday &gt;= &apos;&quot; + v_sDate + &quot;&apos;&quot; + &quot; and leaveworkday &lt;= &apos;&quot; + v_eDate + &quot;&apos;&quot;;	
		        var vec = conn.loadValue(vSQL);		  
		    }catch(e){}	
			
       if(vec.size()&gt;0){
		   for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
			var v_leaveflag =hm.get(&quot;leaveflag&quot;);	
			
			var str1 = i + 1    				+ &quot;,&quot;; //序
			    str1 += hm.get(&quot;dptno&quot;) 	    + &quot;,&quot;;//部門						
			    str1 += hm.get(&quot;empno&quot;) 	    + &quot;,&quot;;//工號		
            try{
	             var sql = &quot; select count(*) count&quot;;
                     sql +=&quot; from A_BAS_ALLDATA_V a	&quot;;
                     sql +=&quot; where a.ITEM155 =&apos;false&apos;&quot;;
                     sql +=&quot; and (a.fail_flag is null  or a.fail_flag=&apos;P&apos; or a.fail_flag !=&apos;Y&apos;)&quot;;
                     sql +=&quot; and a.area =&apos;&quot;+ v_factory + &quot;&apos;&quot;;			 
                     sql +=&quot; and a.ok is not null&quot;;
                     sql +=&quot; and a.userid=&apos;&quot;+ hm.get(&quot;empno&quot;) +&quot;&apos;&quot;;			 
                     sql +=&quot; and a.return_date is not null&quot;;						 
		         var vec1 = Client.SQLloadValue(sql);
		             Client.setLocalObject(&quot;vec1&quot;,vec1);
           }catch(e){				
           }   
		     if(vec1.size()&gt;0){
		        if(v_leaveflag  == &quot;1&quot;){
			    str1 += hm.get(&quot;cname&quot;)+&quot;(離職)&quot;	    + &quot;,&quot;;//姓名								
		        }else{				 
			    str1 += hm.get(&quot;cname&quot;)+&quot;(留停)&quot;	    + &quot;,&quot;;//姓名			
				}
			}	
			    str1 += java.text.SimpleDateFormat(&quot;yyyy/MM/dd&quot;).format(hm.get(&quot;leaveworkday&quot;)).substring(0,10) + &quot;,&quot;;//離職日期		
			    str1 += vec1.get(0).get(&quot;count&quot;)	+ &quot;,&quot;;//認證計數				
			pw.println(str1);
			}catch(e){}
	      }//for i
		} 
	}else if(temp==&quot;6&quot;){
	  var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	  var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);	
      if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; &quot;true&quot;.equals(ckbEDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		var eDate = Form.getValue(&quot;eDate&quot;);
	  }	
        try{
	     var sql = &quot; select a.*,b.ITEM1 u_name ,b.ITEM2 m_name,b.ITEM3 u_level from ART01101300263603615_INS a, ART01101300263603615ITEM39 b &quot;;
             sql +=&quot; where a.ITEM155 =&apos;false&apos;&quot;;
             if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; &quot;true&quot;.equals(ckbEDate)){				 
             sql +=&quot; and a.ITEM49 &gt;= &apos;&quot; + sDate + &quot;&apos;&quot; + &quot; and a.ITEM49 &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;
			 } 
             sql +=&quot; and a.ITEM2 =&apos;(&quot;+ v_factory + &quot;)&apos;&quot;;	
//             sql +=&quot; and b.ITEM10&lt;&gt;&apos;認證中&apos;&quot;;   			 
             sql +=&quot; and a.insid = b.insid&quot;;		
Client.addDebugLog(&quot;基本功下載下崗資訊sql=&quot;+sql);	 			 
		var vec = Client.SQLloadValue(sql);
		  Client.setLocalObject(&quot;vec&quot;,vec);
        }catch(e){				
        }
       if(vec.size()&gt;0){
		for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);
			var task = getTaskByInsID(hm.get(&quot;INSID&quot;));
			 var processname = &quot;&quot;;
			 var realExecutor = &quot;&quot;;
			   if (task != null){
				   processname = task.getProcessName();
				   var realExecutorMemID = task.getRealExecutor();
				   var memberRecord = Client.getMemberByID(realExecutorMemID);
				   realExecutor = memberRecord.getName();
				if(&quot;true&quot; == hm.get(&quot;ITEM155&quot;)){
					processname = &quot;作廢&quot;;
					realExecutor = &quot;&quot;;
				}else if(&quot;complete&quot; == Client.getTask(task.getRootID()).getTaskState() ){
					processname = &quot;已結案&quot;;
					realExecutor = &quot;&quot;;
				}				   
				   
			   }
			
			var str1 = i + 1    				  + &quot;,&quot;;//序
			    str1 += processname   		      + &quot;,&quot;;//目前關卡
			    str1 += realExecutor  	          + &quot;,&quot;;//目前處理者					
			    str1 += hm.get(&quot;ITEM62&quot;) 	      + &quot;,&quot;;//文件編號
			    str1 += hm.get(&quot;ITEM144&quot;) 	      + &quot;,&quot;;//填單人姓名				
			    str1 += hm.get(&quot;ITEM325&quot;) 	      + &quot;,&quot;;//部門
			    str1 += hm.get(&quot;ITEM318&quot;)  	      + &quot;,&quot;;//下崗人姓名
			    str1 += hm.get(&quot;ITEM322&quot;)  	      + &quot;,&quot;;//下崗人工號	
			    str1 += hm.get(&quot;ITEM46&quot;)  	      + &quot;,&quot;;//下崗人班別						
			    str1 += hm.get(&quot;ITEM12&quot;)          + &quot;,&quot;;//填寫日期
				
			    if(hm.get(&quot;ITEM23&quot;)==&quot;true&quot;){	
			    str1 += &quot;單次下崗&quot;	              + &quot;,&quot;;//下崗類別
				}else{
			    str1 += &quot;全部下崗&quot;	              + &quot;,&quot;;//下崗類別
			    }	
        		str1 +=  hm.get(&quot;ITEM10&quot;)	      + &quot;,&quot;;//缺失類別				
			    if(hm.get(&quot;ITEM15&quot;)==&quot;true&quot;){	
			    str1 += &quot;一次缺失&quot;	              + &quot;,&quot;;//下崗缺失型態
				}else{
			    str1 += &quot;三次缺失&quot;	              + &quot;,&quot;;//下崗缺失型態
			    }					
			    str1 +=  hm.get(&quot;ITEM9&quot;)	      + &quot;,&quot;;//缺失細項				
			    str1 +=  hm.get(&quot;ITEM49&quot;)	      + &quot;,&quot;;//下崗日期
				var msg1 = hm.get(&quot;ITEM57&quot;).replaceAll(&quot; &quot;,&quot;&quot;).replaceAll(&quot;\n&quot;,&quot;&quot;).replaceAll(&quot;\r&quot;,&quot;&quot;).replaceAll(&quot;,&quot;,&quot;.&quot;);
		        str1 +=  msg1 	                  + &quot;,&quot;;//備註				 
			    str1 +=  hm.get(&quot;u_level&quot;)	      + &quot;,&quot;;//認證階段					
			    str1 +=  hm.get(&quot;u_name&quot;)	      + &quot;,&quot;;//認證課程				
			    str1 +=  hm.get(&quot;m_name&quot;)	      + &quot;,&quot;;//認證機台
				
			pw.println(str1);
			}catch(e){}
	     }//for i
	   } 
	}else if(temp==&quot;7&quot;){
	  var ckbSDate = Form.getValue(&quot;ckbSDate&quot;);
	  var ckbEDate = Form.getValue(&quot;ckbEDate&quot;);	
      if (&quot;true&quot;.equals(ckbSDate) &amp;&amp; &quot;true&quot;.equals(ckbEDate)){	
		var sDate = Form.getValue(&quot;sDate&quot;);	
		var eDate = Form.getValue(&quot;eDate&quot;);
	  }			
        loadLibrary(&quot;com.gce.Common.Util&quot;);
        var ls_memt = get_ls_memt(v_factory);
        try{
           var sql = &quot; select a.*,b.workplace from A_BAS_FAIL a,mem_geninf b &quot;;
               sql +=&quot; where &apos;&quot;+ ls_memt + &quot;&apos;||a.user_id=b.memid&quot;;	
               sql +=&quot; and fail_date &gt;= &apos;&quot; + sDate + &quot;&apos;&quot; + &quot; and fail_date &lt;= &apos;&quot; + eDate + &quot;&apos;&quot;;			   
		       sql +=&quot; and a.area=&apos;&quot;+ v_factory +&quot;&apos; and a.effective=&apos;false&apos;&quot;;			   
	           sql +=&quot; order by a.user_id,a.fail_date desc,a.bas_type,a.type_desc&quot;;  				 
		   var vec = Client.SQLloadValue(sql);
		       Client.setLocalObject(&quot;vec&quot;,vec);
        }catch(e){				
        }
		if(vec.size()&gt;0 ){
		for (var i = 0; i &lt; vec.size(); i++) {
			try{
			var hm = vec.get(i);

			var str1 = i + 1    				         + &quot;,&quot;; //序	
			    str1 += hm.get(&quot;user_id&quot;)  	             + &quot;,&quot;;//工號					
			    str1 += hm.get(&quot;user_name&quot;)  	         + &quot;,&quot;;//姓名				
			    str1 += hm.get(&quot;workplace&quot;).substr(4,3)  + &quot;,&quot;;//部門				
			    str1 +=  hm.get(&quot;fail_date&quot;)	         + &quot;,&quot;;//下崗日期
			    str1 +=  hm.get(&quot;bas_type&quot;)	             + &quot;,&quot;;//下崗缺失型態				
			    str1 += hm.get(&quot;type_desc&quot;)              + &quot;,&quot;;//下崗缺失類別					
	
			pw.println(str1);
			}catch(e){}
	   }//for i
	  } 
	}else if(temp==&quot;8&quot;){
		try{
			var sql = &quot; select a.return_date,a.ok,a.fail_insid,a.fail_flag,a.fail_date,a.fail_sn,a.ITEM115,a.ITEM155,a.print_flag,a.sn,a.dptno,a.appname,a.username,a.userid,a.work_type,a.createdate,a.pqe_date,a.u_name,a.m_name,a.u_level,a.INSID&quot;;
                sql +=&quot; from A_BAS_ALLDATA_V a	&quot;;
				sql +=&quot; where a.ITEM155 =&apos;false&apos;&quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (a.fail_flag is null  or a.fail_flag=&apos;P&apos; or a.fail_flag =&apos;N&apos;) &quot;;
			 }
             sql +=  getQueryConditionExt_BAS(&quot;3&quot;); 
             sql +=&quot; and a.area =&apos;&quot;+ v_factory + &quot;&apos;&quot;;			 
             sql +=&quot; and a.ok is not null&quot;;
             sql +=&quot; and a.return_date is not null&quot;;		
			 sql +=&quot; and a.u_level in ( select max(b.u_level) from A_BAS_ALLDATA_V b where b.return_date IS NOT NULL and b.ITEM155 =&apos;false&apos; and b.ok is not null  and a.userid= b.userid &quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; AND (b.fail_flag IS NULL  or b.fail_flag=&apos;P&apos; OR b.fail_flag = &apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and b.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;
             sql +=&quot; and a.return_date in (  select min(d.return_date) from A_BAS_ALLDATA_V d where d.return_date IS NOT NULL and d.ITEM155 =&apos;false&apos; and d.ok is not null  and a.userid= d.userid  &quot;;
			 if(ckbEDate == &quot;false&quot;){
			 sql +=&quot; and (d.fail_flag is null  or d.fail_flag=&apos;P&apos; or d.fail_flag =&apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and a.u_level=d.u_level and d.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;
			 sql +=&quot; and a.createdate in (  select min(e.createdate) from A_BAS_ALLDATA_V e where e.return_date IS NOT NULL and  e.ITEM155 =&apos;false&apos; and e.ok is not null and a.userid= e.userid  &quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (e.fail_flag is null  or e.fail_flag=&apos;P&apos; or e.fail_flag =&apos;N&apos;)&quot;; 
			 }
			 sql +=&quot; and a.return_date =e.return_date and a.u_level=e.u_level and e.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;		
			 sql +=&quot; and a.u_name in ( select min(c.u_name) from A_BAS_ALLDATA_V c where c.return_date IS NOT NULL and  c.ITEM155 =&apos;false&apos; and c.ok is not null  and a.userid= c.userid  &quot;; 
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (c.fail_flag is null  or c.fail_flag=&apos;P&apos; or c.fail_flag =&apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and a.u_level=c.u_level and a.return_date =c.return_date and a.createdate =c.createdate and c.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot; )&quot;;
			 sql +=&quot; order by a.dptno,a.userid,a.pqe_date,a.u_name,a.m_name,a.u_level&quot;;		
		
			 var vec = Client.SQLloadValue(sql);
			 Client.addDebugLog(&quot;基本功最高認證類別sql8=&quot;+sql);
			 Client.setLocalObject(&quot;vec&quot;,vec);
		}catch(e){				
		}
       var j = 0;
	   
	    if(vec.size()&gt;0){	   
			for (var i = 0; i &lt; vec.size(); i++) {
				try{
					var hm = vec.get(i);				
					var user_name = hm.get(&quot;username&quot;);
					var emp_class = &quot;&quot;;
					var dptno = &quot;&quot;;
					var wktype = &quot;&quot;;
					var leaveworkday = &quot;&quot;;
					var v_leaveflag = &quot;&quot;;
					if(hm.get(&quot;u_level&quot;)!=&quot;E0&quot;){
					try{
						var vsql = &quot;select dptno,cname,wktype,date(leaveworkday) leaveworkday,emp_class,leaveflag from empm020 where empno=&apos;&quot;+ hm.get(&quot;userid&quot;) +&quot;&apos;;&quot;;		        
						var rs = conn.loadValue(vsql);
				
						if(rs.size()&gt;0){
							dptno =rs.get(0).get(&quot;dptno&quot;);
							user_name =rs.get(0).get(&quot;cname&quot;);
							emp_class =rs.get(0).get(&quot;emp_class&quot;);
							wktype =rs.get(0).get(&quot;wktype&quot;);
							leaveworkday  = rs.get(0).get(&quot;leaveworkday&quot;);
							v_leaveflag = rs.get(0).get(&quot;leaveflag&quot;);
//							if(leaveworkday!=&quot;&quot;){
//								leaveworkday = leaveworkday.substring(0,10);
//							}
//						try{
//							var vSQL = &quot;select count(*) count,leaveflag from empm140 where empno=&apos;&quot;+ hm.get(&quot;userid&quot;) +&quot;&apos; group by leaveflag;&quot;;
//							var prjList = conn.loadValue(vSQL);
//							var v_count =0;
//							var v_leaveflag =&quot;&quot;;
//							if(prjList.size()&gt;0){
//								var v_count =prjList.get(0).get(&quot;count&quot;);
//								var v_leaveflag =prjList.get(0).get(&quot;leaveflag&quot;);					  
//							}
//						}catch(e){}
						var edate = Form.getValue(&quot;eDate&quot;);
						if(edate!=&quot;&quot;){
							var Ob_date = new Packages.pase.agenda.MyDate();
							
							var ls_date = Ob_date.add(edate, 28);
							try{							
								var ls_year = ls_date.substring(0,4);
								var ls_month = ls_date.substring(5,7);
								if(ls_month==&quot;02&quot;){
									var date_beg = ls_year + &quot;-&quot; + ls_month + &quot;-01&quot;;
									var date_end = ls_year + &quot;-&quot; + ls_month + &quot;-28&quot;;
								}else{
									var date_beg = ls_year + &quot;-&quot; + ls_month + &quot;-01&quot;;
									var date_end = ls_year + &quot;-&quot; + ls_month + &quot;-30&quot;;
								}
								
								var sqla = &quot;select case when day(chgday)&lt;10 then dptno_u when  day(chgday)&gt;=10 then dptno_o end as dptno  from empm160 where empno=&apos;&quot;+ hm.get(&quot;userid&quot;) +&quot;&apos; and chgday&gt;=&apos;&quot;+date_beg+&quot;&apos; and chgday&lt;&apos;&quot;+date_end+&quot;&apos;;&quot;;
							   // Client.addDebugLog(&quot;sqlaa==&quot;+sqla);
								var veca = conn.loadValue(sqla);							
								if(veca.size()&gt;0){
									dptno =  veca.get(0).get(&quot;dptno&quot;);												  
								}
							}catch(e){}
						}else{
								
						}
						
						
					  
					  var str1 = j + 1    				    + &quot;,&quot;; //序				
					  str1 += hm.get(&quot;dptno&quot;).substring(0,3) 	         + &quot;,&quot;;//認證部門	
					  str1 += dptno 	         + &quot;,&quot;;//部門
			    	
					  str1 += hm.get(&quot;userid&quot;)  	         + &quot;,&quot;;//認證人工號	
					  str1 += user_name  	        + &quot;,&quot;;//填單人姓名	
					  str1 += wktype  	        + &quot;,&quot;;//工作型態
//					  if(v_count &gt;0 &amp;&amp; v_leaveflag ==&quot;1&quot;){
//						  str1 += &quot;離職&quot;                       + &quot;,&quot;;//人員狀態	
//					  }else if(v_count &gt;0 &amp;&amp; v_leaveflag ==&quot;2&quot;){
//						  str1 += &quot;留停&quot;                       + &quot;,&quot;;//人員狀態					
//					  }else if(v_count == 0){
//						  str1 += &quot;在職&quot;	                    + &quot;,&quot;;//人員狀態					
//					  }		
					  if(v_leaveflag ==&quot;1&quot;){
						  str1 += &quot;離職&quot;                       + &quot;,&quot;;//人員狀態	
					  }else if(v_leaveflag ==&quot;2&quot;){
						  str1 += &quot;留停&quot;                       + &quot;,&quot;;//人員狀態					
					  }else{
						  str1 += &quot;在職&quot;	                    + &quot;,&quot;;//人員狀態					
					  }
					  str1 += leaveworkday         + &quot;,&quot;;//離職日期	
			    
			    	  //str1 += hm.get(&quot;pqe_date&quot;)    	     + &quot;,&quot;;//認證日期	
					  str1 += hm.get(&quot;return_date&quot;)        + &quot;,&quot;;//產品認證日期				
					  str1 += hm.get(&quot;u_level&quot;)		     + &quot;,&quot;;//最高認證類別
			
					  //&quot;序,認證部門,部門,工號,姓名,工作型態,在/離職,離職日期,取得資格日期,最高認證類別,E3多能功,E2多能功,E1多能功,身份別
				
				      if(v_factory==&quot;TGCE&quot;){
						  try{
							  var sql = &quot; select a.u_level,count(*) count&quot;;
							  sql +=&quot; from A_BAS_ALLDATA_V a	&quot;;
							  sql +=&quot; where a.ITEM155 =&apos;false&apos;&quot;; 
							  if(ckbEDate == &quot;false&quot;){
								  sql +=&quot; and (a.fail_flag is null or a.fail_flag =&apos;P&apos; or a.fail_flag =&apos;N&apos;) &quot;;
							  }
							  sql +=  getQueryConditionExt_BAS(&quot;3&quot;); 
							  sql +=&quot; and a.area =&apos;&quot;+ v_factory+&quot;&apos;&quot;;			 
							  sql +=&quot; and a.ok is not null&quot;;
							  sql +=&quot; and a.return_date is not null&quot;;
							  sql +=&quot; and a.u_level&lt;&gt;&apos;E0&apos;&quot;;		 
							  sql +=&quot; and a.userid=&apos;&quot;+ hm.get(&quot;userid&quot;) +&quot;&apos;&quot;;		 
							  sql +=&quot; and a.u_level in (select max(b.u_level) from A_BAS_ALLDATA_V b where b.return_date IS NOT NULL and  b.ITEM155 =&apos;false&apos; and b.ok is not null  and a.userid= b.userid  &quot;;
							  if(ckbEDate == &quot;false&quot;){
								  sql +=&quot; and (b.fail_flag is null  or b.fail_flag=&apos;P&apos; or b.fail_flag =&apos;N&apos;) &quot;;
							  }
							  sql +=&quot; and a.u_name = b.u_name and (a.m_name = b.m_name or (a.m_name  is null and  b.m_name is null))  and b.area =&apos;&quot;+ v_factory +&quot;&apos;&quot;+ getQueryConditionExt_BAS(&quot;3&quot;) +&quot;)&quot;;

							  sql +=&quot; group by a.u_level &quot;;
							  sql +=&quot; order by a.u_level desc&quot;;		
				 Client.addDebugLog(&quot;sql=====&quot;+sql);
		            		  var vec1 = Client.SQLloadValue(sql);
		                      Client.setLocalObject(&quot;vec1&quot;,vec1);
						  }catch(e){				
						  }   
						  if(vec1.size()&gt;0){
							  var e3_count =0;     
							  var e3_prize =0; 
							  var e2_count =0;     
							  var e2_prize =0; 
							  var e1_count =0;     
							  var e1_prize =0; 	
						 
						      for (var j = 0; j &lt; vec1.size(); j++) {		 
								    try{
										var hm1 = vec1.get(j);
										if(hm1.get(&quot;u_level&quot;)==&quot;E3&quot;){
											e3_count =  hm1.get(&quot;count&quot;);      //E3認證類別
										}
										if(hm1.get(&quot;u_level&quot;)==&quot;E2&quot;){
											e2_count =  hm1.get(&quot;count&quot;);      //E2認證類別
										}
										if(hm1.get(&quot;u_level&quot;)==&quot;E1&quot;){
											e1_count =  hm1.get(&quot;count&quot;);      //E1認證類別						  				 
										}				
									}catch(e){}
							  }//for i
			 
						  }else{
							  var e3_count =0;     
//				              var e3_prize =0; 
				              var e2_count =0;     
//				              var e2_prize =0; 
				              var e1_count =0;     
//				              var e1_prize =0; 					 
						  }	
			
						  if(hm.get(&quot;u_level&quot;)==&quot;E3&quot; &amp;&amp; e3_count &gt;0){
							  e3_count -- ; //E3認證計數
						  }else if(hm.get(&quot;u_level&quot;)==&quot;E2&quot; &amp;&amp; e2_count &gt;0){
							  e2_count -- ; //E2認證計數
						  }else if(hm.get(&quot;u_level&quot;)==&quot;E1&quot; &amp;&amp; e1_count &gt;0){
							  e1_count -- ; //E1認證計數
						  }				
						  str1 += e3_count	             + &quot;,&quot;;//E3認證類別				
						  str1 += e2_count	             + &quot;,&quot;;//E2認證類別				
						  str1 += e1_count	             + &quot;,&quot;;//E1認證類別			
						  str1 += emp_class	              ;//身份別			
					  }else{
						  var total =java.lang.Integer.parseInt(temp);
						  var olde = 0;
						  var sqle = &quot;select userid from a_bas_olde where area=&apos;&quot;+v_factory+&quot;&apos; and userid=&apos;&quot;+hm.get(&quot;userid&quot;)+&quot;&apos;&quot;;
						  try{
							  var vece = Client.SQLloadValue(sqle);
							  if(vece!=null &amp;&amp; vece.size()&gt;0){
								  olde = 60;
							  }
							  str1 += olde                                     + &quot;,&quot;;//老E1
							  str1 += total+olde                                     + &quot;,&quot;;//總計
						  }catch(e){
						  }
				
					  }
					  pw.println(str1);
						}else{
							
						}
				
		    }catch(e){}			
			}
			}catch(e){}
	     }//for i	
	  }
	}else if(temp==&quot;9&quot;){
		try{
			var sql = &quot; select a.return_date,a.ok,a.fail_insid,a.fail_flag,a.fail_date,a.fail_sn,a.ITEM115,a.ITEM155,a.print_flag,a.sn,a.dptno,a.appname,a.username,a.userid,a.work_type,a.createdate,a.pqe_date,a.u_name,a.m_name,a.u_level,a.INSID&quot;;
                sql +=&quot; from A_BAS_ALLDATA_V a	&quot;;
				sql +=&quot; where a.ITEM155 =&apos;false&apos;&quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (a.fail_flag is null  or a.fail_flag=&apos;P&apos; or a.fail_flag =&apos;N&apos;) &quot;;
			 }
             sql +=  getQueryConditionExt_BAS(&quot;3&quot;); 
             sql +=&quot; and a.area =&apos;&quot;+ v_factory + &quot;&apos;&quot;;			 
             sql +=&quot; and a.ok is not null&quot;;
             sql +=&quot; and a.return_date is not null&quot;;		
			 sql +=&quot; and a.u_level in ( select max(b.u_level) from A_BAS_ALLDATA_V b where b.return_date IS NOT NULL and b.ITEM155 =&apos;false&apos; and b.ok is not null  and a.userid= b.userid &quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; AND (b.fail_flag IS NULL  or b.fail_flag=&apos;P&apos; OR b.fail_flag = &apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and b.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;
             sql +=&quot; and a.return_date in (  select min(d.return_date) from A_BAS_ALLDATA_V d where d.return_date IS NOT NULL and d.ITEM155 =&apos;false&apos; and d.ok is not null  and a.userid= d.userid  &quot;;
			 if(ckbEDate == &quot;false&quot;){
			 sql +=&quot; and (d.fail_flag is null  or d.fail_flag=&apos;P&apos; or d.fail_flag =&apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and a.u_level=d.u_level and d.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;
			 sql +=&quot; and a.createdate in (  select min(e.createdate) from A_BAS_ALLDATA_V e where e.return_date IS NOT NULL and  e.ITEM155 =&apos;false&apos; and e.ok is not null and a.userid= e.userid  &quot;;
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (e.fail_flag is null  or e.fail_flag=&apos;P&apos; or e.fail_flag =&apos;N&apos;)&quot;; 
			 }
			 sql +=&quot; and a.return_date =e.return_date and a.u_level=e.u_level and e.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot;)&quot;;		
			 sql +=&quot; and a.u_name in ( select min(c.u_name) from A_BAS_ALLDATA_V c where c.return_date IS NOT NULL and  c.ITEM155 =&apos;false&apos; and c.ok is not null  and a.userid= c.userid  &quot;; 
			 if(ckbEDate == &quot;false&quot;){
				 sql +=&quot; and (c.fail_flag is null  or c.fail_flag=&apos;P&apos; or c.fail_flag =&apos;N&apos;) &quot;;
			 }
			 sql +=&quot; and a.u_level=c.u_level and a.return_date =c.return_date and a.createdate =c.createdate and c.area =&apos;&quot;+ v_factory + &quot;&apos;&quot; +getQueryConditionExt_BAS(&quot;3&quot;)+&quot; )&quot;;
			 sql +=&quot; order by a.dptno,a.userid,a.pqe_date,a.u_name,a.m_name,a.u_level&quot;;		
		
			 var vec = Client.SQLloadValue(sql);
			 Client.addDebugLog(&quot;基本功最高認證類別sql9=&quot;+sql);
			 Client.setLocalObject(&quot;vec&quot;,vec);
		}catch(e){				
		}
       var j = 0;
	   
	    if(vec.size()&gt;0){	   
			for (var i = 0; i &lt; vec.size(); i++) {
				try{
					var hm = vec.get(i);				
					var user_name = hm.get(&quot;username&quot;);
					var emp_class = &quot;&quot;;
					var dptno = &quot;&quot;;
					var wktype = &quot;&quot;;
					var leaveworkday = &quot;&quot;;
					var v_leaveflag = &quot;&quot;;
					if(hm.get(&quot;u_level&quot;)!=&quot;E0&quot;){
						try{				  
							
							var sql = &quot;select substr(workplace,5,6) dptno,resigndate,decode(resign,&apos;false&apos;,&apos;在職&apos;,&apos;離職&apos;) resign,homephone from mem_geninf where areacode=&apos;&quot;+v_factory+&quot;&apos; and id=&apos;&quot;+hm.get(&quot;userid&quot;)+&quot;&apos;&quot;;
							var rs = Client.SQLloadValue(sql);
							if(rs!=null &amp;&amp; rs.size()&gt;0){
								dptno = rs.get(0).get(&quot;dptno&quot;);
								v_leaveflag = rs.get(0).get(&quot;resign&quot;);
								leaveworkday = rs.get(0).get(&quot;resigndate&quot;);
								if(rs.get(0).get(&quot;homephone&quot;).equals(&quot;2&quot;)){
									v_leaveflag = &quot;留停&quot;;
								}
							}
							var str1 = j + 1    				    + &quot;,&quot;; //序				
							str1 += hm.get(&quot;dptno&quot;).substring(0,3) 	         + &quot;,&quot;;//認證部門	
							str1 += dptno 	         + &quot;,&quot;;//部門
			    	
					    	str1 += hm.get(&quot;userid&quot;)  	         + &quot;,&quot;;//認證人工號	
							str1 += user_name  	        + &quot;,&quot;;//填單人姓名	
							str1 += wktype  	        + &quot;,&quot;;//工作型態
	
					    	str1 += v_leaveflag                       + &quot;,&quot;;//人員狀態	
							str1 += leaveworkday         + &quot;,&quot;;//離職日期	
			    
			    	    	//str1 += hm.get(&quot;pqe_date&quot;)    	     + &quot;,&quot;;//認證日期	
							str1 += hm.get(&quot;return_date&quot;)        + &quot;,&quot;;//產品認證日期				
							str1 += hm.get(&quot;u_level&quot;)		     + &quot;,&quot;;//最高認證類別				     
							
							var total =java.lang.Integer.parseInt(temp);
							var olde = 0;
							var sqle = &quot;select userid from a_bas_olde where area=&apos;&quot;+v_factory+&quot;&apos; and userid=&apos;&quot;+hm.get(&quot;userid&quot;)+&quot;&apos;&quot;;
							try{
								var vece = Client.SQLloadValue(sqle);
								if(vece!=null &amp;&amp; vece.size()&gt;0){
									olde = 60;
								}
								str1 += olde                                     + &quot;,&quot;;//老E1
//								str1 += total+olde                                     + &quot;,&quot;;//總計
							}catch(e){
							}
				
					  
					    	pw.println(str1);
						
				
						}catch(e){}			
					}
			}catch(e){}
	     }//for i	
	  }
	}	
	
    conn.close();
	pw.close();
}
function update_sql(){
    try{
	  var sql = &quot; select a.fail_date,a.fail_sn,a.insid,a.fail_flag,b.ITEM49 from A_BAS_ALLDATA_V a,ART01101300263603615_INS b &quot;;
            sql +=&quot; where a.fail_date is null&quot;;
            sql +=&quot; and a.Fail_sn is not null&quot;;
            sql +=&quot; and a.fail_sn=b.ITEM62&quot;;
//            sql +=&quot; and a.fail_sn=&apos;BAS_F20110613018&apos;&quot;;			
            sql +=&quot; and a.INSID&lt;&gt;&apos;old_data&apos;&quot;;			 
		var vec = Client.SQLloadValue(sql);
		       Client.setLocalObject(&quot;vec&quot;,vec);
    }catch(e){				
    }
	
	if(vec.size()&gt;0 ){
	for (var i = 0; i &lt; vec.size(); i++) {
	 try{
		var hm = vec.get(i);	
	    var up_sql = &quot;update ART00061289527119196_INS&quot;;
			up_sql +=&quot; set ITEM93=&apos;&quot;+ hm.get(&quot;ITEM49&quot;) +&quot;&apos;&quot;;
			up_sql +=&quot; where ITEM36=&apos;&quot;+hm.get(&quot;fail_sn&quot;)+&quot;&apos;&quot;;				
		
//	    var up_sql = &quot;update A_BAS_UNIT_OLDDATA &quot;;
//			up_sql +=&quot; set FAIL_date=&apos;&quot;+ hm.get(&quot;ITEM49&quot;) +&quot;&apos;&quot;;
//			up_sql +=&quot; where FAIL_SN=&apos;&quot;+hm.get(&quot;fail_sn&quot;)+&quot;&apos;&quot;;							
            var ok = Client.SQLupdateValue(up_sql);
			if(&quot;true&quot;.equals(ok)){
//				Form.showMessageDialog(&quot;回寫缺失資料成功&quot;);
			}else{
				Form.showMessageDialog(&quot;回寫缺失資料失敗&quot;);
			}	
    }catch(e){				
    }
   }//for
  }//if(vec.size()&gt;0 ) 
}//function update_sql()
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00411408698385876</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2016/04/14 15:07:07</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.MAN.PMP2MES</string> 
     </void> 
     <void property="id"> 
      <string>SCL00411408698385876</string> 
     </void> 
     <void property="name"> 
      <string>PMP2MES</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001209032361851</string> 
     </void> 
     <void property="scriptSource"> 
      <string>function updMANM050_AUDIT_CS( vNO,vIns_ID,vStatus){ 
	var vResult = &quot;fail&quot;;
	var conn = Client.createSessionConnection(&quot;T-MES&quot;);
	try{			
		var vSQL = &quot;Update MANM050_AUDIT set flow_number = &apos;&quot;+vIns_ID+&quot;&apos; ,flow_status = &apos;&quot;+vStatus+&quot;&apos;&quot;;
		if(vStatus==&quot;A&quot;){
			vSQL+=&quot; ,start_date = current &quot;
		}else{				  			// --&gt;&gt; C:生效 or D:作廢
			vSQL+=&quot; ,close_date = current &quot;
		}
		vSQL+= &quot; Where ISSUE_NO = &apos;&quot; + vNO.trim() +&quot;&apos;;&quot;;
		var result = conn.updateValue(vSQL);
		if( true==result){
			conn.commit();			// 成功
			vResult = &quot;succ&quot;;
			Form.setValue(&quot;ToMES&quot;,vStatus);
		}
	}catch(e){
		Client.addErrLog(&quot;updMANM050_AUDIT_CS flow_status:&quot;+vSQL+&quot;[E]&quot;+e);
	}finally{
		conn.close();
	}				
	return vResult;
}
function getMANM050_AUDITflow_status(vNO){
	var vStatus = &quot;N/A&quot;;
	var conn = Client.createSessionConnection(&quot;T-MES&quot;);
	try{			
		var vSQL = &quot;select flow_status,item_no FROM MANM050_AUDIT Where ISSUE_NO = &apos;&quot; + vNO.trim()+&quot;&apos;;&quot;;
		var vec = conn.loadValue(vSQL);
		if(vec.size()&gt;0){				
			vStatus = vec.get(0).get(&quot;flow_status&quot;);
			var vITEM_NO = vec.get(0).get(&quot;item_no&quot;);
			Form.setValue(&quot;item_no&quot;,vITEM_NO);  // 
		}
	}catch(e){
		Client.addErrLog(&quot;getMANM050_AUDITflow_status:&quot;+vSQL);
	}finally{
		conn.close();
	}			
	return vStatus;
}
	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00421424829535863</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2016/01/05 15:12:59</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.MAN.leaveFactory</string> 
     </void> 
     <void property="id"> 
      <string>SCL00421424829535863</string> 
     </void> 
     <void property="name"> 
      <string>leaveFactory</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001209032361851</string> 
     </void> 
     <void property="scriptSource"> 
      <string>// add by wangwei@20150303
// pass_type = 延誤一出廠
// sub_type 延誤一外發  在流程程第1關 / 最後一關 / 強制結案自動關卡 Server Function
function updateSubm220(vStatus){     
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var vSN = appDataMap.get(&quot;Sn&quot;);
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return ;
	}
	try{		
		var vTable = appDataMap.get(&quot;pass_detail_tab&quot;); 		// 出廠明細
		var v_factory = appDataMap.get(&quot;Factory&quot;).substring(1,5);
		loadLibrary(&quot;com.gce.Common.Util&quot;);
		var conn_name = conn_db(v_factory,&quot;MES&quot;);
		var upsql=&quot;&quot;;		
		var conn = Server.createSessionConnection(conn_name);	
		var rowCount = vTable.size();//取得筆數
		for( var i=0 ; i&lt;rowCount ; i++) {
			var vSubno = vTable.get(i).get(&quot;ITEM1&quot;);   //標記及編號
			var upsql = &quot;UPDATE subm220 SET af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = current WHERE sub_sno = &apos;&quot;+vSubno+&quot;&apos;;&quot;;					
			var result = conn.updateValue(upsql);
			if(true==result){
				conn.commit();
			}else{
				conn.rollback();
				Server.addErrLog(&quot;更新subm220失敗:&quot;+upsql);
			}
// -------------- 新增 update subm225 by wangwei@2015/08/13		
			var upsql = &quot;UPDATE subm225 SET af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = current WHERE sub_sno = &apos;&quot;+vSubno+&quot;&apos;;&quot;;					
			var result = conn.updateValue(upsql);
			if(true==result){
				conn.commit();
			}else{
				conn.rollback();
				Server.addErrLog(&quot;更新subm225失敗:&quot;+upsql);
			}							
		}
	}catch(e){
		Server.addErrLog(&quot;更新subm220及subm225失敗:&quot;+upsql);
	}finally{
		conn.close();
	}
}	  
//sub_type    鑽頭研磨出廠 Server Function
function updateMosm610(vStatus){
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var vSN = appDataMap.get(&quot;Sn&quot;);
	var vTrnYear = vSN.substr(4,4);
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return ;
	}
	try{		
		var vTable = appDataMap.get(&quot;pass_detail_tab&quot;); 		// 出廠明細
		var v_factory = appDataMap.get(&quot;Factory&quot;).substring(1,5);
		loadLibrary(&quot;com.gce.Common.Util&quot;);
		var conn_name = conn_db(v_factory,&quot;MES&quot;);
		var upsql=&quot;&quot;;
		
		var conn = Server.createSessionConnection(conn_name);	
		var rowCount = vTable.size();//取得筆數
		for( var i=0 ; i&lt;rowCount ; i++) {
			var vSubno = vTable.get(i).get(&quot;ITEM1&quot;);   //標記及編號                                  											2016/01/05 加上年份
			var upsql = &quot;UPDATE mosm610 SET af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = current WHERE tran_no = &apos;&quot;+vSubno+&quot;&apos; and tran_year =&apos;&quot;+vTrnYear+&quot;&apos;;&quot;;					
			var result = conn.updateValue(upsql);
			if(true==result){
				conn.commit();
			}else{
				conn.rollback();
				Server.addErrLog(&quot;更新mosm610失敗:&quot;+upsql);
			}						
		}
	}catch(e){
		Server.addErrLog(&quot;更新mosm610失敗:&quot;+upsql);
	}finally{
		conn.close();
	}
}
// 成品出貨　update ERP PACKING   Server Function
function updatePacking(vStatus){
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var vSN = appDataMap.get(&quot;Sn&quot;);
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return ;
	}
	var vTable = appDataMap.get(&quot;pass_detail_tab&quot;); 		// 出廠明細
	var conn_name = &quot;PROD&quot;//conn_db(v_factory,&quot;ERP&quot;);   	// 四廠共用 ERP
	var upsql=&quot;&quot;;
	try{		
		var conn = Server.createSessionConnection(conn_name);	
		var rowCount = vTable.size();//取得筆數
		for( var i=0 ; i&lt;rowCount ; i++) {
			var vSubno = vTable.get(i).get(&quot;ITEM1&quot;);   //標記及編號
			var upsql = &quot;UPDATE tg_upi_wsh_packing_headers pack SET af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = SYSDATE WHERE pack.name = &apos;&quot;+vSubno+&quot;&apos;&quot;;					
			var result = conn.updateValue(upsql);
			if(true==result){
				conn.commit();
			}else{
				conn.rollback();
				Server.addErrLog(&quot;更新tg_upi_wsh_packing_headers失敗:&quot;+upsql);
			}						
		}
	}catch(e){
		Server.addErrLog(&quot;更新tg_upi_wsh_packing_headers失敗:&quot;+upsql+e);
	}finally{
		conn.close();
	}
}


// 檢查是否已開出廠單 Cliet Function
function chkExist(vSubNo){
	var vReturn=&quot;&quot;;
	var vSQL = &quot;select item10 from ART00061253925974473_ins where item155 = &apos;false&apos; and item10 is not null and insid in (select insid from ART00061253925974473item32 where item1 = &apos;&quot;+vSubNo+&quot;&apos; )&quot;;	
	var vector = Client.SQLloadValue(vSQL);
	if ( vector != null ){
		if (vector.size()&gt;0){
			vReturn = vector.get(0).get(&quot;item10&quot;);			
		}
	}	
	return vReturn;
}
//-------------
function chkExist_ext(vSubNo,vYear){  // add by wangwei@2016/01/05
	var vReturn=&quot;&quot;;
	var vSQL = &quot;select item10 from ART00061253925974473_ins where item155 = &apos;false&apos; and item10 is not null and substr(item10 , 5,4) = &apos;&quot;+vYear+&quot;&apos;&quot;;
	    vSQL = vSQL+ &quot; and insid in (select insid from ART00061253925974473item32 where item1 = &apos;&quot;+vSubNo+&quot;&apos; )&quot;;	
	var vector = Client.SQLloadValue(vSQL);
	if ( vector != null ){
		if (vector.size()&gt;0){
			vReturn = vector.get(0).get(&quot;item10&quot;);			
		}
	}	
	return vReturn;
}

// 延誤一出廠-延誤一代工 2015/03/09
function updateSubm235(vStatus){
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var vSN = appDataMap.get(&quot;Sn&quot;);
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return ;
	}
	var vTable = appDataMap.get(&quot;pass_detail_tab&quot;); 		// 出廠明細
	try{		
		var v_factory = appDataMap.get(&quot;Factory&quot;).substring(1,5);
		loadLibrary(&quot;com.gce.Common.Util&quot;);
		var conn_name = conn_db(v_factory,&quot;MES&quot;);
		var upsql=&quot;&quot;;
		
		var conn = Server.createSessionConnection(conn_name);	
		var rowCount = vTable.size();//取得筆數
		for( var i=0 ; i&lt;rowCount ; i++) {
			var vSubno = vTable.get(i).get(&quot;ITEM1&quot;);   //標記及編號
			var upsql = &quot;UPDATE subm235 SET af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = current WHERE rcv_sno = &apos;&quot;+vSubno+&quot;&apos;;&quot;;					
			var result = conn.updateValue(upsql);
			if(true==result){
				conn.commit();
			}else{
				conn.rollback();
				Server.addErrLog(&quot;更新subm235失敗:&quot;+upsql);
			}
// -------------- 新增update subm225 by wangwei@2015/08/13			
			var upsql = &quot;UPDATE subm225 SET af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = current WHERE sub_sno = &apos;&quot;+vSubno+&quot;&apos;;&quot;;					
			var result = conn.updateValue(upsql);
			if(true==result){
				conn.commit();
			}else{
				conn.rollback();
				Server.addErrLog(&quot;更新subm225失敗:&quot;+upsql);
			}							
		}
	}catch(e){
		Server.addErrLog(&quot;更新subm235及225失敗:&quot;+upsql);
	}finally{
		conn.close();
	}
}

function updateMrbm260(vStatus){     
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var vSN = appDataMap.get(&quot;Sn&quot;);
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return ;
	}
	var v_factory = appDataMap.get(&quot;Factory&quot;).substring(1,5);
	var vtran_no = appDataMap.get(&quot;tran_no&quot;);
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);
	var upsql=&quot;&quot;;
	var vMESstatus=&quot;&quot;;
//	1.MyGCE簽核中  3.MyGCE 抽單作廢4.MyGCE 已核准
	if(vStatus==&quot;P&quot;){vMESstatus=&quot;1&quot;};
	if(vStatus==&quot;E&quot;){vMESstatus=&quot;4&quot;};	
	if(vStatus==&quot;X&quot;){vMESstatus=&quot;3&quot;};		
	try{		
		var conn = Server.createSessionConnection(conn_name);	
		var upsql = &quot;UPDATE MRBM260 SET status=&apos;&quot;+ vMESstatus+&quot;&apos;,af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = current WHERE tran_no = &apos;&quot;+vtran_no+&quot;&apos;;&quot;;					
		var result = conn.updateValue(upsql);
		if(true==result){
			conn.commit();
		}else{
			conn.rollback();
			Server.addErrLog(&quot;更新外句主檔失敗:&quot;+upsql);
		}						
	}catch(e){
		Server.addErrLog(&quot;更新外句主檔失敗:&quot;+upsql);
	}finally{
		conn.close();
	}
}	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>出廠放行單用的Library</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00441499060788739</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2017/07/03 13:52:12</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.AB.Server.addAsignTable</string> 
     </void> 
     <void property="id"> 
      <string>SCL00441499060788739</string> 
     </void> 
     <void property="name"> 
      <string>addAsignTable</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00181370400890358</string> 
     </void> 
     <void property="scriptSource"> 
      <string>// copy from bpmdbx64deb by wangwei@2017/07/03
//com.gce.AB.Server.addAsignTable
// 設定會簽人員function
function addAsignList(PARAMETER,Sign_MemberTable,Description){
	var Ati = MyTask.getArtInstance();
	var hm = Ati.getAppDataMap();
	var factory = hm.get(&quot;Factory&quot;) ;
    var v_factory=factory.substring(1,5);
	var SignTable = hm.get(Sign_MemberTable);
	//SignTable.clear();
	var SignTable_G = hm.get(Sign_MemberTable+&quot;_G&quot;);
    //SignTable_G.clear();	
	var SQL =    &quot; select VALUE2 memid ,VALUE1 username ,RESIGN  from A_PARAMETER_ITEM , A_PARAMETER_DATA, MEM_GENINF &quot;;
	SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
	SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
	SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
	SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 = &apos;&quot;+v_factory+&quot;&apos;&quot;  ;	
	SQL = SQL +  &quot; and MEM_GENINF .MEMID=A_PARAMETER_DATA.VALUE2&quot;;
	if(Description!=&quot;&quot;){
		SQL = SQL +  &quot; and A_PARAMETER_DATA.DESCRIPTION = &apos;&quot;+Description+&quot;&apos;&quot;  ;
	}
	var vec = Server.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Server.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
			    //離職人員判斷，若離職則轉單至ADM
				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(Sign_MemberTable,memid) ;
					var cmemid = memid ;
			    }else{
					 var Dauble_flag = memisDauble(Sign_MemberTable,memid) ;	
					 var cmemid = &quot;PDM&quot; ;	 
				}

				if(Dauble_flag != &quot;Y&quot;){					
				   var dataMap = new java.util.HashMap();
				   dataMap.put(&quot;ITEM1&quot;,cmemid);
				   dataMap.put(&quot;ITEM2&quot;,cMember);		
				   dataMap.put(&quot;ITEM3&quot;,dptcname);
				   dataMap.put(&quot;ITEM4&quot;,memDR);		
				   dataMap.put(&quot;ITEM5&quot;,(v_factory+PARAMETER));									
				   SignTable.add(dataMap);	
				   Ati.setAppValue(Sign_MemberTable,SignTable);
				   var new_record =&quot;Y&quot; ;
				}
			
			 }
			//寫入會簽群組Table，子流程使用
			if (new_record == &quot;Y&quot;){
			    if (SignTable_G != null){
					var dataMap = new java.util.HashMap();
					dataMap.put(&quot;ITEM1&quot;,(v_factory+PARAMETER));									
				    SignTable_G.add(dataMap);				    
					Ati.setAppValue((Sign_MemberTable+&quot;_G&quot;),SignTable_G);
					
		        }	
		    }		
		}else{		     
		}
	   }
	 }catch(e){		
		Server.addDebugLog(&quot;[addAsignList]讀取參數檔失敗!請與系統負責聯絡!!\n&quot;);
	}
}//function addAsignList
//全簽子流程使用
function addAsignList_a(PARAMETER,Sign_MemberTable,Description){
	var Ati = MyTask.getArtInstance();
	var hm = Ati.getAppDataMap();
	var factory = hm.get(&quot;Factory&quot;) ;
    var v_factory=factory.substring(1,5);
	var SignTable = hm.get(Sign_MemberTable);
	//SignTable.clear();
	var SignTable_G = hm.get(Sign_MemberTable+&quot;_G&quot;);
    //SignTable_G.clear();	
	var SQL =    &quot; select VALUE2 memid ,VALUE1 username ,RESIGN  from A_PARAMETER_ITEM , A_PARAMETER_DATA, MEM_GENINF &quot;;
	SQL = SQL +  &quot; where A_PARAMETER_ITEM.PARAMETER = A_PARAMETER_DATA.PARAMETER &quot;;
	SQL = SQL +  &quot; and A_PARAMETER_ITEM.ACTIVE = &apos;true&apos; &quot;;
	SQL = SQL +  &quot; and A_PARAMETER_ITEM.PARAMETER = &apos;&quot;+PARAMETER+&quot;&apos;&quot;;
	SQL = SQL +  &quot; and A_PARAMETER_DATA.KEY1 = &apos;&quot;+v_factory+&quot;&apos;&quot;  ;	
	SQL = SQL +  &quot; and MEM_GENINF .MEMID=A_PARAMETER_DATA.VALUE2&quot;;
	if(Description!=&quot;&quot;){
		SQL = SQL +  &quot; and A_PARAMETER_DATA.DESCRIPTION = &apos;&quot;+Description+&quot;&apos;&quot;  ;
	}
	var vec = Server.SQLloadValue(SQL);			
	  try{
		if ( vec != null ){
			if (vec.size()&gt;0){
				var new_record =&quot;&quot; ;
              for(var i=0;i&lt;vec.size();i++){
			      var ht = vec.get(i);
			      var memid = ht.get(&quot;memid&quot;)
			      var cMember = Server.getMemberByID(memid);			  
			       if(cMember == null){
                   // 檢核員工是否是有效的,若無效基本上會傳給pdm , 
				   memid = &quot;MEMPDM0001&quot;  
				   var cMember = Server.getMemberByID(memid);
			       }		  
			      var roleID = cMember.getMainRoleID();
			      var memDR =  cMember.getMemberDR(roleID);		  
			      var dptcname = memDR.getDepartmentName();	//使用者部門名稱		  			  
			  	  
			    //離職人員判斷，若離職則轉單至ADM
				if (ht.get(&quot;RESIGN&quot;)== &quot;false&quot;){
					var Dauble_flag = memisDauble(Sign_MemberTable,memid) ;
					var cmemid = memid ;
			    }else{
					 var Dauble_flag = memisDauble(Sign_MemberTable,memid) ;	
					 var cmemid = &quot;PDM&quot; ;	 
				}

				if(Dauble_flag != &quot;Y&quot;){					
				   var dataMap = new java.util.HashMap();
				   dataMap.put(&quot;ITEM1&quot;,cmemid);
				   dataMap.put(&quot;ITEM2&quot;,cMember);		
				   dataMap.put(&quot;ITEM3&quot;,dptcname);
				   dataMap.put(&quot;ITEM4&quot;,memDR);		
				   dataMap.put(&quot;ITEM5&quot;,(cmemid));									
				   SignTable.add(dataMap);	
				   Ati.setAppValue(Sign_MemberTable,SignTable);
				   var new_record =&quot;Y&quot; ;
				}
			
			 }
			//寫入會簽群組Table，子流程使用
			if (new_record == &quot;Y&quot;){
			    if (SignTable_G != null){
					var dataMap = new java.util.HashMap();
					dataMap.put(&quot;ITEM1&quot;,(cmemid));									
				    SignTable_G.add(dataMap);				    
					Ati.setAppValue((Sign_MemberTable+&quot;_G&quot;),SignTable_G);
					
		        }	
		    }		
		}else{		     
		}
	   }
	 }catch(e){		
		Server.addDebugLog(&quot;[addAsignList]讀取參數檔失敗!請與系統負責聯絡!!\n&quot;);
	}
}//function addAsignList

function memisDauble(table,memid){
        var flag =&quot;&quot;;	
		var Ati = MyTask.getArtInstance();
	    var hm = Ati.getAppDataMap();
	    var table = hm.get(table);
		for(var j = 0;j&lt;table.size();j++){
			if(table.get(j).get(&quot;ITEM1&quot;).equals(memid)){
		 		var flag =&quot;Y&quot;;
			}
		}
		return flag ;		
}//function memisDauble

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00451471930547476</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2019/04/01 08:15:42</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.MAN.TGCEleaveFactory</string> 
     </void> 
     <void property="id"> 
      <string>SCL00451471930547476</string> 
     </void> 
     <void property="name"> 
      <string>TGCEleaveFactory</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001209032361851</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//pass_type = 延誤一出廠
//sub_type 延誤一外發  在流程程第1關 / 最後一關 / 強制結案自動關卡
function updateSubm220(vStatus){     
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var vSN = appDataMap.get(&quot;Sn&quot;);
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return ;
	}
	var vTable = appDataMap.get(&quot;pass_detail_tab&quot;); 		// 出廠明細
	var v_factory = appDataMap.get(&quot;Factory&quot;).substring(1,5);
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);
	var upsql=&quot;&quot;;
	try{		
		var conn = Server.createSessionConnection(conn_name);	
		var rowCount = vTable.size();//取得筆數
		for( var i=0 ; i&lt;rowCount ; i++){
			if(vStatus==&quot;X&quot;){  // 作廢清空
				vSN = &quot;&quot;;
			}			
			var vSubno = vTable.get(i).get(&quot;ITEM5&quot;);   //標記及編號
			var upsql = &quot;UPDATE subm220 SET af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = current WHERE sub_sno = &apos;&quot;+vSubno+&quot;&apos;;&quot;;					
			var result = conn.updateValue(upsql);
			if(true==result){
				conn.commit();
			}else{
				conn.rollback();
				Server.addErrLog(&quot;call updateSubm220 更新外包主檔失敗:&quot;+upsql);
			}						
		}
	}catch(e){
		Server.addErrLog(&quot;call updateSubm220 更新外包主檔失敗:&quot;+upsql);
	}finally{
		conn.close();
	}
}	  
//sub_type    鑽頭研磨出廠
function updateMosm610(vStatus){
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var vSN = appDataMap.get(&quot;Sn&quot;);
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return ;
	}
	var vTable = appDataMap.get(&quot;pass_detail_tab&quot;); 		// 出廠明細
	var v_factory = appDataMap.get(&quot;Factory&quot;).substring(1,5);
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);
	var upsql=&quot;&quot;;
	try{		
		var conn = Server.createSessionConnection(conn_name);	
		var rowCount = vTable.size();//取得筆數
		for( var i=0 ; i&lt;rowCount ; i++) {
			var vSubno = vTable.get(i).get(&quot;ITEM1&quot;);   //標記及編號
			var upsql = &quot;UPDATE mosm610 SET af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = current WHERE tran_no = &apos;&quot;+vSubno+&quot;&apos;;&quot;;					
			var result = conn.updateValue(upsql);
			if(true==result){
				conn.commit();
			}else{
				conn.rollback();
				Server.addErrLog(&quot;更新外句主檔失敗:&quot;+upsql);
			}						
		}
	}catch(e){
		Server.addErrLog(&quot;更新外句主檔失敗:&quot;+upsql);
	}finally{
		conn.close();
	}
}
// 成品出貨　update ERP PACKING
function updatePacking(vStatus){
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var vSN = appDataMap.get(&quot;Sn&quot;);
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return ;
	}
	var vTable = appDataMap.get(&quot;pass_detail_tab&quot;); 		// 出廠明細
	var v_factory = appDataMap.get(&quot;Factory&quot;).substring(1,5);
	//loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = &quot;PROD&quot;//conn_db(v_factory,&quot;ERP&quot;);
	var upsql=&quot;&quot;;
//	try{		
		var conn = Server.createSessionConnection(conn_name);	
		var rowCount = vTable.size();//取得筆數
		for( var i=0 ; i&lt;rowCount ; i++) {
			var vSubno = vTable.get(i).get(&quot;ITEM1&quot;);   //標記及編號
			var upsql = &quot;UPDATE tg_upi_wsh_packing_headers pack SET af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = SYSDATE WHERE pack.name = &apos;&quot;+vSubno+&quot;&apos;&quot;;					
			var result = conn.updateValue(upsql);
			if(true==result){
				conn.commit();
			}else{
				conn.rollback();
				Server.addErrLog(&quot; call updatePacking 更新tg_upi_wsh_packing_headers失敗:&quot;+upsql);
			}						
		}
//	}catch(e){
//		Server.addErrLog(&quot;更新外句主檔失敗:&quot;+upsql);
//	}finally{
		conn.close();
//	}
}


// 檢查是否已開出廠單
function chkExist(vSubNo){
	var vReturn=&quot;&quot;;
	var vSQL = &quot;select item10 from ART00061253925974473_ins where item155 = &apos;false&apos; and item10 is not null and insid in (select insid from ART00061253925974473item32 where item1 = &apos;&quot;+vSubNo+&quot;&apos; )&quot;;	
	var vector = Client.SQLloadValue(vSQL);
	if ( vector != null ){
		if (vector.size()&gt;0){
			vReturn = vector.get(0).get(&quot;item10&quot;);			
		}
	}	
	return vReturn;
}


function updateSubm235(vStatus){
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var vSN = appDataMap.get(&quot;Sn&quot;);
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return ;
	}
	var vTable = appDataMap.get(&quot;pass_detail_tab&quot;); 		// 出廠明細
	var v_factory = appDataMap.get(&quot;Factory&quot;).substring(1,5);
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);
	var upsql=&quot;&quot;;
	try{		
		var conn = Server.createSessionConnection(conn_name);	
		var rowCount = vTable.size();//取得筆數
		for( var i=0 ; i&lt;rowCount ; i++) {
			var vSubno = vTable.get(i).get(&quot;ITEM1&quot;);   //標記及編號
			var upsql = &quot;UPDATE subm235 SET af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = current WHERE rcv_sno = &apos;&quot;+vSubno+&quot;&apos;;&quot;;					
			var result = conn.updateValue(upsql);
			if(true==result){
				conn.commit();
			}else{
				conn.rollback();
				Server.addErrLog(&quot;更新subm235失敗:&quot;+upsql);
			}						
		}
	}catch(e){
		Server.addErrLog(&quot;更新subm235失敗:&quot;+upsql);
	}finally{
		conn.close();
	}
}
// --------- 
function updateMrbm260(vStatus){     
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var vSN = appDataMap.get(&quot;Sn&quot;);
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return ;
	}
	var v_factory = appDataMap.get(&quot;Factory&quot;).substring(1,5);
	var vtran_no = appDataMap.get(&quot;tran_no&quot;);
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);
	var upsql=&quot;&quot;;
	var vMESstatus=&quot;&quot;;
//	1.MyGCE簽核中  3.MyGCE 抽單作廢4.MyGCE 已核准
	if(vStatus==&quot;P&quot;){vMESstatus=&quot;1&quot;};
	if(vStatus==&quot;E&quot;){vMESstatus=&quot;4&quot;};	
	if(vStatus==&quot;X&quot;){vMESstatus=&quot;3&quot;};		
	try{		
		var conn = Server.createSessionConnection(conn_name);	
		var upsql = &quot;UPDATE MRBM260 SET status=&apos;&quot;+ vMESstatus+&quot;&apos;,af_status=&apos;&quot;+ vStatus+&quot;&apos;,af_no = &apos;&quot;+vSN+&quot;&apos;,af_dtime = current WHERE tran_no = &apos;&quot;+vtran_no+&quot;&apos;;&quot;;					
		var result = conn.updateValue(upsql);
		if(true==result){
			conn.commit();
		}else{
			conn.rollback();
			Server.addErrLog(&quot;更新MRBM260主檔失敗:&quot;+upsql);
		}						
	}catch(e){
		Server.addErrLog(&quot;更新MRBM260主檔失敗:&quot;+upsql);
	}finally{
		conn.close();
	}
}	  

// add by wangwei@2019/03/29
function updateeesm010(vStatus){     	
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();	
	var vSN = appDataMap.get(&quot;Sn&quot;);
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return ;
	}
	var vList = appDataMap.get(&quot;serial&quot;);
	if(&quot;&quot;==vList){
		return ;
	}
	var v_factory = appDataMap.get(&quot;Factory&quot;).substring(1,5);
	var vtran_no = appDataMap.get(&quot;tran_no&quot;);
	loadLibrary(&quot;com.gce.Common.Util&quot;);
	var conn_name = conn_db(v_factory,&quot;MES&quot;);
	var upsql=&quot;&quot;;
	try{		
		var conn = Server.createSessionConnection(conn_name);			
		var res = vList.split(&quot;;&quot;);		
		for(i=0; i &lt; res.length　;i++) {
			var vSERIAL = res[i];//[0];
			if(vSERIAL.length()&gt;0){
				if(vStatus==&quot;X&quot;){
					var upsql = &quot;UPDATE EESM010 SET col_gcers = null where ees_serial=&quot;+vSERIAL;									
				}else{
					var upsql = &quot;UPDATE EESM010 SET col_gcers=&apos;&quot;+vSN+&quot;&apos; where ees_serial=&quot;+vSERIAL;					
				}
				var result = conn.updateValue(upsql);
				if(true==result){
					conn.commit();
				}else{
					conn.rollback();
					Server.addErrLog(&quot;更新MRBM260主檔失敗:&quot;+upsql);
				}
			}					
		}
	}catch(e){
		Server.addErrLog(&quot;更新MRBM260主檔失敗:&quot;+upsql);
	}finally{
		conn.close();
	}
}
</string> 
     </void> 
     <void property="synopsis"> 
      <string>TGCE 出廠放行單更新MES Table</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00451533006214046</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/08/02 14:40:57</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Client.OT</string> 
     </void> 
     <void property="id"> 
      <string>SCL00451533006214046</string> 
     </void> 
     <void property="name"> 
      <string>OT</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00051226985915885</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//設定直屬主管
function setManager(App_ID){
	var App_MemID = Form.getValue(&quot;App_MemID&quot;);
	var App_mem = Client.getMember(&quot;MEMT1&quot;+App_ID);
	var Manager_ID = &quot;Administrator&quot;;
	if(App_mem != null){ 
		Manager_ID = App_mem.getPager();
	}
	Form.setValue(&quot;Next_Member_ID&quot;,Manager_ID);
	Form.setValue(&quot;Manager_ID&quot;,Manager_ID);
}

//設定取後一位簽核主管
function setLastManager(){
	var App_MemID = Form.getValue(&quot;App_MemID&quot;);
	var App_DepID = Form.getValue(&quot;App_DepID&quot;);
	var Dep = Client.getDepartment(App_DepID);
	var LastManager = Dep.getResopnsibility().substring(0,11);
	if (LastManager == App_MemID || LastManager.equals(App_MemID)){//如果申請人是部門主管，則往上簽一級即可
		var member = Client.getMember(LastManager);
		LastManager = member.getPager();
	}
	if(LastManager ==&quot;&quot; || LastManager.equals(&quot;&quot;)){//讀取部門主管錯誤時，將資料塞入errorMsg中
		Form.showMessageDialot(&quot;讀取部門主管錯誤，請與單位書記聯繫!!&quot;);
		Form.setValue(&quot;errorMsg&quot;,&quot;讀取部門主管錯誤，請與單位書記聯繫!!&quot;);
	}else{
		Form.setValue(&quot;LastManager&quot;,LastManager);
	}
}

//設定classno
function setClassno(){
	var empno = Form.getValue(&quot;App_ID&quot;);
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var sql = &quot;select a.classno,to_char(b.classbeg,&apos;%H:%M&apos;) classbeg,to_char(b.classend,&apos;%H:%M&apos;) classend from empm020 a , empm090 b    &quot;;
		sql += &quot;where a.classno  = b.classno and a.empno=&apos;&quot; + empno + &quot;&apos;  and b.wktype=&apos;2&apos; and b.weekday =&apos;N&apos;&quot;;
	var vec = loadSQL(sql,&quot;T-MES&quot;);
	Form.setValue(&quot;classno&quot;,vec.get(0).get(&quot;classno&quot;));
	Form.setValue(&quot;class&quot;,vec.get(0).get(&quot;classbeg&quot;)+&quot;-&quot;+vec.get(0).get(&quot;classend&quot;));		
}

//判斷假日
function chkHoliday(App_date){	
	//var sql =  &quot; select *from a_parameter_data where parameter=&apos;HR_TGCE_R1_DATE&apos; &quot;;
	//	sql += &quot; and value1=&apos;&quot;+ App_date +&quot;&apos; &quot;;
	//	sql += &quot; and (&apos;&quot; + Form.getValue(&quot;App_Dep_ID&quot;) + &quot;&apos; like value2  or value2 =&apos;ALL&apos;) &quot;;
	//var vec = Client.SQLloadValue(sql);
	//if (vec.size() &gt; 0){
	//	return true;			
	//}
	//var myDate = new Packages.pase.agenda.MyDate();
	//var dayOfWeekIndex = java.lang.Integer.parseInt(myDate.getDayOfWeek(App_date));// 取得請假日為星期幾					
	//if(dayOfWeekIndex==6||dayOfWeekIndex==0){
	//	return true;// 該日休假
	//}
	try{
		var sql = &quot;SELECT * from empm110 where date(holiday) = date(&apos;&quot; + App_date + &quot;&apos;)&quot;;
		var conn = Client.createSessionConnection(&quot;T-MES&quot;);
		var vec = conn.loadValue(sql);
		if(vec.size()&gt;0){
			return true;// 該日休假
		}else{
			return false;
		}
	}catch(e){
		Form.showMessageDialog(e);
		loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
		sendErrorMail_Client(e);
	}finally{
		conn.close();
	}
}

//檢查時間格式
function chkTimeFormat(chkTime){
	var regex = &quot;([01]?[0-9]|2[0-3]):[0-5][0-9]&quot;;
	var str_s = new Packages.java.lang.String(chkTime);
	if(match(regex,str_s) == false){
		return false;
	}else{
		return true;
	}	
}

function match(regex,str){
	var pattern = new Packages.java.util.regex.Pattern.compile(regex);
	var matcher = pattern.matcher(str);
	return matcher.matches(); // true or false
}

//計算出勤時數
function cal_overtimecnt(overdate,overtime){
	var cal_H = 0;
	try {
		var myDate = new Packages.pase.agenda.MyDate();
		var App_date = overdate;
		var StartTime = overtime.substring(0,5);
		var EndTime = overtime.substring(6,11);
		var Start = App_date + &quot; &quot; +StartTime;
		var End = App_date + &quot; &quot; + EndTime;
		if (Start &gt;= End){
			End =  myDate.addDay(End,1);
		}
		var diff = myDate.getSubtractSecond(Start,End);
		diff = diff - getDinnerTime_A(overdate,Start,End);
		cal_H = getIntegerValue(diff/1800)/2;
	}catch(e){
		//Form.showMessageDialog(e);
	}
	return cal_H;
}

function getDinnerTime_A(overdate,Start,End){
	var myDate = new Packages.pase.agenda.MyDate();
	var App_date = overdate;
	var total = 0;
	var overBeg = Start;
	var dinnerA_S = App_date + &quot; &quot; + &quot;12:00:00&quot;;
	var dinnerA_E = App_date + &quot; &quot; + &quot;13:00:00&quot;;
	var dinnerB_S = App_date + &quot; &quot; + &quot;17:00:00&quot;;
	var dinnerB_E = App_date + &quot; &quot; + &quot;18:00:00&quot;;
	var dinnerC_S = App_date + &quot; &quot; + &quot;02:00:00&quot;;
	var dinnerC_E = App_date + &quot; &quot; + &quot;03:00:00&quot;;
	if(Start &gt; dinnerA_E){
		dinnerA_S =  myDate.addDay(dinnerA_S,1);
		dinnerA_E =  myDate.addDay(dinnerA_E,1);
	}
	if(Start &gt; dinnerB_E){
		dinnerB_S =  myDate.addDay(dinnerB_S,1);
		dinnerB_E =  myDate.addDay(dinnerB_E,1);
	}
	if(Start &gt; dinnerC_E){
		dinnerC_S =  myDate.addDay(dinnerC_S,1);
		dinnerC_E =  myDate.addDay(dinnerC_E,1);
	}
	/*
	if (dinnerA_E &lt; overBeg){
		dinnerA_S =  myDate.addDay(dinnerA_S,1);	
	}
	if (dinnerA_E &lt; overBeg){
		dinnerA_E =  myDate.addDay(dinnerA_E,1);	
	}
	if (dinnerB_S &lt; overBeg){
		dinnerB_S =  myDate.addDay(dinnerB_S,1);	
	}
	if (dinnerB_E &lt; overBeg){
		dinnerB_E =  myDate.addDay(dinnerB_E,1);	
	}
	if (dinnerC_S &lt; overBeg){
		dinnerC_S =  myDate.addDay(dinnerC_S,1);
	}
	if (dinnerC_E &lt; overBeg){
		dinnerC_E =  myDate.addDay(dinnerC_E,1);	
	}
	*/
	var beg = Start;
	var end = End;
	if (beg &lt; overBeg){//表示跨一日了
		beg =  myDate.addDay(beg,1);	
	}
	if (end &lt; overBeg ){//表示跨一日了
		end =  myDate.addDay(end,1);
	}
	total = calDinner(beg,end,dinnerA_S,dinnerA_E) + calDinner(beg,end,dinnerB_S,dinnerB_E) + calDinner(beg,end,dinnerC_S,dinnerC_E) ;

	return total;
}

function calDinner(beg,end,dinner_S,dinner_E){
	var myDate = new Packages.pase.agenda.MyDate();
	var S;
	var E;
	var total = 0;
	var diff_S = myDate.getSubtractSecond(beg,dinner_S)
	var diff_E =myDate.getSubtractSecond(end,dinner_E)
	if(diff_S &gt; 0){
		S = dinner_S;
	}else{
		S = beg;
	}
	if(diff_E &lt; 0){
		E = dinner_E;
	}else{
		E = end;
	}
	if(S &gt; E){
	}else{
		total = myDate.getSubtractSecond(S,E) ;
	}
	return total;
}

//取得整數值
function getIntegerValue(appHour){
	var strAppHour = java.lang.Float.toString(appHour);
	var index = strAppHour.indexOf(&quot;.&quot;);
	strAppHour = strAppHour.substring(0,index);
	return java.lang.Integer.parseInt(strAppHour);
}


function chkData(type){//1,預報加班   2.補預報加班
	var msg = &quot;&quot;;
	var flag = &quot;OK&quot;;
	
		var RecordInfo = Form.getComponent(&quot;RecordInfo&quot;);
		var rowList = RecordInfo.getRowList();
		for (var i = 0 ; i &lt; rowList.size(); i++){
			 var rowData = rowList.get(i);
			 var empno = rowData.get(&quot;ITEM1&quot;);
 			 var overdate = rowData.get(&quot;ITEM5&quot;);
			 var overtime = rowData.get(&quot;ITEM7&quot;);
 			 var job = rowData.get(&quot;ITEM9&quot;);
  			 var chkFlag = rowData.get(&quot;ITEM11&quot;);
   			 var _type = rowData.get(&quot;ITEM10&quot;);
			 var holiday = &quot;&quot;;
			 var overtimecnt = 0.0;
			 if (empno ==&quot;&quot;){
				 flag = &quot;NG&quot;;
				 msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆的「工號」未輸入，請確認。&quot;;
			 }
			 var member = Client.getMemberByID(&quot;MEMT1&quot;+ empno);
			 if (member == null ){
				 flag = &quot;NG&quot;;
				 msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆的工號輸入有誤，請確認。&quot;;
			 }else{
				 if (member.getJobRank().equals(&quot;D&quot;)){
					 flag = &quot;NG&quot;;
					 msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆 為直接人員，不可使用加班申請單，請確認。&quot;;
				 }else{				 
					 rowData.put(&quot;ITEM2&quot;,member);//姓名
					 var dptno = member.getMainRoleID().substring(4,7);
					 if (dptno.equals(&quot;XXX&quot;)){
						 dptno = member.getWorkPlace().substring(4,7);
					 }
					 if (dptno.equals(&quot;2L1&quot;)){
						 dptno = member.getAssociation();
					 }				 
					 rowData.put(&quot;ITEM3&quot;,dptno);//部門
					 rowData.put(&quot;ITEM4&quot;,member.getMilitaryService());//班別
				 }
			 }
			if(&quot;A2事務員,A3高級事務員,A4助理管理師,A5管理師,A6高級管理師,A7資深管理師,E1,E1助理技術員,E2技術員,E3技術指導員,E4助理工程師,E5工程師,E6高級工程師,E7資深工程師,M3組長,M4組長,M5組長/課長,M6課長,M7主任/課長 &quot;.indexOf(member.getJobLevel()) &lt;0 &amp;&amp; _type.equals(&quot;R4.加班費&quot;)){
				flag = &quot;NG&quot;;
				msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆 7職等以上不可申請加班費，請確認。&quot;;
			}
			if (flag !=&quot;NG&quot;) {
				if (overdate == &quot;&quot;){
					 flag = &quot;NG&quot;;
					 msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆的「歸屬日期」未輸入，請確認。&quot;;
				 }else{
					//檢查申請區間
					var myDate = new Packages.pase.agenda.MyDate();
					var day = myDate.getSubtractDay(myDate.getCurrentDate(),overdate);
					if (type == &quot;1&quot;){
						if (day &gt; 45 || day &lt;=0 ){
							flag = &quot;NG&quot;;
							msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆的「歸屬日期」不在合法申請區間內，請確認。&quot;;
						}
					}else{
						day_a = getOverDay(overdate);						
						if (day_a &lt; -3 || day &gt; 0 ){
							flag = &quot;NG&quot;;
							msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆的「歸屬日期」不在合法申請區間內，請確認。&quot;;
						}
					}				
					loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
					if(!customCheckDateFormat(overdate)){
						 flag = &quot;NG&quot;;
						msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆的「歸屬日期」輸入錯誤，請確認。&quot;;
					}else{
						if(chkHoliday(overdate)){
							holiday = &quot;假日&quot;;
						}else{
							holiday = &quot;平日&quot;;
						}
						rowData.put(&quot;ITEM6&quot;,holiday);//平假日
					}				
				 }
				}
			 if(flag !=&quot;NG&quot;){
				 if (overtime == &quot;&quot;){
					 flag = &quot;NG&quot;;
					 msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆的「加班時段」未輸入，請確認。&quot;;
				 }else{
					 if(overtime.length()　&lt;　11){
						 flag = &quot;NG&quot;;
						 msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆的「加班時段」格式有誤，請確認。&quot;;
					}else{ 
						 if(!chkTimeFormat(overtime.substring(0,5)) || !chkTimeFormat(overtime.substring(6,11))){
							 rowData.put(&quot;ITEM11&quot;,&quot;NG&quot;);//檢核碼(OK才代表是有檢核過的)
							 msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆的「加班時段」格式有誤，請確認。&quot;;
						 }else{
							 if((overtime.substring(3,5).equals(&quot;00&quot;) || overtime.substring(3,5).equals(&quot;30&quot;) ) &amp;&amp; ( overtime.substring(9,11).equals(&quot;00&quot;) || overtime.substring(9,11).equals(&quot;30&quot;))){
								 overtimecnt = cal_overtimecnt(overdate,overtime);
								 rowData.put(&quot;ITEM8&quot;,overtimecnt);//申請時數
							 }else{
								 rowData.put(&quot;ITEM11&quot;,&quot;NG&quot;);//檢核碼(OK才代表是有檢核過的)
								 msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆的「加班時段」必為整點或半點，請確認。&quot;;
							 }						 
						 }
					 }				 
				 }
			 }
			 if (job == &quot;&quot; &amp;&amp; flag !=&quot;NG&quot;){
				 flag = &quot;NG&quot;;
				 msg += &quot;第&quot;+ (i*1 + 1) +&quot;筆的「工作內容」未輸入，請確認。&quot;;
			 }
			 //卡同一人同一歸屬日只能有一筆資料。不可以同一天上半天申請換休，下班天申請加班費。
			 //
			 if (flag == &quot;NG&quot;){
				 rowData.put(&quot;ITEM11&quot;,&quot;NG&quot;);//檢核碼(OK才代表是有檢核過的) 
			 }else{
				 rowData.put(&quot;ITEM11&quot;,&quot;OK&quot;);//檢核碼(OK才代表是有檢核過的)
			 }			 
		}
		RecordInfo.setRowList(rowList);
		return msg;
}

	
//檢查相關資訊是否有填妥（預報加班申請單）
function okAct(type){	
	var msg=&quot;&quot;;
	var RecordInfo = Form.getComponent(&quot;RecordInfo&quot;);
	if(RecordInfo.getRowCount() &lt; 1){//沒有請假明細
		msg += &quot;\n請新增申請記錄！&quot;;
	}
	msg += chkData(type);
	return msg;
}

//檢查簽核流程（預報加班申請單）
function chkFlow(){
	var LastManager_ID = Form.getValue(&quot;LastManager&quot;);//最後一個簽核的人
	var LastManager = Client.getMember(LastManager_ID);
	var Next_Member_ID = Client.getMember(Form.getValue(&quot;App_MemID&quot;)).getPager();//第一個直屬主管
	var i=1;
	var msg =&quot;&quot;;
	while(!(Next_Member_ID==&quot;MEMT1000001&quot;)){
		msg += &quot;第&quot;+ i + &quot;階:&quot;　+　Client.getMember(Next_Member_ID)　+　&quot;\n&quot;;
		if (LastManager_ID ==Next_Member_ID || LastManager_ID.equals(Next_Member_ID)){
			break;
		}		
		Next_Member_ID = Client.getMember(Next_Member_ID).getPager();
		i++;
	}
	if (Next_Member_ID　==　&quot;MEMT1000001&quot;){
		msg = &quot;簽核流程有誤，錯誤簽核流程如下:\n&quot;+ msg  +&quot;請與人資處聯繫!&quot;;
	}else{
		msg=&quot;&quot;;
	}
	return msg;
}

//設定主旨及顯示訊息
function setSubject(type){
	var Sn = Form.getValue(&quot;Sn&quot;)
	Form.setValue(&quot;Subject&quot;,Sn);
}

// 是否7職以下
function isLevel7(empno){
	var member = Client.getMemberByID(&quot;MEMT1&quot;+ empno);
	var list  = &quot;A2事務員,A3高級事務員,A4助理管理師,A5管理師,A6高級管理師,A7資深管理師,E1,E1助理技術員,&quot;;
		list += &quot;E2技術員,E3技術指導員,E4助理工程師,E5工程師,E6高級工程師,E7資深工程師,M3組長,M4組長,&quot;;
		list += &quot;M5組長/課長,M6課長,M7主任/課長 &quot;;
	if(list.indexOf(member.getJobLevel()) &lt; 0){
		return false;
	}else{
		return true;
	}
}
//計算補預報的天數
function getOverDay(overdate){
	var count = 0;
	loadLibrary(&quot;com.gce.HR.Util.Utils&quot;);
	var sql = &quot; select (date(&apos;&quot; + overdate + &quot;&apos;)-date(current) + count(*) ) count from empm110  &quot;;
		sql += &quot; where holiday &gt;= date(&apos;&quot; + overdate + &quot;&apos;) and holiday &lt; date(current)&quot;;
	var vec = loadSQL(sql,&quot;T-MES&quot;);
	count = vec.get(0).get(&quot;count&quot;);
	return count;
}

//設定取後一位簽核主管
function setLastManager_ex(App_MemID,App_DepID){
	var Dep = Client.getDepartment(App_DepID);
	var LastManager = Dep.getResopnsibility().substring(0,11);
	if (LastManager == App_MemID || LastManager.equals(App_MemID)){//如果申請人是部門主管，則往上簽一級即可
		var member = Client.getMember(LastManager);
		LastManager = member.getPager();
	}
	if(LastManager ==&quot;&quot; || LastManager.equals(&quot;&quot;)){//讀取部門主管錯誤時，將資料塞入errorMsg中
		Form.showMessageDialot(&quot;讀取部門主管錯誤，請與單位書記聯繫!!&quot;);
	}else{
		Form.setValue(&quot;LastManager&quot;,LastManager);
	}
}	
</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>SCL00461533006257266</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2018/08/23 16:40:14</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.HR.Server.OT</string> 
     </void> 
     <void property="id"> 
      <string>SCL00461533006257266</string> 
     </void> 
     <void property="name"> 
      <string>OT</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00011227091263550</string> 
     </void> 
     <void property="scriptSource"> 
      <string>//轉R3假
function tranR3(empno,timecnt,tx_id){
	var flag;
	var myVector = new java.util.Vector();
	try{
		var conn = Server.createSessionConnection(&quot;T-MES&quot;);
		var sql;
		var vec;
		//先將該員所有R3假都取出來
		sql  = &quot; select * from empm073 where empno =&apos;&quot; + empno + &quot;&apos;  &quot;;
		sql += &quot; and over133 + over166 + over266 - over133_use - over166_use - over266_use &gt; 0 &quot;;
		sql += &quot; and use_yn = &apos;N&apos; and over_type = &apos;R3&apos; order by overdate&quot;;
		vec = conn.loadValue(sql);
		if( vec.size() &gt; 0){//表示有值，可以開始進行抵扣作業
			for(var i = 0 ; i &lt;vec.size() ; i++){
				if(timecnt  == 0){
					break;
				}
				var _empno = vec.get(i).get(&quot;empno&quot;);
				var _overdate = vec.get(i).get(&quot;overdate&quot;);
				var _over133  = vec.get(i).get(&quot;over133&quot;);
				var _over166  = vec.get(i).get(&quot;over166&quot;);
				var _over266  = vec.get(i).get(&quot;over266&quot;);
				var _over133_use  = vec.get(i).get(&quot;over133_use&quot;);
				var _over166_use  = vec.get(i).get(&quot;over166_use&quot;);
				var _over266_use  = vec.get(i).get(&quot;over266_use&quot;);
				var myMap = new java.util.HashMap();
				myMap.put(&quot;empno&quot;,_empno);
				myMap.put(&quot;overdate&quot;,_overdate);
				if(_over133 - _over133_use &gt; 0  ){//133有剩
					if ( _over133 - _over133_use &gt;= timecnt ) {
						myMap.put(&quot;over133_use&quot;,_over133_use*1 + timecnt*1);//沒用完
						myMap.put(&quot;no_1&quot;,tx_id + &quot;(&quot;+timecnt+&quot;),&quot;);
						timecnt = 0; //用完了
					}else{
						myMap.put(&quot;over133_use&quot;,_over133 );//用完了
						myMap.put(&quot;no_1&quot;,tx_id+&quot;(&quot;+(_over133 - _over133_use)+&quot;),&quot;);
						timecnt = timecnt - (_over133 - _over133_use ) ; //還沒用完						
					}
				}else{
					myMap.put(&quot;over133_use&quot;,_over133_use);
					myMap.put(&quot;no_1&quot;,&quot;&quot;);
				}
				if(_over166 - _over166_use &gt; 0 &amp;&amp; timecnt &gt; 0){//166有剩
					if ( _over166 - _over166_use &gt;= timecnt ) {
						myMap.put(&quot;over166_use&quot;,_over166_use*1 + timecnt*1);//沒用完
						myMap.put(&quot;no_2&quot;,tx_id + &quot;(&quot;+timecnt+&quot;),&quot;);
						timecnt = 0; //用完了
					}else{
						myMap.put(&quot;over166_use&quot;,_over166 );//用完了
						myMap.put(&quot;no_2&quot;,tx_id+&quot;(&quot;+(_over166 - _over166_use)+&quot;),&quot;);
						timecnt = timecnt - (_over166 - _over166_use ) ; //還沒用完
					}		
				}else{
					myMap.put(&quot;over166_use&quot;,_over166_use);
					myMap.put(&quot;no_2&quot;,&quot;&quot;);
				}
				if(_over266 - _over266_use &gt; 0 &amp;&amp; timecnt &gt; 0){//266有剩
					if ( _over266 - _over266_use &gt;= timecnt ) {
						myMap.put(&quot;over266_use&quot;,_over266_use*1 + timecnt*1);//沒用完
						myMap.put(&quot;no_3&quot;,tx_id + &quot;(&quot;+timecnt+&quot;),&quot;);
						timecnt = 0; //用完了
					}else{
						myMap.put(&quot;over266_use&quot;,_over266 );//用完了
						myMap.put(&quot;no_3&quot;,tx_id+&quot;(&quot;+(_over266 - _over266_use)+&quot;),&quot;);
						timecnt = timecnt - (_over266 - _over266_use ) ; //還沒用完

					}
				}else{
					myMap.put(&quot;over266_use&quot;,_over266_use);
					myMap.put(&quot;no_3&quot;,&quot;&quot;);
				}
				myVector.add(myMap);				
			}
		}else{
			//如果該員沒有Ｒ３假時數碓又申請，表云時數在中間應有異動情況
			//要返回flag=false由ＨＲ手動確認資料是否有異常。
			flag = false;
		}
		//全部處理完再update
		for(var j = 0 ; j &lt;myVector.size() ; j++){
			var empno_a = myVector.get(j).get(&quot;empno&quot;);
			var overdate_a = myVector.get(j).get(&quot;overdate&quot;);			
			var over133_use_a = myVector.get(j).get(&quot;over133_use&quot;);
			var over166_use_a = myVector.get(j).get(&quot;over166_use&quot;);
			var over266_use_a = myVector.get(j).get(&quot;over266_use&quot;);
			var no_1_a = myVector.get(j).get(&quot;no_1&quot;);
			var no_2_a = myVector.get(j).get(&quot;no_2&quot;);
			var no_3_a = myVector.get(j).get(&quot;no_3&quot;);
			sql =  &quot;UPDATE empm073 SET over133_use = &quot; + over133_use_a + &quot;, over166_use = &quot; + over166_use_a + &quot; , over266_use = &quot; + over266_use_a + &quot;, &quot;;
			sql += &quot;over133_no =trim(nvl(over133_no,&apos;&apos;)) || &apos;&quot;+no_1_a +&quot;&apos;,over166_no =trim(nvl(over166_no,&apos;&apos;)) || &apos;&quot;+no_2_a +&quot;&apos;,over266_no =trim(nvl(over266_no,&apos;&apos;)) || &apos;&quot;+no_3_a +&quot;&apos;, &quot;;
			sql += &quot;upd_dtime = current ,upd_user=&apos;AUTO&apos; &quot;;
			sql += &quot; WHERE empno=&apos;&quot;+empno_a+&quot;&apos; AND overdate=&apos;&quot;+overdate_a + &quot;&apos;&quot;;
			Server.addDebugLog(&quot;TGCE假單更新Ｒ３假sql=&quot;+sql);
			isSucccess = conn.updateValue(sql);// 更新
			if(true==isSucccess){
				conn.commit();
			}else if (false==isSucccess){
				conn.rollback();
			}
		}
	}catch(e){
		Server.addDebugLog(e);
		flag = false;
	}finally{
		conn.close();
	}
	return flag;
}



//加班單準右
function sendAcceptMailR3R4(type){	
	loadLibrary(&quot;com.A.Common.Server.SendMail&quot;);
	try{
		var formName = &quot;&quot;;
		if(type.equals(&quot;A&quot;)){
			formName = &quot;預報加班申請單&quot;;
		}else if(type.equals(&quot;R3&quot;)){
			formName = &quot;預報加班申請單&quot;;
		}else if(type.equals(&quot;B&quot;)){
			formName = &quot;補預報加班申請單&quot;;
		}else if(type.equals(&quot;R4&quot;)){
			formName = &quot;補預報加班申請單&quot;;
		}else{
			formName = &quot;實際加班申請單&quot;;
		}
		var aInstance = MyTask.getArtInstance(); 
		var dataMap = aInstance.getAppDataMap(); 
		var Sn = dataMap.get(&quot;Sn&quot;);//單號			
		var Creator = dataMap.get(&quot;Creator&quot;);
		var from = &quot;hr@gce.com.tw&quot;;
		var to = Server.getMemberByID(dataMap.get(&quot;Creator_ID&quot;)).getEmail();
		var cc=&quot;&quot;;		
		var bcc = &quot;&quot;;
		var clerkMail = &quot;&quot;;
		var Dep = Server.getDepartment(dataMap.get(&quot;App_DepID&quot;));
		clerkMail = Server.getMemberByID(Dep.getResopnsibility().substring(24,35)).getEmail();
		var arturl = getUrl(2) ;
		var table = &quot;&lt;table border=\&quot;1\&quot; cellpadding=\&quot;2\&quot; cellspacing=\&quot;0\&quot; width=\&quot;760\&quot; bordercolordark=\&quot;#FFFFFF\&quot; id=\&quot;table1\&quot; style=\&quot;font-size: 9pt; font-family: Arial\&quot;&gt;&quot;
  				  + &quot; 	&lt;tr style=\&quot;font-size: 9PT; font-family: Arial; line-height: 100%; border: 1px outset #FFFFFF;line-height:150%\&quot;&gt;&quot;
				  + &quot;   	&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;80\&quot;&gt;申請類型&lt;/td&gt;&quot;
				  + &quot;   	&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;60\&quot;&gt;工號&lt;/td&gt;&quot;
				  + &quot;       &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;60\&quot;&gt;姓名&lt;/td&gt;&quot;
				  + &quot;       &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;60\&quot;&gt;部門&lt;/td&gt;&quot;
				  + &quot;       &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;60\&quot;&gt;班別&lt;/td&gt;&quot;
				  + &quot;       &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;60\&quot;&gt;歸屬日期&lt;/td&gt;&quot;
				  + &quot;       &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;60\&quot;&gt;平假日&lt;/td&gt;&quot;
				  + &quot;       &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;60\&quot;&gt;加班時段&lt;/td&gt;&quot;
				  + &quot;       &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;60\&quot;&gt;申請時數&lt;/td&gt;&quot;
				  + &quot;       &lt;td align=\&quot;center\&quot; bgcolor=\&quot;#C0C0C0\&quot; width=\&quot;200\&quot;&gt;工作內容&lt;/td&gt;&quot;
				  + &quot;   &lt;/tr&gt;&quot;;
		if(type.equals(&quot;C&quot;)){
			var _type = dataMap.get(&quot;type&quot;);
			var empno = dataMap.get(&quot;App_ID&quot;);
			var cname = dataMap.get(&quot;App_Name&quot;);
			var dptno = dataMap.get(&quot;App_Dep&quot;);
			var classno = dataMap.get(&quot;classno&quot;);
			var overdate = dataMap.get(&quot;overdate&quot;);
			var holiday = dataMap.get(&quot;holiday&quot;);
			var applytime = dataMap.get(&quot;applytime&quot;);
			var timecnt = dataMap.get(&quot;timecnt&quot;);
			var job = dataMap.get(&quot;job&quot;);
			bcc += Server.getMemberByID(&quot;MEMT1&quot;+empno).getEmail() + &quot;;&quot;;
			table += &quot;&lt;tr&gt;&quot;;	           
			table +=   &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot; + _type + &quot;&lt;/td&gt;&quot;;
			table +=   &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot; + empno + &quot;&lt;/td&gt;&quot;;
			table +=   &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot; + cname + &quot;&lt;/td&gt;&quot;;
			table +=   &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot; + dptno + &quot;&lt;/td&gt;&quot;;
			table +=   &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot; + classno + &quot;&lt;/td&gt;&quot;;
			table +=   &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot; + overdate + &quot;&lt;/td&gt;&quot;;
			table +=   &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot; + holiday + &quot;&lt;/td&gt;&quot;;
			table +=   &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot; + applytime + &quot;&lt;/td&gt;&quot;;
			table +=   &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot; + timecnt + &quot;&lt;/td&gt;&quot;;
			table +=   &quot;&lt;td align=\&quot;left\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot; + job + &quot;&lt;/td&gt;&quot;;
			table +=   &quot;&lt;/tr&gt;&quot;;
		}else{
			var RecordInfo = dataMap.get(&quot;RecordInfo&quot;);
			var size = RecordInfo.size();
			for(var i=0;i&lt;size;i++){
				 var rowData = RecordInfo.get(i);			 
				 var _type = rowData.get(&quot;ITEM10&quot;);
				 var empno = rowData.get(&quot;ITEM1&quot;);
				 var cname = rowData.get(&quot;ITEM2&quot;);
				 var dptno = rowData.get(&quot;ITEM3&quot;);
				 var classno = rowData.get(&quot;ITEM4&quot;);
				 var overdate = rowData.get(&quot;ITEM5&quot;);
				 var holiday = rowData.get(&quot;ITEM6&quot;);
				 var applytime = rowData.get(&quot;ITEM7&quot;);
				 var timecnt = rowData.get(&quot;ITEM8&quot;);
				 var job = rowData.get(&quot;ITEM9&quot;);
					bcc += Server.getMemberByID(&quot;MEMT1&quot;+empno).getEmail() + &quot;;&quot;;				 
				 table += &quot;&lt;tr&gt;&quot;		           
					   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+_type+&quot;&lt;/td&gt;&quot;
					   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+empno+&quot;&lt;/td&gt;&quot;
					   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+cname+&quot;&lt;/td&gt;&quot;
					   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+dptno+&quot;&lt;/td&gt;&quot;
					   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+classno+&quot;&lt;/td&gt;&quot;
					   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+overdate+&quot;&lt;/td&gt;&quot;
					   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+holiday+&quot;&lt;/td&gt;&quot;
					   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+applytime+&quot;&lt;/td&gt;&quot;
					   +  &quot;&lt;td align=\&quot;center\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+timecnt+&quot;&lt;/td&gt;&quot;
					   +  &quot;&lt;td align=\&quot;left\&quot; bgcolor=\&quot;#FFFFFF\&quot; &gt;&quot;+job+&quot;&lt;/td&gt;&quot;
					   +  &quot;&lt;/tr&gt;&quot;;
			 }
		}
		table +=  &quot;&lt;/table&gt;&quot;;
        var subject = &quot;[結案通知]&quot;+formName+&quot;:&quot;+Creator+ &quot;-&quot;+Sn+&quot;已審核通過&quot;; // Mail Subject
		var text = &quot;&lt;table border=\&quot;0\&quot; width=\&quot;100%\&quot; style=\&quot;font-size: 11pt; font-family: Tahoma\&quot; height=\&quot;321\&quot;&gt;&quot;
				 + &quot;	&lt;tr&gt;&quot;
				 + &quot;	&lt;td height=\&quot;293\&quot;&gt;&quot;
				 + &quot;		&lt;font size=2&gt;Dear Sir,&lt;/font&gt;&quot;
				 + &quot;		&lt;p&gt;&lt;font size=2&gt;您申請的&quot;+formName+&quot;(&quot; + Sn + &quot;)，已簽核完畢。&lt;/font&gt;&lt;/p&gt;&quot;
				 + &quot;		&lt;blockquote&gt;&quot;
				 + &quot;&lt;p&gt;&lt;font size=2&gt;流程名稱：&quot; + formName + &quot;&lt;br&gt;&quot;
				 + &quot;&lt;p&gt;&lt;font size=2&gt;填單者：&quot;+Creator+&quot;&lt;/font&gt;&lt;/p&gt;&quot;
				 + table
				 + &quot;   &lt;br&gt;&quot;
				 + &quot;   點選右方進入網站&quot;+ arturl +&quot;直接察看表單內容。&lt;br&gt;&quot;
				 + &quot;   &lt;br&gt;&quot;
				 + &quot;&lt;p&gt;&lt;font size=2&gt;操作上有任何問題 請與資訊處 王英傑(#22717)聯絡 &lt;/p&gt;&quot;
				 + &quot;&lt;/blockquote&gt;&quot;
				 + &quot;&lt;p&gt;&lt;/td&gt;&quot;
				 + &quot;&lt;/tr&gt;&quot;
				 + &quot;&lt;tr&gt;&quot;
				 + &quot;&lt;td bgcolor=\&quot;#336699\&quot; style=\&quot;font-size: 9pt; font-family: Tahoma\&quot;&gt;&quot;
				 + &quot;&lt;p align=\&quot;center\&quot;&gt;&lt;font color=\&quot;#FFFFFF\&quot;&gt;MyGCE All New Flow System&lt;/font&gt;&lt;/td&gt;&quot;
				 + &quot;&lt;/tr&gt;&quot;
				 + &quot;&lt;/table&gt;&quot;
        var fileList = new Packages.java.util.Vector();
		Server.sendHTMLMail(from,to + &quot;;&quot; + clerkMail + &quot;;&quot; + bcc,subject,text);
		//測試程式用，程式穩定後可刪除 add by yingchiehwang@20110302
		Server.sendHTMLMail(from,&quot;yingchieh_wang@gce.com.tw;jean_lu@gce.com.tw;regina_ke@gce.com.tw&quot;,subject,text + to + &quot;;&quot; + clerkMail + &quot;;&quot; + bcc);
	}catch(e){
		java.lang.System.out.println(e);
	}
}


// 2018/08/16 copy from BPMDBx64dev
//  更新informix 報加班檔
//  因單號是在送出後才產生
function updateEMPM070(vStatus){
	var aInstance = MyTask.getArtInstance();
	var appDataMap = aInstance.getAppDataMap();		
	var vSN = appDataMap.get(&quot;Sn&quot;);
	var vResult =&quot;Y&quot;;
	if (&quot;&quot;==vSN){   			// 沒有單號不要 update
		return &quot;&quot;;
	}
	try{		
		var vTable = appDataMap.get(&quot;ResultTable&quot;); 		// 加班明細
		var vVerify_ID = appDataMap.get(&quot;Verify_ID&quot;);		
		var v_factory = appDataMap.get(&quot;Factory&quot;).substring(1,5);
		var vOverDate = appDataMap.get(&quot;OverDate&quot;);			// 加班日期		
		loadLibrary(&quot;com.gce.Common.Util&quot;);
		var conn_name = conn_db(v_factory,&quot;MES&quot;);
		var vSQL=&quot;&quot;;		
		var conn = Server.createSessionConnection(conn_name);	
		var rowCount = vTable.size();//取得筆數
		for( var i=0 ; i&lt;rowCount ; i++) {			
			var vYESNO = vTable.get(i).get(&quot;ITEM2&quot;);   //同意否 Y /N		
			var vEMPNO = vTable.get(i).get(&quot;ITEM3&quot;);   //工號	
			var vTimeBeg = vTable.get(i).get(&quot;ITEM6&quot;);   //開始時間	
			var vTimeEnd = vTable.get(i).get(&quot;ITEM7&quot;);   //結束時間	
			//   更新 vStatus P: 簽核中 / Y:簽核結束 / X:表單作廢
			var vSQL = &quot;UPDATE EMPM070 SET hr_status=&apos;&quot;+ vStatus+&quot;&apos;,over_no = &apos;&quot;+vSN+&quot;&apos;&quot;;
// --------------若是 vStatus = Y 	表示流程最後一關, 
			if( (&quot;Y&quot;==vStatus)&amp;&amp; (&quot;N&quot;==vYESNO)){
				vSQL +=&quot;, use_yn = &apos;N&apos;&quot;;					//要判斷明細是否同意(Y) , 若是N 則把加班作廢
			}				
			if( (&quot;Y&quot;==vStatus)){
				vSQL +=&quot;,status = &apos;F&apos;,hr_con_user=&apos;&quot;+vVerify_ID+&quot;&apos; ,hr_con_dtime=current&quot;; // status = &apos;F&apos; ==&gt;人事已確認
			}		
			vSQL += &quot; Where overdate=date(&apos;&quot;+vOverDate+&quot;&apos;) and empno = &apos;&quot; + vEMPNO+ &quot;&apos;&quot; ;
			vSQL += &quot; and overtimebeg = to_date(&apos;&quot;+vTimeBeg+&quot;&apos;,&apos;%Y/%m/%d %H:%M&apos;)&quot;;
			vSQL += &quot; and overtimeend = to_date(&apos;&quot;+vTimeEnd+&quot;&apos;,&apos;%Y/%m/%d %H:%M&apos;)&quot;;	
			var result = conn.updateValue(vSQL);
			//Server.addDebugLog(&quot;CALL updateEMPM070 更新加班檔 EMPM070 SQL:&quot; + vSQL);
			if(true==result){
				conn.commit();
				appDataMap.put(&quot;EMPM070&quot;,vStatus+&quot;-更新加班檔(empm070)成功&quot;);
				vResult = &quot;Y&quot;;
			}else{
				conn.rollback();
				appDataMap.put(&quot;EMPM070&quot;,&quot;E-更新加班檔(empm070)失敗&quot;);				
				Server.addErrLog(&quot;更新加班檔 EMPM070 失敗:&quot;+vSQL);
				vResult =  &quot;E&quot;;										
			}							
		}
	}catch(e){
		Server.addErrLog(&quot;更新加班檔 EMPM070 失敗:&quot;+vSQL);
		appDataMap.put(&quot;EMPM070&quot;,&quot;E-更新加班檔 EMPM070 失敗&quot;);
		vResult =  &quot;E&quot;;						
	}finally{
		conn.close();
	}
	return vResult;
}	

</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
   <void method="put"> 
    <string>null</string> 
    <object class="pe.pde.ScriptLibrary"> 
     <void property="author"> 
      <string>Administrator</string> 
     </void> 
     <void property="createDate"> 
      <string>2008/02/03 12:49:29</string> 
     </void> 
     <void property="fullName"> 
      <string>com.gce.org.Server</string> 
     </void> 
     <void property="id"> 
      <string>null</string> 
     </void> 
     <void property="name"> 
      <string>Server</string> 
     </void> 
     <void property="parentId"> 
      <string>SCF00001222752517878</string> 
     </void> 
     <void property="scriptSource"> 
      <string>
/**

	20080123 直接下 SQL 到 DB 速度較快(不行要用 api)
	AF.MEM_GENINF --&gt; EKM.EIP_MEMBER

	INSERT INTO ekm.eip_member (m_uid,m_site,m_account,m_password,m_lockpass,m_block,m_nickname,m_name,m_email,m_birthday,m_create_date,m_create_time)
 (SELECT  memid,areacode,loginid,&apos;NA&apos;,&apos;NA&apos;,&apos;N&apos; m_block,englishname,username,email,birthday,to_Char(sysdate,&apos;yyyy/MM/dd&apos;),to_Char(sysdate,&apos;HH24:MI&apos;)
 FROM MEM_GENINF m WHERE loginid is not null and  LOGINID NOT IN ( select M_ACCOUNT from ekm.eip_member) );

*/

/**
方法一
1.找出有更新的帳號 insert/update 到 ekm

方法二 20080129
全部刪除 eip_member 
eip_member_misc
where m_account not in(&apos;eipadmin&apos;,&apos;guest&apos;,&apos;CATEGORY_MGR&apos;,&apos;BOARD_MGR&apos;,&apos;DEPT_MGR&apos;)
eip_group
eip_group_member
where g_id not in(&apos;KM_DEPT&apos;,&apos;$everyone$&apos;,&apos;ROLeL060817150012000&apos;,&apos;ROLeL080129230225000&apos;,&apos;ROLeL080129230225000_boss&apos;)
重新產生
*/

	function reloadOrg(){
		var ekmschema = &quot;ekm&quot;;
		var ekmapi = new Packages.com.eland.ekm.api.member.MemberAPI();
		try{
			var conn_ekm = Server.createSessionConnection(&quot;EKM&quot;);
			reloadDepartment(conn_ekm,ekmapi,ekmschema);
			reloadMember(conn_ekm,ekmapi,ekmschema);
		}catch(e){}
		if(conn_ekm != null)	{
			try	{
				conn_ekm.commit();
			}catch(e){}
			conn_ekm.close();
		}
	}
	
	function reloadDepartment(conn_ekm,ekmapi,ekmschema){
		var sql_where = &quot; where g_id not in(&apos;KM_DEPT&apos;,&apos;$everyone$&apos;,&apos;ROLeL060817150012000&apos;)&quot;; //,&apos;ROLeL080129230225000&apos;,&apos;ROLeL080129230225000_boss&apos;
		var sql_del = &quot;  delete  &quot;+ ekmschema +&quot;.eip_group  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);
		var sql_del = &quot;  delete  &quot;+ ekmschema +&quot;.eip_group_member  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);	
		conn_ekm.commit();
		/**
		api.insertDept(&quot;部門編號&quot;, &quot;部門名稱&quot;, &quot;部門建立者&quot;, &quot;部門簡介&quot;, &quot;所屬部門的ID &quot;)；
		api.updateDept (&quot;部門編號&quot;,&quot;新部門名稱&quot;, &quot;新部門簡介&quot;, &quot;上層部門ID&quot;)
		*/
		var sql_dep = &quot; select * from dep_geninf  &quot;;
		var vec_dep = Server.SQLloadValue(sql_dep);
		if(vec_dep != null &amp;&amp; vec_dep.size() &gt; 0){
			for(var i=0;i&lt;vec_dep.size();i++){
				try	{
					var depid = vec_dep.get(i).get(&quot;depid&quot;);
					var depname = vec_dep.get(i).get(&quot;name&quot;);
					var creator = &quot;eipadmin&quot;;
					var id = vec_dep.get(i).get(&quot;id&quot;);
					var parentid = vec_dep.get(i).get(&quot;parentid&quot;);
					if(parentid == &quot;company&quot;){
						parentid = &quot;root&quot;;
					}
					var result = ekmapi.insertDept(depid,depname,creator,&quot;&quot;,parentid);
					//var result1 = ekmapi.updateDept(depid,depname,&quot;&quot;,parentid);
					java.lang.System.out.println(i + &quot;=&quot; + depname + &quot;insertDept[&quot; + result + &quot;]&quot;);
				}catch(e){
				}finally {}
	        }
		}
		//var sql_update = &quot; update eip_group set g_parentid = &apos;root&apos; where g_id like &apos;DEP%GCE&apos; &quot;;
		//conn_ekm.updateValue(sql_update);	
		//conn_ekm.commit();
		var sql_update = &quot; update eip_group set g_name = &apos;主管&apos;,g_desc = &apos;主管&apos; where g_id like &apos;%_boss&apos; &quot;;
		conn_ekm.updateValue(sql_update);	
		conn_ekm.commit();
		
	}

	function reloadMember(conn_ekm,ekmapi,ekmschema){
		// to do 注意 schema

		var sql_where = &quot; where m_account not in(&apos;eipadmin&apos;,&apos;guest&apos;,&apos;CATEGORY_MGR&apos;,&apos;BOARD_MGR&apos;,&apos;DEPT_MGR&apos;) &quot;;
		var sql_del = &quot;  delete &quot;+ ekmschema +&quot;.eip_member  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);
		var sql_del = &quot;  delete  &quot;+ ekmschema +&quot;.eip_member_misc  &quot; + sql_where ; 
		conn_ekm.updateValue(sql_del);
		conn_ekm.commit();
		var sql_mem = &quot; SELECT  distinct loginid FROM MEM_GENINF m WHERE loginid is not null and  LOGINID NOT IN ( select M_ACCOUNT from &quot;+ ekmschema +&quot;.eip_member) &quot;;
		var vec_mem = Server.SQLloadValue(sql_mem);
		if(vec_mem != null &amp;&amp; vec_mem.size() &gt; 0){
			for(var i=0;i&lt;vec_mem.size();i++){
				try	{
					var loginid = vec_mem.get(i).get(&quot;loginid&quot;);
					var member = Server.getMember(loginid);
					var result = insertEkmMember(ekmapi,member);
					java.lang.System.out.println(i + &quot;insertMember=[&quot;+ loginid +&quot;][&quot; + result+&quot;]&quot;);
				}catch(e){
				}finally {}
	        }
		}
	}
	
	function insertEkmMember(ekmapi,member){
		var result = false;
		if(member != null){
			//com.eland.api.MemberInfoWrapper info
			//to do 注意部門
			
			var loginid = member.getLoginID();
			var password = member.getLoginID();
			var username = member.getName();
			var email = member.getEmail();
			var sex = &quot;F&quot;; 
			if(member.isMale()){
				sex = &quot;M&quot;;
			}
			var info = new Packages.com.eland.ekm.api.member.MemberInfoWrapper(loginid,password,username,email,sex); //[帳號][密碼][名稱][email][性別&apos;F&apos;/&apos;M&apos;]
			info.department = member.getWorkPlace();
			//info.department = &quot;ROLeL080129230225000&quot;;//金像電員工
			/*
			var otherDepartment= new Array();
			info.memberMiscInfo.title = &quot;經理&quot;;
			info.otherDepartment = otherDepartment;
			info.department = &quot;for_test&quot;;
			var array1 = new Array();
			array1[0] = &quot;1165377077250&quot;;
			info.userSkillId = array1;
			info.customFieldId= array1;
			info.customFieldValue= array1;
			*/
			var result_i = ekmapi.insertMember(info); //成功得1失敗得0
			if(1 == result_i){
				result = true;
			}
		}
		return result ; 
	}





	
	
	
	
	
	
	
	
	




</string> 
     </void> 
     <void property="synopsis"> 
      <string>ScriptLibrary1 synopsis</string> 
     </void> 
    </object> 
   </void> 
  </void> 
 </object> 
</java> 
